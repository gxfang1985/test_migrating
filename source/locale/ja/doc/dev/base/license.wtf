[[概要|section:abstract]]

ライセンスフレームワークとは、
アゼリア上に作られた製品の挙動を制御するための共通手続きである。
現在は製品上に表示する警告の強制表示と、
特定画面への強制的なリダイレクトをカバーするが、
製品に共通する部分は随時機能追加する予定である。 

その一方、ライセンスフレームワークはいかなるライセンス方式の実装も提供していない。
ライセンスキー、アクティベーション、
その他どのようなライセンス方式の実装も製品に委ねられている。 

特定のライセンス実装の提供はしないものの、これまでのサイボウズ製品で共通してきた実装や、
これから共通する実装部分についてはユーティリティとして提供する。 

このように、ライセンスフレームワークは製品の挙動を制御する''ライセンスドライバ''と、
各種のライセンス実装で利用される''ライセンスユーティリティ''の二つの構成要素からなる。 

[[ライセンスドライバ|section:driver]]

ライセンスドライバは[[doc:dev/base/plugin]]を利用したプラグインとして実装する。
つまり具体的なライセンスドライバを記述するのは製品開発者となる。 

以下に示すように、ライセンスドライバは [[include/fw/license.csp]] で定義されている 
[[az:fw.core:CB_LicenseBaseDriver]] クラスを継承して作成する。
プラグインモジュール名は ''license'' であるので、
作成したドライバファイル ''demo.csp'' は "code/plugin/license" ディレクトリに配置する。
詳細は [[code/plugin/license/index.html]]、
およびデモライセンスドライバ（[[code/plugin/license/demo.csp]]）を参照せよ。 

[[src]]
{{// demo.csp デモライセンスドライバ}}
<?php

''require_once( 'fw/license.csp' );''

class plugin_license_demo extends ''CB_LicenseBaseDriver''
{
    {{// 強制表示する警告テンプレート名を返す}}
    {{// FALSE を返すと警告テンプレートを挿入しない}}
    {{// いつどのような条件で警告するかは、メソッドの実装で自由に変更できる}}
    function showWarning()
    {
        return 'warning_demo.tpl';
    }

    {{// 強制リダイレクトする先のページファイル名を返す}}
    {{// FALSE を返すと強制リダイレクトしない}}
    {{// いつどのような条件でリダイレクトするかは、}}
    {{// メソッドの実装で自由に変更できる}}
    function forceRedirect()
    {
        $today = getdate();
        return ( $today['year'] > 2004) ? 'demo_expired.csp' : FALSE;
    }
}
?>
[[/src]]

さらに、使用するライセンスドライバ名を [[common.ini|doc:ext/config#common.ini]] で以下のように宣言する。 

[[src]]
[License]
driver = ''demo''
[[/src]]

アゼリアは必ず何らかのライセンスドライバを要求する。
もしライセンスドライバを与えない or 削除した場合は、
エラーが発生してアプリケーションを実行できない。 

このようにライセンスドライバは非常に柔軟なライセンスロジックの実装を可能とする。
例えば大手顧客のための特別デモライセンスが急拠必要となっても、
製品のコードに触れることなく小さなライセンスドライバを作成・追加するだけで対応できる。 

[[ライセンスユーティリティ|section:utility]]

[[include/fw/license.csp]] では上記ドライバの基底クラスの他に、
[[az:fw.core:CB_GlobalLicenseManager]] というクラスを提供している。
このクラスは製品に共通するライセンスロジックの一部をユーティリティとして提供するものである。 

現在は以下のように、初期化（インストール）した日付と、
インストール時にランダムに生成される文字列を取得するのみだが、
次期製品群のライセンスロジックで共通する部分などはこちらで吸収していく予定である。 

[[src]]
require_once( 'fw/license.csp' );

$lic = CB_GlobalLicenseManager::getInstance();

{{// 初期化日を CB_Date 型で取得}}
{{// データベース初期化前(common.ini [Database] initialized が偽の時)は}}
{{// 未設定}}
$init_day = $lic->getInitDay();

// ランダム生成文字列を取得
$random_key = $lic->getInstallId();
[[/src]]

[[az:fw.core:CB_GlobalLicenseManager]] は初期化日やランダム生成文字列を再設定する API も有している。
特にランダム生成文字列は将来サイボウズがインストール毎に一意な ID を発行する場合に備え、
ユニークフラグを持たせることができるようになっている。 

これらはユーティリティとして提供されているもので、
使用するか否かは製品開発者に委ねられている。 

[[解説|section:explain]]

[[Q. なぜライセンスキーを実装しないのか|head:]]

ライセンスキーの実装を否定している訳ではなく、設計の優先順位の問題である。
ここに示したような柔軟なライセンスドライバ機構の設計の後、
具体的なライセンスロジックに着手するべきだと判断した。 

[[Q. ライセンスドライバは警告表示と強制リダイレクトで十分か|head:]]

現時点のウェブアプリケーションでは、以下の理由から十分と判断している。
*[[既存製品の分析|cb6:page=FileView&gid=3561&fCID=86244&fFID=160283]]では製品全体の挙動の制御はこの二種類だけと判明。 
*''showWarning()'' や ''forceRedirect()'' が呼び出されるタイミングでのフック動作は自由に記述可能。
*その他の細かい表示や情報は製品全体の挙動ではなく、アプリケーションとしての実装である。 

[[Q. ライセンスユーティリティはなぜ提供するのか|head:]]

製品間で共通するライセンスロジックの置場として、提供している。 

[[Q. ライセンスユーティリティが提供する初期化日は安全に保護されているか|head:]]

現時点の実装は CGI ディレクトリに "common.lic" というファイルを作成するものである。
このファイルは秘密文字列とチェックサムを作成することで改竄は困難であるものの、
単純なコピーに弱いという欠点を持つ。
 **ただし**、コピーを困難にするとデータのサーバー間移動が困難になるトレードオフが存在する。
 ここでは API の確立が重要であると判断し、実装の強化・改良は今後の課題とした。 

[[フレームワークソース |section:source]]

*ライセンスフレームワーク（[[include/fw/license.csp]]）
*デモライセンスドライバ（[[plugin/license/demo.csp]]）
