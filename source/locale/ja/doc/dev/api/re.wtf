[[概要|section:abstract]]
このライブラリは[[RichEditor|http://www.richarea.com/]]を改良したものです。
オリジナルに比べて、以下の修正が加えられています。
* バグ修正
* Firefox,Netscapeへの対応の強化
* 安全な画像貼り付け機能の追加
* Smartyテンプレート化
* アゼリアとの統合

[[サポートする環境|head:]]

RichEditorがサポートするブラウザは以下の通りです。
* Internet Explorer Windows版 バージョン5.5,6.0
* Netscape Windows版/Macintosh版 バージョン7.1,7.2
* Firefox Windows版/Macintosh版 バージョン1.0.x

レンダリングエンジンにGeckoを使用しているブラウザの場合、
User-Agentから得られるMozillaのrevision番号をもとに判別しています。
上記の環境のうち、Netscape7.1はrev1.4であり、Netscape7.2およびFirefoxはrev1.7です。
他のブラウザでもUser-AgentからMozilla rev1.4以降と判断される場合RichEditorは起動します。
他の環境では単にテキストエリアが表示されるのみです。

[[設計|section:design]]

[[Smartyプラグインの仕様|head:]]

RichEditorを表示するためのSmarty関数名はcb_re_rich_editorです。
この関数は、その場にエディタを生成するものです。
テキストエリアが生成されるため、必ずフォームの中で使用してください。

また、フォームのonSubmitイベントハンドラで、以下のようにre_on_submit()関数を呼び出す必要があります。このJavaScript関数は最終的にサーバーに送信するデータを準備するものです。

[[src]]
<form method="POST" onSubmit="re_on_submit()" ...
[[/src]]

エディタを使用するページでは、以下のようにBODY要素にonUnloadイベントハンドラを記述してください。
これを記述しないと、Gecko 系ブラウザではページを移った時に、現在表示されているダイアログがそのままになります。
このダイヤログを操作すると、ブラウザがクラッシュすることがあります。

[[src]]
<body onUnload="re_on_unload()" ...
[[/src]]

以下は関数のパラメータの一覧です。

[[html]]
<TABLE class="cb_doc_table" border="1">
<THEAD>
<TR>
<TH>パラメータ名</TH>
<TH>データの型</TH>
<TH>デフォルト</TH>
<TH>説明</TH>
<TH>必須</TH>
</TR>
</THEAD>
<TBODY>
<TR>
<TD>name</TD>
<TD>
<P>JavaScriptの変数として有効なASCII文字列</P></TD>
<TD></TD>
<TD>エディタの名前です。これは内部での識別のために使われる他、サーバーにデータを渡すときの<A href="#param">パラメータ名</A>としても使われます。</TD>
<TD><FONT face=Symbol>Ö</FONT></TD></TR>

<TR>
<TD>value</TD>
<TD>
<P>HTMLテキスト</P></TD>

<TD>
<P>空文字列</P></TD>
<TD>
<P>エディタ起動時に最初に表示される内容です。</P></TD>
<TD></TD></TR>
<TR>
<TD>width</TD>
<TD>
<P>CSSの長さ(100pxなど)</P></TD>
<TD>auto</TD>
<TD>
<P>エディタの幅です。</P></TD>

<TD></TD></TR>
<TR>
<TD>height</TD>
<TD>CSSの長さ(100pxなど)</TD>
<TD>auto</TD>
<TD>
<P>エディタの高さです。</P></TD>
<TD></TD></TR>
<TR>
<TD>pageMode</TD>
<TD>
<P>boolean</P></TD>

<TD>false</TD>
<TD>
<P>falseであればHTML文書の一部を編集し、trueであれば、完全なHTML文書を編集します。<BR>例えば、falseの場合は文書のタイトルや背景を設定する機能がありません。</P></TD>
<TD></TD></TR>
<TR>
<TD>absolutePath</TD>
<TD>boolean</TD>
<TD>false</TD>
<TD>
<P>falseであれば、文書中で使われる画像やリンクのURLから"http://ホスト名"の部分を削除します。<BR>これはIEがURLを絶対パスに勝手に変換してしまうことに対処するもので、Gecko系ブラウザではあまり意味を持ちません。</P></TD>

<TD></TD></TR>
<TR>
<TD>lang</TD>
<TD>
<P>2文字の言語コード</P></TD>
<TD>'en'</TD>
<TD>
<P>ツールバーやメッセージなどで使用する言語です。</P></TD>
<TD></TD></TR>
<TR>
<TD>docLang</TD>
<TD>2文字の言語コード</TD>

<TD>'en'</TD>
<TD>
<P>編集された結果として出力される文書の言語です。この設定はXHTMLモードかつページモードの場合のみ有効です。</P></TD>
<TD></TD></TR>
<TR>
<TD>docCharset</TD>
<TD>エンコーディング名</TD>
<TD>lang,docLangに依存する</TD>
<TD>
<P>編集された結果として出力される文書のエンコーディングです。この設定はXHTMLモードかつページモードの場合のみ有効です。<BR>RichEditorはエンコーディングを変換しません。このエンコーディング名は、単位XML宣言で使われるものです。このパラメータは実際にサーバーに送られる文書のエンコーディングと一致させる必要があります。<BR></P></TD>

<TD></TD></TR>
<TR>
<TD>xhtmlMode</TD>
<TD>boolean</TD>
<TD>false</TD>
<TD>
<P>falseであればHTMLを出力します。trueであれば、整形式のXML(ページモードであれば断片)として結果を出力します。</P></TD>
<TD></TD></TR>

<TR>
<TD>textareaMode</TD>
<TD>boolean</TD>
<TD>false</TD>
<TD>
<P>trueであれば初期状態がテキストエリアとなります。</P></TD>
<TD></TD></TR>

<TR>
<TD>baseURI</TD>
<TD>
<P>URI</P></TD>

<TD>
<P>アゼリアのCGIパス/re/</P></TD>
<TD>
<P>RichEditorの動的なコンテンツへのパスです。</P></TD>
<TD></TD></TR>

<TR>
<TD>imageGetter</TD>
<TD>
<P>URI</P></TD>
<TD>
<P>{baseURI}/command_get</P></TD>
<TD>
<P>添付画像を取得するためのURIです。</P></TD>
<TD></TD></TR>

<TR>
<TD>webRoot</TD>
<TD>
<P>URI</P></TD>
<TD>
<P>静的コンテンツのディレクトリ/re/</P></TD>
<TD>

<P>RichEditorの静的なコンテンツへのパスです。</P></TD>
<TD></TD></TR>
<TR>
<TD>defaultFontFamily</TD>
<TD>
<P>CSSのfont-familyの値</P></TD>
<TD>'Times New Roman'<BR></TD>
<TD>
<P>文書中のフォントを指定していない部分で使われるフォントです。</P></TD>
<TD></TD></TR>
<TR>
<TD>defaultStyleSheet</TD>

<TD>URI</TD>
<TD>
<P>なし</P></TD>
<TD>
<P>最初に読み込まれるスタイルシートです。「クラス」メニューでは、このスタイルシート中のクラスが利用可能になります。</P></TD>
<TD></TD></TR>
<TR>
<TD>fontList</TD>
<TD>
<P>(表示名 =&gt; フォントファミリ名)を要素とする配列<BR></P></TD>

<TD>
<P>10種類の欧文フォント</P></TD>
<TD>
<P>「フォント」メニューで利用可能にするフォントのリストです。</P></TD>
<TD></TD></TR>
<TR>
<TD>fontSizeList</TD>
<TD>
<P>(表示名 =&gt; 数値)を要素とする配列<BR></P></TD>
<TD>
<P>1から7までの値</P></TD>

<TD>
<P>「サイズ」メニューで利用可能にするフォントサイズのリストです。</P></TD>
<TD></TD></TR>
<TR>
<TD>colors</TD>
<TD>
<P>CSSの色(Red, #FF0000など)の配列</P></TD>
<TD>
<P>216ウェブセーフカラー</P></TD>
<TD>
<P>文字色、背景色などで利用可能な色のリストです。</P></TD>
<TD></TD></TR>

<TR>
<TD>snippets</TD>
<TD>
<P>(表示名=&gt;HTMLテキスト)を要素とする配列</P></TD>
<TD>
<P>空配列</P></TD>
<TD>
<P>「HTML部品」で利用可能な部品のリストです。</P></TD>
<TD></TD></TR>
<TR>
<TD>brOnEnter</TD>

<TD>boolean</TD>
<TD>false</TD>
<TD>
<P>trueにすると、EnterとShift+Enterの動作が逆になります。</P></TD>
<TD></TD></TR>
<TR>
<TD>hiddenTabs</TD>
<TD>カンマ区切りの項目名</TD>
<TD>なし</TD>
<TD>
<P>隠して使えないようにするツールのリストです。項目名は以下から選ぶことができます。</P>
clipboard(クリップボード), history(履歴), text(文字のスタイル), align(横方向位置),<BR>
list(箇条書き), indent(インデント), hr(水平線), remove_format(スタイルのクリア), source(HTMLソース),<BR>
table(テーブル), adv_table(テーブルの行列の操作), paragraph(段落), font(フォント), style(スタイルシートクラス),<BR>
size(サイズ), color(文字色), image(画像), link(リンク),<BR>
paste_word(ワード貼り付け), switch_borders(境界線表示), special_chars(特殊文字), form(フォーム),<BR>
snippets(HTMLテンプレート), page_properties(ページ属性), help(ヘルプ), absolute_position(絶対位置指定)<BR></TD>
<TD></TD></TR></TBODY></TABLE>
[[/html]]

[[サーバーに渡されるデータ|head:]]
エディタからサーバーへ次のデータが渡されます。
なお、以下の説明で{name}はSmarty関数のnameパラメータに渡した値で置き換えてください。

[[html]]
<TABLE class="cb_doc_table" border="1">
<THEAD>
<TR>
<TH>パラメータ名</TH>
<TH>説明</TH>
<TR>
</THEAD>
<TBODY>
<TD>{name}</TD>
<TD>編集後のHTML文書のソースです。</TD></TR>

<TR>
<TD>{name}_docid</TD>
<TD>文書IDです。Smarty関数のdocidパラメータに渡した値がそのまま送られます。</TD></TR>
<TR>
<TD>{name}_fileids</TD>
<TD>カンマで区切られた添付画像ファイルIDのリストです。</TD></TR></TBODY></TABLE>
[[/html]]

[[ファイルの添付|head:]]

CB_REFileBinder(ファイル: include/re/re_file.csp)はRichEditorが文書に添付したファイルを管理するためのインターフェースです。
以下の記述を用いて実装を軽量コンテナに登録してください。

[[src]]
[re_file_binder]
class                   = CB_REFileBinder_DB
require                 = re/re_file.csp
prop:_expiry_seconds	= val:86400
[[/src]]

RichEditorがアップロードされたファイルを受け取ると、
ファイルバインダにファイルを追加します(doc_root/re/local_files.csp)。
この時点では、ファイルは仮の添付ファイルとして登録された状態となります。
仮の添付ファイルへは、現在ログインしているユーザーだけがアクセス可能です。

編集を終えた文書を保存するとき、ユーザーは仮の添付ファイルを正式なものとして確定させる必要があります。
以下はRichEditorから渡されたパラメータを利用してその操作を行う例です。{name}はSmarty関数に渡したnameパラメータで置き換えてください。

[[src]]
    require_once( 'fw/lwc.csp' );
    require_once( 're/re_file.csp' );
    
...省略...    
    
    if (isset($G_INPUT['{name}_fileids'])) {
        $fileids = $G_INPUT['{name}_fileids'];
        $fileids = explode(',', $fileids);
    }
    else {
        $fileids = array();
    }
    
    global $G_container_base;
    $file_binder = $G_container_base->getInstance( 're_file_binder' );
    //$docidにはこのファイルを添付する文書のIDが格納されている
    $file_binder->commitFiles($fileids, $docid);
[[/src]]

この操作を行わないファイルは、一定時間を経過した後CB_FileBinderのdeleteExpiredFilesが呼び出されたタイミングで削除されます。
deleteExpiredFilesは同クラスのgetServerFileの内部でも呼び出されています。
これは、ファイルをアップロードしたものの、文書を保存せずに放置されたために不要になったファイルを削除するためのものです。
仮の添付ファイルの寿命はCB_FileBinderの_expiry_secondsプロパティで設定されます。

添付ファイルへは、文書IDと、CB_FileBinderのaddFileが返したファイルIDの組み合わせでアクセスすることができます。
doc_root/re/command_get.cspが実際にそれを行っています。
添付ファイルへのアクセスを行うURIはSmarty関数のimageGetterによって変えることができます。
ユーザー独自のアクセス制御を行う場合などに利用してください。

[[既知の問題|section:rationale]]

主にブラウザの制限やバグに関連する問題があります。

[[全てのブラウザの制限|head:]]

セルの分離をすると、&nbsp;が余計に追加されます。
これは、2 つのセルの内容を単純に結合して左側のセルにまとめているためです。
なお、&nbsp;は空のセルが表示されなくなるのを防ぐために新しいセルに追加されているものです。

ページプロパティの変更をUndoできません。
ヘッダ部分の変更がどのブラウザでもUndoできないためです。

ソースモードに切り替えると、履歴が削除されます。
DOMを使っていることが影響しています。

境界線の表示・非表示を切り替えると履歴が消えます。
DHTMLで文書にスタイルシートを適用しているためです。

カーソルの位置の書体によりコンボボックスが切り替わります。
このとき、ブラウザから得られるフォント名を利用しています。
フォント名は、 Geckoでは設定されたフォント名が返されますが、IEでは実際のフォント名(例えば、serifと指定するとMS明朝)が返ります。
そのため、正確に動作するかは、動作環境にそのフォントがあるかどうかに依存します。
以下の例ではUserAgentでクライアントを判別し、MacOSXとそれ以外の環境でフォントを切り替えています。

[[src]]
$isMac = isset($_SERVER["HTTP_USER_AGENT"]) &&
         strpos($_SERVER["HTTP_USER_AGENT"], 'Macintosh') !== false;
$smarty->assign('fontList',
    array(  
            'Arial Black' => 'Arial Black',
            'Garamond' => 'Garamond',
            'Comic Sans MS' => 'Comic Sans MS',
            'Courier' => 'Courier',
            'Courier New' => 'Courier New',
            'Symbol' => 'Symbol',
            'Times New Roman' => 'Times New Roman',
            'Verdana' => 'Verdana',
            'Webdings' => 'Webdings',
            'Wingdings' => 'Wingdings',
            'ゴシック'=> $isMac ? 'Osaka' : 'ＭＳ Ｐゴシック',
            '明朝'=>$isMac ? 'ヒラギノ明朝 Pro W3' : 'ＭＳ Ｐ明朝',
            '等幅ゴシック'=>$isMac ? 'Osaka－等幅' : 'ＭＳ ゴシック',
            '等幅明朝'=>$isMac ? 'ヒラギノ明朝 Pro W3,Courier' : 'ＭＳ 明朝'
));
[[/src]]

[[IEの制限|head:]]

テーブルに行または列を追加した場合、行(列)の追加->セルの追加...という順に履歴が記録されます。
これは各操作を順に行っているためです
(一気に操作を実行できるouterHTML, insertAdjacentHTMLは<TR>に対して使えないようです)。

セルの結合・分離の操作で、IE6.0ではcolspan変更->セルの内容を結合->不要なセルを削除、および、colspan変更->セルを挿入という3または2のステップが履歴に記録されます。
IE5.5でも同様ですが、Undoすると、見た目上テーブルの形がくずれてしまうというバグがあります(プレビューするとテーブルは正常に表示されます)。
余計にUndoしてからRedoすると正常に表示されます。

テーブル、段落などに対するスタイルシートクラス名の指定はUndoできません。

ワードからのペーストの1つ前の操作をUndoするために、2回よけいにUndoの操作が必要です。
隠しフレームで内部的に２度編集が行われるためです。
セキュリティ上の問題で画像はペーストされません。

セルの編集がUndoできません。
セルに対するouterHTMLが使えないことが影響しています。

[[Firefox,Netscapeの制限|head:]]

フルスクリーン表示の切り替えで履歴が消去されます。
エディタの位置を変更することによる、副作用のようです。

単語として検索が不正確です。
単純に、単語の前後にスペースを付加したものを検索しています。
GeckoにはIEのような単語検索の機能がありません。

以下の操作は履歴に残りません。
これらの操作を行うとUndoができなくなるか、あるいは以前の操作がUndoされます。
以前の操作と矛盾が生じる場合は、Undoボタンが有効にも関わらずUndoできません。
このとき、内部ではエラーが発生しています。これはGeckoのバグと思われます。
* 検索・置換
* テーブルの作成・編集・削除
* セルの編集・挿入・削除・結合・分離
* 行の挿入・削除(ツールバーから実行した場合)
* 列の挿入・削除(ツールバーから実行した場合)
* フォームの作成・編集
* 全ての種類のフォーム部品の作成・編集
* 書体の指定
* CSSクラスの指定
* 画像の作成・編集
* リンクの作成・編集
* Wordからのペースト
* 特殊文字の追加
* HTML部品リスト
* 絶対位置指定
* ページプロパティ

Geckoではフォントの指定にexecCommandではなくDOMを使っています。これは、FontNameコマンドのバグにより、和文フォント名が勝手に改変されるためです。
例えば'ＭＳ 明朝'が'ｍｓ 明朝'に改変され、フォントを適用することができません。

ソースモードで検索は実行できません。

テーブルにガイドが表示されている場合に、カット・コピーを実行してもテーブルが操作対象になりません。
このとき、実際にはテーブルの内部にカーソルが置かれた状態になっています。

テーブルにガイドが表示された状態でテーブルを削除した場合、一時的にガイドが残ります。
これはブラウザの仕様です。

テーブルに対するスタイルシートクラス名の指定ができません。
テーブルを選択した状態と、テーブルの内容を選択した状態が区別できないためです。

Netscape7.1では絶対位置指定を使うことができません。

フォーム部品、水平線に対するガイドは表示されません。

Netscape7.1 Mac版でHTMLソースボタンを何度も連続して押すとクラッシュする場合があります。

