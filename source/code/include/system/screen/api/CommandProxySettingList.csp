<?php

namespace grn\system\screen\api;

use grn\grn\customization\logic\ProxySettingLogic;

class CommandProxySettingList extends ProxySettingBase
{
    public function post($input)
    {
        $this->delete();
        cb_redirect('system/api/proxy_list');
    }

    private function delete()
    {
        $proxy_ids = $this->getInput()['proxy_ids'] ?? [];
        if ( ! is_array($proxy_ids)) {
            return;
        }
        $proxy_setting_logic = new ProxySettingLogic();
        $proxies = $proxy_setting_logic->getByIds($proxy_ids);
        $proxy_setting_logic->deleteMulti(array_keys($proxies));

        require_once('grn/logger.csp');
        $logger_manager = \CB_LoggerManager::getInstance();
        $logger = $logger_manager->getLogger('grn.common');
        $log_action = 'delete';
        $log_target = 'proxy_api';
        foreach ($proxies as $proxy) {
            $log_params = sprintf("id:%s, code:'%s'", $proxy->getId(),
                $proxy->getCode());
            $log_message = sprintf("[%s] %s (%s)", $log_action, $log_target,
                $log_params);
            $logger->noticeEx($log_action, $log_target, $log_message);
        }
    }
}
