<?php

namespace grn\system\sandbox\dao;

class CbUserRoleRelationSandboxDAO
{
    public function copyAll()
    {
        $db = cb_get_master_db();

        $query = "INSERT INTO tab_cb_userrolerelation_sandbox (" .

                 "_id, " .
                 "col_role, " .
                 "col_role_list, " .
                 "col_user, " .
                 "col_user_list) " .

                 "(SELECT " .
                 "_id, " .
                 "col_role, " .
                 "col_role_list, " .
                 "col_user, " .
                 "col_user_list " .
                 "FROM tab_cb_userrolerelation)";

        $db->query($query);
    }

    public function deleteAll()
    {
        $db = cb_get_master_db();
        $db->query("DELETE FROM tab_cb_userrolerelation_sandbox");
    }

    /**
     * @param       $uid
     * @param int[] $roleIds
     *
     * @return bool
     */
    public function setUserRoleRelations($uid, array $roleIds)
    {
        if (empty($roleIds)) {
            return false;
        }

        $db = cb_get_master_db();
        $query
            = "INSERT INTO tab_cb_userrolerelation_sandbox ( col_user, col_role , col_role_list ) VALUES ";

        $values = [];
        $roleList = 0;
        foreach ($roleIds as $roleId) {
            $roleList += 1;
            $values[] = $db->format(" ('@S', '@S', '@S') ",
                [$uid, $roleId, $roleList]);
        }
        $query .= implode(",", $values)
                  . " ON DUPLICATE KEY UPDATE col_role_list=VALUES(col_role_list)";

        $db->query($query);

        return true;
    }

    /**
     * @param       $uid
     * @param int[] $roleIds
     *
     * @return bool
     */
    public function removeUserRoleRelations($uid, array $roleIds)
    {
        if (empty($roleIds)) {
            return false;
        }

        $db = cb_get_master_db();
        $query = $db->format(
            'DELETE FROM tab_cb_userrolerelation_sandbox WHERE col_user="@S" AND col_role IN (@A)',
            [$uid, $roleIds]
        );

        $db->query($query);

        return true;
    }
}
