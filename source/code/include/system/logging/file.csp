<?php

require_once('grn/file.csp');

class GRN_Logging_FileBody extends GRN_FileBody
{
    var $_app_id = 'logging';

    var $col_file
        = [
            'type' => 'weak_relation',
            'to'   => 'GRN_Logging_File',
            'lazy' => true
        ];

    function __construct(& $row)
    {
        parent::__construct($row);
    }
}

class GRN_Logging_FileLog extends GRN_FileLog
{
    var $_app_id = 'logging';

    var $col_file
        = [
            'type' => 'relation',
            'to'   => 'GRN_Logging_File',
            'lazy' => true
        ];
    var $col_body = ['type' => 'weak_relation', 'to' => 'GRN_Logging_FileBody'];

    function __construct(& $row)
    {
        parent::__construct($row);
    }
}

class GRN_Logging_FileLock extends GRN_FileLock
{
    var $_app_id = 'logging';

    var $col_file
        = [
            'type'   => 'relation',
            'to'     => 'GRN_Logging_File',
            'unique' => true
        ];

    function __construct(& $row)
    {
        parent::__construct($row);
    }
}

class GRN_Logging_File extends GRN_File
{
    var $_app_id = 'logging';
    var $_body_table_name = 'GRN_Logging_FileBody';
    var $_log_table_name = 'GRN_Logging_FileLog';
    var $_lock_table_name = 'GRN_Logging_FileLock';

    function __construct(& $row)
    {
        parent::__construct($row, 'grn.logging');
    }
}

class GRN_Logging_FileManager_Core extends GRN_FileManager
{
    function __construct()
    {
        $this->_file_table =& cb_class2table('GRN_Logging_File');
        $this->_body_table =& cb_class2table('GRN_Logging_FileBody');
    }

    function &getFile($id)
    {
        if ( ! $id) {
            $ret = false;

            return $ret;
        }

        $rowset = new CB_RowSet($this->_file_table);
        $condition = $rowset->queryf("_id = '@S'", $id);
        $rowset->addCondition($condition);
        $row = $rowset->iterate();
        $rowset->destroy();

        if (is_null($row)) {
            $ret = false;

            return $ret;
        }

        return $row;
    }

    function &getFileBody($id)
    {
        if ( ! $id) {
            $ret = false;

            return $ret;
        }

        $rowset = new CB_RowSet($this->_body_table);
        $condition = $rowset->queryf("col_file = '@S'", $id);
        $rowset->addCondition($condition);
        $row = $rowset->iterate();
        $rowset->destroy();

        if (is_null($row)) {
            $ret = false;

            return $ret;
        }

        $file_row = $row->get('file');

        return $file_row;
    }

    function deleteFile($id)
    {
        if ( ! $id) {
            $ret = false;

            return $ret;
        }

        $file = &$this->getFile($id);

        $file->delete();
    }
}


