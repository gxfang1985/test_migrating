<?php

namespace grn\favour\screen;

use grn\favour\service\FavourService;
use grn\favour\exception\FavourException;
use grn\favour\data\collection\FavourCollection;
use grn\space\common\exception\GrnInvalidPermissionException;
use grn\grn\access\service\AppAccess;

class FavourerList extends FavourScreenBase
{
    const FAVOURER_LIMIT = 20;

    public function fetch()
    {
        $input = $this->getInput();
        $params = [
            self::ARG_MODULE,
            self::ARG_SUB_MODULE,
            self::ARG_TYPE,
            self::ARG_VALUE
        ];
        $this->checkArgs($input, $params);

        $this->checkInternalAccess();

        try {
            $auth = $this->checkLoginUserAuthority($input);
        } catch (GrnInvalidPermissionException $e) {
            throw new FavourException($e->getErrorCode());
        }
        if ( ! $auth) {
            throw new FavourException();
        }

        $favour_service = new FavourService();
        $favour_collection
            = $favour_service->getFavourCollection($this->getModuleId(),
            $this->getType(), $this->getTypeValue(), $this->getSubModuleId());

        $login = $this->getLoginUser();
        $favourer_ids = [];
        $favourer_list = [];
        require_once('fw/basic_date.csp');
        foreach ($favour_collection as $favour) {
            $favourer = [];
            $ts = new \CB_TimeStamp;
            $ts->unix_ts = $favour->getTimestamp();
            $favourer['timestamp'] = $ts;
            $favourer['favourer_id'] = $favour->getFavourerId();
            $favourer['favourer_name'] = $favour->getFavourerName();
            $favourer['module_id'] = $favour->getModuleId();
            $favourer_list[$favour->getId()] = $favourer;
            $favourer_ids[] = $favour->getFavourerId();
        }

        require_once('grn/smarty.csp');
        $smarty = new \GRN_Smarty();
        $smarty->assign('favourer_list', $favourer_list);
        $smarty->assign('max_count_favourer', self::FAVOURER_LIMIT);

        // user image icon
        require_once('grn/controller.csp');
        $image_icon = \GRN_ControllerUtil::getUserIconFormat($login);
        $smarty->assign('image_icon', $image_icon);
        $users_info
            = \GRN_ControllerUtil::getUserInfoToShowUserName($favourer_ids,
            $login);
        if ($image_icon) {
            $users_info = \GRN_ControllerUtil::addPhotoUrlForUsersInfo($users_info,
                \GRN_ControllerUtil::getUserProfilePhotoSmallSize());
            $smarty->assign('icon_size', \GRN_ControllerUtil::ICON_SIZE_SMALL);
        }
        $smarty->assign('users_info', $users_info);
        $smarty->assign('login_id', $login->getOID());

        return $smarty->fetch('favour/favourer_list.tpl');
    }
}

