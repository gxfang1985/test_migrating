<?php
require_once('fw/profile.csp');
require_once('star/resources.csp');

/**
 * Star System Logic
 *
 * @author Tuyen Truong 2009/11
 * Class GRN_Star_SystemLogic
 */
class GRN_Star_SystemLogic extends CB_ModuleBase
{
    /**
     * @access private
     */
    function __construct()
    {
        parent::__construct(GRN_STAR_MODULE_ID . '.system');
    }

    /** @var self */
    private static $_instance = null;

    /**
     * @return GRN_Star_SystemLogic
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * @param CB_Profile $profile
     * @param            $profile_key
     *
     * @return bool
     */
    function createAttribute($profile, $profile_key)
    {
        if ( ! is_a($profile, 'CB_Profile')) {
            return false;
        }

        return $profile->createAttribute($profile_key, '');
    }

    /**
     * @param CB_Profile $profile
     * @param            $profile_key
     * @param            $value
     *
     * @return bool
     */
    function updateAttribute($profile, $profile_key, $value)
    {
        $temp = null;
        $ret = $profile->getAttribute($profile_key, $temp);

        if ($ret === false) {
            $ret = $this->createAttribute($profile, $profile_key);
            if ($ret === false) {
                return false;
            }
        }

        return $profile->updateAttribute($profile_key, $value);
    }

    /**
     * @param    boolean $flag true: available, false: not available
     *
     * @return bool
     */
    function setStarAvailable($flag)
    {
        $profile = $this->getSystemProfile();

        return $this->updateAttribute($profile, GRN_STAR_STAR_AVAILABLE, $flag);
    }

    /**
     * @return bool|null
     */
    function getStarAvailable()
    {
        $profile = $this->getSystemProfile();

        $value = null;
        $ret = $profile->getAttribute(GRN_STAR_STAR_AVAILABLE, $value);
        if ( ! $ret) {
            return false;
        }

        return $value;
    }

    /**
     * @param    int $limit star limit
     *
     * @return bool
     */
    function setStarLimit($limit)
    {
        $profile = $this->getSystemProfile();

        return $this->updateAttribute($profile, GRN_STAR_STAR_LIMIT, $limit);
    }

    /**
     * @return    int        Star Limit
     */
    function getStarLimit()
    {
        $profile = $this->getSystemProfile();

        $value = -1;
        $ret = $profile->getAttribute(GRN_STAR_STAR_LIMIT, $value);
        if ( ! $ret) {
            $value = GRN_STAR_LIMIT_DEFAULT;    // default: 50
        }

        return $value;
    }
}

