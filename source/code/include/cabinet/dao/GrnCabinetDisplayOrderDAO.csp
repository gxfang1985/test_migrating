<?php

require_once('fw/database.csp');
require_once('cabinet/bean/GrnCabinetDisplayOrder.csp');

class GrnCabinetDisplayOrderDAO
{
    /**
     * @param                        $inDataObj
     * @param GrnCabinetDisplayOrder $inCabinetDisplayOrderObj
     *
     * @return bool|int
     */
    public function insert($inDataObj, $inCabinetDisplayOrderObj)
    {
        /* @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inFolderId = $inCabinetDisplayOrderObj->getFolderId();
        $inOrder = serialize($inCabinetDisplayOrderObj->getOrder());

        $query
            = "INSERT INTO tab_grn_cabinet_filedisplayorder( col_folder, col_order )";
        $query = cb_queryf($inDb, $query . " VALUES ( '@S', '@S');",
            $inFolderId, $inOrder);
        if ($inDb->query($query) === false) {
            $inDb->throwServerError($query);
        }

        $insertCount = $inDb->affected_rows();

        return $insertCount;
    }

    /**
     * @param                        $inDataObj
     * @param GrnCabinetDisplayOrder $inCabinetDisplayOrderObj
     *
     * @return bool|int
     */
    public function update($inDataObj, $inCabinetDisplayOrderObj)
    {
        /* @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inFolderId = $inCabinetDisplayOrderObj->getFolderId();
        $inOrder = serialize($inCabinetDisplayOrderObj->getOrder());

        $query = "UPDATE tab_grn_cabinet_filedisplayorder";
        $query = cb_queryf($inDb,
            $query . " SET col_order = '@S' WHERE col_folder = '@S'", $inOrder,
            $inFolderId);

        if ($inDb->query($query) === false) {
            $inDb->throwServerError($query);
        }

        $updateCount = $inDb->affected_rows();

        return $updateCount;
    }

    /**
     * @param array  $inDataObj
     * @param string $inFolderId
     *
     * @return GrnCabinetDisplayOrder
     */
    public function getCabinetDisplayOrderByFolderId($inDataObj, $inFolderId)
    {
        /* @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $query = "SELECT _id, col_folder, col_order";
        $query = $query . " FROM tab_grn_cabinet_filedisplayorder";
        $query = $query . " WHERE ";
        $query = cb_queryf($inDb, $query . " col_folder = '@S'", $inFolderId);

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        if ($rawdata = $inDb->fetch_assoc($result)) {
            $rawdata['col_order'] = @cb_unserialize($rawdata['col_order'],
                ["allowed_classes" => false]);
            $grnCabinetDisplayOrder = new GrnCabinetDisplayOrder($rawdata);
        } else {
            $grnCabinetDisplayOrder = new GrnCabinetDisplayOrder();
        }
        $inDb->free_result($result);
        $result = false;

        return $grnCabinetDisplayOrder;
    }

}
