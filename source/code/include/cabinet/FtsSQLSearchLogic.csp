<?php

namespace grn\cabinet;

use grn\fts\api\SearchApiParameter;
use grn\fts\SearchQuery;
use grn\fts\SearchTarget;
use grn\fts\SQLSearchLogicInterface;
use GrnCabinetFolderCondition;

class FtsSQLSearchLogic implements SQLSearchLogicInterface
{
    /** @var SearchApiParameter */
    private $parameter;

    private function __construct(SearchApiParameter $parameter)
    {
        $this->parameter = $parameter;
    }

    /**
     * @param SearchApiParameter $parameter
     *
     * @return FtsSQLSearchLogic
     */
    public static function create($parameter)
    {
        return new self($parameter);
    }

    /**
     * @return \Iterator
     */
    public function iterator()
    {
        if (is_null($this->parameter->getKeyword())
            || strlen($this->parameter->getKeyword()) == 0
        ) {
            return;
        }

        $search_result = $this->search();

        foreach ($search_result as $item) {
            yield $item;
        }
    }

    private function search()
    {
        require_once('cabinet/include_fts_search.csp');
        require_once('cabinet/bean/GrnCabinetFolderCondition.csp');

        $search_folder_condition = new \GrnCabinetFolderCondition();
        $search_folder_condition->setUser(cb_get_login_user());
        $search_folder_condition->setFolderId($this->parameter->getCabinetFolderId());
        $search_folder_condition->setSearchAll($this->parameter->getTarget()
                                               == SearchTarget::ALL);
        $search_folder_condition->setOffset($this->parameter->getStart());
        $search_folder_condition->setLimit(SearchQuery::DEFAULT_SIZE + 1);
        $search_folder_condition->setSearchWords($this->parameter->getKeyword());

        $search = new \GRN_Cabinet_FolderFtsSearch($search_folder_condition);

        return $search->searchExecute();
    }

    /**
     * @param $parameter \grn\fts\api\SearchApiParameter
     */
    public function setOptionalCondition($parameter)
    {
    }
}
