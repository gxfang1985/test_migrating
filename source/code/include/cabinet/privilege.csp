<?php

/**
 * ファイル管理特権管理
 *
 * @date    2005/03/08
 * @author  Y.Tanaka
 * @package grn.cabinet
 */

require_once('cabinet/uum_evaluation.csp');
require_once('grn/application.csp');

/**
 * 特権管理クラス
 *
 * @package grn.cabinet
 */
class GRN_Cabinet_PrivilegeManager extends GRN_Cabinet_UumEvaluation
{
    private static $_instance = null;

    /**
     * @static
     * @return GRN_Cabinet_PrivilegeManager
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * コンストラクタ
     */
    function __construct()
    {
        parent::__construct();

        $this->_table_prefix = 'prv';
        $this->_column_prefix = 'authority_';
        $this->_auth_columns = ['operation' => 0];
    }

    function onAction($action, & $object, & $target, $authorities)
    {
        require_once('inspection.csp');
        $inspection = GRN_Cabinet_Inspection::getInstance();
        $inspection->writeLogPrivilege($action, $object, $target, 'privilege');
    }

    /**
     * @access private
     */
    var $_parent_cache = [];

    /**
     * フォルダに対してユーザーが持つ権限を取得する
     *
     * @param CB_User                   $user   アクセスするユーザー
     * @param string|GRN_Cabinet_Folder $folder フォルダ
     *
     * @return array  array( 'read'=>[0,1], 'write'=>[0,1] )
     */
    function getPrivileges($user, $folder)
    {
        if (is_object($folder)) {
            $hid = $folder->getOID();
        } else {
            $hid = $folder;
        }

        if ( ! $hid) {
            return [];
        }

        $hierarchy = [];

        $app_locator = GRN_ApplicationLocator::instance();
        $db = $app_locator->getConnection('cabinet');

        $current = $hid;
        $current = $db->escape($current);

        while ( ! is_null($current)) {
            $hierarchy = [$current => 1] + $hierarchy;
            if (array_key_exists($current, $this->_parent_cache)) {
                $current = $this->_parent_cache[$current];
            } else {
                $query = "SELECT col_parent FROM tab_"
                         . $this->_object_class_name
                         . " WHERE _id = '{$current}'";
                $result = $db->query($query);
                if (cb_is_db_result($result)) {
                    $row = $db->fetch_row($result);
                    $this->_parent_cache[$current] = $row[0];;
                    $current = $row[0];
                    $db->free_result($result);
                } else {
                    $current = null;
                }
            }
        }

        $privileges = $this->evaluateUserObjects($user, $hierarchy);

        if ( ! $privileges) {
            return [];
        }

        $privileges_keys = array_keys($privileges);
        $idx = array_pop($privileges_keys);
        $result = $privileges[$idx];
        unset($privileges[$idx]);

        foreach (array_keys($privileges) as $oid) {
            $auth = $privileges[$oid];

            foreach (array_keys($auth) as $key) {
                if ( ! array_key_exists($key, $result)) {
                    $result[$key] = $auth[$key];
                } else {
                    $result[$key] |= $auth[$key];
                }
            }
        }

        return $result;
    }

    /**
     * 権限が与えられているかしらべる
     *
     * @param CB_User       $user       ユーザー
     * @param object|string $folder     フォルダまたはフォルダID
     * @param mixed         $privileges 権限文字列または権限文字列の配列
     *
     * @return boolean
     */
    function privileged(& $user, & $folder, $privileges)
    {
        if ( ! $privileges) {
            return false;
        }

        if ( ! is_array($privileges)) {
            if ( ! is_string($privileges)) {
                return false;
            }

            $privileges = [$privileges];
        }

        $granted = $this->getPrivileges($user, $folder);

        foreach ($privileges as $key) {
            if ( ! @ $granted[$key]) {
                return false;
            }
        }

        return true;
    }

    /**
     * フォルダの権限を評価して、権限を有するフォルダリストを取得
     *
     * @param CB_User     $user       ユーザー
     * @param array       $folders    評価するフォルダのリスト
     * @param integer     $privileges 評価する権限のリスト
     * @param string|null $parent_id
     *
     * @return array
     */
    function evaluateFolders(& $user, $folders, $privileges, $parent_id = null)
    {
        if ( ! $user || ! $folders || ! $privileges) {
            return [];
        }

        if ( ! is_null($parent_id)) {
            if ( ! $this->privileged($user, $parent_id, $privileges)) {
                return [];
            }
        }

        // cache privileges
        $authorities = $this->evaluateUserObjects($user, $folders);

        if ( ! is_array($privileges)) {
            if ( ! is_string($privileges)) {
                return [];
            }

            $privileges = [$privileges];
        }

        $granted = [];
        foreach ($privileges as $key) {
            $granted[$key] = 1;
        }

        foreach (array_keys($folders) as $id) {
            if ( ! is_null($parent_id)) {
                $this->_parent_cache[$id] = $parent_id;

                if ($authorities[$id] != $granted) {
                    unset($folders[$id]);
                }
            } else {
                if ( ! $this->privileged($user, $id, $privileges)) {
                    unset($folders[$id]);
                }
            }
        }

        return $folders;
    }
}

