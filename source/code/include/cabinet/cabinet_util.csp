<?php

/**
 * ファイル管理ユーティリティ
 *
 * @author  Tanaka, Yoshiaki        2004/11
 * @package grn.cabinet
 */

require_once('fw/module.csp');


class GRN_Cabinet_Util extends CB_ModuleBase
{
    private static $_instance = null;

    /**
     * @return GRN_Cabinet_Util
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    function __construct()
    {
        parent::__construct('grn.cabinet.util');
    }


    /**
     *
     * @param object $user
     * @param object $file
     * @param bool   $folder_view
     * @param offset $offset
     *
     * @return array
     * @access public
     */
    function getFileListView(
        & $user,
        & $file,
        $folder_view = false,
        $offset = -1
    ) {
        $body =& $file->getCurrentBody();
        $modifier =& $file->get('modifier');

        $file_for_view = [
            'id'       => $file->getOID(),
            'title'    => $file->getTitle(),
            'filename' => $body->get('name'),
            'size'     => $body->get('size'),
        ];

        if ($user) {
            require_once('cabinet/notification.csp');
            $nm = GRN_Cabinet_NotificationManager::getInstance();
            $file_for_view['unread'] = $nm->getReadStatus($user, $file);
        }

        require_once('grn/controller.csp');
        $utility = new GRN_ControllerUtil();

        $utility->getCreatorView($file, $file_for_view);
        $utility->getModifierView($file, $file_for_view);

        if ($folder_view) {
            require_once('cabinet/file.csp');
            $filemgr = GRN_Cabinet_FileManager::getInstance();
            if (($folder =& $filemgr->getFolder($file))) {
                $file_for_view['hid'] = $folder->getOID();
                $file_for_view['folder_title'] = $folder->get('name');
            }
        }

        return $file_for_view;
    }

    function setBreadcrumbsList(& $smarty_object, $page_path)
    {
        $page_title = grn_get_current_page_display_name();
        $smarty_object->assign('app_id', 'cabinet');
        $smarty_object->assign('page_title', $page_title);

        $positions = [];
        if ($page_path) {
            foreach ($page_path as $node) {
                $page = $node['page'];
                unset($node['page']);

                $positions[] = ([
                                    'page' => $page,
                                    'name' => grn_get_page_display_name($page)
                                ] + $node);
            }
        }
        $positions[] = ['page' => "", 'name' => $page_title];

        $smarty_object->assign('site_position', $positions);
    }

}


