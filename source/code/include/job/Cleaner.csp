<?php

namespace grn\job;

use grn\fts\Application as FtsApplication;
use grn\fts\mail\cleanup\TempFileCleaner;

class Cleaner
{
    /** @var \CB_DatabaseConnection */
    private $db;

    public function __construct()
    {
        $this->db = cb_get_app_db('job');
    }

    public function cleanupFailedQueue()
    {
        if (defined('ON_FOREST') || ! FtsApplication::isAvailable()) {
            return;
        }
        if ( ! $this->findFailedQueueTable()) {
            return;
        }
        $this->db->query('DELETE FROM cb_slash._failed_queue WHERE ctime < DATE_SUB(UTC_TIMESTAMP(), INTERVAL 30 DAY)');
    }

    /**
     * @return bool
     */
    private function findFailedQueueTable()
    {
        $showDatabases = $this->db->query("SHOW DATABASES LIKE 'cb_slash'");
        if ( ! $this->db->fetch_assoc($showDatabases)) {
            return false;
        }
        $showTables
            = $this->db->query("SHOW TABLES FROM cb_slash LIKE '_failed_queue'");
        if ( ! $this->db->fetch_assoc($showTables)) {
            return false;
        }

        return true;
    }

    public function cleanupTemporaryFiles()
    {
        $tempFileCleaner = new TempFileCleaner();
        $tempFileCleaner->clean();
    }
}
