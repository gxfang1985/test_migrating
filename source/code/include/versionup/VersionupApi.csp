<?php

namespace grn\versionup;


class VersionupApi
{
    private function prepare()
    {
        global $G_state_set;
        $G_state_set->set('copyright_should_be_written', false);
        $G_state_set->set('html_should_be_closed', false);
        $G_state_set->set('error_page_type', 'plain');

        if (cb_is_onpremises()) {
            cb_throw_error('FW00043', null, null, null,
                ['page' => cb_get_pagename()]);
        }

        UpdaterLock::acquire();
    }

    private function getUpdater()
    {
        $version = trim(getenv("HTTP_X_CYBOZU_DESTINATION_VERSION"));

        return UpdaterFactory::createUpdater($version);
    }

    public function runBefore()
    {
        $this->prepare();
        $this->getUpdater()->runBefore();
    }

    public function runMiddle()
    {
        $this->prepare();
        $this->getUpdater()->runMiddle();
    }

    public function runAfter()
    {
        $this->prepare();
        $this->getUpdater()->runAfter();
    }
}
