<?php
declare(strict_types=1);

namespace grn\versionup\v18_11_1;

use grn\versionup\AbstractUpdater;
use grn\versionup\AlterTable;

class Updater extends AbstractUpdater
{
    protected function before()
    {
        // Never write code here before understanding the following comment!

        // This updater is called on upgrading Gr4.10.0 and F18.11.
        // If you need to add logic to change schema/data for future On-premise versions (which correspond with F18.11) and F18.11,
        // please write it on v18_11_2\Updater.csp
    }

    protected function middleAlterTables()
    {
        // Never write code here before understanding the following comment!

        // This updater is called on upgrading Gr4.10.0 and F18.11.
        // If you need to add logic to change schema/data for future On-premise versions (which correspond with F18.11) and F18.11,
        // please write it on v18_11_2\Updater.csp
        $this->addUniqueIndexTabGrnBulletinReadStatus();
        $this->addUniqueIndexTabGrnScheduleRepeatCondition();
        $this->addUniqueIndexTabGrnWorkflowFolder();
        $this->addUniqueIndexTabGrnMessageFolder();
        $this->addUniqueIndexTabGrnRssPersonalFolder();

        // GTM-5371 query tuning of schedule view screen.
        $this->addIndexTabGrnScheduleEventdatetime();
    }

    protected function middleUpdateData()
    {
        // Never write code here before understanding the following comment!

        // This updater is called on upgrading Gr4.10.0 and F18.11.
        // If you need to add logic to change schema/data for future On-premise versions (which correspond with F18.11) and F18.11,
        // please write it on v18_11_2\Updater.csp
    }

    protected function after()
    {
        // Never write code here before understanding the following comment!

        // This updater is called on upgrading Gr4.10.0 and F18.11.
        // If you need to add logic to change schema/data for future On-premise versions (which correspond with F18.11) and F18.11,
        // please write it on v18_11_2\Updater.csp
    }

    private function addUniqueIndexTabGrnBulletinReadStatus()
    {
        $db = cb_get_app_db('bulletin');
        $alter_table = new AlterTable($db, 'tab_grn_bulletin_readstatus');
        $alter_table->dropIndex("idx_u_a", ["col_user", "col_article"]);
        $alter_table->addUniqueIndex("idx_u_a", ["col_user", "col_article"]);
        $alter_table->execute();

        $this->log('Succeeded to add an unique index in tab_grn_bulletin_readstatus.');
    }

    private function addUniqueIndexTabGrnScheduleRepeatCondition()
    {
        $db = cb_get_app_db('schedule');
        $alter_table = new AlterTable($db, 'tab_grn_schedule_repeatcondition');
        $alter_table->addUniqueIndex("idx_event", ["col_event"]);
        $alter_table->dropIndex("cni_event", ["col_event"]);
        $alter_table->execute();

        $this->log('Succeeded to add an unique index in tab_grn_schedule_repeatcondition.');
    }

    private function addUniqueIndexTabGrnWorkflowFolder()
    {
        $db = cb_get_app_db('workflow');
        $alter_table = new AlterTable($db, 'tab_grn_workflow_folder');
        $alter_table->addUniqueIndex("idx_user_foreign_key", ["col_user", "col_foreign_key"]);
        $alter_table->execute();

        $this->log('Succeeded to add an unique index in tab_grn_workflow_folder.');
    }

    private function addUniqueIndexTabGrnMessageFolder()
    {
        $db = cb_get_app_db('message');
        $alter_table = new AlterTable($db, 'tab_grn_message_folders');
        $alter_table->dropIndex("cni_user", ["col_user"]);
        $alter_table->dropIndex("idx_user_folder_type", ["col_user", "col_folder_type"]);
        $alter_table->addUniqueIndex("idx_user_folder_type", ["col_user", "col_folder_type"]);
        $alter_table->execute();

        $this->log('Succeeded to delete unnecessary indexes and add an unique index in tab_grn_message_folders.');
    }

    private function addUniqueIndexTabGrnRssPersonalFolder()
    {
        $db = cb_get_app_db('rss');
        $alter_table = new AlterTable($db, 'tab_grn_rss_personalfolder');
        $alter_table->dropIndex("idx_user_type", ["col_user", "col_type"]);
        $alter_table->addUniqueIndex("idx_user_type", ["col_user", "col_type"]);
        $alter_table->dropIndex("cni_user", ["col_user"]);
        $alter_table->execute();

        $this->log('Succeeded to delete unnecessary indexes and add an unique index in tab_grn_rss_personalfolder.');
    }

    private function addIndexTabGrnScheduleEventdatetime()
    {
        $db = cb_get_app_db('schedule');
        $alter_table = new AlterTable($db, 'tab_grn_schedule_eventdatetime');
        $alter_table->addIndex("idx_setdatetime_enddatetime", ["col_setdatetime", "col_enddatetime"]);
        $alter_table->execute();

        $this->log('Succeeded to add index in tab_grn_schedule_eventdatetime.');
    }
}
