<?php

namespace grn\versionup\v7_7_1010;

use grn\versionup\AbstractUpdater;

class Updater extends AbstractUpdater
{
    protected function before()
    {
    }

    protected function middleAlterTables()
    {
    }

    protected function middleUpdateData()
    {
        $this->updateTheNumericAccessRightOfWorkflow();
    }

    protected function after()
    {
    }

    /**
     * GTM-3852
     */
    private function updateTheNumericAccessRightOfWorkflow()
    {
        $db = cb_get_app_db('workflow');
        if ($this->isCalledFromDotComConverter() || cb_is_onpremises()) {
            /*
             * Case When upgrading onpremises:
             * Case When migrating with the uploader:
             *
             * Update the numeric value item to the following fixed value.
             * Applicant [View:1, Edit:1]
             * Approver [View:1, Edit:NULL]
             */

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_item 
SET
 col_attach_file_view='1' ,
 col_attach_file='1'
WHERE
 col_foreign_key='grn.workflow.numeric'
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_itemdata 
SET
 col_attach_file_view='1',
 col_attach_file='1'
WHERE
 col_foreign_key='grn.workflow.numeric'
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_accesschangeform AS accesschangeform 
SET
 accesschangeform.col_view='1',
 accesschangeform.col_edit=NULL 
WHERE
 accesschangeform.col_item IN ( SELECT item._id FROM tab_grn_workflow_item AS item WHERE item.col_foreign_key='grn.workflow.numeric' )
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_accesschangedata AS accesschangedata 
SET
 accesschangedata.col_view='1',
 accesschangedata.col_edit=NULL 
WHERE
 accesschangedata.col_item_data IN ( SELECT itemdata._id FROM tab_grn_workflow_itemdata AS itemdata WHERE itemdata.col_foreign_key='grn.workflow.numeric' )
SQL;
            $db->query($query);
        } else {
            /*
             * Case When upgrading forest:
             *
             * Update the following invalid value of the numerical value item.
             * Applicant [View:NULL, Edit:1]
             * Approver [View:NULL, Edit:1]
             */

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_item 
SET
 col_attach_file_view='1' 
WHERE
 col_foreign_key='grn.workflow.numeric'
 AND col_attach_file='1'
 AND col_attach_file_view IS NULL
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_itemdata 
SET
 col_attach_file_view='1' 
WHERE
 col_foreign_key='grn.workflow.numeric'
 AND col_attach_file='1'
 AND col_attach_file_view IS NULL
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_accesschangeform AS accesschangeform 
SET
 accesschangeform.col_view='1' 
WHERE
 accesschangeform.col_item IN ( SELECT item._id FROM tab_grn_workflow_item AS item WHERE item.col_foreign_key='grn.workflow.numeric' )
 AND accesschangeform.col_edit='1'
 AND accesschangeform.col_view IS NULL
SQL;
            $db->query($query);

            $query
                = <<<SQL
UPDATE
 tab_grn_workflow_accesschangedata AS accesschangedata 
SET
 accesschangedata.col_view='1' 
WHERE
 accesschangedata.col_item_data IN ( SELECT itemdata._id FROM tab_grn_workflow_itemdata AS itemdata WHERE itemdata.col_foreign_key='grn.workflow.numeric' )
 AND accesschangedata.col_edit='1'
 AND accesschangedata.col_view IS NULL
SQL;
            $db->query($query);
        }

        $this->log("Succeeded to update the numeric access right of workflow.");
    }
}
