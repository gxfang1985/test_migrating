<?php

namespace grn\versionup\v7_2_910;

use grn\versionup\AbstractUpdater;

class Updater extends AbstractUpdater
{
    protected function before()
    {
    }

    protected function middleAlterTables()
    {
    }

    protected function middleUpdateData()
    {
        $this->deleteInvalidMessageRelationData();
    }

    protected function after()
    {
    }

    private function deleteInvalidMessageRelationData()
    {
        $db = cb_get_app_db('message');
        $user_tables = cb_get_user_tables();
        for ($i = 0; $i < $user_tables; ++$i) {
            $db->query(
                'DELETE mf FROM tab_grn_message_foldermessagerelations___p' . $i
                . ' mf ' .
                'INNER JOIN tab_grn_message_addressees ma ' .
                'ON ma.col_message=mf.col_message AND ma.col_addressee=mf.col_user '
                .
                'WHERE ma.col_dtime > 0 AND mf.col_snapshot_message IS NULL'
            );
        }
        $this->log("Succeeded to delete invalid message relation data.");
    }
}
