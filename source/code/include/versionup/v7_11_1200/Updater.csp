<?php

namespace grn\versionup\v7_11_1200;

use grn\fw\DistributorDBConvert;
use grn\versionup\AbstractUpdater;
use grn\versionup\AlterTable;

class Updater extends AbstractUpdater
{
    protected function before()
    {
    }

    protected function middleAlterTables()
    {
        if (cb_is_forest()) {
            $this->alterTableTabGrnUserinfo();
            $this->modifyBulletinReadstatusTable();
            $this->alterTableCybozuWebService();
        }
    }

    protected function middleUpdateData()
    {
        if (cb_is_onpremises_distributed_database()) {
            $this->deleteUnnecessaryDataLargescale();
        }
    }

    protected function after()
    {
        if (cb_is_onpremises_distributed_database()) {
            $this->dropUnnecessaryTablesLargescale();
        }
    }

    private function alterTableTabGrnUserinfo()
    {
        $db = cb_get_app_db('master');
        $alter_table = new AlterTable($db, 'tab_grn_userinfo');

        $alter_table->dropColumn('col_attendee');
        $alter_table->dropColumn('col_attendee_mtime');
        $alter_table->execute();

        $this->log("Succeeded to alter the tab_grn_userinfo table.");
    }

    /**
     * GTM-3778
     */
    private function modifyBulletinReadstatusTable()
    {
        $db = cb_get_app_db('bulletin');
        $alter_table = new AlterTable($db, 'tab_grn_bulletin_readstatus');

        $alter_table->dropColumn("col_reserve_blob1");
        $alter_table->dropColumn("col_reserve_blob2");
        $alter_table->dropColumn("col_reserve_blob3");
        $alter_table->dropColumn("col_reserve_int1");
        $alter_table->dropColumn("col_reserve_int2");
        $alter_table->dropColumn("col_reserve_int3");
        $alter_table->dropColumn("col_reserve_text1");
        $alter_table->dropColumn("col_reserve_text2");
        $alter_table->dropColumn("col_reserve_text3");

        $alter_table->execute();

        $this->log("Succeeded to modify the tab_grn_bulletin_readstatus table.");
    }

    /**
     * GTM-1860
     */
    private function dropUnnecessaryTablesLargescale()
    {
        $tables = DistributorDBConvert::TABLES;

        $schedule_id = DistributorDBConvert::APP_SCHEDULE;
        $db = cb_get_app_db($schedule_id);
        foreach ($tables[$schedule_id] as $table) {
            $db->query("DROP TABLE IF EXISTS $table");
            $this->log("Succeeded to drop $table table");
        }

        $others_id = DistributorDBConvert::APP_OTHERS;
        $db = cb_get_master_db();
        foreach ($tables[$others_id] as $table) {
            $db->query("DROP TABLE IF EXISTS $table");
            $this->log("Succeeded to drop $table table");
        }
    }

    /**
     * GRB-19271
     */
    private function deleteUnnecessaryDataLargescale()
    {
        $table = 'tab_cb_profiledata___p1';

        // 5 is the maximum id of unnecessary data
        $query_select = "SELECT _id, col_key FROM $table WHERE _id <= 5";
        $query_delete = "DELETE FROM $table WHERE _id = '@S'";

        $connections = get_profile_get_connections();
        foreach ($connections as $connection) {
            $result = $connection->query($query_select);
            while ($row = $connection->fetch_assoc($result)) {
                $id = $row['_id'];
                $user_id = $row['col_key'];
                $user_connection = grn_profile_get_connection($user_id);

                if ($connection->getHostName()
                    != $user_connection->getHostName()
                ) {
                    $query = $connection->format($query_delete, [$id]);
                    $connection->query($query);
                    $this->log("Succeeded to delete unnecessary data on $table table. Id: $id");
                }
            }
            $connection->free_result($result);
        }
    }

    private function alterTableCybozuWebService()
    {
        $db = cb_get_master_db();
        $alter_table = new AlterTable($db, 'tab_grn_cbwebsrv_weather');

        $alter_table->dropColumn('col_image');
        $alter_table->dropColumn('col_max_temp');
        $alter_table->dropColumn('col_min_temp');
        $alter_table->dropColumn('col_prob_of_prec');

        $alter_table->execute();
        $this->log("Succeeded to alter the tab_grn_cbwebsrv_weather table.");
    }
}
