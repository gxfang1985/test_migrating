<?php

namespace grn\grn\access\dao;

use grn\grn\access\bean\Availability;

class AvailabilityUserDAO extends AvailabilityBaseDAO
{
    /**
     * AvailabilityUserDAO constructor.
     */
    function __construct()
    {
        parent::__construct();
        $this->table = "tab_grn_availability_user";
        $this->targetColumn = "col_user";
    }

    /**
     * @param array $raw_data
     *
     * @return Availability
     */
    protected function convertArrayToBean(array $raw_data)
    {
        $availability = parent::convertArrayToBean($raw_data);
        $availability->setTargetType(Availability::USER);

        return $availability;
    }

    /**
     * @param array $user_ids
     *
     * @return Availability[]
     */
    public function getByUserIds($user_ids)
    {
        $query
            = "SELECT _id, col_app, col_user, col_ctime FROM tab_grn_availability_user";
        $query .= cb_queryf($this->dbConn, " WHERE col_user IN (@A) ;",
            $user_ids);

        $availability_list = [];
        $result = $this->dbConn->query($query);
        while ($rawData = $this->dbConn->fetch_assoc($result)) {
            $availability = $this->convertArrayToBean($rawData);
            $availability->setTarget($rawData['col_user']);
            if (array_key_exists($availability->getTarget(),
                $availability_list)
            ) {
                $availability_list[$availability->getTarget()][]
                    = $availability;
            } else {
                $availability_list[$availability->getTarget()]
                    = [$availability];
            }
        }
        $this->dbConn->free_result($result);

        return $availability_list;
    }
}
