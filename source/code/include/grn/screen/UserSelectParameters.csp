<?php

namespace grn\grn\screen;

use grn\grn\MemberLogic;

define('GRN_USER_SELECT_PAGE_FUNC_INIT', '0');
define('GRN_USER_SELECT_PAGE_FUNC_BROWSE', '1');
define('GRN_USER_SELECT_PAGE_FUNC_ADD', '2');
define('GRN_USER_SELECT_PAGE_FUNC_REMOVE', '3');
define('GRN_USER_SELECT_PAGE_FUNC_APPLY', '4');
define('GRN_USER_SELECT_PAGE_FUNC_MULTI_APPLY', '5');

/**
 * Class UserSelectParameters
 *
 * @package grn\grn\screen
 */
class UserSelectParameters
{
    private $input;

    // パラメタリスト
    // $select_func: 'init','browse','add','remove','apply','multi_apply'
    public $select_func = 'init';
    // $searchword:
    public $searchword = '';
    // $no_multiple: '0','1'
    public $no_multiple = '0';
    // $send_cgi_parameter: '0':Normal '1':Send CGI parameter to parents page(use schedule)
    public $send_cgi_parameter = '0';
    // $include_org: '0','1'
    public $include_org = '0';
    // $system: '0','1'
    public $system = '0';
    // $system_display: '0','1'
    public $system_display = '0';
    // $form_name: Form name of the parent page
    public $form_name = null;
    // $select_name: Select Box name of the parent page
    public $select_name = 'sUID[]';
    // $plugin_name: Access plugin data
    public $plugin_data_name = 'access_plugin';
    // $plugin_session_name: Access plugin session name
    public $plugin_session_name = null;
    // $item_data_name: Add item name
    public $item_data_name = 'item';
    // $item_session_name: Add item session name
    public $item_session_name = null;
    // $s_oid: '0':Root '-1':Search result '-2':Not affiliation user Other:Organization ID
    public $s_oid = '0';
    // $s_rid: '0':All '-1':Search result Other:Selected Role ID
    public $s_rid = '0';
    // $selected_tab: '0':User '1':Role
    public $selected_tab = '0';
    // $app_id: Calling application ID. Using the Session Key for holding data selected by the plurality of user selectable
    public $app_id = 'grn.common';
    // $return_page: Return page
    public $return_page = '';
    // $item_group_id: Selected item group ID
    public $item_group_id = '0';
    // $multi_apply: '0':Single '1':Multi
    public $multi_apply = '0';
    // $plid: Portlet ID
    public $plid = null;
    //$org_id: Selected organization ID
    public $org_id = null;
    // $role_id: Selected role ID
    public $role_id = null;
    // $require_role: '0','1'
    public $require_role_tab = 0;
    // $is_calendar: '0','1'
    public $is_calendar = 0;
    // $is_search_result: '0','1'
    public $is_search_result = 0;
    // $show_group_role: '0','1'
    public $show_group_role = 1;
    // $reflect_to_additional_name:reflect to name
    public $reflect_to_additional_name = null;
    /**
     * @var int|string
     */
    public $more_user_offset = 0;
    /**
     * @var int|string
     */
    public $more_user_limit = -1;

    public $require_dynamic_roles = 0;

    public $require_administrator_role = 0;

    public $ajax_url = null;

    public $selected_tid = null;

    /** @var array */
    public $param_names
        = [
            'select_func',
            'searchword',
            'no_multiple',
            'include_org',
            'system',
            'system_display',
            'form_name',
            'select_name',
            's_oid',
            's_rid',
            'plugin_data_name',
            'plugin_session_name',
            'item_data_name',
            'item_session_name',
            'selected_tab',
            'send_cgi_parameter',
            'app_id',
            'return_page',
            'multi_apply',
            'plid',
            'item_group_id',
            'org_id',
            'role_id',
            'require_role_tab',
            'is_calendar',
            'is_search_result',
            'show_group_role',
            'reflect_to_additional_name',
            'more_user_offset',
            'more_user_limit',
            'require_dynamic_roles',
            'require_administrator_role',
            'ajax_url',
            'selected_tid'
        ];


    /**
     * UserSelectParameters constructor.
     *
     * @param array $input
     */
    function __construct(array $input)
    {
        $this->input = $input;

        $this->form_name = cb_get_pagename();
        $this->plugin_session_name = cb_get_pagename();
        $this->item_session_name = cb_get_pagename();

        foreach ($this->param_names as $name) {
            if (array_key_exists($name, $input)) {
                // Use variable variables ¶
                if ($name === "searchword") {
                    $this->$name = $input[$name];
                } else {
                    $this->$name = htmlspecialchars($input[$name]);
                }
            }
        }

        if ( ! is_numeric($this->s_oid)) {
            $this->s_oid = '0';
        }

        $is_not_dynamic_role = $this->s_rid != MemberLogic::ROLE_ID_EVERYONE
                               && $this->s_rid
                                  != MemberLogic::ROLE_ID_LOGINUSER;
        if ($is_not_dynamic_role && ! is_numeric($this->s_rid)) {
            $this->s_rid = '0';
        }

        if ( ! is_numeric($this->no_multiple)) {
            $this->no_multiple = '0';
        }
        if ( ! is_numeric($this->send_cgi_parameter)) {
            $this->send_cgi_parameter = '0';
        }
        if ( ! is_numeric($this->include_org)) {
            $this->include_org = '0';
        }
        if ( ! is_numeric($this->system)) {
            $this->system = '0';
        }
        if ( ! is_numeric($this->system_display)) {
            $this->system_display = '0';
        }
        if ( ! is_numeric($this->item_group_id)) {
            $this->item_group_id = '0';
        }
        if ( ! is_numeric($this->multi_apply)) {
            $this->multi_apply = '0';
        }
        if ( ! is_numeric($this->plid)) {
            $this->plid = null;
        }
        if ( ! is_numeric($this->require_role_tab)) {
            $this->require_role_tab = '0';
        }
        if ( ! is_numeric($this->is_calendar)) {
            $this->is_calendar = '0';
        }
        if ( ! is_numeric($this->is_search_result)) {
            $this->is_search_result = '0';
        }

        if ( ! is_numeric($this->show_group_role)) {
            $this->show_group_role = '1';
        }

        if ( ! is_numeric($this->more_user_offset)) {
            $this->more_user_offset = '0';
        }

        if ( ! is_numeric($this->more_user_limit)) {
            $this->more_user_limit = '-1';
        }

        if ( ! is_numeric($this->require_dynamic_roles)) {
            $this->require_dynamic_roles = '0';
        }

        if ( ! is_numeric($this->require_administrator_role)) {
            $this->require_administrator_role = '0';
        }
    }

    /**
     * Judge Function.
     *
     * @return string
     */
    public function judgeFunction()
    {
        if ($this->select_func === 'init') {
            return GRN_USER_SELECT_PAGE_FUNC_INIT;
        } elseif ($this->select_func === 'browse') {
            return GRN_USER_SELECT_PAGE_FUNC_BROWSE;
        } elseif ($this->select_func === 'add') {
            return GRN_USER_SELECT_PAGE_FUNC_ADD;
        } elseif ($this->select_func === 'remove') {
            return GRN_USER_SELECT_PAGE_FUNC_REMOVE;
        } elseif ($this->select_func === 'apply') {
            return GRN_USER_SELECT_PAGE_FUNC_APPLY;
        } elseif ($this->select_func === 'multi_apply') {
            return GRN_USER_SELECT_PAGE_FUNC_MULTI_APPLY;
        } else {
            return GRN_USER_SELECT_PAGE_FUNC_INIT;
        }

    }

}
