<?php

namespace grn\grn;

class LogMessage implements LogMessageInterface
{
    private $message;
    private $format;

    /**
     * @param        $message
     * @param string $format : Format of a log entry.
     *                       The following items can be specified to the format: {timestamp}, {login_user} and {message}
     *                       By default, the format is "[timestamp}] {login_user} {message}"
     */
    function __construct($message, $format = null)
    {
        $this->message = $message;
        $this->format = $format ?? '[{timestamp}] {login_user} {message}';
    }

    function createFormattedLogMessage()
    {
        return $this->formatMessage($this->message, $this->format);
    }

    private function formatMessage($message, $format)
    {
        $login_user = cb_lwc_uum()->getLoginUser();
        $parts = [
            'timestamp'  => date('Y-m-d H:i:s'),
            'message'    => $message,
            'login_user' => $login_user
                ? "{$login_user->getOID()} {$login_user->get( 'display_name' )}"
                : 'not_login_user',
        ];
        $formatted_message = $format;
        foreach ($parts as $name => $value) {
            $formatted_message = str_replace('{' . $name . '}', $value,
                $formatted_message);
        }

        return $formatted_message . "\n";
    }
}
