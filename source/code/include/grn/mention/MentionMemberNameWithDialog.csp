<?php
declare(strict_types=1);

namespace grn\grn\mention;

use grn\grn\dialog\MemberNameWithDialog;
use grn\grn\MemberLogic;

class MentionMemberNameWithDialog extends MemberNameWithDialog
{
    /**
     * Render show user HTML
     *
     * @param array $user_info
     *
     * @return string
     */
    protected function renderUser(array $user_info)
    {
        $wrap_class = isset($user_info['status']) ? 'user_grn '
                                                    . $user_info['status']
            : 'user_grn';
        $target = cb_is_forest() ? ' target="_blank"' : '';
        $anchor = '@' . htmlspecialchars($user_info['name']);
        $item
            = "<li class='%s'><a class='js_label_a' href=\"%s\" %s><span class='js_label'>%s</span></a></li>";
        $url = $user_info['url'];
        $result = sprintf($item, $wrap_class, $url, $target, $anchor);

        return $result;
    }

    /**
     * Render show role
     *
     * @param string $role_id          Role ID
     * @param string $role_foreign_key Role foreign key
     *
     * @return string
     */
    protected function renderRole(
        string $role_id,
        string $role_foreign_key
    ): string {
        require_once $this->smarty->_get_plugin_filepath('function',
            'grn_member_dialog');
        $result = '';
        $anchor_id = $this->param_id . '_dialog_link_role_' . $role_id;
        $result .= smarty_function_grn_member_dialog([
            'dialog_link_tpl_name' => 'grn/mention/role_dialog_link.tpl',
            'link_name'            => $role_foreign_key,
            'anchor_id'            => $anchor_id,
            'want_page'            => 1,
            'dialog_name'          => $this->param_dialog_name
        ], $this->smarty);

        return $result;
    }

    /**
     * Render show Group
     *
     * @param string $group_id   Group ID
     * @param string $group_name Group name
     *
     * @return string
     */
    protected function renderGroup(string $group_id, string $group_name): string
    {
        require_once $this->smarty->_get_plugin_filepath('function',
            'grn_member_dialog');
        $anchor_id = $this->param_id . '_dialog_link_group_' . $group_id;
        $result = smarty_function_grn_member_dialog([
            'dialog_link_tpl_name' => 'grn/mention/group_dialog_link.tpl',
            'link_name'            => $group_name,
            'anchor_id'            => $anchor_id,
            'want_page'            => 1,
            'dialog_name'          => $this->param_dialog_name
        ], $this->smarty);

        return $result;
    }

    /**
     * Display deleted user
     *
     * @param int   $deleted_user_index deleted index
     * @param array $deleted_users_info Deleted user list
     *
     * @return string
     */
    protected function renderDeletedMember(
        $deleted_user_index,
        array $deleted_users_info
    ) {
        $result = '';

        if ( ! $this->param_is_display_deleted_user) {
            return $result;
        }

        if ( ! array_key_exists($deleted_user_index, $deleted_users_info)) {
            return $result;
        }
        $user_name
            = $deleted_users_info[$deleted_user_index][MemberLogic::DISPLAY_NAME];
        $anchor = '@' . htmlspecialchars($user_name);
        $item = "<li class='user_grn'><span>%s</span></li>";

        return sprintf($item, $anchor);
    }

    /**
     * Create more display link with ajax
     *
     * @return string
     */
    protected function createMoreDisplayScriptWithAjax()
    {
        $smarty = new \GRN_Smarty();

        return $smarty->fetch('grn/mention/ajax/member_list_show_more.tpl');
    }
}
