<?php

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

// エラーフックの登録
require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $filepath);
$uum =& $G_container_base->getInstance('uum');

//読み込み
require_once("fw/string_util.csp");
while (($line = $csv->readLine()) !== false) {
    if ($skip > 0) {
        $skip--;
        continue;
    }

    if (($len = count($line)) < 1) {
        cb_throw_error(E_GRN_CSV_INVALID_USER_ROLE_COLUMNS,
            ['page' => cb_msg('grn.system.user', 'user_role_import1')]);
    }

    //ユーザー取得
    if ( ! ($user =& $uum->getUserByForeignKey(cb_trim($line[0])))) {
        cb_throw_error(E_GRN_CSV_USER_FOR_ROLE_NOT_FOUND,
            ['page' => cb_msg('grn.system.user', 'user_role_import1')],
            ['user' => cb_trim($line[0])]);
    }

    //ロールID取得
    $ids = [];
    for ($i = 1; $i < $len; $i++) {

        $role_key = cb_trim($line[$i]);
        if (strlen($role_key) <= 0) {
            continue;
        }

        if ( ! ($role =& $uum->getStaticRoleByForeignKey($role_key))) {
            cb_throw_error(E_GRN_CSV_ROLE_FOR_USER_NOT_FOUND,
                ['page' => cb_msg('grn.system.user', 'user_role_import1')],
                ['role' => cb_trim($line[$i])]);
        }
        if ( ! in_array($role->getOID(), $ids)) {
            $ids[] = $role->getOID();
        }
    }

    //セット
    $uum->setUserRoles($user->getOID(), $ids);
    $user_key = $line[0];
    $uum->execInspection('user', 'import_role',
        ['uid' => $user->getOID(), 'rids' => implode(',', $ids)]);
}


