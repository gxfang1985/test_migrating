<?php
/**
 *  アクセス権の設定情報を保有するユーザー/ロールの一覧を取得
 *
 * @param  string  target      ユーザー一覧かロール一覧か
 * @param  string  org_id      組織ID
 * @param  array   navi_params CGIパラメータ
 * @param  object  & al        アクセス権設定ロジック
 *
 * @return array               ユーザー/ロール一覧
 */
function &grn_get_org_access_info($target, $org_id, $navi_params, & $al)
{
    //-- prepare uum and uum_util
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');

    $info = [];

    if ($target == 'role') {
        //(for target 'role')

        //--role list
        $role_rows = $uum->listStaticRoles();
        $info['role_list'] = [];
        foreach (array_keys($role_rows) as $id) {
            $role =& $role_rows[$id];
            $info['role_list'][$id] = [
                'rid'            => $id,
                'foreign_key'    => $role->get('foreign_key'),
                'security_model' => $al->getSecurityModel($role),

                // 以下は、パフォーマンスを考慮して、GRN_*_Access_Logic 側で実装すべき
                'access_count'   => count($al->getAccesses($role)),
            ];
        }
    } else {
        //(for target 'user(organization)')

        require_once('grn/org_util.csp');

        //--group information structure
        if (0 > $org_id) {
            $info = [];
            $info['oid'] = -1;
            $info['name'] = cb_msg('grn.system', 'nogroup_users');
            $info['foreign_key'] = null;
            $info['description'] = null;
            $info['ancestors'] = [];
            $info['children'] = [];
            $info['child_count'] = 0;
        } else {
            $org_row =& grn_get_org_row($org_id);
            $info =& grn_get_org_info($org_row, false, true);
            if ($org_row) {
                $info['security_model'] = $al->getSecurityModel($org_row);

                // 以下は、パフォーマンスを考慮して、GRN_*_Access_Logic 側で実装すべき
                $info['access_count'] = count($al->getAccesses($org_row));
            }

            //--ancestors group list
            $info['ancestors'] =& grn_get_org_ancestors($org_row);

            //--child groups
            $info['children'] =& grn_get_org_children($org_id, true);
            $info['child_count'] = count($info['children']);
        }

        if ($org_id) {
            //--N-navigation
            $info['navi_info'] = grn_get_user_list_info($org_id, $navi_params);

            //--user list
            $info['user_list'] = grn_get_user_list($org_id, $info['navi_info']);

            //--security model attribute
            foreach (array_keys($info['user_list']) as $id) {
                $info['user_list'][$id]['security_model']
                    = $al->getSecurityModel($info['user_list'][$id]['row']);

                // 以下は、パフォーマンスを考慮して、GRN_*_Access_Logic 側で実装すべき
                $info['user_list'][$id]['access_count']
                    = count($al->getAccesses($info['user_list'][$id]['row']));
            }
        }
    }

    return $info;
}

