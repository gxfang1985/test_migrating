<?php

namespace grn\grn\bean;

use grn\grn\ValidatableInterface;
use grn\grn\GrnException;
use grn\grn\Validate;

/**
 * BeanAbstractクラス
 * あるひとつのデータを表現するクラス
 *
 * Copy from grn\space\common\data\bean\BeanAbstract
 *
 * @package grn\grn\bean
 * @access  public
 **/
abstract class BeanAbstract implements ValidatableInterface
{
    const CHECK_INPUT = true;

    const NOT_CHECK_INPUT = false;

    /**
     * Using a constant array key. 配列のキーに使う定数
     */
    const ID = "_id";

    /**
     * シーケンスIDの値を保持する
     */
    private $_id;

    /**
     * @var boolean
     */
    private $_isInputCheck;

    /**
     * コンストラクタ
     * オブジェクト配列を引数で受け取った場合は、受け取った配列でオブジェクトを初期化する
     * 引数がnullの場合は各データクラスのデフォルト値で初期化する
     *
     * @access    public
     *
     * @param     array $dataArray initial data
     */
    public function __construct(
        array $dataArray = null,
        $isInputCheck = self::CHECK_INPUT
    ) {
        if (is_null($dataArray)) {
            $this->setId(null);
        } else {
            $this->setId($dataArray[self::ID] ?? null);
        }

        $this->setInputCheck($isInputCheck);
    }

    private function setInputCheck($isInputCheck)
    {
        $this->_isInputCheck = $isInputCheck;
    }

    private function isInputCheck()
    {
        return $this->_isInputCheck;
    }

    protected function isInputNumber($value)
    {
        if ($this->isInputCheck()) {
            return Validate::isNumber($value);
        }

        return true;
    }

    protected function isInputBoolean($value)
    {
        if ($this->isInputCheck()) {
            return Validate::isBoolean($value);
        }

        return true;
    }

    /**
     * 検査する（オーバーライド）
     * Validity check is override
     *
     * @access    public
     *
     * @param     int     $validType VALID_TYPE_CREATE, VALID_TYPE_MODIFY, VALID_TYPE_SELECT
     * @param     boolean $isThrow   EXCEPTION_THROW:exception throw   EXCEPTION_NOT_THROW:exception not throw
     *
     * @throws    GrnException
     * @return    boolean       TRUE : $value is internal application   if isThrow = EXCEPTION_NOT_THROW then FALSE: external applicaton
     */
    public function isValidData($validType, $isThrow = self::EXCEPTION_THROW)
    {
        Validate::isInTheRange($validType, self::VALID_TYPE_SELECT,
            self::VALID_TYPE_MODIFY);

        if ($this->checkValidate($validType)) {
            return true;
        }

        if ($isThrow) {
            throw new GrnException();
        } else {
            return false;
        }
    }

    /**
     * 検査の実行
     * Performing Validation
     *
     * @access    public
     *
     * @param     int $validType VALID_TYPE_CREATE, VALID_TYPE_MODIFY, VALID_TYPE_SELECT
     *
     * @return    boolean       TRUE : valid   FALSE: Invalid
     */
    protected function checkValidate($validType)
    {
        if ($validType == BeanAbstract::VALID_TYPE_MODIFY) {
            if (is_null($this->getId())) {
                return false;
            }
        }

        return true;
    }

    /**
     * オプジェクトデータを配列に変換する
     * 配列のキーはconst定数を使用
     *
     * @access    public
     * @return    array         key:constant value:string or boolean or number
     */
    public function convertArray()
    {
        $result = [];
        $result[self::ID] = $this->getId();

        return $result;
    }

    /**
     * オブジェクトシーケンスIDを取得
     *
     * @access    public
     * @return    string        sequence id
     */
    public function getId()
    {
        return $this->_id;
    }

    /**
     * オブジェクトシーケンスIDを設定
     *
     * @access    public
     *
     * @param     string $value sequence id
     *
     * @throws    GrnInvalidArgumentException    It is not number.
     */
    public function setId($value)
    {
        $this->isInputNumber($value);

        $this->_id = $value;
    }

    /**
     * check whether bean is equal.
     *
     * @param   object  BeanAbsract     $bean
     *
     * @return  boolean
     * @throws  GrnException      bean is differnt class
     */
    public function equalRecord(BeanAbstract $bean)
    {
        if ( ! ($bean instanceof static)) {
            $e = new GrnException();
            throw $e;
        }

        return ($this->getId() === $bean->getId()) ? true : false;
    }
}
