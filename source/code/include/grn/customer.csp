<?php

/**
 * Customer Information
 *
 * @package grn.common
 */

require_once('fw/module.csp');
require_once('grn/file.csp');

define('GRN_CUSTOMER_ID', 1);

class GRN_CustomerInfo extends CB_PersistentBase
{
    // お客様番号
    var $col_customer_id = ['type' => 'char'];
    // 法人名
    var $col_company_name = ['type' => 'char'];
    // 法人名よみ
    var $col_company_name2 = ['type' => 'char'];
    // ロゴ（パス）
    var $col_logo_path = ['type' => 'char', 'length' => 255];
    // ロゴ（ファイル）
    var $col_logo_file = ['type' => 'weak_relation', 'to' => 'GRN_File'];

    // reserved columns
    var $col_reserve_text1 = ['type' => 'char', 'lazy' => true];
    var $col_reserve_text2 = ['type' => 'char', 'lazy' => true];
    var $col_reserve_text3 = ['type' => 'char', 'lazy' => true];
    var $col_reserve_int1 = ['type' => 'int', 'lazy' => true];
    var $col_reserve_int2 = ['type' => 'int', 'lazy' => true];
    var $col_reserve_int3 = ['type' => 'int', 'lazy' => true];
    var $col_reserve_blob1 = ['type' => 'blob', 'lazy' => true];
    var $col_reserve_blob2 = ['type' => 'blob', 'lazy' => true];
    var $col_reserve_blob3 = ['type' => 'blob', 'lazy' => true];

    function __construct(&$row)
    {
        parent::__construct($row);
    }
}

/**
 * @package grn.common
 */
class GRN_Customer
{
    /**
     * @access private
     */
    var $_table = null;

    /**
     * @return GRN_Customer
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Customer();
        }

        return $_instance;
    }

    /**
     * @access private
     */
    function __construct()
    {
        $this->_table = cb_class2table('GRN_CustomerInfo');
    }

    /**
     * お客様属性を取得する。
     *
     * @param string $key キー
     *
     * @return mixed    属性
     */
    function getProperty($key)
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);
        if (false === $row) {
            return false;
        }

        $ret = $row->get($key);

        return $ret;
    }

    /**
     * お客様属性を設定する。
     *
     * @param array $properties お客様属性
     */
    function setProperties($properties)
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);
        if (false === $row) {
            assert(false);
        }

        foreach (array_keys($properties) as $key) {
            $row->set($key, $properties[$key]);
        }

        $row->updateNow();
    }

    /**
     * ロゴファイルを設定する
     *
     * @param array $logo ファイル情報
     */
    function setLogoFile($logo)
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);

        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();

        require_once('grn/file.csp');
        $fmgr = GRN_FileManager::getInstance();
        $file =& $fmgr->createFile($login, $logo, 'customer logo add.');

        $oldfile = $row->get('logo_file');
        if ($oldfile) {
            $oldfile->delete();
        }
        $row->set('logo_file', $file);
        $row->updateNow();
    }

    /**
     * ロゴファイルを取得する
     *
     * @return mixed
     */
    function &getLogoFile()
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);
        $ret =& $row->get('logo_file');

        return $ret;
    }

    /**
     * ロゴを削除する
     *
     * @return bool
     */
    function removeLogoFile()
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);
        $logo = $row->get('logo_file');

        return $logo->delete();
    }

    /**
     * お客様番号を設定する
     *
     * @param string $customer_id お客様番号
     */
    function setCustomerId($customer_id)
    {
        $row = $this->_table->getRow(GRN_CUSTOMER_ID);
        if (false === $row) {
            assert(false);
        }

        $id = sprintf('%06d', $customer_id);
        $row->set('customer_id', $id);
        $row->updateNow();
    }
}


