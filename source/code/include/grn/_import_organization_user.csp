<?php
require_once('grn/org_privilege.csp');
$logic = GRN_OrganizationPrivilegeLogic::getInstance();
$is_admin = $logic->isAdmin();

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

//require_once( 'fw/session_manager.csp' );
//$sm = CB_SessionManager::getInstance();
//$session =& $sm->getSession( 'system/user/organization_user_import1' );

// エラーフックの登録
require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $filepath);
$uum =& $G_container_base->getInstance('uum');

//読み込み
require_once("fw/string_util.csp");
while (($line = $csv->readLine()) !== false) {
    if ($skip > 0) {
        $skip--;
        continue;
    }

    if (($len = count($line)) < 1) {
        cb_throw_error(E_GRN_CSV_INVALID_USER_GROUP_COLUMNS,
            ['page' => cb_msg('grn.system.user', 'organization_user_import1')]);
    }

    //組織取得
    if ( ! ($group =& $uum->getGroupByForeignKey(cb_trim($line[0])))) {
        cb_throw_error(E_GRN_CSV_GROUP_FOR_USER_NOT_FOUND,
            ['page' => cb_msg('grn.system.user', 'organization_user_import1')],
            ['group' => cb_trim($line[0])]);
    }
    $logged_in_user = $uum->getLoginUser();
    if ( ! $logic->isPrivileged($logged_in_user, $group)) {
        cb_throw_error(E_GRN_CSV_NO_GROUP_PRIVILEGE,
            null,
            ['foreign_key' => cb_trim($line[0])]);
    }

    //ユーザーID取得
    $ids = [];
    for ($i = 1; $i < $len; $i++) {

        $user_key = cb_trim($line[$i]);
        if (strlen($user_key) <= 0) {
            continue;
        }

        if ( ! ($user =& $uum->getUserByForeignKey($user_key))) {
            cb_throw_error(E_GRN_CSV_USER_FOR_GROUP_NOT_FOUND,
                [
                    'page' => cb_msg('grn.system.user',
                        'organization_user_import1')
                ],
                ['user' => cb_trim($line[$i])]);
        }
        if ( ! in_array($user->getOID(), $ids)) {
            $ids[] = $user->getOID();
        }
    }

    //セット
    $uum->setGroupUsers($group->getOID(), $ids);

    $uum->execInspection('group', 'import_user',
        ['gid' => $group->getOID(), 'uids' => implode(',', $ids)]);
}


