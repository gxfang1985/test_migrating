<?php

abstract class GrnAbstractQuery
{
    /**
     *
     * @return string
     */
    abstract public function getQuery();

    private $databaseConnection;

    public function setDatabaseConnection($datbaseConnection)
    {
        $this->databaseConnection = $datbaseConnection;
    }

    /**
     *
     * @return CB_DatabaseConnection
     */
    public function getDatabaseConnection()
    {
        return $this->databaseConnection;
    }

    /**
     *
     * @param array $format
     *
     * @return string
     */
    protected function queryf($format, $args)
    {
        return cb_vqueryf($this->getDatabaseConnection(), $format, $args);
    }

    /**
     *
     * @param string $tableName
     */
    protected function getUserTableName($tableName)
    {
        return grn_get_personal_tablename_message($this->getUserId(),
            $tableName);
    }

    public function execute()
    {
        $db = $this->getDatabaseConnection();
        $query = $this->getQuery();
        $result = $db->query($query);
        if ($result === false) {
            $db->throwError(['query' => 'failed query on SELECT: ' . $query]);
        }

        $return = [];
        while (($row = $db->fetch_assoc($result)) !== false) {
            $return[] = $row;
        }
        $db->free_result($result);

        return $return;
    }
}
