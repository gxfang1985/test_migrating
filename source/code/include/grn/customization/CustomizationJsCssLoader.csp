<?php

namespace grn\grn\customization;

class CustomizationJsCssLoader
{
    /**
     * @var array
     */
    private $customization
        = [
            "system_js"             => [],
            "application_js"        => [],
            "application_init_data" => [],
            "user_js"               => [],
            "user_css"              => [],
            "event_info"            => []
        ];

    /**
     * @var int
     */
    private $countEventData = 0;

    /**
     * @var $this
     */
    private static $instance = null;

    /**
     * @var bool
     */
    private static $is_licensed = null;

    /**
     * @return CustomizationJsCssLoader
     */
    public static function getInstance()
    {
        if ( ! isset(self::$instance)) {
            $c = __CLASS__;
            self::$instance = new $c;
        }

        return self::$instance;
    }

    /**
     */
    private function __construct()
    {
    }

    /**
     * @return bool
     */
    public function isLoadableEvents(): bool
    {
        return $this->countEventData > 0;
    }

    /**
     * @return array
     */
    public function getSystemJS(): array
    {
        return [];
    }

    /**
     * @return array
     */
    public function getApplicationJS(): array
    {
        $application_js = [];
        foreach ($this->customization["application_js"] as $each_application_js) {
            $application_js = array_merge($application_js,
                $each_application_js);
        }

        return $application_js;
    }

    /**
     * @return array
     */
    public function getApplicationInitData(): array
    {
        $application_init_data = [];
        foreach (
            $this->customization["application_init_data"] as $module_id =>
            $each_event
        ) {
            $application_init_data[$module_id] = $each_event;
        }

        return $application_init_data;
    }

    /**
     * @return array
     */
    public function getUserJS(): array
    {
        $user_js = [];
        foreach ($this->customization["user_js"] as $each_user_js) {
            $user_js = array_merge($user_js, $each_user_js);
        }

        return $user_js;
    }

    /**
     * @return array
     */
    public function getUserCSS(): array
    {
        $user_css = [];
        foreach ($this->customization["user_css"] as $each_user_css) {
            $user_css = array_merge($user_css, $each_user_css);
        }

        return $user_css;
    }

    /**
     * @return array
     */
    public function getEventInfo(): array
    {
        $event_info = [];
        foreach ($this->customization["event_info"] as $each_event) {
            foreach ($each_event as $event_name => $each_event_data) {
                $event_info[$event_name] = $each_event_data;
            }
        }

        return $event_info;
    }

    /**
     * @return bool
     */
    public function isAvailableLicense(): bool
    {
        if (cb_is_forest()) {
            return true;
        }
        if (is_null(self::$is_licensed)) {
            $lm = \GRN_LicenseManager::getInstance();
            self::$is_licensed
                = $lm->hasEffectiveLicense(GRN_LICENSE_SERVICE_EXPIRED_OFFSET);
        }

        return self::$is_licensed;

    }

    /**
     * @param \grn\grn\customization\JsApiLoaderInterface $js_api_loader
     * @param \grn\grn\customization\JsApiEventInterface  $js_api_event
     */
    public function addEvent(
        JsApiLoaderInterface $js_api_loader,
        JsApiEventInterface $js_api_event
    ) {
        $is_not_available_license = ! $this->isAvailableLicense();
        $is_not_customization_available
            = ! $js_api_loader->isCustomizationAvailable();

        if ($is_not_available_license || $is_not_customization_available) {
            return;
        }

        $module_id = $js_api_loader->getModuleID();
        $event_name = $js_api_event->getEventName();

        if ( ! isset($this->customization["application_js"][$module_id])) {
            $this->customization["application_js"][$module_id]
                = $js_api_loader->getApplicationJS();
        }

        if ( ! isset($this->customization["application_init_data"][$module_id][$event_name])) {
            $this->customization["application_init_data"][$module_id][$event_name]
                = $js_api_event->getInitData();
        }

        if ( ! isset($this->customization["user_js"][$module_id])) {
            $this->customization["user_js"][$module_id]
                = $js_api_loader->getUserJS();
        }

        if ( ! isset($this->customization["user_css"][$module_id])) {
            $this->customization["user_css"][$module_id]
                = $js_api_loader->getUserCSS();
        }

        if ( ! isset($this->customization["event_info"][$module_id][$event_name])) {
            $this->customization["event_info"][$module_id][$event_name]
                = $js_api_event->getEventData();
            $this->countEventData++;
        }
    }

}
