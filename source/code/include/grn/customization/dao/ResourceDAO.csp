<?php

namespace grn\grn\customization\dao;

use grn\grn\customization\bean\Resource;

class ResourceDAO
{
    protected $dbConn;
    protected $module;

    /**
     * ResourceDAO constructor.
     *
     * @param string $module
     */
    function __construct($module)
    {
        $this->dbConn = cb_get_app_db($module);
        $this->module = $module;
    }

    /**
     * @return string
     */
    function getCustomizationResourceTableName()
    {
        return 'tab_grn_' . $this->module . '_customization_resource';
    }

    /**
     * @param $resources \grn\grn\customization\bean\Resource[]
     *
     * @return int
     */
    public function insert($resources)
    {
        $query
            = "INSERT INTO {$this->getCustomizationResourceTableName()}(col_target, col_url, col_file, col_type) VALUES ";

        $affected_row = 0;
        $query_value = [];
        foreach ($resources as $resource) {
            $query_value[] = cb_queryf($this->dbConn, "('@S', '@S', @S, '@S')",
                $resource->getTarget(),
                $resource->getURL(),
                $resource->getFile() ?: 'default',
                $resource->getType());
        }

        if (count($query_value) > 0) {
            $query .= implode(',', $query_value);
            $this->dbConn->query($query);
            $affected_row = $this->dbConn->affected_rows();
        }

        return $affected_row;
    }

    /**
     * @param string[] $targets
     *
     * @return int
     */
    public function deleteByTargets($targets)
    {
        $query
            = "DELETE FROM {$this->getCustomizationResourceTableName()} WHERE ";
        $query .= cb_queryf($this->dbConn, "col_target IN (@A);", $targets);
        $this->dbConn->query($query);

        return $this->dbConn->affected_rows();
    }

    /**
     * @param string[] $targets
     *
     * @return \grn\grn\customization\bean\Resource[]
     */
    public function getByTargets($targets)
    {
        $query
            = "SELECT * FROM {$this->getCustomizationResourceTableName()} WHERE ";
        $query .= cb_queryf($this->dbConn, "col_target IN (@A)", $targets);
        $query .= " ORDER BY _id;";

        $resources = [];
        $result = $this->dbConn->query($query);
        while ($row = $this->dbConn->fetch_assoc($result)) {
            $resource = new Resource($row);
            $resources[$resource->getId()] = $resource;
        }
        $this->dbConn->free_result($result);

        return $resources;
    }

    /**
     * @param string $file_id
     *
     * @return string
     */
    public function getTargetByFileID($file_id)
    {
        $query = cb_queryf($this->dbConn,
            "SELECT col_target FROM {$this->getCustomizationResourceTableName()} WHERE col_file = '@S'",
            $file_id);
        $result = $this->dbConn->query($query);
        $row = $this->dbConn->fetch_assoc($result);
        if ( ! $row) {
            cb_throw_error(E_GRN_USERS_FILE_NOT_FOUND);
        }

        return $row['col_target'];
    }
}
