<?php

namespace grn\grn\customization\screen;

use grn\grn\customization\common\CustomizationSetting;
use grn\grn\customization\logic\ProxyConnection;
use grn\grn\customization\logic\ProxySettingLogic;
use grn\grn\GrnGenericScreenBase;
use grn\grn\JSONResponse;
use grn\grn\ErrorCode;

class ProxyApi extends GrnGenericScreenBase
{
    public function post($input)
    {
        if (CustomizationSetting::isForceDisabled()) {
            cb_throw_error(ErrorCode::CUSTOMIZATION_FORCE_DISABLED);
        }

        $code = $input['code'] ?? '';
        $url = $input['url'] ?? '';
        $method = $input['method'] ?? '';
        $headers = $input['headers'] ?? [];
        $data = $input['data'] ?? [];

        $setting_logic = new ProxySettingLogic();
        $setting = $setting_logic->getByCode($code);

        if ( ! $setting) {
            cb_throw_error(ErrorCode::PROXY_API_CANNOT_SEND_INVALID_PARAMS);
        }

        $connection = new ProxyConnection($setting);

        $response_data = $connection->send($url, $method, $headers, $data);

        $json = JSONResponse::create();
        $json->response($response_data);
    }
}
