<?php

namespace grn\grn\customization\screen;

use grn\grn\GrnGenericScreenBase;

abstract class FileDownload extends GrnGenericScreenBase
{
    /**
     */
    public final function fetch()
    {
        $input = $this->getInput();
        $file_id = cb_at($input, 'fid');
        if ( ! $file_id) {
            cb_throw_error(E_GRN_USERS_FILE_NOT_FOUND);
        }

        $this->checkAccessRightOfFile($file_id);

        $this->download($file_id);
    }

    /**
     * @param string $file_id
     */
    private function download($file_id)
    {
        require_once('grn/customization/file.csp');
        $fm = \GRN_Customization_FileManager::getInstance($this->getAppId());
        if ( ! ($file =& $fm->getFile($file_id))) {
            cb_throw_error(E_GRN_USERS_FILE_NOT_FOUND);
        }

        header("Cache-Control: max-age=315360000");
        header("Expires: " . gmdate('D, d M Y H:i:s', time() + 315360000)
               . " GMT");

        $file->download(true);

        cb_safe_exit();
    }

    /**
     * @return string
     */
    protected abstract function getAppId();

    /**
     * @param string $file_id
     */
    protected abstract function checkAccessRightOfFile($file_id);
}
