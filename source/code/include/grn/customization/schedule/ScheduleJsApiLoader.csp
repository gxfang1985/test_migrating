<?php

namespace grn\grn\customization\schedule;

use grn\grn\customization\JsApiLoaderInterface;
use grn\grn\customization\logic\ResourceLogic;
use grn\grn\customization\logic\CustomizationGroupLogic;

require_once("grn/customization/file.csp");
require_once("grn/ticket.csp");

class ScheduleJsApiLoader implements JsApiLoaderInterface
{
    const MODULE_ID = "schedule";

    /**
     * @var array
     */
    private $customizationTargets = [];

    /**
     * @var array
     */
    private $resourceScriptFile = ["js" => [], "css" => []];

    /**
     * @var $this
     */
    private static $instance = null;

    /**
     * Get Instance(Singleton pattern)
     *
     * @return ScheduleJsApiLoader
     */
    public static function getInstance()
    {
        if ( ! isset(self::$instance)) {
            $c = __CLASS__;
            self::$instance = new $c;
        }

        return self::$instance;
    }

    /**
     * Constructor
     */
    private function __construct()
    {
        $this->setCustomizationTargets();
        $this->setResourceScriptFile();
    }

    /**
     * @return string
     */
    public function getModuleID(): string
    {
        return self::MODULE_ID;
    }

    /**
     * @return bool
     */
    public function isCustomizationAvailable(): bool
    {
        return count($this->customizationTargets) > 0;
    }

    /**
     * @return array
     */
    public function getApplicationJS(): array
    {
        return [
            "js/dist/js_api_schedule.js"
        ];
    }

    /**
     * @return array
     */
    public function getUserJS(): array
    {
        return $this->resourceScriptFile["js"];
    }

    /**
     * @return array
     */
    public function getUserCSS(): array
    {
        return $this->resourceScriptFile["css"];
    }

    /**
     *
     */
    private function setResourceScriptFile()
    {
        if (count($this->customizationTargets) === 0) {
            return;
        }

        $module_id = $this->getModuleID();
        $resource_logic = new ResourceLogic($module_id);
        $resources
            = $resource_logic->getByTargets($this->customizationTargets);

        $fm = \GRN_Customization_FileManager::getInstance($module_id);
        $download_page = $module_id . "/customization/file_download";

        $file_ids = [];
        foreach ($resources as $resource) {
            $file_id = $resource->getFile();
            if ($file_id) {
                $file_ids[] = $file_id;
            }
        }
        $files = $fm->getFiles($file_ids);

        $login_user_id = cb_get_login_user()->getOID();
        $is_need_download_ticket = cb_is_need_download_ticket();
        foreach ($resources as $resource) {
            $url = $resource->getURL();
            $file_id = $resource->getFile();
            if ($file_id) {
                $file = $files[$file_id];
                $file_name = $file->get('name');
                $file_hash = $file->get('hash');
                $file_params = [
                    'fid'  => $file_id,
                    'hash' => $file_hash
                ];
                if ($is_need_download_ticket) {
                    $ticket = \GRN_Ticket::create($login_user_id);
                    $file_params['ticket'] = $ticket;
                }
                $url = cb_pageurl($download_page, $file_params, null,
                    $file_name);
            }

            if ($resource->getType() == 'js') {
                $this->resourceScriptFile['js'][] = $url;
            } elseif ($resource->getType() == 'css') {
                $this->resourceScriptFile['css'][] = $url;
            }
        }
    }

    /**
     *
     */
    private function setCustomizationTargets()
    {
        /* @var \CB_User $login_user */
        $login_user = cb_get_login_user();

        $customization_group_logic
            = new CustomizationGroupLogic($this->getModuleID());
        foreach (
            $customization_group_logic->getAvailableGroupList() as
            $customization_group
        ) {
            $group_id = $customization_group->getId();
            if ($customization_group_logic->isTargetByUserId($login_user->getOID(),
                $group_id)
            ) {
                $this->customizationTargets[$group_id]
                    = CustomizationGroupLogic::CUSTOMIZATION_TARGET_PREFIX
                      . $group_id;
            }
        }
    }
}
