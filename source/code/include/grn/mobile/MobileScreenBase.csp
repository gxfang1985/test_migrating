<?php

namespace grn\grn\mobile;

use grn\grn\access\service\AppAccess;
use grn\grn\GrnGenericScreenBase;

class MobileScreenBase extends GrnGenericScreenBase
{
    public function __construct($input)
    {
        parent::__construct($input);
        $this->initMobileView();
        $this->setMobileFooterBar([], true, false, true);
    }

    public function fetch()
    {
        $this->navigate();
        // 表示できるアプリはない場合
        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();
        $t->display(cb_get_pagename() . '.tpl');
    }

    public function getTitle()
    {
    }

    public function checkLogin()
    {
        // ログインユーザー取得
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();

        if ( ! $login) {
            // ログインしていない場合

            cb_require_role('LoginUser');


            // ログインした後
            cb_redirect('mobile/index');
        }
    }

    private function navigate()
    {
        // ログインしている場合
        require_once('grn/application.csp');
        $locator = \GRN_ApplicationLocator::instance();
        $apps = [
            'schedule'     => ['page' => 'schedule/mobile/index'],
            'notification' => ['page' => 'notification/mobile/index'],
            'mail'         => ['page' => 'mail/mobile/index'],
            'space'        => ['page' => 'space/mobile/index'],
            'message'      => ['page' => 'message/mobile/index'],
        ];
        $logged_in_id = cb_get_login_user()->getOID();
        $available_apps_internal
            = AppAccess::getAvailableAppIdsInternalByUserId($logged_in_id);
        $available_apps
            = array_keys(array_filter(AppAccess::getAvailabilityExternalAppIdsByUserId(cb_get_login_user()->getOID(),
            $available_apps_internal)));
        foreach ($apps as $key => $value) {
            if (in_array($key, $available_apps)) {
                cb_redirect($value['page']);
            }
        }
    }
}
