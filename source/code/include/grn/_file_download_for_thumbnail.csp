<?php

use grn\grn\ThumbnailUtil;

if (isset($body) && $body instanceof GRN_ServerFile) {
    global $G_INPUT;

    $thumbnail = array_key_exists('thumbnail', $G_INPUT) ? $G_INPUT['thumbnail']
        : null;
    if ($thumbnail == 1 && $body->exists()) {
        $image_data = $body->getContents();
        $imageInfo = @getimagesizefromstring($image_data);
        if (is_array($imageInfo) && isset($imageInfo['mime'])) {
            cb_prepare_download($body->get('name'), $imageInfo['mime'], true,
                true);
        }
        if (ThumbnailUtil::isEnableInlineThumbnail()) {
            $util = new ThumbnailUtil();
            $util->setAspectRatio(ThumbnailUtil::ASPECT_RATIO_FIX);
            $result = $util->makeThumbnailByImageData($image_data, 450, 450);
            if ($result === false) {
                $body->download(true);
            }
            cb_safe_exit();
        }
    }
}
