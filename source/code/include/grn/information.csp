<?php

require_once('fw/module.csp');

/**
 * おしらせ管理クラス
 *
 * @package grn.common
 */
class GRN_SystemInformation extends CB_ModuleBase
{
    /**
     * @access private
     */
    var $_ids = null;

    /**
     * @access private
     */
    var $_id_map = null;

    /**
     * @access private
     */
    function _constructIdMap()
    {
        $this->_ids = [];
        $this->_id_map = [];

        $path = cb_basedir() . '/code/plugin/grn/common/information';
        $dir = @opendir($path);
        if ($dir === false) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_SYSTEM_NO_LOGIC_DIR, null,
                ['dir' => $path]);
        }
        while (($file = readdir($dir)) !== false) {
            if (preg_match('#^([0-9][0-9])(.*)\\.csp$#', $file, $regs)) {
                $this->_id_map[$regs[2]] = $regs[1] . $regs[2];
                $this->_ids[$regs[1] . $regs[2]] = $regs[2];
            }
        }
        closedir($dir);
        ksort($this->_ids);
    }

    /**
     * @access private
     */
    function __construct()
    {
        parent::__construct('grn.common.information');
    }

    /**
     * シングルトンインスタンスを取得する
     *
     * @return GRN_SystemInformation
     */
    public static function getInstance()
    {
        $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_SystemInformation();
        }

        return $_instance;
    }

    /**
     * ロジックIDのリストを取得する
     *
     * @return array    ロジックID
     */
    function getLogicIds()
    {
        if (is_null($this->_ids)) {
            $this->_constructIdMap();
        }

        return $this->_ids;
    }

    /**
     * ロジックを取得する
     *
     * @param string $id ロジックID
     *
     * @return GRN_SystemInformationLogicBase|bool
     */
    function &getLogic($id)
    {
        if (is_null($this->_id_map)) {
            $this->_constructIdMap();
        }
        if ( ! array_key_exists($id, $this->_id_map)) {
            $___ret = false;

            return $___ret;
        }

        $real_id = $this->_id_map[$id];
        $loader = $this->getPluginLoader();
        $logic = $loader->loadDriver($real_id);
        assert('(!is_object($logic)) || is_a($logic, "GRN_SystemInformationLogicBase")');

        return $logic;
    }
}

/**
 * おしらせプラグインのベースクラス
 *
 * @abstract
 * @package grn.common
 */
class GRN_SystemInformationLogicBase extends CB_ModuleBase
{
    /**
     * @access private
     */
    var $_id;

    function __construct($id)
    {
        parent::__construct('grn.common.information.' . $id);
        $this->_id = $id;
    }

    /**
     * IDを取得する
     *
     * return string ID
     */
    function getId()
    {
        return $this->_id;
    }

    /**
     * 名前を取得する
     *
     * @return string おしらせ名
     */
    function getName()
    {
        return $this->getMessage('name');
    }

    /**
     * おしらせ情報を返す
     *
     * @return string おしらせ
     */
    function getContents()
    {
        return '';
    }
}


