<?php

namespace grn\grn;

class JavaScriptExportResource
{
    const MESSAGE_KEY = 'message';
    const TPLRC_KEY = 'tplrc';
    private static $OUTPUT_RESOURCES
        = [
            self::MESSAGE_KEY => [],
            self::TPLRC_KEY   => []
        ];

    private static $RESOURCE_NAME = "GRN_RESOURCES";

    /***
     * The function load all *.csp file of jsrc folder
     */
    private static function loadResources()
    {
        $jsrcPath = cb_basedir() . '/locale/jsrc/';
        if (file_exists($jsrcPath)) {
            $listFile = array_diff(scandir($jsrcPath), ['..', '.']);
            foreach ($listFile as $file) {
                $resourceFile = include($jsrcPath . $file);
                if (array_key_exists(self::MESSAGE_KEY, $resourceFile)) {
                    self::$OUTPUT_RESOURCES[self::MESSAGE_KEY]
                        = array_merge(self::$OUTPUT_RESOURCES[self::MESSAGE_KEY],
                        $resourceFile[self::MESSAGE_KEY]);
                }
                if (array_key_exists(self::TPLRC_KEY, $resourceFile)) {
                    self::$OUTPUT_RESOURCES[self::TPLRC_KEY]
                        = array_merge(self::$OUTPUT_RESOURCES[self::TPLRC_KEY],
                        $resourceFile[self::TPLRC_KEY]);
                }
            }
        }
    }

    /**
     * @param null $locale
     *
     * @return string
     */
    public static function output($locale = null)
    {
        self::loadResources();
        $outputResources = [];
        foreach (self::$OUTPUT_RESOURCES as $folder => $resourceList) {

            foreach ($resourceList as $moduleId => $resourceKeyList) {

                if ( ! array_key_exists($moduleId, $outputResources)) {
                    $outputResources[$moduleId] = [];
                }
                foreach ($resourceKeyList as $resourceKey) {

                    if ($folder == self::MESSAGE_KEY) {
                        $message = cb_msg($moduleId, $resourceKey, null,
                            $locale);
                    } else {
                        $message = cb_msg_tplrc($moduleId, $resourceKey);
                    }
                    $outputResources[$moduleId][$resourceKey] = $message;
                }
            }
        }

        return 'grn.component.i18n.' . self::$RESOURCE_NAME . ' = '
               . json_encode($outputResources, JSON_UNESCAPED_UNICODE);
    }
}
