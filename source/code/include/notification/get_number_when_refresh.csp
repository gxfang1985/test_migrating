<?php

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

if ($login && is_a($login, 'CB_User')) {
    require_once("notification/application.csp");
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Notification_App $notification_app */
    $notification_app = $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);

    if ( ! $notification_app) {
        return;
    }

    $notification_app->updateApplications($login, true);

    $notification_app_list = $notification_app->getApplicationList(false);
    $number_of_each_app_notification = [];
    foreach ($notification_app_list as $key => $item) {
        $number_of_each_app_notification[$key]
            = $notification_app->getWhatsNewDataCount($login, 'grn.' . $key);
    }

    $number_of_all = $notification_app->getDataCountComheader($login);
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('notification');
    $session->set("notification_number", $number_of_all);
    $session->set("each_notification_number", $number_of_each_app_notification);
}
