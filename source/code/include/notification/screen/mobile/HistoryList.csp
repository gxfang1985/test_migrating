<?php

namespace grn\notification\screen\mobile;

require_once('fw/basic_date.csp');
require_once('mail/utility.csp');

class HistoryList extends MobileNotificationScreenBase
{
    private function init()
    {
        // 表示するデータ種別
        $this->setDataType('history');

        // 通知アプリ取得
        $this->setNotificationApp();

        // 通知更新処理対応アプリケーションの更新処理呼び出し
        $logged_in_user = cb_get_login_user();
        $this->getNotificationApp()->updateApplications($logged_in_user, true);

        // 通知対応アプリ列挙
        $this->setAppsList();
    }

    private function assignArguments($smarty)
    {
        $this->assignBreadcrumbCurrentPage($smarty,
            grn_get_page_display_name('notification/index'));

        $smarty->assign('apps_list', $this->getAppInfos());
        $smarty->assign('data_list', $this->getDataList());
        $smarty->assign('users_info', $this->getUsersInfo());
        $smarty->assign('uid', $this->getLoginUserId());
        $smarty->assign('is_history_list', true);
        $smarty->assign('selected_app_info', $this->getSelectedAppInfos());
    }

    public function ajaxFetch()
    {
        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();

        $this->checkArgFromInput([
            self::ARG_MODULE_ID,
            self::ARG_START_POSITION,
            self::ARG_IS_SHOW_SINGLE,
            self::ARG_LAST_DATA_ID
        ], $this->getInput());

        $this->init();

        // 通知データリストの取得
        if ( ! is_null($this->getLastDataId())) {
            $last_time = null;
            if ($this->getStartPosition()) {
                $last_time = new \CB_TimeStamp();
                $last_time->unix_ts = $this->getStartPosition() + 1;
            }

            global $G_container_base;
            $db = $G_container_base->getInstance('dbconn');

            $add_condition = cb_queryf($db, "n.col_timestamp = '@S'",
                $this->getStartPosition());
            $logged_in_user = cb_get_login_user();
            $data_list = $this->getNotificationApp()->getDataListFast(
                $this->getDataType(), $logged_in_user, $this->getModuleId(),
                'time', true, 0, -1, null, $last_time, $add_condition, false
            );

            $had_show_ids = [];
            foreach (array_keys($data_list) as $key) {
                if ($key >= $this->getLastDataId()) {
                    $had_show_ids[] = $key;
                }
            }
            $add_condition = cb_queryf($db, "n._id NOT IN (@A)", $had_show_ids);

            if (count($data_list) > 0) {
                $this->setNotificationDataListForView($this->getModuleId(),
                    $last_time, $add_condition);
            } else {
                $this->setNotificationDataListForView($this->getModuleId(),
                    $last_time);
            }
        }
        $this->setUsersInfo($this->getDataList());

        $this->assignArguments($t);

        return $t->fetch('notification/mobile/ajax/more_notification_list.tpl');
    }
}
