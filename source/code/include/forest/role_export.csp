<?php

require_once('fw/csv.csp');

class GRN_ForestRoleExport
{
    const CHARSET = 'UTF-8';
    const ADMINISTRATORS_CODE = 'Administrators';
    const ADMINISTRATORS_SLASH_ID = 7532782697181632512;

    public function __construct()
    {
        global $G_container_base;
        $this->uum = $G_container_base->getInstance('uum');
    }

    public function main()
    {
        if ( ! defined('ON_FOREST')) {
            exit("Error: not forest mode");
        }

        $this->updateAdministratorsSlashId();
        $this->export();
    }

    private function updateAdministratorsSlashId()
    {
        $admin = $this->uum->getStaticRole(GRN_UUM_ADMINISTRATION_ROLE);
        $admin->_setPrivately('slash', self::ADMINISTRATORS_SLASH_ID);
    }

    private function export()
    {
        $writer = new CB_CSVWriter(self::CHARSET, null);

        $allRoles = $this->uum->getStaticRoles(0, -1, '_id');
        foreach ($allRoles as $role) {
            $line = $this->getLine($role);
            $writer->writeLine($line);
        }
    }

    /**
     * @param CB_Role $role
     *
     * @return string[]
     */
    private function getLine(CB_Role $role)
    {
        $line = [];
        $foreignKey = $role->get('foreign_key');

        // 1. code
        $line[] = $foreignKey;

        // 2. name
        $line[] = $foreignKey;

        // 3. new code
        $line[] = $foreignKey;

        // 4. type
        $line[] = 'static';

        // 5. memo
        $line[] = $role->get('description');

        // 6. slash id
        $line[] = $role->get('slash');

        return $line;
    }
}
