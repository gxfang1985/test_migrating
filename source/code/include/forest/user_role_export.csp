<?php

require_once('fw/csv.csp');

class GRN_ForestUserRoleExport
{
    const CHARSET = 'UTF-8';
    const ADMINISTRATOR_ID = '1';

    public function __construct()
    {
        global $G_container_base;
        $this->uum = $G_container_base->getInstance('uum');
    }

    public function main()
    {
        if ( ! defined('ON_FOREST')) {
            exit("Error: not forest mode");
        }

        $this->export();
    }

    private function export()
    {
        $writer = new CB_CSVWriter(self::CHARSET, null);

        $allUsers = $this->uum->getUsers();
        foreach ($allUsers as $user) {
            if ($user->getOID() == self::ADMINISTRATOR_ID) {
                continue;
            }
            $roles = $this->uum->getUserRoles($user->getOID());
            $loginName = $user->get('foreign_key');
            $line = [];
            // 1. login code
            $line[] = $loginName;
            foreach ($roles as $role) {

                // 2,3,4,・・・,n group code
                $line[] = $role->get('foreign_key');

            }
            $writer->writeLine($line);
        }
    }
}
