<?php

namespace grn\kunai\db\dao;

use grn\kunai\data\bean\KunaiAvailabilityStaticRole;
use grn\kunai\data\collection\KunaiAvailabilityStaticRoleCollection;
use grn\kunai\db\dao\AbstractKunaiBaseDAO;
use grn\kunai\exception\KunaiException;

class KunaiAvailabilityStaticRoleDAO extends AbstractKunaiBaseDAO
{
    /**
     * Select all or multi records
     *
     * @param  array $static_role_ids
     *         If you want to select many records, you can set this parameter.
     *
     * @return KunaiAvailabilityStaticRoleCollection    $availability_static_role_collection
     */
    public function selectAllOrMulti(array $static_role_ids = [])
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT";
            $query .= " _id, ";
            $query .= " col_ctime, ";
            $query .= " col_static_role, ";
            $query .= " col_app_status ";
            $query .= "FROM";
            $query .= " tab_grn_kunai_availability_static_role ";

            if (count($static_role_ids) > 0) {
                $query .= "WHERE col_static_role IN (";
                $tempIsNeedComma = false;
                foreach ($static_role_ids as $static_role_id) {
                    if ($tempIsNeedComma) {
                        $query .= ", ";
                    }
                    $query .= "'{$dbConn->escape($static_role_id)}'";
                    $tempIsNeedComma = true;
                }
                $query .= ") ";
            }

            $query .= "ORDER BY _id ASC";
            $query .= ";";
            $result = $dbConn->query($query);
            $availability_static_role_collection
                = new KunaiAvailabilityStaticRoleCollection();
            while ($row = $dbConn->fetch_assoc($result)) {
                $row['col_app_status'] = cb_unserialize($row['col_app_status'],
                    ["allowed_classes" => false]);
                $availability_static_role_collection->appendBean(new KunaiAvailabilityStaticRole($row,
                    KunaiAvailabilityStaticRole::NOT_CHECK_INPUT));
            }
            $dbConn->free_result($result);

            $availability_static_role_collection->setCountNoLimit(count($availability_static_role_collection));
        } catch (KunaiException $e) {
            throw $e;
        }

        return $availability_static_role_collection;
    }

    /**
     * Delete multi records
     *
     * @param array $static_role_ids
     */
    public function deleteMulti(array $static_role_ids)
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query
                = "DELETE FROM tab_grn_kunai_availability_static_role WHERE col_static_role IN (";
            $tempIsNeedComma = false;
            foreach ($static_role_ids as $static_role_id) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }
                $query .= "'{$dbConn->escape($static_role_id)}'";
                $tempIsNeedComma = true;
            }
            $query .= ");";
            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Delete all records
     */
    public function deleteAll()
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "DELETE FROM tab_grn_kunai_availability_static_role;";
            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Insert one record
     *
     * @param KunaiAvailabilityStaticRole $availability_static_role
     */
    public function insert(KunaiAvailabilityStaticRole $availability_static_role
    ) {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query = "INSERT INTO tab_grn_kunai_availability_static_role SET";
            $query .= "  col_ctime = '{$dbConn->escape( $availability_static_role->getCreateTime() )}'";
            $query .= ", col_static_role = '{$dbConn->escape( $availability_static_role->getStaticRoleId() )}'";
            $query .= ", col_app_status = '{$dbConn->escape( serialize($availability_static_role->getAppStatus()) )}'";
            $query .= ";";

            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Update one record
     *
     * @param KunaiAvailabilityStaticRole $availability_static_role
     */
    public function update(KunaiAvailabilityStaticRole $availability_static_role
    ) {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query = "UPDATE tab_grn_kunai_availability_static_role SET";
            $query .= "  col_app_status = '{$dbConn->escape( serialize($availability_static_role->getAppStatus()) )}'";
            $query .= " WHERE ";
            $query .= "  col_static_role = '{$dbConn->escape( $availability_static_role->getStaticRoleId() )}'";
            $query .= " AND ";
            $query .= "  _id = '{$dbConn->escape( $availability_static_role->getId() )}'";
            $query .= ";";

            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Select one record by static role id
     *
     * @param  string $static_role_id
     *
     * @return KunaiAvailabilityStaticRole    $availability_static_role
     */
    public function selectByStaticRoleId($static_role_id)
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT";
            $query .= " _id, ";
            $query .= " col_ctime, ";
            $query .= " col_static_role, ";
            $query .= " col_app_status ";
            $query .= "FROM";
            $query .= " tab_grn_kunai_availability_static_role ";
            $query .= "WHERE ";
            $query .= " col_static_role = '{$dbConn->escape( $static_role_id )}' ";
            $query .= "ORDER BY _id ASC";
            $query .= ";";
            $result = $dbConn->query($query);
            if ($row = $dbConn->fetch_assoc($result)) {
                $row['col_app_status'] = cb_unserialize($row['col_app_status'],
                    ["allowed_classes" => false]);
                $availability_static_role
                    = new KunaiAvailabilityStaticRole($row,
                    KunaiAvailabilityStaticRole::NOT_CHECK_INPUT);
            } else {
                $availability_static_role = new KunaiAvailabilityStaticRole();
            }
            $dbConn->free_result($result);
        } catch (KunaiException $e) {
            throw $e;
        }

        return $availability_static_role;
    }

}
