<?php

namespace grn\kunai\db\dao;

use grn\kunai\data\bean\KunaiAvailabilityDynamicRole;
use grn\kunai\data\collection\KunaiAvailabilityDynamicRoleCollection;
use grn\kunai\db\dao\AbstractKunaiBaseDAO;
use grn\kunai\exception\KunaiException;

class KunaiAvailabilityDynamicRoleDAO extends AbstractKunaiBaseDAO
{
    /**
     * Select all or multi records
     *
     * @param  array $dynamic_roles 'Everyone', 'LoginUser'
     *                              If you want to select many records, you can set this parameter.
     *
     * @return KunaiAvailabilityDynamicRoleCollection    $availability_dynamic_role_collection
     */
    public function selectAllOrMulti(array $dynamic_roles = [])
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT";
            $query .= " _id, ";
            $query .= " col_ctime, ";
            $query .= " col_dynamic_role, ";
            $query .= " col_app_status ";
            $query .= "FROM";
            $query .= " tab_grn_kunai_availability_dynamic_role ";

            if (count($dynamic_roles) > 0) {
                $query .= "WHERE col_dynamic_role IN (";
                $tempIsNeedComma = false;
                foreach ($dynamic_roles as $dynamic_role) {
                    if ($tempIsNeedComma) {
                        $query .= ", ";
                    }
                    $query .= "'{$dbConn->escape($dynamic_role)}'";
                    $tempIsNeedComma = true;
                }
                $query .= ") ";
            }

            $query .= "ORDER BY _id ASC";
            $query .= ";";
            $result = $dbConn->query($query);
            $availability_dynamic_role_collection
                = new KunaiAvailabilityDynamicRoleCollection();
            while ($row = $dbConn->fetch_assoc($result)) {
                $row['col_app_status'] = cb_unserialize($row['col_app_status'],
                    ["allowed_classes" => false]);
                $availability_dynamic_role_collection->appendBean(new KunaiAvailabilityDynamicRole($row,
                    KunaiAvailabilityDynamicRole::NOT_CHECK_INPUT));
            }
            $dbConn->free_result($result);

            $availability_dynamic_role_collection->setCountNoLimit(count($availability_dynamic_role_collection));
        } catch (KunaiException $e) {
            throw $e;
        }

        return $availability_dynamic_role_collection;
    }

    /**
     * Delete multi records
     *
     * @param array $dynamic_roles
     */
    public function deleteMulti(array $dynamic_roles)
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query
                = "DELETE FROM tab_grn_kunai_availability_dynamic_role WHERE col_dynamic_role IN (";
            $tempIsNeedComma = false;
            foreach ($dynamic_roles as $dynamic_role) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }
                $query .= "'{$dbConn->escape($dynamic_role)}'";
                $tempIsNeedComma = true;
            }
            $query .= ");";
            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Delete all records
     */
    public function deleteAll()
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "DELETE FROM tab_grn_kunai_availability_dynamic_role;";
            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Insert one record
     *
     * @param KunaiAvailabilityDynamicRole $availability_dynamic_role
     */
    public function insert(
        KunaiAvailabilityDynamicRole $availability_dynamic_role
    ) {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query = "INSERT INTO tab_grn_kunai_availability_dynamic_role SET";
            $query .= "  col_ctime = '{$dbConn->escape( $availability_dynamic_role->getCreateTime() )}'";
            $query .= ", col_dynamic_role = '{$dbConn->escape( $availability_dynamic_role->getDynamicRole() )}'";
            $query .= ", col_app_status = '{$dbConn->escape( serialize($availability_dynamic_role->getAppStatus()) )}'";
            $query .= ";";

            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Update one record
     *
     * @param KunaiAvailabilityDynamicRole $availability_dynamic_role
     */
    public function update(
        KunaiAvailabilityDynamicRole $availability_dynamic_role
    ) {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query = "UPDATE tab_grn_kunai_availability_dynamic_role SET";
            $query .= "  col_app_status = '{$dbConn->escape( serialize($availability_dynamic_role->getAppStatus()) )}'";
            $query .= " WHERE ";
            $query .= "  col_dynamic_role = '{$dbConn->escape( $availability_dynamic_role->getDynamicRole() )}'";
            $query .= " AND ";
            $query .= "  _id = '{$dbConn->escape( $availability_dynamic_role->getId() )}'";
            $query .= ";";

            $dbConn->query($query);
        } catch (KunaiException $e) {
            throw $e;
        }
    }

    /**
     * Select one record by dynamic role
     *
     * @param  string $dynamic_role
     *
     * @return KunaiAvailabilityDynamicRole    $availability_dynamic_role
     */
    public function selectByDynamicRole($dynamic_role)
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT";
            $query .= " _id, ";
            $query .= " col_ctime, ";
            $query .= " col_dynamic_role, ";
            $query .= " col_app_status ";
            $query .= "FROM";
            $query .= " tab_grn_kunai_availability_dynamic_role ";
            $query .= "WHERE ";
            $query .= " col_dynamic_role = '{$dbConn->escape( $dynamic_role )}' ";
            $query .= "ORDER BY _id ASC";
            $query .= ";";
            $result = $dbConn->query($query);
            if ($row = $dbConn->fetch_assoc($result)) {
                $row['col_app_status'] = cb_unserialize($row['col_app_status'],
                    ["allowed_classes" => false]);
                $availability_dynamic_role
                    = new KunaiAvailabilityDynamicRole($row,
                    KunaiAvailabilityDynamicRole::NOT_CHECK_INPUT);
            } else {
                $availability_dynamic_role = new KunaiAvailabilityDynamicRole();
            }
            $dbConn->free_result($result);
        } catch (KunaiException $e) {
            throw $e;
        }

        return $availability_dynamic_role;
    }

}
