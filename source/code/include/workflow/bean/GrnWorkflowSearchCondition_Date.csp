<?php
require_once("workflow/bean/GrnWorkflowSearchCondition.csp");

/**
 *
 */
class GrnWorkflowSearchCondition_Date extends GrnWorkflowSearchCondition
{
    private $validOperator
        = [
            parent::GRN_WORKFLOW_SEARCH_OPERATOR_EQUAL,
            parent::GRN_WORKFLOW_SEARCH_OPERATOR_NOT_EQUAL,
            parent::GRN_WORKFLOW_SEARCH_OPERATOR_AFTER,
            parent::GRN_WORKFLOW_SEARCH_OPERATOR_BEFORE
        ];

    /**
     * @return int
     */
    public function getType()
    {
        return parent::GRN_WORKFLOW_SEARCH_ITEM_DATE;
    }

    /**
     * @@see GrnWorkflowSearchCondition::hasValidValue
     * @return bool
     */
    public function hasValidValue()
    {
        $valid_operator = in_array($this->getOperator(), $this->validOperator);
        $valid_value = $this->getValue() instanceof CB_DateEx;

        return $valid_operator && $valid_value;
    }

    /**
     * @return int
     */
    private function getStartTime()
    {
        /**
         * @var $value CB_DateEx
         */
        $value = $this->getValue();

        return strtotime($value->format());
    }

    /**
     * @return int
     */
    private function getEndTime()
    {
        /**
         * @var $value CB_DateEx
         */
        $value = $this->getValue();
        $tomorrow = clone $value;
        $tomorrow->moveDays(1);

        return strtotime($tomorrow->format());

    }

    /**
     * @see GrnWorkflowSearchCondition::getConditionSQL
     *
     * @param CB_DatabaseConnection $db
     *
     * @return string
     */
    protected function equals(CB_DatabaseConnection $db)
    {
        return "({$this->getColumnName()} >= '{$this->getStartTime()}' AND {$this->getColumnName()} < '{$this->getEndTime()}')";
    }

    /**
     * @see GrnWorkflowSearchCondition::getConditionSQL
     *
     * @param CB_DatabaseConnection $db
     *
     * @return string
     */
    protected function notEquals(CB_DatabaseConnection $db)
    {
        return "({$this->getColumnName()} < '{$this->getStartTime()}' OR {$this->getColumnName()} >= {$this->getEndTime()})";
    }

    /**
     * @see GrnWorkflowSearchCondition::getConditionSQL
     *
     * @param CB_DatabaseConnection $db
     *
     * @return string
     */
    protected function after(CB_DatabaseConnection $db)
    {
        return "({$this->getColumnName()} >= '{$this->getStartTime()}')";
    }

    /**
     * @see GrnWorkflowSearchCondition::getConditionSQL
     *
     * @param CB_DatabaseConnection $db
     *
     * @return string
     */
    protected function before(CB_DatabaseConnection $db)
    {
        return "({$this->getColumnName()} < '{$this->getEndTime()}')";
    }

    /**
     * @return string
     */
    protected function getColumnName()
    {
        return 'p.col_ctime';
    }
}
