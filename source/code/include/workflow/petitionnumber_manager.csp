<?php
/**
 * Workflow Application Petition Number Class
 *
 * @author  Yuichi, Nakamura 2006/02
 * @version 1.0
 * @package grn.workflow
 */

/** Workflow Application **/
require_once('workflow/resources.csp');
require_once('workflow/petitionnumber_manager_base.csp');

/**
 * Petition Manager Class
 *
 * @package grn.workflow
 */
class GRN_Workflow_PetitionNumber_Manager
    extends GRN_Workflow_PetitionNumber_Manager_Base
{
    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {
        //Get Parent Instance
        $parent = parent::getInstance();

        //Sync Parent Table and Petition List Cache
        $this->_table_name =& $parent->_table_name;
        $this->_list =& $parent->_list;
    }

    /**
     * Get Instance
     *
     * @return GRN_Workflow_PetitionNumber_Manager $instance                  //Instance of GRN_Workflow_PetitionNumber_Manager
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Workflow_PetitionNumber_Manager();
        }

        return $_instance;
    }

    /**
     * Create Petition Number
     *
     * @param  array $property_list //Property List(Name=>Value)
     *
     * @return int   $petition_number_id                //Petition Number ID
     */
    function create($property_list)
    {
        //Get Database
        $database = $this->_getDatabase();

        //Create Column List
        $column_list = $this->_getColumnList();

        //Create Query
        $insert_list = [];
        foreach ($column_list as $column) {
            if ($column == '_id') {
                $insert_list[$column] = 'NULL';
            } else {
                $insert_list[$column] = cb_queryf($database, '"@S"',
                    $insert_list[$column]);
            }
        }
        $column_string = implode(', ', array_keys($insert_list));
        $value_string = implode(', ', $insert_list);
        $query = sprintf('INSERT %s(%s) VALUES (%s)',
            $this->_table_name, $column_string, $value_string);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Return Petition ID
        $petition_number_id = $database->get_insert_id();

        return $petition_number_id;
    }
}


