<?php

require_once('fw/database.csp');
require_once('workflow/bean/GrnWorkflowForm.csp');

class GrnWorkflowFormDAO
{
    /**
     * @param $inDataObj
     * @param $inPathId
     *
     * @return GrnWorkflowForm[]
     */
    public function getWorkflowFormListByPathId($inDataObj, $inPathId)
    {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inLock = (array_key_exists('lock', $inDataObj))
            ? $inDataObj['lock'] : null;
        $inOffset = (array_key_exists('offset', $inDataObj))
            ? $inDataObj['offset'] : null;
        $inLimit = (array_key_exists('limit', $inDataObj))
            ? $inDataObj['limit'] : null;
        $inLanguage = (array_key_exists('language', $inDataObj))
            ? $inDataObj['language'] : null;

        $query = "SELECT a._id";
        $query = $query . ", a.col_active";
        $query = $query . ", a.col_category";
        $query = $query . ", a.col_creator";
        $query = $query . ", a.col_creator_foreign_key";
        $query = $query . ", a.col_creator_name";
        $query = $query . ", a.col_ctime";
        $query = $query . ", a.col_list_index";
        $query = $query . ", a.col_modifier";
        $query = $query . ", a.col_modifier_foreign_key";
        $query = $query . ", a.col_modifier_name";
        $query = $query . ", a.col_mtime";
        $query = $query . ", a.col_name";
        $query = $query . ", a.col_foreign_key";
        $query = $query . ", a.col_path";
        $query = $query . ", a.col_path_step";
        $query = $query . ", a.col_memo";
        $query = $query . ", a.col_serial_format";
        $query = $query . ", a.col_serial_number";
        $query = $query . ", a.col_serial_type";
        $query = $query . ", a.col_transactor";
        $query = $query . ", a.col_transactor_name";
        $query = $query . ", a.col_type";
        $query = $query . ", a.col_admin_memo";
        $query = $query . ", a.col_auto_export";
        $query = $query . ", a.col_deleted";
        $query = $query . ", a.col_export_folder";
        $query = $query . ", a.col_icon_id";
        $query = $query . ", a.col_icon_type";
        $query = $query . ", a.col_icon_url";
        $query = $query . ", f._id AS col_category";
        $query = $query
                 . ", IFNULL(fl.col_name, f.col_name) AS col_category_name";
        $query = $query
                 . " FROM tab_grn_workflow_form AS a LEFT JOIN (tab_grn_workflow_category f LEFT JOIN (tab_grn_workflow_category_local fl INNER JOIN tab_cb_language_status l ON fl.language_id = l._id AND l.col_language = '"
                 . $inDb->escape($inLanguage)
                 . "') ON f._id = fl.parent_id) ON a.col_category = f._id";
        $query = $query . " WHERE a.col_path = '" . $inDb->escape($inPathId)
                 . "'";
        $query = $query . "   AND  a.col_deleted <> 1 ";
        $query = $query . " ORDER BY f._id, a.col_list_index, a._id";

        if ( ! is_null($inOffset)) {
            $query = $inDb->select_format($query, $inOffset, $inLimit, $inLock);
        }

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnFormArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnForm = new GrnWorkflowForm($rawdata);
            $grnFormArray[] = $grnForm;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnFormArray;
    }
}
