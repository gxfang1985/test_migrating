<?php

/**
 * 経路データ
 *
 * @author  Yuichi UEYAMA 2006/01
 * @version 1.0
 * @package grn.workflow
 */

require_once('workflow/model.csp');

/**
 * 経路分岐条件データクラス
 */
class GRN_Workflow_PathConditionDatas extends GRN_Workflow_Model
{
    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {
        //Parent Class Constructer
        parent::__construct('tab_grn_workflow_pathconditiondata');

        //Initialize Columns Information
        $this->_columns_info = [
            'necessary' => [
                'col_name' => ''
            ],
            'default'   => [
                'col_number'         => null,
                'col_operator'       => null,
                'col_option'         => '',
                'col_path_skip_data' => '',
                'col_path_condition' => '',
            ],
        ];

        //Initialize Table Aliases for Join
        $this->_aliases = [
            'tab_grn_workflow_pathconditiondata'     => 'a',
            'tab_grn_workflow_pathskipdata'          => 'b',
            'tab_grn_workflow_itemdata'              => 'c',
            'tab_grn_workflow_pathconditionstepdata' => 'd',
        ];
    }

    /**
     * Get Instance
     *
     * @return GRN_Workflow_PathConditionDatas $instance                  //Instance of GRN_Workflow_PathConditionDatas
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Workflow_PathConditionDatas();
        }

        return $_instance;
    }

    /**
     * Add Path Condition Data
     *
     * @param   array $properties //Path Condition Data Properties
     *
     * @return  string  $path_condition_id       //Path Condition Data ID
     */
    function &add($properties)
    {
        //Check Arguments
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Properties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        //Insert Path Condition Data
        $ret = $this->_insertRecords(array_keys($properties), [$properties]);

        return $ret;
    }

    /**
     * Modify Path Condition Data
     *
     * @param   int   $path_condition_data_id //Path Condition Data
     * @param   array $properties             //Path Condition Data Properties
     */
    function modify($path_condition_data_id, $properties)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_data_id,
            E_GRN_WRKF_PATH_CONDITION_DATA_INVALID_ID);   //Path Condition Data ID
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Priperties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        $columns = [
            'tab_grn_workflow_pathconditiondata' => ['_id' => 'col_path_condition_data',],
        ];

        //Check Path Condition Data Exists
        $path_condition_data = $this->get($path_condition_data_id, $columns);
        if ( ! is_array($path_condition_data)
             || 0 == count($path_condition_data)
        ) {
            //Path Condition Not Found
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_PATH_CONDITION_NOT_FOUND);
        }

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "_id='@S'",
            $path_condition_data_id);

        //Update Path Condition Data
        $this->_updateRecords($condition, $properties);
    }

    /**
     * Remove Path Condition
     *
     * @param   int $path_condition_data_id //Path Condition Data ID
     *
     * @return  none
     */
    function remove($path_condition_data_id)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_data_id,
            E_GRN_WRKF_PATH_CONDITION_DATA_INVALID_ID);  //Path Condition Data ID

        //Check Path Condition Data Exists
        $path_condition_data = $this->get($path_condition_data_id);
        if ( ! is_array($path_condition_data)
             || 0 == count($path_condition_data)
        ) {
            //Path Condition Data Not Found
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_PATH_CONDITION_DATA_NOT_FOUND);
        }

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "_id='@S'",
            $path_condition_data_id);

        //Delete Path Condition Data
        $this->_deleteRecords($condition);
    }

    /**
     * Remove Path Condition Data List
     *
     * @param   mixed $path_condition_data_id_list //Path Condition Data ID List
     *
     * @return  none
     */
    function removeList($path_condition_data_id_list = null)
    {
        //Create Condition String
        $condition = null;
        if (is_array($path_condition_data_id_list)
            && 0 < count($path_condition_data_id_list)
        ) {
            foreach ($path_condition_data_id_list as $key => $value) {
                $path_condition_data_id_list[$key] = cb_queryf($this->_dbconn,
                    "'@S'", $value);
            }
            $path_condition_data_id_list = implode(',',
                $path_condition_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "_id IN (@S)", $path_condition_data_id_list);
            $condition = '_id IN(' . $path_condition_data_id_list . ')';
        }

        //Delete Path Condition Data List
        $this->_deleteRecords($condition);
    }

    /**
     * Get Path Condition Data
     *
     * @param   int   $path_condition_data_id //Path Condition ID
     * @param   array $columns                //Request Columns
     * @param   int   $lock                   //Lock Mode
     *
     * @return  mixed   $path_condition_data          //Path Condition(or FALSE)
     */
    function &get(
        $path_condition_data_id,
        $columns = null,
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_data_id,
            E_GRN_WRKF_PATH_CONDITION_DATA_INVALID_ID);  //Path Condition Data ID

        //Create Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from
            = "tab_grn_workflow_pathconditiondata AS a 
                 INNER JOIN tab_grn_workflow_pathskipdata AS b ON a.col_path_skip_data = b._id 
                 INNER JOIN tab_grn_workflow_itemdata AS c ON b.col_item_data = c._id";

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "a._id='@S'",
            $path_condition_data_id);

        //Create Order By String
        $order_by = 'a.col_list_index,a._id';

        //Create and Send Query
        $query
            = "SELECT {$columns} FROM {$from} WHERE ({$condition}) ORDER BY {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, 1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Querty Faild
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Get Path Condition Data
        $path_condition_data = $this->_dbconn->fetch_assoc($result);

        return $path_condition_data;
    }

    /**
     * Get Path Condition Data List
     *
     * @param   array $path_condition_data_id_list //Path Condition Data ID List
     * @param   int   $petition_id                 //Petition ID
     * @param   array $columns                     //Columns
     * @param   int   $lock                        //Lock Mode
     *
     * @return  array   $path_condition_data_list       //Path Condition Data List
     */
    function &getList(
        $path_condition_data_id_list = null,
        $petition_id = null,
        $columns = null,
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($petition_id,
            E_GRN_WRKF_PETITION_INVALID_ID);    //Petition ID

        //Create Condition String
        $condition = [];
        if (is_array($path_condition_data_id_list)
            && 0 < count($path_condition_data_id_list)
        ) {
            foreach ($path_condition_data_id_list as $key => $value) {
                $path_condition_data_id_list[$key] = cb_queryf($this->_dbconn,
                    "'@S'", $value);
            }
            $path_condition_data_id_list = implode(',',
                $path_condition_data_id_list);
//            $condition[] = cb_queryf($this->_dbconn, "a._id IN (@S)", $path_condition_data_id_list);
            $condition[] = 'a._id IN(' . $path_condition_data_id_list . ')';
        }
        $condition[] = cb_queryf($this->_dbconn, "b.col_petition='@S'",
            $petition_id);
        if (is_array($condition) && 0 < count($condition)) {
            $condition = implode(' AND ', $condition);
        }

        //Create Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from
            = "tab_grn_workflow_pathconditiondata AS a 
                 INNER JOIN tab_grn_workflow_pathskipdata AS b ON a.col_path_skip_data = b._id 
                 INNER JOIN tab_grn_workflow_itemdata AS c ON b.col_item_data = c._id 
                 LEFT JOIN tab_grn_workflow_pathconditionstepdata AS d ON a._id = d.col_path_condition_data";

        //Create Order By String
        $order_by = 'a.col_list_index,a._id,c.col_list_index,c._id';

        //Create and Send Query
        $query = "SELECT {$columns} FROM {$from}";
        if ($condition !== null) {
            $query .= " WHERE ({$condition})";
        }
        $query .= " ORDER BY {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, -1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Create Path Condition Data List
        $path_condition_data_list = [];
        while ($row = $this->_dbconn->fetch_assoc($result)) {
            if (is_array($row) && array_key_exists('col_settings', $row)) {
                $row['col_settings'] = cb_unserialize($row['col_settings'],
                    ["allowed_classes" => false]);
            }
            $path_condition_data_list[$row['_id']] = $row;
        }

        //Return Path Condition List
        return $path_condition_data_list;
    }

    /**
     * Get List By Path Skip Data ID
     *
     * @param   array $path_step_data_id_list //Path Step Data ID List
     * @param   array $columns                //Columns
     * @param   int   $lock                   //Lock Mode
     *
     * @return  array   $path_condition_data_list   //Path Condition Data List
     */
    function getListByPathSkipDataId(
        $path_step_data_id_list = null,
        $columns = null,
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Create Condition String
        $condition = null;
        if (is_array($path_step_data_id_list)
            && 0 < count($path_step_data_id_list)
        ) {
            foreach ($path_step_data_id_list as $key => $value) {
                $path_step_data_id_list[$key] = cb_queryf($this->_dbconn,
                    "'@S'", $value);
            }
            $path_step_data_id_list = implode(',', $path_step_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "col_path_skip_data IN (@S)", $path_step_data_id_list);
            $condition = 'col_path_skip_data IN(' . $path_step_data_id_list
                         . ')';
        }

        //Create Column String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create Form String
        $from = "tab_grn_workflow_pathcondition AS a";

        //Create Order By String
        $order_by = 'a.col_list_index,a._id';

        //Create and Send Query
        $query = "SELECT {$columns} FROM {$from}";
        if ($condition !== null) {
            $query .= " WHERE ({$condition})";
        }
        $query .= " ORDER BY {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, -1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Query Faild
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Create Path Condition Data List
        $path_condition_data_list = [];
        while ($row = $this->_dbconn->fetch_assoc($result)) {
            $path_condition_data_list[$row['_id']] = $row;
        }

        //Return Path Condition List
        return $rows;
    }
}

/**
 * 経路スキップデータクラス
 */
class GRN_Workflow_PathConditionStepDatas extends GRN_Workflow_Model
{
    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {
        //Parent Class Constructor
        parent::__construct('tab_grn_workflow_pathconditionstepdata');

        //Initialize Columns Information
        $this->_columns_info = [
            'default' => [
                'col_path_condition_data' => null,
                'col_path_step_data'      => null,
                'col_path_condition_step' => null,
            ],
        ];

        //Initialize Table Aliases for Join
        $this->_aliases = [
            'tab_grn_workflow_pathconditionstepdata' => 'a',
        ];
    }

    /**
     * Get Instance
     *
     * @return GRN_Workflow_PathConditionStepDatas
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Workflow_PathConditionStepDatas();
        }

        return $_instance;
    }

    /**
     * Add Path Condition Step Data
     *
     * @param   array $properties //Path Condition Step Data Properties
     *
     * @return  string     $path_condition_step_id  //Path Condition Step ID
     */
    function &add($properties)
    {
        //Check Arguments
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Properties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        //Insert Path Condition Step Data
        $ret = $this->_insertRecords(array_keys($properties), [$properties]);

        return $ret;
    }

    /**
     * Add Path Condition Step Data List
     *
     * @param   array $columns //Columns
     * @param   array $records //Records
     *
     * @return  string  $last_insert_id          //Last Insert Path Condition Step Data ID
     */
    function addList($columns, $records)
    {
        //Check Arguments
        if ( ! is_array($columns) || 0 == count($columns)) {
            //Empty Columns
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_COLUMNS);
        }
        if ( ! is_array($records) || 0 == count($records)) {
            //Empty Records
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_RECORDS);
        }

        //Insert Path Condition Step Data List
        return $this->_insertRecords($columns, $records);
    }

    /**
     * Modify Path Condition Step Data
     *
     * @param   int   $path_condition_step_data_id //Path Condition Step Data ID
     * @param   array $properties                  //Path Condition Step Data Properties
     */
    function modify($path_condition_step_data_id, $properties)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_step_data_id,
            E_GRN_WRKF_PATH_CONDITION_STEP_DATA_INVALID_ID);   //Path Condition Step Data ID
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Priperties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        //Check Path Condition Step Data Exists
        $path_condition_step_data = $this->get($path_condition_step_data_id);
        if ( ! is_array($path_condition_step_data)
             || 0 == count($path_condition_step_data)
        ) {
            //Path Condition Step Not Found
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_PATH_CONDITION_STEP_DATA_NOT_FOUND);
        }

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "_id='@S'",
            $path_condition_step_data_id);

        //Update Path Condition Step Data
        $this->_updateRecords($condition, $properties);
    }

    /**
     * Remove Path Condition Step Data
     *
     * @param   int $path_condition_step_data_id //Path Condition Step Data ID
     *
     * @return  none
     */
    function remove($path_condition_step_data_id)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_step_data_id,
            E_GRN_WRKF_PATH_CONDITION_STEP_DATA_INVALID_ID);

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "_id='@S'",
            $path_condition_step_data_id);

        //Delete Path Condition Step Data
        $this->_deleteRecords($condition);
    }

    /**
     * Remove Path Condition Step Data List
     *
     * @param   array $path_condition_step_data_id_list //Path Condition Step Data ID List
     *
     * @return  none
     */
    function removeList($path_condition_step_data_id_list = null)
    {
        //Create Condition String
        $condition = null;
        if (is_array($path_condition_step_data_id_list)
            && 0 < count($path_condition_step_data_id_list)
        ) {
            foreach ($path_condition_step_data_id_list as $key => $value) {
                $path_condition_step_data_id_list[$key]
                    = cb_queryf($this->_dbconn, "'@S'", $value);
            }
            $path_condition_step_data_id_list = implode(',',
                $path_condition_step_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "_id IN (@S)", $path_condition_step_data_id_list);
            $condition = '_id IN(' . $path_condition_step_data_id_list . ')';
        }

        //Delete Path Condition Step Data List
        $this->_deleteRecords($condition);
    }

    /**
     * Remove Path Condition Step List By Path Condition Data ID
     *
     * @param   array $path_condition_data_id_list //Path Condition Data ID List
     *
     * @return  none
     */
    function removeListByPathConditionDataId($path_condition_data_id_list = null
    ) {
        //Create Condition String
        $condition = null;
        if (is_array($path_condition_data_id_list)
            && 0 < count($path_condition_data_id_list)
        ) {
            foreach ($path_condition_data_id_list as $key => $value) {
                $path_condition_data_id_list[$key] = cb_queryf($this->_dbconn,
                    "'@S'", $value);
            }
            $path_condition_data_id_list = implode(',',
                $path_condition_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "col_path_condition_data IN (@S)", $path_condition_data_id_list);
            $condition = 'col_path_condition_data IN('
                         . $path_condition_data_id_list . ')';
        }

        //Delete Path Condition Step Data List
        $this->_deleteRecords($condition);
    }

    /**
     * Get Path Condition Step
     *
     * @param   int   $path_condition_step_data_id //Path Condition Step ID
     * @param   array $columns                     //Request Columns
     * @param   int   $lock                        //Lock Mode
     *
     * @return  array   $path_condition_step_data       //Path Condition Step Data
     */
    function &get(
        $path_condition_step_data_id,
        $columns = null,
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_condition_step_data_id,
            E_GRN_WRKF_PATH_CONDITION_STEP_DATA_INVALID_ID); //Path Condition Step Data ID

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "_id='@S'",
            $path_condition_step_data_id);

        //Get Path Condition Step Data List
        $path_condition_step_data_list = $this->_selectRecords($columns, '_id',
            0, 1, null, $condition, $lock);

        //Return Path Condition Step Data
        return $path_condition_step_data_list[$path_condition_step_data_id];
    }

    /**
     * Get List
     *
     * @param   array $path_condition_step_data_id_list //Path Condition Step Data ID List
     * @param   array $columns                          //Request Columns
     * @param   int   $lock                             //Lock Mode
     *
     * @return  array   $path_condition_step_data_list      //Path Condition Step Data List
     */
    function &getList(
        $path_condition_step_data_id_list = null,
        $columns = null,
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Create Condition String
        $condition = null;
        if (is_array($path_condition_step_data_id_list)
            && 0 < count($path_condition_step_data_id_list)
        ) {
            foreach ($path_condition_step_data_id_list as $key => $value) {
                $path_condition_step_data_id_list[$key]
                    = cb_queryf($this->_dbconn, "'@S'", $value);
            }
            $path_condition_step_data_id_list = implode(',',
                $path_condition_step_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "_id IN (@S)", $path_condition_step_data_id_list);
            $condition = '_id IN(' . $path_condition_step_data_id_list . ')';
        }

        //Get Path Condition Step Data List
        $path_condition_step_data_list = $this->_selectRecords($columns, '_id',
            0, -1, '_id', $condition, $lock);

        //Return Path Condition Step Data List
        return $path_condition_step_data_list;
    }

    /**
     * Get Path Condition Step List By Path Condition Data ID
     *
     * @param   mixed  $path_condition_data_id_list //Path Condition Data ID List
     * @param   array  $columns                     //Request Columns
     * @param   string $key                         //Key Column
     * @param   int    $lock                        //Lock Modd
     *
     * @return  array   $path_condition_step_data_list  //Path Condition Step Data List
     */
    function getListByPathConditionDataId(
        $path_condition_data_id_list = null,
        $columns = null,
        $key = '_id',
        $lock = CB_DATABASE_NO_LOCK
    ) {
        //Create Condition String
        $condition = null;
        if (is_array($path_condition_data_id_list)
            && 0 < count($path_condition_data_id_list)
        ) {
            foreach ($path_condition_data_id_list as $index => $value) {
                $path_condition_data_id_list[$index] = cb_queryf($this->_dbconn,
                    "'@S'", $value);
            }
            $path_condition_data_id_list = implode(',',
                $path_condition_data_id_list);
//            $condition = cb_queryf($this->_dbconn, "col_path_condition_data IN (@S)", $path_condition_id_data_list);
            $condition = 'col_path_condition_data IN('
                         . $path_condition_data_id_list . ')';
        }

        //Get Path Condition Step Data List
        $path_condition_step_data_list = $this->_selectRecords($columns, $key,
            0, -1, '_id', $condition, $lock);

        //Return Path Condition Step Data List
        return $path_condition_step_data_list;
    }
}

