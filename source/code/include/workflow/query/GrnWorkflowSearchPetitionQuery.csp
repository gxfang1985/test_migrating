<?php
require_once("workflow/query/GrnWorkflowSearchQuery.csp");

/**
 *
 */
class GrnWorkflowSearchPetitionQuery extends GrnWorkflowSearchQuery
{
    /**
     * @var string
     */
    private $folderId;

    public function setFolderId($folderId)
    {
        $this->folderId = $folderId;
    }

    public function getFolderId()
    {
        return $this->folderId;
    }

    /**
     *
     * @var array<string>
     */
    private $removedIdList = [];

    public function setRemovedIdList($removedIdList)
    {
        $this->removedIdList = $removedIdList;
    }

    public function getRemovedIdList()
    {
        return $this->removedIdList;
    }

    private function getRemoveIdListCSV()
    {
        return implode(",", $this->getRemovedIdList());
    }

    /**
     *
     * (non-PHPdoc)
     * @return string
     */
    public function getQuery()
    {
        $conditionsQuery = $this->getConditionQuery();
        $db = $this->getDatabaseConnection();

        $query
            = "SELECT DISTINCT "
              . " r.col_petition AS col_petition "
              . "FROM "
              . "tab_grn_workflow_folderrelation r "
              . "INNER JOIN tab_grn_workflow_folder AS f ON r.col_folder=f._id "
              . "INNER JOIN tab_cb_user AS u ON (f.col_user=u._id AND u.col_deleted IS NULL) "
              . "INNER JOIN tab_grn_workflow_petition AS p ON p._id = r.col_petition "
              . "INNER JOIN tab_grn_workflow_itemdata AS d ON d.col_petition = r.col_petition "
              . "LEFT JOIN  tab_cb_user AS pu ON p.col_user = pu._id "
              . "WHERE " .
              "{$this->queryf("f._id = '@S'", [$this->getFolderId()])} ";

        if (strlen($conditionsQuery) > 0) {
            $query .= " AND ( {$conditionsQuery} ) ";
        }

        if (count($this->getRemovedIdList())) {
            $query .= " AND ( d._id NOT IN ({$this->getRemoveIdListCSV()}))";
        }

        $query = $db->select_format($query, $this->getOffset(),
            $this->getLimit(), CB_DATABASE_NO_LOCK);

        return $query;
    }
}
