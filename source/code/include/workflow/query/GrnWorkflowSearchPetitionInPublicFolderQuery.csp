<?php
require_once("workflow/query/GrnWorkflowSearchQuery.csp");

class GrnWorkflowSearchPetitionInPublicFolderQuery
    extends GrnWorkflowSearchQuery
{
    /**
     * (non-PHPdoc)
     * @see grn/GrnAbstractQuery::getQuery()
     */
    public function getQuery()
    {
        $conditionsQuery = $this->getConditionQuery();
        $db = $this->getDatabaseConnection();

        $query
            = "SELECT DISTINCT"
              . " p._id petition_id, c._id category_id, f._id form_id "
              . " FROM "
              . " tab_grn_workflow_petition p "
              . " LEFT JOIN tab_grn_workflow_form f ON p.col_form = f._id "
              . " LEFT JOIN tab_grn_workflow_category c ON f.col_category = c._id "
              . " INNER JOIN tab_grn_workflow_itemdata AS d ON d.col_petition = p._id "
              . " LEFT JOIN  tab_cb_user AS pu ON p.col_user = pu._id "
              . "WHERE "
              . ' p.col_status IN (' . GRN_WORKFLOW_STATUS_ACCEPTANCE . ','
              . GRN_WORKFLOW_STATUS_FINISHED . ')';

        if (strlen($conditionsQuery) > 0) {
            $query .= " AND ( {$conditionsQuery} ) ";
        }
        $query = $db->select_format($query, $this->getOffset(),
            $this->getLimit(), CB_DATABASE_NO_LOCK);

        return $query;
    }
}
