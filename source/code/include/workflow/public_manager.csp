<?php
/**
 * Workflow Application Public Manager Class
 *
 * @author  SHIMADA Yosuke 2007/07
 * @version 1.0
 * @package grn.workflow
 */

/** Workflow Application **/
require_once('workflow/resources.csp');
require_once('workflow/public_manager_base.csp');

/**
 * Workflow Category Public Manager Class
 *
 * @package grn.workflow
 */
class GRN_Workflow_Category_Public_Manager
    extends GRN_Workflow_Category_Public_Manager_Base
{
    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {
        //Get Parent Instance
        $parent = parent::getInstance();

        //Sync Parent Table and Public Cache
        $this->_table_list =& $parent->_table_list;
        $this->_public_cache_list =& $parent->_public_cache_list;
    }

    /**
     * Get Instance
     *
     * @return GRN_Workflow_Category_Public_Manager $instance                  //Instance of GRN_Catogory_Public_Manager
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Workflow_Category_Public_Manager();
        }

        return $_instance;
    }

    /**
     * Create Public
     *
     * @param  object $category       //Category Object
     * @param  object $target         //Target Object
     * @param  string $target_type    //Table Type(user/group/static_role/dynamic_role)
     * @param  object $authority_list //Authority List
     *
     * @return int    $Public_id                //Public ID
     */
    function create(&$category, &$target, $target_type, $authority_list)
    {
        //Get Database
        $database = $this->_getDatabase();

        //Get Table Name
        $table_name = $this->_getTableName($target_type);

        //Set Category and Target Object
        $insert_list[GRN_WORKFLOW_COLUMN_OBJECT] = cb_queryf($database, '"@S"',
            $category['_id']);
        if ($target_type == GRN_WORKFLOW_PUBLIC_TARGET_TYPE_DYNAMIC_ROLE) {
            $insert_list[GRN_WORKFLOW_COLUMN_TARGET] = cb_queryf($database,
                '"@S"', $target);
        } else {
            $insert_list[GRN_WORKFLOW_COLUMN_TARGET] = cb_queryf($database,
                '"@S"', $target->getOID());
        }

        //Set Authority List
        foreach ($authority_list as $authority_id => $authority_value) {
            $insert_list['col_authority_' . $authority_id]
                = cb_queryf($database, '"@S"', $authority_value);
        }

        $column_string = implode(', ', array_keys($insert_list));
        $value_string = implode(', ', $insert_list);
        $query = sprintf('INSERT %s(%s) VALUES (%s)', $table_name,
            $column_string, $value_string);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Clear Public Cache
        $this->clearPublicCache();

        //Return Public ID
        $public_id = $database->get_insert_id();

        return $public_id;
    }

    /**
     * Update Public
     *
     * @param  array  $public_id      //Public ID
     * @param  object $target         //Target Object
     * @param  string $target_type    //Table Type(user/group/static_role/dynamic_role)
     * @param  object $authority_list //Authority List
     *
     * @return int    $Public_id                //Public ID
     */
    function update(
        $public_id,
        &$category,
        &$target,
        $target_type,
        $authority_list
    ) {
        //Get Database
        $database =& $this->_getDatabase();

        //Get Table Name
        $table_name = $this->_getTableName($target_type);

        //Set Category and Target Object
        $update_list[GRN_WORKFLOW_COLUMN_OBJECT] = cb_queryf($database,
            sprintf('%s = "@S"', GRN_WORKFLOW_COLUMN_OBJECT), $category['_id']);
        if ($target_type == GRN_WORKFLOW_PUBLIC_TARGET_TYPE_DYNAMIC_ROLE) {
            $update_list[GRN_WORKFLOW_COLUMN_TARGET] = cb_queryf($database,
                sprintf('%s = "@S"', GRN_WORKFLOW_COLUMN_TARGET), $target);
        } else {
            $update_list[GRN_WORKFLOW_COLUMN_TARGET] = cb_queryf($database,
                sprintf('%s = "@S"', GRN_WORKFLOW_COLUMN_TARGET),
                $target->getOID());
        }

        //Set Authority List
        foreach ($authority_list as $authority_id => $authority_value) {
            $authority_column = 'col_authority_' . $authority_id;
            $update_list[$authority_column] = cb_queryf($database, '@S = "@S"',
                $authority_column, $authority_value);
        }

        $update_string = implode(', ', $update_list);
        $where_string = cb_queryf($database, '_id = "@S"', $public_id);
        $query = sprintf('UPDATE %s SET %s WHERE %s', $table_name,
            $update_string, $where_string);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Clear Public Cache
        $this->clearPublicCache();

        //Return Public ID
        $public_id = $database->get_insert_id();

        return $public_id;
    }

    /**
     * Remove Public
     *
     * @param int    $category_id //Category ID
     * @param int    $target_id   //Target ID
     * @param string $target_type //Table Type(user/group/static_role)
     * @param BOOL   $result      //Result
     */
    function remove($category_id, $target_id, $target_type)
    {
        //Get Database
        $database =& $this->_getDatabase();

        //Get Table Name
        $table_name = $this->_getTableName($target_type);

        //Create Query
        $where_list = [
            cb_queryf($database,
                sprintf('%s = "@S"', GRN_WORKFLOW_COLUMN_TARGET), $target_id),
            cb_queryf($database,
                sprintf('%s = "@S"', GRN_WORKFLOW_COLUMN_OBJECT), $category_id),
        ];
        $where_string = implode(' AND ', $where_list);

        $query = sprintf('DELETE FROM %s WHERE %s', $table_name, $where_string);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Delete From Public List
        $this->getList($category_id, $target_type, true);

        return true;
    }

    /**
     * Remove Multiple Public
     *
     * @param array  $public_id_list //Public ID List
     * @param string $target_type    //Table Type(user/group/static_role)
     * @param BOOL   $result         //Result
     */
    function removeMulti($public_id_list, $target_type)
    {
        //Get Database
        $database =& $this->_getDatabase();

        //Get Table Name
        $table_name = $this->_getTableName($target_type);

        //Create Query
        $escape_aids = [];
        foreach ($public_id_list as $aid) {
            $aid = cb_queryf($database, '"@S"', $aid);
            $escape_aids[$aid] = $aid;
        }
        $public_id_string = implode(',', $escape_aids);
        $where_string = sprintf('_id IN(%s)', $public_id_string);
        $query = sprintf('DELETE FROM %s WHERE %s', $table_name,
            $where_string);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Delete From Public List
        $public_id = current($public_id_list);
        foreach (array_keys($this->_public_cache_list) as $key) {
            if (in_array($public_id, $this->_public_cache_list[$key])) {
                foreach ($public_id_list as $public_id) {
                    unset($this->_public_cache_list[$key][$public_id]);
                }
            }
        }

        return true;
    }

    /**
     * Remove All Public
     *
     * @param int  $category_id //Category ID
     * @param BOOL $result      //Result
     */
    function removeAll($category_id = null)
    {
        //Get Database
        $database =& $this->_getDatabase();

        //Create Query
        $where_string = "";
        if ($category_id == -1) {
            $where_string = sprintf('WHERE %s IS NULL',
                GRN_WORKFLOW_COLUMN_OBJECT);
        } elseif ( ! is_null($category_id)) {
            $where_string = cb_queryf($database,
                sprintf('WHERE %s = "@S"', GRN_WORKFLOW_COLUMN_OBJECT),
                $category_id);
        }

        //Delete From All Public Table
        foreach ($this->_target_type_list as $target_type) {
            $query = sprintf('DELETE FROM %s %s',
                $this->_getTableName($target_type), $where_string);

            //Execute Query
            $result = $database->query($query);
            if ($result === false) {
                //Throw Query Error
                $database->throwError(['query' => 'query failed: ' . $query]);
            }

            //Delete From Public List
            unset($this->_public_cache_list[$category_id]);
        }

        return true;
    }

    /**
     * Set Security  Model
     *
     * @param  int    $category_id    //Category ID
     * @param  array  $category       //Category Object
     * @param  string $security_model //Security Model
     *
     * @return bool   $result                    //Result
     */
    function setSecurityModel($category_id, & $category, $security_model)
    {
        //Get Current Security Model
        $current_security_model = $this->getSecurityModel($category);
        if ($current_security_model != $security_model) {
            //Set Security Model
//            $security_model = $current_security_model;
            switch ($security_model) {
                case 'revoke':
                    $security_model = GRN_WORKFLOW_SECURITY_MODEL_TYPE_REVOKE;
                    break;
                case 'grant':
                    $security_model = GRN_WORKFLOW_SECURITY_MODEL_TYPE_GRANT;
                    break;
                default:
                    assert('FALSE');
                    break;
            }

            // Update Security Model
            require_once('workflow/category_logic.csp');
            $category_logic = GRN_Workflow_Category_Logic::getInstance();
            $result
                = $category_logic->changePublicSecurityModel($category_id,
                $security_model);
            if ($result === false) {
                assert('FALSE');
            }

            // Delete All Public
            $result = $this->removeAll($category_id);
            if ($result === false) {
                assert('FALSE');
            }

            //Clear Public Cache
            $this->clearPublicCache();

        }

        return true;
    }
}


