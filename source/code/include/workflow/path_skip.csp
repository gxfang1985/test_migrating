<?php

/**
 * 経路
 *
 * @author  Yuichi UEYAMA 2006/01
 * @version 1.0
 * @package grn.workflow
 */

require_once('workflow/model.csp');

/**
 * 申請経路分岐情報クラス
 */
class GRN_Workflow_PathSkips extends GRN_Workflow_Model
{
    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {
        //Parent Class Constructor
        parent::__construct('tab_grn_workflow_pathskip');

        //Initialize Columns Information
        $this->_columns_info = [
            'necessary' => [
                'col_form',
                'col_item',
            ]
        ];

        //Initialize Table Aliases for Join
        $this->_aliases = [
            'tab_grn_workflow_pathskip'          => 'a',
            'tab_grn_workflow_form'              => 'b',
            'tab_grn_workflow_item'              => 'c',
            'tab_grn_workflow_pathcondition'     => 'd',
            'tab_grn_workflow_pathconditionstep' => 'e',
        ];
    }

    /**
     * Get Instance
     *
     * @return GRN_Workflow_PathSkips $instance                  //Instance of GRN_Workflow_PathSkips
     */
    public static function getInstance()
    {
        static $_instance = null;
        if (is_null($_instance)) {
            $_instance = new GRN_Workflow_PathSkips();
        }

        return $_instance;
    }

    /**
     * Add Path Skip
     *
     * @param   array $properties //Path Skip Properties
     *
     * @return  string  $path_skip_id           //Path Skip ID
     */
    function &add($properties)
    {
        //Check Arguments
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Properties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        //Insert Path Skip
        $ret = $this->_insertRecords(array_keys($properties), [$properties]);

        return $ret;
    }

    /**
     * Modify Path Skip
     *
     * @param   int   $path_skip_id //Path Skip ID
     * @param   array $properties   //Path Skip Properties
     */
    function modify($path_skip_id, $properties)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_skip_id,
            E_GRN_WRKF_PATH_SKIP_INVALID_ID);       //Path Skip ID
        if ( ! is_array($properties) || 0 == count($properties)) {
            //Empty Priperties
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_EMPTY_PROPERTIES);
        }

        //Check Path Skip Exists
        $path_skip = $this->get($path_skip_id);
        if ( ! is_array($path_skip) || 0 == count($path_skip)) {
            //Path Skip Not Found
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_PATH_SKIP_NOT_FOUND);
        }

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "_id='@S'", $path_skip_id);

        //Update Path Skip
        $this->_updateRecords($condition, $properties);
    }

    /**
     * Remove Path Skip
     *
     * @param   int $path_skip_id //Path Skip ID
     */
    function remove($path_skip_id)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_skip_id,
            E_GRN_WRKF_PATH_SKIP_INVALID_ID);       //Path Skip ID

        //Check Path Skip Exists
        $path_skip = $this->get($path_skip_id);
        if ( ! is_array($path_skip) || 0 == count($path_skip)) {
            //Path Skip Not Found
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_PATH_SKIP_NOT_FOUND);
        }

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "_id='@S'", $path_skip_id);

        //Delete Path Skip
        $this->_deleteRecords($condition);
    }

    /**
     * Remove Path Skip By Form ID
     *
     * @param   int $form_id //Form ID
     */
    function removeByFormID($form_id)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($form_id, E_GRN_WRKF_FORM_INVALID_ID);   //Form ID

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "col_form='@S'", $form_id);

        //Delete Path Skip
        $this->_deleteRecords($condition);
    }

    /**
     * Remove Path Skip By Item ID
     *
     * @param   int $item_id //Item ID
     */
    function removeByItemID($item_id)
    {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($item_id, E_GRN_WRKF_ITEM_INVALID_ID);   //Item ID

        //Create Condition
        $condition = cb_queryf($this->_dbconn, "col_item='@S'", $item_id);

        //Delete Path Skip
        $this->_deleteRecords($condition);
    }

    /**
     * Get Path Skip
     *
     * @param   int   $path_skip_id //Path Skip ID
     * @param   array $columns      //Request Columns
     * @param   int   $lock         //Lock Mode
     *
     * @return  mixed   $path_skip               //Path Skip(or FALSE)
     */
    function &get(
        $path_skip_id,
        $columns = null,
        $lock = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_skip_id,
            E_GRN_WRKF_PATH_SKIP_INVALID_ID);       //Path Skip ID

        //Check Request Columns
        if (is_null($columns)) {
            //Set Default Columns
            $columns['tab_grn_workflow_pathskip'] = [
                '_id'      => '_id',
                'col_form' => 'col_form',
                'col_item' => 'col_item',
            ];
        }

        //Format Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from = "tab_grn_workflow_pathskip AS a";

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "a._id='@S'", $path_skip_id);

        //Create Order By String
        $order_by = 'ORDER BY a._id';

        //Create and Send Query
        $query
            = "SELECT {$columns} FROM {$from} WHERE ({$condition}) {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, 1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Query Failed
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Get Path Skip
        $path_skip = $this->_dbconn->fetch_assoc($result);
        if ($path_skip) {
            if (array_key_exists('col_settings', $path_skip)) {
                $path_skip['col_settings']
                    = cb_unserialize($path_skip['col_settings'],
                    ["allowed_classes" => false]);
            }
        }

        //Return Path Skip
        return $path_skip;
    }

    /**
     * Get Path Skip (with Extra Information)
     *
     * @param   int   $path_skip_id //Path Skip ID
     * @param   array $columns      //Request Columns
     * @param   int   $lock         //Lock Mode
     *
     * @return  mixed   $path_skip               //Path Skip(or FALSE)
     */
    function &getEx(
        $path_skip_id,
        $columns = null,
        $lock = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($path_skip_id,
            E_GRN_WRKF_PATH_SKIP_INVALID_ID);       //Path Skip ID

        //Check Request Columns
        if (is_null($columns)) {
            //Set Default Columns
            $columns['tab_grn_workflow_pathskip'] = [
                '_id'      => '_id',
                'col_form' => 'col_form',
                'col_item' => 'col_item',
            ];
        }

        //Format Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from = "tab_grn_workflow_pathskip AS a " .
                "INNER JOIN tab_grn_workflow_form b ON a.col_form = b._id " .
                "INNER JOIN tab_grn_workflow_item c ON a.col_item = c._id ";

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "a._id='@S'", $path_skip_id);

        //Create Order By String
        $order_by = 'ORDER BY a._id';

        //Create and Send Query
        $query
            = "SELECT {$columns} FROM {$from} WHERE ({$condition}) {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, 1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Query Failed
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Get Path Skip
        $path_skip = $this->_dbconn->fetch_assoc($result);
        if ($path_skip) {
            if (array_key_exists('col_settings', $path_skip)) {
                $path_skip['col_settings']
                    = cb_unserialize($path_skip['col_settings'],
                    ["allowed_classes" => false]);
            }
        }

        //Return Path Skip
        return $path_skip;
    }

    /**
     * Get Path Skip by Form ID
     *
     * @param   int   $form_id //Form ID
     * @param   array $columns //Request Columns
     * @param   int   $lock    //Lock Mode
     *
     * @return  mixed   $Path Skip               //Path Skip(or FALSE)
     */
    function getByFormId(
        $form_id,
        $columns = null,
        $lock = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($form_id, E_GRN_WRKF_FORM_INVALID_ID);       //Form ID

        //Create Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from = "tab_grn_workflow_pathskip AS a ";

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "a.col_form='@S'", $form_id);

        //Create and Send Query
        $query = "SELECT {$columns} FROM {$from} WHERE ({$condition})";
        $query = $this->_dbconn->select_format($query, 0, 1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Query Failed
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Get Path Skip
        $path_skip = $this->_dbconn->fetch_assoc($result);

        return $path_skip;
    }

    /**
     * Get Path Skip by Form ID (with Extra Information)
     *
     * @param   int   $form_id //Form ID
     * @param   array $columns //Request Columns
     * @param   int   $lock    //Lock Mode
     *
     * @return  mixed   $Path Skip               //Path Skip(or FALSE)
     */
    function getByFormIdEx(
        $form_id,
        $columns = null,
        $lock = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Arguments
        require_once('workflow/error_code.csp');
        require_once('fw/string_util.csp');
        cb_trim_check($form_id, E_GRN_WRKF_FORM_INVALID_ID);       //Form ID

        //Create Columns String
        $columns = $this->_formatColumns($columns, $this->_aliases);

        //Create From String
        $from = "tab_grn_workflow_pathskip AS a " .
                "INNER JOIN tab_grn_workflow_item c ON a.col_item = c._id " .
                "INNER JOIN tab_grn_workflow_pathcondition d ON a._id = d.col_path_skip "
                .
                "LEFT JOIN tab_grn_workflow_pathconditionstep e ON d._id = e.col_path_condition ";

        //Create Condition String
        $condition = cb_queryf($this->_dbconn, "a.col_form='@S'", $form_id);

        //Create Order By String
        $order_by = 'ORDER BY d.col_list_index, d._id';

        //Create and Send Query
        $query
            = "SELECT {$columns} FROM {$from} WHERE ({$condition}) {$order_by}";
        $query = $this->_dbconn->select_format($query, 0, -1, $lock);
        $result = $this->_dbconn->query($query);
        if (false === $result) {
            //Query Failed
            $this->_dbconn->throwError(['query' => "failed query on SELECT: {$query}"]);
        }

        //Get Path Skip (with Extra Information)
        $path_skip = [];
        while ($row = $this->_dbconn->fetch_assoc($result)) {
            $path_skip[$row['col_path_condition']][$row['col_path_condition_step']]
                = $row;
        }

        return $path_skip;
    }
}


