<?php

namespace grn\space\common\db\dao;

use grn\space\common\db\dao\DataAccessControlAbstract;
use grn\space\common\exception\GrnDatabaseException;


/**
 * Database Back Layer
 * This layer mediates the database front layer and the DB.
 *
 * AccessControlListGroup Data Access Object Class
 * Accept requests from the database front layer for all AccessControlListGroup
 **/
class AccessControlListGroupDAO extends DataAccessControlAbstract
{
    /**
     * The select of a access control list group is executed to the database.
     *
     * @param  string $aclId   access control sequence id
     * @param  string $groupId group id
     *
     * @throws GrnDatabaseException     Any error in the database.
     */
    public function insertAccessControleListGroupByGroupId($aclId, $groupId)
    {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "INSERT INTO tab_grn_space_acl_group (col_acl, col_group) VALUES ";
            $query .= "(";
            $query .= "'" . $dbConn->escape($aclId) . "', ";
            $query .= "'" . $dbConn->escape($groupId) . "' ";
            $query .= ")";
            $query .= ";";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The select of a access control list group is executed to the database.
     *
     * @param  string $aclId access control sequence id
     * @param  array  $member_ids
     *
     * @throws GrnDatabaseException             Any error in the database.
     */
    public function insertAccessControleListGroups($aclId, array $member_ids)
    {
        if (count($member_ids) === 0) {
            return;
        }

        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "INSERT INTO tab_grn_space_acl_group (col_acl, col_group) VALUES ";

            $tempIsNeedComma = false;
            foreach ($member_ids as $member_id) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }

                $query .= "(";
                $query .= "'" . $dbConn->escape($aclId) . "', ";
                $query .= "'" . $dbConn->escape($member_id) . "' ";
                $query .= ")";

                $tempIsNeedComma = true;
            }

            $query .= ";";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The delete of access control list groups is executed to the data base.
     *
     * @param  stirng $aclId access control list sequence id
     * @param  array  $member_ids
     *
     * @throws GrnDatabaseException         Any error in the database.
     */
    public function deleteAccessControleListGroups($aclId, array $member_ids)
    {
        if (count($member_ids) === 0) {
            return;
        }

        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "DELETE FROM tab_grn_space_acl_group WHERE col_acl = '{$dbConn->escape($aclId)}'";
            $query .= " AND col_group IN (";

            $tempIsNeedComma = false;
            foreach ($member_ids as $member_id) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }

                $query .= "'" . $dbConn->escape($member_id) . "' ";

                $tempIsNeedComma = true;
            }

            $query .= ");";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The delete of access control list groups is executed to the data base.
     *
     * @param  stirng $aclId access control list sequence id
     *
     * @throws GrnDatabaseException         Any error in the database.
     */
    public function deleteAccessControleListGroupByAclId($aclId)
    {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "DELETE FROM tab_grn_space_acl_group WHERE col_acl = '{$dbConn->escape($aclId)}';";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * Get group ids according to authority id.
     *
     * @param string $authorityId
     * @param string $spaceId
     *
     * @return array
     * @throws GrnDatabaseException
     */
    public function getGroupIdArrayAccordingToAuthorityId(
        $authorityId,
        $spaceId
    ) {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT g.col_group ";
            $query .= "FROM tab_grn_space_acl_group AS g ";
            $query .= "INNER JOIN ( ";
            $query .= "SELECT sacl.col_acl ";
            $query .= "FROM tab_grn_space_access_control_list AS clist ";
            $query .= "INNER JOIN tab_grn_space_space_acl AS sacl ";
            $query .= "ON clist.col_authority = '"
                      . $dbConn->escape($authorityId) . "' ";
            $query .= "AND  sacl.col_space = '" . $dbConn->escape($spaceId)
                      . "' ";
            $query .= "AND sacl.col_acl = clist._id ";
            $query .= " ) AS tbl ";
            $query .= "ON g.col_acl = tbl.col_acl";
            $result = $dbConn->query($query);
            $userId = [];
            while ($row = $dbConn->fetch_assoc($result)) {
                $userId[] = $row['col_group'];
            }

            return $userId;
        } catch (GrnDatabaseException $e) {
            throw $e;
        }
    }
}


