<?php

namespace grn\space\common\db\dao;

use grn\space\common\data\collection\SpaceMemberCollection;
use grn\space\common\db\dao\DataAccessControlAbstract;
use grn\space\common\exception\GrnDatabaseException;


/**
 * Database Back Layer
 * This layer mediates the database front layer and the DB.
 *
 * AccessControlListUser Data Access Object Class
 * Accept requests from the database front layer for all AccessControlListUser
 */
class AccessControlListUserDAO extends DataAccessControlAbstract
{
    /**
     * The select of a access control list user is executed to the database.
     *
     * @param  string $aclId  access control sequence id
     * @param  string $userId suer id
     *
     * @throws GrnDatabaseException     Any error in the database.
     */
    public function insertAccessControleListUserByUserId($aclId, $userId)
    {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "INSERT INTO tab_grn_space_acl_user (col_acl, col_user) VALUES ";
            $query .= "(";
            $query .= "'" . $dbConn->escape($aclId) . "', ";
            $query .= "'" . $dbConn->escape($userId) . "' ";
            $query .= ")";
            $query .= ";";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The select of a access control list user is executed to the database.
     *
     * @param  string $aclId access control sequence id
     * @param  array  $member_ids
     *
     * @throws GrnDatabaseException             Any error in the database.
     */
    public function insertAccessControleListUsers($aclId, array $member_ids)
    {
        if (count($member_ids) === 0) {
            return;
        }

        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "INSERT INTO tab_grn_space_acl_user (col_acl, col_user) VALUES ";

            $tempIsNeedComma = false;
            foreach ($member_ids as $member_id) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }

                $query .= "(";
                $query .= "'" . $dbConn->escape($aclId) . "', ";
                $query .= "'" . $dbConn->escape($member_id) . "' ";
                $query .= ")";

                $tempIsNeedComma = true;
            }

            $query .= ";";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The delete of access control list users is executed to the data base.
     *
     * @param  string $aclId access control list sequence id
     * @param  array  $member_ids
     *
     * @throws GrnDatabaseException         Any error in the database.
     */
    public function deleteAccessControleListUsers($aclId, array $member_ids)
    {
        if (count($member_ids) === 0) {
            return;
        }

        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "DELETE FROM tab_grn_space_acl_user WHERE col_acl = '{$dbConn->escape($aclId)}'";
            $query .= " AND col_user IN (";

            $tempIsNeedComma = false;
            foreach ($member_ids as $member_id) {
                if ($tempIsNeedComma) {
                    $query .= ", ";
                }

                $query .= "'" . $dbConn->escape($member_id) . "' ";

                $tempIsNeedComma = true;
            }

            $query .= ");";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * The delete of access control list users is executed to the data base.
     *
     * @param  string $aclId access control list sequence id
     *
     * @throws GrnDatabaseException         Any error in the database.
     */
    public function deleteAccessControleListUserByAclId($aclId)
    {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = "DELETE FROM tab_grn_space_acl_user WHERE col_acl = '{$dbConn->escape($aclId)}';";

            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }
    }

    /**
     * Get user ids according to authority id.
     *
     * @param string $authorityId
     * @param string $spaceId
     *
     * @return array
     * @throws GrnDatabaseException
     */
    public function getUserIdArrayAccordingToAuthorityId($authorityId, $spaceId)
    {
        try {
            $dbConn = $this->getDatabaseConnection();
            $query = "SELECT user.col_user ";
            $query .= "FROM tab_grn_space_acl_user AS user ";
            $query .= "INNER JOIN ( ";
            $query .= "SELECT sacl.col_acl ";
            $query .= "FROM tab_grn_space_access_control_list AS clist ";
            $query .= "INNER JOIN tab_grn_space_space_acl AS sacl ";
            $query .= "ON clist.col_authority = '"
                      . $dbConn->escape($authorityId) . "' ";
            $query .= "AND  sacl.col_space = '" . $dbConn->escape($spaceId)
                      . "' ";
            $query .= "AND sacl.col_acl = clist._id ";
            $query .= " ) AS tbl ";
            $query .= "ON user.col_acl = tbl.col_acl";
            $result = $dbConn->query($query);
            $userId = [];
            while ($row = $dbConn->fetch_assoc($result)) {
                $userId[] = $row['col_user'];
            }

            return $userId;
        } catch (GrnDatabaseException $e) {
            throw $e;
        }
    }
}
