<?php

namespace grn\space\db\dao;

use grn\space\common\db\dao\DataAccessControlAbstract;
use grn\space\common\exception\GrnDatabaseException;

/**
 * Database Back Layer
 * This layer mediates the database front layer and the DB.
 *
 * Space Sequence Id Data Access Object Class
 * Accept requests from the database front layer for all SpaceSequenceInfomation
 **/
class SpaceSequenceDAO extends DataAccessControlAbstract
{
    /**
     * The increment of a SpaceSequenceId is executed to the database.
     *
     * @throws GrnDatabaseException         Any error in the database.
     * @return int
     */
    public function getNextSequenceId()
    {
        try {
            $dbConn = $this->getDatabaseConnection();

            $query
                = 'SELECT col_last_id + 1 FROM tab_grn_space_space_sequence FOR UPDATE;';
            $result = $dbConn->query($query);
            $row = $dbConn->fetch_assoc($result);
            $resultSequenceId = $row['col_last_id + 1'];

            $query = "UPDATE tab_grn_space_space_sequence SET ";
            $query .= " col_last_id = " . $resultSequenceId;
            $query .= ";";
            $dbConn->query($query);
        } catch (GrnDatabaseException $e) {
            //将来的にはGrnDatabaseExceptionをキャッチしたい。
            //In the future you want to catch the GrnDatabaseException.
            throw $e;
        }

        return $resultSequenceId;
    }
}
