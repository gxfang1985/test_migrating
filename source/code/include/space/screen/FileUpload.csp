<?php

namespace grn\space\screen;

use grn\space\service\DiscussionService;
use grn\space\common\data\bean\Authority;
use grn\space\common\exception\GrnInvalidArgumentException;
use grn\space\common\exception\GrnInvalidPermissionException;
use grn\space\common\exception\GrnDataNotFoundException;
use grn\space\common\exception\GrnRequiredDataIsNotException;
use grn\space\common\exception\ErrorCode;
use grn\space\common\utility\SpaceFileUtility;
use grn\space\common\data\bean\SpaceFile;

/**
 * Class FileUpload
 *
 */
class FileUpload extends GenericScreenBase
{
    /**
     * Application Type
     *
     * @var $appType
     */
    private $appType;

    /**
     * Application Id
     *
     * @var $appId
     */
    private $appId;

    /**
     * File Info
     *
     * @var $fileInfo
     */
    private $fileInfo;

    /**
     * @param $input
     *
     * @throws GrnDataNotFoundException
     * @throws GrnInvalidArgumentException
     * @throws \Exception
     */
    public function __construct($input)
    {
        parent::__construct($input);

        $checkArr = [
            self::ARG_SPACE_ID,
            self::ARG_FILE_ID,
            self::ARG_THREAD_ID,
            self::ARG_FROM
        ];

        $this->checkArgFromInput($checkArr, $input);

        try {
            //Get File
            $fileObj = $this->getSpaceFile(
                $this->getSpaceId(), $this->getThreadId(), $this->getFileId(),
                $this->getLoginUserId(),
                Authority::AUTHORITY_CODE_WRITE
            );
            $this->fileInfo = SpaceFileUtility::getSpaceFileView($fileObj);
            $this->appType = $fileObj->getParentApplicationType();
            $this->appId = $fileObj->getParentApplicationId();
        } catch (GrnDataNotFoundException $e) {
            $e->setErrorCode(ErrorCode::GRN_INVALID_FILE_ID);
            throw $e;
        }
    }

    /**
     *
     * Return raw HTML which will be used without being escaped.
     *
     * @return    string
     * @throws    GrnInvalidArgumentException
     * @throws    GrnInvalidPermissionException
     * @throws    GrnDataNotFoundException
     */
    public function fetch()
    {
        $input = $this->getInput();

        require_once("grn/smarty.csp");
        $t = new \GRN_Smarty();

        $t->assign('page_title', $this->getTitle());
        $t->assign('space_id', $this->getSpaceId());
        $t->assign('thread_id', $this->getThreadId());
        $t->assign('file_id', $this->getFileId());
        $t->assign('appType', $this->appType);
        $linkparams = [
            'spid' => $this->getSpaceId(),
            'tid'  => $this->getThreadId(),
            'fid'  => $this->getFileId()
        ];
        $t->assign('linkparams', $linkparams);
        if ($this->appType == SpaceFile::PARENT_APPLICATION_TYPE_TODO) {
            $t->assign('todo_id', $this->appId);
        }

        $t->assign('index_return', @$input['index_return']);

        $t->assign('file', $this->fileInfo);
        $t->assign('from', $this->getFrom());

        //Get attachment file
        include('grn/_upload_prepend.csp');

        return $t->fetch("space/file_upload.tpl");
    }

    /**
     *
     * Return a part of the site position of the page in Todo application.
     *
     * @return array
     */
    public function getSitePosition()
    {
        $input = $this->getInput();

        if ($this->appType == SpaceFile::PARENT_APPLICATION_TYPE_THREAD) {
            $sitePosition = [
                [
                    "page"     => "space/application/discussion/index",
                    "name"     => grn_get_page_display_name("space/discussion/index"),
                    "spid"     => $this->getSpaceId(),
                    "fragment" => "tid=" . $this->getThreadId(),
                ]
            ];

            if ( ! array_key_exists('index_return', $input)
                 || $input['index_return'] != true
            ) {
                $sitePosition = array_merge($sitePosition, [
                        [
                            "page" => "space/application/discussion/file_view",
                            "name" => grn_get_page_display_name("space/file/file_detail"),
                            "fid"  => $this->getFileId(),
                            "spid" => $this->getSpaceId(),
                            "tid"  => $this->getThreadId(),
                        ]
                    ]
                );
            }
        } else {
            $sitePosition = [
                [
                    "page" => "space/application/todo/index",
                    "name" => grn_get_page_display_name("space/todo/index"),
                    "spid" => $this->getSpaceId(),
                ],
                [
                    "page" => "space/application/todo/view",
                    "name" => grn_get_page_display_name("space/todo/todo_detail"),
                    "spid" => $this->getSpaceId(),
                    "tdid" => $this->appId,
                    "from" => $this->getFrom(),
                ]
            ];
            if ( ! array_key_exists('index_return', $input)
                 || $input['index_return'] != true
            ) {
                $sitePosition = array_merge($sitePosition, [
                        [
                            "page" => "space/application/todo/file_view",
                            "name" => grn_get_page_display_name("space/file/file_detail"),
                            "fid"  => $this->getFileId(),
                            "spid" => $this->getSpaceId(),
                            "tid"  => $this->getThreadId(),
                            "from" => $this->getFrom(),
                        ]
                    ]
                );
            }
        }
        $sitePosition = array_merge($sitePosition, [
                [
                    "page" => "",
                    "name" => grn_get_page_display_name("space/file/file_upload"),
                ]
            ]
        );

        return $sitePosition;
    }

    /**
     *
     * Return the title of the page
     *
     * @return string
     */
    public function getTitle()
    {
        return grn_get_page_display_name("space/file/file_upload");
    }

    /**
     *
     * Upload File
     *
     * @throws    GrnInvalidArgumentException
     * @throws    GrnInvalidPermissionException
     * @throws    GrnDataNotFoundException
     * @throws    GrnRequiredDataIsNotException
     *
     * @param     $input
     *
     * @return    int
     */
    public function post($input)
    {
        $discussionService = DiscussionService::getInstance();
        //attachment file
        require_once('grn/upload.csp');
        $uploadFileArray
            = \GRN_UploadFile::getUploadedFiles(@$input['upload_ticket'],
            @$input['upload_fileids'], true);
        if (count($uploadFileArray) < 1) {
            throw new GrnRequiredDataIsNotException(ErrorCode::GRN_FILE_IS_NOT_FOUND);
        }
        $uploadFile = current($uploadFileArray);

        $spaceId = $this->getSpaceId();
        $threadId = $this->getThreadId();

        if ($this->appType == SpaceFile::PARENT_APPLICATION_TYPE_THREAD) {
            $todoId = null;
        } else {
            $todoId = $this->appId;
        }
        //update File
        $discussionService->uploadSpaceFile($uploadFile, $this->getLoginUser(),
            @$input['comment'], $this->getFileId(), $spaceId, $threadId,
            $todoId);

        $session = $this->getSession(self::DISCUSSION_SESSION_KEY);
        $session->set(self::ARG_THREAD_ID, $this->getThreadId());

        return $this->appType;
    }
}
