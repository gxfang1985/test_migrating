<?php

namespace grn\space\screen\application\discussion;

use grn\grn\MemberLogic;
use grn\space\service\SpaceService;

/**
 * Class DiscussionIndexAjax
 */
class DiscussionIndexAjax extends DiscussionBase
{
    /**
     * @return mixed|string
     */
    public function fetch()
    {
        $input = $this->getInput();
        $parameter = [self::ARG_SPACE_ID];
        $this->checkArgFromInput($parameter, $input);
        $this->verifySpaceIsNotExpired();
        $space_id = $this->getSpaceId();

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();

        $t->assign('thread_list_component', new ThreadList($input));
        $t->assign('space_id', $space_id);
        $t->assign('mention_params', ['space_id' => $space_id]);

        require_once('fw/plugin.csp');
        $mention_access_plugin_encoded = \CB_PluginLoader::encodeParam(
            [
                'name'   => 'space',
                'params' => [
                    'app_id'   => 'space',
                    'space_id' => $space_id,
                    'target'   => [MemberLogic::TYPE_USER]
                ]
            ]);
        $t->assign('mention_access_plugin_encoded',
            $mention_access_plugin_encoded);

        require_once('star/logic.csp');
        $star_logic = \GRN_Star_StarLogic::getInstance();
        $use_star = $star_logic->isActive();
        $t->assign('use_star', $use_star);

        $t->assign('ajax_load', true);

        return $t->fetch('space/application/discussion/ajax/index.tpl');
    }

    /**
     * @return array
     */
    public function getSitePosition()
    {
        return [['page' => '', 'name' => $this->getTitle()]];
    }

    /**
     * @return string
     */
    public function getTitle()
    {
        return grn_get_page_display_name('space/discussion/index');
    }
}
