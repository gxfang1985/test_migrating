<?php

namespace grn\space\screen\application\todo;

use grn\grn\access\service\AppAccess;

/**
 * Class TodoPortlet
 */
class TodoPortlet extends TodoBase
{
    private $_todo_list;
    private $_portlet;
    private $_title_width;

    /**
     * TodoPortlet constructor.
     *
     * @param $input
     * @param $portlet
     */
    public function __construct($input, $portlet)
    {
        $this->_todo_list = new TodoList($input);
        $this->_portlet = $portlet;
        $this->_init();
    }

    /**
     * @return string
     */
    public function getMyUndertakeTodo()
    {
        $page_tile = $this->_portlet['title'];
        if (is_null($page_tile)) {
            require_once('fw/i18n.csp');
            $page_tile = cb_msg('grn.space', 'todo_undertake');
        }
        $todo_list_for_view = $this->_todo_list->getMyTodo();
        $todo_list_for_view = count($todo_list_for_view) > 20
            ? array_slice($todo_list_for_view, 0, 20, true)
            : $todo_list_for_view;

        $todo_application_status
            = AppAccess::isAppAvailableInternalAccess('todo');

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty;
        require_once('space/GrnSpaceApplication.csp');
        $t->assign('todo_type', \GrnSpaceApplication::PORTLET_TODO_UNDERTAKE);
        $t->assign('page_title', $page_tile);
        $t->assign('todo_list', $todo_list_for_view);
        $t->assign('width', $this->_title_width);
        $t->assign('todo_application_status', $todo_application_status);

        return $t->fetch('space/portlet/view_space_todo_portlet.tpl');
    }

    /**
     * @return string
     */
    public function getMyRelyTodo()
    {
        $page_tile = $this->_portlet['title'];
        if (is_null($page_tile)) {
            require_once('fw/i18n.csp');
            $page_tile = cb_msg('grn.space', 'todo_rely');
        }
        $todo_list_for_view = $this->_todo_list->getMyAssignedTodo();
        $todo_list_for_view = count($todo_list_for_view) > 20
            ? array_slice($todo_list_for_view, 0, 20, true)
            : $todo_list_for_view;

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty;
        require_once('space/GrnSpaceApplication.csp');
        $t->assign('todo_type', \GrnSpaceApplication::PORTLET_TODO_RELY);
        $t->assign('page_title', $page_tile);
        $t->assign('todo_list', $todo_list_for_view);
        $t->assign('width', $this->_title_width);

        return $t->fetch('space/portlet/view_space_todo_portlet.tpl');
    }

    private function _init()
    {
        if ( ! isset($this->_portlet)) {
            require_once('portal/error_code.csp');
            cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
        }
        $user = cb_get_login_user();
        if ( ! $user) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_USER_NOT_FOUND);
        }
        require_once('grn/ui.csp');
        $um = \GRN_UIConfigManager::getInstance();
        $uc = $um->getUserConfig($user);
        $this->_title_width = $uc->getSubjectWidth();
    }
}
