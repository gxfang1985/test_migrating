<?php

namespace grn\space\screen;

use grn\space\common\exception\GrnKintoneException;

use grn\space\common\exception\ErrorCode;
use grn\space\service\SpaceService;
use grn\space\service\KintoneService;

/**
 * Class CommandAppManageAddLink
 *
 */
class CommandAppManageAddLink extends AppManageBase
{
    const ARG_APPLICATION_ID = "kappid";

    /**
     * @param $notUsed
     *
     * @return array
     * @throws GrnKintoneException
     */
    public function post($notUsed)
    {
        $spaceID = $this->getArrayValue(parent::ARG_SPACE_ID,
            $this->getInput());
        $kAppID = $this->getArrayValue(self::ARG_APPLICATION_ID,
            $this->getInput());
        $loginID = $this->getLoginUserId();

        $kintoneService = KintoneService::getInstance();

        //validate $kAppID
        $kintoneService->checkLinkableApp($spaceID, $kAppID, $loginID);

        $application
            = $kintoneService->linkKintoneApplication($this->getSpace(),
            $kAppID, $loginID);

        return [
            'page'   => 'space/application/external/index',
            'params' => [
                'spid'  => $this->getSpace()->getId(),
                'appid' => $application->getId()
            ]
        ];
    }
}
