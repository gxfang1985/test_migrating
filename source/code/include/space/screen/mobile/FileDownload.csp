<?php

namespace grn\space\screen\mobile;

use grn\space\common\data\bean\Authority;
use grn\space\common\exception\ErrorCode;
use grn\space\common\exception\GrnDataNotFoundException;

/**
 * Class FileDownload
 */
class FileDownload extends MobileGenericScreenBase
{
    /**
     * @param $input
     *
     * @throws GrnDataNotFoundException
     * @throws \grn\space\common\exception\GrnInvalidArgumentException
     */
    public function post($input)
    {
        $this->setInput($input);
        $this->checkArgFromInput([
            self::ARG_SPACE_ID,
            self::ARG_THREAD_ID,
            self::ARG_FILE_ID
        ], $input);
        $this->verifySpaceIsNotExpired();
        $spaceId = $this->getSpaceId();
        $discussionId = $this->getThreadId();
        $fileId = $this->getFileId();
        $loginId = $this->getLoginUserId();

        $spaceFile = $this->getSpaceFile($spaceId, $discussionId, $fileId,
            $loginId, Authority::AUTHORITY_CODE_READ_DETAIL);
        $fileObj = $spaceFile->getGrnSpaceFileObject();
        if ( ! $body = $fileObj->getCurrentBody()) {
            throw new GrnDataNotFoundException(ErrorCode::GRN_INVALID_FILE_ID);
        }
        $body->download(true);

        cb_safe_exit();
    }
}
