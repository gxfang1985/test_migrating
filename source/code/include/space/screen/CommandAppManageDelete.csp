<?php

namespace grn\space\screen;

use grn\space\common\exception\ErrorCode;
use grn\space\service\SpaceService;
use grn\space\service\KintoneService;

/**
 * Class CommandAppManageDelete
 *
 */
class CommandAppManageDelete extends AppManageBase
{
    const ARG_APPLICATION_ID = "appid";
    const ARG_DELETE_METHOD = "delete_method";

    /**
     * @param $notUsed
     *
     * @return array
     */
    public function post($notUsed)
    {
        $spaceID = $this->getArrayValue(parent::ARG_SPACE_ID,
            $this->getInput());
        $appID = $this->getArrayValue(self::ARG_APPLICATION_ID,
            $this->getInput());
        $method = $this->getArrayValue(self::ARG_DELETE_METHOD,
            $this->getInput());
        $loginID = $this->getLoginUserId();

        $kintoneService = KintoneService::getInstance();
        $spaceService = SpaceService::getInstance();

        $application = $spaceService->getSpaceApplication($appID, $spaceID,
            $loginID);

        if (strcmp($method, 'unlink') === 0) {
            $kintoneService->unlinkKintoneApplication($this->getSpace(),
                $application);
        } elseif ($application->isExternalApplicationOwner()
                  && strcmp($method, 'remove') === 0
        ) {
            $kintoneService->deleteKintoneApplication($this->getSpace(),
                $application);
        }

        return [
            'page'   => 'space/appmanage_view',
            'params' => ['spid' => $spaceID]
        ];
    }
}
