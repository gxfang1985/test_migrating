<?php
declare(strict_types=1);

namespace grn\space\screen;

abstract class SpaceAddRedirect
{
    const SESSION_NAME = 'G_INPUT_Session';

    abstract protected function getUserIDs(array $input);

    abstract protected function checkArgFromInput(array $input);

    /**
     * @param array $input
     *
     */
    public function post(array $input)
    {
        $this->checkArgFromInput($input);

        $user_ids = $this->getUserIDs($input);

        $this->saveUserIDIntoSession($user_ids);

        return;
    }

    /**
     * @return string
     */
    public function getSessionKeyFromReferer(): string
    {
        $referer = $this->getReferer();

        return $referer . ' _redirect';
    }

    /**
     * @return string
     */
    public function getReferer(): string
    {
        $referer = $_SERVER['HTTP_REFERER'] ?? '';
        if (is_string($referer)) {
            return $referer;
        }

        return '';
    }

    /**
     * @param array $user_ids
     */
    public function saveUserIDIntoSession(array $user_ids)
    {
        require_once('fw/session_manager.csp');
        $sm = \CB_SessionManager::getInstance();
        $session_key = $this->getSessionKeyFromReferer();
        $session = $sm->getSession($session_key);
        $session->set(self::SESSION_NAME,
            $this->makeGInputForSession($user_ids));
    }

    /**
     * @param array $user_ids
     *
     * @return array
     */
    public function makeGInputForSession(array $user_ids): array
    {
        return ["sUID" => $user_ids];
    }

}
