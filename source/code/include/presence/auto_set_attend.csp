<?php

global $G_INPUT;
global $G_config_common;

if ( ! cb_is_init_process()) {
    if ( ! array_key_exists('_notimecard', $G_INPUT)
         || ! $G_INPUT['_notimecard']
    ) {
        // get login user
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login_user = $uum->getLoginUser();

        if ($login_user && is_a($login_user, 'CB_User')) {
            $page_parts = explode('/', strtolower(cb_get_pagename()));
            if (count($page_parts) < 1 || $page_parts[0] == 'index') {
                $page_parts = ['portal', 'index'];
            }

            // code/doc_root/grn 以下は自動打刻しない
            if (strcmp($page_parts[0], 'grn') != 0
                && strcmp($page_parts[0], 'cellular') != 0
            ) {
                $set_presence = true;

                // check setting auto set presence when login
                require_once('presence/config.csp');
                $config_manager = GRN_Presence_ConfigManager::getInstance();
                $system_config = $config_manager->getSystemConfig();
                $auto_change_presence_info
                    = $system_config->getAutoChangePresenceInfo();
                if ( ! $auto_change_presence_info['auto_set_presence']) {
                    $set_presence = false;
                }

                // set presence
                if ($set_presence) {
                    $presence_info = [];
                    $presence_info['status'] = 'attend';
                    $presence_info['memo'] = '';
                    $presence_info['mode'] = 'default';

                    $login_time = new CB_TimeStamp();
                    $login_time->unix_ts = time();

                    require_once('presence/logic.csp');
                    $presence_logic = GRN_Presence_Logic::getInstance();
                    $presence_logic->setPresence($login_user->getOID(),
                        $presence_info, $login_time, false);
                }
                unset($config_manager, $system_config);
            }
            unset($page_parts);
        }
        unset($uum, $login_user);
    }
}



