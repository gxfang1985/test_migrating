<?php

namespace grn\mail;

require_once('mail/resources.csp');

class MailStatuses
{
    private $statuses = [];

    /**
     * @param \CB_DatabaseConnection $db
     */
    public function __construct(\CB_DatabaseConnection $db)
    {
        $this->setStatuses($db);
    }

    private function setStatuses(\CB_DatabaseConnection $db)
    {
        $query
            = "SELECT _id, col_type, col_name, col_code, col_color FROM tab_grn_mail_status;";

        $result = $db->query($query);

        while ($row = $db->fetch_assoc($result)) {
            $this->statuses[$row['_id']] = $row;
        }
        $db->free_result($result);
    }

    private function isValidStatus($statusId)
    {
        if ( ! isset($statusId) && $statusId === '') {
            // No status
            // Note: Sent mail has no status. Draft mail has no status as default.
            return false;
        } elseif ( ! array_key_exists($statusId, $this->statuses)) {
            // Invaliid status
            return false;
        }

        return true;
    }

    /**
     * Return status name to display.
     *
     * @param $statusId
     *
     * @return string
     */
    public function getStatusName($statusId)
    {
        if ( ! $this->isValidStatus($statusId)) {
            return '';
        }

        $status = $this->statuses[$statusId];

        if (strcmp($status['col_type'], GRN_MAIL_STATUS_TYPE_SYSTEM) === 0) {
            // system defined status
            if (strcmp($statusId, GRN_MAIL_STATUS_CODE_DEFAULT) === 0) {
                return '';
            } else {
                return cb_msg(GRN_MAIL_MODULE_ID, $status['col_code']);
            }
        } else {
            // user defined status
            return $status['col_name'];
        }
    }

    /**
     * Return hex color code.
     *
     * @param $statusId
     *
     * @return string
     */
    public function getStatusColor($statusId)
    {
        if ( ! $this->isValidStatus($statusId)) {
            return '';
        }

        return $this->statuses[$statusId]['col_color'];
    }
}
