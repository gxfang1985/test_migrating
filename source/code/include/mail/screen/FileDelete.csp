<?php

namespace grn\mail\screen;

use grn\mail\screen\MailScreenBase;
use grn\mail\dao\GrnMailReceivedFileRelationDAO;
use grn\mail\dao\GrnMailFileInfoDAO;

require_once('mail/error_code.csp');

class FileDelete extends MailScreenBase
{
    public function post($input)
    {
        $this->setInput($input);
        $input = $this->getInput();

        $mail_id = $this->getMailId();
        $user = $this->getLoginUser();
        if ( ! is_object($user)) {
            cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
        }
        $mail_logic = $this->getMailLogic();

        // 添付ファイルの削除
        $mail_data = $mail_logic->getMailData($mail_id, false);
        if ($mail_data['sent']) {
            $mail_logic->deleteAttachedFiles($mail_id);
        } elseif (defined('ON_FOREST')) {
            // 受信メールかつフォレスト環境ではGRN35-1365
            $relationDao = new GrnMailReceivedFileRelationDAO();
            $fileInfoDao = new GrnMailFileInfoDAO();
            $userId = $user->getOID();
            $tableName = 'tab_' . grn_mail_get_personal_tablename($userId,
                    GRN_MAIL_FILEINFO_TABLE);
            $fileIds = $fileInfoDao->getFileIdsByMailId($mail_id,
                $tableName);
            /** @var \CB_BlobFileManager $fm */
            global $G_container_base;
            $fm = $G_container_base->getInstance('file_manager');
            foreach ($fileIds as $fileId) {
                $fm->addToRemoveByBlobId($relationDao->getBlobId($fileId,
                    $userId));
                $relationDao->setDelete($fileId, $userId);
            }
        }

        $mail_logic->deleteSourceFile($mail_id);
    }
}
