<?php

namespace grn\mail\screen\mobile;

use grn\mail\HtmlMailInlineContents;
use grn\mail\HtmlMailProcessor;

class MailHtmlContents extends MobileMailScreenBase
{
    private $_mail_data = null;

    public function __construct($input)
    {
        parent::__construct($input);
        $this->_mail_data = $this->getMailLogic()
                                 ->getMailData($this->getMailId());
    }

    public function fetch()
    {
        require_once('grn/smarty.csp');
        $smarty = new \GRN_Smarty;

        //title
        $smarty->assign('page_title', cb_msg('grn.mobile', 'detail_title'));

        $user_id = cb_get_login_user()->getOID();
        $mail_id = $this->getMailId();

        $this->getUtility()
             ->updateSessionOfHtmlMailShowPicture($user_id, $mail_id, true);
        $show_picture = $this->getSystemConfig()->canUserUseHtmlMailPicture();
        $files = new HtmlMailInlineContents(cb_at($this->_mail_data,
            'files', []), $mail_id);
        $html
            = (new HtmlMailProcessor())->process($this->_mail_data['html_data'],
            $files, $show_picture);
        $smarty->assign('data', $html);

        return $smarty->fetch(cb_get_pagename() . '.tpl');
    }
}
