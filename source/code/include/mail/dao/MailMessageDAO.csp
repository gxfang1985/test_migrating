<?php

namespace grn\mail\dao;


class MailMessageDAO
{

    /**
     * @param \CB_User $user
     * @param array    $mailIds
     *
     * @return array
     */
    public function setUnreadMails(\CB_User $user, array $mailIds)
    {
        $db = cb_get_app_db("mail");
        $table = "tab_" . grn_mail_get_personal_tablename($user->getOID(),
                GRN_MAIL_MESSAGE_TABLE);
        $updateQuery = cb_queryf($db,
            "UPDATE @S SET col_read_ts = '0' WHERE col_user='@S' AND _id IN (@A)",
            $table, $user->getOID(), $mailIds);
        $db->query($updateQuery);

        $selectQuery = cb_queryf($db,
            "SELECT _id AS mid FROM @S WHERE col_user='@S' AND _id IN (@A) AND col_read_ts = '0'",
            $table, $user->getOID(), $mailIds);

        $updatedMailIds = [];
        $result = $db->query($selectQuery);
        while ($row = $db->fetch_assoc($result)) {
            $updatedMailIds[] = $row["mid"];
        }

        return $updatedMailIds;
    }

    /**
     * @param string $mail_id
     * @param string $suffix
     *
     * @return bool
     */
    public function getDecodeTnefFlag($mail_id, $suffix)
    {
        $db = cb_get_app_db("mail");
        $table = "tab_" . grn_mail_get_personal_tablename($suffix,
                GRN_MAIL_MESSAGE_TABLE);
        $ret
            = $db->query($db->format("SELECT col_reserve_int1 FROM {$table} WHERE _id = '@S'",
            [$mail_id]));

        $row = $db->fetch_row($ret);

        if ($row === false) {
            return false;
        }

        return ! ! $row[0];
    }
}
