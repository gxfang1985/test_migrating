<?php

namespace grn\mail\dao;

class GrnMailFileInfoDAO
{
    /**
     * @param string $fileId
     * @param string $suffix
     *
     * @return array
     */
    public function getFileInfoById($fileId, $suffix)
    {
        $db = $this->getDataBaseConnection();
        $query
            = $db->format("SELECT _id, col_user FROM tab_grn_mail_fileinfo___p{$suffix} WHERE _id='@S'",
            [$fileId]);
        $result = $db->query($query);
        $row = $db->fetch_assoc($result);
        $db->free_result($result);

        return ['fileId' => $row['_id'], 'userId' => $row['col_user']];
    }

    /**
     * @param string $mailId
     * @param string $part_no
     * @param string $suffix
     *
     * @return array
     */
    public function getFileInfo($mailId, $part_no, $suffix)
    {
        $db = $this->getDataBaseConnection();
        $query
            = $db->format("SELECT _id, col_user FROM tab_grn_mail_fileinfo___p{$suffix} WHERE col_mail='@S' AND col_part_no='@S'",
            [$mailId, $part_no]);
        $result = $db->query($query);
        $row = $db->fetch_assoc($result);
        $db->free_result($result);
        if ($row) {
            return ['fileId' => $row['_id'], 'userId' => $row['col_user']];
        } else {
            return [];
        }
    }

    /**
     * @param string $mailId
     * @param string $tableName
     *
     * @return array
     */
    public function getFileIdsByMailId($mailId, $tableName)
    {
        $db = $this->getDataBaseConnection();
        $query
            = $db->format("SELECT _id FROM {$tableName} WHERE col_mail='@S'",
            [$mailId]);
        $result = $db->query($query);
        $fileIds = [];
        while ($row = $db->fetch_assoc($result)) {
            $fileIds[] = $row['_id'];
        }

        return $fileIds;
    }

    /**
     * @param string $userId
     * @param string $tableName
     *
     * @return array
     */
    public function getFileIdsByUserId($userId, $tableName)
    {
        $db = $this->getDataBaseConnection();
        $query
            = $db->format("SELECT _id FROM {$tableName} WHERE col_user='@S'",
            [$userId]);
        $result = $db->query($query);
        $fileIds = [];
        while ($row = $db->fetch_assoc($result)) {
            $fileIds[] = $row['_id'];
        }

        return $fileIds;
    }

    /**
     * @return \CB_DatabaseConnection
     */
    private function getDataBaseConnection()
    {
        $app_locator = \GRN_ApplicationLocator::instance();

        return $app_locator->getConnection('mail');
    }
}
