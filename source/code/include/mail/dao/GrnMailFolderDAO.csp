<?php

namespace grn\mail\dao;

require_once("mail/resources.csp");

class GrnMailFolderDAO
{
    /**
     *
     * @param array $parentIds
     *
     * @return array
     */
    public function getSubFolderIds(array $parentIds, $exclude_garbage = false)
    {
        $ids = [];

        $app_locator = \GRN_ApplicationLocator::instance();
        $db = $app_locator->getConnection('mail');
        $query = cb_queryf($db,
            "SELECT _id FROM tab_grn_mail_folder WHERE col_parent IN (@A)",
            $parentIds);
        if ($exclude_garbage === true) {
            $query .= $db->format(" AND ( col_code IS NULL OR col_code NOT IN (@A) ) ",
                [
                    [
                        GRN_MAIL_FOLDER_CODE_UNSENT,
                        GRN_MAIL_FOLDER_CODE_TRASH
                    ]
                ]);
        }

        $result = $db->query($query);
        while ($row = $db->fetch_assoc($result)) {
            $ids[] = $row['_id'];
        }

        return $ids;
    }

    /**
     * @param array $parentIds
     *
     * @return array
     */
    public function getChildFolderIdsRecursively(
        array $parentIds,
        $exclude_gabage = false
    ) {
        $ids = $this->getSubFolderIds($parentIds, $exclude_gabage);
        if (count($ids) > 0) {
            $ids = array_merge($ids,
                $this->getChildFolderIdsRecursively($ids, $exclude_gabage));
        }

        return $ids;
    }
}
