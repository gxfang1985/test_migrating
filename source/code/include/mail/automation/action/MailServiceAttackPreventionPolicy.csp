<?php
/**
 * Describe prevention policy for mail service attack policy.
 */

namespace grn\mail\automation\action;


class MailServiceAttackPreventionPolicy
{
    /** @var \GRN_Mail_SystemConfig */
    private $systemConfiguration;

    /**
     * prohibition against override
     *
     * @private
     *
     * @param \GRN_Mail_SystemConfig $systemConfiguration
     */
    private function __construct(\GRN_Mail_SystemConfig $systemConfiguration)
    {
        $this->systemConfiguration = $systemConfiguration;
    }

    /**
     * Factory method
     *
     * @param \GRN_Mail_SystemConfig $systemConfiguration
     *
     * @return MailServiceAttackPreventionPolicy
     */
    public static function create(\GRN_Mail_SystemConfig $systemConfiguration)
    {
        return new self($systemConfiguration);
    }

    /**
     * @param                   $accountId
     * @param \CB_MailAddress[] $addresseesOfForwardTo
     *
     * @return \CB_MailAddress[]
     */
    public function filterInfiniteLoopAddress(
        $accountId,
        array $addresseesOfForwardTo
    ) {
        $account = $this->systemConfiguration->getAccountData($accountId);
        if (is_null($account) || empty($addresseesOfForwardTo)) {
            return [];
        }

        $filteredAddressees = [];
        $from
            = \CB_MailAddress::static_parse($account['account_info']->email);
        foreach ($addresseesOfForwardTo as $addressee) {
            if ($from->address === $addressee->address) {
                continue;
            }
            $filteredAddressees[] = $addressee;
        }

        return $filteredAddressees;
    }
}
