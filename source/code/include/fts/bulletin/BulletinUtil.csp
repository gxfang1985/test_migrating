<?php

namespace grn\fts\bulletin;

use grn\fts\SearchConstants;
use grn\fts\SearchDocumentInterface;

require_once('grn/application.csp');
require_once('bulletin/article.csp');
require_once('bulletin/follow.csp');

class BulletinUtil
{
    /**
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \GRN_Bulletin_Article
     */
    public function getArticle(SearchDocumentInterface $document)
    {
        $tokens = explode(SearchConstants::DOCUMENT_ID_DELIMITER,
            $document->getId());
        assert('count($tokens) > 2');

        $articleId = substr($tokens[2], 1);
        $factory = \GRN_Bulletin_ArticleFactory::getInstance();

        return $factory->get($articleId);
    }

    /**
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \GRN_Bulletin_Follow
     */
    public function getFollow(SearchDocumentInterface $document)
    {
        $tokens = explode(SearchConstants::DOCUMENT_ID_DELIMITER,
            $document->getId());
        assert('count($tokens) > 3');

        $followId = substr($tokens[3], 1);
        $factory = new \GRN_Bulletin_FollowFactory();

        return $factory->get($followId);
    }

    /**
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \GRN_Bulletin_File
     */
    public function getFile(SearchDocumentInterface $document)
    {
        assert('$document->isFile()');

        $fileId = $document->getFileId();
        $locator = \GRN_ApplicationLocator::instance();
        $tm = $locator->getTableManager('bulletin');
        $table = $tm->getTableInfo('GRN_Bulletin_File');
        $db = $table->getDBConnection();
        $rowset = new \CB_RowSet($table);
        $rowset->addCondition(cb_queryf($db, "_id = '@S'", $fileId));
        $file = $rowset->iterate();
        $rowset->destroy();

        return $file;
    }

    public function getArticleIconUrl()
    {
        return cb_get_app_path() . '/grn/image/cybozu/bulletin16.png';
    }
}
