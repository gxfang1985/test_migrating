<?php

namespace grn\fts\bulletin;

use grn\fts\AccessControllerInterface;
use grn\fts\SearchDocumentInterface;
use grn\fts\SearchConstants;

class AccessController implements AccessControllerInterface
{
    /**
     * Get if a searched document is accessible for a user.
     *
     * @param \grn\fts\SearchDocumentInterface $document
     * @param \CB_User                         $user
     *
     * @return bool
     */
    public function isAccessible(
        SearchDocumentInterface $document,
        \CB_User $user
    ) {
        $util = $this->getSearchUtil();
        $tokens = explode(SearchConstants::DOCUMENT_ID_DELIMITER,
            $document->getId());
        $article = $util->getArticle($document);
        if ( ! $article) {
            return false;
        }
        if ( ! $article->isPublished() || $article->isExpired()) {
            return false;
        }
        if (count($tokens) > 3 && substr($tokens[3], 0, 1) === 'C') {
            $follow = $util->getFollow($document);
            if ( ! $follow) {
                return false;
            }
        }
        if ($document->isFile()) {
            $file = $util->getFile($document);
            if (is_null($file)) {
                return false;
            }
        }

        return $article->access($user, GRN_BULLETIN_ACCESS_R);
    }

    private function getSearchUtil()
    {
        return new BulletinUtil();
    }
}
