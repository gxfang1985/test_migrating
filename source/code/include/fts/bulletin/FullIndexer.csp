<?php

namespace grn\fts\bulletin;

use grn\fts\BulkCommandKeys;
use grn\fts\FullIndexerArgValue;
use grn\fts\FullIndexTarget;
use grn\fts\IndexerLoggerInterface;
use grn\fts\FullIndexer as Indexer;

class FullIndexer
{
    /** @var \grn\fts\FullIndexer */
    private $indexer;
    /** @var \CB_DatabaseConnection */
    private $db;

    /**
     * @param \grn\fts\FullIndexer $indexer
     */
    public function __construct(Indexer $indexer)
    {
        $this->indexer = $indexer;
        $this->db = cb_get_app_db('bulletin');
    }

    /**
     * @param \grn\fts\IndexerLoggerInterface $logger
     * @param \grn\fts\FullIndexerArgValue    $value
     */
    public function execute(
        IndexerLoggerInterface $logger,
        FullIndexerArgValue $value
    ) {
        if ($value->shouldCreateIndexes(BulkCommandKeys::BULLETIN_ARTICLE)) {
            $logger->log("Start indexing of articles.");
            $this->createArticleIndexes();
            $logger->log("Finish indexing of articles.");
            gc_collect_cycles();
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::BULLETIN_FOLLOW)) {
            $logger->log("Start indexing of follows.");
            $this->createFollowIndexes();
            $logger->log("Finish indexing of follows.");
            gc_collect_cycles();
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::BULLETIN_FILE)) {
            $logger->log("Start indexing of files.");
            $this->createFileIndexes();
            $logger->log("Finish indexing of files.");
            gc_collect_cycles();
        }
    }

    private function createArticleIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::BULLETIN_ARTICLE,
            new FullIndexTarget(new ArticleIndexTarget()));
    }

    private function createFollowIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::BULLETIN_FOLLOW,
            new FullIndexTarget(new FollowIndexTarget()));
    }

    private function createFileIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::BULLETIN_FILE,
            new FullIndexTarget(new FileIndexTarget()));
    }
}
