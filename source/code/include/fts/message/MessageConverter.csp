<?php

namespace grn\fts\message;

use grn\fts\DocumentConverterInterface;
use grn\fts\SearchDocumentInterface;
use grn\fts\SearchUtil;
use grn\fts\DocumentView;

class MessageConverter implements DocumentConverterInterface
{

    /**
     * Convert a search result to view data of Garoon.
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \grn\fts\DocumentView
     */
    public function convert(SearchDocumentInterface $document)
    {
        $messageUtil = new MessageUtil();
        $message = $messageUtil->getMessage($document, cb_get_login_user());

        // message must exists.
        assert('$message');

        $snippet = $this->getSnippet($document);
        $title = $message->get('subject');
        $titleIcon = $messageUtil->getMessageIconUrl();
        $url = $this->getUrl($message);
        $modifierView = $this->getModifierView($message);
        $lastMtime = $message->get('last_mtime');
        $modifiedTime = (is_null($lastMtime)) ? $message->get('ctime')->unix_ts
            : $lastMtime->unix_ts;

        $documentView = new DocumentView($snippet, $title, $titleIcon, $url,
            $modifiedTime);
        $documentView->setModifierView($modifierView);

        return $documentView;
    }

    /**
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return string
     */
    private function getSnippet(SearchDocumentInterface $document)
    {
        $util = $this->getSearchUtil();

        return $util->getSnippet($document);
    }

    /**
     * @param \GRN_Message_Messages $message
     *
     * @return string
     */
    private function getUrl(\GRN_Message_Messages $message)
    {
        $mid = $message->getId('original_message');
        if (is_null($mid)) {
            $mid = $message->getOID();
        }
        $params = ['mid' => $mid];

        return cb_format_url("message/view", $params);
    }

    /**
     * @param \GRN_Message_Messages $message
     *
     * @return \grn\fts\ModifierView
     */
    private function getModifierView(\GRN_Message_Messages $message)
    {
        $modifier = ($message->get('modifier')) ?: $message->get('creator');
        $util = $this->getSearchUtil();

        return $util->getModifierView($modifier,
            $message->get('modifier_name') ?: $message->get('creator_name'));
    }

    /**
     * @return \grn\fts\SearchUtil
     */
    private function getSearchUtil()
    {
        return new SearchUtil();
    }
}
