<?php

namespace grn\fts;

class FullIndexTargetHelper
{
    const INITIAL_LAST_ID = 0;
    const INITIAL_START_ID = 1;

    /**
     * @param \CB_DatabaseConnection $db
     * @param string                 $query
     *
     * @return int
     */
    public static function getIndexTargetLastId(
        \CB_DatabaseConnection $db,
        $query
    ) {
        $lastId = self::INITIAL_LAST_ID;
        if ( ! $query) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_MISSING_MANDATORY);
        }
        $db->reconnect();
        $result = $db->query($query);
        if ($row = $db->fetch_assoc($result)) {
            $lastId = (int)$row['id'];
        }
        $db->free_result($result);

        return $lastId;
    }

    /**
     * @param string                 $getTargetQuery
     * @param \CB_DatabaseConnection $db
     * @param int                    $startId
     * @param int                    $limit
     *
     * @return \grn\fts\IndexTargetRange
     */
    public static function getTargetRange(
        $getTargetQuery,
        \CB_DatabaseConnection $db,
        $startId,
        $limit
    ) {
        if ( ! $getTargetQuery || ! $startId || ! $limit) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_MISSING_MANDATORY);
        }
        $db->reconnect();
        $result = $db->query($db->format($getTargetQuery, [$startId, $limit]));
        $ids = [];
        if ($result) {
            while ($row = $db->fetch_assoc($result)) {
                $ids[] = $row['id'];
            }
        }
        $indexTarget = new IndexTargetRange();
        $indexTarget->setStartId((count($ids) > 0) ? (int)array_shift($ids)
            : (int)$startId);
        $indexTarget->setEndId((count($ids) > 0) ? (int)array_pop($ids)
            : $indexTarget->getStartId());

        return $indexTarget;
    }
}
