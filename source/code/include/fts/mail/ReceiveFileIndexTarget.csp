<?php

namespace grn\fts\mail;


use grn\fts\FullIndexTargetHelper;
use grn\fts\FullIndexTargetRangeDAOInterface;

class ReceiveFileIndexTarget implements FullIndexTargetRangeDAOInterface
{
    /** @var \CB_DatabaseConnection */
    private $db;
    /** @var int */
    private $userTableNum;

    public function __construct($userTableNum)
    {
        $this->db = cb_get_app_db('mail');
        $this->userTableNum = $userTableNum;
    }

    /**
     * @param int $startId
     * @param int $limit
     *
     * @return \grn\fts\IndexTargetRange
     */
    public function getTargetRange($startId, $limit)
    {
        if (defined('ON_FOREST')) {
            $getTargetQuery
                = "SELECT i._id AS id " .
                  "FROM tab_grn_mail_fileinfo___p{$this->db->escape($this->userTableNum)} AS i, "
                  .
                  "tab_grn_mail_message___p{$this->db->escape($this->userTableNum)} AS m, "
                  .
                  "tab_grn_mail_folder AS f, " .
                  "tab_grn_mail_sourcefilebody___p{$this->db->escape($this->userTableNum)} AS s, "
                  .
                  "tab_grn_mail_receivedfilerelation AS r " .
                  "WHERE i._id >= '@S' " .
                  "AND i.col_mail=m._id " .
                  "AND m.col_folder=f._id " .
                  "AND m._id=s.col_mail " .
                  "AND r.col_file=i._id " .
                  "AND r.col_user=m.col_user " .
                  "AND r.col_blob IS NOT NULL " .
                  "AND m.col_dtime IS NULL " .
                  "ORDER BY i._id LIMIT @S";
        } else {
            $getTargetQuery
                = "SELECT m._id AS id " .
                  "FROM tab_grn_mail_fileinfo___p{$this->db->escape($this->userTableNum)} AS f, "
                  .
                  "tab_grn_mail_message___p{$this->db->escape($this->userTableNum)} AS m, "
                  .
                  "tab_grn_mail_sourcefilebody___p{$this->db->escape($this->userTableNum)} AS s "
                  .
                  "WHERE m._id >= '@S' " .
                  "AND f.col_mail=m._id " .
                  "AND m._id=s.col_mail " .
                  "AND m.col_dtime IS NULL " .
                  "GROUP BY m._id ORDER BY m._id LIMIT @S";
        }

        return FullIndexTargetHelper::getTargetRange($getTargetQuery, $this->db,
            $startId, $limit);
    }

    /**
     * @return int
     */
    public function getLastId()
    {
        if (defined('ON_FOREST')) {
            $query
                = "SELECT i._id AS id " .
                  "FROM tab_grn_mail_fileinfo___p{$this->db->escape($this->userTableNum)} AS i, "
                  .
                  "tab_grn_mail_message___p{$this->db->escape($this->userTableNum)} AS m, "
                  .
                  "tab_grn_mail_folder AS f, " .
                  "tab_grn_mail_sourcefilebody___p{$this->db->escape($this->userTableNum)} AS s, "
                  .
                  "tab_grn_mail_receivedfilerelation AS r " .
                  "WHERE i.col_mail=m._id " .
                  "AND m.col_folder=f._id " .
                  "AND m._id=s.col_mail " .
                  "AND r.col_file=i._id " .
                  "AND r.col_user=m.col_user " .
                  "AND r.col_blob IS NOT NULL " .
                  "AND m.col_dtime IS NULL " .
                  "ORDER BY i._id DESC LIMIT 1";
        } else {
            $query
                = "SELECT m._id AS id " .
                  "FROM tab_grn_mail_fileinfo___p{$this->db->escape($this->userTableNum)} AS f, "
                  .
                  "tab_grn_mail_message___p{$this->db->escape($this->userTableNum)} AS m, "
                  .
                  "tab_grn_mail_sourcefilebody___p{$this->db->escape($this->userTableNum)} AS s "
                  .
                  "WHERE f.col_mail=m._id " .
                  "AND m._id=s.col_mail " .
                  "AND m.col_dtime IS NULL " .
                  "ORDER BY m._id DESC LIMIT 1";
        }

        return FullIndexTargetHelper::getIndexTargetLastId($this->db, $query);
    }
}
