<?php

namespace grn\fts\mail;

use grn\fts\BulkIndexerChildProcessInterface;
use grn\fts\ChildProcessArgValue;
use grn\fts\FtsProduct;

class BulkSendFileIndexer implements BulkIndexerChildProcessInterface
{
    /** @var \grn\fts\ChildProcessArgValue */
    private $value;

    /**
     * @param array $input
     */
    public function __construct(array $input)
    {
        $this->value = new ChildProcessArgValue();
        $this->value->parseInput($input);
    }

    /**
     * @return string[]
     */
    public function getConnectAppIds()
    {
        return ["mail"];
    }

    /**
     */
    public function execute()
    {
        $service = new IndexService($this->value->getSearchEngine());
        $db = cb_get_app_db('mail');
        $query
            = "SELECT b._id, " .
              "b.col_blob, " .
              "b.col_name, " .
              "b.col_mail, " .
              "m.col_user, " .
              "m.col_from, " .
              "m.col_to, " .
              "m.col_cc, " .
              "m.col_bcc, " .
              "m.col_send_ts, " .
              "m.col_folder, " .
              "f.col_account " .
              "FROM tab_grn_mail_filebody___p{$db->escape($this->value->getUserTableNum())} AS b, "
              .
              "tab_grn_mail_message___p{$db->escape($this->value->getUserTableNum())} AS m, "
              .
              "tab_grn_mail_sourcefilebody___p{$db->escape($this->value->getUserTableNum())} AS s, "
              .
              "tab_grn_mail_folder AS f " .
              "WHERE b._id>='{$db->escape($this->value->getStartId())}' " .
              "AND '{$db->escape($this->value->getEndId())}'>=b._id " .
              "AND b.col_mail=m._id " .
              "AND s.col_mail=m._id " .
              "AND m.col_folder=f._id " .
              "AND m.col_dtime IS NULL " .
              "FOR UPDATE";

        $result = $db->query($query);
        $rows = [];
        while ($row = $db->fetch_assoc($result)) {
            $rows[] = $row;
        }
        $db->free_result($result);
        if (defined('ON_FOREST')) {
            $service->bulkCreateFileIndex($rows, $this->value->getForward(),
                'mail.sendFile');
        } else {
            $service->bulkCreateSendFileIndex($rows,
                "grn_mail_filebody___p{$this->value->getUserTableNum()}",
                $this->value->getForward());
        }
        $rowsCount = count($rows);
        echo "{$rowsCount} send files indexed.";
        gc_collect_cycles();
    }
}
