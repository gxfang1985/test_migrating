<?php

namespace grn\fts\space;

use grn\fts\BulkCommandKeys;
use grn\fts\FullIndexerArgValue;
use grn\fts\FullIndexTarget;
use grn\fts\IndexerLoggerInterface;
use grn\fts\FullIndexer as Indexer;

class FullIndexer
{
    /** @var \grn\fts\FullIndexer */
    private $indexer;
    /** @var \CB_DatabaseConnection */
    private $db;

    /**
     * @param \grn\fts\FullIndexer $indexer
     */
    public function __construct(Indexer $indexer)
    {
        $this->indexer = $indexer;
        $this->db = cb_get_app_db('space');
    }

    /**
     * @param \grn\fts\IndexerLoggerInterface $logger
     * @param \grn\fts\FullIndexerArgValue    $value
     */
    public function execute(
        IndexerLoggerInterface $logger,
        FullIndexerArgValue $value
    ) {
        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_SPACE)) {
            $logger->log("Start indexing of spaces.");
            $this->createSpaceIndexes();
            $logger->log("Finish indexing of spaces.");
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_DISCUSSION)) {
            $logger->log("Start indexing of discussions.");
            $this->createDiscussionIndexes();
            $logger->log("Finish indexing of discussions.");
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_TODO)) {
            $logger->log("Start indexing of todo.");
            $this->createTodoIndexes();
            $logger->log("Finish indexing of todo.");
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_DISCUSSION_COMMENT)) {
            $logger->log("Start indexing of discussion comments.");
            $this->createDiscussionCommentIndexes();
            $logger->log("Finish indexing of discussion comments.");
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_TODO_COMMENT)) {
            $logger->log("Start indexing of todo comments.");
            $this->createTodoCommentIndexes();
            $logger->log("Finish indexing of todo comments.");
        }

        if ($value->shouldCreateIndexes(BulkCommandKeys::SPACE_FILE)) {
            $logger->log("Start indexing of files.");
            $this->createFileIndexes($logger);
            $logger->log("Finish indexing of files.");
        }
    }

    private function createSpaceIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::SPACE_SPACE,
            new FullIndexTarget(new SpaceIndexTarget()));
    }

    private function createDiscussionIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::SPACE_DISCUSSION,
            new FullIndexTarget(new DiscussionIndexTarget()));
    }

    private function createTodoIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::SPACE_TODO,
            new FullIndexTarget(new TodoIndexTarget()));
    }

    private function createDiscussionCommentIndexes()
    {
        $this->indexer->getHandler()
                      ->handle(BulkCommandKeys::SPACE_DISCUSSION_COMMENT,
                          new FullIndexTarget(new DiscussionCommentIndexTarget()));
    }

    private function createTodoCommentIndexes()
    {
        $this->indexer->getHandler()
                      ->handle(BulkCommandKeys::SPACE_TODO_COMMENT,
                          new FullIndexTarget(new TodoCommentIndexTarget()));
    }

    private function createFileIndexes()
    {
        $this->indexer->getHandler()->handle(BulkCommandKeys::SPACE_FILE,
            new FullIndexTarget(new FileIndexTarget()));
    }
}
