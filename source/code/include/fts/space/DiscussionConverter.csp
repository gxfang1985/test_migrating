<?php

namespace grn\fts\space;

use grn\fts\DocumentConverterInterface;
use grn\fts\DocumentView;
use grn\fts\SearchDocumentInterface;
use grn\fts\SearchUtil;
use grn\fts\SearchConstants;
use grn\space\data\bean\Thread;

class DiscussionConverter implements DocumentConverterInterface
{
    /**
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \grn\fts\DocumentView
     */
    public function convert(SearchDocumentInterface $document)
    {
        $spaceUtil = new SpaceUtil();
        $space = $spaceUtil->getSpace($document);
        $thread = $spaceUtil->getThread($document);

        $snippet = $this->getSnippet($document);
        $title = $thread->getTitle();
        $titleIcon = $spaceUtil->getDiscussionIconUrl();
        $url = $this->getUrl($document);
        $modifierView = $this->getModifierView($thread);
        $modifiedTime = $thread->getModifyTimestamp();
        $spaceView = $spaceUtil->getSpaceView($space);

        $documentView = new DocumentView($snippet, $title, $titleIcon, $url,
            $modifiedTime);
        $documentView->setModifierView($modifierView);
        $documentView->setSpaceView($spaceView);

        return $documentView;
    }

    /**
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return string
     */
    private function getSnippet(SearchDocumentInterface $document)
    {
        $searchUtil = new SearchUtil();

        return $searchUtil->getSnippet($document);
    }

    /**
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return string
     */
    private function getUrl(SearchDocumentInterface $document)
    {
        $tokens = explode(SearchConstants::DOCUMENT_ID_DELIMITER,
            $document->getId());
        $spaceId = substr($tokens[2], 1);
        $threadId = substr($tokens[3], 1);
        $params = ['spid' => $spaceId];
        $fragment = "tid={$threadId}";

        return cb_format_url("space/application/discussion/index", $params,
            $fragment);
    }

    /**
     * @param \grn\space\data\bean\Thread $thread
     *
     * @return \grn\fts\ModifierView
     */
    private function getModifierView(Thread $thread)
    {
        $searchUtil = new SearchUtil();
        $spaceUser = $thread->getModifier();
        $modifier = $this->getUser($spaceUser->getMemberID());

        return $searchUtil->getModifierView($modifier,
            $thread->getModifierDisplayName());
    }

    /**
     * @param string $userId
     *
     * @return \CB_User
     */
    protected function getUser($userId)
    {
        global $G_container_base;
        /** @var \GRN_Uum $uum */
        $uum = $G_container_base->getInstance('uum');

        return $uum->getUser($userId);
    }
}

