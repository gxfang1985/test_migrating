<?php

namespace grn\fts\space;


use grn\fts\FullIndexTargetHelper;
use grn\fts\FullIndexTargetRangeDAOInterface;

class TodoCommentIndexTarget implements FullIndexTargetRangeDAOInterface
{
    /** @var \CB_DatabaseConnection */
    private $db;

    public function __construct()
    {
        $this->db = cb_get_app_db('space');
    }

    /**
     * @param int $startId
     * @param int $limit
     *
     * @return \grn\fts\IndexTargetRange
     */
    public function getTargetRange($startId, $limit)
    {
        $getTargetQuery
            = "SELECT comment._id AS id " .
              "FROM tab_grn_space_todo_comment AS tc, " .
              "tab_grn_space_comment AS comment, " .
              "tab_grn_space_todo AS todo, " .
              "tab_grn_space_todo_thread AS threadtodo, " .
              "tab_grn_space_thread as thread, " .
              "tab_grn_space_category_hierarchy as h, " .
              "tab_grn_space_category as c, " .
              "tab_grn_space_space_application as a " .
              "WHERE comment._id >= '@S' " .
              "AND tc.col_comment=comment._id " .
              "AND tc.col_todo=todo._id " .
              "AND todo._id=threadtodo.col_todo " .
              "AND threadtodo.col_thread=thread._id " .
              "AND thread.col_category=h.col_category " .
              "AND h.col_ancestor=c._id " .
              "AND c.col_hierarchy_level = 1 " .
              "AND c._id=a.col_root_category " .
              "ORDER BY comment._id LIMIT @S";

        return FullIndexTargetHelper::getTargetRange($getTargetQuery, $this->db,
            $startId, $limit);
    }

    /**
     * @return int
     */
    public function getLastId()
    {
        $query
            = "SELECT comment._id AS id " .
              "FROM tab_grn_space_todo_comment AS tc, " .
              "tab_grn_space_comment AS comment, " .
              "tab_grn_space_todo AS todo, " .
              "tab_grn_space_todo_thread AS threadtodo, " .
              "tab_grn_space_thread as thread, " .
              "tab_grn_space_category_hierarchy as h, " .
              "tab_grn_space_category as c, " .
              "tab_grn_space_space_application as a " .
              "WHERE tc.col_comment=comment._id " .
              "AND tc.col_todo=todo._id " .
              "AND todo._id=threadtodo.col_todo " .
              "AND threadtodo.col_thread=thread._id " .
              "AND thread.col_category=h.col_category " .
              "AND h.col_ancestor=c._id " .
              "AND c.col_hierarchy_level = 1 " .
              "AND c._id=a.col_root_category " .
              "ORDER BY comment._id DESC LIMIT 1";

        return FullIndexTargetHelper::getIndexTargetLastId($this->db, $query);
    }
}
