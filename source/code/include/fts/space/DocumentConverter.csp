<?php

namespace grn\fts\space;

use grn\fts\DocumentConverterInterface;
use grn\fts\SearchDocumentInterface;
use grn\fts\SearchConstants;

class DocumentConverter implements DocumentConverterInterface
{
    /**
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \grn\fts\DocumentView
     */
    public function convert(SearchDocumentInterface $document)
    {
        $converter = $this->getConverter($document);

        return $converter->convert($document);
    }

    /**
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \grn\fts\DocumentConverterInterface
     */
    private function getConverter(SearchDocumentInterface $document)
    {
        $tokens = explode(SearchConstants::DOCUMENT_ID_DELIMITER,
            $document->getId());
        $tokenCount = count($tokens);
        switch ($tokenCount) {
            case 3:
                return new SpaceConverter();
            case 4:
                return new DiscussionConverter();
            case 5:
                if (substr($tokens[4], 0, 1) === 'C') {
                    return new CommentConverter();
                } elseif (substr($tokens[4], 0, 1) === 'T') {
                    return new TodoConverter();
                } else {
                    return new FileConverter();
                }
            case 6:
                if (substr($tokens[5], 0, 1) === 'C') {
                    return new CommentConverter();
                } else {
                    return new FileConverter();
                }
            case 7:
                return new FileConverter();
            default:
                assert('FALSE');
        }
    }
}
