<?php

namespace grn\fts\cabinet;

use grn\fts\AccessControllerInterface;
use grn\fts\SearchDocumentInterface;

class AccessController implements AccessControllerInterface
{

    /**
     * Get if a searched document is accessible for a user.
     *
     * @param \grn\fts\SearchDocumentInterface $document
     * @param \CB_User                         $user
     *
     * @return bool
     */
    public function isAccessible(
        SearchDocumentInterface $document,
        \CB_User $user
    ) {
        require_once('cabinet/access.csp');
        $accessManager = new \GRN_Cabinet_AccessManager();

        $util = $this->getSearchUtil();
        $folder = $util->getFolder($document);
        if (is_null($folder)) {
            return false;
        }
        $file = $util->getFile($document);
        if (is_null($file) || $file->isInTrash()) {
            return false;
        }

        return $accessManager->access($user, $folder, GRN_CABINET_ACCESS_R);
    }

    /**
     * @return CabinetUtil
     */
    private function getSearchUtil()
    {
        return new CabinetUtil();
    }
}
