<?php

namespace grn\fts\cabinet;

use grn\fts\DocumentConverterInterface;
use grn\fts\DocumentView;
use grn\fts\SearchDocumentInterface;
use grn\fts\SearchUtil;
use grn\fts\FileView;
use grn\fts\FileIcon;

class FileConverter implements DocumentConverterInterface
{

    /**
     * Convert a search result to view data of Garoon.
     *
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return \grn\fts\DocumentView
     */
    public function convert(SearchDocumentInterface $document)
    {
        $util = new CabinetUtil();
        $file = $util->getFile($document);
        $folder = $util->getFolder($document);

        $snippet = $this->getSnippet($document);
        $title = $folder->_folder->get('name');
        $titleIcon = $util->getCabinetIconUrl();
        $url = $this->getUrl($file->getOID(),
            $folder->_folder->getOID());
        $modifierView = $this->getModifierView($file);
        $modifiedTime = $file->get('mtime')->unix_ts;
        $fileView = $this->getFileView($file);

        $highlights = $document->getFileNameHighlights();
        if ( ! is_null($highlights)) {
            $fileView->setSnippetTitle($highlights[0]);
        }
        if ( ! strlen($title) > 0) {
            $title = $fileView->getTitle();
        }

        $documentView = new DocumentView($snippet, $title, $titleIcon, $url,
            $modifiedTime);
        $documentView->setModifierView($modifierView);
        $documentView->setFileView($fileView);

        return $documentView;
    }

    /**
     * @param \grn\fts\SearchDocumentInterface $document
     *
     * @return string
     */
    private function getSnippet(SearchDocumentInterface $document)
    {
        $util = $this->getSearchUtil();

        return $util->getSnippet($document);
    }

    /**
     * @return \grn\fts\SearchUtil
     */
    private function getSearchUtil()
    {
        return new SearchUtil();
    }

    /**
     * @param string $fileId
     * @param string $folderId
     *
     * @return string
     */
    private function getUrl($fileId, $folderId)
    {
        $params = [
            'hid' => $folderId,
            'fid' => $fileId
        ];

        return cb_format_url("cabinet/view", $params);
    }

    /**
     * @param \GRN_Cabinet_File $file
     *
     * @return \grn\fts\ModifierView
     */
    private function getModifierView(\GRN_Cabinet_File $file)
    {
        $modifier = $file->get('modifier');
        $util = $this->getSearchUtil();

        return $util->getModifierView($modifier, $file->get('modifier_name'));
    }

    /**
     * @param \GRN_Cabinet_File $file
     *
     * @return \grn\fts\FileView
     */
    private function getFileView(\GRN_Cabinet_File $file)
    {
        /** @var \GRN_Cabinet_FileBody $fileBody */
        $fileBody = $file->getCurrentBody();
        $downloadUrl = $this->getDownloadUrl($file, $fileBody);

        return new FileView($fileBody->get('name'),
            FileIcon::getIconUrl($fileBody), $downloadUrl,
            $fileBody->get('size'));
    }

    /**
     * @param \GRN_Cabinet_File     $file
     * @param \GRN_Cabinet_FileBody $fileBody
     *
     * @return string
     */
    private function getDownloadUrl(
        \GRN_Cabinet_File $file,
        \GRN_Cabinet_FileBody $fileBody
    ) {
        return cb_format_url('cabinet/download',
            ['fid' => $file->getOID()], null, $fileBody->get('name'));
    }
}
