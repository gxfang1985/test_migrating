<?php

namespace grn\fts\screen;

use grn\fts\Application;
use grn\fts\filter\LanguageFilter;
use grn\fts\SearchQueryInterface;
use grn\fts\SortOrder;

require_once('grn/smarty.csp');

class Search
{
    const TEMPLATE_PATH = 'fts/search.tpl';

    /** @var string */
    private $text = '';
    /** @var \grn\fts\SortOrder */
    private $sortOrder;
    /** @var bool */
    private $fileOnly = false;
    /** @var string */
    private $fileType = '';
    /** @var string */
    private $modifier = '';
    /** @var string */
    private $dateLower = SearchQueryInterface::DATE_NOT_SPECIFIED;
    /** @var string */
    private $dateUpper = SearchQueryInterface::DATE_NOT_SPECIFIED;
    /** @var string[] */
    private $searchApplications = [];
    /** @var string */
    private $language = LanguageFilter::ALL;

    public function __construct(array $input)
    {
        $this->sortOrder = new SortOrder;
        $this->parseInput($input);
    }

    public function fetch()
    {
        $availableApplications
            = Application::getAvailableSearcheableApplications();
        if (count($availableApplications) === 0) {
            cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
        }

        $smarty = new \GRN_Smarty();
        $smarty->assign('text', $this->getText());
        $smarty->assign('sortByDatetime',
            $this->getSortOrder() === SortOrder::DATETIME);
        $smarty->assign('fileOnly', $this->getFileOnly());
        $smarty->assign('fileType', $this->getFileType());
        $smarty->assign('modifier', $this->getModifier());
        $smarty->assign('availableApplications', $availableApplications);
        $smarty->assign('searchApplications', $this->getSearchApplications());
        $smarty->assign('language', $this->getLanguage());
        $smarty->assign('is_elasticsearch',
            Application::getFtsEngine()->isElasticsearch());

        $dateLower = $this->getDateLower();
        if ($dateLower !== SearchQueryInterface::DATE_NOT_SPECIFIED) {
            $smarty->assign('dateLower', $dateLower);
        }
        $dateUpper = $this->getDateUpper();
        if ($dateUpper !== SearchQueryInterface::DATE_NOT_SPECIFIED) {
            $smarty->assign('dateUpper', $dateUpper);
        }

        $smarty->assign('page_title', grn_get_current_page_display_name());

        $smarty->assign('runBackgroundSearch',
            Application::isBackgroundSearchModeEnabled());

        return $smarty->fetch(self::TEMPLATE_PATH);
    }

    private function parseInput(array $input)
    {
        if (isset($input['text'])) {
            $this->setText($input['text']);
        }
        if (isset($input['sortOrder'])) {
            $this->setSortOrder($input['sortOrder']);
        }
        if (isset($input['fileOnly']) && $input['fileOnly']) {
            $this->setFileOnly(true);
        }
        if (isset($input['fileType'])) {
            $this->setFileType($input['fileType']);
        }
        if (isset($input['mail']) && $input['mail']) {
            $this->addSearchApplication('mail');
        }
        if (isset($input['cabinet']) && $input['cabinet']) {
            $this->addSearchApplication('cabinet');
        }
        if (isset($input['bulletin']) && $input['bulletin']) {
            $this->addSearchApplication('bulletin');
        }
        if (isset($input['message']) && $input['message']) {
            $this->addSearchApplication('message');
        }
        if (isset($input['space']) && $input['space']) {
            $this->addSearchApplication('space');
        }
        if (isset($input['modifier'])) {
            $this->setModifier($input['modifier']);
        }
        if (isset($input['dateLower'])) {
            $this->setDateLower($input['dateLower']);
        }
        if (isset($input['dateUpper'])) {
            $this->setDateUpper($input['dateUpper']);
        }
        if (isset($input['language'])) {
            $this->setLanguage($input['language']);
        }
    }

    /**
     * @param string $text
     */
    public function setText($text)
    {
        $this->text = $text;
    }

    /**
     * @return string
     */
    public function getText()
    {
        return $this->text;
    }

    /**
     * @param string $dateLower
     */
    public function setDateLower($dateLower)
    {
        $this->dateLower = $dateLower;
    }

    /**
     * @return string
     */
    public function getDateLower()
    {
        return $this->dateLower;
    }

    /**
     * @param string $dateUpper
     */
    public function setDateUpper($dateUpper)
    {
        $this->dateUpper = $dateUpper;
    }

    /**
     * @return string
     */
    public function getDateUpper()
    {
        return $this->dateUpper;
    }

    /**
     * @param boolean $fileOnly
     */
    public function setFileOnly($fileOnly)
    {
        $this->fileOnly = $fileOnly;
    }

    /**
     * @return boolean
     */
    public function getFileOnly()
    {
        return $this->fileOnly;
    }

    /**
     * @param string $fileType
     */
    public function setFileType($fileType)
    {
        $this->fileType = $fileType;
    }

    /**
     * @return string
     */
    public function getFileType()
    {
        return $this->fileType;
    }

    /**
     * @param string $modifier
     */
    public function setModifier($modifier)
    {
        $this->modifier = $modifier;
    }

    /**
     * @return string
     */
    public function getModifier()
    {
        return $this->modifier;
    }

    /**
     * @param string $sortOrder
     */
    public function setSortOrder($sortOrder)
    {
        $this->sortOrder->setSortType($sortOrder);
    }

    /**
     * @return string
     */
    public function getSortOrder()
    {
        return $this->sortOrder->getSortType();
    }

    /**
     * @param string $application
     */
    public function addSearchApplication($application)
    {
        $this->searchApplications[$application] = true;
    }

    /**
     * @return string[]
     */
    public function getSearchApplications()
    {
        return $this->searchApplications;
    }

    /**
     * @param string $language
     */
    public function setLanguage($language)
    {
        $this->language = $language;
    }

    /**
     * @return string
     */
    public function getLanguage()
    {
        return $this->language;
    }
}
