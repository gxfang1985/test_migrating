<?php

namespace grn\fts;


class ChildProcessRunner
{
    /** @var BulkIndexerChildProcessInterface[] */
    private $commanders = [];

    const LOCK_WAIT_TIMEOUT = 3600; // 1 hours

    /**
     * @param string $command
     */
    public function run($command)
    {
        if ( ! isset($this->commanders[$command])) {
            echo "Command not found. Failed!!";
            exit(1);
        }
        $commander = $this->commanders[$command];

        $this->modifyLockWaitTimeout($commander->getConnectAppIds());

        $commander->execute();
    }

    /**
     * Modify innodb_lock_wait_timeout to prevent the indexing is skipped
     * during indexing targets has locked by another background process.
     * see: GRB-16670
     *
     * @param string[] $connectAppIds
     */
    private function modifyLockWaitTimeOut(array $connectAppIds)
    {
        foreach ($connectAppIds as $appId) {
            cb_get_app_db($appId)->query("SET SESSION innodb_lock_wait_timeout = "
                                         . self::LOCK_WAIT_TIMEOUT);
        }
    }

    /**
     * @param string                           $command
     * @param BulkIndexerChildProcessInterface $commander
     */
    public function addCommander(
        $command,
        BulkIndexerChildProcessInterface $commander
    ) {
        $this->commanders[$command] = $commander;
    }
}
