<?php

namespace grn\schedule\screen\mobile;

use grn\schedule\screen\FacilityApproveDetailUtil;

require_once("schedule/resources.csp");
require_once("schedule/error_code.csp");
require_once("schedule/application.csp");

class FacilityApproveMobileDetail extends MobileScheduleScreenBase
{
    const ARG_EVENT_ID = "event";
    const ARG_FACILITY_ID = "faid";
    const ARG_B_DATE = "bdate";
    const ARG_REFERER = "referer_key";
    const ARG_NOTIFICATION_ID = "nid";
    const ARG_NOTIFICATION_HISTORY_ID = "nhid";
    const ARG_PATH_MOBILE_APPROVE = "schedule/mobile/operation/facility_approve";

    function __construct($input)
    {
        //Function at footer screen
        $func = [];
        $this->setMobileApplicationId(GRN_SCHEDULE_APPLICATION_ID);
        $this->setMobileFooterBar($func);
        parent::__construct($input);
        $this->checkArgFromInput(
            [
                self::ARG_EVENT_ID,
                self::ARG_FACILITY_ID
            ],
            $input
        );
    }

    public function fetch()
    {
        require_once("grn/smarty.csp");
        $smarty = new \GRN_Smarty();
        $input = $this->getInput();

        $facilityApproveDetailUtil = new FacilityApproveDetailUtil();

        //Back link, always goto notification list
        $facilityApproveDetailUtil->prepareForView($smarty, $input, true);
        $this->assignBreadcrumbUpperPage($smarty,
            $facilityApproveDetailUtil::ARG_EMPTY,
            $facilityApproveDetailUtil::ARG_EMPTY, [], true);

        //breadcrumb
        $this->assignBreadcrumbCurrentPage($smarty, $this->getTitle());

        return $smarty->fetch(self::ARG_PATH_MOBILE_APPROVE . ".tpl");
    }

    /***
     * The function for operation administrator determine accepted or rejected
     *
     * @param mixed $input
     */
    public function post($input = null)
    {
        $input = $this->getInput();
        $facilityApproveScreen = new FacilityApproveDetailUtil();
        $eventId = cb_at($input, self::ARG_EVENT_ID);
        $facilityId = cb_at($input, self::ARG_FACILITY_ID);
        $refererKey = cb_at($input, self::ARG_REFERER);


        $facilityApproveScreen->processForPost($input);

        cb_redirect(
            self::ARG_PATH_MOBILE_APPROVE,
            [
                self::ARG_FACILITY_ID => $facilityId,
                self::ARG_EVENT_ID    => $eventId,
                self::ARG_REFERER     => $refererKey
            ]
        );
    }

    public function getTitle()
    {
        return grn_get_current_page_display_name();
    }
}
