<?php

use grn\grn\access\service\AppAccess;

function isEnableReport()
{
    require_once('report/resources.csp');

    return AppAccess::isAppAvailableInternalAccess(GRN_REPORT_APPLICATION_ID);
}

function _toUnique($array)
{
    $tmp = [];
    foreach ($array as $value) {
        $tmp[$value] = 1;
    }

    $keys = array_keys($tmp);

    return $keys;
}

function getEventIdListByWeeksEvent($weeks_event)
{
    $event_id_list = [];
    foreach (array_keys($weeks_event) as $key) {
        $week = &$weeks_event[$key];
        foreach (array_keys($week['schedule_event']) as $key2) {
            if ( ! isset($week['schedule_event'][$key2]['event'])) {
                continue;
            }

            $events = &$week['schedule_event'][$key2]['event'];
            $ids = getEventIdListByEventList($events);
            $event_id_list = array_merge($event_id_list, $ids);
        }

        foreach (array_keys($week['banner_event']) as $key2) {
            if ( ! isset($week['banner_event'][$key2])) {
                continue;
            }

            $events = &$week['banner_event'][$key2];
            $ids = getEventIdListByEventList($events);
            $event_id_list = array_merge($event_id_list, $ids);
        }
    }

    return _toUnique($event_id_list);
}

function getEventIdListByUsersEvent($users_event)
{
    $event_id_list = [];
    foreach (array_keys($users_event) as $key) {
        $schedule_events = $users_event[$key]['schedule_event']['event'];
        $schedule_event_ids = getEventIdListByEventList($schedule_events);
        $event_id_list = array_merge($event_id_list, $schedule_event_ids);

        $banner_events = $users_event[$key]['banner_event'];
        $banner_event_ids = getEventIdListByEventList($banner_events);
        $event_id_list = array_merge($event_id_list, $banner_event_ids);
    }

    return $event_id_list;
}

function getEventIdListByEventList($events)
{
    if ( ! $events || ! is_array($events) || count($events) == 0) {
        return [];
    }

    $event_id_list = [];
    foreach (array_keys($events) as $key) {
        $event = &$events[$key];
        if (isset($event['id'])) {
            $event_id_list[] = $event['id'];
        }
    }

    return $event_id_list;
}

function getEventIdListByScheduleEvent($schedule_event)
{
    $event_id_list = [];
    //通常の予定
    if (isset($schedule_event['time_event'])) {
        foreach (array_keys($schedule_event['time_event']) as $key) {
            $event_id_list[] = &$schedule_event['time_event'][$key]['id'];
        }
    }

    //終日予定
    if (isset($schedule_event['allday_event'])) {
        foreach (array_keys($schedule_event['allday_event']) as $key) {
            $event_id_list[] = &$schedule_event['allday_event'][$key]['id'];
        }
    }
    //期間予定
    foreach (array_keys($schedule_event['banner_event']) as $key) {
        $event_id_list[] = &$schedule_event['banner_event'][$key]['id'];
    }

    //明日の予定(通常)
    foreach (array_keys($schedule_event['next']['event']) as $key) {
        $event_id_list[] = &$schedule_event['next']['event'][$key]['id'];
    }

    //明日の予定(終日)
    if (isset($schedule_event['next']['allday_event'])) {
        foreach (array_keys($schedule_event['next']['allday_event']) as $key) {
            $event_id_list[]
                = &$schedule_event['next']['allday_event'][$key]['id'];
        }
    }
    //明日の予定(期間)
    if (isset($schedule_event['next']['banner_event'])) {
        foreach (array_keys($schedule_event['next']['banner_event']) as $key) {
            $event_id_list[]
                = &$schedule_event['next']['banner_event'][$key]['id'];
        }
    }

    return _toUnique($event_id_list);
}

function getEventIdListByUsersWeekEvent($users_event)
{
    $event_id_list = [];
    foreach (array_keys($users_event) as $key) {
        foreach ($users_event[$key]['schedule_event'] as $day_events) {
            $day_event_ids = getEventIdListByEventList($day_events['event']);
            $event_id_list = array_merge($event_id_list, $day_event_ids);
        }
        foreach (array_keys($users_event[$key]['banner_event']) as $banner_key) {
            $banner_events = &$users_event[$key]['banner_event'][$banner_key];
            $banner_event_ids = getEventIdListByEventList($banner_events);
            $event_id_list = array_merge($event_id_list, $banner_event_ids);
        }
    }

    return $event_id_list;
}


