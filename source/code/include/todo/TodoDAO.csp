<?php

namespace grn\todo;

class TodoDAO
{
    protected function getDatabaseConnection()
    {
        $applicationLocator = \GRN_ApplicationLocator::instance();

        return $applicationLocator->getConnection("todo");
    }

    public function selectExpiredTodoByUserId(
        $user_id,
        $start_timestamp,
        $end_timestamp
    ) {
        $db = $this->getDatabaseConnection();
        $query = $this->createCommandSelectExpiredTodoByUserId($user_id,
            $start_timestamp, $end_timestamp);
        $result = $db->query($query);

        //SQL Fail -> throw Error
        ($result === false) && $db->throwError();

        $todos = [];

        while (($rowdata = $db->fetch_assoc($result))) {
            array_push($todos, $rowdata);
        }
        $db->free_result($result);

        return $todos;
    }

    private function createCommandSelectExpiredTodoByUserId(
        $user_id,
        $start_timestamp,
        $end_timestamp
    ) {
        $query = 'SELECT _id id , col_title title from tab_grn_todo_entity ';

        $condition_set = [
            'WHERE  col_user ='        => $user_id,
            'AND    col_limited ='     => 1,
            'AND    col_finish'        => 'IS NULL',
            'AND    col_expiration >=' => $start_timestamp,
            'AND    col_expiration <=' => $end_timestamp,
            'ORDER BY col_expiration'  => 'ASC'
        ];
        $statement = ' ';

        foreach ($condition_set as $condition => $value) {
            $statement .= $condition . ' ' . $this->getDatabaseConnection()
                                                  ->escape($value) . ' ';
        }

        return $query . $statement;
    }

}
