<?php

namespace grn\cydec\mq;

use grn\grn\push_notification\PushPayload;

class PushQueueRecordBuilder
{
    /**
     * @var PushJobMessage
     */
    private $pushJobMessage;

    /**
     * @var \Closure
     */
    private $onBuildFunction;

    /**
     * @param PushJobMessage $push_job_message
     * @param \Closure       $on_build_function
     */
    public function __construct(
        PushJobMessage $push_job_message,
        \Closure $on_build_function
    ) {
        $this->pushJobMessage = $push_job_message;
        $this->onBuildFunction = $on_build_function;
    }

    /**
     * @var array
     */
    private $envelopeList = [];

    /**
     * @param PushPayload $push_payload
     */
    public function addEnvelope(PushPayload $push_payload)
    {
        $this->envelopeList[] = $push_payload;
    }

    public function build()
    {
        if (empty($this->envelopeList)) {
            return;
        }

        foreach ($this->envelopeList as $push_payload) {
            $message = $this->pushJobMessage->payloadToJson($push_payload);
            if ($message) {
                $callBack = $this->onBuildFunction;
                $callBack([
                    new QueueRecord($message,
                        $this->pushJobMessage->getJobName())
                ]);
            }
        }
    }
}
