<?php

/**
 * 記事検索条件生成クラス
 *
 * @author  Tanaka, Yoshiaki        2005/01
 * @package grn.bulletin
 */

require_once('grn/application.csp');

function grn_bulletin_make_condition_array($column, $values, $operator)
{
    $app_locator = GRN_ApplicationLocator::instance();
    $database =& $app_locator->getConnection('bulletin');

    if ( ! $values) {
        return null;
    }

    $glue = ' ' . $operator . ' ' . $column . ' = ';

    //Escape Values
    foreach (array_keys($values) as $key) {
        if (is_null($values[$key])) {
            $values[$key] = cb_queryf($database, "@S", $values[$key]);
        } else {
            $values[$key] = cb_queryf($database, "'@S'", $values[$key]);
        }
    }

    return $column . ' = ' . implode($glue, $values);
}

function grn_bulletin_make_category_condition(
    $alias,
    $values,
    $operator = 'AND'
) {
    $app_locator = GRN_ApplicationLocator::instance();
    $database = $app_locator->getConnection('bulletin');

    if ($alias) {
        $alias .= '.';
    }

    $column_name = $alias . 'col_category';

    if (is_array($values)) {
        return grn_bulletin_make_condition_array($column_name, $values,
            $operator);
    }

    if ($values) {
        if ( ! is_null($values)) {
            $values = cb_queryf($database, "'@S'", $values);
        }

        return $column_name . ' = ' . $values;
    }

    //return $column_name.' != '. GRN_BULLETIN_NULL_OBJECT_ID;
    return null;
}

function __grn_bulletin_timestamp($tm)
{
    if ( ! $tm) {
        $tm = time();
    } elseif (is_a($tm, 'cb_timestamp')) {
        $tm = $tm->unix_ts;
    }

    return $tm;
}

function grn_bulletin_make_published_condition(
    $alias,
    $tm = null,
    $published_only = true,
    $before_last_updated = false
) {
    $tm = __grn_bulletin_timestamp($tm);

    if ($alias) {
        $alias .= '.';
    }

    if ($published_only) {
        $q = '(' . $alias . 'col_start_timestamp IS NULL OR ' . $alias
             . 'col_start_timestamp <= ' . $tm . ') AND ';
        $q .= '(' . $alias . 'col_end_timestamp IS NULL OR ' . $alias
              . 'col_end_timestamp > ' . $tm . ')';
    } elseif ($before_last_updated) {
        $q = $alias . 'col_ntime < ' . $tm;
    } else {
        $q = $alias . 'col_start_timestamp IS NULL OR ' . $alias
             . 'col_start_timestamp <= ' . $tm;
    }

    return '(' . $q . ')';
}

function grn_bulletin_make_expired_condition($alias, $tm = null)
{
    $tm = __grn_bulletin_timestamp($tm);
    if ($alias) {
        $alias .= '.';
    }

    return '(' . $alias . 'col_end_timestamp <= ' . $tm . ')';
}

function grn_bulletin_make_not_expired_condition($alias, $tm = null)
{
    $tm = __grn_bulletin_timestamp($tm);
    if ($alias) {
        $alias .= '.';
    }

    return '(' . $alias . 'col_end_timestamp IS NULL OR ' . $alias
           . 'col_end_timestamp > ' . $tm . ')';
}

function grn_bulletin_make_before_condition($alias, $tm = null)
{
    $tm = __grn_bulletin_timestamp($tm);
    if ($alias) {
        $alias .= '.';
    }

    return '(' . $alias . 'col_start_timestamp > ' . $tm . ')';
}

function grn_bulletin_make_derelict_condition($alias, $reference_timestamp)
{
    $rt = __grn_bulletin_timestamp($reference_timestamp);

    if ($alias) {
        $alias .= '.';
    }

    return '(' . $alias . 'col_ntime < ' . $rt . ')';
}




