<?php

namespace grn\bulletin\screen\mobile;

class CommentDelete extends MobileBulletinScreenBase
{
    public function __construct($input)
    {
        parent::__construct($input);
        $this->checkArgFromInput([
            self::ARG_CATEGORY_ID,
            self::ARG_ARTICLE_ID,
            self::ARG_FOLLOW_ID
        ], $input);
        $user = $this->getLoginUser();
        $article_id = $this->getArticleId();
        $this->setArticle($this->getArticleById($user, $article_id));
    }

    public function fetch()
    {
        $cid = $this->getCategoryId();
        $aid = $this->getArticleId();
        $follow_id = $this->getFollowId();
        $user = $this->getLoginUser();
        $article = $this->getArticle();
        if ( ! $follow = $article->getFollow($follow_id)) {
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }
        $follow->isDeletable($user, true);

        require_once('grn/smarty.csp');
        $smarty = new \GRN_Smarty();
        $smarty->assign('cid', $cid);
        $smarty->assign('aid', $aid);
        $smarty->assign('follow_id', $follow_id);

        $this->assignBreadcrumbUpperPage($smarty,
            cb_msg('grn.mobile', 'detail_title'),
            self::URL_BULLETIN_DETAIL,
            [
                self::ARG_CATEGORY_ID => $cid,
                self::ARG_ARTICLE_ID  => $aid,
            ]);
        $this->assignBreadcrumbCurrentPage($smarty,
            cb_msg('grn.mobile', 'comment_delete'));

        return $smarty->fetch('bulletin/mobile/comment_delete.tpl');
    }

    public function post($input)
    {
        $follow_id = $this->getFollowId();
        $user = $this->getLoginUser();
        $article = $this->getArticle();
        if ( ! ($follow = $article->getFollow($follow_id))) {
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }
        $follow->delete($user);
    }

    public function getTitle()
    {
        $article = $this->getArticle();

        return $article->getTitle() . ' - ' . cb_msg('grn.mobile',
                'comment_delete');
    }
}
