<?php

namespace grn\bulletin\screen\mobile;

class FileDownload extends MobileBulletinScreenBase
{
    public function post($input)
    {
        $this->setInput($input);
        $this->checkArgFromInput([
            self::ARG_CATEGORY_ID,
            self::ARG_ARTICLE_ID,
            self::ARG_FILE_ID
        ], $input);
        $user = $this->getLoginUser();
        $file_id = $this->getFileId();

        require_once('bulletin/file.csp');
        $manager = \GRN_Bulletin_FileManager::getInstance();
        $article_id = $manager->getArticleId($file_id);
        $follow_id = $manager->getFollowId($file_id);

        if ( ! ($article = $this->getArticleById($user, $article_id))) {
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
        }

        $file = null;

        if ($follow_id) {
            if ( ! ($follow = $article->getFollow($follow_id))) {
                cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
            }
            $file = $follow->getFile($file_id);
        } else {
            $file = $article->getFile($file_id);
        }

        $body = null;
        $body = $file->getCurrentBody();

        if ( ! $body) {
            cb_throw_error(E_GRN_BULLETIN_FILE_LOG_NOT_FOUND);
        }

        // logging
        require_once('bulletin/table.csp');
        grn_bulletin_write_log("download", "file", [
            'uid'     => $user->getOID(),
            'fid'     => $file->getOID(),
            'version' => $file->get('version'),
            'name'    => $body->get('name')
        ], 'info');

        $body->download(true);

        cb_safe_exit();
    }
}
