<?php

namespace grn\bulletin\screen\mobile;

class BulletinCommentAdd extends MobileBulletinScreenBase
{
    public function fetch()
    {
        $input = $this->getInput();

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();

        $article_id = $this->getArticleId();

        $article = $this->getArticle();

        // フォローの書き込みができない場合
        if (1 != $article->get('can_follow')) {
            cb_throw_error(E_GRN_BULLETIN_TOPIC_DO_NOT_ALLOW_FOLLOW);
        }

        $upper_name = cb_msg('grn.mobile', 'detail_title');
        $upper_page = self::URL_BULLETIN_DETAIL;
        $upper_param = [
            self::ARG_CATEGORY_ID => cb_at($input, self::ARG_CATEGORY_ID),
            self::ARG_ARTICLE_ID  => $article_id
        ];
        $current_name = cb_msg('grn.mobile', 'comment_add');

        // bulletin follow reply
        if (array_key_exists(self::ARG_FOLLOW_ID, $input)
            && $input[self::ARG_FOLLOW_ID] > 0
        ) {
            if ( ! ($follow
                =& $article->getFollow($input[self::ARG_FOLLOW_ID]))
            ) {
                cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
            }
            $upper_name = cb_msg('grn.mobile',
                'comment_detail_title');
            $upper_page
                = 'bulletin/mobile/comment_detail';
            $upper_param[self::ARG_FOLLOW_ID] = cb_at($input,
                self::ARG_FOLLOW_ID);
            $current_name = cb_msg('grn.mobile',
                'comment_reply');
        }

        $t->assign('cid', @ $input['cid']);
        $t->assign('aid', $article_id);
        $t->assign('parent_fid', @ $input[self::ARG_FOLLOW_ID]);

        //generate upload ticket
        include('grn/_upload_prepend.csp');

        $this->assignBreadcrumbUpperPage($t, $upper_name, $upper_page,
            $upper_param);
        $this->assignBreadcrumbCurrentPage($t, $current_name);

        return $t->fetch('bulletin/mobile/comment_add.tpl');
    }

    public function post($input)
    {
        $this->setInput($input);
        $this->checkArgFromInput([self::ARG_ARTICLE_ID], $input);
        $user = $this->getLoginUser();
        $article_id = $this->getArticleId();

        $article = $this->getArticleById($user, $article_id);

        $properties['data'] = $input['comment_data'];
        $properties['html'] = null;

        if (@ $input['attached_file']) {
            require_once('grn/upload.csp');
            $files = \GRN_UploadFile::getUploadedFiles(@$input['upload_ticket'],
                @$input['file_input'], true);
        } else {
            $files = [];
        }

        if (is_null($properties['data'])
            || strlen(cb_trim($properties['data'])) < 1
        ) {
            if ( ! $files || count($files) == 0) {
                cb_throw_error(E_GRN_BULLETIN_EMPTY_FOLLOW);
            }
        }

        // bulletin follow reply
        if (array_key_exists(self::ARG_FOLLOW_ID, $input)
            && $input[self::ARG_FOLLOW_ID] > 0
        ) {
            if ( ! ($follow
                =& $article->getFollow($input[self::ARG_FOLLOW_ID]))
            ) {
                cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
            }
            $follow_number = $follow->get(self::ARG_FOLLOW_ID);
            if ($follow_number && $follow_number > 0) {
                $properties['data'] = ">>" . $follow_number . "\n"
                                      . $properties['data'];
            }
        }

        $follow = $article->writeFollow($user, $properties, $files);

        assert('$follow !== FALSE');
    }

    public function getTitle()
    {
        $input = $this->getInput();
        $this->checkArgFromInput([self::ARG_ARTICLE_ID], $input);
        $user = $this->getLoginUser();
        $article_id = $this->getArticleId();

        $article = $this->getArticleById($user, $article_id);
        $this->setArticle($article);

        return $article->getTitle() . ' - ' . (cb_at($input,
                self::ARG_FOLLOW_ID, 0) > 0 ? cb_msg('grn.mobile',
                'comment_reply') : cb_msg('grn.mobile', 'comment_add'));
    }
}
