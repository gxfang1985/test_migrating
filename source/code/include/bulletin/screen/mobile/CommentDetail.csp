<?php

namespace grn\bulletin\screen\mobile;

class CommentDetail extends MobileBulletinScreenBase
{
    public function __construct($input)
    {
        parent::__construct($input);
        $this->checkArgFromInput([
            self::ARG_CATEGORY_ID,
            self::ARG_ARTICLE_ID,
            self::ARG_FOLLOW_ID
        ], $input);
        $user = $this->getLoginUser();
        $article_id = $this->getArticleId();
        $this->setArticle($this->getArticleById($user, $article_id));
    }

    public function fetch()
    {
        $cid = $this->getCategoryId();
        $aid = $this->getArticleId();
        $follow_id = $this->getFollowId();
        $user = $this->getLoginUser();
        $article = $this->getArticle();
        require_once('bulletin/controller.csp');
        $utility = new \GRN_Bulletin_ControllerUtil();
        $comment_for_view
            = $this->getCommentViewById($follow_id);
        $user_info
            = $utility->getUserInfoToShowUserName([$comment_for_view['creator_uid']],
            $user);
        $user_info = $this->getUsersInfoType($user_info);
        $uid = $comment_for_view['creator_uid'];
        $comment_for_view['creator_type'] = $user_info[$uid]['valid'];
        $comment_for_view['cid'] = $cid;
        $comment_for_view['aid'] = $aid;
        $comment_for_view['can_follow'] = $article->get('can_follow');
        $comment_for_view['auth'] = $article->getAuthorities($user);

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();
        $t->assign('comment', $comment_for_view);

        $upper_page_args = [
            self::ARG_CATEGORY_ID => $cid,
            self::ARG_ARTICLE_ID  => $aid
        ];
        $this->assignBreadcrumbUpperPage($t,
            cb_msg('grn.mobile', 'detail_title'), 'bulletin/mobile/view',
            $upper_page_args);
        $this->assignBreadcrumbCurrentPage($t,
            cb_msg('grn.mobile', 'comment_reply_title'));

        return $t->fetch('bulletin/mobile/comment_detail.tpl');
    }

    public function getTitle()
    {
        $article = $this->getArticle();

        return $article->getTitle() . ' - ' . cb_msg('grn.mobile',
                'comment_reply_title');
    }
}
