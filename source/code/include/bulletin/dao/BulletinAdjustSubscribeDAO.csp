<?php

namespace grn\bulletin\dao;

/**
 * BulletinAdjustSubscribe Access Object Class
 */
class BulletinAdjustSubscribeDAO
{
    private static $instance = null;

    /**
     * Constructor
     */
    public function __construct()
    {

    }

    /**
     * Get Instance(Singleton pattern)
     *
     * @return BulletinAdjustSubscribeDAO $instance
     */
    public static function getInstance()
    {
        if ( ! isset(self::$instance)) {
            $c = __CLASS__;
            self::$instance = new $c;
        }

        return self::$instance;
    }

    /**
     * @param array $category_ids
     * @param array $dao_params
     *
     * @return array
     */
    public function selectCategoryForceNotify(
        array $category_ids,
        array $dao_params
    ) {
        if (count($category_ids) === 0) {
            return [];
        }

        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_categoryentity._id,
 bulletin_categoryentity.col_force_notify 
FROM
 tab_grn_bulletin_categoryentity AS bulletin_categoryentity
WHERE
 bulletin_categoryentity._id IN( @A )
SQL;
        $query = $db->format($query, [$category_ids]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        foreach ($category_ids as $category_id) {
            $rows[$category_id] = [];
        }

        while ($row = $db->fetch_assoc($result)) {
            $category_id = $row["_id"];
            $rows[$category_id] = $row["col_force_notify"];
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param array $category_ids
     * @param array $dao_params
     *
     * @return array
     */
    public function selectUsersNotificationCategory(
        array $category_ids,
        array $dao_params
    ) {
        if (count($category_ids) === 0) {
            return [];
        }

        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT 
 bulletin_usernotification.col_user, 
 bulletin_usernotification.col_category 
FROM
 tab_grn_bulletin_usernotification AS bulletin_usernotification
WHERE
 bulletin_usernotification.col_category IN ( @A )
SQL;
        $query = $db->format($query, [$category_ids]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        foreach ($category_ids as $category_id) {
            $rows[$category_id] = [];
        }

        while ($row = $db->fetch_assoc($result)) {
            $category_id = $row["col_category"];
            $user_id = $row["col_user"];
            $rows[$category_id][$user_id] = $user_id;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param array $category_ids
     * @param array $dao_params
     *
     * @return array
     */
    public function selectGroupsNotificationCategory(
        array $category_ids,
        array $dao_params
    ) {
        if (count($category_ids) === 0) {
            return [];
        }

        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_groupnotification.col_category,
 usergrouprelation.col_user 
FROM
 tab_grn_bulletin_groupnotification AS bulletin_groupnotification 
LEFT JOIN tab_cb_usergrouprelation AS usergrouprelation
 ON usergrouprelation.col_group = bulletin_groupnotification.col_group 
WHERE
 bulletin_groupnotification.col_category IN ( @A )
 AND usergrouprelation.col_user IS NOT NULL
SQL;
        $query = $db->format($query, [$category_ids]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        foreach ($category_ids as $category_id) {
            $rows[$category_id] = [];
        }

        while ($row = $db->fetch_assoc($result)) {
            $category_id = $row["col_category"];
            $user_id = $row["col_user"];
            $rows[$category_id][$user_id] = $user_id;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param array $category_ids
     * @param array $dao_params
     *
     * @return array
     */
    public function selectRolesNotificationCategory(
        array $category_ids,
        array $dao_params
    ) {
        if (count($category_ids) === 0) {
            return [];
        }

        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_rolenotification.col_category,
 userrolerelation.col_user 
FROM
 tab_grn_bulletin_rolenotification AS bulletin_rolenotification 
LEFT JOIN tab_cb_userrolerelation AS userrolerelation
 ON userrolerelation.col_role = bulletin_rolenotification.col_role 
WHERE
 bulletin_rolenotification.col_category IN ( @A )
 AND userrolerelation.col_user IS NOT NULL
SQL;
        $query = $db->format($query, [$category_ids]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        foreach ($category_ids as $category_id) {
            $rows[$category_id] = [];
        }

        while ($row = $db->fetch_assoc($result)) {
            $category_id = $row["col_category"];
            $user_id = $row["col_user"];
            $rows[$category_id][$user_id] = $user_id;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param array $category_ids
     * @param array $dao_params
     *
     * @return array
     */
    public function selectDynamicRolesNotificationCategory(
        array $category_ids,
        array $dao_params
    ) {
        if (count($category_ids) === 0) {
            return [];
        }

        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT 
 bulletin_dynamicrolenotification.col_category 
FROM
 tab_grn_bulletin_dynamicrolenotification AS bulletin_dynamicrolenotification
WHERE
 bulletin_dynamicrolenotification.col_category IN ( @A )
 AND bulletin_dynamicrolenotification.col_dynamic_role IN ( 'LoginUser', 'Everyone' )
SQL;
        $query = $db->format($query, [$category_ids]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        foreach ($category_ids as $category_id) {
            $rows[$category_id] = null;
        }

        while ($row = $db->fetch_assoc($result)) {
            $category_id = $row["col_category"];
            $rows[$category_id] = $category_id;
        }
        $db->free_result($result);

        return $rows;
    }
}
