<?php

class GrnBulletinReadstatusDAO
{
    /**
     * @param        $in_db
     * @param int    $article_id
     * @param array  $acknowledgement_user_ids
     */
    public function insertAcknowledgement(
        $in_db,
        $article_id,
        $acknowledgement_user_ids
    ) {
        $count_acknowledgement = count($acknowledgement_user_ids);
        if ($count_acknowledgement <= 0) {
            return;
        }

        $query
            = "INSERT INTO tab_grn_bulletin_readstatus (col_article, col_acknowledgement, col_user) VALUES ";
        $insert_value = [];
        foreach ($acknowledgement_user_ids as $acknowledgement_user_id) {
            $insert_value[] = cb_queryf($in_db, "('@S', 1, '@S' )", $article_id,
                $acknowledgement_user_id);
        }

        $in_db->query($query . implode($insert_value, ",") . ";");
    }

    /**
     * @param      $in_db
     * @param int  $article_id
     * @param bool $is_read
     *
     * @return int
     */
    public function getAcknowledgementNum($in_db, $article_id, $is_read = false)
    {
        $query = "SELECT count(*) as num FROM tab_grn_bulletin_readstatus as r"
                 . " INNER JOIN tab_cb_user as u ON r.col_user = u._id"
                 . " WHERE u.col_deleted IS NULL";

        if ($is_read) {
            $query .= " AND r.col_first_timestamp IS NOT NULL AND r.col_last_timestamp IS NOT NULL";
        }

        $query .= " AND r.col_acknowledgement = 1 AND r.col_article = '@S';";

        $query = cb_queryf($in_db, $query, $article_id);

        $result = $in_db->query($query);

        $row = $in_db->fetch_assoc($result);

        return $row['num'];
    }

    /**
     * @param     $in_db
     * @param int $article_id
     * @param int $limit
     * @param int $offset
     *
     * @return array
     */
    public function getAcknowledgementList(
        $in_db,
        $article_id,
        $limit = -1,
        $offset = 0
    ) {
        $query
            = "SELECT u._id, u.col_display_name, u.col_position, IFNULL(r.col_first_timestamp, 9999999999) as col_first_timestamp "
              . " FROM tab_grn_bulletin_readstatus as r "
              . " LEFT JOIN tab_cb_user as u ON u._id = r.col_user "
              . " WHERE r.col_article = '@S' AND r.col_acknowledgement=1 "
              . " ORDER BY col_first_timestamp DESC, u.col_position, u._id ASC ";

        $query = cb_queryf($in_db, $query, $article_id);
        $query = $in_db->select_format($query, $offset, $limit);

        $acknowledgments = [];
        $result = $in_db->query($query);
        while ($row = $in_db->fetch_assoc($result)) {
            $acknowledgments[$row['_id']] = [
                '_id'             => $row['_id'],
                'display_name'    => $row['col_display_name'],
                'position'        => $row['col_position'],
                'first_timestamp' => $row['col_first_timestamp']
            ];
        }

        return $acknowledgments;

    }
}
