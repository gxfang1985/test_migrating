<?php

namespace grn\bulletin\dao;

/**
 * BulletinUnSubscribeCategory Access Object Class
 */
class BulletinUnSubscribeCategoryDAO
{
    const COLUMN_CATEGORY = "col_category";//bigint(20) NOT NULL,
    const COLUMN_USER = "col_user";//bigint(20) NOT NULL,

    private static $instance = null;

    /**
     * Constructor
     */
    public function __construct()
    {

    }

    /**
     * Get Instance(Singleton pattern)
     *
     * @return BulletinUnSubscribeCategoryDAO $instance
     */
    public static function getInstance()
    {
        if ( ! isset(self::$instance)) {
            $c = __CLASS__;
            self::$instance = new $c;
        }

        return self::$instance;
    }

    /**
     * @param string $user_id
     * @param string $category_id
     * @param array  $dao_params
     *
     * @return array
     */
    public function insertUnscribeUserCategory(
        $user_id,
        $category_id,
        array $dao_params
    ) {
        $db = $dao_params['db'];

        $query
            = <<<SQL
INSERT tab_grn_bulletin_unsubscribecategory
 (col_user, col_category) 
VALUES
 ("@S", "@S")
SQL;
        $query = $db->format($query, [$user_id, $category_id]);
        $db->query($query);

        return $db->get_insert_id();
    }

    /**
     *
     * @param string $user_id
     * @param array  $dao_params
     *
     * @return array
     */
    public function selectUnSubscribeCategoryByUserId(
        $user_id,
        array $dao_params
    ) {
        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_unsubscribecategory.col_category 
FROM
 tab_grn_bulletin_unsubscribecategory AS bulletin_unsubscribecategory
WHERE
 bulletin_unsubscribecategory.col_user = "@S"
SQL;
        $query = $db->format($query, [$user_id]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        while ($row = $db->fetch_assoc($result)) {
            $col_category = $row[self::COLUMN_CATEGORY];
            $rows[$col_category] = $col_category;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param string $category_id
     * @param array  $dao_params
     *
     * @return array
     */
    public function selectUnSubscribeCategoryUserByCategoryId(
        $category_id,
        array $dao_params
    ) {
        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_unsubscribecategory.col_user
FROM
 tab_grn_bulletin_unsubscribecategory AS bulletin_unsubscribecategory
WHERE
 bulletin_unsubscribecategory.col_category = "@S"
SQL;
        $query = $db->format($query, [$category_id]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        while ($row = $db->fetch_assoc($result)) {
            $col_user = $row[self::COLUMN_USER];
            $rows[$col_user] = $col_user;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     *
     * @param string $user_id
     * @param string $category_id
     * @param array  $dao_params
     *
     * @return array
     */
    public function selectUnscribeUserCategory(
        $user_id,
        $category_id,
        array $dao_params
    ) {
        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_unsubscribecategory.col_user,
 bulletin_unsubscribecategory.col_category
FROM
 tab_grn_bulletin_unsubscribecategory AS bulletin_unsubscribecategory
WHERE
 bulletin_unsubscribecategory.col_user = "@S"
 AND bulletin_unsubscribecategory.col_category = "@S"
SQL;
        $query = $db->format($query, [$user_id, $category_id]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        while ($row = $db->fetch_assoc($result)) {
            $col_category = $row[self::COLUMN_CATEGORY];
            $col_user = $row[self::COLUMN_USER];
            $rows[$col_user] = $col_category;
        }
        $db->free_result($result);

        return $rows;
    }

    /**
     * @param string $user_id
     * @param string $category_id
     * @param array  $dao_params
     */
    public function deleteUnscribeUserCategory(
        $user_id,
        $category_id,
        array $dao_params
    ) {
        $db = $dao_params['db'];

        $query
            = <<<SQL
DELETE FROM
 tab_grn_bulletin_unsubscribecategory
WHERE
 col_user = "@S"
 AND col_category = "@S"
SQL;
        $query = $db->format($query, [$user_id, $category_id]);
        $db->query($query);
    }
}
