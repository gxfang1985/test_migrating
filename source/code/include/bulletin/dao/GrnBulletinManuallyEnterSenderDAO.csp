<?php

class GrnBulletinManuallyEnterSenderDAO
{
    /**
     * @param CB_DatabaseConnection $db
     * @param int                   $manually_enter_sender_id
     *
     * @return string
     */
    public function getSenderNameById($db, $manually_enter_sender_id)
    {
        $query = cb_queryf($db,
            "SELECT _id, col_sender_name FROM tab_grn_bulletin_manually_enter_sender WHERE _id = '@S';",
            $manually_enter_sender_id);
        $result = $db->query($query);
        if ($row = $db->fetch_assoc($result)) {
            $sender_name = $row['col_sender_name'];
        } else {
            $sender_name = null;
        }
        $db->free_result($result);

        return $sender_name;
    }

    /**
     * @param CB_DatabaseConnection $db
     * @param string                $sender_name
     * @param bool                  $use_like
     *
     * @return array
     */
    public function getIdsBySenderName($db, $sender_name, $use_like = false)
    {
        $query = "SELECT _id FROM tab_grn_bulletin_manually_enter_sender WHERE";
        if ($use_like) {
            $query .= cb_queryf($db, " col_sender_name LIKE '%@L%';",
                $sender_name);
        } else {
            $query .= cb_queryf($db, " col_sender_name_bin = '@S';",
                $sender_name);
        }

        $manually_enter_sender_ids = [];
        $result = $db->query($query);
        while ($row = $db->fetch_assoc($result)) {
            $manually_enter_sender_ids[] = $row['_id'];
        }
        $db->free_result($result);

        return $manually_enter_sender_ids;
    }

    /**
     * @param CB_DatabaseConnection $db
     * @param string                $sender_name
     *
     * @return int
     */
    public function insertManuallyEnterSender($db, $sender_name)
    {
        $query = "INSERT INTO tab_grn_bulletin_manually_enter_sender" .
                 " SET col_sender_name_bin = '@S', col_sender_name = '@S'" .
                 " ON DUPLICATE KEY UPDATE _id = _id;";
        $query = cb_queryf($db, $query, $sender_name, $sender_name);

        $db->query($query);

        return $db->get_insert_id();
    }

    /**
     * @param CB_DatabaseConnection $db
     *
     * @return bool
     */
    public function cleanManuallyEnterSender($db)
    {
        $manually_enter_sender_ids = [];

        $query
            = "SELECT DISTINCT col_manually_enter_sender FROM tab_grn_bulletin_articleentity WHERE col_manually_enter_sender IS NOT NULL;";
        $result = $db->query($query);
        while ($row = $db->fetch_assoc($result)) {
            $manually_enter_sender_ids[] = $row['col_manually_enter_sender'];
        }
        $db->free_result($result);

        $query
            = "SELECT DISTINCT col_manually_enter_sender FROM tab_grn_bulletin_draftentity WHERE col_manually_enter_sender IS NOT NULL;";
        $result = $db->query($query);
        while ($row = $db->fetch_assoc($result)) {
            $manually_enter_sender_ids[] = $row['col_manually_enter_sender'];
        }
        $db->free_result($result);

        $query
            = "DELETE FROM tab_grn_bulletin_manually_enter_sender WHERE _id NOT IN (@A);";
        $query = cb_queryf($db, $query, $manually_enter_sender_ids);
        $result = $db->query($query);

        return $result;
    }
}
