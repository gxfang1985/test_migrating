<?php

namespace grn\bulletin\dao;

/**
 * BulletinUserProfile Access Object Class
 */
class BulletinProfileDataDAO
{
    const COLUMN_USER = "col_user";//bigint(20) NOT NULL,
    const COLUMN_SUBSCRIBE = "col_subscribe";//int(11) NOT NULL,

    private static $instance = null;

    /**
     * Constructor
     */
    public function __construct()
    {

    }

    /**
     * Get Instance(Singleton pattern)
     *
     * @return BulletinProfileDataDAO $instance
     */
    public static function getInstance()
    {
        if ( ! isset(self::$instance)) {
            $c = __CLASS__;
            self::$instance = new $c;
        }

        return self::$instance;
    }

    /**
     *
     * @param string $user_id
     * @param int    $subscribe
     * @param array  $dao_params
     *
     * @return string
     */
    public function insertPersonalAdjustSubscribe(
        $user_id,
        $subscribe,
        array $dao_params
    ) {
        $db = $dao_params['db'];

        $query
            = <<<SQL
INSERT tab_grn_bulletin_profiledata
 (col_user, col_subscribe) 
VALUES
 ("@S", "@S") 
ON DUPLICATE KEY UPDATE col_subscribe=VALUES(col_subscribe)
SQL;
        $query = $db->format($query, [$user_id, $subscribe]);
        $db->query($query);

        return $db->get_insert_id();
    }

    /**
     * @param string $user_id
     * @param array  $dao_params
     *
     * @return array
     */
    public function selectPersonalAdjustSubscribe($user_id, array $dao_params)
    {
        $db = $dao_params['db'];
        $offset = cb_at($dao_params, "lock", 0);
        $limit = cb_at($dao_params, "limit", -1);
        $lock = cb_at($dao_params, "lock", CB_DATABASE_DEFAULT_LOCK);

        $query
            = <<<SQL
SELECT
 bulletin_profiledata.col_user,
 bulletin_profiledata.col_subscribe 
FROM
 tab_grn_bulletin_profiledata AS bulletin_profiledata
WHERE
 bulletin_profiledata.col_user = "@S"
SQL;
        $query = $db->format($query, [$user_id]);
        $query = $db->select_format($query, $offset, $limit, $lock);
        $result = $db->query($query);

        $rows = [];
        while ($row = $db->fetch_assoc($result)) {
            $rows[$row[self::COLUMN_USER]] = $row[self::COLUMN_SUBSCRIBE];
        }
        $db->free_result($result);

        return $rows;
    }
}
