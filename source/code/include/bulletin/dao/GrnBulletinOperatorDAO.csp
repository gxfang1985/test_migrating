<?php

use grn\bulletin\bean\GrnBulletinOperator;
use grn\grn\Validate;

class GrnBulletinOperatorDAO
{
    /**
     * @param array $in_data_obj
     * @param int   $article_id
     * @param bool  $is_draft
     *
     * @return array
     */
    public function getOperatorListByArticleID(
        $in_data_obj,
        $article_id,
        $is_draft
    ) {
        $in_db = $in_data_obj['db'];

        $query = "SELECT * FROM tab_grn_bulletin_operator WHERE "
                 . ($is_draft ? "col_draft" : "col_article")
                 . " = '@S' ORDER BY _id ASC;";
        $query = cb_queryf($in_db, $query, $article_id);

        $result = $in_db->query($query);
        $operator_list = [];
        while ($row = $in_db->fetch_assoc($result)) {
            $operator = new GrnBulletinOperator($row);
            $operator_list[$operator->getUser()] = $operator;
        }
        $in_db->free_result($result);

        return $operator_list;
    }

    /**
     * @param array               $in_data_obj
     * @param GrnBulletinOperator $operator
     *
     * @return bool
     */
    public function isOperator($in_data_obj, GrnBulletinOperator $operator)
    {
        $in_db = $in_data_obj['db'];

        $query = "SELECT * FROM tab_grn_bulletin_operator WHERE";

        if (Validate::isNotNull($operator->getArticle())) {
            $query .= cb_queryf($in_db, " col_article = '@S' ",
                $operator->getArticle());
        }

        if (Validate::isNotNull($operator->getDraft())) {
            $query = preg_match("/WHERE$/", $query) ? $query : $query . " AND";
            $query .= cb_queryf($in_db, " col_draft = '@S'",
                $operator->getDraft());
        }

        if (Validate::isNotNull($operator->getUser())) {
            $query = preg_match("/WHERE$/", $query) ? $query : $query . " AND";
            $query .= cb_queryf($in_db, " col_user = '@S'",
                $operator->getUser());
        }

        $query .= cb_queryf($in_db, " ORDER BY _id ASC;");
        $result = $in_db->query($query);

        return ($result && $in_db->num_rows($result) > 0) ? true : false;
    }

    /**
     * @param array               $in_data_obj
     * @param GrnBulletinOperator $operator
     *
     * @return boolean
     */
    public function insertOperator($in_data_obj, GrnBulletinOperator $operator)
    {
        $in_db = $in_data_obj['db'];

        $query = "INSERT INTO tab_grn_bulletin_operator SET";

        if (Validate::isNotNull($operator->getArticle())) {
            $query .= cb_queryf($in_db, " col_article = '@S',",
                $operator->getArticle());
        }

        if (Validate::isNotNull($operator->getDraft())) {
            $query .= cb_queryf($in_db, " col_draft = '@S',",
                $operator->getDraft());
        }

        if (Validate::isNull($operator->getDraft())
            && Validate::isNull($operator->getArticle())
        ) {
            return false;
        }

        $query .= cb_queryf($in_db, " col_user = '@S', col_user_name = '@S';",
            $operator->getUser(), $operator->getUserName());
        $result = $in_db->query($query);

        return $result;
    }

    /**
     * @param array $in_data_obj
     * @param int   $article_id
     * @param bool  $is_draft
     *
     * @return mixed
     */
    public function deleteAllOperatorByArticleId(
        $in_data_obj,
        $article_id,
        $is_draft = false
    ) {
        $in_db = $in_data_obj['db'];

        $query = "DELETE FROM tab_grn_bulletin_operator WHERE "
                 . ($is_draft ? "col_draft" : "col_article")
                 . "='@S';";
        $query = cb_queryf($in_db, $query, $article_id);
        $result = $in_db->query($query);

        return $result;
    }
}
