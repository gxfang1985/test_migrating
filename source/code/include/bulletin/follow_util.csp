<?php

/**
 * 掲示板フォローユーティリティー
 *
 * @author  Tanaka, Yoshiaki        2004/11
 * @package grn.bulletin
 */

require_once('bulletin/follow.csp');
require_once('bulletin/base_util.csp');


/**
 * フォローコレクション
 *
 * @package grn.bulletin
 */
class GRN_Bulletin_FollowList extends GRN_Bulletin_ListBase
{
    /**
     * @access private
     */
    var $_user = null;
    /**
     * @access private
     */
    var $_article = null;


    function __construct(& $user, & $article)
    {
        parent::__construct();

        $this->_user =& $user;
        $this->_article =& $article;
    }


    // 先頭フォローID

    /**
     * @access private
     */
    var $_head = null;

    function setHeadFollowID($id)
    {
        if ($this->_rowset) {
            return false;
        }
        $this->_head = $id;

        return true;
    }

    function getHeadFollowID()
    {
        return $this->_head;
    }

    /**
     * override
     *
     * @access protected
     */
    function _setOrderColumn(& $rowset, $inverse = false)
    {
        if ($this->countOrderColumn() <= 0) {
            $this->addOrderColumn('ctime', true);
        }

        return parent::_setOrderColumn($rowset, $inverse);
    }

    /**
     * override
     *
     * @access protected
     * @return CB_RowSet
     */
    function _createRowSet()
    {
        if ( ! $this->_user || ! $this->_article) {
            $ret = null;

            return $ret;
        }

        if (($a = $this->_getAliasByColumn(null))) {
            $a .= '.';
        }

        $table = $this->getTableInfo('GRN_Bulletin_FollowEntity');

        $rowset = new CB_RowSet($table, $this->_getAliasByColumn(null));

        $rowset->addCondition($rowset->queryf($a . "col_article = '@S'",
            $this->_article->getOID()));

        return $rowset;
    }

    /**
     * override
     *
     * @access protected
     */
    protected function _initialize()
    {
        if ( ! $this->_article) {
            return false;
        }

        if ( ! is_null($this->_head)) {
            if (($target =& $this->_article->getFollow($this->_head))) {
                $this->setOffset($this->_getPreviousOffset($target));
            }
        }

        return parent::_initialize();
    }

    /**
     * override
     *
     * @access protected
     */
    function &_row2object(& $row)
    {
        $factory = GRN_Bulletin_FollowFactory::getInstance();
        $ret = $factory->row2object($row);

        return $ret;
    }

}



