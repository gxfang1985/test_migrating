<?php
/**
 * @brief
 * @author   Yoshiaki Tanaka
 * @date     2005/05/06
 * @par      Copyright (c) 2004 Cybozu,Inc. All rights reserved .
 * @package  grn.timecard
 */


function grn_timecard_validate_record(& $record)
{
    if (is_null(($in = $record->get('in')))) {
        // 出社せずに退社はない
        if ( ! is_null($record->get('out'))) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_RECORD_IN);
        }

        // 出社せずに不在記録はない
        if ($record->getNumAbsenceRecors() > 0) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_TIME);
        }

        return true;
    }

    if ( ! is_null(($out = $record->get('out')))) {
        // 出社時刻より退社時刻が過去であることはない
        if ($in->unix_ts > $out->unix_ts) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_RECORD_OUT);
        }
    }

    $absences = $record->listAbsenceRecords();

    // 各不在記録を評価
    foreach (array_keys($absences) as $id) {
        grn_timecard_validate_absence_record($absences[$id], $in, $out);
    }

    $found_no_in = false;

    // 各不在記録の重なりを評価
    foreach (array_keys($absences) as $id) {
        $ts_out = $absences[$id]->get('out');
        $ts_in = $absences[$id]->get('in');

        if (is_null($ts_in)) {
            if ($found_no_in) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_ABSENCES_NO_INTIME);
            }
            $found_no_in = true;
        }

        if ( ! is_null($out)) {
            if (is_null($ts_out)) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_OUT);
            }
            if (is_null($ts_in)) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_IN);
            }
        }

        foreach (array_keys($absences) as $subid) {
            if ($id == $subid) {
                continue;
            }

            grn_timecard_intersect_record($absences[$subid], $ts_out, $ts_in);
        }
    }

    return true;
}

function grn_timecard_intersect_record(& $record, $ts_out, $ts_in)
{
    if (is_null($ts_out)) {
        return false;
    }

    if (is_null(($out = $record->get('out')))) {
        return false;
    }

    $in = $record->get('in');

    if ($ts_in) {
        // 外出時刻の重なりをチェック
        if ($ts_out->unix_ts <= $out->unix_ts
            && $out->unix_ts < $ts_in->unix_ts
        ) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_DUPLICATE_ABSENCE);
        }

        if ($in) {
            // 復帰時刻の重なりをチェック
            if ($ts_out->unix_ts < $in->unix_ts
                && $in->unix_ts <= $ts_in->unix_ts
            ) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_DUPLICATE_ABSENCE);
            }
        }
    } elseif ($in) {
        // 指定された外出時刻の重なりをチェック
        if ($out->unix_ts <= $ts_out->unix_ts
            && $ts_out->unix_ts < $in->unix_ts
        ) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_DUPLICATE_ABSENCE);
        }
    } else {
        if ($out->unix_ts == $ts_out->unix_ts) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_DUPLICATE_ABSENCE);
        }
    }

    return false;
}


function grn_timecard_validate_absence_record(& $record, $ts_in, $ts_out)
{
    if (is_null(($out = $record->get('out')))) {
        if ( ! is_null($record->get('in'))) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_OUT);
        }

        return true;
    }

    // 出社時刻の指定がなく不在記録は存在しない
    if (is_null($ts_in)) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_TIME);
    }

    // 外出時刻は出社時刻より過去であることはない
    if ($out->unix_ts < $ts_in->unix_ts) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_OUT);
    }

    if ( ! is_null(($in = $record->get('in')))) {
        // 復帰時刻は出社時刻より過去であることはない
        if ($in->unix_ts < $ts_in->unix_ts) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_IN);
        }

        // 復帰時刻は外出時刻より過去であることはない
        if ($out->unix_ts > $in->unix_ts) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_IN);
        }

        if ( ! is_null($ts_out)) {
            // 外出時刻は退社時刻より未来であることはない
            if ($out->unix_ts > $ts_out->unix_ts) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_OUT);
            }
            // 復帰時刻は退社時刻より未来であることはない
            if ($in->unix_ts > $ts_out->unix_ts) {
                require_once('timecard/error_code.csp');
                cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_IN);
            }
        }
    } else {
        // 復帰せずに退社することはない
        if ( ! is_null($ts_out)) {
            require_once('timecard/error_code.csp');
            cb_throw_error(E_GRN_TIMECARD_INVALID_ABSENCE_IN);
        }
    }

    return true;
}


