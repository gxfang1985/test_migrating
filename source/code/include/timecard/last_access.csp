<?php
/**
 * @author   Yoshiaki Tanaka
 * @date     2005/05/06
 * @par      Copyright (c) 2004 Cybozu,Inc. All rights reserved .
 * @package  grn.timecard
 */


/**
 * 最終アクセス時刻を更新
 */
function grn_timecard_update_last_access(& $user, $ts = null)
{
    /**
     * セッションとプロファイルの両方に値を保存して
     * 更新しない限りはセッションの値だけを参照する
     */
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('timecard');

    $attr_name = 'last_access_timestamp';

    if ( ! is_null($ts)) {
        // 強制的にタイムスタンプを更新

        $session->set($attr_name, $ts->unix_ts);

        require_once('fw/profile.csp');
        $profile = cb_get_user_profile($user, 'grn.timecard');

        if ( ! $profile->updateAttribute($attr_name, $ts->unix_ts)) {
            $profile->createAttribute($attr_name, $ts->unix_ts);
        }
    } else {
        $last_timestamp = $session->get($attr_name);
        $now = time();
        if ( ! $last_timestamp) {
            // セッションの値が空の場合はプロファイルから値を取得

            require_once('fw/profile.csp');
            $profile = cb_get_user_profile($user, 'grn.timecard');

            if ( ! $profile->getAttribute($attr_name, $last_timestamp)) {
                // 最初のタイムスタンプ更新

                $profile->createAttribute($attr_name, $now);
                $session->set($attr_name, $now);

                return;
            }
            $session->set($attr_name, $last_timestamp);
        }

        $last_timestamp = intval($last_timestamp);

        if ($now > $last_timestamp) {
            // 5分おきにタイムスタンプを更新
            if (($now - $last_timestamp) > (60 * 5)) {
                if ( ! isset($profile)) {
                    require_once('fw/profile.csp');
                    $profile = cb_get_user_profile($user, 'grn.timecard');
                }
                $profile->updateAttribute($attr_name, $now);
                $session->set($attr_name, $now);
            }
        }
    }
}

/**
 * 最終アクセス時刻を取得する
 */
function grn_timecard_get_last_access($user)
{
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('timecard');

    $attr_name = 'last_access_timestamp';

    $last_timestamp = $session->get($attr_name);

    if ( ! $last_timestamp) {
        require_once('fw/profile.csp');
        $profile = cb_get_user_profile($user, 'grn.timecard');

        if ( ! $profile->getAttribute($attr_name, $last_timestamp)) {
            return null;
        }
    }
    $ts = new CB_TimeStamp();
    $ts->unix_ts = intval($last_timestamp);

    return $ts;
}



