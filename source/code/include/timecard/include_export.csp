<?php
/**
 * @author   Yoshiaki Tanaka
 * @date     2005/05/06
 * @par      Copyright (c) 2004 Cybozu,Inc. All rights reserved .
 * @package  grn.timecard
 */


/**
 * 1レコードを書き出す
 */
function grn_timecard_export_record(
    & $writer,
    & $record,
    $absence_max,
    $user_name
) {
    if ( ! $writer || ! $record) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INTERNAL);
    }

    $line = [];

    $user =& $record->get('user');

    $line[] = $user->get('foreign_key');
    $line[] = $user_name;

    require_once('fw/date.csp');
    $line[] = cb_date_format('DateMiddle_YMD', $record->get('date'));

    if (($ts = $record->get('in'))) {
        $line[] = cb_date_format('TimeShort_HM', $ts);
    } else {
        $line[] = '';
    }

    ! is_null($record->get('reserve_text2')) ?
        $line[] = $record->get('reserve_text2') : $line[] = '';

    if (($ts = $record->get('out'))) {
        $line[] = cb_date_format('TimeShort_HM', $ts);
    } else {
        $line[] = '';
    }

    ! is_null($record->get('reserve_text3')) ?
        $line[] = $record->get('reserve_text3') : $line[] = '';

    $absences = $record->listAbsenceRecords();

    for ($i = 0; $i < $absence_max; ++$i) {
        if (count($absences) > 0) {
            $absences_keys = array_keys($absences);
            $first = array_shift($absences_keys);
            $absence =& $absences[$first];

            if (($ts = $absence->get('out'))) {
                $line[] = cb_date_format('TimeShort_HM', $ts);
            } else {
                $line[] = '';
            }

            ! is_null($absence->get('reserve_text3')) ?
                $line[] = $absence->get('reserve_text3') : $line[] = '';

            if (($ts = $absence->get('in'))) {
                $line[] = cb_date_format('TimeShort_HM', $ts);
            } else {
                $line[] = '';
            }

            ! is_null($absence->get('reserve_text2')) ?
                $line[] = $absence->get('reserve_text2') : $line[] = '';

            unset($absences[$first]);
        } else {
            $line[] = '';
            $line[] = '';
            $line[] = '';
            $line[] = '';
        }
    }

    $line[] = $record->get('description');

    $writer->writeLine($line);
}

/**
 * ユーザーの1ヶ月分の記録を書き出す
 */
function grn_timecard_export_csv(
    & $user,
    & $writer,
    $start_date_param = null,
    $end_date_param = null
) {
    $start_date = clone $start_date_param;
    $end_date = clone $end_date_param;

    if ( ! $user || ! $writer) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INTERNAL);
    }

    require_once('timecard/functions.csp');
    if (is_null(($start_date = grn_timecard_convert2date($start_date)))) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INTERNAL);
    }

    if (is_null($end_date)) {
        $end_date = $start_date;
        $end_date->moveMonths(1);
    }

    require_once('timecard/list.csp');
    $records = grn_timecard_list_records($user, $start_date, $end_date);

    require_once('timecard/config.csp');
    $config = GRN_Timecard_SystemConfig::getInstance();

    $absence_max = $config->getAbsenceMax();
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $login_user_id = $login->getOID();
    require_once("grn/controller.csp");
    $user_info = [
        'col_display_name'          => 'display_name',
        'col_valid'                 => 'valid',
        'col_display_name_language' => 'display_name_language',
        'col_nickname'              => 'nickname',
        'col_position'              => 'position',
        'col_foreign_key'           => 'foreign_key'
    ];
    foreach ($user_info as $col => $val) {
        $user_info[$col] = $user->get($val);
    }
    $user_name = $uum->getNameOf($login, $user_info, true);
    $blank_line = [];
    $blank_line[] = $user->get('foreign_key');
    $blank_line[] = $user_name;
    $blank_line[] = ''; // 日付
    $blank_line[] = ''; // 出社
    $blank_line[] = ''; // 出社IPアドレス
    $blank_line[] = ''; // 退社
    $blank_line[] = ''; // 退社IPアドレス

    for ($i = 0; $i < $absence_max; ++$i) {
        $blank_line[] = ''; // 外出
        $blank_line[] = ''; // 外出IPアドレス
        $blank_line[] = ''; // 復帰
        $blank_line[] = ''; // 復帰IPアドレス
    }
    $blank_line[] = ''; // 備考

    while ($start_date->compare($end_date) < 0) {
        $key = $start_date->format();

        if (array_key_exists($key, $records)) {
            grn_timecard_export_record($writer, $records[$key], $absence_max,
                $user_name);
        } else {
            $blank_line[2] = cb_date_format('DateMiddle_YMD', $start_date);
            $writer->writeLine($blank_line);
        }
        $start_date->moveDays(1);
    }
}


