<?php
/**
 * @author   Yoshiaki Tanaka
 * @date     2005/05/06
 * @par      Copyright (c) 2004 Cybozu,Inc. All rights reserved .
 * @package  grn.timecard
 */


/**
 * 指定日付の間で記録をリストアップする
 */
function grn_timecard_list_records(
    & $user,
    $start_date = null,
    $end_date = null
) {
    if ( ! is_a($user, 'CB_User')) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INTERNAL);
    }

    require_once('timecard/functions.csp');

    if (is_null(($start_date = grn_timecard_convert2date($start_date)))) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INTERNAL);
    }

    if (is_null($end_date)) {
        $end_date = clone $start_date;
        $end_date->moveMonths(1);
    }

    if ($start_date->compare($end_date) >= 0) {
        return [];
    }

    $table = cb_class2table('GRN_Timecard_Record');
    //for escape
    $db = $table->getDBConnection();
    $rowset = new CB_RowSet($table);

    $conditions = [];
    //escape!
    $conditions[] = 'col_user = \'' . $db->escape($user->getOID()) . '\'';
    $conditions[] = 'col_date >= \'' . $db->escape($start_date->format())
                    . '\'';
    $conditions[] = 'col_date < \'' . $db->escape($end_date->format()) . '\'';

    $rowset->addCondition(implode(' AND ', $conditions));
    $rowset->addOrderColumn('col_date');

    $records = [];

    while ( ! is_null(($row = $rowset->iterate()))) {
        $rd = $row->get('date');
        $records[$rd->format()] = $row;
    }

    return $records;
}


