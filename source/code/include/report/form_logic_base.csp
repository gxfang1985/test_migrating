<?php
/**
 * Report Application Form Base Class
 *
 * @date    2009/9
 * @version 1.0
 * @package grn.report
 */

/** Report Application **/
require_once('report/resources.csp');

/**
 * Form Logic Base Class
 *
 * @package grn.report
 */
class GRN_Report_Form_Logic_Base
{
    //Form Manager Base Instance
    var $_form_manager_base = null;

    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {

    }

    private static $_instance = null;

    /**
     * Get Instance
     *
     * @return GRN_Report_Form_Logic_Base
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get Form Manager Base
     *
     * @return object $form_manager_base         //Form Manager Base
     */
    function _getFormManagerBase()
    {
        if (is_null($this->_form_manager_base)) {
            require_once('report/form_manager_base.csp');
            $this->_form_manager_base
                = GRN_Report_Form_Manager_Base::getInstance();
        }

        return $this->_form_manager_base;
    }

    /**
     * Get Column List
     *
     * @param  string $class_name //Class Name
     *
     * @return array  $column_name_list          //Column Name List
     */
    function getColumnList($class_name = null)
    {
        //Check Class Name
        $column_prefix = null;
        if (is_null($class_name)) {
            //Default Class Name and Table Name
            $class_name = GRN_REPORT_TABLE_FORM;
        } else {
            //Set Column Prefix
            switch ($class_name) {
                case GRN_REPORT_TABLE_FORM:
                    $column_prefix = "f";
                    break;
                case GRN_REPORT_TABLE_ITEM:
                    $column_prefix = "i";
                    break;
            }
        }

        //Get Column List
        $column_name_list
            =& GRN_Report_Table_Manager::getColumnList($class_name,
            $column_prefix, true);

        //Return Column Name List
        return $column_name_list;
    }

    /**
     * Get Form
     *
     * @param  int   $form_id     //Form ID
     * @param  int   $category_id //Category ID
     * @param  array $column_list //Column List
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $form                      //Form Information Array
     */
    function &get(
        $form_id,
        $category_id = null,
        $column_list = [],
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Argument
        require_once('fw/string_util.csp');
        require_once('report/error_code.csp');
        cb_trim_check($form_id, E_GRN_RPRT_FORM_INVALID_ID);    //Form ID

        //Get Form 
        $form_manager_base = $this->_getFormManagerBase();
        $form =& $form_manager_base->get($form_id, $category_id,
            $column_list, $option, $refresh, $lock_mode);
        if ( ! $form) {
            //Form Not Found
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FORM_NOT_FOUND);
        }

        //Return Form
        return $form;
    }

    /**
     * Get Form(with Extra Information)
     *
     * @param  int   $form_id     //Form ID
     * @param  int   $category_id //Category ID
     * @param  array $column_list //Column List
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $form                      //Form Information Array
     */
    function &getEx(
        $form_id,
        $category_id = null,
        $column_list = [],
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Argument
        require_once('fw/string_util.csp');
        require_once('report/error_code.csp');
        cb_trim_check($form_id, E_GRN_RPRT_FORM_INVALID_ID);    //Form ID

        //Get Form 
        $form_manager_base =& $this->_getFormManagerBase();
        $form =& $form_manager_base->getEx($form_id, $category_id,
            $column_list, $option, $refresh, $lock_mode);
        if ( ! $form) {
            //Form Not Found
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FORM_NOT_FOUND);
        }

        //Return Form
        return $form;
    }

    /**
     * Get Form Direct
     *
     * @param  int   $form_id     //Form ID
     * @param  array $column_list //Column List
     * @param  mixed $option      //Option (array('condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $form                      //Form Information Array
     */
    function getDirect(
        $form_id,
        $column_list = [],
        $option = [],
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Argument
        require_once('fw/string_util.csp');
        require_once('report/error_code.csp');
        cb_trim_check($form_id, E_GRN_RPRT_FORM_INVALID_ID);    //Form ID

        //Get Form 
        $form_manager_base = $this->_getFormManagerBase();
        $form = $form_manager_base->getDirect($form_id,
            $column_list, $option, $lock_mode);

        if ( ! $form) {
            //Form Not Found
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FORM_NOT_FOUND);
        }

        //Return Form
        return $form;
    }

    /**
     * Get Form List
     *
     * @param  int   $category_id //Category ID
     * @param  array $column_list //Column List
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $form_list                 //Form Information List
     */
    function &getList(
        $category_id = null,
        $column_list = [],
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Form List
        $form_manager_base = $this->_getFormManagerBase();
        $form_list =& $form_manager_base->getList($category_id,
            $column_list, $option, $refresh, $lock_mode);

        //Return Form List
        return $form_list;
    }

    /**
     * Get Form List (with Extra Information)
     *
     * @param  int   $category_id //Report ID
     * @param  array $column_list //Column List
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $form_list                 //Form Information List
     */
    function &getListEx(
        $category_id = null,
        $column_list = [],
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Form List
        $form_manager_base =& $this->_getFormManagerBase();
        $form_list =& $form_manager_base->getListEx($category_id,
            $column_list, $option, $refresh, $lock_mode);

        //Return Form List
        return $form_list;
    }

    /**
     * Get Form Count
     *
     * @param  int   $category_id //Category ID
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return int    $form_count                //Form Count
     */
    function getCount(
        $category_id = null,
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Form List
        $form_manager_base = $this->_getFormManagerBase();
        $form_count = $form_manager_base->getCount($category_id, $option,
            $refresh, $lock_mode);

        //Return Form Count
        return $form_count;
    }

    /**
     * Get Form Count(with Extra Information)
     *
     * @param  int   $category_id //Category ID
     * @param  mixed $option      //Option (array('list'=>array('offset'=>'', 'limit'=>''), 'sort'=>array('column'=>'', 'order'=>''), 'condition'=>array('column'=>'', 'value'=>'', 'operator'=>''))
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return int    $form_count                //Form Count
     */
    function getCountEx(
        $category_id = null,
        $option = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Form List
        $form_manager_base =& $this->_getFormManagerBase();
        $form_count = $form_manager_base->getCountEx($category_id,
            $option, $refresh, $lock_mode);

        //Return Form Count
        return $form_count;
    }
}


