<?php
/**
 * Report Application File Relation Base Class
 *
 * @date    2009/10
 * @version 1.0
 * @package grn.report
 */

/** Report Application **/
require_once('report/resources.csp');

/**
 * File Relation Logic Base Class
 *
 * @package grn.report
 */
class GRN_Report_FileRelation_Logic_Base
{
    //File Relation Manager Base Instance
    var $_file_relation_manager_base = null;

    /**
     * Constructor
     *
     * @return none
     */
    function __construct()
    {

    }

    private static $_instance = null;

    /**
     * Get Instance
     *
     * @return GRN_Report_FileRelation_Logic_Base
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get File Relation Manager Base
     *
     * @return object $item_data_file_manager_base         //File Relation Manager Base
     */
    function _getFileRelationManagerBase()
    {
        if (is_null($this->_file_relation_manager_base)) {
            require_once('report/filerelation_manager_base.csp');
            $this->_file_relation_manager_base
                = GRN_Report_FileRelation_Manager_Base::getInstance();
        }

        return $this->_file_relation_manager_base;
    }

    /**
     * Get Column List
     *
     * @param  none
     *
     * @return array  $column_name_list          //Column Name List
     */
    function getColumnList()
    {
        //Get Column List
        $column_name_list
            =& GRN_Report_Table_Manager::getColumnList(GRN_REPORT_TABLE_FILERELATION);

        //Return Column Name List
        return $column_name_list;
    }

    /**
     * Get File
     *
     * @param  int   $type        //Attach Type (Follow or ItemData)
     * @param  int   $file_id     //File ID
     * @param  int   $data_id     //Data ID
     * @param  array $column_list //Column List
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $file            //Item Data File Information Array
     */
    function &get(
        $type,
        $file_id,
        $data_id = null,
        $column_list = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Argument
        require_once('fw/string_util.csp');
        require_once('report/error_code.csp');
        cb_trim_check($file_id, E_GRN_RPRT_FILERELATION_INVALID_ID);  //File ID

        //Get File 
        $file_relation_manager_base = $this->_getFileRelationManagerBase();
        $file =& $file_relation_manager_base->get($type,
            $file_id, $data_id, $column_list, $refresh, $lock_mode);
        if ( ! $file) {
            //File Not Found
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FILERELATION_NOT_FOUND);
        }

        //Return Item Data File
        return $file;
    }

    /**
     * Get File Direct
     *
     * @param  int   $file_id     //File ID
     * @param  array $column_list //Column List
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $item_data_file  //File Information Array
     */
    function getDirect(
        $file_id,
        $column_list = [],
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Argument
        require_once('fw/string_util.csp');
        require_once('report/error_code.csp');
        cb_trim_check($file_id,
            E_GRN_RPRT_FILERELATION_INVALID_ID);    //File ID

        //Get File 
        $file_relation_manager_base =& $this->_getFileRelationManagerBase();
        $file
            = $file_relation_manager_base->getDirect($file_id,
            $column_list, $lock_mode);
        if ( ! $file) {
            //File Not Found
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FILERELATION_NOT_FOUND);
        }

        //Return File
        return $file;
    }

    /**
     * Get File List
     *
     * @param  int   $type        //Attach Type (Follow or ItemData)
     * @param  int   $data_id     //Data ID
     * @param  array $column_list //Column List
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $file_list       //File Information List
     */
    function &getList(
        $type,
        $data_id = null,
        $column_list = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get File List
        $file_relation_manager_base = $this->_getFileRelationManagerBase();
        $file_list
            =& $file_relation_manager_base->getList($type,
            $data_id, $column_list, $refresh, $lock_mode);

        //Return File List
        return $file_list;
    }

    /**
     * Get File Count
     *
     * @param  int  $type      //Attach Type (Follow or ItemData)
     * @param  int  $data_id   //Data ID
     * @param  bool $refresh   //Refresh Cache
     * @param  int  $lock_mode //Lock Mode
     *
     * @return int    $item_data_file_count //File Count
     */
    function getCount(
        $type,
        $data_id = null,
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Item Data File List
        $file_relation_manager_base =& $this->_getFileRelationManagerBase();
        $file_count
            = $file_relation_manager_base->getCount($type,
            $data_id, $refresh, $lock_mode);

        //Return Item Data File Count
        return $file_count;
    }

    function getListByFollowIdList(
        $follow_id_list,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        $file_relation_manager_base = $this->_getFileRelationManagerBase();
        $file_list
            = $file_relation_manager_base->getListByFollowIdList($follow_id_list,
            $lock_mode);

        return $file_list;
    }

    /**
     * Get Item Data File Count of Report
     *
     * @param  int  $report_id //Report ID
     * @param  bool $refresh   //Refresh Cache
     * @param  int  $lock_mode //Lock Mode
     *
     * @return int    $item_data_file_count //File Count
     */
    function getTotalItemDataFileCount(
        $report_id,
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Count of Item Data File
        $file_relation_manager_base = $this->_getFileRelationManagerBase();
        $count
            = $file_relation_manager_base->getTotalItemDataFileCount($report_id,
            $refresh, $lock_mode);

        return $count;
    }
}


