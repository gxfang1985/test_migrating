<?php

require_once('developer/azunit.csp');
require_once('report/item_logic_base.csp');
require_once('report/table_manager.csp');

class test_grn_report_item_logic_base extends CB_TestCase
{
    /** database **/
    var $_database = null;

    /** table_name **/
    var $_table_name = null;

    /** Test Target List **/
    var $_item_list = null;

    /** Unique key **/
    var $_unique_key = null;

    /** Basic Value List **/
    var $_item_value_list = [];

    /**
     * Constructor
     *
     * @access private
     *
     * @param string $test_method //Test Method Name
     */
    function test_grn_report_item_logic_base($test_method)
    {
        //Initialize Parent Class
        parent::CB_TestCase($test_method);

        //Initalize Randam Key
        mt_srand(time());

        //Initialize Unique Key
        $this->_unique_key = $test_method . time();

        //Get Database Connection
        global $G_container_base;
        $this->_database =& $G_container_base->getInstance('dbconn');

        //Set table name
        $this->_table_name = 'tab_grn_report_item';

        //Set Basic Value List
        $this->_item_value_list = [
            'col_foreign_key' => 'foreign_key_',
            'col_list_index'  => '',
        ];

        return;
    }

    /**
     * Initialize Test
     *
     * @access private
     */
    function _initialize()
    {
        //Get Unique Key
        $unique_key = $this->_unique_key;

        //Create Test Item
        $this->_createItem($unique_key);

        return;
    }

    /**
     * finalize Test
     *
     * @access private
     */
    function _finalize()
    {
        //Delete Test Item
        $this->_deleteItem();

        return;
    }

    /**
     * Create Item
     *
     * @access private
     *
     * @param string $unique_key //Unique key
     */
    function _createItem($unique_key)
    {
        for ($i = 0; $i < 5; $i++) {
            //Create Query
            $item_value_list = [];
            foreach ($this->_item_value_list as $key => $value) {
                if (strlen($value) > 0) {
                    $item_value_list[$key] = cb_queryf($this->_database,
                        '"@S@S"', $value, $i);
                } else {
                    $item_value_list[$key] = cb_queryf($this->_database, '"@S"',
                        $i);
                }
            }
            $column_string = implode(',', array_keys($item_value_list));
            $value_string = implode(',', $item_value_list);
            $query = sprintf('INSERT %s(%s) VALUES (%s)',
                $this->_table_name, $column_string, $value_string);

            //Execute Query
            $result = $this->_database->query($query);
            if ($result === false) {
                //Throw Query Error
                $this->_database->throwError([
                    'query' => 'query failed: ' . $query
                ]);
            }

            //Add Cache
            $item_id = $this->_database->get_insert_id();
            foreach (array_keys($item_value_list) as $key) {
                $this->_item_list[$item_id][$key] = mb_ereg_replace('"', '',
                    $item_value_list[$key]);
            }
        }

        return;
    }

    /**
     * Delete Item
     *
     * @access private
     *
     * @param string $unique_key //Unique key
     */
    function _deleteItem()
    {
        //Create Query
        $where_string = cb_queryf($this->_database, '_id IN (@S)',
            implode(',', array_keys($this->_item_list)));
        $query = sprintf('DELETE FROM %s WHERE %s', $this->_table_name,
            $where_string);

        //Execute Query
        $result = $this->_database->query($query);
        if ($result === false) {
            //Throw Query Error
            $this->_database->throwError([
                'query' => 'query failed: ' . $query
            ]);
        }

        //Delete Cache
        $this->_item_list = [];

        return;
    }

    /**
     * Validate Item
     *
     * @access  private
     *
     * @param  int $item_id        //Item ID
     * @param  int $validate_props //Validate Properties
     *
     * @return BOOL                              //Validate Result
     */
    function _validateItem($item_id, $validate_props)
    {
        //Get Link From Table
        $item =& $this->_item_list[$item_id];

        //Validate Properties
        foreach ($validate_props as $prop_name => $prop_value) {
            //Check Assertion
            if (strval($item[$prop_name]) !== strval($prop_value)) {
//                var_dump($item[$prop_name]);
//                var_dump($prop_value);
//                die();

                //Finalize Test
                $this->_finalize();
                assert('strval($item[$prop_name]) === strval($prop_value)');
            }
        }

        return true;
    }

    /**
     * Get Item
     *
     * @access  private
     * @return BOOL                  //Validate Result
     */
    function test_get()
    {
        //Initialize Test
        $this->_initialize();

        //Get Item Logic Base Instance
        $logic = GRN_Report_Item_Logic_Base::getInstance();

        //Test Item List
        $item_list =& $this->_item_list;
        foreach (array_keys($item_list) as $item_id) {
            //Get item
            $item = $logic->get($item_id);

            //Create Validate Properties
            $validate_props = [];
            $item_value_list =& $this->_item_value_list;
            foreach (array_keys($item_value_list) as $item_name) {
                $validate_props[$item_name] = $item[$item_name];
            }

            //Validate Item
            $this->_validateItem($item_id, $validate_props);
        }

        //Finalize Test
        $this->_finalize();

        return true;
    }

    /**
     * Get Item List
     *
     * @access  private
     * @return BOOL                  //Validate Result
     */
    function test_getList()
    {
        //Initialize Test
        $this->_initialize();

        //Get Item Logic Base Instance
        $logic = GRN_Report_Item_Logic_Base::getInstance();

        //Test Item List
        $item_list =& $logic->getList();

        foreach (array_keys($item_list) as $item_id) {
            //Get Item
            $item =& $item_list[$item_id];

            if (strpos($item['col_foreign_key'], 'grn.report') == 0) {
                continue;
            }

            //Create Validate Properties
            $validate_props = [];
            $item_value_list =& $this->_item_value_list;
            foreach (array_keys($item_value_list) as $item_name) {
                $validate_props[$item_name] = $item[$item_name];
            }

            //Validate Item
            $this->_validateItem($item_id, $validate_props);
        }

        //Finalize Test
        $this->_finalize();

        return true;
    }

    /**
     * Get Item Count
     *
     * @access  private
     * @return BOOL                  //Validate Result
     */
    function test_getCount()
    {
        //Initialize Test
        $this->_initialize();

        //Get Item Logic Base Instance
        $logic = GRN_Report_Item_Logic_Base::getInstance();

        //Test Item Count
        $item_count = $logic->getCount();

        //Validate Item Count
        assert('$item_count == count($this->_item_list)');

        //Finalize Test
        $this->_finalize();

        return true;
    }
}

cb_test_run();

?>
