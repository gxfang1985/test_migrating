<?php
/**
 * Report Application File Relation Base Class
 *
 * @dat     2009/10
 * @version 1.0
 * @package grn.report
 */

/** Report Application **/
require_once('report/resources.csp');
require_once('grn/application.csp');

/**
 * File Relation Manager Base Class
 *
 * @package grn.report
 */
class GRN_Report_FileRelation_Manager_Base
{
    /** Table Name **/
    var $_table_name = null;

    /** File List **/
    var $_list = [];

    /**
     * Constructor
     *
     * @return void
     */
    function __construct()
    {
        $this->_table_name = 'tab_grn_report_filerelation';
    }

    /**
     * Get Instance
     *
     * @return object $instance                  //Instance of GRN_Report_FileRelation_Manager_Base
     */
    private static $_instance = null;

    /**
     * @return GRN_Report_FileRelation_Manager_Base
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get File Relation Direct
     *
     * @param  int   $file_id     //File ID
     * @param  array $column_list //Column List
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $file                  //File Relation Information Array
     */
    function getDirect(
        $file_id,
        $column_list = [],
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        $file = [];

        //Get Database
        $database =& GRN_Report_Table_Manager::getDataBase();

        //Create Column List
        if (count($column_list) === 0) {
            $column_list = implode(',',
                GRN_Report_Table_Manager::getColumnList(GRN_REPORT_TABLE_FILERELATION));
        } else {
            $column_list = implode(',', $column_list);
        }

        //Create Condition
        $condition_list = [];
        $condition_list[] = cb_queryf($database, "_id = '@S'", $file_id);
        $condition = implode(' AND ', $condition_list);
        if ($condition) {
            $condition = 'WHERE ' . $condition;
        }

        //Create Order By Column
        $order_by = 'ORDER BY _id';

        //Create Query
        $query = sprintf('SELECT %s FROM %s %s %s', $column_list,
            $this->_table_name, $condition, $order_by);
        $query = $database->select_format($query, 0, 1, $lock_mode);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Get File Relation
        $file = $database->fetch_assoc($result);
        $database->free_result($result);

        //Return File Relation
        return $file;
    }

    /**
     * Get File
     *
     * @param  int      $type        //Attach Type(Follow or ItemData)
     * @param  int      $file_id     //File ID
     * @param  int      $data_id     //Data ID
     * @param  array    $column_list //Column List
     * @param  bool|int $refresh     //Lock Mode
     * @param  int      $lock_mode   //Lock Mode
     *
     * @return array  $file            //File Information Array
     */
    function &get(
        $type,
        $file_id,
        $data_id = null,
        $column_list = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get File List
        $file_list =& $this->getList($type, $data_id, $column_list, $refresh,
            $lock_mode);

        //Get File
        if ( ! array_key_exists($file_id, $file_list)) {
            $ret = false;

            return $ret;
        }

        //Return File
        return $file_list[$file_id];
    }

    /**
     * Get File List
     *
     * @param  int   $type        //Attach Type (Follow or ItemData)
     * @param  int   $data_id     //Data ID
     * @param  array $column_list //Column List
     * @param  bool  $refresh     //Refresh Cache
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $file_list            //File Information List
     */
    function &getList(
        $type,
        $data_id = null,
        $column_list = [],
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        $file_list = [];

        //Check Arguments
        $data_id = is_null($data_id) ? 0 : $data_id;

        //Get File List From Cache
        $cached = false;
        if ( ! $refresh) {
            if (array_key_exists($data_id, $this->_list)) {
                if (is_array($this->_list[$data_id])) {
                    $file_list =& $this->_list[$data_id];
                    $cached = true;
                }
            }
        } else {
            $this->_list[$data_id] = [];
        }

        //Get File List From Database
        if ( ! $cached || $refresh) {
            //Get Database
            $database = GRN_Report_Table_Manager::getDataBase();

            //Create Column List
            if (count($column_list) === 0) {
                $column_list = implode(',',
                    GRN_Report_Table_Manager::getColumnList(GRN_REPORT_TABLE_FILERELATION));
            } else {
                $column_list = implode(',', $column_list);
            }

            //Create Condition
            $condition_list = [];
            if ($data_id != 0) {
                if ($type == GRN_REPORT_FOLLOW_FILE) {
                    $condition_list[] = cb_queryf($database,
                        'col_follow = "@S"', $data_id);
                } elseif ($type == GRN_REPORT_ITEM_DATA_FILE) {
                    $condition_list[] = cb_queryf($database,
                        'col_item_data = "@S"', $data_id);
                } else {
                    return false;
                }
            }
            $condition = implode(' AND ', $condition_list);
            if ($condition) {
                $condition = 'WHERE ' . $condition;
            }

            //Create Order By Column
            $order_by = 'ORDER BY _id';

            //Create Query
            $query = sprintf('SELECT %s FROM %s %s %s', $column_list,
                $this->_table_name, $condition, $order_by);
            $query = $database->select_format($query, 0, -1, $lock_mode);

            //Execute Query
            $result = $database->query($query);
            if ($result === false) {
                //Throw Query Error
                $database->throwError(['query' => 'query failed: ' . $query]);
            }

            //Update File List
            $count = $database->num_rows($result);
            for ($i = 0; $i < $count; $i++) {
                $row = $database->fetch_assoc($result);
                $this->_list[$data_id][$row['_id']] = $row;
            }
            $database->free_result($result);

            if ($count > 0) {
                $file_list =& $this->_list[$data_id];
            }
        }

        //Return File List
        return $file_list;
    }

    /**
     * Get File Count
     *
     * @param  int  $type      //Attach Type (Follow or ItemData)
     * @param  int  $data_id   //Data ID
     * @param  bool $refresh   //Refresh Cache
     * @param  int  $lock_mode //Lock Mode
     *
     * @return int    $file_count           //File Count
     */
    function getCount(
        $type,
        $data_id = null,
        $refresh = false,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get Database
        $database =& GRN_Report_Table_Manager::getDataBase();

        //Create Condition
        $condition_list = [];
        if ( ! is_null($data_id)) {
            if ($type == GRN_REPORT_FOLLOW_FILE) {
                $condition_list[] = cb_queryf($database, 'col_follow = "@S"',
                    $data_id);
            } elseif ($type == GRN_REPORT_ITEM_DATA_FILE) {
                $condition_list[] = cb_queryf($database, 'col_item_data = "@S"',
                    $data_id);
            } else {
                return false;
            }
        }
        $condition = implode(' AND ', $condition_list);
        if ($condition) {
            $condition = 'WHERE ' . $condition;
        }

        //Create Query
        $query = sprintf('SELECT COUNT(*) FROM %s %s', $this->_table_name,
            $condition);
        $query = $database->select_format($query, 0, -1, $lock_mode);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }
        $row = $database->fetch_assoc($result);
        $database->free_result($result);

        //Return File Count
        return $row['COUNT(*)'];
    }

    function getListByFollowIdList(
        $follow_id_list,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        if ( ! $follow_id_list || count($follow_id_list) == 0) {
            return [];
        }

        //Get Database
        $database = GRN_Report_Table_Manager::getDataBase();

        $query = " SELECT"
                 . " col_follow,col_file,_id "
                 . " FROM "
                 . " tab_grn_report_filerelation "
                 . " WHERE "
                 . " col_follow in (" . cb_queryf($database, "@S",
                implode(',', $follow_id_list)) . ")";
        $query = $database->select_format($query, 0, -1, $lock_mode);

        $follow_file_list = [];

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        //Update File List
        $count = $database->num_rows($result);
        for ($i = 0; $i < $count; $i++) {
            $row = $database->fetch_assoc($result);
            $follow_file_list[$row['col_follow']][$row['_id']] = $row;
        }
        $database->free_result($result);

        return $follow_file_list;
    }

    function getTotalItemDataFileCount($report_id, $refresh, $lock_mode)
    {
        //Get Database
        $database = GRN_Report_Table_Manager::getDataBase();

        //Create Condition
        $condition = cb_queryf($database,
            "WHERE col_report = '@S' AND col_item_data IS NOT NULL",
            $report_id);

        //Create Query
        $query = sprintf('SELECT COUNT(*) FROM %s %s', $this->_table_name,
            $condition);
        $query = $database->select_format($query, 0, -1, $lock_mode);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }
        $row = $database->fetch_assoc($result);
        $database->free_result($result);

        //Return File Count
        return $row['COUNT(*)'];
    }

    /**
     * Get list of all report follow files
     *
     * @param  array $report_id   //Data ID
     * @param  array $column_list //Column List
     * @param  int   $lock_mode   //Lock Mode
     *
     * @return array  $file_list            //File Information List
     */
    function &getListByReportIdList(
        $report_id_list = [],
        $column_list = [],
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Check Arguments
        if ( ! is_array($report_id_list) || count($report_id_list) == 0) {
            return [];
        }

        $file_list = [];

        //Get File List From Database
        $database = GRN_Report_Table_Manager::getDataBase();

        //Create Column List
        if (count($column_list) === 0) {
            $column_list = implode(',',
                GRN_Report_Table_Manager::getColumnList(GRN_REPORT_TABLE_FILERELATION));
        } else {
            $column_list = implode(',', $column_list);
        }

        //Create Condition
        $condition_list = [];
        $condition_list[] = cb_queryf($database, 'col_report IN ( @A )',
            $report_id_list);
        $condition_list[] = cb_queryf($database, 'col_follow IS NOT NULL');
        $condition = implode(' AND ', $condition_list);
        if ($condition) {
            $condition = 'WHERE ' . $condition;
        }

        //Create Order By Column
        $order_by = 'ORDER BY _id';

        //Create Query
        $query = sprintf('SELECT %s FROM %s %s %s', $column_list,
            $this->_table_name, $condition, $order_by);
        $query = $database->select_format($query, 0, -1, $lock_mode);

        //Execute Query
        $result = $database->query($query);
        if ($result === false) {
            //Throw Query Error
            $database->throwError(['query' => 'query failed: ' . $query]);
        }

        $count = $database->num_rows($result);
        for ($i = 0; $i < $count; $i++) {
            $row = $database->fetch_assoc($result);
            $file_list[$row['_id']] = $row;
        }
        $database->free_result($result);

        //Return File List
        return $file_list;
    }
}
