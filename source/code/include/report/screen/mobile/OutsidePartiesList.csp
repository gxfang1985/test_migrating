<?php

namespace grn\report\screen\mobile;

use grn\grn\access\service\AppAccess;
use grn\grn\Validate;

class OutsidePartiesList extends MobileReportScreenBase
{
    private $_is_from_ajax;

    public function __construct($input)
    {
        parent::__construct($input);

        $this->setMobileFooterBar();
    }

    public function fetch()
    {
        $input = $this->getInput();
        $this->checkArgFromInput([self::ARG_REPORT_ID], $input);
        $user_id = $this->getLoginUserId();
        $report_id = $this->getReportId();
        require_once('report/controller_util.csp');
        if ( ! (\GRN_Report_Report_Controller_Utility::getInstance()
                                                     ->isViewable($user_id,
                                                         $report_id))
        ) {
            cb_throw_error(E_GRN_RPRT_REPORT_DENY_ACCESS);
        }
        $partners = $this->getReportPartners($report_id);
        $limit = self::MORE_VIEW_COUNT;
        $offset = $this->getArrayValue(self::ARG_NAVI_TAG, $input);
        if ( ! Validate::isNumber($offset)) {
            $offset = 0;
        }
        $loop_times = count($partners) >= ($limit + $offset) ? ($limit
                                                                + $offset)
            : count($partners);
        $display_partners = array_slice($partners, 0, $loop_times);
        $this->setNewOffset($offset, $limit, count($partners));
        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();
        $t->assign('count', count($partners));
        $t->assign('partners', $display_partners);
        require_once('report/address_util.csp');
        $t->assign('address_available',
            $address_available = \GRN_ReportAddressUtil::isAddressAvailable());
        $t->assign('address_available_for_external',
            AppAccess::isAppAvailableExternalAccess('address'));
        if ($this->_is_from_ajax) {
            return $t->fetch('report/mobile/outside_parties_list.tpl');
        } else {
            //set the navigation bar
            $this->assignBreadcrumbUpperPage($t,
                cb_msg('grn.mobile', 'detail_title'), 'report/mobile/view',
                [self::ARG_REPORT_ID => $report_id]);
            $this->assignBreadcrumbCurrentPage($t,
                cb_msg('grn.report', 'outside_parties'));

            $t->assign('offset', $this->getNewOffset());
            $t->assign('more_view_args', [self::ARG_REPORT_ID => $report_id]);

            return $t->fetch('report/mobile/outside_parties_index.tpl');
        }
    }

    public function getIsFromAjax()
    {
        return $this->_is_from_ajax;
    }

    public function setIsFromAjax($value)
    {
        $this->_is_from_ajax = $value;
    }

    public function getTitle()
    {
        return $this->getReportTitle() . ' - ' . cb_msg('grn.report',
                'outside_parties');
    }
}
