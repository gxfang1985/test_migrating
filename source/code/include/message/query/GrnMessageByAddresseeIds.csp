<?php
require_once("message/table_utility.csp");
require_once("grn/GrnAbstractQuery.csp");

class GrnMessageByAddresseeIds extends GrnAbstractQuery
{
    /** @var $databaseConnection CB_DatabaseConnection */
    private $databaseConnection;

    /**
     * @param $datbaseConnection CB_DatabaseConnection
     */
    public function setDatabaseConnection($datbaseConnection)
    {
        $this->databaseConnection = $datbaseConnection;
    }

    /**
     * @return CB_DatabaseConnection
     */
    public function getDatabaseConnection()
    {
        return $this->databaseConnection;
    }

    private $userIdList;

    public function setUserIdList($userIdList)
    {
        $this->userIdList = $userIdList;
    }

    public function getUserIdList()
    {
        return $this->userIdList;
    }

    /**
     *
     * @reurn string
     */
    protected function getUserIdListCsv()
    {
        if (count($this->getUserIdList()) == 0) {
            return false;
        }
        $databaseConnection = $this->getDatabaseConnection();
        $escapedUserIdList = [];
        foreach ($this->getUserIdList() as $cateogryId) {
            $escapedUserIdList[] = "'"
                                   . $databaseConnection->escape($cateogryId)
                                   . "'";
        }

        return implode(",", $escapedUserIdList);
    }

    /** @var string */
    private $startTimestamp;

    public function setStartTimestamp($startTimestamp)
    {
        $this->startTimestamp = $startTimestamp;
    }

    public function getStartTimestamp()
    {
        return $this->startTimestamp;
    }

    /** @var string */
    private $endTimestamp;

    public function setEndTimestamp($endTimestamp)
    {
        $this->endTimestamp = $endTimestamp;
    }

    public function getEndTimestamp()
    {
        return $this->endTimestamp;
    }

    public function getQuery()
    {
        $db = $this->getDatabaseConnection();

        $query = "SELECT DISTINCT tab_grn_message_messages._id AS _id"
                 . " FROM "
                 . "(tab_grn_message_messages "
                 . " INNER JOIN tab_grn_message_addressees AS a "
                 . " ON tab_grn_message_messages._id = a.col_message "
                 . " AND a.col_addressee in ({$this->getUserIdListCsv()}) "
                 . " AND tab_grn_message_messages.col_last_mtime >= '{$db->escape($this->getStartTimestamp())}' "
                 . " AND tab_grn_message_messages.col_last_mtime <= '{$db->escape($this->getEndTimestamp())}' "
                 . " AND tab_grn_message_messages.col_message_type = '0') "
                 . " INNER JOIN tab_cb_user AS u ON a.col_addressee = u._id AND u.col_deleted IS NULL LIMIT 0, 18446744073709551615;";

        return $query;
    }
}
