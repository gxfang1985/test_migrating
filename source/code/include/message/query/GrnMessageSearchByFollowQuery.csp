<?php
require_once("message/query/GrnMessageAbstractSearchQuery.csp");

class GrnMessageSearchByFollowQuery extends GrnMessageAbstractSearchQuery
{
    public function getQuery()
    {
        $db = $this->getDatabaseConnection();

        $result
            = "SELECT
            m._id mid, f._id fid
        FROM
            tab_grn_message_messages m,
            {$this->getUserTableName('tab_grn_message_foldermessagerelations')} r,
            tab_grn_message_folders h,
            tab_grn_message_follows f
        WHERE
            h._id = r.col_folder
            AND
            f.col_message = r.col_message
        ";

        if ( ! is_null($this->getKeyword())) {
            $result .= " AND {$this->queryf( "f.col_data LIKE '%@L%' ", [$this->getKeyword()])} ";
        }

        $categoryListCsv = $this->getCategoryListCsv();
        if ($categoryListCsv) {
            $result .= " AND h._id IN ({$categoryListCsv}) ";
        }

        if ( ! is_null($this->getStartTimestamp())) {
            $result .= " AND m.col_last_mtime >= '"
                       . $db->escape($this->getStartTimestamp()) . "' ";
        }

        if ( ! is_null($this->getEndTimestamp())) {
            $result .= " AND m.col_last_mtime < '"
                       . $db->escape($this->getEndTimestamp()) . "' ";
        }

        if ($this->isSearchSnapshot()) {
            $result .= " AND m._id = r.col_snapshot_message ";
            $result .= " AND m.col_last_follow_id >= f.col_id ";
        } else {
            $result .= ' AND m._id = r.col_message ';
            $result .= ' AND r.col_snapshot_message IS NULL';
        }

        return $result;
    }
}
