<?php
require_once("message/query/GrnMessageAbstractSearchQuery.csp");

class GrnMessageSearchByAddresseeQuery extends GrnMessageAbstractSearchQuery
{
    /**
     *
     * @return string
     */
    protected function getJoinColumnName()
    {
        return $this->isSearchSnapshot() ? "col_snapshot_message"
            : "col_message";
    }

    /**
     *
     * @return string
     */
    public function getQuery()
    {
        $db = $this->getDatabaseConnection();

        $result
            = "SELECT m._id mid, NULL fid FROM 
        (
            (
                (
                    tab_grn_message_folders AS h
                    INNER JOIN {$this->getUserTableName( 'tab_grn_message_foldermessagerelations' )} AS r ON h._id = r.col_folder
                )
                INNER JOIN
                tab_grn_message_messages AS m ON r.{$this->getJoinColumnName()} = m._id
            )
            INNER JOIN
            tab_grn_message_addressees AS a ON a.col_message = m._id
        )
        LEFT JOIN
        tab_cb_user AS u ON a.col_addressee = u._id AND u.col_deleted IS NULL
        WHERE
            a.col_dtime ='0'
            AND
            a.col_is_sender = '0' ";

        if ( ! is_null($this->getKeyword())) {
            $result .= " AND ("
                       . " {$this->queryf( "u.col_display_name LIKE '%@L%' ", [$this->getKeyword()])} "
                       . " OR "
                       . " {$this->queryf( "a.col_addressee_name LIKE '%@L%' ", [$this->getKeyword()])} "
                       . " OR "
                       . " {$this->queryf( "u.col_nickname LIKE '%@L%' ", [$this->getKeyword()])} "
                       . ")";
        }

        $categoryListCsv = $this->getCategoryListCsv();
        if ($categoryListCsv) {
            $result .= " AND h._id IN ({$categoryListCsv}) ";
        }

        if ( ! is_null($this->getStartTimestamp())) {
            $result .= " AND m.col_last_mtime >= '"
                       . $db->escape($this->getStartTimestamp()) . "' ";
        }

        if ( ! is_null($this->getEndTimestamp())) {
            $result .= " AND m.col_last_mtime < '"
                       . $db->escape($this->getEndTimestamp()) . "' ";
        }

        if ( ! $this->isSearchSnapshot()) {
            $result .= " AND r.col_snapshot_message IS NULL ";
        }

        return $result;
    }
}
