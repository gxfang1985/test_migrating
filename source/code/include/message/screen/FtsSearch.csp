<?php

namespace grn\message\screen;

use grn\fts\Application as FtsApplication;
use grn\fts\filter\LanguageFilter;
use grn\fts\SearchQueryInterface;
use grn\fts\SearchTarget;
use grn\fts\SortOrder;

require_once('grn/smarty.csp');

class FtsSearch
{
    const TEMPLATE_PATH = 'message/search_fts.tpl';

    /** @var string */
    private $text = '';
    /** @var int */
    private $folderId = null;
    /** @var \grn\fts\SortOrder */
    private $sortOrder;
    /** @var bool */
    private $fileOnly = false;
    /** @var string */
    private $fileType = '';
    /** @var bool */
    private $titleFilter = false;
    /** @var string */
    private $modifier = '';
    /** @var string */
    private $dateLower = SearchQueryInterface::DATE_NOT_SPECIFIED;
    /** @var string */
    private $dateUpper = SearchQueryInterface::DATE_NOT_SPECIFIED;
    /** @var string */
    private $folderTarget = SearchTarget::CURRENT;
    /** @var string */
    private $language = LanguageFilter::ALL;

    /**
     * @param array $input
     */
    public function __construct(array $input)
    {
        $this->sortOrder = new SortOrder();
        $this->parseInput($input);
    }

    /**
     * @return string
     */
    public function fetch()
    {
        $loginUser = cb_get_login_user();
        assert('$loginUser');
        $smarty = new \GRN_Smarty();
        $smarty->assign('search_text', $this->getText());
        $smarty->assign('sortByDatetime',
            $this->getSortOrder() === SortOrder::DATETIME);
        $smarty->assign('fileOnly', $this->getFileOnly());
        $smarty->assign('fileType', $this->getFileType());
        $smarty->assign('titleFilter', $this->getTitleFilter());
        $smarty->assign('modifier', $this->getModifier());
        $smarty->assign('loginUserId', $loginUser->getOID());
        $smarty->assign('language', $this->getLanguage());
        $smarty->assign('is_elasticsearch',
            FtsApplication::getFtsEngine()->isElasticsearch());

        $folderId = $this->getFolderId();
        if (is_null($folderId)) {
            /* folderID must be exists */
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
        } else {
            require_once('message/folder_logic.csp');
            $folderLogic = new \GRN_Message_FolderLogic();
            $folder = $folderLogic->getFolderInfo($loginUser, $folderId);
            if ($folder && $folder['folder_type'] !== GRN_MESSAGE_DRAFTFOLDER
                && $folder['folder_type'] !== GRN_MESSAGE_GARBAGEFOLDER
            ) {
                $smarty->assign('folderId', $folderId);
            } else {
                /* invalid folder */
                require_once('message/error_code.csp');
                cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
            }
        }

        $dateLower = $this->getDateLower();
        if ($dateLower !== SearchQueryInterface::DATE_NOT_SPECIFIED) {
            $smarty->assign('dateLower', $dateLower);
        }
        $dateUpper = $this->getDateUpper();
        if ($dateUpper !== SearchQueryInterface::DATE_NOT_SPECIFIED) {
            $smarty->assign('dateUpper', $dateUpper);
        }

        require_once('message/controller.csp');
        $controller = new \GRN_Message_ControllerUtil();
        $smarty->assign('site_position',
            $controller->makeMessageSitePosition($folderId));

        $locator = \GRN_ApplicationLocator::instance();
        $smarty->assign('page_title', grn_get_current_page_display_name([
            'app_name' => $locator->getInstance('message')->getName()
        ]));

        // hide root, draft, garbage folder in selectbox
        $hideFolders = (0x01 << GRN_MESSAGE_DRAFTFOLDER) | (0x01
                                                            << GRN_MESSAGE_GARBAGEFOLDER);
        $smarty->assign('hideFolders', $hideFolders);

        $smarty->assign('runBackgroundSearch',
            FtsApplication::isBackgroundSearchModeEnabled());

        return $smarty->fetch(self::TEMPLATE_PATH);
    }

    /**
     * @param array $input
     */
    private function parseInput(array $input)
    {
        if (isset($input['search_text'])) {
            $this->setText($input['search_text']);
        }
        if (isset($input['sortOrder'])) {
            $this->setSortOrder($input['sortOrder']);
        }
        if (isset($input['fileOnly']) && $input['fileOnly']) {
            $this->setFileOnly(true);
        }
        if (isset($input['fileType'])) {
            $this->setFileType($input['fileType']);
        }
        if (isset($input['titleFilter']) && $input['titleFilter']) {
            $this->setTitleFilter(true);
        }
        if (isset($input['modifier'])) {
            $this->setModifier($input['modifier']);
        }
        if (isset($input['dateLower'])) {
            $this->setDateLower($input['dateLower']);
        }
        if (isset($input['dateUpper'])) {
            $this->setDateUpper($input['dateUpper']);
        }
        if (isset($input['dcid'])) {
            $this->setFolderId($input['dcid']);
        }
        if (isset($input['folderTarget'])) {
            $this->setFolderTarget($input['folderTarget']);
        }
        if (isset($input['language'])) {
            $this->setLanguage($input['language']);
        }
    }

    /**
     * @param string $text
     */
    public function setText($text)
    {
        $this->text = $text;
    }

    /**
     * @return string
     */
    public function getText()
    {
        return $this->text;
    }

    /**
     * @param int $folderId
     */
    public function setFolderId($folderId)
    {
        $this->folderId = $folderId;
    }

    /**
     * @return int
     */
    public function getFolderId()
    {
        return $this->folderId;
    }

    /**
     * @param string $sortOrder
     */
    public function setSortOrder($sortOrder)
    {
        $this->sortOrder->setSortType($sortOrder);
    }

    /**
     * @return string
     */
    public function getSortOrder()
    {
        return $this->sortOrder->getSortType();
    }

    /**
     * @param string $dateLower
     */
    public function setDateLower($dateLower)
    {
        $this->dateLower = $dateLower;
    }

    /**
     * @return string
     */
    public function getDateLower()
    {
        return $this->dateLower;
    }

    /**
     * @param string $dateUpper
     */
    public function setDateUpper($dateUpper)
    {
        $this->dateUpper = $dateUpper;
    }

    /**
     * @return string
     */
    public function getDateUpper()
    {
        return $this->dateUpper;
    }

    /**
     * @param string $modifier
     */
    public function setModifier($modifier)
    {
        $this->modifier = $modifier;
    }

    /**
     * @return string
     */
    public function getModifier()
    {
        return $this->modifier;
    }

    /**
     * @param boolean $fileOnly
     */
    public function setFileOnly($fileOnly)
    {
        $this->fileOnly = $fileOnly;
    }

    /**
     * @return boolean
     */
    public function getFileOnly()
    {
        return $this->fileOnly;
    }

    /**
     * @param string $fileType
     */
    public function setFileType($fileType)
    {
        $this->fileType = $fileType;
    }

    /**
     * @return string
     */
    public function getFileType()
    {
        return $this->fileType;
    }

    /**
     * @param string $folderTarget
     */
    public function setFolderTarget($folderTarget)
    {
        $this->folderTarget = $folderTarget;
    }

    /**
     * @return string
     */
    public function getFolderTarget()
    {
        return $this->folderTarget;
    }

    /**
     * @param string $language
     */
    public function setLanguage($language)
    {
        $this->language = $language;
    }

    /**
     * @return string
     */
    public function getLanguage()
    {
        return $this->language;
    }

    /**
     * @return boolean
     */
    public function getTitleFilter()
    {
        return $this->titleFilter;
    }

    /**
     * @param boolean $titleFilter
     */
    public function setTitleFilter($titleFilter)
    {
        $this->titleFilter = $titleFilter;
    }
}
