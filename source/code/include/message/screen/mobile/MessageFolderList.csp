<?php

namespace grn\message\screen\mobile;

use grn\message\screen\mobile\MobileMessageScreenBase;
use grn\grn\mobile\MobileFolderList;
use grn\grn\Validate;
use grn\grn\GrnException;

class MessageFolderList extends MobileMessageScreenBase
{
    public function __construct($input)
    {
        parent::__construct($input);

        require_once('grn/smarty.csp');
        $smarty = new \GRN_Smarty;

        $this->setMobileFooterBar();

        $this->_smarty = $smarty;
    }

    public function fetch()
    {
        if (is_null($this->_smarty)) {
            require_once('grn/smarty.csp');
            $this->_smarty = new \GRN_Smarty;
        }
        $smarty = $this->_smarty;

        $input = $this->getInput();
        $category_id = cb_at($input, 'cid');
        $tree_for_view = $this->getFolderTree($category_id);

        if ($tree_for_view) {
            $smarty->assign('folder_tree', $tree_for_view);
        }

        //assign breadcrumb.
        $this->assignBreadcrumbCurrentPage($smarty, $this->getTitle());

        return $smarty->fetch(cb_get_pagename() . '.tpl');
    }

    public function getSubFolderList($input)
    {
        if ( ! Validate::isNumber(@$input[self::ARG_CATEGORY_ID])) {
            throw new GrnException(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
        }
        $oid = $input[self::ARG_CATEGORY_ID];

        require_once('grn/org_tree.csp');
        require_once('message/folder_tree.csp');

        $util = \GRN_OrgTreeUtil::getInstance();

        $page_name = 'message/mobile/index';
        $tree = $util->getTree($page_name, 'GRN_Message_FolderTree',
            ['cid' => $oid]);

        $folder_list_object = new MobileFolderList($input);
        $sub_tree = $folder_list_object->constructSubFolderList($tree,
            $page_name, 'cid', $oid, 'message/mobile/message_list', []);

        return $sub_tree;
    }

    public function getTitle()
    {
        return grn_get_page_display_name('message/mobile/index');
    }
}

