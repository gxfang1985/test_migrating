<?php

namespace grn\message\screen\mobile;

class FileDownload extends MobileMessageScreenBase
{
    public function post($input)
    {
        $this->setInput($input);
        $this->checkArgFromInput([self::ARG_FILE_ID], $input);
        $login = cb_get_login_user();
        $file_id = $this->getFileId();

        require_once('message/file.csp');
        $file_manager = new \GRN_Message_FileManager();

        if ( ! $file_manager->hasPrivilege($login, $file_id)) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
                null,
                ['app_name' => $this->getMessageName()]);
        }

        $file = $file_manager->getFile($file_id);
        if ( ! $file) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
                null,
                ['app_name' => $this->getMessageName()]);
        }

        $body = null;

        $log_ver = array_key_exists('ver', $input) ? $input['ver'] : '';
        if ($log_ver != '') {
            require_once('grn/application.csp');
            $app_locator = \GRN_ApplicationLocator::instance();
            $dbconn = $app_locator->getConnection('message');

            $rowset = $file->getLogSet();
            $rowset->addCondition("col_version ='" . $dbconn->escape($log_ver)
                                  . "'");

            $log = $rowset->iterate();
            $rowset->destroy();

            if ( ! $log) {
                require_once('message/error_code.csp');
                cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
                    null,
                    ['app_name' => $this->getMessageName()]);
            }

            $body = $log->get('body');
        } else {
            $body = $file->getCurrentBody();
        }
        $body->download(true);

        cb_safe_exit();
    }
}
