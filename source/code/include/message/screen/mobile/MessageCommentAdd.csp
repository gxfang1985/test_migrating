<?php

namespace grn\message\screen\mobile;

use grn\grn\mention\MentionController;
use grn\grn\MemberLogic;

class MessageCommentAdd extends MobileMessageScreenBase
{
    public function fetch()
    {
        $input = $this->getInput();

        require_once('grn/smarty.csp');
        $t = new \GRN_Smarty();

        $message = $this->getMessageForView();

        $category_id = cb_at($input, self::ARG_CATEGORY_ID);
        $relation_id = cb_at($input, self::ARG_RELATION_ID);
        $message_id = cb_at($input, self::ARG_MESSAGE_ID);
        $follow_id = cb_at($input, self::ARG_FOLLOW_ID);

        if ( ! $this->checkFollowEnable()) {
            cb_throw_error(E_GRN_MESSAGE_DO_NOT_ALLOW_FOLLOW);
        }

        $upper_name = cb_msg('grn.mobile', 'detail_title');
        $upper_page = 'message/mobile/view';
        $upper_param = [
            self::ARG_CATEGORY_ID => $category_id,
            self::ARG_RELATION_ID => $relation_id,
            self::ARG_MESSAGE_ID  => $message_id
        ];
        $current_name = cb_msg('grn.mobile', 'comment_add');

        require_once('message/message_logic.csp');
        $message_logic = new \GRN_Message_Logic();

        if ($follow_id) {
            if ( ! ($follow = $message_logic->getFollowDetail($message_id,
                $follow_id))
            ) {
                cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_FOUND);
            }
            $upper_name = cb_msg('grn.mobile',
                'comment_detail_title');
            $upper_page = 'message/mobile/comment_detail';
            $upper_param[self::ARG_FOLLOW_ID] = $follow_id;
            $current_name = cb_msg('grn.mobile',
                'comment_reply');
        }
        $sp = 0;
        if (array_key_exists('sp', $input)) {
            $sp = $input['sp'];
        }
        $upper_param['sp'] = $sp;
        $t->assign('sp', $sp);

        $t->assign('cid', $category_id);
        $t->assign('rid', $relation_id);
        $t->assign('mid', $message_id);
        $t->assign('parent_fid', $follow_id);

        require_once('fw/plugin.csp');
        $mention_access_plugin_encoded = \CB_PluginLoader::encodeParam(
            [
                'name'   => 'message',
                'params' => [
                    'app_id'      => 'message',
                    'message_id'  => $message_id,
                    'target'      => [MemberLogic::TYPE_USER],
                    'relation_id' => $relation_id,
                ]
            ]
        );
        $t->assign('mention_access_plugin_encoded',
            $mention_access_plugin_encoded);

        include('grn/_upload_prepend.csp');

        $this->assignBreadcrumbUpperPage($t, $upper_name, $upper_page,
            $upper_param);
        $this->assignBreadcrumbCurrentPage($t, $current_name);

        return $t->fetch('message/mobile/comment_add.tpl');
    }

    public function post($input)
    {
        $category_id = cb_at($input, self::ARG_CATEGORY_ID);
        $relation_id = cb_at($input, self::ARG_RELATION_ID);
        $message_id = cb_at($input, self::ARG_MESSAGE_ID);
        $follow_id = cb_at($input, self::ARG_FOLLOW_ID);

        $login = cb_get_login_user();

        if ($category_id == '' || $relation_id == '' || $message_id == '') {
            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                ['app_name' => $this->getMessageName()],
                ['app_name' => $this->getMessageName()],
                ['app_name' => $this->getMessageName()]);
        }

        if ( ! $this->checkFollowEnable()) {
            cb_throw_error(E_GRN_MESSAGE_DO_NOT_ALLOW_FOLLOW);
        }

        if (cb_at($input, 'attached_file')) {
            require_once('grn/upload.csp');
            $files = \GRN_UploadFile::getUploadedFiles(cb_at($input,
                'upload_ticket'), cb_at($input, 'file_input'), true);
        } else {
            $files = [];
        }

        $data = cb_at($input, 'comment_data');
        if (is_null($data) || strlen(cb_trim($data)) < 1) {
            if ( ! $files || count($files) == 0) {
                cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_INPUTTED);
            }
        }

        //reply
        require_once('message/message_logic.csp');
        $message_logic = new \GRN_Message_Logic();
        if ($follow_id) {
            if ( ! ($follow = $message_logic->getFollowDetail($message_id,
                $follow_id))
            ) {
                cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_FOUND);
            }
            if (array_key_exists('id', $follow) && $follow['id'] > 0) {
                $data = ">>" . $follow['id'] . "\n" . $data;
            }
        }

        $follow = [];
        $follow['creator'] =& $login;
        $follow['format_type'] = 0;
        $follow['data'] = $data;

        $mentioned_objects
            = MentionController::getMentionObjectsFromRequestArgs($input);
        $mention_member_ids
            = $mentioned_objects->getObjectIdsGroupByType();
        $mention_user_ids
            = $mention_member_ids[MemberLogic::TYPE_USER];
        $no_permission_mentioned_user_ids
            = $message_logic->filterUsersNotHavingPermission($message_id,
            $mention_user_ids);
        if ($no_permission_mentioned_user_ids) {
            cb_throw_error(E_GRN_MESSAGE_HAS_NO_PERMISSION,
                null,
                ['users' => MemberLogic::getCommaSeparatedUserNames($no_permission_mentioned_user_ids)]
            );
        }
        $follow['mention'] = $mentioned_objects;

        $ret = $message_logic->writeFollow($login, $message_id, $follow,
            $files);
        if ($ret === false) {
            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                ['app_name' => $this->getMessageName()],
                ['app_name' => $this->getMessageName()],
                ['app_name' => $this->getMessageName()]);
        }
    }

    public function getTitle()
    {
        $message = $this->getMessageForView();
        if (is_array($message) && array_key_exists('subject', $message)) {
            return $message['subject'] . ' - ' . cb_msg('grn.mobile',
                    'comment_add');
        }

        return cb_msg('grn.mobile', 'comment_add');
    }
}
