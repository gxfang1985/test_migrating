<?php
/**
 * Message Tree View
 *
 * @author: Huy Nguyen - 2009/11
 */

require_once('grn/org_tree.csp');

class GRN_Message_FolderTree extends GRN_OrgTree
{
    var $_locale = null;

    /**
     * @param $params
     */
    function __construct($params)
    {
        $this->_groups_have_childs = [];
    }

    /**
     * @return CB_User
     */
    function _getLoginUser()
    {
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $user = $uum->getLoginUser();

        return $user;
    }

    /**
     * @return GRN_Message_FolderLogic
     */
    function _getFolderLogic()
    {
        require_once('message/folder_logic.csp');
        $folder_logic = new GRN_Message_FolderLogic();

        return $folder_logic;
    }

    /**
     * 子組織を取得する。
     *
     * @param   int $oid 親組織ID
     *
     * @return  array 子組織
     */
    function _getChildren($oid)
    {
        $logic = $this->_getFolderLogic();

        $use_garbagebox = null;
        $folders = [];
        $user = $this->_getLoginUser();
        if (is_null($oid)) {
            $folders = $logic->getRootFolders($user);

            require_once('message/personal_logic.csp');
            $personal_logic = GRN_Message_PersonalLogic::getInstance();
            $use_garbagebox = $personal_logic->getUseGarbageBoxAttribute($user);
        } else {
            $folders = $logic->getChildren($user, $oid);
        }

        $ret = [];
        foreach ($folders as $fid => $folder) {
            if (GRN_MESSAGE_GARBAGEFOLDER == $folder['type']
                && ! $use_garbagebox
            ) {
                continue;
            }

            $ret[$fid] = [
                '_id'        => $folder['id'],
                'col_name'   => $folder['name'],
                'subscribed' => $folder['subscribe'],
                'type'       => $folder['type'],
                'unread'     => $folder['unread'],
            ];
        }

        return $ret;
    }

    /**
     * @param int $oid
     *
     * @return  array associated array
     */
    function &_getAncestors($oid)
    {
        global $G_message_login;

        require_once('message/folder_logic.csp');
        $logic = new GRN_Message_FolderLogic();
        $retval =& $logic->getAncestors($oid);

        return $retval;
    }

    function _onCreateChild(&$child, &$child_row)
    {
        $child['subscribed'] = $child_row['subscribed'];
        $child['type'] = $child_row['type'];
        $child['unread'] = $child_row['unread'];
    }

    /**
     * 子組織数を取得する。
     *
     * @param  int $oid 親組織ID
     *
     * @return int num of child organization
     */
    function _getChildCount($oid)
    {
        $logic = $this->_getFolderLogic();
        $user = $this->_getLoginUser();
        $count = $logic->childrenCount($oid);

        return $count;
    }

    function getRoot()
    {
        $tree =& $this->_tree;
        if (is_null($tree)) {
            return $tree;
        }

        // update caption of special folders when current locale is changed
        require_once('fw/i18n.csp');
        $i18n = CB_I18N::getInstance();
        $locale = strtolower($i18n->getCurrentLanguage());

        if (strcasecmp($this->_locale, $locale)) {
            foreach (array_keys($tree) as $key) {
                $folder =& $tree[$key];
                switch ($folder['type']) {
                    case GRN_MESSAGE_RECEIVINGFOLDER:
                        $folder['name'] = cb_msg('grn.message', 'inbox');
                        break;
                    case GRN_MESSAGE_SENDINGFOLDER:
                        $folder['name'] = cb_msg('grn.message', 'outbox');
                        break;
                    case GRN_MESSAGE_DRAFTFOLDER:
                        $folder['name'] = cb_msg('grn.message', 'draftbox');
                        break;
                    case GRN_MESSAGE_GARBAGEFOLDER:
                        $folder['name'] = cb_msg('grn.message', 'garbagebox');
                        break;
                }
            }
        }

        $this->_locale = $locale;

        return $tree;
    }

    function getSelectedNode()
    {
        $user = $this->_getLoginUser();
        // login as another user
        if ($this->_uid !== $user->getOID()) {
            $this->_selectedNode = null;
            $this->initialize();
        }

        $logic = $this->_getFolderLogic();

        // selected folder is deleted
        $folder_id = null;
        if ( ! is_null($this->_selectedNode)
             && ($folder_id
                = $logic->getFolderIDBySpecificFolderID($user,
                $this->_selectedNode)) === false
        ) {
            $this->_selectedNode = null;
            $this->initialize();
        }

        if ($folder_id) {
            $folder_info = $logic->getFolderInfo($user, $folder_id);
            if ($folder_info['folder_type'] == GRN_MESSAGE_GARBAGEFOLDER) {
                require_once('message/personal_logic.csp');
                $personal_logic = GRN_Message_PersonalLogic::getInstance();
                if ($personal_logic->getUseGarbageBoxAttribute($user) == '0') {
                    $this->_selectedNode = null;
                    $this->initialize();
                }
            }
        }

        if ( ! $this->_selectedNode) {
            $this->_selectedNode = $logic->getSpecificFolderID($user,
                GRN_MESSAGE_RECEIVINGFOLDER);
        }

        return $this->_selectedNode;
    }

    /**
     * ツリーの子ノードを構築する。
     *
     * @param int  $parent_oid 親ノードID
     * @param bool $expanded
     * @param bool $force
     *
     * @return array|bool 構築した子ノード
     */
    function buildChild($parent_oid, $expanded = false, $force = true)
    {
        return $this->_buildChild($parent_oid, $expanded, $force);
    }
}

////////// Utility functions //////////

function grn_message_rebuild_folder_tree($list_page, $expand_oid = null)
{
    $util = GRN_OrgTreeUtil::getInstance();
    $tree = $util->getTree($list_page, 'GRN_Message_FolderTree');
    $tree->rebuild();

    // update init time
    $util->updateInitPageList($list_page, $tree);

    if ( ! is_null($expand_oid)) {
        global $G_message_login;

        require_once('message/folder_logic.csp');
        $logic = new GRN_Message_FolderLogic();
        $ancestors =& $logic->getAncestors($expand_oid);

        foreach (array_keys($ancestors) as $fid) {
            $tree->buildChild($fid);
        }
    }
    $util->setTree($list_page, $tree);
}


