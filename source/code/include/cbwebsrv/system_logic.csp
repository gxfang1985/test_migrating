<?php
/**
 * Cybozu Net application system logic
 *
 * @author   Eiji TAEN   2005/05
 * @package  grn.cbwebsrv
 */

require_once('cbwebsrv/common.csp');

/**
 * Cybozu Net application system logic class
 *
 * @package  grn.cbwebsrv
 */
class GRN_CBWebSrv_SystemLogic
{
    /**
     * message system profile
     *
     * @access   private
     */
    var $_profile = null;

    /**
     * constructor
     */
    function __construct()
    {
        //
    }

    /**
     * get instance
     *
     * @return   GRN_CBWebSrv_SystemLogic
     */
    public static function getInstance()
    {
        static $_instance = null;

        if (is_null($_instance)) {
            $_instance = new GRN_CBWebSrv_SystemLogic();
        }

        return $_instance;
    }

    /**
     * get message application system profile
     *
     * @return   CB_Profile
     */
    function _getSystemProfile()
    {
        if (is_null($this->_profile)) {
            require_once('cbwebsrv/application.csp');
            $application = new GRN_CBWebSrv_Application();
            $this->_profile = $application->getSystemProfile();
        }

        return $this->_profile;
    }

    /**
     * get specified attribute
     *
     * @access   private
     *
     * @param    $name      string   attribute name
     * @param    $default   string   default value
     *
     * @return   string              specified attribute. if it doesn't exist,
     *                               return $default
     */
    function _getAttribute($name, $default)
    {
        $profile = $this->_getSystemProfile();

        if ( ! $profile->getAttribute($name, $value)) {
            return $default;
        }

        return $value;
    }

    /**
     * set specified attribute
     *
     * @access   private
     *
     * @param    $name    string   attribute name
     * @param    $value   string   attribute value
     *
     * @return   boolean           TRUE: success setting attribute, FALSE: fail
     */
    function _setAttribute($name, $value)
    {
        $profile =& $this->_getSystemProfile();

        if ( ! $profile->getAttribute($name, $dummy)) {
            if ( ! $profile->createAttribute($name, $value)) {
                return false;
            }
        } else {
            if ( ! $profile->updateAttribute($name, $value)) {
                return false;
            }
        }

        return true;
    }

    /**
     * get format configuration attribute
     *
     * @param    string $name service name
     *
     * @return   string   format configuration
     */
    function getServiceAvailabilityAttribute($name)
    {
        return $this->_getAttribute('system_' . $name, '1');
    }

    /**
     * set format configuration attribute
     *
     * @param    string $name service name
     *
     * @return   string   format configuration
     */
    function setServiceAvailabilityAttribute($name, $availability)
    {
        // logging
        $status = $availability ? 'Activate' : 'Deactivate';
        $service_name = cb_msg('grn.cbwebsrv', $name);

        require_once('grn/logger.csp');
        $lm = CB_LoggerManager::getInstance();
        $logger =& $lm->getLogger('grn.cbwebsrv');
        $action = 'config';
        $target = 'service';
        $log_params = [
            'sid'      => $name,
            'name'     => $service_name,
            'activate' => $availability
        ];
        $logger->noticeEx($action, $target, $log_params);

        return $this->_setAttribute('system_' . $name, $availability);
    }

    /**
     * get use-product-id attribute
     */
    function getUseProductIDAttribute()
    {
        return $this->_getAttribute('system_use_product_id', '1');
    }

    /**
     *
     */
    function setUseProductIDAttribute($value)
    {
        // logging
        require_once('grn/logger.csp');
        $lm = CB_LoggerManager::getInstance();
        $logger =& $lm->getLogger('grn.cbwebsrv');
        $action = 'config';
        $target = 'common';
        $log_params = ['use_product_id' => $value];
        $logger->noticeEx($action, $target, $log_params);

        return $this->_setAttribute('system_use_product_id', $value);
    }

}


