<?php
require_once('fw/cydec.csp');

class CB_ForestUtil
{
    private static $REDIRECT_PAGES
        = [
            'system/index'                                   => 'system/common_list',
            'system/external/webproxy'                       => 'system/common_list',
            'system/external/command_webproxy'               => 'system/common_list',
            'portal/system/php_portlet_list'                 => 'system/common_list',
            'portal/system/php_portlet_add'                  => 'system/common_list',
            'portal/system/command_php_portlet_add'          => 'system/common_list',
            'portal/system/php_portlet_delete'               => 'system/common_list',
            'portal/system/command_php_portlet_delete'       => 'system/common_list',
            'portal/system/php_portlet_delete_all'           => 'system/common_list',
            'portal/system/command_php_portlet_delete_all'   => 'system/common_list',
            'portal/system/php_portlet_delete_multi'         => 'system/common_list',
            'portal/system/command_php_portlet_delete_multi' => 'system/common_list',
            'portal/system/php_portlet_export1'              => 'system/common_list',
            'portal/system/command_php_portlet_export1'      => 'system/common_list',
            'portal/system/php_portlet_export2'              => 'system/common_list',
            'portal/system/command_php_portlet_export2'      => 'system/common_list',
            'portal/system/php_portlet_import'               => 'system/common_list',
            'portal/system/command_php_portlet_import'       => 'system/common_list',
            'portal/system/php_portlet_modify'               => 'system/common_list',
            'portal/system/command_php_portlet_modify'       => 'system/common_list',
            'portal/system/php_portlet_name_export'          => 'system/common_list',
            'portal/system/command_php_portlet_name_export'  => 'system/common_list',
            'portal/system/php_portlet_name_import1'         => 'system/common_list',
            'portal/system/command_php_portlet_name_import1' => 'system/common_list',
            'portal/system/php_portlet_name_import2'         => 'system/common_list',
            'portal/system/command_php_portlet_name_import2' => 'system/common_list',
            'portal/system/php_portlet_preview'              => 'system/common_list',
            'portal/system/php_portlet_view'                 => 'system/common_list',
            'system/notification/cybozu'                     => 'system/common_list',
            'system/notification/command_cybozu'             => 'system/common_list',
            'personal/user/user_view'                        => 'personal/common_list',
            'personal/user/user_modify'                      => 'personal/common_list',
            'personal/user/command_user_modify'              => 'personal/common_list',
            'personal/user/password'                         => 'personal/common_list',
            'personal/user/command_password'                 => 'personal/common_list',
            'personal/i18n/timezone'                         => 'personal/common_list',
            'personal/i18n/command_timezone'                 => 'personal/common_list',
            'phonemessage/system/common_set'                 => 'system/application_list',
            'notification/system/command_scheduling_service' => 'system/application_list',
            'notification/system/scheduling_service'         => 'system/application_list',
        ];

    private static $REDIRECT_DIRS
        = [
            'system/support'          => 'system/common_list',
            'system/customer'         => 'system/common_list',
            'system/authentication'   => 'system/common_list',
            'system/sso'              => 'system/common_list',
            'system/logging'          => 'system/common_list',
            'system/license'          => 'system/common_list',
            'system/i18n/locale'      => 'system/common_list',
            'dezielink/system'        => 'system/common_list',
            'dezielink/portlet'       => 'index',
            'personal/sso'            => 'personal/common_list',
            'system/user'             => 'system/common_list',
            'system/queue_monitoring' => 'system/common_list',
        ];

    private static $EXCEPTED_PAGES
        = [
            'system/user/delete_user_list'                           => 'system/user/delete_user_list',
            'system/user/command_delete_user_list'                   => 'system/user/command_delete_user_list',
            'system/user/delete_user_permanent_delete_multi'         => 'system/user/delete_user_permanent_delete_multi',
            'system/user/command_delete_user_permanent_delete_multi' => 'system/user/command_delete_user_permanent_delete_multi',
            'system/user/role_list'                                  => 'system/user/role_list',
            // GTM-2542
            'system/user/user_column_search_setting'                 => 'system/user/user_column_search_setting',
            'system/user/command_user_column_search_setting_modify'  => 'command_user_column_search_setting_modify',
            'system/user/using_role_set'                             => 'system/user/using_role_set',
            // GTM-2542
            'system/user/command_using_role_set'                     => 'system/user/command_using_role_set',
            // GTM-2542
        ];

    /**
     * Return redirect pages on forest.
     *
     * @return array
     */
    public static function getRedirectPages()
    {
        return self::$REDIRECT_PAGES;
    }

    /**
     * Return except pages on forest.
     *
     * @return array
     */
    public static function getExceptedPages()
    {
        return self::$EXCEPTED_PAGES;
    }

    /**
     * Return redirect dirs on forest.
     *
     * @return array
     */
    public static function getRedirectDirs()
    {
        return self::$REDIRECT_DIRS;
    }

    /**
     * Get a instance of forest config.
     *
     * @return CB_ConfigManager
     */
    public static function getConfig()
    {
        static $config = null;

        if (is_null($config)) {
            $path = CB_CyDECUtil::getInstance()->getGaroonConfig('forest.ini');
            if ( ! file_exists($path)) {
                die("cannot find " . $path);
            }
            $config = new CB_ConfigManager($path);
        }

        return $config;
    }

    /**
     * @param CB_User $user
     * @param string  $password
     *
     * @return bool
     */
    public static function validatePassword(CB_User $user, $password)
    {
        return (self::hashPassword($password, $user->get('slash_salt'))
                === $user->get('slash_password'));
    }

    public static function hashPassword($password, $salt)
    {
        return strtoupper(hash("sha256", $password . ':' . $salt));
    }
}

/**
 * Class CB_RegionManager
 */
class CB_RegionManager
{
    /** constants */
    const REGION_JSON = 'region.json';

    /**
     * @return array
     */
    public static function getRegionJson(): array
    {
        static $json = null;

        if ($json !== null) {
            return $json;
        }

        // Clearing realpath caches is necessary because
        // /usr/local/forest is a symbolic link and its destination will be changed while running PHP processes.
        clearstatcache(true);

        global $G_config_common;
        $dir_path = $G_config_common->get('Forest', 'region_dir');

        $file_path = $dir_path . DIRECTORY_SEPARATOR . self::REGION_JSON;
        if ( ! is_readable($file_path)) {
            cb_throw_error(E_COMMON_REGION_JSON_CANNOT_READ_FILE);
        }

        $json = file_get_contents($file_path);
        $json = json_decode($json, true);
        if ($json === null) {
            cb_throw_error(E_COMMON_REGION_JSON_INVALID_DATA);
        }

        return $json;
    }
}
