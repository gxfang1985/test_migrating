<?php

/**
 * Framework postprocess.
 *
 * @package fw.core
 */

global $G_state_set, $G_container_base;

// shutdown container registered objects
if (isset($G_container_base)) {
    $G_container_base->shutdown();
}

if (class_exists('CB_TransactionManager')) {
    $tm = CB_TransactionManager::getInstance();
    if ($G_state_set->get('error_occurred')) {
        // rollback changes in transactions lower than audit level.
        $tm->abort(CB_TRANSACTION_LEVEL_MAIL);
    }

    // commit remained transacions if any
    $tm->commit();

    unset($tm);
}

if ( ! $G_state_set->get('error_occurred')) {
    require_once('grn/CybozuSuccessHeader.csp');
    // send 'X-Cybozu-Success' header after all transactions are successful.
    $header = new grn\grn\CybozuSuccessHeader();
    $header->send();
    unset($header);
}

// clean up upload temp files
if ($G_state_set->get('cbpapi.upload_tmp_files')) {
    require_once('cbpapi/util.csp');
    cbpapi_cleanup_upload_temp_file();
}

if ( ! headers_sent() && $G_state_set->get('no_cache')) {
    header("Expires: Thu, 19 Nov 1981 08:52:00 GMT");
    header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
    header("Pragma: no-cache");
}
