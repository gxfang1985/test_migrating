<?php

namespace grn\fw;

require_once('fw/server_file.csp');

/**
 * Class ServerFileAddManager
 *
 * @package grn\fw
 */
class ServerFileAddManager implements \CB_Transactional
{
    /** @var array */
    private $_toCopy = [];
    /** @var \CB_ServerFileManager */
    private $fileManager;

    public function __construct(\CB_ServerFileManager $fileManager)
    {
        $this->fileManager = $fileManager;
    }

    /**
     * Commit changes.  Implementers must be aware that this may
     * be called many times during the process request.
     *
     * @return bool
     */
    public function commit()
    {
        foreach ($this->_toCopy as $cp) {
            $from = $cp[0];
            $to = $cp[1];

            if ( ! file_exists($from)) {
                continue;
            }
            if (is_uploaded_file($from)) {
                move_uploaded_file($from, $to);
            } else {
                copy($from, $to);
            }
        }
        $this->_toCopy = [];
        $this->fileManager->deleteTemporaryFile();

        return true;
    }

    /**
     * Abort and discard changes.  Implementers must be aware that
     * this may be called many times during the process request.
     */
    public function abort()
    {
        $this->_toCopy = [];
        $this->fileManager->deleteTemporaryFile();
    }

    /**
     * @param string $to
     * @param string $from
     */
    public function addToCopy($to, $from)
    {
        $this->_toCopy[$to] = [$from, $to];
    }
}
