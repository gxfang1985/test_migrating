<?php

use grn\grn\XCybozuSessionTokenDetector;

function cb_csrf_get_token()
{
    global $G_config_common;
    if ($G_config_common->get('Global', 'csrf_check_disable')) {
        return md5(uniqid(rand(), true));
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('grn.csrf');
    $csrf_ticket = $session->get('csrf_ticket');
    if ( ! $csrf_ticket) {
        $csrf_ticket = md5(uniqid(rand(), true));
        $session->set('csrf_ticket', $csrf_ticket);
    }

    return $csrf_ticket;
}

/**
 * @param string $token
 * @param bool   $throw_error
 *
 * @return bool
 */
function cb_csrf_validate_token($token, $throw_error = true)
{
    global $G_config_common;
    if ($G_config_common->get('Global', 'csrf_check_disable')) {
        return true;
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('grn.csrf');
    $csrf_ticket = $session->get('csrf_ticket');
    if ($csrf_ticket) {
        if (strcmp(trim($csrf_ticket), trim($token)) === 0) {
            return true;
        }
    }
    if ($throw_error) {
        cb_throw_error('FW00043', null, null, null,
            ['page' => cb_get_pagename()]);
    }

    return false;
}


/**
 * @param      $token
 * @param bool $throw_error
 *
 * @return bool
 */
function cb_csrf_validate_token_v1($token, $throw_error = true)
{
    if (XCybozuSessionTokenDetector::isAccessWithXCybozuSessionToken()) {
        return true;
    }

    return cb_csrf_validate_token($token, $throw_error);
}
