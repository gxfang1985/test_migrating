<?php
require_once("fw/bean/CbUserNameLanguage.csp");

class CbUserNameLanguageDAO
{
    public function createTable($inDataObj)
    {
        /* @var CB_DatabaseConnection $db */
        $db = $inDataObj['db'];

        $db->query("DROP TABLE IF EXISTS tab_cb_user_name_language;");

        $db->query(
            "CREATE TABLE tab_cb_user_name_language ("
            . "`_id` BIGINT(20) NOT NULL, "
            . "`col_language` BIGINT(20) NOT NULL, "
            . "PRIMARY KEY(`_id`, `col_language`), "
            . "CONSTRAINT `cns_cb_user_name_language_id` FOREIGN KEY (`_id`) REFERENCES `tab_cb_user` (`_id`) ON DELETE CASCADE,"
            . "CONSTRAINT `cns_cb_user_name_language_language` FOREIGN KEY (`col_language`) REFERENCES `tab_cb_language_status` (`_id`) ON DELETE CASCADE"
            . ") ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_cs;"
        );
    }

    /**
     * @param $inDataObj
     * @param $userId
     *
     * @return CBUserNameLanguage
     */
    public function selectByUserId($inDataObj, $userId)
    {
        /* @var CB_DatabaseConnection $db */
        $ret = [];
        $db = $inDataObj['db'];

        $result
            = $db->query("SELECT * FROM tab_cb_user_name_language WHERE _id = '{$db->escape($userId)}';");

        while ($row = $db->fetch_assoc($result)) {
            $ret[] = new CbUserNameLanguage($row);
        }

        return $ret;
    }

    /**
     * @param                    $inDataObj
     * @param CBUserNameLanguage $userNameLanguage
     *
     * @return bool
     */
    public function delete($inDataObj, $userNameLanguage)
    {
        /* @var CB_DatabaseConnection $db */
        $db = $inDataObj['db'];
        $query = "DELETE FROM tab_cb_user_name_language WHERE "
                 . " _id = '{$db->escape($userNameLanguage->getId())}' "
                 . " AND "
                 . " col_language = '{$db->escape($userNameLanguage->getLanguage())}';";

        $result = $db->query($query);
        if ($result === false) {
            $db->throwError($query);
        }

        return true;
    }

    /**
     * @param                    $inDataObj
     * @param CBUserNameLanguage $userNameLanguage
     *
     * @return bool
     */
    public function insert($inDataObj, $userNameLanguage)
    {
        /* @var CB_DatabaseConnection $db */
        $db = $inDataObj['db'];
        $query = "INSERT INTO tab_cb_user_name_language SET "
                 . "_id='{$db->escape($userNameLanguage->getId())}', "
                 . "col_language='{$db->escape($userNameLanguage->getLanguage())}';";
        $result = $db->query($query);
        if ($result === false) {
            $db->throwError($query);
        }

        return true;
    }

    /**
     * @param $inDataObj
     * @param $defaultLanguageId
     *
     * @return bool
     */
    public function initializeData($inDataObj, $defaultLanguageId)
    {
        /* @var CB_DatabaseConnection $db */
        $db = $inDataObj["db"];

        $query = "DELETE FROM tab_cb_user_name_language;";
        $result = $db->query($query);
        if ($result === false) {
            $db->throwError($result);
        }

        $query = "INSERT " .
                 "tab_cb_user_name_language (_id, col_language) " .
                 "SELECT " .
                 "u._id, IF(uls.col_language IS NULL, '{$db->escape($defaultLanguageId)}', uls.col_language) "
                 .
                 "FROM " .
                 "tab_cb_user u " .
                 "LEFT JOIN " .
                 "tab_cb_user_locale_setting uls " .
                 "ON " .
                 "u._id = uls._id ;";
        $result = $db->query($query);
        if ($result === false) {
            $db->throwError($query);
        }

        return true;
    }
}
