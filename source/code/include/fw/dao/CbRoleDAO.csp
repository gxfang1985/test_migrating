<?php

use grn\system\sandbox\SandboxConstants;

require_once('fw/database.csp');

class CbRoleDAO
{
    private $postfix = '';

    /**
     * @param int $sandbox
     */
    public function __construct($sandbox = SandboxConstants::NO_SANDBOX_MODE)
    {
        $this->postfix = ($sandbox === SandboxConstants::SANDBOX_MODE
            ? "_sandbox" : "");
    }

    /**
     * @param int $inUserId
     *
     * @return array
     */
    public function getRoleByUserId($inUserId)
    {
        $inDb = cb_get_master_db();

        $p = $this->postfix;

        $query
            = "SELECT role._id, role.col_foreign_key, role.col_list_index, role.col_slash"
              .
              " FROM tab_cb_role AS role" .
              " INNER JOIN tab_cb_userrolerelation{$p} AS relation ON role._id = relation.col_role"
              .
              " WHERE relation.col_user = '@S'" .
              " ORDER BY relation.col_role_list";
        $query = $inDb->format($query, [$inUserId]);
        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $roles = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $roles[] = $rawdata;
        }
        $inDb->free_result($result);

        return $roles;
    }
}
