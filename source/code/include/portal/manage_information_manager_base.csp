<?php
/**
 * Portal Application Manage Manager Base Class
 *
 * @author  Yuichi, Nakamura 2005/8
 * @version 1.0
 * @package grn.portal
 */

/** Portal Application **/
require_once('portal/resources.csp');
require_once('grn/application.csp');

/**
 * Portal Manage Manager BaseClass
 *
 * @package grn.portal
 */
class GRN_Portal_Manage_Information_Manager_Base
{
    /** Portal Manage Table List **/
    var $_table_list = [];

    /** Portal Manage Cache List **/
    var $_manage_cache_list = [];

    /** Module ID **/
    var $_module_id = null;

    /** Table Name List **/
    var $_table_name_list = [];

    /** Authority List **/
    var $_authority_list = [];

    /**
     * Constructor
     */
    function __construct()
    {

    }

    /** @var self */
    private static $_instance = null;

    /**
     * @return self
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get Database
     *
     * @return CB_DatabaseConnection
     */
    function _getDatabase()
    {
        static $database = null;
        if (is_null($database)) {
            $app_locator = GRN_ApplicationLocator::instance();
            $database = $app_locator->getConnection('portal');
        }

        return $database;
    }

    /**
     * Get Table Information Object
     *
     * @param  string $target_type //Table Type(user/group/static_role)
     *
     * @return CB_TableInfo
     */
    function _getTableInfo($target_type)
    {
        $table_list =& $this->_table_list;
        if ( ! array_key_exists($target_type, $table_list)) {
            $app_locator = GRN_ApplicationLocator::instance();
            $table_manager = $app_locator->getTableManager('portal');
            switch ($target_type) {
                case GRN_PRTL_MANAGE_TARGET_TYPE_USER:
                    $table_list[$target_type]
                        = $table_manager->getTableInfo($this->_table_name_list[GRN_PRTL_MANAGE_TARGET_TYPE_USER]);
                    break;
                case GRN_PRTL_MANAGE_TARGET_TYPE_GROUP:
                    $table_list[$target_type]
                        = $table_manager->getTableInfo($this->_table_name_list[GRN_PRTL_MANAGE_TARGET_TYPE_GROUP]);
                    break;
                case GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE:
                    $table_list[$target_type]
                        = $table_manager->getTableInfo($this->_table_name_list[GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE]);
                    break;
                case GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE:
                    $table_list[$target_type]
                        = $table_manager->getTableInfo($this->_table_name_list[GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE]);
                    break;
                default:
                    assert('FALSE');
                    break;
            }
        }

        return $table_list[$target_type];
    }

    /**
     * Get Column List
     *
     * @param  CB_TableInfo $table_info //Target Table Information
     *
     * @return array clumns
     */
    function &_getColumnList($table_info)
    {
        static $column_name_list = null;
        if (is_null($column_name_list)) {
            require_once('portal/table.csp');
            $column_info = $table_info->getColumnInfo();
            foreach (array_keys($column_info) as $column_name) {
                $column_name_list[] = 'col_' . $column_name;
            }
            $column_name_list[] = '_id';
        }

        return $column_name_list;
    }

    /**
     * set Manage Cache
     *
     * @param  int   $user_id        //User ID
     * @param  int   $object_id      //Object ID(Portal/Portlet Layout/My Portal)
     * @param  array $authority_list //Authority List
     *
     * @return void
     */
    function setManageCache($user_id, $object_id, $authority_list)
    {
        //Set Manage Cache
        foreach ($authority_list as $authority_id => $authority_value) {
            $this->_manage_cache_list[$user_id][$object_id][$authority_id]
                = $authority_value;
        }

        return;
    }

    /**
     * get Manage Cache
     *
     * @param  int $user_id   //User ID
     * @param  int $object_id //Object ID(Portal/Portlet Layout/My Portal)
     *
     * @return array  $authority_list            //Authority List
     */
    function getManageCache($user_id, $object_id)
    {
        //Check Manage Cache Availavle
        if (array_key_exists($user_id, $this->_manage_cache_list)) {
            if (array_key_exists($object_id,
                $this->_manage_cache_list[$user_id])
            ) {
                //Return Manage Cache
                return $this->_manage_cache_list[$user_id][$object_id];
            }
        }

        return false;
    }

    /**
     * clear Manage  Cache
     *
     * @return false
     */
    function clearManageCache()
    {
        $this->_manage_cache_list = [];

        return false;
    }

    /**
     * Create Target Condition
     *
     * @param  array  $target_list //Target List
     * @param  string $target_type //Target Type(user/group/static_role/dynamic_role)
     *
     * @return string $condition                 //Condition Strring
     */
    function _createTargetCondition($target_list, $target_type)
    {
        $condition = null;
        //escape!
        $app_locator = GRN_ApplicationLocator::instance();
        $db = $app_locator->getConnection('portal');

        //Create Condition From Target List
        switch ($target_type) {
            case GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE:
                $condition_list = [];
                foreach ($target_list as $target_id => $target_value) {
                    if ($target_value == 1) {
                        $condition_list[] = sprintf("'%s'",
                            $db->escape($target_id));
                    }
                }
                $condition = sprintf('(col_target IN (%s))',
                    implode(',', $condition_list));
                break;
            default:
                if (count($target_list) != 0) {
                    $keys = array_keys($target_list);
                    $escaped_keys = [];
                    foreach ($keys as $key) {
                        $escaped_keys [] = "'" . $db->escape($key) . "'";
                    }
                    $condition = sprintf('(col_target IN (%s))',
                        implode(',', $escaped_keys));
                    //escape
                }
                break;
        }

        return $condition;
    }

    /**
     * Create Object Condition
     *
     * @param  array $object_list //Object List
     *
     * @return string $condition                 //Condition String
     */
    function _createObjectCondition(& $object_list)
    {
        //Create Condition From Category List
        $condition = null;
        //escape!
        $app_locator = GRN_ApplicationLocator::instance();
        $db = $app_locator->getConnection('portal');

        if (count($object_list) != 0) {
            $keys = array_keys($object_list);
            $escaped_keys = [];
            foreach ($keys as $key) {
                $escaped_keys [] = "'" . $db->escape($key) . "'";
            }
            $condition = sprintf('(col_object IN (%s))',
                implode(',', $escaped_keys));
            //escape!
        }

        return $condition;
    }
}

/**
 * Portal Portal Manage Manager Class
 *
 * @package grn.portal
 */
class GRN_Portal_Portal_Manage_Information_Manager_Base
    extends GRN_Portal_Manage_Information_Manager_Base
{
    //Portlet Information Manager Instance
    var $_portal_information_manager_base = null;

    /**
     * Constructor
     */
    function __construct()
    {
        //Initialize Parent Class
        $this->_module_id = 'portal.system';
        $this->_table_name_list = [
            GRN_PRTL_MANAGE_TARGET_TYPE_USER         => GRN_PRTL_TABLE_PORTAL_MANAGE_USER,
            GRN_PRTL_MANAGE_TARGET_TYPE_GROUP        => GRN_PRTL_TABLE_PORTAL_MANAGE_GROUP,
            GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE  => GRN_PRTL_TABLE_PORTAL_MANAGE_STATIC_ROLE,
            GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE => GRN_PRTL_TABLE_PORTAL_MANAGE_DYNAMIC_ROLE,
        ];
        $this->_authority_list = ['manage' => 0];
    }

    /** @var self */
    private static $_instance = null;

    /**
     * Get Instance
     *
     * @return self
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get Portal Information Manager Base
     *
     * @return object $portal_Information_manager_base    //Portal Information Manager Base
     */
    function _getPortalInformationManagerBase()
    {
        if (is_null($this->_portal_information_manager_base)) {
            require_once('portal/portal_information_manager_base.csp');
            $this->_portal_information_manager_base
                = GRN_Portal_System_Portal_Information_Manager_Base::getInstance();
        }

        return $this->_portal_information_manager_base;
    }

    /**
     * Evaluate Portal List
     *
     * @param  array   $portal_list       //Portal List
     * @param  CB_User $user
     * @param  array   $dynamic_role_list //Dynamic Role List
     * @param int      $lock_mode         //Lock Mode
     *
     * @return array  $manage_list               //Evaluate Result Manage List
     */
    function evaluatePortalList(
        $portal_list,
        & $user,
        $dynamic_role_list,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get UUM Instance
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');

        //Get Portal Information Manager Base Instance
        $portal_information_manager_base
            = $this->_getPortalInformationManagerBase();

        //Get Evaluate Target List
        $targets_list = [];
        $user_id
            = $user->getOID();
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_USER]
            = [$user_id => &$user];
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_GROUP]
            = $uum->getUserGroups($user_id);
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE]
            = $uum->getUserRoles($user_id);;
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE]
            = $dynamic_role_list;

        //Initialize Manage Cache
        $manage_list = [];
        foreach (array_keys($portal_list) as $portal_id) {
            $this->setManageCache($user_id, $portal_id, $this->_authority_list);
            $manage_list[$user_id][$portal_id] = $this->_authority_list;
        }

        //Check Manage
        foreach (array_keys($targets_list) as $targets_type) {
            //Check Target List Count
            if (count($targets_list[$targets_type]) === 0) {
                continue;
            }
            $target_list =& $targets_list[$targets_type];

            //Create Condition
            $condition = null;
            $target_condition = $this->_createTargetCondition($target_list,
                $targets_type);
            $portal_condition = $this->_createObjectCondition($portal_list);
            $condition = sprintf('WHERE %s AND %s', $target_condition,
                $portal_condition);

            //Get Table Information
            $table_info = $this->_getTableInfo($targets_type);

            //Create Table Column List
            $column_list = implode(',', $this->_getColumnList($table_info));

            //Get Database
            $database = $this->_getDatabase();

            //Create Query
            $query = sprintf('SELECT %s FROM tab_%s %s', $column_list,
                $table_info->getTableName(), $condition);
            $query = $database->select_format($query, 0, -1, $lock_mode);

            //Execute Query
            $result = $database->query($query);
            if ($result === false) {
                //Throw Query Error
                $database->throwError(['query' => 'query failed: ' . $query]);
            }

            //Create RowSet With Condition
            $count = $database->num_rows($result);
            for ($i = 0; $i < $count; $i++) {
                $row = $database->fetch_assoc($result);

                //Get Portal Object
                $portal_id =& $row['col_object'];

                //Set Manage Cache
                foreach (array_keys($this->_authority_list) as $authority_id) {
                    //Get Authority Value
                    $authority_value = $row['col_authority_' . $authority_id];
                    $prev_authority_value
                        = $manage_list[$user_id][$portal_id][$authority_id];
                    $manage_list[$user_id][$portal_id][$authority_id]
                        = max($prev_authority_value,
                        $authority_value);
                }
                $this->setManageCache($user_id, $portal_id,
                    $manage_list[$user_id][$portal_id]);
            }
        }

        //Return Manage List
        return $manage_list;
    }
}

/**
 * Portal Portlet Group Manage Manager Class
 *
 * @package grn.portal
 */
class GRN_Portal_Portlet_Group_Manage_Information_Manager_Base
    extends GRN_Portal_Manage_Information_Manager_Base
{
    //Portlet Group Information Manager Instance
    var $_portlet_group_information_manager_base = null;

    /**
     * Constructor
     */
    function __construct()
    {
        //Initialize Parent Class
        $this->_module_id = 'portlet.group';
        $this->_table_name_list = [
            GRN_PRTL_MANAGE_TARGET_TYPE_USER         => GRN_PRTL_TABLE_PORTLET_GROUP_MANAGE_USER,
            GRN_PRTL_MANAGE_TARGET_TYPE_GROUP        => GRN_PRTL_TABLE_PORTLET_GROUP_MANAGE_GROUP,
            GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE  => GRN_PRTL_TABLE_PORTLET_GROUP_MANAGE_STATIC_ROLE,
            GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE => GRN_PRTL_TABLE_PORTLET_GROUP_MANAGE_DYNAMIC_ROLE,
        ];
        $this->_authority_list = ['manage' => 0];
    }

    /** @var self */
    private static $_instance = null;

    /**
     * Get Instance
     *
     * @return self
     */
    public static function getInstance()
    {
        if ( ! isset(self::$_instance)) {
            $c = __CLASS__;
            self::$_instance = new $c;
        }

        return self::$_instance;
    }

    /**
     * Get Portlet Group Information Manager Base
     *
     * @return object $portley_group_Information_manager_base    //Portlet Group Information Manager Base
     */
    function _getPortletGroupInformationManagerBase()
    {
        if (is_null($this->_portlet_group_information_manager_base)) {
            require_once('portal/portlet_group_information_manager_base.csp');
            $this->_portlet_group_information_manager_base
                = GRN_Portal_Portlet_Group_Information_Manager_Base::getInstance();
        }

        return $this->_portlet_group_information_manager_base;
    }

    /**
     * Evaluate Portlet Group List
     *
     * @param  array   $portlet_group_list //portlet group List
     * @param  CB_User $user
     * @param  array   $dynamic_role_list  //Dynamic Role List
     * @param int      $lock_mode          //Lock Mode
     *
     * @return array  $manage_list               //Evaluate Result Manage List
     */
    function evaluatePortletGroupList(
        $portlet_group_list,
        & $user,
        $dynamic_role_list,
        $lock_mode = CB_DATABASE_DEFAULT_LOCK
    ) {
        //Get UUM Instance
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');

        //Get Portlet Group Information Manager Base Instance
        $portlet_group_information_manager_base
            =& $this->_getPortletGroupInformationManagerBase();

        //Get Evaluate Target List
        $targets_list = [];
        $user_id
            = $user->getOID();
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_USER]
            = [$user_id => &$user];
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_GROUP]
            = $uum->getUserGroups($user_id);
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_STATIC_ROLE]
            = $uum->getUserRoles($user_id);;
        $targets_list[GRN_PRTL_MANAGE_TARGET_TYPE_DYNAMIC_ROLE]
            = $dynamic_role_list;

        //Initialize Manage Cache
        $manage_list = [];
        foreach (array_keys($portlet_group_list) as $portlet_group_id) {
            $this->setManageCache($user_id, $portlet_group_id,
                $this->_authority_list);
            $manage_list[$user_id][$portlet_group_id] = $this->_authority_list;
        }

        //Check Manage
        foreach (array_keys($targets_list) as $targets_type) {
            //Check Target List Count
            if (count($targets_list[$targets_type]) === 0) {
                continue;
            }
            $target_list =& $targets_list[$targets_type];

            //Create Condition
            $condition = null;
            $target_condition
                = $this->_createTargetCondition($target_list,
                $targets_type);
            $portlet_group_condition
                = $this->_createObjectCondition($portlet_group_list);
            $condition = sprintf('WHERE %s AND %s', $target_condition,
                $portlet_group_condition);

            //Get Table Information
            $table_info = $this->_getTableInfo($targets_type);

            //Create Table Column List
            $column_list = implode(',', $this->_getColumnList($table_info));

            //Get Database
            $database =& $this->_getDatabase();

            //Create Query
            $query = sprintf('SELECT %s FROM tab_%s %s', $column_list,
                $table_info->getTableName(), $condition);
            $query = $database->select_format($query, 0, -1, $lock_mode);

            //Execute Query
            $result = $database->query($query);
            if ($result === false) {
                //Throw Query Error
                $database->throwError(['query' => 'query failed: ' . $query]);
            }

            //Create RowSet With Condition
            $count = $database->num_rows($result);
            for ($i = 0; $i < $count; $i++) {
                $row = $database->fetch_assoc($result);

                //Get Portlet Group ID
                $portlet_group_id =& $row['col_object'];

                //Set Manage Cache
                foreach (array_keys($this->_authority_list) as $authority_id) {
                    //Get Authority Value
                    $authority_value = $row['col_authority_' . $authority_id];
                    $prev_authority_value
                        = $manage_list[$user_id][$portlet_group_id][$authority_id];
                    $manage_list[$user_id][$portlet_group_id][$authority_id]
                        = max($prev_authority_value,
                        $authority_value);
                }
                $this->setManageCache($user_id, $portlet_group_id,
                    $manage_list[$user_id][$portlet_group_id]);
            }
        }

        //Return Manage List
        return $manage_list;
    }
}


