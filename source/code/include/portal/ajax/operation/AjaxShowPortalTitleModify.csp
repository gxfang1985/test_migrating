<?php

namespace grn\portal\ajax\operation;


use grn\grn\JSONResponse;
use grn\portal\ajax\AjaxCommanderConstraints;
use grn\portal\ajax\PortalAjaxCommandInterface;

require_once('portal/portal_logic.csp');
require_once('portal/manage_logic.csp');
require_once('grn/smarty.csp');
require_once('portal/error_code.csp');

class AjaxShowPortalTitleModify implements PortalAjaxCommandInterface
{
    /** @var array */
    private $input;
    /** @var JSONResponse */
    private $jsonResponse;

    /**
     * @param array        $input
     * @param JSONResponse $jsonResponse
     */
    public function __construct(array $input, JSONResponse $jsonResponse)
    {
        $this->input = $input;
        $this->jsonResponse = $jsonResponse;
    }

    /**
     */
    public function execute()
    {
        $this->jsonResponse->validateAjaxAccess();

        $portalId = cb_at($this->input, "portal_id");
        if (is_null($portalId)) {
            cb_throw_error(E_COMMON_MISSING_MANDATORY);
        }

        //Get Portal
        $system_portallogic = \GRN_Portal_SystemPortalLogic::getInstance();
        $portal = $system_portallogic->get($portalId);

        //Evaluate Access Right of Portal
        $access_logic = \GRN_Portal_SystemPortalAccessLogic::getInstance();
        $access_logic->evaluateAccess($portal);

        //Evaluate Manage Right
        $manage_logic = \GRN_Portal_SystemPortalManageLogic::getInstance();
        $manage_logic->evaluateManage($portal, true);

        // instantiate an Smarty object
        $t = new \GRN_Smarty;

        // SmartyValidate should be initialized when an input form is there.
        require('SmartyValidate.class.php');
        \SmartyValidate::connect($t);
        \SmartyValidate::register_form(AjaxCommanderConstraints::OPERATION_AJAX_SHOW_PORTAL_TITLE_MODIFY,
            true);

        // multilanguage Infomation
        $logic = \GRN_Portal_OperationPortalLogic::getInstance();
        $localLanguageValues
            = $logic->createMultiLanguageValuesArray($portalId);

        $multiLanguageInfoArray = [];
        $multiLanguageInfoArray['element_name'] = GRN_PRTL_ELEMENT_NAME_PORTAL;
        $multiLanguageInfoArray['values'] = $localLanguageValues;
        $t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

        $t->assign('form_name',
            AjaxCommanderConstraints::OPERATION_AJAX_SHOW_PORTAL_TITLE_MODIFY);

        //Get Application Locator
        $locator = \GRN_ApplicationLocator::instance();
        //Set Application Name
        $t->assign('app_name', $locator->getName('portal'));

        // Display Smarty Template
        $t->display("portal/operation/ajax_show_modify.tpl");
    }
}
