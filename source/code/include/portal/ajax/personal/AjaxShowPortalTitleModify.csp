<?php

namespace grn\portal\ajax\personal;


use grn\grn\JSONResponse;
use grn\portal\ajax\AjaxCommanderConstraints;
use grn\portal\ajax\PortalAjaxCommandInterface;

require_once('grn/application.csp');
require_once('portal/portal_logic.csp');
require_once('portal/inspection.csp');

class AjaxShowPortalTitleModify implements PortalAjaxCommandInterface
{
    /** @var array */
    private $input;
    /** @var JSONResponse */
    private $jsonResponse;

    /**
     * @param array        $input
     * @param JSONResponse $jsonResponse
     */
    public function __construct(array $input, JSONResponse $jsonResponse)
    {
        $this->input = $input;
        $this->jsonResponse = $jsonResponse;
    }

    /**
     */
    public function execute()
    {
        $this->jsonResponse->validateAjaxAccess();

        // instantiate an Smarty object
        $t = new \GRN_Smarty;

        // SmartyValidate should be initialized when an input form is there.
        require('SmartyValidate.class.php');
        \SmartyValidate::connect($t);
        \SmartyValidate::register_form(AjaxCommanderConstraints::PERSONAL_AJAX_SHOW_PORTAL_TITLE_MODIFY,
            true);

        $portalId = cb_at($this->input, "portal_id");
        if (is_null($portalId)) {
            cb_throw_error(E_COMMON_MISSING_MANDATORY);
        }

        // Evaluate Access
        require_once('portal/access_logic.csp');
        $myPortalAccessLogic = \GRN_Portal_MyPortalAccessLogic::getInstance();
        $myPortalAccessLogic->evaluateAccess();

        $myPortalLogic = \GRN_Portal_MyPortalLogic::getInstance();
        $portal = $myPortalLogic->get($portalId);
        $t->assign('portal',
            ['pid' => $portal->getOID(), 'title' => $portal->get('name')]);
        $t->assign('form_name',
            AjaxCommanderConstraints::PERSONAL_AJAX_SHOW_PORTAL_TITLE_MODIFY);

        //Get Application Locator
        $locator = \GRN_ApplicationLocator::instance();
        //Set Application Name
        $t->assign('app_name', $locator->getName('portal'));

        // Display Smarty Template
        $t->display("portal/personal/ajax_show_portal_modify.tpl");
    }
}
