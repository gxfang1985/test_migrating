<?php

namespace grn\portal\dao;

class GrnPortalPortalLayoutDAO
{
    /** @var \CB_DatabaseConnection */
    private $db;

    /**
     * @param \CB_DatabaseConnection $db
     */
    public function __construct($db)
    {
        $this->db = $db;
    }

    /**
     * @param string $portalId
     *
     * @return bool
     */
    public function isFixedWidth($portalId)
    {
        $query
            = $this->db->format("SELECT COUNT(*) AS count FROM tab_grn_portal_portallayout WHERE col_portal = '@S'",
            [$portalId]);
        $result = $this->db->query($query);
        $row = $this->db->fetch_assoc($result);
        $fixed = false;
        if ($row) {
            $fixed = ($row['count'] > 0);
        }

        return $fixed;
    }

    /**
     * @param string $portalId
     *
     * @return array
     */
    public function getPortalLayoutSettings($portalId)
    {
        $query
            = $this->db->format("SELECT col_portal, col_settings FROM tab_grn_portal_portallayout WHERE col_portal = '@S'",
            [$portalId]);
        $result = $this->db->query($query);
        $settings = [];
        if ($row = $this->db->fetch_assoc($result)) {
            $settings = @json_decode($row['col_settings'], true);
            if ( ! is_array($settings)) {
                $settings = [];
            }
        }

        return $settings;
    }

    /**
     * @param string $portalId
     * @param array  $settings
     *
     * @return bool
     */
    public function setPortalLayoutSettings($portalId, $settings)
    {
        $settingsChar = json_encode($settings);
        $query
            = $this->db->format("INSERT INTO tab_grn_portal_portallayout (`col_portal`, `col_settings`) VALUES ('@S', '@S') ON DUPLICATE KEY UPDATE `col_settings`='@S'",
            [$portalId, $settingsChar, $settingsChar]);

        return $this->db->query($query);
    }

    /**
     * @param $portalId
     *
     * @return bool|\mysqli_result
     */
    public function deletePortalLayoutSettings($portalId)
    {
        $query
            = $this->db->format("DELETE FROM tab_grn_portal_portallayout WHERE `col_portal` = '@S'",
            [$portalId]);

        return $this->db->query($query);
    }
}
