<?php

require_once('fw/database.csp');
require_once('portal/bean/GrnPortalPortletLocal.csp');

class GrnPortalPortletLocalDAO
{
    /**
     * @param                       $inDataObj
     * @param GrnPortalPortletLocal $inPortletLocalObj
     *
     * @return bool
     */
    public function deleteByParentId_LanguageCode(
        $inDataObj,
        $inPortletLocalObj
    ) {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inParentId = $inPortletLocalObj->getParentId();
        $inLanguageCode = $inPortletLocalObj->getLanguageCode();

        $query = "DELETE FROM tab_grn_portal_portlet_local";
        $query = $query . " WHERE parent_id='" . $inDb->escape($inParentId)
                 . "' AND language_id = (SELECT _id FROM tab_cb_language_status WHERE col_language='"
                 . $inDb->escape($inLanguageCode) . "');";
        if ($inDb->query($query) === false) {
            $inDb->throwServerError($query);
        }

        return true;
    }

    /**
     * @param                       $inDataObj
     * @param GrnPortalPortletLocal $inPortletLocalObj
     *
     * @return bool
     */
    public function insert($inDataObj, $inPortletLocalObj)
    {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inParentId = $inPortletLocalObj->getParentId();
        $inLanguageCode = $inPortletLocalObj->getLanguageCode();
        $inName = $inPortletLocalObj->getName();

        $query
            = "INSERT INTO tab_grn_portal_portlet_local( parent_id, language_id, col_name )";
        $query = $query . " VALUES ( '" . $inDb->escape($inParentId)
                 . "', (SELECT _id FROM tab_cb_language_status WHERE col_language='"
                 . $inDb->escape($inLanguageCode) . "'), '"
                 . $inDb->escape($inName) . "');";
        if ($inDb->query($query) === false) {
            $inDb->throwServerError($query);
        }

        return true;
    }

    /**
     * @param                       $inDataObj
     * @param GrnPortalPortletLocal $inPortletLocalObj
     *
     * @return bool|int
     */
    public function update($inDataObj, $inPortletLocalObj)
    {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inParentId = $inPortletLocalObj->getParentId();
        $inLanguageCode = $inPortletLocalObj->getLanguageCode();
        $inName = $inPortletLocalObj->getName();

        $query = "UPDATE tab_grn_portal_portlet_local";
        $query = $query . " SET col_name = '" . $inDb->escape($inName) . "'";
        $query = $query . " WHERE parent_id = '" . $inDb->escape($inParentId)
                 . "'";
        $query = $query
                 . " AND language_id = (SELECT _id FROM tab_cb_language_status WHERE col_language='"
                 . $inDb->escape($inLanguageCode) . "');";

        if ($inDb->query($query) === false) {
            $inDb->throwServerError($query);
        }

        $updateCount = $inDb->affected_rows();

        return $updateCount;
    }

    /**
     * @param                       $inDataObj
     * @param GrnPortalPortletLocal $inPortletLocalObj
     *
     * @return GrnPortalPortletLocal
     */
    public function selectByPortletId_LanguageCode(
        $inDataObj,
        $inPortletLocalObj
    ) {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];
        $inParentId = $inPortletLocalObj->getParentId();
        $inLanguageCode = $inPortletLocalObj->getLanguageCode();

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query
                 . " FROM tab_grn_portal_portlet_local pl, tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = '" . $inDb->escape($inParentId)
                 . "'";
        $query = $query . " AND l.col_language = '"
                 . $inDb->escape($inLanguageCode) . "'";

        $result = $inDb->query($query);

        if (($result === false) || ($inDb->num_rows($result) != 1)) {
            if ($result) {
                $inDb->free_result($result);
            }

            return false;
        }

        $rawdata = $inDb->fetch_assoc($result);
        $inDb->free_result($result);

        $grnPortletLocal = new GrnPortalPortletLocal($rawdata);

        return $grnPortletLocal;
    }

    /**
     * @param $inDataObj
     * @param $inType
     *
     * @return GrnPortalPortletLocal[]
     */
    public function getPortletLocalListByType($inDataObj, $inType)
    {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query . " FROM tab_grn_portal_portlet p";
        $query = $query . ", tab_grn_portal_portlet_local pl";
        $query = $query . ", tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = p._id";
        $query = $query . " AND p.col_type = '" . $inDb->escape($inType) . "'";
        $query = $query . " ORDER BY p.col_list_index";

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnPortletLocalArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnPortletLocal = new GrnPortalPortletLocal($rawdata);
            $grnPortletLocalArray[] = $grnPortletLocal;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnPortletLocalArray;
    }

    /**
     * @param $inDataObj
     * @param $inType
     * @param $inExportLanguageCodeArray
     *
     * @return GrnPortalPortletLocal[]
     */
    public function getPortletLocalListByType_LanguageCodes(
        $inDataObj,
        $inType,
        $inExportLanguageCodeArray
    ) {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $inEscapeExportLanguageCodeArray = [];
        foreach ($inExportLanguageCodeArray as $langCode) {
            $inEscapeExportLanguageCodeArray[] = $inDb->escape($langCode);
        }
        $inLanguageCodes = implode("','", $inEscapeExportLanguageCodeArray);

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query . " FROM tab_grn_portal_portlet p";
        $query = $query . ", tab_grn_portal_portlet_local pl";
        $query = $query . ", tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = p._id";
        $query = $query . " AND p.col_type = '" . $inDb->escape($inType) . "'";
        $query = $query . " AND l.col_language IN ('${inLanguageCodes}')";
        $query = $query . " ORDER BY p.col_list_index";

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnPortletLocalArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnPortletLocal = new GrnPortalPortletLocal($rawdata);
            $grnPortletLocalArray[] = $grnPortletLocal;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnPortletLocalArray;
    }

    /**
     * @param $inDataObj
     * @param $inType
     * @param $inAllowPortletGroupIdArray
     *
     * @return GrnPortalPortletLocal[]
     */
    public function getPortletLocalListByType_GroupIds(
        $inDataObj,
        $inType,
        $inAllowPortletGroupIdArray
    ) {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $inEscapeAllowPortletGroupIdArray = [];
        foreach ($inAllowPortletGroupIdArray as $id) {
            $inEscapeAllowPortletGroupIdArray[] = $inDb->escape($id);
        }
        $inGroupIds = implode("','", $inEscapeAllowPortletGroupIdArray);

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query . " FROM tab_grn_portal_portlet p";
        $query = $query . ", tab_grn_portal_portlet_local pl";
        $query = $query . ", tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = p._id";
        $query = $query . " AND p.col_type = '" . $inDb->escape($inType) . "'";
        $query = $query . " AND p.col_group IN ('${inGroupIds}')";
        $query = $query . " ORDER BY p.col_list_index";

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnPortletLocalArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnPortletLocal = new GrnPortalPortletLocal($rawdata);
            $grnPortletLocalArray[] = $grnPortletLocal;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnPortletLocalArray;
    }

    /**
     * @param $inDataObj
     * @param $inType
     * @param $inAllowPortletGroupIdArray
     * @param $inExportLanguageCodeArray
     *
     * @return GrnPortalPortletLocal[]
     */
    public function getPortletLocalListByType_GroupIds_LanguageCodes(
        $inDataObj,
        $inType,
        $inAllowPortletGroupIdArray,
        $inExportLanguageCodeArray
    ) {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $inEscapeAllowPortletGroupIdArray = [];
        foreach ($inAllowPortletGroupIdArray as $id) {
            $inEscapeAllowPortletGroupIdArray[] = $inDb->escape($id);
        }
        $inGroupIds = implode("','", $inEscapeAllowPortletGroupIdArray);

        $inEscapeExportLanguageCodeArray = [];
        foreach ($inExportLanguageCodeArray as $langCode) {
            $inEscapeExportLanguageCodeArray[] = $inDb->escape($langCode);
        }
        $inLanguageCodes = implode("','", $inEscapeExportLanguageCodeArray);

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query . " FROM tab_grn_portal_portlet p";
        $query = $query . ", tab_grn_portal_portlet_local pl";
        $query = $query . ", tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = p._id";
        $query = $query . " AND p.col_type = '" . $inDb->escape($inType) . "'";
        $query = $query . " AND p.col_group IN ('${inGroupIds}')";
        $query = $query . " AND l.col_language IN ('${inLanguageCodes}')";
        $query = $query . " ORDER BY p.col_list_index";

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnPortletLocalArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnPortletLocal = new GrnPortalPortletLocal($rawdata);
            $grnPortletLocalArray[] = $grnPortletLocal;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnPortletLocalArray;
    }

    /**
     * @param $inDataObj
     * @param $inPortletId
     *
     * @return GrnPortalPortletLocal[]
     */
    public function getPortletLocalListByPortletId($inDataObj, $inPortletId)
    {
        /** @var CB_DatabaseConnection $inDb */
        $inDb = $inDataObj['db'];

        $query
            = "SELECT pl.parent_id, pl.language_id, pl.col_name, l.col_language";
        $query = $query
                 . " FROM tab_grn_portal_portlet_local pl, tab_cb_language_status l";
        $query = $query . " WHERE pl.language_id = l._id";
        $query = $query . " AND pl.parent_id = '" . $inDb->escape($inPortletId)
                 . "'";

        $result = $inDb->query($query);

        if ($result === false) {
            //Throw Query Error
            $inDb->throwError(['query' => 'query failed: ' . $query]);
        }

        $grnPortletLocalArray = [];
        while ($rawdata = $inDb->fetch_assoc($result)) {
            $grnPortletLocal = new GrnPortalPortletLocal($rawdata);
            $grnPortletLocalArray[$grnPortletLocal->getLanguageCode()]
                = $grnPortletLocal;
        }
        $inDb->free_result($result);
        $result = false;

        return $grnPortletLocalArray;
    }
}
