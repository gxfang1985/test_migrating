<?php

cb_require_role('CommandLine');

global $G_config_common;
if ($G_config_common->get('BackupMode', 'disable')) {
    echo "Usage: Backupmode is disabled.\n";
    exit(1);
}

require_once('fw/backupmode.csp');
require_once('fw/date.csp');
$daysofweek = [
    'sun' => 0,
    'mon' => 1,
    'tue' => 2,
    'wed' => 3,
    'thu' => 4,
    'fri' => 5,
    'sat' => 6
];

//format check
$unregister = null;
$register = null;
for ($i = 1; $i < $argc; $i++) {
    if (preg_match("#^--unregister=[']?((\\\'|[^'])*)[']?$#", $argv[$i],
        $regs)
    ) {
        $unregister = $regs[1];
    }
}
for ($i = 1; $i < $argc; $i++) {
    if (preg_match("#^--register=[']?((\\\'|[^'])*)[']?$#", $argv[$i], $regs)) {
        $register = $regs[1];
    }
}

$days = null;
$start = null;
$period = null;
$message = null;
for ($i = 1; $i < $argc; $i++) {
    if ( ! is_null($unregister)) {
        if (preg_match("#^--unregister=[']?((\\\'|[^'])*)[']?$#", $argv[$i],
            $regs)
        ) {
            ;
        } else {
            echo "Usage: ${argv[0]} [--unregister='name'] [--register='name' --days='(sun|mon|tue|wed|thu|fri|sat)(,(sun|mon|tue|wed|thu|fri|sat)*)' --start='hh:mm' --period='minutes' [--message='message']]\n";
            exit(1);
        }
    } elseif ( ! is_null($register)) {
        if (preg_match("#^--register=[']?((\\\'|[^'])*)[']?$#", $argv[$i],
            $regs)
        ) {
            ;
        } elseif (preg_match("#^--days=[']?((sun|mon|tue|wed|thu|fri|sat)(,(sun|mon|tue|wed|thu|fri|sat))*)[']?$#",
            $argv[$i], $regs)
        ) {
            $days = $regs[1];
        } elseif (preg_match("#^--start=[']?([0-9][0-9]:[0-9][0-9])[']?$#",
            $argv[$i], $regs)
        ) {
            $start = $regs[1];
        } elseif (preg_match("#^--period=[']?([0-9]*)[']?$#", $argv[$i], $regs)
                  && is_numeric($regs[1])
        ) {
            $period = $regs[1];
        } elseif (preg_match("#^--message=[']?((\\\'|[^'])*)[']?$#", $argv[$i],
            $regs)
        ) {
            $message = $regs[1];
        } else {
            echo "Usage: ${argv[0]} [--unregister='name'] [--register='name' --days='(sun|mon|tue|wed|thu|fri|sat)(,(sun|mon|tue|wed|thu|fri|sat)*)' --start='hh:mm' --period='minutes' [--message='message']]\n";
            exit(1);
        }
    } else {
        echo "Usage: ${argv[0]} [--unregister='name'] [--register='name' --days='(sun|mon|tue|wed|thu|fri|sat)(,(sun|mon|tue|wed|thu|fri|sat)*)' --start='hh:mm' --period='minutes' [--message='message']]\n";
        exit(1);
    }
}

if ( ! is_null($unregister)) {
    cb_unregister_backupmode_schedule($unregister);
} elseif ( ! is_null($register)) {
    if (is_null($days) || is_null($start) || is_null($period)) {
        echo "Usage: ${argv[0]} [--unregister='name'] [--register='name' --days='(sun|mon|tue|wed|thu|fri|sat)(,(sun|mon|tue|wed|thu|fri|sat)*)' --start='hh:mm' --period='minutes' [--message='message']]\n";
        exit(1);
    }

    //validation and conversion
    $days = explode(',', $days);
    $temp = [];
    foreach ($days as $day) {
        $temp[$daysofweek[$day]] = $day;
    }
    $days = array_keys($temp);

    $start_time = new CB_Time();
    $start_time->parse("$start:00");
    if ( ! cb_date_validate_time($start_time)) {
        echo "Invalid time: --start='$start'\n";
        exit(1);
    }

    $day_command = '';
    $delim = '';
    foreach ($days as $day) {
        $day_command .= $delim . $day;
        $delim = ',';
    }
    $minute_command = $start_time->minute;
    $hour_command = $start_time->hour;
    $command = "$minute_command $hour_command * * $day_command";

    cb_register_backupmode_schedule($register, $command, $period, $message);
}

$list = cb_backupmode_schedule_list();

echo "schedule list:\n";
echo "name ; days ; start(hh:mm) ; period(min)\n";
echo "----------------------------------------\n";

$daysofweek = array_keys($daysofweek);
foreach ($list as $key => $item) {
    $name = $key;
    $days = '';
    $start = '';
    $period = $item['period'];

    $command = explode(' ', $item['command']);

    //days
    $day_commands = explode(',', $command[4]);
    $days = [];
    foreach ($day_commands as $day_command) {
        $days[] = $daysofweek[intval($day_command)];
    }
    $days = implode(',', $days);

    //start
    $start = sprintf('%02d:%02d', $command[1], $command[0]);

    echo "$name ; $days ; $start ; $period\n";
}


