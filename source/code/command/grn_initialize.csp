<?php
require_once("grn/cli.csp");
require_once("fw/Initialization.csp");

function isStartInitialization()
{
    echo "Do you really initialize Garoon? (y/[n]) :";
    $stdin = fopen('php://stdin', 'r');
    $line = trim(fgets($stdin));
    fclose($stdin);
    if (strlen($line) == 0) {
        return false;
    }
    if (strtolower(substr($line, 0, 1)) != "y") {
        return false;
    }

    return true;
}

// flush output
while (ob_get_level() > 0) {
    ob_end_flush();
}

//$options = array(
//    "db_admin_password" => "cybozu",
//	"db_user_password" => "cybozu",
//    "garoon_admin_password" => "cybozu",
//    "default_timezone" => "Asia/Tokyo",
//    "default_locale" => "ja",
//    "force_initialize" => "yes",
//);
$options = cb_cli_start(
// Mandatory command-line options
    [
        new CB_CLI_DB_ADMIN_PASSWORD_OPTION(),
        new CB_CLI_DB_USER_PASSWORD_OPTION(),
        new CB_CLI_GAROON_ADMIN_PASSWORD_OPTION(),
        new CB_CLI_DEFAULT_TIMEZONE_OPTION(),
        new CB_CLI_DEFAULT_LOCALE_OPTION(),
    ],

    // Optional command-line options
    [
        new CB_CLI_FORCE_INITIALIZE_OPTION(),
        new CB_CLI_INIT_DATA_OPTION()
    ]
);

if ( ! (array_key_exists("force_initialize", $options)
        && $options["force_initialize"] == "yes")
) {
    if (isStartInitialization() === false) {
        return;
    }
}

if ( ! preg_match('/^[a-zA-Z0-9_]{6,10}$/ ', $options["db_user_password"])) {
    echo "Database user password is invalid.\nValid characters are: A-Z, a-z, 0-9, and underscore (_).\nPassword must contain 6 characters and no more than 10.\nPlease type again!\n";

    return;
}

// End Transaction.
require_once('fw/transaction.csp');
CB_TransactionManager::getInstance()->commit();

global $G_container_base, $G_config_common;
require_once('fw/profile.csp');

if ( ! isset($options["init_data"]) || strlen($options["init_data"]) == 0) {
    $options["init_data"] = "0";
}

require_once("grn/application.csp");
$initialization = new Initialization($G_config_common, $G_container_base,
    GRN_ApplicationLocator::instance());
$initialization->setDbAdminPassword($options["db_admin_password"]);
$initialization->setDbUserPassword($options["db_user_password"]);
$initialization->setGaroonAdminPassword($options["garoon_admin_password"]);
$initialization->setDefaultLocale($options["default_locale"]);
$initialization->setDefaultTimezone($options["default_timezone"]);
$initialization->setInitDataType($options["init_data"]);
$initialization->start();

cb_cli_end("");

