<?php

cb_require_role('CommandLine');

/*
 * Forcibly reset the administration password (the database password)
 * from command-line.
 *
 * ToDo: Hide user input from keyboard. (but how?)
 *       In UNIX, we may use 'stty -echo'.
 *       In Windows, Shima-san says ANSI escape sequence may be used.
 */

// disable output buffering for command-line
while (ob_get_level() > 0) {
    ob_end_clean();
}

// enable automatic flushing upon every 'echo'.
ob_implicit_flush();

//////////////////////////////////////////////////////////////////////////

$host = ini_get('mysqli.default_host');
$host = trim($host);
if ($host !== '' && $host !== 'localhost') {
    echo "ERROR: This program is executable on server that database engine is running.\n";
    exit(1);
}

echo "WARNING: THIS WILL BE RESET THE ADMINISTRATION PASSWORD!\n";
echo "Continue? [No]: ";

$console = fopen('php://stdin', 'r');
if ($console === false) {
    exit(1);
}

$ans = fgets($console);
if ((strlen($ans) == 0)
    || (strncasecmp($ans, 'y', 1) != 0)
) {
    exit(1);
}

echo 'New Password: ';
$p1 = trim(fgets($console), "\r\n");
echo 'Retype Password: ';
$p2 = trim(fgets($console), "\r\n");

if (strcmp($p1, $p2) != 0) {
    echo "Password does not match!  Try again.\n";
    exit(1);
}

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$uum->changePassword(GRN_UUM_ADMINISTRATION_USER, $p1, $p2, true);


