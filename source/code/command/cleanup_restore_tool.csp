<?php

cb_require_role('CommandLine');

require_once('grn/cli.csp');

$opts = cb_cli_start(
// Mandatory command-line options
    [
    ],
    // Optional command-line options
    [
        new CB_CLI_EXEC_OPTION()
    ]
);

global $G_container_base;
$dbconn =& $G_container_base->getInstance("dbconn");

//  EXEC オプションが付与されていない場合の処理
if (array_key_exists(CB_CLI_EXEC_OPTION, $opts) === false) {
    // SQL クエリ文
    $query = "select max(_id) from tab_grn_message_messages";
    // SQL クエリを実行する
    $ret = $dbconn->query($query);

    // SQL クエリの実行結果を添字配列として取得する
    $row = $dbconn->fetch_row($ret);

    // カウント値を 0にする
    $count = 0;

    // $row  が 0 かどうか
    if ($row !== false) {
        // 引数の取得
        $count = $row[0];
    }
    // SQL クエリの実行結果をメモリから開放する
    $dbconn->free_result($ret);

    // SQL クエリの実行結果をログファイルへ出力
    cb_cli_log("tab_grn_message_messages: max id = $count");

    $query = "select * from tab_grn_message_messages_sequence";
    $ret = $dbconn->query($query);
    $row = $dbconn->fetch_row($ret);
    $count = 0;
    if ($row !== false) {
        $count = $row[0];
    }
    $dbconn->free_result($ret);
    cb_cli_log("tab_grn_message_messages_sequence: max id = $count");

    $query = "select max(_id) from tab_grn_schedule_event";
    $ret = $dbconn->query($query);
    $row = $dbconn->fetch_row($ret);
    $count = 0;
    if ($row !== false) {
        $count = $row[0];
    }
    $dbconn->free_result($ret);
    cb_cli_log("tab_grn_schedule_event: max id = $count");

    $query = "select * from tab_grn_schedule_event_sequence";
    $ret = $dbconn->query($query);
    $row = $dbconn->fetch_row($ret);
    $count = 0;
    if ($row !== false) {
        $count = $row[0];
    }
    $dbconn->free_result($ret);
    cb_cli_log("tab_grn_schedule_event_sequence: max id = $count");

// EXEC オプションを付与した場合の処理
} else {
    $query = "select max(_id) from tab_grn_message_messages";
    $ret = $dbconn->query($query);
    $row = $dbconn->fetch_row($ret);
    $count = 0;
    if ($row !== false) {
        $count = $row[0];
    }
    $dbconn->free_result($ret);

    if (is_null($count)) {
        cb_cli_log("There is no need to update tab_grn_message_messages_sequence.col_next_id.");
    } else {
        $sql
            = "update tab_grn_message_messages_sequence set col_next_id = $count";
        $sql_ret = $dbconn->query($sql);

        cb_cli_log("tab_grn_message_messages: max id = $count");
        cb_cli_log($sql);
    }

    $query = "select max(_id) from tab_grn_schedule_event";
    $ret = $dbconn->query($query);
    $row = $dbconn->fetch_row($ret);
    $count = 0;
    if ($row !== false) {
        $count = $row[0];
    }
    $dbconn->free_result($ret);

    if (is_null($count)) {
        cb_cli_log("There is no need to update tab_grn_schedule_event_sequence._id.");
    } else {
        $sql = "update tab_grn_schedule_event_sequence set _id = $count";
        $sql_ret = $dbconn->query($sql);

        cb_cli_log("tab_grn_schedule_event: max id = $count");
        cb_cli_log($sql);
    }
}

cb_cli_end();


