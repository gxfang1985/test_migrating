<?php

cb_require_role('CommandLine');

require_once('grn/cli.csp');

$summary = "";

$opts = cb_cli_start(
// Mandatory command-line options
    [new CB_CLI_BEFORE_OPTION()],

    // Optional command-line options
    [new CB_CLI_EXEC_OPTION()]
);

if (array_key_exists(CB_CLI_BEFORE_OPTION, $opts)) {
    $before = cb_date_convert2timestamp($opts[CB_CLI_BEFORE_OPTION]);
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $message_db = $app_locator->getConnection('message');
    // execute
    if (array_key_exists(CB_CLI_EXEC_OPTION, $opts)) {
        // list mid and log
        $query_list
            = "SELECT messages._id as mid_groupby FROM tab_grn_message_messages AS messages 
                INNER JOIN tab_grn_message_addressees AS addressees
                ON messages._id = addressees.col_message
                WHERE messages.col_creator != addressees.col_addressee
                AND addressees.col_is_operator = 1
                AND messages.col_ctime < $before
                GROUP BY messages._id";
        $ret = $message_db->query($query_list);
        $count = 0;
        while ($row = $message_db->fetch_assoc($ret)) {
            cb_cli_log(sprintf("Deleted maintainer of mid=%s.",
                $row["mid_groupby"]));
            $count++;
        }

        // clear all maintaince right of user who isn't creator
        $query_delete
            = "UPDATE tab_grn_message_addressees,tab_grn_message_messages
            SET tab_grn_message_addressees.col_is_operator = 0
            WHERE tab_grn_message_messages.col_creator != tab_grn_message_addressees.col_addressee
            AND tab_grn_message_messages._id = tab_grn_message_addressees.col_message
            AND tab_grn_message_messages.col_ctime < $before;";
        $result = $message_db->query($query_delete);

        //$affected_row = $message_db->affected_rows();
        $summary .= "Deleted maintainer $count record";
        $summary .= ($count > 1) ? "s." : ".";
    } else {
        // count row for delete maintainer
        $query
            = "SELECT COUNT(DISTINCT messages._id) AS total FROM tab_grn_message_messages AS messages 
            INNER JOIN tab_grn_message_addressees AS addressees
            ON messages._id = addressees.col_message
            WHERE messages.col_creator != addressees.col_addressee
            AND addressees.col_is_operator = 1
            AND messages.col_ctime < $before;";
        $result = $message_db->query($query);
        $row = $message_db->fetch_assoc($result);
        $total = $row["total"];
        $summary .= "Hit $total record";
        $summary .= ($total > 1) ? "s." : ".";
    }
}

cb_cli_end($summary);


