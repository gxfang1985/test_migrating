<?php

cb_require_role('CommandLine');

use grn\grn\access\service\AppAccess;

/**
 * メールの自動受信イベント（子プロセス）
 */
// メールを取得する
require_once('grn/application.csp');
require_once('mail/application.csp');
require_once('mail/connection.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Mail_App $mail_app */
$mail_app =& $app_locator->getInstance('mail');
if ( ! is_object($mail_app) || ! is_a($mail_app, 'GRN_Mail_App')) {
    cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
}
// コマンドライン引数からユーザーIDを取得する
global $G_INPUT;
$user_id = $G_INPUT['user_id'];
! AppAccess::checkInternalAccess('mail', $user_id);
$utility =& $mail_app->getUtility();
$receive =& $utility->getRecvLogic();
$folder =& $utility->getFolderLogic();

// 通知を取得する
require_once('notification/application.csp');
/** @var GRN_Notification_App $notify_app */
$notify_app =& $app_locator->getInstance('notification');

$max_receive_size = $mail_app->getConfig('max_auto_receive_size');
if ($max_receive_size === false || ! is_numeric($max_receive_size)) {
    $max_receive_size = -1;
}

// ユーザーを取得する
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$user =& $uum->getUser($user_id);
$uum->loginAs($user);

// デフォルトメールアカウント情報を取得する
$account_info = $mail_app->getDefaultMailAccountInfo($user);
if ( ! is_null($account_info)) {
    // メールアカウントIDを取得する
    $account_id = $account_info['id'];

    // メールアカウントを取得する
    $mail_config =& $utility->getSystemConfig();
    // システムで設定されている保存メールサイズの取得
    $mail_config->getSizeUserLimitSetting($size_settings, $user_id);
    $account =& $mail_config->_getAccountRow($account_id);
    if (is_object($account) && is_a($account, 'GRN_Mail_Account')) {
        // 組み込みフォルダを初期化する
        $folder->_initSpecialFolders($user, $account);

        $mail_config =& $utility->getPersonalConfig($user);
        if ($mail_config->checkAccountForReceive($account_id, $no_account,
            $no_server)
        ) {
            // 現在の保存メールサイズ
            $mail_size = $mail_config->getMailSize(null);
            // 既に受信している保存メールサイズが、制限値をオーバーしているかチェック
            if (($size_settings['user_limit_' . $user_id] < 0)
                || ($mail_size < $size_settings['user_limit_' . $user_id] * 1024
                                 * 1024)
            ) {
                // 外部通知（通知メール）使用フラグを取得する
                $use_notify = false;
                if (is_object($notify_app)
                    && is_a($notify_app, 'GRN_Notification_App')
                ) {
                    $tmp = false;
                    $notify_config =& $notify_app->getPersonalConfig($user);
                    $notify_config->getNotUseNotify($tmp);
                    $use_notify = ! $tmp;
                }

                $max_receive_count = $mail_app->getConfig('max_receive_count');

                // メールを受信する
                $mail_id_list = $receive->recvMails($user, $account_id,
                    $use_notify, $max_receive_count, $remaining,
                    $notify_received_num, $max_receive_size);
            }
        }
    }
}


