<?php

if (defined('ON_FOREST')) {
    return;
}

cb_require_role('CommandLine');

require_once('grn/cli.csp');
require_once('fw/i18n.csp');
require_once('system/logging/file.csp');

$opts = cb_cli_start(
// Mandatory command-line options
    [
    ],

    // Optional command-line options
    [
    ]
);

//Get archive settings
require_once('grn/logger.csp');
$config = GRN_Logging_SystemConfig::getInstance();
$retention_period = $config->getRetentionPeriod();
if (empty($retention_period)) {
    $retention_period = 3;
}

//Log
$logic = GRN_LoggingLogic::getInstance();

//Date
require_once('fw/date.csp');

$milestones = mktime(0, 0, 0);
$max_ts = $milestones - ($retention_period * 365 * 24 * 60 * 60);

global $G_container_base;
$dbconn =& $G_container_base->getInstance('dbconn');
$query
    = "SELECT _id, col_title_sort_key FROM tab_grn_logging_file WHERE col_ctime < "
      . $max_ts;
$ret = $dbconn->query($query);

$fm = new GRN_Logging_FileManager_Core();

//Delete files
$result = [];
while ($row = $dbconn->fetch_row($ret)) {
    $fm->deleteFile($row[0]);
    $result[] = $row[1];
}

//Display result
$total = count($result);
$summary = 'No deleted file';
if ($total > 0) {
    $summary = 'Deleted files : ';
    for ($i = 0; $i < $total - 1; $i++) {
        $summary .= $result[$i] . ', ';
    }
    $summary .= $result[$total - 1];
}

cb_cli_end($summary);
