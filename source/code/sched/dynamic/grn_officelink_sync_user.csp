<?php
$flag_last_day_of_month = '';
if (count($argv) > 1) {
    $flag_last_day_of_month = $argv[1];
}

require_once('dezielink/system_logic.csp');
$sys_logic = GRN_OfficeLink_SystemLogic::getInstance();

if (empty($flag_last_day_of_month)
    // sync daily, weekly, monthly
    || strcmp($flag_last_day_of_month, 'last_day_of_month') === 0
       // sync on last day of month
       && $sys_logic->isLastDayOfMonth()
) {
    // Do sync user
    $connector_available = $sys_logic->getConnectorAvailable();
    if ( ! $connector_available) {
        require_once('dezielink/error_code.csp');
        cb_throw_error(E_GRN_OFLK_APP_DISABLED);
    }

    if ( ! $sys_logic->getSyncUserAvailable()) {
        return;
    }

    $url = $sys_logic->getURL();

    require_once('dezielink/sync_user_logic.csp');
    $sync_logic = GRN_OfficeLink_SyncUserLogic::getInstance($url);

    require_once('dezielink/sync_user_manager.csp');
    $sync_man = GRN_Connector_SyncUserManager::getInstance();
    $sync_man->setSyncLogic($sync_logic);

    $sync_man->runSync();

    //Logging
    require_once('dezielink/inspection.csp');
    $logger = GRN_Dezielink_Inspection::getInstance();

    if ($logger->isEnabled()) {
        $log_params = ['url' => $url];
        $logger->writeInspectionLogNotice('sync', 'officelink_sync_user',
            $log_params);
    }
}

