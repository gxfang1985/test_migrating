<?php

use  grn\grn\access\service\AppAccess;

/**
 * ログイン時の新着メールチェック
 */
function plugin_fw_uum_login_grn_mail_check_new_mails($user)
{
    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();

    if ( ! AppAccess::isAppAvailableInternalAccess('mail')) {
        return;
    }

    // ログイン直後フラグをセット
    $mail_app = $locator->getInstance('mail');
    $mail_app->setLoginFlag();

    // システム画面では行わない
    $page_parts = explode('/', cb_get_pagename());
    if (isset($page_parts[0]) && is_array($page_parts)) {
        foreach ($page_parts as $value) {
            if ($value == 'system') {
                return;
            }
        }
    }

    // メールアプリ使用不可設定
    require_once('mail/system_config.csp');
    $system_config = GRN_Mail_SystemConfig::getInstance();
    if ( ! $system_config->canUseMail()) {
        return;
    }

    // 新着メールチェック不許可設定
    $system_config->getGeneralSetting($general_settings);
    if ( ! $general_settings['check_mail_on_login']) {
        return;
    }

    // 新着メールチェック実行
    require_once('mail/recv.csp');
    $recv_logic = GRN_Mail_ReceiveLogic::getInstance();
    $recv_logic->getNewMailCountForAllAccount($user, 0, true, false);
}


