<?php
/** Set First View Portal
 *
 * @author  Yuichi, Nakamura 2005/03
 * @version 1.0
 */

//Include Files
require_once('portal/resources.csp');

function plugin_fw_uum_login_grn_portal_first_view($user)
{
    //Get Active Application IDs
    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();
    $app_ids = $locator->getActiveApplicationIds();

    //Get Request Application ID
    $page_path = strtolower(cb_get_pagename());
    $page_parts = explode('/', $page_path);
    $app_id = $page_parts[0];

    //Check Portal Application
    if ($app_id == 'index') {
        //Set Top Application
        if (count($app_ids) === 0) {
            return;
        }
        $app_id = current($app_ids);
    }
    if ($app_id != 'portal') {
        //No Portal Application
        return;
    }
    if ( ! in_array($app_id, $app_ids)) {
        //Not Active 
        return;
    }

    $selected_portal_id = null;

    //Get UUM Instance
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');

    require_once('portal/system_logic.csp');
    $portal_systemlogic = GRN_Portal_SystemLogic::getInstance();

    //Get User Group FirstView Portal
    $group_portal_id_list = [];
    //$group_list = $uum->getUserGroups($user->getOID());
    $group_list = $uum->getUserGroupsInfo($user->getOID());
    if (is_array($group_list)) {
        $group_portal_id_list
            = $portal_systemlogic->getOrganizationLoginPortalList(array_keys($group_list));
    }

    if (count($group_portal_id_list) === 1) {
        $selected_portal_id = current($group_portal_id_list);
    }

    //Get Primary Group FirstView Portal
    if ( ! $selected_portal_id) {
        $primary_group = $uum->getUserPrimaryGroup($user->getOID());
        if ($primary_group === false) {
            $selected_portal_id = current($group_portal_id_list);
        } else {
            $primary_group_id = $primary_group->getOID();
            if (array_key_exists($primary_group_id, $group_portal_id_list)) {
                $selected_portal_id = $group_portal_id_list[$primary_group_id];
            } else {
                $selected_portal_id = current($group_portal_id_list);
            }
        }
    }

    //Get Current Portal ID From FirstView Portal
    if ( ! $selected_portal_id) {
        $selected_portal_id = $portal_systemlogic->getOrganizationLoginPortal();
    }

    //Set Selected Portal ID
    if ($selected_portal_id) {
        //Set Selected Portal ID to URL
        global $G_INPUT;
        $G_INPUT['pid'] = $selected_portal_id;

        //Set Selected Portal ID to Session
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession(GRN_PRTL_MODULE_ID);
        $session->set(GRN_PRTL_SESSION_GROUP_INDEX,
            [GRN_PRTL_SESSION_CURRENT_ID => $selected_portal_id]);
    }

    return;
}


