<?php

use grn\favour\service\FavourService;
use grn\favour\Application;

function plugin_fw_uum_login_grn_favour_get_notify_data()
{
    global $G_INPUT;
    global $G_config_common;

    if ( ! cb_is_init_process() && ! cb_is_cbpapi() && ! cb_is_rest_api()) {
        // ログインユーザーを取得する
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();
        if ($login && is_a($login, 'CB_User')) {
            require_once('grn/application.csp');
            $app_locator = GRN_ApplicationLocator::instance();
            /** @var Application $favour_app */
            $favour_app
                = $app_locator->getInstance(Application::APPLICATION_ID);
            if ( ! $favour_app) {
                return;
            }

            $favour_service = new FavourService();
            $favour_notify_count
                = $favour_service->getFavourNotifyCountByUserId($login->getOID());
            require_once('fw/session_manager.csp');
            $session_manager = CB_SessionManager::getInstance();
            $session = $session_manager->getSession('notification');
            $session->set("favour_notify_number", $favour_notify_count);
            $session->set("last_time_update", time());
        }
    }
}
