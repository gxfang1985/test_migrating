<?php

function plugin_fw_uum_logout_grn_presence_auto_set_absence($user)
{
    global $G_INPUT;
    if ( ! ! cb_is_cellular_page()) {
        return;
    }

    if ( ! array_key_exists('_notimecard', $G_INPUT)
         || ! $G_INPUT['_notimecard']
    ) {
        // auto change presence info
        require_once('presence/config.csp');
        $config_manager = GRN_Presence_ConfigManager::getInstance();
        $system_config = $config_manager->getSystemConfig();
        $auto_change_presence_info
            = $system_config->getAutoChangePresenceInfo();
        if ($auto_change_presence_info['auto_set_absence']) {
            // presence info is absence
            $presence_info = [];
            $presence_info['status'] = 'absence';
            $presence_info['memo'] = '';
            $presence_info['mode'] = 'default';

            $absence_time = new CB_TimeStamp();
            $absence_time->unix_ts = time();

            // set absence for login user
            require_once('presence/logic.csp');
            $presence_logic = GRN_Presence_Logic::getInstance();
            $presence_logic->setPresence($user->getOID(), $presence_info,
                $absence_time, false);
        }
    }
}


