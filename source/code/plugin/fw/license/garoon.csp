<?php

require_once('fw/license.csp');
require_once('grn/license.csp');

class plugin_fw_license_garoon extends CB_LicenseBaseDriver
{
    function getResponse($challenge)
    {
        return md5('9752071af32161d2ab9b8db522cb1c8e 0109 af38822a662ced88901084e956661738'
                   . $challenge);
    }

    function showWarning()
    {
        return false;
    }

    function forceRedirect()
    {
        global $G_INPUT;
        global $G_config_common;

        if (cb_is_init_process()) {
            return false;
        }

        if (cb_is_rest_api()) {
            // REST API license check will be done within RestApiHandler
            return false;
        }

        $lm = GRN_LicenseManager::getInstance();
        $license_info = $lm->getLicense(GRN_LICENSE_BASESYSTEM);

        if ($license_info === false) {
            cb_throw_error(E_GRN_LICENSE_FAIL_VARIDATION);
        }

        global $G_license_mode;
        $G_license_mode = $lm->getStatus($license_info);

        if ($G_license_mode !== GRN_LICENSE_SUCCESS) {
            // 除外リストの生成
            $exclude_pathes['information'] = 1;
            $exclude_pathes['license'] = 1;

            if ($G_license_mode === GRN_LICENSE_OVER_USER) {
                $exclude_pathes['user'] = 1;
            }

            $page_parts = explode('/', strtolower(cb_get_pagename()));

            if ((strcmp('system', $page_parts[0]) == 0)
                && count($page_parts) >= 3
            ) {
                // 除外リスト内は自由に移動可能
                if (array_key_exists($page_parts[1], $exclude_pathes)) {
                    return false;
                }

                // おしらせへ強制遷移
                return 'system/index.csp';
            } elseif ((strcmp('system', $page_parts[0]) == 0)) {
                // 基本システム画面内も自由に移動可能
                return false;
            } else {
                require_once('grn/application.csp');
                $locator = GRN_ApplicationLocator::instance();
                $app = $locator->getInstance($page_parts[0]);

                // アプリケーションの場合
                if ($app) {
                    if (count($page_parts) > 1) {
                        // アプリケーションの管理画面への遷移の場合
                        if (strcmp($page_parts[1], 'system') === 0) {
                            // 除外リスト内は自由に移動可能
                            if (array_key_exists($page_parts[1],
                                $exclude_pathes)
                            ) {
                                return false;
                            }

                            // おしらせへ強制遷移
                            return 'system/index.csp';
                        }
                    }
                }
                // ライセンス期限ぎれの場合
                if ($G_license_mode === GRN_LICENSE_EXPIRED) {
                    // 試用期限切れ
                    return 'grn/license_expired.csp';
                }
            }
        }

        return false;
    }
}


