<?php

require_once('util_api/logic.csp');

/**
 * @param array $error_info
 */
function plugin_fw_error_hook_util_api($error_info)
{
    if (grn_util_api_get_debug_file_name()) {
        ob_start();
        print_r($error_info);
        $log_message = ob_get_contents();
        ob_end_clean();

        $log_message = "ERROR\n" . html_entity_decode($log_message, ENT_QUOTES);
        grn_util_api_debug($log_message);
    }

    // clean up upload temp files
    global $G_state_set;
    if ($G_state_set->get('util_api.upload_tmp_files')) {
        require_once('util_api/util.csp');
        util_api_cleanup_upload_temp_file();
    }

    // Save error message into log file only when request is an API request
    global $G_authentication_force_driver;
    if ($G_authentication_force_driver == 'util_api') {
        _util_api_save_start_log_if_necessary($error_info['ErrorNumber']);

        $err_mesg = "Error = \"" . $error_info['ErrorNumber'] . "; "
                    . $error_info['ErrorDiag']
                    . $error_info['ErrorCause']
                    . $error_info['ErrorCounterMeasure'] . "\"";
        grn_util_api_save_finish_log($err_mesg);
    }
}

function _util_api_save_start_log_if_necessary($errorcode)
{
    require_once('grn/error_code.csp');
    static $NO_START_LOG_ERRORS = [
        E_GRN_NO_SYSTEM_PRIVILEGE                => 1,
        E_GRN_CMMN_AUTH_LOGIN_LOAD_PLUGIN_FAILED => 1,
    ];

    if (array_key_exists($errorcode, $NO_START_LOG_ERRORS)) {
        global $G_container_base;
        $grn_uum =& $G_container_base->getInstance('uum');
        $login_user = $grn_uum->getLoginUser();

        $util_api_service = GRN_Util_Api_Service::getInstance();

        if (is_a($login_user, 'CB_User')) {
            $user_info = $grn_uum->getUserInfo($login_user->getOID(),
                ['col_foreign_key']);
            $util_api_service->set_login_account($user_info['col_foreign_key']);
        }

        $util_api_service->save_start_log();
    }
}


