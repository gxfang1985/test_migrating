<?php

use grn\schedule\AttendanceStatusLogic;

/**
 * @author  Y.Tanaka        2005/01
 * @package grn.schedule
 */

require_once('cellular/component.csp');

class plugin_grn_schedule_cellular_component extends GRN_Cellular_ComponentBase
{

    function __construct()
    {
        parent::__construct('schedule');
    }

    function isSupported($key)
    {
        if ($key == 'icon') {
            return true;
        }

        if ($key == 'top') {
            return true;
        }

        if ($key == 'index') {
            return true;
        }

        return false;
    }

    function getContent($key)
    {
        if ($key == 'icon') {
            return $this->getIcon();
        }

        if ($key == 'top') {
            return $this->getTop();
        }

        if ($key == 'index') {
            return $this->getIndex();
        }

        return false;
    }

    function getIcon()
    {
        return 'watch';
    }

    function getTop()
    {
        require_once('schedule/application.csp');
        $app = GRN_Schedule_Application::getInstance();

        global $G_container_app;
        $uum = $G_container_app->getInstance('uum');

        $login = $uum->getLoginUser();

        require_once('schedule/personal_logic.csp');
        $personallogic = GRN_Schedule_PersonalLogic::getInstance();
        require_once('schedule/system_logic.csp');
        $systemlogic = GRN_Schedule_SystemLogic::getInstance();

        // ログインユーザーの各種設定の取得
        $hiddenprivate = $systemlogic->getHiddenPrivate();

        require_once('fw/date.csp');

        $ts = new CB_TimeStamp();
        $ts->unix_ts = time();
        $tsex = new CB_TimeStampEx($ts);
        $today = $tsex->getDate();

        $sc_type = GRN_SCHEDULE_EVENT_TYPE_NORMAL
                   + GRN_SCHEDULE_EVENT_TYPE_ALLDAY
                   + GRN_SCHEDULE_EVENT_TYPE_BANNER;

        $attendanceStatusLogic = new AttendanceStatusLogic();
        $isEnableAttendanceStatus
            = $attendanceStatusLogic->isEnableAttendanceCheck();

        $events = $app->getEvents(
            $login, $today, $today, $login, $sc_type, $hiddenprivate, true,
            $isEnableAttendanceStatus
        );

        if ($isEnableAttendanceStatus) {
            require_once("schedule/view_util.csp");
            $util = GRN_Schedule_View_Util::getInstance();
            foreach (['normal', 'allday'] as $type) {
                $events[$type] = $util->filterAbsentEvents($events[$type]);
            }
        }

        $num = count($events['allday']) + count($events['normal'])
               + count($events['banner']);

        return [
            'order'  => 10,
            'type'   => 'file',
            'file'   => 'schedule/cellular/todayevents',
            'params' => ['count' => $num],
        ];
    }

    function getIndex()
    {
        return [
            'type'   => 'file',
            'file'   => 'schedule/cellular/index',
            'params' => null,
        ];
    }

}


