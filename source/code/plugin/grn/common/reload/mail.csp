<?php

// 再読み込みが押されたときの処理
// ポータルとメールのindex画面で押された場合にメールの新着チェックを行う
function plugin_grn_common_reload_mail($id)
{
    if ((strcasecmp($id, 'portal') !== 0) && (strcasecmp($id, 'mail') !== 0)) {
        return;
    }

    // アプリトップページ取得
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app =& $app_locator->getInstance($id);
    if ( ! is_object($app)) {
        return;
    }

    $index_name = $app->getConfig('index');
    if (is_string($index_name)) {
        // indexページかどうかチェック
        $page_parts = explode('/', cb_get_pagename());
        $index_name = explode('/', $index_name);
        if (isset($page_parts[1]) && isset($index_name[1])
            && (strcasecmp($index_name[1], $page_parts[1]) != 0)
        ) {
            return;
        }
    }

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user =& $uum->getLoginUser();
    if ( ! is_object($user)) {
        return;
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();

    // メールの使用が許可されているか
    $system_config =& $utility->getSystemConfig();
    $system_config->getGeneralSetting($general_settings);
    if ( ! $general_settings['disable_mail']) {
        // 全アカウントの新着メール数を取得
        $recv_logic =& $utility->getRecvLogic();
        $recv_logic->getNewMailCountForAllAccount($user, 5, true, false);
    }
}


