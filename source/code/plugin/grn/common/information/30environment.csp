<?php

require_once('grn/information.csp');

class plugin_grn_common_information_30environment
    extends GRN_SystemInformationLogicBase
{
    function __construct()
    {
        parent::__construct('environment');
    }

    function getContents()
    {
        ////////////////////
        // マシン情報
        ////////////////////
        $machine = [];

        $machine[] = [
            'id'    => 'OS',
            'value' => cb_getserveros()
        ];
        $machine[] = [
            'id'    => 'SCRIPT_ENGINE',
            'value' => PHP_VERSION
        ];
        $machine[] = [
            'id'    => 'HOST',
            'value' => php_uname()
        ];

        ////////////////////
        // 環境変数情報
        ////////////////////
        $env = [];
        $info = $this->getMessage('_server_info');
        $is_IIS_server = false;
        if (array_key_exists('SERVER_SOFTWARE', $_SERVER)) {
            $webserver_info = $_SERVER['SERVER_SOFTWARE'];
            $pos = strpos($webserver_info, 'Microsoft-IIS');
            if ($pos !== false) {
                $is_IIS_server = true;
            }
        }
        foreach ($info as $id => $memo) {
            $value = @ $_SERVER[$id];
            if ('DOCUMENT_ROOT' == $id) {
                if ($is_IIS_server) {
                    $value = substr($_SERVER['PATH_TRANSLATED'],
                        0,
                        -strlen($_SERVER['PATH_INFO']));
                } else {
                    if (0 == strlen($value)) {
                        $value = substr($_SERVER['PATH_TRANSLATED'],
                            0,
                            -strlen($_SERVER['PATH_INFO']));
                    }
                }
            }
            $env[] = [
                'id'    => $id,
                'value' => $value,
                'memo'  => $memo
            ];
        }

        $basedir = cb_basedir();
        if (strncasecmp(php_uname('s'), 'WIN', 3) === 0) {
            $basedir = str_replace('\\', '/', $basedir);
        }
        // 環境情報追加
        $env[] = [
            'id'    => 'Dir',
            'value' => $basedir,
            'memo'  => $this->getMessage('Dir')
        ];

        global $G_config_common;
        $db_dir = $G_config_common->get('Files', 'dir');

        $pos = strpos($db_dir, 'mysql');
        if ($pos !== false) {
            $pos = strpos($db_dir, '/', $pos);
            $db_dir = substr($db_dir, 0, $pos);

            $free = disk_free_space($db_dir);
        } else {
            $free = 0;
            $db_dir = '';
        }
        $free = number_format($free);
        $env[] = [
            'id'    => 'DiskFreeSpace',
            'dir'   => $db_dir,
            'value' => $free,
            'memo'  => $this->getMessage('DiskFreeSpace')
        ];


        $info = [
            'machine' => $machine,
            'env'     => $env
        ];
        require_once('grn/smarty.csp');
        $t = new GRN_Smarty();
        $t->assign('info', $info);
        $contents = $t->fetch('grn/information_environment.tpl');

        return $contents;
    }
}


