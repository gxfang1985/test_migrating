<?php
/**
 * Emviroment Valiable Authenticate Driver
 *
 * @author  Yuichi, Nakamura 2005/02
 * @version 1.0
 */

//Include Files
require_once('grn/authentication.csp');

//String Resources
define('GRN_AUTH_AUTHENTICATE_ENVIRONMENT_VIEW_SYSTEM',
    'system/authentication/authenticate/view_environment.csp');     //Driver System View Page
define('GRN_AUTH_AUTHENTICATE_ENVIRONMENT_ADD_SYSTEM',
    'system/authentication/authenticate/add_environment.csp');      //Driver System Add Page
define('GRN_AUTH_AUTHENTICATE_ENVIRONMENT_MODIFY_SYSTEM',
    'system/authentication/authenticate/modify_environment.csp');   //Driver System Modify Page

class plugin_grn_common_authentication_authenticate_environment
    extends GRN_Authentication_Authenticate_DriverBase
{
    /** Configuration Parameters **/
    var $_driver_settings
        = [
            'variable_name'     => null,    //Environment Variable Name
            'credential_format' => null,    //Credential Format
            'credential_prefix' => null,    //Credential Prefix String
            'credential_suffix' => null     //Credential Suffix String
        ];

    /** User Repository Driver **/
    var $_user_repository = null;

    /** Configuration Complete Flag **/
    var $_configured = false;

    /**
     * Constructor
     *
     */
    function __construct()
    {
        $noPage = null;
        //Create Driver Page Setting
        $driver_page = [
            GRN_AUTH_PAGE_TYPE_VIEW_SYSTEM     => GRN_AUTH_AUTHENTICATE_ENVIRONMENT_VIEW_SYSTEM,
            GRN_AUTH_PAGE_TYPE_ADD_SYSTEM      => GRN_AUTH_AUTHENTICATE_ENVIRONMENT_ADD_SYSTEM,
            GRN_AUTH_PAGE_TYPE_MODIFY_SYSTEM   => GRN_AUTH_AUTHENTICATE_ENVIRONMENT_MODIFY_SYSTEM,
            GRN_AUTH_PAGE_TYPE_VIEW_PERSONAL   => $noPage,
            GRN_AUTH_PAGE_TYPE_ADD_PERSONAL    => $noPage,
            GRN_AUTH_PAGE_TYPE_MODIFY_PERSONAL => $noPage,
        ];

        //Initialize Parent Class
        parent::__construct(cb_msg(GRN_AUTH_AUTHENTICATE_ENVIRONMENT, 'name'),
            GRN_AUTH_AUTHENTICATE_ENVIRONMENT,
            $driver_page
        );
    }

    /**
     * Set Driver Config
     *
     * @param  array  $driver_settings //Driver Settings
     * @param  object $repository      //User Repository Driver Object
     *
     * @return bool     $result
     */
    function setConfig(& $driver_settings, $repository)
    {
        //Check Arguments
        if ( ! is_array($driver_settings)) {
            //Driver Configuration Failed
            return false;
        }
        if ( ! array_key_exists('variable_name', $driver_settings)
             ||
             ! array_key_exists('credential_format', $driver_settings)
        ) {
            //Driver Configuration Failed
            return false;
        }

        //Check User Repository Driver
        if ( ! is_object($repository)) {
            return false;
        }

        //Set Driver Configuration
        $this->_driver_settings['variable_name']
            = $driver_settings['variable_name'];
        $this->_driver_settings['credential_format']
            = $driver_settings['credential_format'];
        $this->_driver_settings['credential_prefix']
            = @$driver_settings['credential_prefix'];
        $this->_driver_settings['credential_suffix']
            = @$driver_settings['credential_suffix'];

        //Set User Repository Driver
        $this->_user_repository = $repository;

        //Set Configuration Complete Flag
        $this->_configured = true;

        //Driver Configuration Success
        return true;
    }

    /**
     * Get Driver Config
     *
     * @return array    $driver_settings    //Driver Settings
     */
    function &getConfig()
    {
        //Check Configuration Complete Flag
        return $this->_driver_settings;
    }

    /**
     * Authenticate
     *
     * @return bool    $result
     */
    function authenticate()
    {
        //Check Configuration Complete Flag
        if ( ! $this->_configured) {
            return false;
        }

        //Get Environment Variable
        $environment_value = getenv($this->_driver_settings['variable_name']);
        if (strlen($environment_value) === 0) {
            return false;
        }

        //Process Prefix and Suffix String
        $prefix =& $this->_driver_settings['credential_prefix'];
        $suffix =& $this->_driver_settings['credential_suffix'];
        if (strlen($prefix) > 0) {
            $prefix_pos = mb_strpos($environment_value, $prefix);
            $environment_value = mb_substr($environment_value, $prefix_pos + 1);
        }
        if (strlen($suffix) > 0) {
            $suffix_pos = mb_strrpos($environment_value, $suffix);
            $environment_value = mb_substr($environment_value, 0, $suffix_pos);
        }

        //Preccess Credential Format
        $account = null;
        $password = null;
        $format =& $this->_driver_settings['credential_format'];
        switch ($format) {
            case 'account':
                $account = $environment_value;
                break;
            case 'account:password':
                $values = explode(':', $environment_value);
                $account = $values[0];
                $password = $values[1];
            default:
                $account = $environment_value;
                break;
        }

        //Get GRN_UUM Instance
        global $G_container_base;
        $grn_uum = $G_container_base->getInstance('uum');

        //Check Account
        $user = $grn_uum->getUserByForeignKey($account);
        if ( ! $user) {
            return false;
        }

        //Check Administrator
        $uid = $user->getOID();
        if ($uid == GRN_UUM_ADMINISTRATION_USER) {
            return false;
        }

        //Authenticate
        $repository = $this->_user_repository;
        if ( ! $repository->authenticate($account, $password, false)) {
            //Authenticate Failed
            return false;
        }

        //Save Authenticated Account and Password
        parent::setAccount($account);
        parent::setPassword($password);

        //Authenticate Success
        return true;
    }

    /**
     * Set Credential
     *
     * @param  string $account  //Account
     * @param  string $password //Password
     *
     * @return bool    $result
     */
    function setCredential($account, $password)
    {
        /** Always TRUE (No Credential)**/
        return true;
    }

    /**
     * Get Credential
     *
     * @param  int $user_id
     *
     * @return bool|string $credential               //Credential
     */
    function getCredential($user_id = null)
    {
        return true;
    }

    /**
     * Reset Credential
     *
     * @return bool    $result
     */
    function resetCredential()
    {
        /** Always TRUE (No Credential)**/
        return true;
    }
}

