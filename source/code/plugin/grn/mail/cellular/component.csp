<?php

/**
 * @author  Y.Tanaka        2005/01
 * @package grn.schedule
 */

require_once('cellular/component.csp');

class plugin_grn_mail_cellular_component extends GRN_Cellular_ComponentBase
{

    function __construct()
    {
        parent::__construct('mail');
    }

    function isSupported($key)
    {
        if ($key == 'icon') {
            return true;
        }
        if ($key == 'top') {
            return true;
        }
        if ($key == 'index') {
            return true;
        }

        return false;
    }

    function getContent($key)
    {
        if ($key == 'icon') {
            return $this->getIcon();
        }
        if ($key == 'top') {
            return $this->getTop();
        }
        if ($key == 'index') {
            return $this->getIndex();
        }

        return false;
    }

    function getIcon()
    {
        return 'mail';
    }

    function getTop()
    {
        $new_mails = 0;

        global $G_container_app;
        $uum =& $G_container_app->getInstance('uum');
        $login =& $uum->getLoginUser();
        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $personal_config =& $utility->getPersonalConfig($login);
        $recv_logic =& $utility->getRecvLogic();

        // デフォルトアカウント
        $account_data = $personal_config->getDefaultAccountData(false);
        if ( ! is_null($account_data)) {
            $account_id = $account_data['id'];
            // 受信可能かチェックする（ちと重い。。）
            if ($personal_config->checkAccountForReceive($account_id,
                $no_account, $no_server)
            ) {
                // 新着メール件数取得
                // メールサーバーに問い合わせる（一定間隔）
                $new_mails = $recv_logic->getNewMailCount($login, $account_id,
                    GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN, true, false);
            }
        }
        if ($new_mails) {
            return [
                'order'  => 15,
                'type'   => 'file',
                'file'   => 'mail/cellular/todayevents',
                'params' => ['count' => $new_mails],
            ];
        }

        return false;
    }

    function getIndex()
    {

        return [
            'type'   => 'link',
            'page'   => 'mail/cellular/list',
            'icon'   => $this->getIcon(),
            'params' => null,
        ];
    }

}


