<?php

function grn440_remote_main()
{
    //////////////////////////////
    // resource update
    //////////////////////////////
    cb_export_log('Started grn440_remote_main. ', false);

    global $G_config_common;

    if ( ! defined('USE_INSTALLED_MYSQL')) {
        cb_export_log("Start update my.ini.", false);
        $mysqli_default_socket = ini_get("mysqli.default_socket");
        $mysql_dir = dirname(dirname($mysqli_default_socket));
        $mysql_etc_dir = $mysql_dir . '/etc';
        $my_ini = $mysql_etc_dir . '/my.ini';
        $data = file_get_contents($my_ini);

        if ($data !== false) {
            if (cb_is_onpremises_distributed_database()) {
                //Setting my.ini
                if (preg_match('/replicate-do-table/', $data)) // Slave database
                {
                    cb_export_log("Start update replicate.", false);
                    $data = str_replace("[mysqld]",
                        "[mysqld]\nreplicate-do-table = cb_cbgrn.tab_grn_mygroup",
                        $data);
                    cb_export_log("End update replicate.", false);

                    $fp = fopen($my_ini, 'w');
                    if ( ! $fp) {
                        cb_export_log("Can not update my.ini file.", true);
                    } else {
                        fwrite($fp, $data);
                        fclose($fp);
                    }
                    unset($data);
                }
            }
        } else {
            cb_export_log("Can not read my.ini file.", true);
        }

        cb_export_log("End update my.ini.", false);

        $cb_version = $mysql_dir . '/cb_version';
        if (file_exists($cb_version)) {
            cb_export_log("Start delete cb_version.", false);
            if (unlink($cb_version) === false) {
                cb_export_log("Can not delete cb_version file.", true);
            }

            cb_export_log("End delete cb_version.", false);
        }
    }

    // Start common.ini file
    cb_export_log("Start update common.ini.", false);

    cb_export_log("Start set Global section.", false);
    $G_config_common->set('Global', 'client_ip_identify_header',
        'X-Forwarded-For');
    cb_export_log("End set Global section.", false);

    cb_export_log("Start set API section.", false);
    $G_config_common->set('API', 'version', '1.8.0');
    cb_export_log("End set API section.", false);

    cb_export_log("Start set Browser section.", false);
    $G_config_common->set('Browser', 'password_autocomplete', '1');
    cb_export_log("End set Browser section.", false);

    $G_config_common->save();
    cb_export_log("End update common.ini.", false);
    // End common.ini file

    // Start garoon.ini file
    global $G_config_grn;
    cb_export_log("Start update garoon.ini.", false);

    $version = '4.4.0';
    cb_export_log("Start set Locale section.", false);
    $G_config_grn->set('System', 'version', $version);
    $G_config_grn->set('Locale', 'ja_version', $version);
    $G_config_grn->set('Locale', 'en_version', $version);
    $G_config_grn->set('Locale', 'zh_version', $version);
    cb_export_log("End set Locale section.", false);

    $G_config_grn->save();
    cb_export_log("End update garoon.ini.", false);
    // End garoon.ini file

    // Start sched.ini file
    cb_export_log("Start update sched.ini.", false);
    $sched_ini = cb_basedir() . '/sched.ini';
    $data = file_get_contents($sched_ini);
    $data = preg_replace('/^\\s*db_logging.*$/m', "db_logging=false",
        $data);
    $fp = fopen($sched_ini, 'w');
    fwrite($fp, $data);
    fclose($fp);
    cb_export_log("End update sched.ini.", false);
    // End sched.ini file

    // Start applications ini file
    $grn_ini_dir = cb_basedir() . '/grn/';
    cb_export_log("Start update 11space.ini.", false);
    $space_ini = $grn_ini_dir . '11space.ini';
    write_ini_item($space_ini, 'version', '4.4.0');
    cb_export_log("End update 11space.ini.", false);

    cb_export_log('Finished grn440_remote_main. ', false);
    // End applications ini file
}

grn440_remote_main();
