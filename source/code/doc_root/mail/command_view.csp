<?php

global $G_INPUT;
$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];
$mail_id = @ $G_INPUT['mid'];
$cmd = @ $G_INPUT['cmd'];
if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    // メールの移動
    $mail_ids = [$mail_id];
    $new_category_id = @ $G_INPUT['dcid'];
    if ($cmd == "move") {
        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $mail_logic = $utility->getMailLogic();
        if ($new_category_id === 'another_account') {
            require_once('fw/session_manager.csp');
            $sm = CB_SessionManager::getInstance();
            $session = $sm->getSession('mail/index');

            // セッションに処理するメールデータIDリストを保存
            $session->set('mail_ids', $mail_ids);

            // 他のアカウントのフォルダ移動画面へ
            cb_redirect('mail/move_another',
                ['aid' => $account_id, 'cid' => $category_id]);
        } else {
            $mail_logic->moveMailDatas($mail_ids, $new_category_id);
        }
    } elseif ($cmd == "change") {
        $status_id = array_key_exists('status', $G_INPUT) ? $G_INPUT['status']
            : '';
        require_once('mail/status.csp');
        grn_mail_set_status($user, $mail_id, $status_id);
        cb_redirect('mail/view',
            ['aid' => $account_id, 'cid' => $category_id, 'mid' => $mail_id]);
    }
}

cb_redirect('mail/index', ['cid' => $category_id, 'aid' => $account_id]);


