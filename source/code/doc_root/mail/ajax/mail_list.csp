<?php

use grn\mail\screen\MailList;
use grn\grn\JSONResponse;

if (strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST') == 0) {
    global $G_INPUT;
    global $G_state_set;

    $G_state_set->set('html_should_be_closed', false);
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('error_page_type', 'json');

    $json = JSONResponse::create();

    $check_pane_info = cb_at($G_INPUT, 'check_pane_info');
    if ($check_pane_info === '1') {
        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $pane_info = $utility->getPaneInfo();
    } else {
        $pane_info = ['pane' => 3];
    }

    if ($pane_info['pane'] !== 3) {
        $json->response(['redirect' => cb_get_full_url('mail/index')]);
    } else {
        $mail_list_object = new MailList($G_INPUT);
        $mail_list = $mail_list_object->fetch();

        $json->response([
            'mail_list'        => $mail_list,
            'numOfUnreadMails' => $mail_list_object->getNumOfUnreadMails()
        ]);
    }
}
