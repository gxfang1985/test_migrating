<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}


// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($user);
$app = $utility->getMailApp();

//------------------

// ポートレット設定
$portlet_settings = array_key_exists('settings', $portlet)
    ? $portlet['settings'] : [];

// システムポータル
$system_flag = ($display == 'set-system' || $display == 'set-operation');

// 新着メールチェックが使用不可かどうか
if ( ! $system_config->canUserCheckMail()) {
    $check_mails = 0;
} else {
    $check_mails = array_key_exists('check_mails', $portlet_settings)
        ? $portlet_settings['check_mails'] : null;
    $check_mails = is_null($check_mails) ? GRN_MAIL_DEFAULT_CHECK_MAIL
        : (int)$check_mails;
    if (($check_mails != 0) && ($check_mails != 1)) {
        $check_mails = GRN_MAIL_DEFAULT_CHECK_MAIL;
    }
}
//GRB-14958: Ignore calling javascript get new email if view at system, operation, personal
if (count(array_diff(['system', 'operation', 'personal'],
        explode('/', cb_get_pagename()))) < 3
) {
    $check_mails = 0;
}
$t->assign('check_mails', $check_mails);

$settings_for_view = [];
$settings_for_view['font_size'] = @ $portlet_settings['font_size'];
$t->assign('settings', $settings_for_view);

$account_ids = array_key_exists('user_account', $portlet_settings)
    ? $portlet_settings['user_account'] : '';
if (is_null($account_ids)) {
    if ($system_flag) {
        // システムポータルの場合のデフォルト設定
        $account_ids = 'default';
    }
}

//------------------

// メールの使用が許可されているか
$system_config->getGeneralSetting($general_settings);
$disable_mail = $general_settings['disable_mail'];
$check_mail_on_login = $general_settings['check_mail_on_login'];

require_once('fw/ui.csp');
$browser = cb_ui_get_browser();
$t->assign('browser', $browser);

// ログイン直後フラグ
$b_on_login = $app->getLoginFlag();
if ($b_on_login) {
    // ログイン時の新着メールチェック不許可
    $t->assign('b_on_login', $b_on_login);
}

if ( ! $check_mails) {
    // メールチェックを行わない場合はインラインフレームにしないので情報取得
    include('_view_news.csp');
} else {
    include('_view_account.csp');
}

$check_span = GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN;
if (array_key_exists('check_span', $portlet_settings)) {
    $check_span = $portlet_settings['check_span'];
    if (($check_span < GRN_MAIL_MIN_CHECK_MAIL_SPAN)
        || ($check_span > GRN_MAIL_MAX_CHECK_MAIL_SPAN)
    ) {
        $check_span = GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN;
    }
}
$t->assign('check_span', $check_span);

// メール使用不許可フラグ
$t->assign('disable_mail', $disable_mail);

require_once('grn/application.csp');
require_once('mail/resources.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_name = $app_locator->getName(GRN_MAIL_APP_ID);
$t->assign('app_name', $app_name);

//Set Page Title
if ($portlet['title'] === '') {
    $page_title = cb_plain_msg('grn.mail', 'portlet_view_news',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "",
            'name' => $page_title
        ]
    ]
);


$t->assign('portlet', $portlet);
$t->assign('plid', @ $portlet['plid']);

$t->skipWarning();
// Smarty実行
$doc_name = 'mail/portlet/view_news';
$t->display("{$doc_name}.tpl");

