<?php

assert('isset( $utility ) && ! is_null( $utility )');
assert('isset( $personal_config ) && ! is_null( $personal_config )');

//------------------

// ポートレットで設定されているアカウントのリストを作成
$account_data_list_for_check = [];
if (isset($account_ids)) {
    if (is_array($account_ids) && (count($account_ids) > 0)) {
        // 表示するアカウントIDリスト(個人ポートレット)
        $account_data_list = $personal_config->getAccountDataList(false);
        foreach ($account_ids as $account_id) {
            if (isset($account_data_list[$account_id])
                && ! is_null($account_data_list[$account_id])
            ) {
                $account_data =& $account_data_list[$account_id];

                // 受信用アカウントIDリストに追加
                $account_data_list_for_check[$account_id] =& $account_data;
            }
        }
    } else {
        // システムポートレット
        if ($account_ids == 'all') {
            // 全アカウント
            $account_data_list = $personal_config->getAccountDataList(false);
            foreach (array_keys($account_data_list) as $account_id) {
                $account_data =& $account_data_list[$account_id];

                // 受信用アカウントIDリストに追加
                $account_data_list_for_check[$account_id] =& $account_data;
            }
        } else {
            // デフォルトアカウント
            $account_data = $personal_config->getDefaultAccountData(false);
            if ( ! is_null($account_data)) {
                // 受信用アカウントIDリストに追加
                $account_data_list_for_check[$account_data['id']]
                    =& $account_data;
            }
        }
    }

    $account_list_for_view = [];

    // 新着チェックするアカウントデータリスト
    $recv_logic = $utility->getRecvLogic();
    foreach (array_keys($account_data_list_for_check) as $account_id) {
        // 受信可能かチェックする（ちと重い。。）
        if ( ! $personal_config->checkAccountForReceive($account_id,
            $no_account, $no_server)
        ) {
            continue;
        }

        $account_data =& $account_data_list_for_check[$account_id];

        // 新着メール件数取得
        if (( ! isset($b_on_login) || ! $b_on_login || @$check_mails_of_portlet)
            && $check_mails
            && ($check_span > 0)
        ) {
            // メールサーバーに問い合わせる（一定間隔）
            $new_mails = $recv_logic->getNewMailCount($user, $account_id,
                $check_span, true, true);
        } else {
            // メールサーバーに問い合わせない
            $new_mails = $account_data['new_mails'];
        }

        $title = $name = $account_data['title'];

        // 表示用
        $account_list_for_view[$account_id] = [
            'aid'   => $account_id,
            'name'  => $name,
            'title' => $title,
            'count' => $new_mails
        ];
    }

    $t->assign('user_account', $account_list_for_view);
    $t->assign('has_account', count($account_list_for_view));
}


