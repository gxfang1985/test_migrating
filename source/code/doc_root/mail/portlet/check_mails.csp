<?php
/**
 * インラインフレームで新着メールチェックを行うページ
 */

// Copyrightを表示しない
global $G_state_set;
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('error_page_type', 'check_mails');

// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// ポートレットレイアウトID
global $G_INPUT;
$plid = array_key_exists('plid', $G_INPUT) ? $G_INPUT['plid'] : '';
if ( ! is_numeric($plid)) {
    require_once('portal/error_code.csp');
    cb_throw_error(E_GRN_PRTL_PORTLET_LAYOUT_INVALID_ID);
}

$b_on_login = array_key_exists('b_on_login', $G_INPUT) ? $G_INPUT['b_on_login']
    : '';

// システムポータルフラグ
$system_flag = true;                // for Debug

// デフォルト設定
$settings_for_view = [];
$settings_for_view['font_size'] = 'font_size_normal';
$check_mails
    = 1;                                   // 新着メールチェック（この画面では常にON）
$check_span = GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN;     // 間隔（秒）

require_once('grn/application.csp');
require_once('mail/resources.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_name = $app_locator->getName(GRN_MAIL_APP_ID);
$t->assign('app_name', $app_name);

//------------------

// ユーザー取得
$portlet_settings = null;
if ($user) {
    $account_ids = null;

    // ポートレットの設定を取得
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app_portal */
    $app_portal = $app_locator->getInstance('portal');
    if (is_object($app_portal)
        && method_exists($app_portal, 'getSettingsOfPortlet')
    ) {
        // ポートレット設定を取得
        $portlet_settings = $app_portal->getSettingsOfPortlet($plid);
        if (is_array($portlet_settings)) {
            $account_ids = array_key_exists('user_account', $portlet_settings)
                ? $portlet_settings['user_account'] : 'default';

            $settings_for_view['font_size'] = array_key_exists('font_size',
                $portlet_settings) ? $portlet_settings['font_size'] : '';

            // 新着メールチェック
            // この画面では常にON

            // 新着メールチェック間隔
            $check_span = array_key_exists('check_span', $portlet_settings)
                ? $portlet_settings['check_span'] : null;
            $check_span = is_null($check_span)
                ? GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN : (int)$check_span;
            if (($check_span < GRN_MAIL_MIN_CHECK_MAIL_SPAN)
                || ($check_span > GRN_MAIL_MAX_CHECK_MAIL_SPAN)
            ) {
                $check_span = GRN_MAIL_DEFAULT_CHECK_MAIL_SPAN;
            }
        } else {
            // デフォルト設定
            if ($system_flag) {
                $account_ids = 'default';           // デフォルトアカウントを表示
            }
        }
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $personal_config = $utility->getPersonalConfig($user);

    $check_mails_of_portlet = 1;
    include('_view_news.csp');
}

$t->assign('plid', $plid);

$t->assign('settings', $settings_for_view);

// 新着メールチェック
$t->assign('check_mails', $check_mails);

// 新着メールチェックの間隔（秒）
$t->assign('check_span', $check_span);

require_once('fw/ui.csp');
$browser = cb_ui_get_browser();
$t->assign('browser', $browser);

$t->skipWarning();

// Smarty実行
$doc_name = 'mail/portlet/check_mails';
$t->display("{$doc_name}.tpl");


