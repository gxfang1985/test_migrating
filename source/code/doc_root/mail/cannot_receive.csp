<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
$user_id = $user->getOID();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];
$reverse = @ $G_INPUT['reverse'];
if (is_null($reverse) || (strlen($reverse) == 0)) {
    $reverse = true;
}

//------------------

// 表示する件数取得
require_once("grn/ui.csp");
$ui_config_manager = GRN_UIConfigManager::getInstance();
$ui_config = $ui_config_manager->getUserConfig($user);
$subject_cols = $ui_config->getSubjectWidth();
$name_cols = $ui_config->getNameWidth();

//------------------

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$personal_config = $utility->getPersonalConfig($user);
$system_config = $utility->getSystemConfig();
$folder_logic = $utility->getFolderLogic();
$recv_logic = $utility->getRecvLogic();

$t->assign('app_name', $G_mail_name);

// メールの使用が許可されているか
$system_config->getGeneralSetting($general_settings);
$disable_mail = $general_settings['disable_mail'];
$check_mail_on_login = $general_settings['check_mail_on_login'];

// 送受信記録を使用する設定
$use_address_history = $system_config->canUserUseHistory();

$name_type = null;
if ($use_address_history) {
    $name_type = 'history';
} else {
    // 送受信できる設定がされているか
    $can_send = false;
    if ( ! $disable_mail) {
        $temp = null;
        $personal_config->checkCommunicationSetting($temp, $can_recv,
            $can_send);
    }

    if ($can_send) {
        $name_type = 'send';
    }
}

//------------------

// サイズの上限設定取得
$system_config->getSizeUserLimitSetting($size_settings, $user_id);

if ($size_settings['receive_limit_' . $user_id] == -1) {
    $receive_limit_for_view = '';
    $receive_limit_for_byte_view = '';
} else {
    if ($size_settings['receive_limit_' . $user_id] >= 1024) {
        $receive_limit_for_view = ($size_settings['receive_limit_' . $user_id]
                                   / 1024) . 'MB';
    } else {
        $receive_limit_for_view = $size_settings['receive_limit_' . $user_id]
                                  . 'KB';
    }

    $receive_limit_for_byte_view = number_format($size_settings['receive_limit_'
                                                                . $user_id]
                                                 * 1024) . 'byte';
}

//------------------

// エラーメールリスト
$error_mails = $recv_logic->getPop3ErrorMailDataList($account_id, $reverse);

$error_mails_for_view = [];
foreach (array_keys($error_mails) as $key) {
    $error_mail =& $error_mails[$key];

    $error_mails_for_view[$key] = [
        'id'          => $key,
        'aid'         => $account_id, //user_acount_ID
        'cid'         => $category_id, //category_ID
        'uid'         => $error_mail['uid'],
        'subject'     => $error_mail['subject'],
        'from'        => $error_mail['from'],
        'ctime'       => $error_mail['send_ts'], //送信日時
        'attach_file' => $error_mail['attached'],
        'size'        => $error_mail['size'],
    ];
}

//------------------

// page title
$page_title = grn_get_current_page_display_name(['app_name' => $G_mail_name]);
$t->assign('page_title', $page_title);

// フォルダ情報
$folder_detail = false;
include('_folder_common.csp');

$t->assign('category', $category_for_view);

$t->assign(
    'site_position',
    [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index)
        ],
        [
            'page' => $page_index,
            'name' => $page_folder,
            'aid'  => $account_id,
            'cid'  => $category_id
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

// メール使用不許可フラグ
$t->assign('disable_mail', $disable_mail);
$t->assign('name_type', $name_type);

// set_data
$t->assign(
    'set', [
        'file_size' => $receive_limit_for_view,
        'file_unit' => $receive_limit_for_byte_view
    ]
);

// mail_data
$t->assign('mails', $error_mails_for_view);

$t->assign('reverse', $reverse ? 0 : 1);

// 表示文字数
$t->assign(
    'characters', [
        'subject' => $subject_cols, //表題
        'name'    => $name_cols //名前＋Email
    ]
);

// can not receive delete multi
$delete_info_multi = [
    'title'        => grn_get_page_display_name('mail/cannot_receive_delete_multi',
        ['app_name' => $G_mail_name]),
    'page'         => 'mail/cannot_receive_delete_multi.tpl',
    'no_confirm'   => false,
    'data'         => ['category' => $category_for_view],
    'handler'      => 'btn_delete_multi',
    'multi_target' => 'uids[]',
    'form_target'  => 'mail/cannot_receive',
];
$t->assign('delete_info_multi', $delete_info_multi);
//-- show page
$t->display(cb_get_pagename() . ".tpl");

