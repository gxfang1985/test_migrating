<?php

use grn\mail\dao\GrnMailReceivedFileRelationDAO;
use grn\mail\dao\GrnMailFileInfoDAO;

global $G_INPUT;
$mail_id = @ $G_INPUT['mid'];

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $mail_logic = $utility->getMailLogic();

    // 添付ファイルの削除
    $mail_data = $mail_logic->getMailData($mail_id, false);
    if ($mail_data['sent']) {
        $mail_logic->deleteAttachedFiles($mail_id);
    } elseif (defined('ON_FOREST')) {
        // 受信メールかつフォレスト環境ではGRN35-1365
        $relationDao = new GrnMailReceivedFileRelationDAO();
        $fileInfoDao = new GrnMailFileInfoDAO();
        $userId = $user->getOID();
        $tableName = 'tab_' . grn_mail_get_personal_tablename($userId,
                GRN_MAIL_FILEINFO_TABLE);
        $fileIds = $fileInfoDao->getFileIdsByMailId($mail_id, $tableName);
        /** @var CB_BlobFileManager $fm */
        $fm = $G_container_base->getInstance('file_manager');
        foreach ($fileIds as $fileId) {
            $fm->addToRemoveByBlobId($relationDao->getBlobId($fileId, $userId));
            $relationDao->setDelete($fileId, $userId);
        }
    }

    $mail_logic->deleteSourceFile($mail_id);
}

cb_redirect('mail/view', ['mid' => $mail_id]);


