<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
global $G_INPUT;
$user = cb_get_login_user();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

//--------------------------------------------------------------
// アカウントデータ取得
require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($user);

$t->assign('app_name', $G_mail_name);

// アカウント権限
$system_config->getUserPrivilegeSetting($settings);

//--------------------------------------------------------------
// アカウントデータリスト
if ($settings['all_permission']) {
    $account_list = $personal_config->getAccountDataList(true, false, -1, -1,
        false, false);
} else {
    $account_list = $personal_config->getAccountDataList(true);
}

$account_list_for_view = [];
if (is_array($account_list)) {
    foreach (array_keys($account_list) as $key) {
        $account_data =& $account_list[$key];
        if (is_array($account_data)) {
            $account_info = $account_data['account_info'];
            $server_data =& $account_data['server'];
            $name = $account_data['name'];
            $account_name = $account_data['title'];
            $disabled = $account_data['disabled'];
            $deleted = $account_data['deleted'];
        } else {
            $account_info = null;
            $server_data = null;
            $name = '';
            $account_name = '';
            $disabled = true;
            $deleted = true;
        }

        if (is_object($account_info)) {
            $email = $account_info->email;
            $retrieve_account = $account_info->retrieve_account;
            $retrieve_save = $account_info->getRetrieveSave();
        } else {
            $email = null;
            $retrieve_account = null;
            $retrieve_save = null;
            $disabled = true;
            $deleted = true;
        }

        $account_list_for_view[$key] = [
            'aid'               => $key,
            'name'              => $name,
            'title'             => $account_name,
            'account'           => $retrieve_account,
            'email'             => $email,
            'leave_server_mail' => $retrieve_save,
            'mailserver'        => $server_data,
            'stop'              => $disabled,
            'deleted'           => $deleted
        ];
    }
}

//------------------

$no_setting = '0';
$account_data_count = count($account_list_for_view);
// サーバー設定数を取得する
$server_data_count = $system_config->getServerDataCount();
if ($account_data_count == 0) {
    if ($server_data_count == 0) {
        $no_setting = '3';
    } else {
        $no_setting = '2';
        if ($settings['all_permission']) {
            $no_setting = '0';
        }
    }
}

// 0はOK、1はメールサーバーがまだ 2はアカウントがまだ 3は両方まだ
$t->assign('no_setting', $no_setting);

//--------------------------------------------------------------

// アカウント情報
$t->assign('account_list', $account_list_for_view);

$t->assign('disabled_add_account', $server_data_count < 1 ? true : false);
$t->assign('disabled_change_order', $account_data_count < 2 ? true : false);

// ユーザー権限
$t->assign(
    'system', [
        'user_all_permission' => $settings['all_permission'],
        'user_account_modify' => $settings['modify_account'],
    ]
);

//--------------------------------------------------------------

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

//-- show page
$t->display(cb_get_pagename() . '.tpl');

