<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($user);
$folder_logic = $utility->getFolderLogic();

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$t->assign('app_name', $G_mail_name);

//-- get parameters from URL parameters
$account_id = @ $G_INPUT['aid'];
$filter_id = @ $G_INPUT['mfid'];

//------------------

// アカウントデータ
$account_data = $personal_config->getAccountData($account_id, false, true);
if ( ! is_array($account_data) || ! array_key_exists('user_id', $account_data)
     || $account_data['user_id'] != $user->getOID()
) {
    require_once('mail/error_code.csp');
    cb_throw_error(E_GRN_MAIL_GET_FILTER_DATA_NOT_FOUND);
}

//------------------

// ごみ箱を使用する設定
$use_trash = $personal_config->useTrash();
$use_status = $system_config->canUserUseStatus()
              && $personal_config->useStatus();
$use_address_history = $system_config->canUserUseHistory();

// ごみ箱のID
$trash_id = $folder_logic->translateFolderId($account_id,
    GRN_MAIL_FOLDER_CODE_TRASH);

// 振り分け設定
$filter_data = $personal_config->getFilterData($filter_id, true);
assert('! is_null( $filter_data )');
if ($filter_data['account_id'] != $account_id) {
    require_once('mail/error_code.csp');
    cb_throw_error(E_GRN_MAIL_GET_FILTER_DATA_NOT_FOUND);
}

$folder_id = $filter_data['folder_id'];

$available = (is_null($folder_id)
              || (($folder_id === $trash_id)
                  && ! $use_trash)) ? 0 : 1;

$filter_data_for_view = [
    'mfid'      => $filter_id,
    'title'     => $filter_data['name'],
    'cid'       => $folder_id,
    'available' => $available, //利用可能（保存先フォルダがあるか否か）
    'kind'      => $filter_data['or'] == 0 ? 1 : 2, //1:全ての条件,2:いずれかの条件
];

// 条件
$conditions =& $filter_data['conditions'];
assert('! is_null( $conditions )');

$filter_data_for_view['condition'] = [];
if (is_array($conditions)) {
    foreach (array_keys($conditions) as $key) {
        $condition =& $conditions[$key];

        $filter_data_for_view['condition'][] = [
            'object' => $condition['type'],
            //1:subject,2:from,3:to,4:cc,5:メールサイズ
            'value'  => $condition['string'],
            'type'   => $condition['expr']
        ];
    }
}

// 順番
$order = 1;
$filter_list = $personal_config->getFilterDataList($account_id, false);
if (is_array($filter_list)) {
    foreach (array_keys($filter_list) as $key) {
        if ($key == $filter_id) {
            break;
        }

        $order++;
    }
}
$filter_data_for_view['order'] = $order;

// ステータス名
require_once('mail/status.csp');
$status = grn_mail_get_status($filter_data['status_id']);

//------------------

// set_data
$t->assign(
    'set', [
        'aid'                  => $account_id,
        'account'              => $account_data['title'],
        'stop'                 => $account_data['disabled'], //アカウント停止中か否か
        'status_name'          => $status['name'],
        'status_color'         => $status['color'],
        'save_address_history' => $filter_data['save_address_history'] != 0 ? 1
            : 0
    ]
);

//mail filter delete info
$delete_info = [
    'title'      => grn_get_page_display_name('mail/personal/filter_delete',
        ['app_name' => $G_mail_name]),
    'page'       => 'mail/personal/filter_delete.tpl',
    'no_confirm' => false,
    'data'       => [
        'set'          => [
            'aid'     => $account_id,
            'mfid'    => $filter_id,
            'account' => $account_data['title'],
            'title'   => $filter_data['name']
        ],
        'truncate_len' => GRN_MAIL_SUBJECT_TRUNCATE_WIDTH
    ],
    'handler'    => 'lnk_delete',
];
$t->assign('delete_info', $delete_info);

$t->assign('use_status', $use_status);
$t->assign('use_address_history', $use_address_history);

// filter
$t->assign('filter', $filter_data_for_view);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "mail/personal/filter",
            'name' => grn_get_page_display_name("mail/personal/filter"),
            'aid'  => $account_id
        ],
        [
            'page' => "",
            'name' => $page_title
        ]
    ]
);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


