<?php
$t->assign('app_name', $G_mail_name);

// get parameters from URL parameters
global $G_INPUT;
$user = cb_get_login_user();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}
$personal_config = $utility->getPersonalConfig($user);

//------------------
// アカウントデータ取得
$account_id = cb_at($G_INPUT, 'aid');
$set = null;
$account_data = null;
$current_server_id = null;

if ( ! is_null($account_id)) {
    $account_data = $personal_config->getAccountData($account_id, true, true);
    if ( ! is_array($account_data)
         || ! array_key_exists('user_id', $account_data)
         || $account_data['user_id'] != $user->getOID()
    ) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    $account_info = $account_data['account_info'];
    $server_name = null;
    $server_info = null;
    $server_data =& $account_data['server'];
    if (is_array($server_data)) {
        $server_info = $server_data['server_info'];
        $server_name = $server_data['name'];
        $current_server_id = $server_data['id'];
    }

    // set data
    $set = [
        'aid'               => $account_id,
        'foreign_key'       => $account_data['foreign_key'],
        'name'              => $account_data['name'],
        'account_name'      => $account_data['title'],
        'email'             => $account_info->email,
        'account'           => $account_info->retrieve_account,
        'password'          => $account_info->retrieve_password,
        'send_account'      => $account_info->smtp_account,
        'send_password'     => $account_info->smtp_password,
        'leave_server_mail' => $account_info->getRetrieveSave(),
        'mail_server'       => $server_name,
        'stop'              => $account_data['disabled']
    ];

    if ( ! is_null($server_info)
         && ($server_info->getSmtpAuth() !== GRN_MAIL_SMTP_AUTH_NONE)
         && $server_info->smtp_set_account
    ) {
        // 送信メールアカウントの設定フラグ
        $set['set_send'] = true;
    }
}

// アカウント設定
$t->assign('set', $set);
//------------------

$system_config = $utility->getSystemConfig();

// ユーザー権限
$system_config->getUserPrivilegeSetting($settings);
$t->assign(
    'system', [
        'user_all_permission'    => $settings['all_permission'],
        'user_account_modify'    => $settings['modify_account'],
        'user_leave_server_mail' => $settings['leave']
    ]
);

if (isset($need_mail_servers) && $need_mail_servers) {
    // メールサーバー一覧取得
    $server_list = $system_config->getServerDataList(false);

    $mail_servers = [];
    $server_set_send = '';
    if (is_null($current_server_id)
        || ! array_key_exists($current_server_id, $server_list)
        || is_null($server_list[$current_server_id])
    ) {
        $mail_servers[] = [
            'value'    => '',
            'label'    => cb_msg('grn.mail.lang', 'select'),
            'selected' => true,
            'set_send' => false
        ];
        $server_set_send = '\'0';
    }

    if (is_array($server_list)) {
        foreach (array_keys($server_list) as $key) {
            $server_data =& $server_list[$key];
            $mail_servers[$key] = [
                'value' => $key,
                'label' => $server_data['name']
            ];

            $mail_servers[$key]['selected'] = ( ! is_null($current_server_id)
                                                && ($current_server_id
                                                    == $key));

            // 送信メールアカウントの設定フラグ
            $server_info = $server_data['server_info'];
            if (strlen($server_set_send) > 0) {
                $server_set_send .= ':';
            } else {
                $server_set_send .= '\'';
            }

            if ( ! is_null($server_info)
                 && ($server_info->getSmtpAuth() !== GRN_MAIL_SMTP_AUTH_NONE)
                 && $server_info->smtp_set_account
            ) {
                $server_set_send .= '1';
                $mail_servers[$key]['set_send'] = true;
            } else {
                $server_set_send .= '0';
                $mail_servers[$key]['set_send'] = false;
            }
        }
    }

    if (strlen($server_set_send) > 0) {
        $server_set_send .= '\'';
    }

    // mail_server
    $t->assign('mail_server', $mail_servers);

    // メールサーバーの送信アカウント設定On(1)、OFF(0)を:でつなげて渡す（画面切り替えに必要）
    $t->assign('server_set_send', $server_set_send);
}
