<?php

if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST')) {
    global $G_INPUT;
    $user = cb_get_login_user();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();

    // instantiate an Smarty object
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'mail/personal/account_add';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        require('_command_account_add.csp');

        // アカウントデータの追加
        $personal_config = $utility->getPersonalConfig($user);
        $personal_config->addAccountData($foreign_key, $name, null,
            $account_info, $send_vcard, $default_bcc, $sender, $disabled);

        // the validation session is finished
        if (SmartyValidate::is_registered_form($target_name)) {
            SmartyValidate::unregister_form($target_name);
        }

        cb_redirect('mail/personal/account_list');
    } else {
        //-- if error, show the source form
        $t->setPageInfo($target_name);

        // page title
        $page_title = grn_get_current_page_display_name();
        $t->assign('page_title', $page_title);

        $need_mail_servers = true;
        require('_account_add.csp');
        require('_command_account_add_validate.csp');

        // site position
        $t->assign(
            'site_position', [
                [
                    'page' => 'mail/personal/account_list',
                    'name' => grn_get_page_display_name('mail/personal/account_list')
                ],
                [
                    'page' => '',
                    'name' => $page_title
                ]
            ]
        );

        //-- show page
        $t->display("{$target_name}.tpl");
    }
}
