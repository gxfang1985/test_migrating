<?php

if (array_key_exists('REQUEST_METHOD', $_SERVER)
    && 0 == strcasecmp($_SERVER['REQUEST_METHOD'], 'POST')
) {
    global $G_INPUT;
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    $account_id = array_key_exists('naccount', $G_INPUT) ? $G_INPUT['naccount']
        : '';
    if (is_string($account_id) && (strlen($account_id) > 0)) {
        $cmd = array_key_exists('cmd', $G_INPUT) ? $G_INPUT['cmd'] : '';
        if (strcmp($cmd, 'change_account') === 0) {
            cb_redirect('mail/personal/folder_subscribe',
                ['aid' => $account_id]);
        } else {
            $input_name = 'fid' . $account_id;
            $subscribe_folders = array_key_exists($input_name, $G_INPUT)
                ? $G_INPUT[$input_name] : '';

            // 購読設定
            require_once('mail/utility.csp');
            $utility = GRN_Mail_Utility::getInstance();
            $folder_logic = $utility->getFolderLogic();
            $folder_logic->subscribeFolders($account_id, $subscribe_folders);

            _mail_rebuild_folder_tree($account_id);
        }
    }
}

cb_redirect('personal/application_list', ['app_id' => 'mail']);


