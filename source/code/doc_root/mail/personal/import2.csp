<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];
$file_id = @ $G_INPUT['file'];
$format = @ $G_INPUT['format'];

$target_page = 'mail/personal/import1';

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session = $sm->getSession($target_page);

$files = $session->getFiles('import_files');
if ( ! is_array($files) || ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_MAIL_FILE_NOT_FOUND);
}
$filename = $session->get('import_filename');


require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$personal_config = $utility->getPersonalConfig($user);

// アカウントデータ取得
$account_data = $personal_config->getAccountData($account_id, false, true);

$size = $files[$file_id]->get('size');
if ($size === false) {
    $size = 0;
}

$account_data_for_view = [
    'aid'      => $account_id,
    'cid'      => $category_id,
    'account'  => $account_data['title'],
    'file'     => $file_id,
    'format'   => $format,
    'size'     => $size,
    'filename' => $filename,
];

// set_data
$t->assign('set', $account_data_for_view);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
// site position
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

