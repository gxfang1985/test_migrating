<?php
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

global $G_INPUT;
$account_id = @ $G_INPUT['aid'];

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    $target_name = 'mail/personal/filter_add';

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    // register the target_form, or you get an error if you go back to the previous page by using
    // your browser 'back' button
    SmartyValidate::register_form($target_name);

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $personal_config = $utility->getPersonalConfig($user);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $name = @ $G_INPUT['title'];
        if ($name == '') {
            cb_throw_error(E_COMMON_MISSING_MANDATORY);
        }

        $folder_id = @ $G_INPUT['folder'];
        if (($folder_id == '') || ($folder_id == '-1')) {
            cb_throw_error(E_COMMON_MISSING_MANDATORY);
        }

        if ($folder_id == '0') {
            // フォルダ新規作成
            $folder_logic = $utility->getFolderLogic();
            $folder_id = $folder_logic->addFolderData($account_id, null,
                $name, null);
        }

        $or = intval(@ $G_INPUT['kind']) == 2;

        $status_id = @ $G_INPUT['status'];
        $save_address_history = @ $G_INPUT['save_address_history'];

        // 振り分け条件
        $conditions = [];
        foreach ($G_INPUT as $key => $value) {
            if (strpos($key, 'object_') !== false) {
                if (is_numeric($number = substr($key, 7))) {
                    $condition = [];
                    $condition['type'] = $value;
                    $condition['string'] = @ $G_INPUT["text_$number"];
                    $condition['expr'] = @ $G_INPUT["type_$number"];
                    $conditions[] = $condition;
                }
            }
        }

        // 振り分け設定の追加
        $personal_config->addFilterData($account_id, $folder_id, $name, $or,
            $status_id, $save_address_history, $conditions);

        // the validation session is finished
        if (SmartyValidate::is_registered_form($target_name)) {
            SmartyValidate::unregister_form($target_name);
        }

        _mail_rebuild_folder_tree($account_id);
        cb_redirect('mail/personal/filter', ['aid' => $account_id]);
    } else {
        //-- if error, show the source form
        // include sharing code
        $t->setPageInfo($target_name);

        $system_config = $utility->getSystemConfig();
        $personal_config = $utility->getPersonalConfig($user);

        $status_id = '';
        if (array_key_exists('status', $G_INPUT)) {
            $status_id = $G_INPUT['status'];
        }

        include('_filter_add.csp');

        // set_data
        $t->assign(
            'set', [
                'aid'                  => $account_id,
                'account'              => $account_data['title'],
                'stop'                 => $account_data['disabled'],
                //アカウント停止中か否か
                'use_garbage'          => $use_trash,
                //ごみ箱を使っているか否か
                'status_id'            => @ $G_INPUT['status'],
                'save_address_history' => intval(@ $G_INPUT['save_address_history'])
                                          == 1
            ]
        );

        // page title
        $page_title = grn_get_current_page_display_name();
        $t->assign('page_title', $page_title);

        // site position
        $t->assign(
            'site_position', [
                [
                    'page' => "mail/personal/filter",
                    'name' => grn_get_page_display_name("mail/personal/filter"),
                    'aid'  => $account_id
                ],
                [
                    'page' => "",
                    'name' => $page_title
                ]
            ]
        );

        $filter_for_view = [];
        $filter_for_view['title'] = @ $G_INPUT['title'];
        $filter_for_view['kind'] = @ $G_INPUT['kind'];
        $filter_for_view['cid'] = @ $G_INPUT['folder'];

        // conditions
        $conditions = [];
        foreach ($G_INPUT as $key => $value) {
            if (strpos($key, 'object_') !== false) {
                if (is_numeric($number = substr($key, 7))) {
                    $condition = [];
                    $condition['object'] = $value;
                    $condition['value'] = @ $G_INPUT["text_$number"];
                    $condition['type'] = @ $G_INPUT["type_$number"];
                    $conditions[] = $condition;
                }
            }
        }

        $filter_for_view['condition'] = $conditions;

        $t->assign('filter_set_num', count($conditions));

        $t->assign('filter', $filter_for_view);

        $t->display($target_name . '.tpl');
    }

} else {
    cb_redirect('mail/personal/filter', ['aid' => $account_id]);
}


