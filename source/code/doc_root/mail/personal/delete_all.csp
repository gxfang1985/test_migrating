<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$app = $utility->getMailApp();
$personal_config = $utility->getPersonalConfig($user);

$t->assign('app_name', $G_mail_name);

//------------------

// アカウントデータリスト
$account_list_for_view = [];
$account_list_for_view[0] = [
    'value'    => '0',
    'label'    => cb_msg($app->getModuleId() . '.personal',
        'all_account_option'),
    'selected' => true
];

$account_list = $personal_config->getAccountDataList(false, false, -1, -1,
    false, false);
if (is_array($account_list)) {
    foreach (array_keys($account_list) as $key) {
        $temp_data =& $account_list[$key];
        $account_list_for_view[$key] = [
            'value' => $key,
            'label' => $temp_data['title']
        ];
    }
}

//------------------

$no_setting = '0';
$account_data_count = count($account_list_for_view);
if (count($account_list_for_view) == 0) {
    // サーバー設定数を取得する
    $system_config = $utility->getSystemConfig();
    $server_data_count = $system_config->getServerDataCount();
    if (($account_data_count == 0) && ($server_data_count == 0)) {
        $no_setting = '3';
    } elseif ($account_data_count == 0) {
        $no_setting = '2';
    } elseif ($server_data_count == 0) {
        $no_setting = '1';
    }
}

// 0はOK、1はメールサーバーがまだ 2はアカウントがまだ 3は両方まだ
$t->assign('no_setting', $no_setting);

//------------------

// 削除基準日
$current_date = getdate();
$date = new CB_Date();
$date->year = $current_date['year'];
$date->month = $current_date['mon'];
$date->day = $current_date['mday'];

require_once('fw/date.csp');
$date_for_view = new CB_DateEx($date);
$date_for_view->moveYears(-1);

$t->assign('date', $date_for_view);

//------------------

// account_data
$t->assign('user_account', $account_list_for_view);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);
//explanation
$t->assign('explanation',
    cb_plain_msg(GRN_MAIL_PERSONAL_MODULE_ID, 'GRMSG_MAIL_PE-4',
        ['app_name' => $G_mail_name]));

//mail delete info
$delete_info = [
    'title'         => grn_get_page_display_name('mail/personal/delete_all2',
        ['app_name' => $G_mail_name]),
    'page'          => 'mail/personal/delete_all2.tpl',
    'no_confirm'    => false,
    'data'          => ['app_name' => $G_mail_name],
    'handler'       => 'btn_delete',
    'before_delete' => 'get_date',
];
$t->assign('delete_info', $delete_info);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

