<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('mail/personal/import1');
    $files = $session->getFiles('import_files');

    global $G_INPUT;
    if (isset($G_INPUT['cmd']) && ($G_INPUT['cmd'] == 'yes')) {
        if ( ! isset($G_INPUT['file']) || ! $G_INPUT['file']) {
            cb_throw_error(E_GRN_MAIL_FILE_NOT_FOUND);
        }

        $file_id = $G_INPUT['file'];

        if ( ! is_array($files) || ! array_key_exists($file_id, $files)) {
            cb_throw_error(E_GRN_MAIL_FILE_NOT_FOUND);
        }

        $account_id = @ $G_INPUT['aid'];
        $category_id = @ $G_INPUT['cid'];
        $format = @ $G_INPUT['format'];

        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $personal_config = $utility->getPersonalConfig($user);

        // メールデータのインポート
        $personal_config->importMaildatas($format, $files[$file_id],
            $category_id);

        foreach (array_keys($files) as $id) {
            $session->unsetFile('import_files', $id);
        }
        $session->unset_by('import_filename');

        cb_redirect('personal/application_list', ['app_id' => 'mail']);
    } else {
        // キャンセル
        foreach (array_keys($files) as $id) {
            $session->unsetFile('import_files', $id);
        }
        $session->unset_by('import_filename');

        cb_redirect('mail/personal/import1');
    }
}


