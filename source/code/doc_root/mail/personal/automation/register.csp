<?php

use grn\mail\screen\personal\automation\ModifyEvent;
use grn\mail\screen\personal\automation\AddEvent;
use grn\mail\screen\personal\automation\Register;
use grn\grn\access\service\AppAccess;

require_once("grn/smarty.csp");
require_once(cb_basedir() . "/code/doc_root/mail/personal/_prepend.csp");

cb_require_role("LoginUser");
global $G_INPUT;
$action = cb_at($G_INPUT, "action", "add");
$accountId = cb_at($G_INPUT, "accountId", -1);
$eventId = cb_at($G_INPUT, "eventId", -1);
//GRB-15180
$uid = cb_get_login_user()->getOID();
require_once("grn/application.csp");
require_once("address/resources.csp");
$locator = \GRN_ApplicationLocator::instance();
$allowUsingAddressBook
    = AppAccess::isAppAvailableInternalAccess(GRN_ADDRESS_APPLICATION_ID,
    $uid);
//end
$page = new Register($accountId);
if ( ! in_array($action, ["modify", "add"])) {
    cb_redirect("mail/personal/automation", ["accountId" => $accountId]);
}

if ($action === "modify") {
    $actionPage = new ModifyEvent($accountId, $eventId);
} elseif ($action === "add") {
    $actionPage = new AddEvent($accountId);
}

/** @var $actionPage \grn\mail\screen\personal\automation\RegisterAction */
$smarty = new \GRN_Smarty;
$smarty->assign("actionName", $action);
$smarty->assign("account", $page->getAccount());
$smarty->assign("useIncrementalSearch", $page->getUseIncrementalSearch());
$smarty->assign("event", $actionPage->getEvent());
$smarty->assign("site_position", $actionPage->getSitePosition());
$smarty->assign("page_title", $actionPage->getTitle());
$smarty->assign("allowUsingAddressBook", $allowUsingAddressBook);//GRB-15180
$smarty->display("mail/personal/automation/register.tpl");
