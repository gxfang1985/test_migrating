<?php

// application object
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();

global $G_mail;
$G_mail = null;
if ( ! ($G_mail = $locator->getInstance('mail'))) {
    require_once('mail/error_code.csp');
    cb_throw_error(E_GRN_MAIL_NOT_AVAILABLE);
}
global $G_mail_name;
$G_mail_name = $G_mail->getName();
unset($locator);

// user object
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
global $G_mail_login;
$G_mail_login = $uum->getLoginUser();

if ( ! is_object($G_mail_login) || ! is_a($G_mail_login, 'cb_user')) {
    require_once('fw/error_code.csp');
    cb_throw_error(E_COMMON_ACCOUNT_INVALIDATED);
}
unset($uum);

require_once('mail/utility.csp');
$_utility = GRN_Mail_Utility::getInstance();
$_folder = $_utility->getFolderLogic();

// check account id
global $G_INPUT;
if (array_key_exists('aid', $G_INPUT) && strlen($G_INPUT['aid']) > 0
    && strcmp($G_INPUT['aid'], '0') != 0
) {
    $_personal = $_utility->getPersonalConfig($G_mail_login);
    $_account = $_personal->getAccountData($G_INPUT['aid']);
    if (is_null($_account)) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    if ( ! array_key_exists('user_id', $_account)
         || $_account['user_id'] != $G_mail_login->getOID()
    ) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }

    // initialize special folders
    $_folder->initSpecialFolders($G_mail_login, $G_INPUT['aid']);
} else {
    // initialize special folders
    $_folder->initSpecialFolders($G_mail_login);
}

// check category id
if (array_key_exists('cid', $G_INPUT) && strlen($G_INPUT['cid']) > 0) {
    $_folder = $_utility->getFolderLogic();
    $_folder_data = $_folder->getFolderData($G_INPUT['cid'], false, false);
    if (is_null($_folder_data)) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
    }
    if ( ! array_key_exists('user_id', $_folder_data)
         || $_folder_data['user_id'] != $G_mail_login->getOID()
    ) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
    }
}

// check mail id
if (array_key_exists('mid', $G_INPUT) && strlen($G_INPUT['mid']) > 0) {
    $_mail = $_utility->getMailLogic();
    $_mail_data = $_mail->getMailData($G_INPUT['mid'], false);
    if (is_null($_mail_data)) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
    }
    if ( ! array_key_exists('user_id', $_mail_data)
         || $_mail_data['user_id'] != $G_mail_login->getOID()
    ) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_MAIL_ACCESS_DENIED);
    }
}

function _mail_rebuild_folder_tree($account_id, $expand_oid = null)
{
    require_once('mail/folder_tree.csp');
    $list_page = 'mail/index/' . $account_id;
    grn_mail_rebuild_folder_tree($list_page, $account_id, $expand_oid);
}


