<?php

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

require_once('mail/table.csp');
require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$mail_logic = $utility->getMailLogic();

//------------------

$cmd = '';
if (array_key_exists('cmd', $G_INPUT)) {
    $cmd = $G_INPUT['cmd'];
}

switch ($cmd) {
    case 'change':
        cb_redirect('mail/view', $G_INPUT);
        break;
    case 'save':
        $mid = '';
        if (array_key_exists('mid', $G_INPUT)) {
            $mid = $G_INPUT['mid'];
        }
        require_once('mail/resources.csp');

        $table_name = grn_mail_get_personal_tablename($user->getOID(),
            GRN_MAIL_MESSAGE_TABLE);
        $utility = GRN_Mail_Utility::getInstance();
        $table = $utility->getTableInfo($table_name);

        $db = $table->getDBConnection();
        $rowset = new CB_RowSet($table);
        $rowset->addCondition(cb_queryf($db,
            '_id = \'@S\' AND col_user = \'@S\'', $mid,
            $user->getOID()));
        $rowset->limit(0, 1);
        $row = $rowset->iterate();
        $rowset->destroy();

        if ( ! $row) {
            cb_throw_error(E_GRN_MAIL_MAIL_ACCESS_DENIED);
        }

        $properties = [];
        // header force encoding
        if (array_key_exists('charset_header', $G_INPUT)
            && strlen($G_INPUT['charset_header']) > 0
        ) {
            $msg = $row->getMessage();
            $msg->setForceEncoding($G_INPUT['charset_header']);
            $main_part = $msg->getMainPart();
            $properties['subject'] = $msg->getSubject();
            $properties['from'] = implode(', ',
                $msg->getHeaderValues('from'));
            $properties['to'] = implode(', ', $msg->getHeaderValues('to'));
            $properties['cc'] = implode(', ', $msg->getHeaderValues('cc'));

            unset($G_INPUT['charset_header']);
        }

        // body force encoding
        if (array_key_exists('charset_body', $G_INPUT)
            && strlen($G_INPUT['charset_body']) > 0
        ) {
            $msg = $row->getMessage();
            $msg->setForceEncoding($G_INPUT['charset_body']);
            $main_part = $msg->getMainPart();
            GRN_Mail_Message::static_getPartContent($main_part, $body,
                $html_body,
                $G_INPUT['charset_body']);
            $properties['data'] = $body;
            $properties['html_data'] = $html_body;

            unset($G_INPUT['charset_body']);
        }

        if (array_key_exists('charset_on', $G_INPUT)) {
            unset($G_INPUT['charset_on']);
        }

        $row->updateProperties($properties);

        cb_redirect('mail/view', $G_INPUT);
        break;
    default:
        cb_redirect('mail/view', $G_INPUT);
        break;
}


