<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// SmartyValidate should be initialized when an input form is there.
require_once('SmartyValidate.class.php');
SmartyValidate::connect($smarty);
$form_name = 'mail/cellular/create';
SmartyValidate::register_form($form_name);

$account_id = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;
$category_id = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;

//sessionに入れ込む。
$sess_mail_add['subject'] = isset($G_INPUT['title']) ? $G_INPUT['title']
    : null;
$sess_mail_add['data'] = isset($G_INPUT['content']) ? $G_INPUT['content']
    : null;
$sess_mail_add['signature'] = isset($G_INPUT['signature'])
    ? $G_INPUT['signature'] : null;
$sess_mail_add['aid'] = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;
$sess_mail_add['cid'] = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;
$sess_mail_add['to'] = isset($G_INPUT['to']) ? $G_INPUT['to'] : null;
$sess_mail_add['cc'] = isset($G_INPUT['cc']) ? $G_INPUT['cc'] : null;
$sess_mail_add['bcc'] = isset($G_INPUT['bcc']) ? $G_INPUT['bcc'] : null;

// validate after a POST
if ( ! SmartyValidate::is_valid($G_INPUT, $form_name)) {
    grn_cellular_switch_page($G_pagepath . "/create");
}

if (isset($G_INPUT['to_button'])) {
    $sess_mail_add['from'] = 'to';
    $G_cellular_session->set('sess_mail_add', $sess_mail_add);
    grn_cellular_switch_page($G_pagepath . "/search1",
        ['aid' => $account_id, 'cid' => $category_id,]);
} elseif (isset($G_INPUT['cc_button'])) {
    $sess_mail_add['from'] = 'cc';
    $G_cellular_session->set('sess_mail_add', $sess_mail_add);
    grn_cellular_switch_page($G_pagepath . "/search1",
        ['aid' => $account_id, 'cid' => $category_id,]);
} elseif (isset($G_INPUT['bcc_button'])) {
    $sess_mail_add['from'] = 'bcc';
    $G_cellular_session->set('sess_mail_add', $sess_mail_add);
    grn_cellular_switch_page($G_pagepath . "/search1",
        ['aid' => $account_id, 'cid' => $category_id,]);
} else {
    if (strlen(@$G_INPUT['to']) == 0 && strlen(@$G_INPUT['cc']) == 0
        && strlen(@$G_INPUT['bcc']) == 0
    ) {
        // 必須項目エラー
        $sess_mail_add['empty_flag'] = true;
        $G_cellular_session->set('sess_mail_add', $sess_mail_add);
        grn_cellular_switch_page($G_pagepath . "/create");
    } else {
        $G_cellular_session->set('sess_mail_add', $sess_mail_add);
        // the validation session is finished
        SmartyValidate::unregister_form($form_name);
        grn_cellular_switch_page($G_pagepath . "/confirm",
            ['aid' => $account_id, 'cid' => $category_id,]);
    }
}


