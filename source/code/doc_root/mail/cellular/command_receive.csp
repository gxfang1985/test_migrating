<?php

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$recv_logic = $utility->getRecvLogic();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($G_login_user);

$app = $utility->getMailApp();
$max_receive_count = $app->getMaxReceiveCount(); // 最大受信件数

$account_id = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;
if ( ! isset($account_id) || is_null($account_id)
     || (strlen($account_id) == 0)
) {
    // デフォルトアカウントデータ取得
    $account_id = $personal_config->getDefaultAccountId(false, true, true);
}
$category_id = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;
$receive = isset($G_INPUT['receive']) ? $G_INPUT['receive'] : null;

// システムで設定されているメール保存制限値を取得
$user_id = $G_login_user->getOID();
$system_config->getSizeUserLimitSetting($size_settings, $user_id);

// ユーザーの総メールサイズを取得
$mail_size = $personal_config->getMailSize(null);

// 総サイズチェック
$size_over = false;
if (($size_settings['user_limit_' . $user_id] != -1)
    && ($mail_size >= $size_settings['user_limit_' . $user_id] * 1024 * 1024)
) {
    // 容量制限を越える場合には受信処理を強制スキップ
    $size_over = true;
}

// フォルダ情報
if (is_null($category_id) || (strlen($category_id) == 0)) {
    if (isset($account_id) && ! is_null($account_id)
        && (strlen($account_id) >= 0)
    ) {
        $folder_logic = $utility->getFolderLogic();

        // 受信箱
        $folder_data = $folder_logic->getSpecialFolderData($account_id,
            GRN_MAIL_FOLDER_CODE_INBOX, false);
        $category_id = $folder_data['id'];
    }
}

// 外部通知設定取得
$use_notify_mail = false;
$locator = GRN_ApplicationLocator::instance();
/** @var GRN_Notification_App $notify_app */
if ($notify_app = $locator->getInstance('notification')) {
    $temp = false;
    $notify_config = $notify_app->getPersonalConfig($G_login_user);
    $notify_config->getNotUseNotify($temp);
    if ( ! is_null($notify_config) && $notify_config->getNotUseNotify($temp)) {
        $use_notify_mail = ! $temp;
    }
}

$notify_received_num = 0; // 受信した外部通知メール数

if ($receive && ! $size_over) {
    // 受信可能なアカウントかチェック
    $no_account = $no_server = true;
    if ($personal_config->checkAccountForReceive($account_id, $no_account,
        $no_server)
    ) {
        // 特定アカウントのメール受信
        $remaining = 0;

        // メール受信
        $mail_ids = $recv_logic->recvMails($G_login_user, $account_id,
            $use_notify_mail,
            $max_receive_count, $remaining, $notify_received_num);
    }
}

grn_cellular_redirect($G_pagepath . "/list", [
    'aid'     => $account_id,
    'cid'     => $category_id,
    'receive' => $receive,
    'ncnt'    => $notify_received_num
]);

