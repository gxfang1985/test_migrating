<?php
if ( ! is_object($G_login_user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$smarty = new GRN_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

require_once('mail/utility.csp');
$mail_utility = GRN_Mail_Utility::getInstance();
$mail_app = $mail_utility->getMailApp();
$personal_config = $mail_utility->getPersonalConfig($G_login_user);
$folder_logic = $mail_utility->getFolderLogic();
$search_logic = $mail_utility->getSearchLogic();

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);

$list_limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();

$smarty->assign('width', $width);

$account_id = @ $G_INPUT['aid'];
$text = @ $G_INPUT['text'];

$smarty->assign('from', 'search');

// アカウント情報
include('_account_common.csp');
$account_info = [
    'account_name' => $account_data['title'],
    'email'        => $account_data['account_info']->email,
    'aid'          => $account_data['id'],
];
$smarty->assign('account_info', $account_info);

$smarty->assign('text', $text);
if (strlen($text)) {
    // 表示数
    $number_on_page = $list_limit;

    // 検索対象
    $search_keys = [
        'subject' => true,
        'data'    => true,
        'from'    => true,
        'to'      => true,
        'cc'      => true,
        'bcc'     => true,
    ];

    // 検索文字列
    $search_text = &$text;

    // ソート
    $sort_time = 'send_ts';

    // 検索期間を決定する
    $start_ts = null;
    $last_ts = null;

    // アカウントＩＤ
    $aid = &$account_id;

    // 全フォルダを検索する場合にはフォルダIDを「1」にセットする
    $hid = $folder_logic->getSpecialFolderData($aid, GRN_MAIL_FOLDER_CODE_ROOT,
        false);
    $hid = $hid['id'];

    // 全フォルダを検索する場合には強制的にサブフォルダ検索もONにする
    $subfolder = true;

    // N件ナビゲーション
    require_once("cellular/controller.csp");
    $controller_util = new GRN_Cellular_ControllerUtil();
    // 現在位置
    $current_start_position = $controller_util->getNaviStartPosition();
    // セッションに保存
    $controller_util->setNaviStartPosition($current_start_position);

    // 件数
    $number_of_all = $search_logic->getSearchItemCount($G_login_user,
        $search_keys, $search_text,
        $sort_time, $start_ts, $last_ts,
        $aid, $hid, $subfolder);

    // n件ナビゲーション情報を取得する
    $navigation_info
        = $controller_util->makeNaviInformation($current_start_position,
        $number_on_page,
        $number_of_all,
        [
            'aid'  => $account_id,
            'text' => $search_text
        ]);

    $search_count = $navigation_info['end_count']
                    - $navigation_info['start_count'] + 1;

    $retval = $search_logic->getSearchItems($G_login_user,
        $search_keys, $search_text,
        $current_start_position, $search_count,
        $sort_time, $start_ts, $last_ts,
        $aid, $hid, $subfolder);
    // view化
    $mail_list_for_view = [];
    if (is_array($retval)) {
        $count = 1;
        foreach (array_keys($retval) as $_id) {
            $mail_data =& $retval[$_id];
            $mail_id = $mail_data['id'];
            $time_view_flag = false;  //日付の表示判断フラグ。
            $time = $mail_data['send_ts'];
            $tsex = new CB_TimeStampEx($time);
            $time_day = &$tsex->getDate();
            if ($count == 1) {
                $time_view_flag = true;
                $temp_time = $time_day;
            } else {
                if ($temp_time != $time_day) {
                    $time_view_flag = true;
                    $temp_time = $time_day;
                }
            }
            unset($tsex);
            $count++;
            $subject = $mail_data['subject'];
            if (is_null($subject)) {
                $subject = '';
            } else {
                $subject = cb_trim($subject);
            }

            $read_ts = $mail_data['read_ts'];
            $b_unread = ( ! is_object($read_ts)
                          || ($read_ts->unix_ts == 0));
            $temp_from_mail = &$mail_data['from_email'];

            $mail_with_tag_flag = false;
            if (mb_substr($temp_from_mail, 0, 1) == '<') {
                $mail_with_tag_flag = true;
            }
            $mail_list_for_view[$mail_id] = [
                'maid'               => $mail_id,
                'type'               => $mail_data['sent'] ? '1' : '0',
                'unread'             => $b_unread,
                'aid'                => $account_id,
                'time'               => $time, // 日時
                'subject'            => $subject,
                'from_name'          => $mail_data['from_name'],
                'from_email'         => $mail_data['from_email'],
                'to_email'           => $mail_data['to_email'],
                'mail_with_tag_flag' => $mail_with_tag_flag,
                'time_view_flag'     => $time_view_flag,
            ];
        }
    }
    // 次、前のページ遷移
    $smarty->assign('navi', $navigation_info['navi']);
    // 
    $smarty->assign('mails', $mail_list_for_view);
}

// Smarty実行
$doc_name = cb_get_pagename();
$smarty->display("{$doc_name}.tpl");

