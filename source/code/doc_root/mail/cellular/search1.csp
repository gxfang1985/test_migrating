<?php

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ログインユーザーを取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
$login_id = $login->getOID();

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$cid = @$G_INPUT['cid'];
$aid = @$G_INPUT['aid'];

$params = (isset($G_INPUT)) ? $G_INPUT : null;
$smarty->assign('params', $params);

$smarty->assign('cid', $cid);
$smarty->assign('aid', $aid);

$tab = [
    'mode'   => 'b',
    'page'   => "$G_pagepath/search_user",
    'params' => $params,
    'add'    => [
        [ // 検索tab
          'mode' => 's',
          'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();

if ($address_app = $locator->getInstance('address')) {
    $smarty->assign('enable_address', true);

    include('_search_common.csp');

    assert('isset($book_options)');

    //アドレス帳とブック一覧
    $menu_count_per_page = 30;
    $menu_count = count($book_options);

    if ($menu_count <= $menu_count_per_page) {
        $smarty->assign('book_options', $book_options);
    } else {
        $menu_page = (isset($menu_pg)) ? $menu_pg : 1;
        $menu_list_per_page = $menu_count_per_page - 2;

        if (($menu_count % ($menu_count_per_page - 2)) == 0) {
            $total_pages = $menu_count / ($menu_count_per_page - 2);
        } else {
            $total_pages = 1 + (int)($menu_count / ($menu_count_per_page - 2));
        }

        $menu_start_point = ($menu_page - 1) * $menu_list_per_page;
        $menu_end_point = $menu_page * $menu_list_per_page;

        $temp_menu = [];

        if ($menu_page != 1) {
            array_push($temp_menu, [
                    'value' => 'm' . ($menu_page - 1),
                    'label' => cb_msg('grn.cellular.common', 'link_back')
                ]
            );

        }

        for ($i = $menu_start_point; $i < $menu_end_point; $i++) {
            if ( ! isset($book_options[$i])) {
                continue;
            }
            array_push($temp_menu, $book_options[$i]);
        }

        if ($total_pages != $menu_page) {
            array_push($temp_menu, [
                    'value' => 'm' . ($menu_page + 1),
                    'label' => cb_msg('grn.cellular.common', 'link_next')
                ]
            );
        }

        $smarty->assign('book_options', $temp_menu);
    }
}

$smarty->assign('gid', 'b');
$smarty->assign('tab', $tab);

//add my address group
require_once('address/mygroup_logic.csp');
$address_group_logic = GRN_Address_MyGroup_Logic::getInstance();
$address_mygroups = $address_group_logic->getMyGroupList($login);
$smarty->assign('address_mygroups', $address_mygroups);

$smarty->display(cb_get_pagename() . '.tpl');

