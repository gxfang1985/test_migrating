<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$sess_mail_add = $G_cellular_session->get('sess_mail_add');

// セッション確認
if ( ! isset($sess_mail_add['aid'])) {
    // セッション切れ
    grn_cellular_switch_page($G_pagepath . "/list");
}

$account_id = (isset($sess_mail_add['aid'])) ? $sess_mail_add['aid'] : null;
$category_id = (isset($sess_mail_add['cid'])) ? $sess_mail_add['cid'] : null;

if (isset($G_INPUT['modify_button'])) {
    grn_cellular_switch_page($G_pagepath . "/create", [
        'aid' => $account_id,
        'cid' => $category_id
    ]);
} else {
    $user_id = $G_login_user->getOID();
    $sign_id = $sess_mail_add['signature'];

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $send_logic = $utility->getSendLogic();

    require_once('mail/include_send.csp');

    $properties = [];
    $properties['subject'] = (isset($sess_mail_add['subject']))
        ? $sess_mail_add['subject'] : null;

    $personal_config = $utility->getPersonalConfig($G_login_user);
    if ($sess_mail_add['signature'] != '0') {
        // アカウントの署名設定リストを取得
        $signature_list = $personal_config->getSignatureDataList($account_id,
            true);

        $properties['sign_data'] = $signature_list[$sign_id]['data'];
    }
    $properties['data'] = (isset($sess_mail_add['data']))
        ? $sess_mail_add['data'] : null;
    $to
        = $properties['to'] = (isset($sess_mail_add['to'])) ? str_replace([
        "\r",
        "\n"
    ], '', $sess_mail_add['to']) : null;
    $cc
        = $properties['cc'] = (isset($sess_mail_add['cc'])) ? str_replace([
        "\r",
        "\n"
    ], '', $sess_mail_add['cc']) : null;
    $bcc
        = $properties['bcc'] = (isset($sess_mail_add['bcc'])) ? str_replace([
        "\r",
        "\n"
    ], '', $sess_mail_add['bcc']) : null;

    // メールの送信 check that account belongs to a logged in user before send mails
    if ($personal_config->checkAccountForOwner($account_id)) {
        $mail_id = $send_logic->sendMail($G_login_user, $account_id,
            $properties, $_FILES);
        $utility->addIncrementalSearch($to, $cc, $bcc);
    }

    $G_cellular_session->unset_by('sess_mail_add');
    grn_cellular_switch_page($G_pagepath . "/list", [
        'aid' => $account_id,
        'cid' => $category_id
    ]);
}


