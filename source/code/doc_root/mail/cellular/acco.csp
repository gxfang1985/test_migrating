<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$width = $user_config->getSubjectWidth();

$smarty->assign('width', $width);

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($G_login_user);

// 遷移元ページ
$from = isset($G_INPUT['from']) ? $G_INPUT['from'] : 'list';
$smarty->assign('from', $from);

// 検索キーワード
$text = isset($G_INPUT['text']) ? $G_INPUT['text'] : null;
$smarty->assign('text', $text);

// アカウントID
$account_id = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;

// アカウント情報
if ( ! isset($account_id) || is_null($account_id)
     || (strlen($account_id) == 0)
) {
    // デフォルトアカウントデータ取得
    $account_id = $personal_config->getDefaultAccountId();
}

$smarty->assign('aid', $account_id);

// アカウントデータ取得
$account_data = $personal_config->getAccountData($account_id, true, false);
$account_info = null;
if (is_array($account_data)) {
    if ( ! array_key_exists('user_id', $account_data)
         || ($account_data['user_id'] != $G_login_user->getOID())
    ) {
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    $account_info = $account_data['account_info'];
}

// アカウントデータリスト
$account_list_for_view = [];
$account_list = $personal_config->getAccountDataList(false);

if (is_array($account_list)) {
    foreach (array_keys($account_list) as $key) {
        $temp_data =& $account_list[$key];
        $temp_account_info = $temp_data['account_info'];
        $temp_title = $temp_data['title'];
        array_push($account_list_for_view, [
                'aid'     => $key,
                'name'    => $temp_title,
                'email'   => $temp_account_info->email,
                'checked' => ($key == $account_id) ? true : false
            ]
        );
    }
}

// アカウント リスト
$smarty->assign('user_account', $account_list_for_view);

$smarty->display(cb_get_pagename() . '.tpl');

