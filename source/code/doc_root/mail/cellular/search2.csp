<?php

require_once('grn/application.csp');

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// n件移動中かをチェックする
if (isset($G_INPUT['sf']) && 1 == $G_INPUT['sf']) {
    // セッションからパラメータを取得する
    $search_for_view = $G_cellular_session->get('search_info');
    $str = $search_for_view['text'];
    $G_INPUT['submit_user'] = true;

} else {
    // GET/POSTされたパラメータを取得する
    $str = isset($G_INPUT['s_text']) ? $G_INPUT['s_text'] : '';
}

$se = null;

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();
$smarty->assign('width', $width);

$cid = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;
$aid = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;
$gid = isset($G_INPUT['gid']) ? $G_INPUT['gid'] : null;
$page = (isset($G_INPUT['pg'])) ? $G_INPUT['pg'] : null;

$params = (isset($G_INPUT)) ? $G_INPUT : null;
unset($params['pg']);
unset($params['gid']);
$smarty->assign('params', $params);

$smarty->assign('cid', $cid);
$smarty->assign('aid', $aid);

$tab = [
    'mode'   => 's',
    'page'   => cb_get_pagename(),
    'params' => $params,
    'add'    => [
        // 検索tab
        [
            'mode' => 's',
            'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

if (strlen($gid)) {
    $prefix = mb_substr($gid, 0, 1);
    if ($prefix != 's') {
        // selectページにswitch
        grn_cellular_switch_page($G_pagepath . '/search_user');
    }
}

require_once('fw/string_util.csp');
$str = cb_trim($str);
$search_for_view = [];
$search_for_view['text'] = $str;

if (strlen($str)) {
    $smarty->assign('str', $str);

    if (array_key_exists('submit_group', $G_INPUT)) {
        $smarty->assign('submit_group', true);

        $app_locator = GRN_ApplicationLocator::instance();
        $db = $app_locator->getConnection('mail');

        require_once('fw/string_util.csp');
        $keywords = cb_parse_search_text($str);

        if (count($keywords) > 0) {
            $groups = $G_uum->getGroupListByNames($keywords);
        } else {
            $groups = $G_uum->getGroupList();
        }

        $lists = [];
        foreach ($groups as $_group) {
            array_push($lists, [
                    'gid'  => 'g' . $_group->getOID(),
                    'name' => $_group->get('name')
                ]
            );
        }

        //ページ毎に表示するリストを取得。
        $total_count = count($lists);
        if ($total_count > $limit) {
            $start_point = ($page) * $limit;
            $end_point = ($page + 1) * $limit;

            $temp = [];
            for ($i = $start_point; $i < $end_point && $i < $total_count; $i++) {
                array_push($temp, $lists[$i]);
            }
            if ($end_point < $total_count) {
                $next = $page + 1;
                $smarty->assign('next_page', isset($next) ? $next : null);
                $smarty->assign('next', true);
            }
            if ($page > 0) {
                $before = $page - 1;
                $smarty->assign('before_page', isset($before) ? $before : null);
                $smarty->assign('before', true);
            }
            $smarty->assign('lists', $temp);
        } else {
            $smarty->assign('lists', $lists);
        }

    } elseif (array_key_exists('submit_user', $G_INPUT)) {
        $smarty->assign('submit_user', true);

        // アドレス帳を取得する
        if ($app = $locator->getInstance('address')) {
            $book_manager = $app->getBookManager();

            // アドレス帳の設定を取得する
            require_once('address/config.csp');
            $config_manager = GRN_Address_ConfigManager::getInstance();

            $personal_config
                = $config_manager->getPersonalConfig($G_login_user);

            // ユーザー名簿ブックを取得する
            if ( ! ($book = $book_manager->getUserListBook())) {
                cb_throw_error(E_GRN_ADDRESS_USER_LIST_BOOK_NOT_FOUND);
            }

            require_once('address/view_util.csp');
            $view_util = GRN_Address_ViewUtil::getInstance();
            // 組み込み項目情報一覧を取得する
            $builtin_items = $view_util->listBuiltinItems($book);

            // カスタマイズ項目情報一覧を取得する
            $extended_items = $view_util->listExtendedItems($book);

            // 一覧表示フラグを取得する
            $personal_config->getDisplayFlag($book, $builtin_items,
                $extended_items);

            $offset = 0;
            $data_count = 0;
            $datas_for_view = [];

            require_once('cellular/controller.csp');
            $controller_util = new GRN_Cellular_ControllerUtil();

            //検索キーワードを配列化する。
            require_once('fw/string_util.csp');
            $str_arr = cb_parse_search_text($str);

            // ユーザー情報一覧を取得する
            $data_count = $book->getFullTextSearchDataCount($str_arr, $se,
                $builtin_items);
            $order_by = 'tab_cb_user.col_position, tab_cb_user._id';
            $datas = $book->listFullTextSearchDatas(0, -1, $order_by,
                $str_arr, $se, $builtin_items);
            $datas_for_view = $view_util->listDatas($datas, null,
                $builtin_items, $extended_items);

            $display_obj = [];
            // 絞り込む
            if ($datas_for_view) {

                $user_obj_array
                    = $G_uum->getUserObjects(array_keys($datas_for_view));

                foreach ($datas_for_view as $key => $value) {
                    $emails = [];
                    $obj = $user_obj_array[$key];
                    if ($obj->get('email_address')) {
                        $emails[] = $obj->get('email_address');
                    }
                    require_once('cellular/utils.csp');
                    $extension_items = getDisplayExtensionItemList($obj,
                        ['use', 'show']);
                    foreach ($extension_items as $extension_item) {
                        if ($extension_item['type'] == 'email_address'
                            && strlen($extension_item['value']) != 0
                        ) {
                            $emails[] = $extension_item['value'];
                        }
                    }
                    if (count($emails) > 0) {
                        $display_obj[] = [
                            'mid'    => $obj->getOID(),
                            'name'   => $obj->get('display_name'),
                            'emails' => $emails
                        ];
                    }
                }
            }
            $data_count = count($display_obj);

            //ページ毎に表示するリストを取得。
            $total_count = count($display_obj);
            if ($total_count > $limit) {
                $start_point = ($page) * $limit;
                $end_point = ($page + 1) * $limit;

                $temp = [];
                for (
                    $i = $start_point; $i < $end_point && $i < $total_count;
                    $i++
                ) {
                    array_push($temp, $display_obj[$i]);
                }
                if ($end_point < $total_count) {
                    $next = $page + 1;
                    $smarty->assign('next_page', $next);
                    $smarty->assign('next', true);
                }
                if ($page > 0) {
                    $before = $page - 1;
                    $smarty->assign('before_page', $before);
                    $smarty->assign('before', true);
                }
                $smarty->assign('datas_for_view', $temp);
            } else {
                $smarty->assign('datas_for_view', $display_obj);
            }

            // セッションにパラメータを割り当てる
            $G_cellular_session->set('search_info', $search_for_view);
        }
    }
}

$smarty->assign('tab', $tab);

$G_cellular_session->set('back-from-address-view', $G_INPUT);

$smarty->display(cb_get_pagename() . '.tpl');

