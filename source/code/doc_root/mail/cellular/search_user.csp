<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;
/** @var GRN_Uum $G_uum */
// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular = $locator->getInstance('cellular');
$uconfig = $cellular->getUserConfig($G_login_user);
$limit = (int)($uconfig->getListMax());

$width = $uconfig->getSubjectWidth();

$smarty->assign('width', $width);

$cid = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;
$aid = isset($G_INPUT['aid']) ? $G_INPUT['aid'] : null;
$gid = isset($G_INPUT['gid']) ? $G_INPUT['gid'] : null;
$page = isset($G_INPUT['pg']) ? $G_INPUT['pg'] : null;

$smarty->assign('cid', $cid);
$smarty->assign('aid', $aid);

$params = (isset($G_INPUT)) ? $G_INPUT : null;
unset($params['pg']);
unset($params['gid']);
$smarty->assign('params', $params);

$tab = [
    'mode'   => 'b',
    'page'   => cb_get_pagename(),
    'params' => $params,
    'add'    => [
        [ // 検索tab
          'mode' => 's',
          'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

$smarty->assign('access_plugin', null);

if ( ! strlen($gid)) {
    $smarty->assign('gid', 'b');
} else {
    // gid分割
    $smarty->assign('gid', $gid);
    if (($p = strpos($gid, ':')) !== false) {
        $group_id = substr($gid, 0, $p);
    } else {
        $group_id = $gid;
    }
    $prefix = substr($group_id, 0, 1);
    if ( ! is_numeric($prefix)) {
        $group_id = substr($group_id, 1);
    } else {
        $prefix = 'g';
    }
    $tab['mode'] = $prefix;

    $display_obj = [];
    $members = [];

    if ($prefix == 's') {
        // 検索ページにswitch
        $G_cellular_session->set('mail_search_user_group', cb_get_pagename());
        grn_cellular_switch_page($G_pagepath . '/search2');
    } elseif ($prefix == 'm') {
        if ($group_id) {
            // Myグループ
            if ( ! ($group = &$G_uum->getMyGroup($group_id))) {
                cb_throw_error(E_GRN_MYGROUP_NOT_FOUND);
            }
            // ユーザーの取得
            $members = $G_uum->getMyGroupUsers($group->getOID());
        }
    } elseif ($prefix == 'u') {
        // 最近選択したユーザー
        $lists = $G_uum->getFrequentUsersInfo($G_login_user->getOID());
        foreach (array_keys($lists) as $_id) {
            $members[$_id] = $G_uum->getUser($_id);
        }
    } else {
        if ($group_id) {
            // 組織
            if ( ! ($group = &$G_uum->getGroup($group_id))) {
                cb_throw_error(E_GRN_GROUP_NOT_FOUND);
            }
            // ユーザーの取得
            $members = $G_uum->getGroupUsers($group->getOID());
        }
    }

    // 絞り込む
    if ($members) {
        foreach ($members as $id => $obj) {
            //emailｱﾄﾞﾚｽ情報を持っているユーザだけ表示する。

            $emails = [];
            if ($obj->get('email_address')) {
                $emails[] = $obj->get('email_address');
            }
            require_once('cellular/utils.csp');
            $extension_items = getDisplayExtensionItemList($obj,
                ['use', 'show']);
            foreach ($extension_items as $extension_item) {
                if ($extension_item['type'] == 'email_address'
                    && strlen($extension_item['value']) != 0
                ) {
                    $emails[] = $extension_item['value'];
                }
            }
            if (count($emails) > 0) {
                $display_obj[] = [
                    'mid'    => $obj->getOID(),
                    'name'   => $obj->get('display_name'),
                    'emails' => $emails
                ];
            }
        }
    }

    //ページ毎に表示するリストを取得。
    $total_count = count($display_obj);
    if ($total_count > $limit) {
        $start_point = ($page) * $limit;
        $end_point = ($page + 1) * $limit;

        $temp = [];
        for ($i = $start_point; $i < $end_point && $i < $total_count; $i++) {
            if ($display_obj[$i]) {
                array_push($temp, $display_obj[$i]);
            }
        }
        if ($end_point < $total_count) {
            $next = $page + 1;
            $smarty->assign('next_page', $next);
            $smarty->assign('next', true);
        }
        if ($page > 0) {
            $before = $page - 1;
            $smarty->assign('before_page', $before);
            $smarty->assign('before', true);
        }
        $smarty->assign('objects', $temp);
    } else {
        $smarty->assign('objects', $display_obj);
    }
}

$smarty->assign('tab', $tab);

// this value will be used to come back from /address/cellular/view 
$G_cellular_session->set('back-from-address-view', $G_INPUT);

$smarty->display(cb_get_pagename() . '.tpl');

