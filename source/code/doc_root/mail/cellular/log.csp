<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$width = $user_config->getSubjectWidth();
$smarty->assign('width', $width);

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($G_login_user);
$address_history_logic = $utility->getAddressHistoryLogic();


// 送受信記録機能の使用が許可されているか
if ( ! $system_config->canUserUseHistory()) {
    cb_throw_error(E_GRN_MAIL_CANNOT_USE_ADDRESS_HISTORY);
}


//------------------
require_once("cellular/controller.csp");
$controller_util = new GRN_Cellular_ControllerUtil();
//assert( '! is_null( $controller_util )' );
// 表示する件数
$number_on_page = $user_config->getListMax();
// N件ナビゲーション
// 現在位置
$current_start_position = $controller_util->getNaviStartPosition();
$isExistsNextPage = false;

// セッションに保存
$controller_util->setNaviStartPosition($current_start_position);

$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];

require_once('mail/resources.csp');
$status_id = GRN_MAIL_STATUS_CODE_ALL;

if ( ! is_string($account_id) || (strlen($account_id) == 0)) {
    if (is_string($category_id) && (strlen($category_id) > 0)) {
        // フォルダから逆引き
        $folder_logic = $utility->getFolderLogic();
        $folder_data = $folder_logic->getFolderData($category_id, false,
            false);
        if (is_array($folder_data)) {
            $account_id = $folder_data['account_id'];
        }
    } else {
        // デフォルトアカウントID
        $account_id = $personal_config->getDefaultAccountId();
    }
}

$mid = null;
if (isset($G_INPUT['mid'])) {
    $mid = $G_INPUT['mid'];
}

$email = null;
if (isset($G_INPUT['email'])) {
    $email = $G_INPUT['email'];
    if (is_string($email) && (strlen($email) > 0)) {
        $email = urldecode($G_INPUT['email']);
        $email = GRN_Mail_Utility::static_addEmailBracket($email, 'remove');

        // 指定されたE-Mailのアドレス情報を取得
        $address_info_data
            = $address_history_logic->getAddressInfoDataByEmailFromMessage($G_login_user,
            $email,
            $status_id,
            'send_ts',
            true,
            $current_start_position,
            $number_on_page);
    } else {
        $email = null;
    }
}

if ( ! is_string($email)) {
    $address_info_data = null;
}

$history_list = [];
//------------------
if (is_null($address_info_data)) {
    // データが見つからない
    $address_info_data_for_view = [
        'aid'      => $account_id,
        'cid'      => $category_id,
        'name'     => $email,
        'email'    => $email,
        'disabled' => true
    ];
    $history_list_for_view = null;
} else {
    $from = '';
    $from_name
        = GRN_Mail_Utility::static_addNameQuotation($address_info_data['name'],
        'add');
    $from_email
        = GRN_Mail_Utility::static_addEmailBracket($address_info_data['email'],
        'add');
    if (strlen($from_name) > 0) {
        $from = $from_name;
        if (strlen($from_email) > 0) {
            $from .= ' ';
        }
    }
    if (strlen($from_email) > 0) {
        $from .= $from_email;
    }
    $address_info_data_for_view = [
        'mid'   => $mid,
        'aid'   => $account_id,
        'cid'   => $category_id,
        'name'  => $from,
        //      'from' => $address_info_data['name'],
        'email' => $from_email
    ];

    // 履歴データ一覧を取得
    $history_list
        = $address_history_logic->getAddressHistoryDataList($G_login_user,
        $address_info_data['email'],
        'send_ts',
        true,
        0,
        $number_on_page + 1,
        $status_id);
    $isExistsNextPage
        = $address_history_logic->hasNextPage($address_info_data['email']);
    $history_list_for_view = [];
    if (is_array($history_list)) {
        $count = 1;
        foreach (array_keys($history_list) as $key) {
            $history_data =& $history_list[$key];
            $time_view_flag = false;  //日付の表示判断フラグ。
            $time = $history_data['send_ts'];
            $tsex = new CB_TimeStampEx($time);
            $time_day = $tsex->getDate();
            if ($count == 1) {
                $time_view_flag = true;
                $temp_time = $time_day;
            } else {
                if ($temp_time != $time_day) {
                    $time_view_flag = true;
                    $temp_time = $time_day;
                }
            }
            unset($tsex);
            $count++;

            $history_data =& $history_list[$key];

            $mail_id = $history_data['mail_id'];

            $history_list_for_view[$key] = [
                'type'           => $history_data['sent'], //受信0 送信1
                'mid'            => $mail_id,
                'name'           => $from,
                'time'           => $history_data['send_ts'],
                'subject'        => $history_data['subject'],
                'attached_files' => $history_data['attached'],
                'time_view_flag' => $time_view_flag,
            ];

            $temp_account_id = $history_data['account_id'];
            $account_data
                = $personal_config->getAccountData($temp_account_id,
                false, false);
            if (is_array($account_data)) {
                $history_list_for_view[$key]['account']
                    = $account_data['title'];
            }

            $read_ts = $history_data['read_ts'];
            $history_list_for_view[$key]['unread'] = ( ! is_object($read_ts)
                                                       || ($read_ts->unix_ts
                                                           == 0));
            $history_list_for_view[$key]['aid']
                = $history_data['account_id'];
            $history_list_for_view[$key]['cid'] = $history_data['folder_id'];

        }
    }

    $smarty->assign('mails', $history_list_for_view);
}

$email_url = is_string($email) ? urlencode($email) : null;
// n件ナビゲーション情報を取得する
$navigation_info = $controller_util->makeSimpleNaviInformation(
    $current_start_position,
    $number_on_page,
    count($history_list),
    $isExistsNextPage,
    [
        'mid'   => $mid,
        'email' => $email_url,
        'aid'   => $account_id,
        'cid'   => $category_id,
        'sid'   => $status_id
    ]
);

// データ一覧
$smarty->assign('navi', $navigation_info['navi']);
$smarty->display(cb_get_pagename() . '.tpl');


