<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$width = $user_config->getSubjectWidth();

$smarty->assign('width', $width);

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$mail_logic = $utility->getMailLogic();

$mail_id = (isset($G_INPUT['mid'])) ? $G_INPUT['mid'] : null;
//メールデータを取得。
$mail_data = $mail_logic->getMailData($mail_id, true);
//toのデータ取得
$to = GRN_Mail_Utility::static_formatAddressString($mail_data['to'], true, true,
    true, true, 'array');
//ccのデータ取得
$cc = GRN_Mail_Utility::static_formatAddressString($mail_data['cc'], true, true,
    true, true, 'array');

$to_list = [];
foreach ($to as $key => $value) {
    array_push($to_list, [
            'no'      => $key,
            'type'    => 'to',
            'name'    => $value['name'],
            'email'   => $value['email'],
            'caption' => $value['name'] . $value['email'],
        ]
    );
}

foreach ($cc as $key => $value) {
    array_push($to_list, [
            'no'      => $key,
            'type'    => 'cc',
            'name'    => $value['name'],
            'email'   => $value['email'],
            'caption' => $value['name'] . $value['email'],
        ]
    );
}

if (array_key_exists('bcc', $mail_data)) {
    $bcc = GRN_Mail_Utility::static_formatAddressString($mail_data['bcc'], true,
        true, true, true, 'array');
    foreach ($bcc as $key => $value) {
        array_push($to_list, [
                'no'      => $key,
                'type'    => 'bcc',
                'name'    => $value['name'],
                'email'   => $value['email'],
                'caption' => $value['name'] . $value['email'],
            ]
        );
    }
}

//リストのトータル数。
$total_count = count($to_list);

$list_per_page = (int)($user_config->getListMax() / 2);
//取得したリストが設定値より多い場合の遷移の処理。
if (isset($G_INPUT['pa'])) {
    $page = $G_INPUT['pa'];
} else {
    $page = 1;
}
if ($total_count > $list_per_page) {

    $start_point = ($page - 1) * $list_per_page;
    $end_point = $page * $list_per_page;

    $temp = [];

    for ($i = $start_point; $i < $end_point && $i < $total_count; $i++) {

        if ($to_list[$i]) {
            array_push($temp, $to_list[$i]);
        }
    }
    if ($end_point <= $total_count) {
        $next = $page + 1;
    }

    if ($page > 1) {
        $before = $page - 1;
    }
    $smarty->assign('to_list', $temp);
    $smarty->assign('next_page', (isset($next)) ? $next : 0);
    $smarty->assign('before_page', (isset($before)) ? $before : 0);
} else {
    $smarty->assign('to_list', $to_list);
}
$smarty->assign('mid', $mail_id);

// 送受信記録機能の使用が許可されているか
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($G_login_user);
$smarty->assign('use_history', $system_config->canUserUseHistory());

$smarty->display(cb_get_pagename() . '.tpl');


