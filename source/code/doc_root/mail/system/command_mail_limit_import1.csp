<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $charset = '';
    if (array_key_exists('charset', $G_INPUT)) {
        $charset = $G_INPUT['charset'];
    }

    $skip = 0;
    if (array_key_exists('skip', $G_INPUT)) {
        $skip = intval($G_INPUT['skip']);
    }

    $target_name = 'mail/system/mail_limit_import1';

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        require_once('fw/session_manager.csp');

        $session_manager = CB_SessionManager::getInstance();
        $session = $session_manager->getSession($target_name);
        $file_infos = $session->getFiles('import_files');
        if (is_array($file_infos)) {
            foreach (array_keys($file_infos) as $id) {
                $session->unsetFile('import_files', $id);
            }
        }

        $file = $_FILES['file'];

        if ($file['error']) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }
        // セッションにファイルを一時保存
        $file_id = $session->addFile('import_files', $file);

        // the validation session is finished
        if (SmartyValidate::is_registered_form($target_name)) {
            SmartyValidate::unregister_form($target_name);
        }

        cb_redirect('mail/system/mail_limit_import2',
            [
                'charset' => $charset,
                'skip'    => $skip,
                'file'    => $file_id
            ]);
    } else {
        $t->setPageInfo($target_name);

        if ( ! $charset) {
            global $G_config_common;
            $charset = $G_config_common->get('I18N',
                'default_external_encoding');
        }

        $t->assign('charset', $charset);
        $t->assign('skip', $skip);

        $parent_page = 'mail/system/import_index';

        $page_title = grn_get_current_page_display_name();
        $parent_name = grn_get_page_display_name($parent_page);
        $t->assign('page_title', $page_title);
        $t->assign(
            'site_position',
            [
                ['page' => $parent_page, 'name' => $parent_name],
                ['page' => "", 'name' => $page_title],
            ]
        );

        $t->display($target_name . '.tpl');
    }
}

