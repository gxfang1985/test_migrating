<?php
require_once("SmartyValidate.class.php");
if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST')) {
    global $G_INPUT;
    if (array_key_exists('uid', $G_INPUT)) {
        $user_id = $G_INPUT['uid'];
    }
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getUser($user_id);
    if ( ! is_object($user) || ! is_a($user, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    if ($G_INPUT['mailbox_size'] != -10) {
        $G_INPUT['customize'] = '1';
    }
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    // Validation check

    SmartyValidate::connect($t);
    $target_name = 'mail/system/user_mail_limit';
    // force to register
    SmartyValidate::register_form($target_name);
    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $customsize = $G_INPUT['mailbox_size'] == '-10';
        $settings = [
            'user_limit_' . $user_id    => $customsize ? $G_INPUT['customize']
                : $G_INPUT['mailbox_size'],
            'receive_limit_' . $user_id => $G_INPUT['receive_size'],
            'send_limit_' . $user_id    => $G_INPUT['send_size']
        ];

        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $system_config = $utility->getSystemConfig();
        $system_config->getSizeUserLimitSetting($setting, $user_id);
        $system_config->getSizeLimitSetting($setting_common);
        $user_limit = $setting['user_limit_' . $user_id];
        $receive_limit = $setting['receive_limit_' . $user_id];
        $send_limit = $setting['send_limit_' . $user_id];
        if ($G_INPUT['mailbox_size'] == $setting_common['user_limit']
            && $G_INPUT['receive_size'] == $setting_common['receive_limit']
            && $G_INPUT['send_size'] == $setting_common['send_limit']
        ) {
            $system_config->removeSizeUserLimitSetting($settings, $user_id);
            cb_redirect('mail/system/user_disk_size');
        }
        if ($user_limit != ($customsize ? $G_INPUT['customize']
                : $G_INPUT['mailbox_size'])
            || $receive_limit != $G_INPUT['receive_size']
            || $send_limit != $G_INPUT['send_size']
        ) {
            // サイズ制限
            $system_config->setSizeUserLimitSetting($settings, $user_id);
        } else {
            if ($user_limit == $setting_common['user_limit']
                && $receive_limit == $setting_common['receive_limit']
                && $send_limit == $setting_common['send_limit']
            ) {
                $system_config->removeSizeUserLimitSetting($settings, $user_id);
            }

        }
        cb_redirect('mail/system/user_disk_size');
    } else {
        $doc_name = cb_get_pagename();
        $t->assign('app_name', $G_mail_name);
        include('_user_mail_limit.csp');
        //------------------
        $t->setPageInfo($target_name);
        // page title
        $page_title = grn_get_page_display_name('mail/system/user_mail_limit');
        $t->assign('page_title', $page_title);

        // site position
        $t->assign(
            'site_position', [
                [
                    'page' => '',
                    'name' => grn_get_page_display_name('mail/system/user_mail_limit')
                ]
            ]
        );
        $option_tmp = cb_at($G_INPUT, 'mailbox_size');
        for ($i = 0; $i < count($mailbox_size); $i++) {
            $mailbox_size[$i]['selected'] = $mailbox_size[$i]['value']
                                            == $option_tmp;
        }
        $t->assign('mailbox_size', $mailbox_size);

        // 送信メールサイズ設定    
        $send_size_tmp = cb_at($G_INPUT, 'send_size');
        for ($i = 0; $i < count($send_size); $i++) {
            $send_size[$i]['selected'] = $send_size[$i]['value']
                                         == $send_size_tmp;
        }
        $t->assign('send_size', $send_size);

        // 受信メールサイズ設定
        $receive_size_tmp = cb_at($G_INPUT, 'receive_size');
        for ($i = 0; $i < count($receive_size); $i++) {
            $receive_size[$i]['selected'] = $receive_size[$i]['value']
                                            == $receive_size_tmp;
        }
        $t->assign('user_id', $G_INPUT['uid']);
        $t->assign('receive_size', $receive_size);
        //-- show page
        $t->assign('customize', $G_INPUT['customize']);

        $t->display('mail/system/user_mail_limit.tpl');
    }
}



