<?php
require_once("SmartyValidate.class.php");
if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST')) {
    global $G_INPUT;
    if ($G_INPUT['mailbox_size'] != -10) {
        $G_INPUT['customize'] = '1';
    }
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    // Validation check

    SmartyValidate::connect($t);
    $target_name = 'mail/system/mail_limit';
    // force to register
    SmartyValidate::register_form($target_name);
    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $customsize = $G_INPUT['mailbox_size'] == '-10';
        $settings = [
            'user_limit'    => $customsize ? $G_INPUT['customize']
                : $G_INPUT['mailbox_size'],
            'receive_limit' => $G_INPUT['receive_size'],
            'send_limit'    => $G_INPUT['send_size']
        ];
        require_once('mail/utility.csp');
        require_once('grn/org_util.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $system_config = $utility->getSystemConfig();
        // サイズ制限
        $system_config->setSizeLimitSetting($settings);
        //reset value mail size limit of all users
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $user_count = $uum->getUserCount();
        //--N-navigation
        $navi_params = [];
        $navigation_info = grn_get_user_navigation_info($user_count,
            $navi_params, -1);
        $user_list = $system_config->getUsersAccountList(null,
            $navigation_info);
        foreach (array_keys($user_list) as $uid) {
            $system_config->removeSizeUserLimitSetting($settings, $uid);
        }
        cb_redirect('system/application_list', ['app_id' => 'mail']);
    } else {
        $doc_name = cb_get_pagename();
        $t->assign('app_name', $G_mail_name);
        include('_mail_limit.csp');
        //------------------
        $t->setPageInfo($target_name);
        // page title
        $page_title = grn_get_page_display_name('mail/system/mail_limit');
        $t->assign('page_title', $page_title);

        // site position
        $t->assign(
            'site_position', [
                [
                    'page' => '',
                    'name' => grn_get_page_display_name('mail/system/mail_limit')
                ]
            ]
        );
        $option_tmp = cb_at($G_INPUT, 'mailbox_size');
        for ($i = 0; $i < count($mailbox_size); $i++) {
            $mailbox_size[$i]['selected'] = $mailbox_size[$i]['value']
                                            == $option_tmp;
        }
        $t->assign('mailbox_size', $mailbox_size);

        // 送信メールサイズ設定    
        $send_size_tmp = cb_at($G_INPUT, 'send_size');
        for ($i = 0; $i < count($send_size); $i++) {
            $send_size[$i]['selected'] = $send_size[$i]['value']
                                         == $send_size_tmp;
        }
        $t->assign('send_size', $send_size);

        // 受信メールサイズ設定
        $receive_size_tmp = cb_at($G_INPUT, 'receive_size');
        for ($i = 0; $i < count($receive_size); $i++) {
            $receive_size[$i]['selected'] = $receive_size[$i]['value']
                                            == $receive_size_tmp;
        }
        $t->assign('receive_size', $receive_size);
        //-- show page
        $t->assign('customize', $G_INPUT['customize']);

        $t->display('mail/system/mail_limit.tpl');
    }
}
