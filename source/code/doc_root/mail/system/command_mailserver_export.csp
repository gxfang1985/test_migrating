<?php

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

global $G_INPUT;
$charset = @ $G_INPUT['charset'];
if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

/// テンポラリのファイルを作成
$tempdir = cb_tmpdir();
$temp_filename = tempnam($tempdir, 'mailcsv_');

require_once('fw/csv.csp');
$csv = new CB_CSVWriter($charset, $temp_filename);

// 項目名の書き出し
$b_item_name = @ $G_INPUT['item_name'];

require_once('mail/system_config.csp');
$system_config = GRN_Mail_SystemConfig::getInstance();
$system_config->exportServerDataToCSV($csv, $b_item_name);
$csv->close();

// 一時ファイルに書き出した内容をファイルとして出力
cb_prepare_download('mailserver.csv', 'application/csv', false);
$fp = fopen($temp_filename, 'rb');
if (($size = filesize($temp_filename)) > 0) {
    echo fread($fp, $size);
}
fclose($fp);
// 一時ファイルの削除
unlink($temp_filename);

