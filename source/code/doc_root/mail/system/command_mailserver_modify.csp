<?php

if (array_key_exists('REQUEST_METHOD', $_SERVER)
    && 0 == strcasecmp($_SERVER['REQUEST_METHOD'], 'POST')
) {
    $mailserver_id = array_key_exists('msid', $G_INPUT) ? $G_INPUT['msid'] : '';
    if (is_null($mailserver_id) || $mailserver_id == "") {
        cb_throw_error(E_GRN_MAIL_SERVER_DATA_NOT_FOUND);
    }
    $port_params = ['smtp_port', 'received_port'];
    $tmp_port_params = [];
    foreach ($port_params as $param) {
        if (array_key_exists($param, $G_INPUT)
            && ! is_numeric($G_INPUT[$param])
        ) {
            $tmp_port_params[$param] = $G_INPUT[$param];
            $G_INPUT[$param] = '0';
        }
    }

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'mail/system/mailserver_modify';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        // reset params from tmp
        foreach ($tmp_port_params as $param) {
            $G_INPUT[$param] = $tmp_port_params[$param];
        }

        require_once('mail/system_config.csp');
        require('_command_mailserver_add.csp');

        // サーバーデータの追加
        $system_config = GRN_Mail_SystemConfig::getInstance();
        $server_id = $system_config->modifyServerData($mailserver_id,
            $foreign_key, $name, null, $server_info);

        // the validation session is finished
        if (SmartyValidate::is_registered_form($target_name)) {
            SmartyValidate::unregister_form($target_name);
        }

        cb_redirect('mail/system/mailserver_view', ['msid' => $mailserver_id]);

    } else {

        //-- if error, show the source form

        $t->setPageInfo($target_name);

        // reset params from tmp
        foreach ($tmp_port_params as $param => $value) {
            $G_INPUT[$param] = $value;
        }

        // page title
        $page_title = grn_get_current_page_display_name();
        $t->assign('page_title', $page_title);

        // site position
        $t->assign(
            'site_position', [
                [
                    'page' => 'mail/system/mailserver',
                    'name' => grn_get_page_display_name('mail/system/mailserver')
                ],
                [
                    'page' => '',
                    'name' => $page_title
                ]
            ]
        );

        $t->assign('msid', $mailserver_id);

        require('_mailserver_add.csp');

        require('_command_mailserver_add_validate.csp');

        $t->assign(
            'encrypted_connection', [
                [
                    'value' => 'NONE',
                    'label' => cb_msg('grn.mail.system', 'none')
                ],
                [
                    'value'    => 'SSL',
                    'label'    => cb_msg('grn.mail.system', 'use_ssl'),
                    'selected' => $use_SSL
                ],
                [
                    'value'    => 'TLS',
                    'label'    => cb_msg('grn.mail.system', 'use_tls'),
                    'selected' => $use_TLS
                ],
            ]
        );

        //-- show page
        $t->display('mail/system/mailserver_modify.tpl');
    }


}

