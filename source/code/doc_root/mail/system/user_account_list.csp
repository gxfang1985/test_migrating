<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
global $G_INPUT;
global $G_container_base;
$org_id = @ $G_INPUT['oid'];
$t->assign('org_id', $org_id);
$user_id = @ $G_INPUT['uid'];
$uum = $G_container_base->getInstance('uum');
$user = $uum->getUser($user_id);
if ( ! is_object($user)) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

//--------------------------------------------------------------
require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();

//--------------------------------------------------------------
// アカウントデータリスト
$account_list = $system_config->getAccountDataList($user, true, false, -1, -1,
    false, false);

$account_list_for_view = [];
if (is_array($account_list)) {
    foreach (array_keys($account_list) as $key) {
        $account_data =& $account_list[$key];
        if (is_array($account_data)) {
            $account_info = $account_data['account_info'];
            $server_data =& $account_data['server'];
            $name = $account_data['name'];
            $account_name = $account_data['title'];
            $size = $account_data['mail_size'];
            if (($size > 0) && ($size < 1024)) {
                $size = 1024;
            }

            $disabled = $account_data['disabled'];
            $deleted = $account_data['deleted'];
        } else {
            $account_info = null;
            $server_data = null;
            $name = '';
            $account_name = '';
            $size = 0;
            $disabled = true;
            $deleted = true;
        }

        if (is_object($account_info)) {
            $email = $account_info->email;
            $retrieve_account = $account_info->retrieve_account;
            $retrieve_save = $account_info->getRetrieveSave();
        } else {
            $email = null;
            $retrieve_account = null;
            $retrieve_save = null;
            $disabled = true;
            $deleted = true;
        }

        $account_list_for_view[$key] = [
            'aid'               => $key,
            'name'              => $name,
            'title'             => $account_name,
            'account'           => $retrieve_account,
            'email'             => $email,
            'size'              => $size,
            'leave_server_mail' => $retrieve_save,
            'mailserver'        => $server_data,
            'stop'              => $disabled,
            'deleted'           => $deleted
        ];
    }
}

//--------------------------------------------------------------

// ユーザー情報
$user_for_view = [
    'uid'  => $user->getOID(),
    'name' => $user->get('display_name')
];
$t->assign('user', $user_for_view);

// アカウント情報
$t->assign('account_list', $account_list_for_view);

$t->assign('disabled_add_account',
    $system_config->getServerDataCount() < 1 ? true : false);
$t->assign('disabled_change_order',
    count($account_list_for_view) < 2 ? true : false);

//--------------------------------------------------------------

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'user_account'      => ['oid' => $org_id],
    'user_account_list' => null
];

$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('mail/system/', $page_infos);
$t->assign('site_position', $site_position);
$t->display(cb_get_pagename() . '.tpl');

