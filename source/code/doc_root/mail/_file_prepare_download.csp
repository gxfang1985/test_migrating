<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

require_once('mail/table.csp');
require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$mail_logic = $utility->getMailLogic();

//------------------

if (isset($G_INPUT['tmpid'])) {
    $temp_mail_id = @ $G_INPUT['tmpid'];
} else {
    $mail_id = @ $G_INPUT['mid'];
}
$file_id = @ $G_INPUT['fid'];
$pids = @ $G_INPUT['pids'];
$pid_array = null;
if (is_string($pids) && (strlen($pids) > 0)) {
    $pid_array = explode('.', $pids);
}
$pids_count = is_array($pid_array) ? count($pid_array) : 0;

if (isset($temp_mail_id)) {
    $b_sent = true;
    $temp_mail_data = $mail_logic->getTemporaryMailData($temp_mail_id, true);
    if (array_key_exists('files', $temp_mail_data)
        && in_array($file_id, array_keys($temp_mail_data['files']))
    ) {
        $file_body = $mail_logic->getTemporaryMailFileBodyRow($file_id);
    } else {
        cb_throw_error(E_GRN_MAIL_FILE_DATA_NOT_FOUND);
    }
} else {
    $b_sent = false;
    $mail_data = $mail_logic->getMailData($mail_id, false);
    if ($pids_count == 0) {
        $file_body = $mail_logic->getMailFileBody($mail_id, $file_id);
        if ($mail_data['sent'] && $mail_data['import_mail'] === false
            || (isset($mail_data['draft']) && $mail_data['draft'] == 1)
        ) {
            // 下書きメールも送信メールと同様に扱う
            $b_sent = true;
        }
    } else {
        // 内包メールをパーズ
        // セッションファイルに保存されているメールソースを読み込む
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session = $session_manager->getSession(GRN_MAIL_BREVITY_CODE
                                                . '_rfc822_' . $pids);

        // 指定したセクションに関連付けられている連想配列を取得する。
        // (キー=ID 値=CB_ServerFile のもの)
        $ids = $session->getFiles('temp_files');
        foreach (array_keys($ids) as $id) {
            $temp_file = $ids[$id];

            // $draft_file は CB_ServerFile と同じメソッドを持つので、
            // fopen したり削除したりすることができる。

            $mail_source = $temp_file->getPath();
            break;
        }

        require_once('fw/mail_message.csp');
        $message = CB_MailParser::static_parse($mail_source);
        if (is_null($message)) {
            cb_throw_error(E_GRN_MAIL_FILE_DATA_NOT_FOUND);
        }

        $attachments = $message->getAttachedParts(true);
        if (array_key_exists($file_id, $attachments)) {
            $file_body = $attachments[$file_id];
        }
    }
}

if ( ! is_object($file_body)) {
    cb_throw_error(E_GRN_MAIL_FILE_DATA_NOT_FOUND);
}

$file_name = (method_exists($file_body, 'getFilename'))
    ? $file_body->getFilename() : $file_body->get('name');
