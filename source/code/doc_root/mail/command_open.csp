<?php

global $G_INPUT;
$account_id = cb_at($G_INPUT, 'aid');
$mail_id = cb_at($G_INPUT, 'mid');

if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST')) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    $cmd = array_key_exists('cmd', $G_INPUT) ? $G_INPUT['cmd'] : '';

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();

    if (strcmp($cmd, 'open') === 0)        // 開封返信メールを送信
    {
        $send_logic = $utility->getSendLogic();
        $send_logic->sendResponseOfConfirmationMail($user, $account_id,
            $mail_id, 'manual');
    } elseif (strcmp($cmd, 'ignored') === 0) // 送信しない
    {
        $mail_logic = $utility->getMailLogic();
        $mail_logic->setConfirmationStatus($mail_id, 'ignored');
    }
}

cb_redirect('mail/view', ['mid' => $mail_id]);


