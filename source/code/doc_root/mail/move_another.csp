<?php
global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();
if ( ! is_object($user)) {
    cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('mail/table.csp');
require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$personal_config = $utility->getPersonalConfig($user);
$folder_logic = $utility->getFolderLogic();

$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];

//------------------

// セッションから削除するメールデータIDリストを取得
require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session = $sm->getSession('mail/index');

$mail_ids = $session->get('mail_ids');
$delete_num = is_array($mail_ids) ? count($mail_ids) : 0;

//------------------

// アカウントデータリスト
$account_list_for_view = [];
$account_data = null;
$folder_list_for_view = [];
$folder_list_for_view['data'] = [];
$account_list = $personal_config->getAccountDataList(false,
    false, -1, -1, false, false);
if (is_array($account_list)) {
    foreach (array_keys($account_list) as $key) {
        $temp_data =& $account_list[$key];
        $temp_account_info = $temp_data['account_info'];
        $temp_title = $temp_data['title'];
        $account_list_for_view[$key] = [
            'value' => $key,
            'label' => $temp_title
        ];

        if ($key == $account_id) {
            $account_list_for_view[$key]['selected'] = true;
            $temp_cid = $category_id;
        } else {
            // 受信箱データ取得
            $temp_data = $folder_logic->getSpecialFolderData($key,
                GRN_MAIL_FOLDER_CODE_INBOX, false);
            $temp_cid = $temp_data['id'];
        }
        $folder_list_for_view['data'][] = ['aid' => $key, 'cid' => $temp_cid];
    }
    $folder_list_for_view['selected'] = $account_id;
}

// カレントアカウント
if ( ! is_null($account_id) && array_key_exists($account_id, $account_list)
     && ! is_null($account_list[$account_id])
) {
    $account_data =& $account_list[$account_id];
} else {
    $account_id = null;
}

if (is_null($account_id) || is_null($account_data)) {
    cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
}

//------------------

// フォルダ情報
$folder_data = $folder_logic->getFolderData($category_id, false);

//------------------

$page_title = grn_get_current_page_display_name();

$page_index = 'mail/index';
$page_root = 'mail/root';
$page_inbox = 'mail/inbox';
$page_outbox = 'mail/outbox';
$page_draftbox = 'mail/draftbox';
$page_garbagebox = 'mail/garbagebox';
$page_category_list = 'mail/category_list';

$folder_code = is_array($folder_data) ? $folder_data['code'] : '';

switch ($folder_code) {
    case GRN_MAIL_FOLDER_CODE_ROOT:
        $folder_type = '0';
        $page_folder = grn_get_page_display_name($page_root);
        break;
    case GRN_MAIL_FOLDER_CODE_INBOX:
        $folder_type = '1';
        $page_folder = grn_get_page_display_name($page_inbox);
        break;
    case GRN_MAIL_FOLDER_CODE_SENTBOX:
        $folder_type = '2';
        $page_folder = grn_get_page_display_name($page_outbox);
        break;
    case GRN_MAIL_FOLDER_CODE_UNSENT:
        $folder_type = '3';
        $page_folder = grn_get_page_display_name($page_draftbox);
        break;
    case GRN_MAIL_FOLDER_CODE_TRASH:
        $folder_type = '4';
        $page_folder = grn_get_page_display_name($page_garbagebox);
        break;
    default:
        $folder_type = '5';
        $page_folder = grn_get_page_display_name($page_category_list);
        break;
}


//--------------------------------------------------------------

$t->assign('category_id', $category_id);


// page title
$t->assign('page_title', $page_title);

$t->assign(
    'site_position',
    [
        $utility->getIndexSitePosition($user, $account_id),
        [
            'page' => $page_index,
            'name' => $page_folder,
            'aid'  => $account_id,
            'cid'  => $category_id
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

//移動メール件数
$t->assign('move_numbers', $delete_num);

// set_data
$t->assign('mails', $mail_ids);
$t->assign('aid', $account_id);

$t->assign('set', ['account' => $account_data['title']]);

// アカウントリスト
$t->assign('user_account', $account_list_for_view);

// フォルダリスト
$t->assign('folder_list', $folder_list_for_view);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

