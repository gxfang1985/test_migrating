<?php

global $G_INPUT;
$account_id = @ $G_INPUT['aid'];
$category_id = @ $G_INPUT['cid'];
$parent_id = @ $G_INPUT['pid'];

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    $name = @ $G_INPUT['title'];
    $memo = @ $G_INPUT['memo'];
    $new_account_id = @ $G_INPUT['user_account'];

    $target_name = 'mail/folder_modify';

    // Smarty をインスタンス化
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $folder_logic = $utility->getFolderLogic();

    $folder_data = $folder_logic->getFolderData($category_id);
    if (strlen($folder_data['code']) > 0) {
        require_once('fw/i18n.csp');
        require_once('mail/resources.csp');
        $G_INPUT['title'] = $folder_data['code'];
        $name = cb_msg(GRN_MAIL_MODULE_ID, $G_INPUT['title']);
        $parent_id = $folder_data['parent_id'];
    }

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // フォルダの更新
        $folder_id = $folder_logic->modifyFolderData($category_id, $parent_id,
            $name, $memo);
        _mail_rebuild_folder_tree($account_id, $parent_id);

        cb_redirect('mail/folder_view', ['cid' => $category_id]);
    } else {
        $t->setPageInfo($target_name);

        $personal_config = $utility->getPersonalConfig($user);

        // フォルダ情報
        $folder_detail = true;
        include('_folder_add.csp');

        $category_for_view['title'] = $name;
        $category_for_view['cid'] = $category_id;
        $category_for_view['aid'] = $account_id;
        $category_for_view['memo'] = $memo;

        //--------------------------------------------------------------

        $folder_list_for_view = [];
        $folder_list_for_view['data'] = [];

        // 元々選択されていたアカウントの場合は、フォルダ階層は root から対象フォルダまで
        // 他のアカウントについては root から全て
        if (is_array($account_list)) {
            foreach (array_keys($account_list) as $key) {
                $temp_data =& $account_list[$key];

                if ($key == $account_id) {
                    $temp_cid = $category_id;
                    $parent_folder_id = $parent_id;
                    $hide_selected_folder = 1;
                } else {
                    $hide_selected_folder = 0;
                    if ($key == $new_account_id) {
                        $temp_cid = $parent_id;
                    } else {
                        // 受信箱データ取得
                        $temp_data = $folder_logic->getSpecialFolderData($key,
                            GRN_MAIL_FOLDER_CODE_INBOX, false);
                        $temp_cid = $temp_data['id'];
                    }
                }
                $folder_list_for_view['data'][] = [
                    'aid'   => $key,
                    'cid'   => $temp_cid,
                    'hflag' => $hide_selected_folder
                ];
            }
            $folder_list_for_view['selected'] = $new_account_id;
        }

        //--------------------------------------------------------------

        $t->assign('account_id', $account_id);
        $t->assign('category_id', $category_id);

        if (isset($parent_folder_id)) {
            $category_for_view['parent_id'] = $parent_folder_id;
        }

        $t->assign('category', $category_for_view);

        // page title
        $page_title = grn_get_current_page_display_name();
        $t->assign('page_title', $page_title);

        // account
        $t->assign('account', $account_for_view);

        // 選択されたユーザーアカウントをセット
        // 元々のユーザーアカウントが selected になってるのでそれはリセット
        foreach ($account_list_for_view as $_aid => $dummy) {
            if ($_aid == $new_account_id) {
                $selected = true;
            } else {
                $selected = false;
            }
            $account_list_for_view[$key]['selected'] = $selected;
        }

        $t->assign('user_account', $account_list_for_view);

        // フォルダリスト
        $t->assign('folder_list', $folder_list_for_view);

        $site_position = [
            $utility->getIndexSitePosition($user, $account_id),
            [
                'page' => $page_index,
                'name' => $page_folder,
                'aid'  => $account_id,
                'cid'  => $category_id
            ],
            [
                'page' => 'mail/folder_view',
                'name' => grn_get_page_display_name('mail/folder_view'),
                'aid'  => $account_id,
                'cid'  => $category_id,
            ],
            [
                'page' => '',
                'name' => $page_title
            ]
        ];

        $t->assign('site_position', $site_position);

        // Smarty実行
        $t->display($target_name . '.tpl');
    }

}


