<?php
require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
if ( ! $login) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

// portlet settings
$settings_for_view = [
    'font_size' => 'normal',
    'time'      => true,
    'app'       => 'all',
    'rows'      => 5,
];
$portlet_settings = [];
if (array_key_exists('settings', $portlet)) {
    $portlet_settings = $portlet['settings'];
}
if (is_array($portlet_settings)) {
    foreach ($portlet_settings as $key => $value) {
        $settings_for_view[$key] = $value;
    }
}
$t->assign('settings', $settings_for_view);

require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Star_Application $star_application */
$star_application = $app_locator->getInstance(GRN_STAR_APPLICATION_ID);
$star_application->updateStarList($login, false);

$translate_map =& $star_application->getSupportedApplications();
if (array_search(@$portlet_settings['app'], $translate_map) === false) {
    $module_id = null;
} else {
    $module_id = $portlet_settings['app'];
    $app_id = array_search($portlet_settings['app'], $translate_map);
    $support_app = $app_locator->getInstance($app_id, false, true);
    if ($support_app) {
        $locale_app_name = $support_app->getName();
    }
    $t->assign('supported_application_name', $locale_app_name);
    $t->assign('is_supported_application', true);
}
// personal config
require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$config = $cm->getUserConfig($login);
$t->assign('subject_width', $config->getSubjectWidth());
$t->assign('name_width', $config->getNameWidth());


require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$limit = $settings_for_view['rows'];
$star_data = $star_logic->getList($login, $module_id, 0, $limit, 'ctime',
    true);
$t->assign('star_list', $star_data);


// page title
if ($portlet['title'] === '') {
    $page_title = cb_plain_msg('grn.star', 'portlet_star_view');
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

$t->assign('portlet', $portlet);
$doc_name = 'star/portlet/view_star_list';
$t->display("{$doc_name}.tpl");
