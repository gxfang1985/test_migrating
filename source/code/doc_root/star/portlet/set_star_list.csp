<?php
require_once('portal/error_code.csp');

use grn\grn\access\service\AppAccess;

if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

$settings = array_key_exists('settings', $portlet) ? $portlet['settings'] : [];

// font options
$font_options_for_view = [
    ['value' => 'small', 'label' => cb_msg('grn.star', 'font_size_small')],
    ['value' => 'normal', 'label' => cb_msg('grn.star', 'font_size_normal')],
    ['value' => 'large', 'label' => cb_msg('grn.star', 'font_size_large')],
];
switch (@ $settings['font_size']) {
    case 'small':
        $font_options_for_view[0]['selected'] = true;
        break;
    case 'normal':
        $font_options_for_view[1]['selected'] = true;
        break;
    case 'large':
        $font_options_for_view[2]['selected'] = true;
        break;
    default:
        $font_options_for_view[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options_for_view);
// application
$apps = [
    [
        'value' => 'all',
        'label' => cb_msg('grn.star', 'all_application')
    ]
];
$b_found = false;
require_once('star/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Star_Application $star_app */
$star_app = $app_locator->getInstance(GRN_STAR_APPLICATION_ID);
$supported_apps =& $star_app->getSupportedApplications();
unset($star_app);
foreach ($supported_apps as $app_id => $module) {
    $app = $app_locator->getInstance($app_id);
    if (is_null($app) || ! AppAccess::isAppAvailable($app_id)) {
        continue;
    }
    $tmp = ['value' => $module, 'label' => $app->getName()];
    if ($module == @$settings['app']) {
        $tmp['selected'] = true;
        $b_found = true;
    }
    $apps[] = $tmp;
}
unset($app_locator, $app);
if ( ! $b_found) {
    $apps[0]['selected'] = true;
}

$t->assign('apps', $apps);

// display settings
$display_keys = ['time'];
if (is_array($settings)) {
    foreach ($display_keys as $key) {
        if (array_key_exists($key, $settings)) {
            $t->assign($key, $settings[$key]);
        } else {
            $t->assign($key, true);
        }
    }
} else {
    foreach ($display_keys as $key) {
        $t->assign($key, true);
    }
}
// row number

$t->assign(
    'select1', [
        'name'    => 'rows',
        'options' => [
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20
        ],
        'padding' => '&nbsp;',
    ]
);
$rows_for_view = array_key_exists('rows', $settings) ? $settings['rows'] : '';
if ($rows_for_view == '') {
    $rows_for_view = 5;
}
$portlet['settings']['rows'] = $rows_for_view;

//Assign include_php Parameter
$t->assign('portlet', $portlet);
$t->assign('display', $display);

$doc_name = 'star/portlet/set_star_list';
$t->display("{$doc_name}.tpl");

