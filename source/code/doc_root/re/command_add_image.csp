<?php

if (array_key_exists('REQUEST_METHOD', $_SERVER)
    && 0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')
) {
    require_once('re/re_file.csp');
    require_once('grn/smarty.csp');

    cb_require_role('LoginUser');
    $uploaded_file = $_FILES["file"];

    $success = true;
    $t = new GRN_Smarty;
    global $G_container_base, $G_state_set;
    $file_binder = $G_container_base->getInstance('re_file_binder');
    if ($file_binder->isValidFile($uploaded_file)) {
        if (CB_REFile::validateFileSize($uploaded_file, false)) {
            $fileid = $file_binder->addFile($uploaded_file);
            $file = $file_binder->getServerFile($fileid);

            $t->assign('fileid', $fileid);
            $t->assign('filehash', $file->get('hash'));
        } else {
            require_once('grn/file.csp');
            $config = GRN_FileManagerConfig::getInstance();
            $max_file_size = $config->getMaxFileSize();

            $t->assign('err_file_size_over',
                grn_get_filesize_format($max_file_size));
            $success = false;
        }
    } else {
        $t->assign('err_invalid_image_type', true);
        $success = false;
    }

    $G_state_set->set('html_should_be_closed', false);
    $G_state_set->set('copyright_should_be_written', false);
    if ($success) {
        $t->display("re/command_add_image.tpl");
    } else {
        $t->display("re/add_image.tpl");
    }
}
