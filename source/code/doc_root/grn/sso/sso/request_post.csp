<?php

//Get Smarty Instance
require_once("grn/smarty.csp");
$t =& $smarty;

//Get Identifier Value List
require_once('grn/sso.csp');
$sso_service = GRN_SSO_Service::getInstance();
$identifier_value_list
    = $sso_service->getIdentifierValueList($sso_link['app_id'],
    $sso_link['id_list']);

//Get System and Personal Parameter List
$system_param_list = $method['driver_settings']['system_params'];
$personal_param_list = $method['driver_settings']['personal_params'];
$param_list = $system_param_list + $personal_param_list;

//Create Identifier Value String
$param_string_list = [];
$replaced_param_list = $sso_service->replaceIdentifierValueList($param_list,
    $identifier_value_list);
foreach ($replaced_param_list as $name => $value) {
    $param_string_list[] = sprintf('%s=%s', $name, $value);
}
$param_string = implode('&', $param_string_list);

//Create ID List String
$id_list = serialize($sso_link['id_list']);
$id_list = urlencode($id_list);

//Create IFrame URL
$url = cb_pageurl('grn/sso/sso/request_post_frame');
$iframe_url = sprintf('%ssmid=%s&said=%s&id_list=%s', $url, $method['smid'],
    $sso_link['app_id'], $id_list);

//Get Available Window
$target = null;
if (array_key_exists('target', $sso_link)) {
    $target = $sso_link['target'];
} else {
    if ($method['available_window'] == 1) {
        $target = '_blank';
    }
}

//Get Caption and Image
$caption = null;
$image = null;
if (array_key_exists('caption', $sso_link)) {
    $caption = $sso_link['caption'];
}
if (array_key_exists('image', $sso_link)) {
    $image = $sso_link['image'];
}
if (array_key_exists('truncated_caption', $sso_link)) {
    //Truncated Caption Display
    $t->assign('truncated_caption', $sso_link['truncated_caption']);
}

//Get Redirect URL
if (array_key_exists('redirect_url', $sso_link)) {
    $redirect_url = $sso_link['redirect_url'];
} else {
    $redirect_url = $method['driver_settings']['target_url'];
}

//Assign Display Infomation

//Caption Display
$t->assign('caption', $caption);

//Image Display
$t->assign('image', $image);

//Assign Display Information
$t->assign('iframe_url', $iframe_url);

//Target URL Display
$t->assign('redirect_url', $redirect_url);

//Available Window Display Infomation
$t->assign('target', $target);

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("grn/sso/sso/request_post.tpl");


