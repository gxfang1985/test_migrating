<?php

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = $smarty;

//Get Parameters
$application_id = $sso_link['app_id'];
$id_list = $sso_link['id_list'];

//Get Identifier Value List
require_once('grn/sso.csp');
$sso_service = GRN_SSO_Service::getInstance();
$identifier_value_list = $sso_service->getIdentifierValueList($application_id,
    $id_list);

//Get System and Personal Parameter List
$system_param_list = $method['driver_settings']['system_params'];
$personal_param_list = $method['driver_settings']['personal_params'];
$param_list = $system_param_list + $personal_param_list;

//Create Identifier Value String
$param_string_list = [];
$replaced_param_list = $sso_service->replaceIdentifierValueList($param_list,
    $identifier_value_list);
foreach ($replaced_param_list as $name => $value) {
    $param_string_list[] = sprintf('%s=%s', $name, $value);
}
$param_string = implode('&', $param_string_list);

//Get Redirect URL
if (array_key_exists('redirect_url', $sso_link)) {
    $redirect_url = sprintf('%s?%s', $sso_link['redirect_url'], $param_string);
} else {
    $redirect_url = sprintf('%s?%s', $method['driver_settings']['target_url'],
        $param_string);
}

//Create IFrame Parameters
$iframe_param_names = "";
$iframe_param_values = "";
if (is_array($replaced_param_list)) {
    $iframe_param_names = implode(',', array_keys($replaced_param_list));
    $iframe_param_values = implode(',', $replaced_param_list);
}

//Get Available Window
$target = null;
if (array_key_exists('target', $sso_link)) {
    $target = $sso_link['target'];
} else {
    if ($method['available_window'] == 1) {
        $target = $sso_link['target'];
    }
}

//Get Caption and Image
$caption = null;
$image = null;
if (array_key_exists('caption', $sso_link)) {
    $caption = $sso_link['caption'];
}
if (array_key_exists('image', $sso_link)) {
    $image = $sso_link['image'];
}

//Assign Display Infomation
//Caption Display
$t->assign('caption', $caption);

//Image Display
$t->assign('image', $image);

//SSO Request Method
$t->assign('method', 'get');

//SSO Target URL Display
$t->assign('target_url', $method['driver_settings']['target_url']);

//SSO Parameter Names
$t->assign('param_names', $iframe_param_names);

//SSO Parameter Values
$t->assign('param_values', $iframe_param_values);

//Target URL Display
$t->assign('redirect_url', $redirect_url);

//Available Window Display Infomation
$t->assign('target', $target);

//SSO Method Display
$t->assign('sso_method', $method);

//SSO Link Display
$t->assign('sso_link', $sso_link);

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("grn/sso/sso/request_get.tpl");


