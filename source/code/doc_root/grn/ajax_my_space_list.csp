<?php

use grn\space\utility\SpaceUtility;

use grn\space\common\utility\IconUtility;

use grn\space\common\data\bean\Authority;
use grn\space\common\utility\SpaceDatetimeUtility;
use grn\space\screen\GenericScreenBase;
use grn\space\data\collection\SpaceCollection;
use grn\space\common\data\bean\DatetimeFormat;
use grn\space\data\condition\SpaceSearchCondition;
use grn\space\service\SpaceService;
use grn\space\common\exception\GrnException;
use grn\grn\access\service\AppAccess;
use grn\space\common\utility\SpaceMemberUtility;

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
global $G_state_set;

$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('error_page_type', 'json');

if (($login = $uum->getLoginUser()) === false) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

$login_id = $login->getOID();
if ( ! AppAccess::isAppAvailable('space', $login_id)) {
    return;
}

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();

$list_my_space = [];
$link_more = false;
$link_to_space = '';
$space_active = true;
if ($locator->isActive('space')) {
    require_once("fw/i18n.csp");
    $i18n = \CB_I18N::getInstance();
    $languageCode = $i18n->getCurrentLanguage();
    $timezoneName = $i18n->getCurrentTimezone();

    require_once("fw/i18n/locale.csp");
    $datetimeFormat = new DatetimeFormat();
    $datetimeFormat->setLongDateFormat(\CB_LocaleManager::getCurrentLongDateFormat($login_id));
    $datetimeFormat->setShortDateFormat(\CB_LocaleManager::getCurrentShortDateFormat($login_id));
    $datetimeFormat->setTimeFormat(\CB_LocaleManager::getCurrentTimeFormat($login_id));

    $spaceService = SpaceService::getInstance();

    $spaceSearchCondition = new SpaceSearchCondition();
    $spaceSearchCondition->setSearchParticipantUserId($login_id);
    $spaceSearchCondition->setSearchParticipantGroupIds(SpaceMemberUtility::getLoginUserGroupIds());
    $spaceSearchCondition->setSearchParticipantRoleIds(SpaceMemberUtility::getLoginUserRoleIds());
    $spaceSearchCondition->setOrderSortArray([
        SpaceSearchCondition::SORT_COMPONENT_MODIFY_TIME_DESC,
        SpaceSearchCondition::SORT_ID_DESC
    ]);
    $spaceSearchCondition->setLimit(21);
    $spaceSearchCondition->setLanguageCode($languageCode);
    $spaceSearchCondition->setSearchSpaceExpirationDate(SpaceSearchCondition::SEARCH_SPACE_NOT_EXPIRED);

    //Do not need ACL check because joining space is always accessible.
    $spaceCollection
        = $spaceService->searchSpaceBySearchCondition($spaceSearchCondition,
        $login_id, SpaceService::CATEGORY_NAME_IS_NECESSARY);
    SpaceDatetimeUtility::constructionComponentInspectionDisplayDatetime(
        $spaceCollection, $datetimeFormat,
        SpaceDatetimeUtility::DISPLAY_TYPE_DYNAMIC_IS_NOW_TIME, $languageCode,
        $timezoneName);
    IconUtility::constructionSpaceCollectionIconPath($spaceCollection);
    SpaceUtility::truncateSpaceUsingUserConfig($spaceCollection, $login);

    $array_my_space_list = [];

    $count = ($spaceCollection->count()) > 20 ? 20 : $spaceCollection->count();

    for ($i = 0; $i < $count; $i++) {
        $array_my_space_list[] = $spaceCollection->getBean($i);
    }

    foreach ($array_my_space_list as $my_space_item) {
        $id = $my_space_item->getId();
        $space_name = $my_space_item->getSpaceName();
        $icon_link = $my_space_item->getDisplayIconPath();

        $link = cb_pageurl('space/top', ['spid' => $id]);

        $list_my_space[] = [
            'name'      => $space_name,
            'icon_link' => $icon_link,
            'link'      => $link
        ];
    }
    if ($spaceCollection->count() > 20) {
        $link_to_space = cb_pageurl('space/index');
        $link_more = true;
    }
} else {
    $space_active = false;
}

require_once("grn/smarty.csp");
$smarty = new \GRN_Smarty();

$smarty->assign('space_active', $space_active);
$smarty->assign('list_my_space', $list_my_space);
$smarty->assign('link_more', $link_more);
$smarty->assign('link_to_space', $link_to_space);
$smarty->display('grn/ajax_my_space_list.tpl');

