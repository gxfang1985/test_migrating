<?php
cb_require_role('LoginUser');

global $G_INPUT;
$login = cb_get_login_user();

global $G_state_set;
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('error_page_type', 'json');

require_once('grn/org_tree.csp');

$oid = cb_at($G_INPUT, 'oid');
$page_name = cb_at($G_INPUT, 'page');
if ($page_name != null) {
    $page_name .= '/user';
}
$util = GRN_OrgTreeUtil::getInstance();
$tree = $util->getTree($page_name);
if ( ! $tree->containNode($oid)) {
    $class_name = 'GRN_OrgTree';
    $tree = grn_rebuild_tree_group_user($page_name, $class_name, $oid);
}

$children = [];
if ($tree && is_numeric($oid)) {
    $tree->expandToAndDisplayChild($oid);
    $children = @$tree->_nodes[$oid]['children'];
    if ( ! $children || count($children) == 0) {
        $children = [];

    }
    $util->setTree($page_name, $tree);
}

$children = array_values($children);
require_once("grn/JSONResponse.csp");
$json = \grn\grn\JSONResponse::create();
$json->response([
    'subFolderList' => $children,
    'count'         => count($children)
]);
