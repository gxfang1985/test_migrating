<?php

cb_require_role('LoginUser');

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    if ( ! array_key_exists('page', $G_INPUT) || strlen($G_INPUT['page']) < 1) {
        cb_throw_error(E_GRN_EXPORT_PAGE_NOT_FOUND);
    }

    global $G_container_app;
    $uum =& $G_container_app->getInstance('uum');
    $login =& $uum->getLoginUser();

    $charset = null;

    if ($login) {
        if (array_key_exists('charset', $G_INPUT)) {
            $charset = $G_INPUT['charset'];
        }

        if (is_null($charset)) {
            global $G_config_common;
            $charset = $G_config_common->get('I18N',
                'default_external_encoding');
        }

        if (array_key_exists('save_charset', $G_INPUT)
            && $G_INPUT['save_charset'] == 1
        ) {
            require_once('grn/ui.csp');

            $ucm = GRN_UIConfigManager::getInstance();
            $uc =& $ucm->getUserConfig($login);
            $uc->setExportCharset($charset);
        }
    }

    $page = $G_INPUT['page'];

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession('grn.common.ui');

    if (is_null(($stored_input = $session->get($page)))
        || ! is_array($stored_input)
    ) {
        cb_throw_error(E_GRN_EXPORT_PAGE_NOT_FOUND);
    }

    // 引数に文字コードをセット
    $stored_input['charset'] = $charset;

    /*
    $session->set( $page, null );
    $session->set( $page.'._page', null );
    $session->set( $page.'._position', null );
    */

    $page = str_replace('.', '/', $page);

    // ファイル出力ページへ
    cb_redirect(str_replace('.', '/', $page), $stored_input, null,
        'notitle.txt');
}


