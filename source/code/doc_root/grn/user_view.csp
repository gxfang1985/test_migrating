<?php

cb_require_role('LoginUser');

require_once('grn/smarty.csp');
require_once('fw/date.csp');
$t = new GRN_Smarty;

global $G_state_set;
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('html_should_be_closed', false);

////////////////////////////////////////////////////////////////

// GET/POSTされたパラメータを取得する
$uid = null;
if (array_key_exists('uid', $G_INPUT)) {
    $uid = $G_INPUT['uid'];
}
if (0 == strlen($uid)) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// 詳細を表示するユーザーを取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getUser($uid);
if ( ! is_object($user) || ! is_a($user, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// 組み込み項目を取得する
require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();
$builtin_items = $controller_util->listBuiltinItems($user);

// カスタマイズ項目を取得する
$extended_items = $controller_util->listExtendedItems($user);

// シングルサインオンの設定を取得する
$sso_for_view = ['user' => $uid];

$timestamp = new CB_TimeStampEx();
$datetime = $timestamp->getDateTime();
$datetime->hour = 0;
$datetime->minute = 0;
$datetime->second = 0;
$timestamp->setDateTime($datetime);

$t->assign('unix_timestamp', $timestamp->unix_ts);
$t->assign('user_id', $uid);
$t->assign('builtin_items', $builtin_items);
$t->assign('extended_items', $extended_items);
$t->assign('sso', $sso_for_view);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('common/user_view');
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = ['user_view' => null];
$site_position = $controller_util->makeSitePosition('grn/', $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


