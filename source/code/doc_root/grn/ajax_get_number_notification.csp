<?php

require_once("grn/AjaxHelper.csp");
require_once("notification/application.csp");

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);
    $G_state_set->set('error_page_type', 'json');

// ログインユーザーを取得する
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    if ($login === false) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    global $G_config_common;
    $update_notification_time = $G_config_common->get('Global',
        'update_notification_time');
    if ( ! isset($update_notification_time)) {
        $update_notification_time = 300;
    } else {
        $update_notification_time = 60 * $update_notification_time;
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('notification');
    $data = \grn\AjaxHelper::getNumberOfNotification(
        $login,
        GRN_ApplicationLocator::instance()
                              ->getInstance(GRN_NOTIFICATION_APP_ID),
        GRN_ApplicationLocator::instance()
                              ->getInstance(grn\favour\Application::APPLICATION_ID),
        time(),
        $update_notification_time,
        $session
    );
    $jsonResponse = \grn\grn\JSONResponse::create();
    $jsonResponse->response($data);
}
