<?php
cb_require_role('LoginUser');

global $G_INPUT;

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// パラメタリスト
// $keyword: 検索キーワード
$keyword = '';
// $target_form_name: 書き換えターゲットフォーム名
$target_form_name = '';
// $target_category_select_name: 書き換えカテゴリターゲットセレクトボックス名
$target_category_select_name = '';
// $target_item_select_name: 書き換えアイテムターゲットセレクトボックス名
$target_item_select_name = '';
// $plugin_name: アクセス権評価用プラグインデータ名
$plugin_data_name = '';
// $plugin_session_name: アクセス権評価用プラグインセッション名
$plugin_session_name = '';
// $search_login_name: login名で検索するかどうか
$search_login_name = '1';

$param_names = [
    'keyword',
    'target_form_name',
    'target_category_select_name',
    'target_item_select_name',
    'plugin_data_name',
    'plugin_session_name',
    'search_login_name'
];

$suffix = '';
foreach (array_keys($G_INPUT) as $input_key) {
    if (preg_match('/target_form_name(_.*)/', $input_key, $regs)
        && strlen($G_INPUT[$input_key]) > 0
    ) {
        $suffix = $regs[1];
    }
}
foreach ($param_names as $name) {
    if (array_key_exists($name . $suffix, $G_INPUT)) {
        $$name = $G_INPUT[$name . $suffix];
    }
}

$item_options = [];

// uum
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
//require_once( 'grn/uum_util.csp' );
//$uum_util = GRN_UumUtil::getInstance();
require_once('grn/uum_util_search.csp');
$uum_util = new GRN_UumUtil_Search();

// access_plugin
$plugin = null;
$plugin_param = [];
require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$plugin_session = $sm->getSession($plugin_session_name);
if ($plugin_session) {
    $plugin_data = $plugin_session->get($plugin_data_name);
    if (is_array($plugin_data) && array_key_exists('name', $plugin_data)) {
        $loader = new CB_PluginLoader('grn.common.user.select');
        $plugin = $loader->loadDriver($plugin_data['name']);
    }
    if (is_array($plugin_data) && array_key_exists('params', $plugin_data)) {
        $plugin_param = $plugin_data['params'];
    }
}

require_once('fw/string_util.csp');
require_once("grn/controller.csp");
if (strlen(cb_trim($keyword)) > 0) {
    $users_id = $uum_util->searchUsersId($keyword, $search_login_name);
    if ($plugin) {
        //アクセス権
        $users_id = $plugin->evalUsers($users_id, $plugin_param);
    }

    $login = $uum->getLoginUser();
    $users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
        $login);

    foreach ($users_id as $user_id) {
        $item_options[] = [
            'value' => $user_id,
            'name'  => GRN_ControllerUtil::getUserNameText($login->getOID(),
                $user_id, $users_info)
        ];
    }
}

$t->assign('item_options', $item_options);

$t->assign('target_form_name', $target_form_name);
$t->assign('target_category_select_name', $target_category_select_name);
$t->assign('target_item_select_name', $target_item_select_name);

$t->display('grn/user_add_search_users.tpl');


