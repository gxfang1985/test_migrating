<?php

use grn\grn\access\service\AppAccess;

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
global $G_state_set;
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('error_page_type', 'json');

if (($login = $uum->getLoginUser()) === false) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

require_once("grn/smarty.csp");
$smarty = new \GRN_Smarty();

// UIの共通設定管理ロジックを取得する
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
assert('is_object( $manager ) && is_a( $manager, \'GRN_UIConfigManager\' )');

require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_menus = '';
$menu = $manager->getDefaultApplicationMenu();
$list = $menu->listMenu();
$app_menus = grn_moremodern_app_menu($app_locator, $list);

$smarty->assign('start_com_header', $app_menus);
$smarty->display('grn/ajax_app_menu.tpl');

/**
 * @param GRN_ApplicationLocator $app_locator
 * @param array                  $list_menu
 *
 * @return string
 */
function grn_standard_app_menu($app_locator, array $list_menu)
{
    // アプリケーションパスの取得
    global $G_config_common;
    $app_path = $G_config_common->get('Global', 'app_path');

    $app_menus = '';
    foreach ($list_menu as $key => $item) {
        if (($item['app_id'] == 'report' || $item['app_id'] == 'workflow')
            && ! $app_locator->isLicensed($item['app_id'])
        ) {
            continue;
        }
        $location = $item['location'];
        $name = $item['name'];
        $app_id = $item['app_id'];
        $icon = '';

        if ( ! is_null($app_id)) {
            if ( ! AppAccess::isAppAvailable($app_id)) {
                continue;
            }
            $location = cb_format_url($location);
            $app_config = $app_locator->getConfig($app_id);
            $icon = array_key_exists('icon32', $app_config)
                ? $app_config['icon32'] : null;
            // <!-- GRN2-4480 ココから-->
            // 施設予約のみアプリ本体とアイコンが違うため個別対応
            require_once('schedule/resources.csp');
            if ($app_id == GRN_SCHEDULE_APPLICATION_ID
                && $item['location'] == "schedule/facility_index"
            ) {
                $icon = "facility16";
            }
            // <!-- GRN2-4480 ココまで-->
        } else {
            require_once('grn/controller.csp');
            $location = grn_safe_url($location);
        }

        global $G_config_grn;
        $is_debug = ($G_config_common->get('Global', 'debug')
                     & ERROR_TRACE_LOG_FLAG_213);
        if ( ! $G_config_grn || $is_debug) {
            $build_date = time();
        } else {
            $build_date = $G_config_grn->get('System', 'build_date');
        }
        $build_date .= '.text';

        if ($icon) {
            $icon = str_replace('32', '16', $icon);
        }

        if ( ! is_null($app_id)) {
            $link_img = $app_path . '/grn/image/cybozu/' . $icon . '.png?'
                        . $build_date;
            $img = "<img src=\"" . htmlspecialchars($link_img, ENT_QUOTES)
                   . "\"/>";
        } else {
            if (strlen($icon) > 0) // アイコンがある
            {
                if (strpos($icon, '?') === false) {
                    $link_img = $icon . '?' . $build_date;
                    $img = "<img src=\"" . htmlspecialchars($link_img,
                            ENT_QUOTES) . "\"/>";
                } else {
                    $link_img = $icon . '&' . $build_date;
                    $img = "<img src=\"" . htmlspecialchars($link_img,
                            ENT_QUOTES) . "\"/>";
                }
            } else // アイコンがない
            {
                $link_img = $app_path . "/grn/image/cybozu/defaultmenu16.png?"
                            . $build_date;
                $img = "<img src=\"" . htmlspecialchars($link_img,
                        ENT_QUOTES) . "\"/>";
            }
        }

        $app_menus .= "<li><a href=\"" . htmlspecialchars($location, ENT_QUOTES)
                      . "\">" . $img . htmlspecialchars($name) . "</a></li>";
    }

    return $app_menus;
}

/**
 * @param GRN_ApplicationLocator $app_locator
 * @param array                  $list_menu
 *
 * @return string
 */
function grn_moremodern_app_menu($app_locator, array $list_menu)
{
    $standard_application_icon
        = '<div class="icon-appMenu-%s appmenu-item-icon"></div>';
    $external_application_icon
        = '<img src="%s" alt="%s" class="appmenu-item-icon">';
    $template
        = '<span class="appmenu-item" title="%s" data-short_title="%s"><a href="%s">%s<div><nobr>%s</nobr></div></a></span>';
    $app_menus = [];
    foreach ($list_menu as $key => $item) {
        if (($item['app_id'] == 'report' || $item['app_id'] == 'workflow')
            && ! $app_locator->isLicensed($item['app_id'])
        ) {
            continue;
        }
        $location = $item['location'];
        $application_name = $item['name'];
        $app_id = $item['app_id'];
        $app_menu_icon = sprintf($standard_application_icon, 'defaultmenu');

        if ( ! is_null($app_id)) {
            if ( ! AppAccess::isAppAvailable($app_id)) {
                continue;
            }
            $location = cb_format_url($location);
            $app_menu_icon = $app_id;

            require_once('schedule/resources.csp');
            if ($app_id == GRN_SCHEDULE_APPLICATION_ID
                && $item['location'] == "schedule/facility_index"
            ) {
                $app_menu_icon = 'facility';
            }
            $app_menu_icon = sprintf($standard_application_icon,
                $app_menu_icon);
        } else {
            require_once('grn/controller.csp');
            $location = grn_safe_url($location);
            $has_application_icon = isset($item['icon'])
                                    && strlen($item['icon']) > 0;
            if ($has_application_icon) {
                $app_menu_icon = sprintf($external_application_icon,
                    grn_safe_url($item['icon']),
                    htmlspecialchars($application_name));
            }
        }
        $truncated_application_name = mb_strimwidth($application_name, 0, 28,
            '...');
        $app_menus[] = sprintf($template,
            htmlspecialchars($application_name),
            htmlspecialchars($truncated_application_name), $location,
            $app_menu_icon, htmlspecialchars($truncated_application_name));
    }

    return implode("", $app_menus);
}
