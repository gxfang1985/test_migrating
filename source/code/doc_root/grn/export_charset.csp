<?php

use grn\grn\access\service\AppAccess;

cb_require_role('LoginUser');

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

global $G_INPUT;

if ( ! array_key_exists('page', $G_INPUT) || strlen($G_INPUT['page']) < 1) {
    cb_throw_error(E_GRN_EXPORT_PAGE_NOT_FOUND);
}

$page = $G_INPUT['page'];

$parts = explode('.', strtolower($page));
$t->assign('page_parts', $parts);

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login_user = $uum->getLoginUser();
$login_id = $login_user->getOID();

require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
if ( ! $app_locator->isActive($parts[0])) {
    cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
}

require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession('grn.common.ui');

if (is_null(($input = $session->get($page)))) {
    cb_throw_error(E_GRN_EXPORT_PAGE_NOT_FOUND);
}

if ($parts[1] != 'system') {
    AppAccess::checkAccess($parts[0], $login_id);
}

$position = $session->get($page . '._position');

if (is_array($position)) {
    $position_keys = array_keys($position);
    $last = array_pop($position_keys);
    $position[$last] += $input;
    $position[$last]['page'] = str_replace('.', '/',
        $session->get($page . '._page'));
} else {
    $position = [];
}

require_once('fw/i18n.csp');
$title = cb_msg('grn.common', 'export_charset');
$position[] = ['page' => '', 'name' => $title];

// 呼び出し元の位置にあるものとして振舞う
$parts[count($parts) - 1] = 'export_charset';
cb_set_pagename(implode('/', $parts));


$t->assign('site_position', $position);
$t->assign('page_title', $title);

$t->assign('page', $G_INPUT['page']);

$t->display('grn/export_charset.tpl');


