<?php

cb_require_role('LoginUser');

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// GET/POSTされたパラメータを取得する
$gid = null;
if (array_key_exists('gid', $G_INPUT)) {
    $gid = $G_INPUT['gid'];
}
$return_url = null;
if (array_key_exists('return_url', $G_INPUT)) {
    $return_url = $G_INPUT['return_url'];
}
$tp = null;
if (array_key_exists('tp', $G_INPUT)) {
    $tp = $G_INPUT['tp'];
}
$ppid = null;
if (array_key_exists('ppid', $G_INPUT)) {
    $ppid = $G_INPUT['ppid'];
}

include('org_select.csp');

$t->assign('return_url', $return_url);
$t->assign('tp', $tp);
$t->assign('ppid', $ppid);

//--user list
$user_list = [];
if (is_numeric($org_id) && 0 < $org_id) {
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user_rows = $uum->getGroupUsers($org_id);
    if (is_array($user_rows) && 0 < count($user_rows)) {
        $user_list = [];
        foreach (array_keys($user_rows) as $uid) {
            $user_row =& $user_rows[$uid];
            $user_list[$uid] = $user_row->get('display_name');
        }
    }
    $t->assign('no_group', 1);
}
$t->assign('user_list', $user_list);

$session_name = "grn.popup_group";
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession($session_name);
$user_ids = $session->get('user_ids');

if ( ! is_array($user_ids)) {
    $user_ids = [];
}
if (array_key_exists('add', $G_INPUT)) {
    if (array_key_exists('uid', $G_INPUT)) {
        $uids = $G_INPUT['uid'];
        if (is_array($uids) && count($uid)) {
            foreach ($uids as $uid) {
                $user_ids[$uid] = 1;
            }
        }
    }
} elseif (array_key_exists('remove', $G_INPUT)) {
    if (array_key_exists('rid', $G_INPUT)) {
        $ruids = $G_INPUT['rid'];

        if (is_array($ruids) && count($ruids)) {
            foreach ($ruids as $ruid) {
                unset($user_ids[$ruid]);
            }
        }
    }
} else {
    $user_ids = [];
}
$session->set('user_ids', $user_ids);

$selected_list = [];
foreach (array_keys($user_ids) as $id) {
    $user =& $uum->getUser($id);
    if ( ! $user) {
        continue;
    }
    $selected_list[$id] = [
        'uid'          => $id,
        'display_name' => $user->get('display_name'),
        'foreign_key'  => $user->get('foreign_key'),
    ];
}

$t->assign('selected_list', $selected_list);
// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('common/popup_group');
$t->assign('page_title', $page_title);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


