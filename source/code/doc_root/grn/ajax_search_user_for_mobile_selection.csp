<?php

use grn\grn\MemberLogic;

cb_require_role('LoginUser');

global $G_INPUT;
$login = cb_get_login_user();
$login_id = $login->getOID();

global $G_state_set;
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('error_page_type', 'json');

$accept_params = ['keyword', 'app_id', 'access_plugin', 'sp'];
for ($i = 0; $i < count($accept_params); $i++) {
    $param = $accept_params[$i];
    $$param = isset($G_INPUT[$param]) ? $G_INPUT[$param] : null;
}

require_once('grn/uum_util_search.csp');
$uum_util = new GRN_UumUtil_Search();

// access_plugin
$access_plugin = cb_unserialize(base64_decode($access_plugin),
    ['allowed_classes' => false]);
$plugin = null;
$plugin_param = [];
if (is_array($access_plugin)
    && array_key_exists('name', $access_plugin)
    && array_key_exists('params', $access_plugin)
) {
    $loader = new CB_PluginLoader('grn.common.user.select');
    $plugin = $loader->loadDriver($access_plugin['name']);
    $plugin_param = $access_plugin['params'];
}

$users_id = [];

require_once('fw/string_util.csp');
require_once("grn/controller.csp");
if (strlen(cb_trim($keyword)) > 0) {
    $users_id = $uum_util->searchUsersId($keyword);
    if ($plugin) {
        //アクセス権
        $users_id = $plugin->evalUsers($users_id, $plugin_param);
    }
}
$users_id = array_values($users_id);
$j = 0;
if ( ! is_null(($sp))) {
    $limit = 100;

    $uid_list = [];

    $j = $sp + $limit;
    if ($j > count($users_id)) {
        $j = count($users_id);
    }

    for ($i = $sp; $i < $j; $i++) {
        $uid_list[] = $users_id[$i];
    }
} else {
    $uid_list = $users_id;
}
$totalUsers = count($users_id);
unset($users_id);

if ( ! is_array($uid_list)) {
    $uid_list = [];
}

$users_info = MemberLogic::getInstance()
                         ->getDisplayUsersByUserIds($uid_list, $app_id, true);
$users_info = array_values($users_info);

require_once("grn/JSONResponse.csp");
$json = \grn\grn\JSONResponse::create();
$json->response([
    'list'   => $users_info,
    'offset' => $j,
    'total'  => $totalUsers
]);
