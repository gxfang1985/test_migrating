<?php

cb_require_role('LoginUser');

require_once("grn/smarty.csp");
require_once("grn/upload.csp");
$t = new GRN_Smarty;

global $G_state_set;
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);

if (isset($G_INPUT['upload_ticket']) === false) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_INVALID_TICKET);
}

$upload_ticket = $G_INPUT['upload_ticket'];
$files = GRN_UploadFile::getUploadedAllFiles($upload_ticket);

$file_list_for_view = [];
foreach ($files as $key => $file) {
    $file_for_view = [];
    $file_for_view['name'] = $file->get('name');
    $file_for_view['size'] = _getSizeString($file->get('size'));
    $file_for_view['fileid'] = $file->get('fileid');
    $file_list_for_view[] = $file_for_view;
}

$t->assign('files', $file_list_for_view);
$t->display(cb_get_pagename() . ".tpl");

function _getSizeString($size)
{
    $suffix = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
    $idx = intval((strlen($size) - 1) / 3);
    $ret = number_format(($size / pow(1024, $idx)), 1) . $suffix[$idx];
    $ret = str_replace('.0', '', $ret);

    return $ret;
}
