<?php

use grn\grn\JSONResponse;
use grn\grn\MemberLogic;

cb_require_role('LoginUser');
global $G_INPUT;

$keyword = cb_at($G_INPUT, 'keyword', '');
$app_id = cb_at($G_INPUT, 'app_id');
$plugin_data_name = cb_at($G_INPUT, 'plugin_data_name', '');
$plugin_session_name = cb_at($G_INPUT, 'plugin_session_name', '');
$search_login_name = cb_at($G_INPUT, 'search_login_name', '0');

$members_info = [];

require_once('grn/uum_util_search.csp');
$uum_util = new GRN_UumUtil_Search();

// access_plugin
$plugin = null;
require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$plugin_param = [];
$plugin_session = $sm->getSession($plugin_session_name);
if ($plugin_session) {
    $plugin_data = $plugin_session->get($plugin_data_name);
    if (is_array($plugin_data) && array_key_exists('name', $plugin_data)) {
        $loader = new CB_PluginLoader('grn.common.user.select');
        $plugin = $loader->loadDriver($plugin_data['name']);
        $plugin_param = cb_at($plugin_data, 'params');
    }
}

require_once('fw/string_util.csp');
if (strlen(cb_trim($keyword)) > 0) {
    $users_id = $uum_util->searchUsersId($keyword, $search_login_name);
    if ($plugin) {
        $users_id = $plugin->evalUsers($users_id, $plugin_param);
    }
    $members_info = MemberLogic::getInstance()->getDisplayUsersByUserIds($users_id, $app_id, false, true, true);
}

//Do not check the Application user access right if app_id is 'grn.common'
if ($app_id === 'grn.common') {
    foreach ($members_info as $member_id => $member_info) {
        $members_info[$member_id][MemberLogic::IS_NOT_USING_APP] = false;
    }
}

$members_info = array_values($members_info);
$json = JSONResponse::create();
$json->response(['members_info' => $members_info]);



