<?php

cb_require_role('LoginUser');

global $G_container_base;
/** @var $uum GRN_Uum */
$uum =& $G_container_base->getInstance('uum');

require_once('grn/file.csp');
$file_manager = GRN_FileManager::getInstance();

// GET/POSTされたパラメータを取得する
$uid = @ $G_INPUT['uid'];
if (0 == strlen($uid)) {
    cb_throw_error(E_GRN_USERFILE_INVALID_FILE_ID);
}
$fid = @ $G_INPUT['fid'];
if (0 == strlen($fid)) {
    cb_throw_error(E_GRN_USERFILE_INVALID_FILE_ID);
}

// ユーザーを取得する
$user =& $uum->getUser($uid);
if ( ! is_object($user) || ! is_a($user, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// 組み込み項目にファイルが含まれているか検証する
$item_ids = $uum->listDefaultItemIds();
$not_found = true;
foreach (array_keys($item_ids) as $item_id) {
    $data = $uum->getDefaultItemData($user, $item_id);
    if (array_key_exists('value', $data)) {
        if (is_object($data['value']) && is_a($data['value'], 'GRN_File')) {
            if ($fid == $data['value']->getOID()) {
                $not_found = false;
                break;
            }
        }
    }
}

if ($not_found) {
    // 拡張項目のユーザー情報一覧を取得する
    $datas = $uum->getAllExtensionItemData($user);
    // 拡張項目にファイルが含まれているか検証する
    foreach (array_keys($datas) as $item_id) {
        $data =& $datas[$item_id];
        if (array_key_exists('value', $data)) {
            if (is_object($data['value']) && is_a($data['value'], 'GRN_File')) {
                if ($fid == $data['value']->getOID()) {
                    $not_found = false;
                    break;
                }
            }
        }
    }
}

if ($not_found) {
    // サムネイルがあるか
    $ids = $uum->getUserThumbnailIds($uid);
    if (array_search($fid, $ids) !== false) {
        $not_found = false;
        // サムネイル画像はキャッシュする
        header("Cache-Control: max-age=315360000");
        header("Expires: " . gmdate('D, d M Y H:i:s', time() + 315360000)
               . " GMT");
    }
}

// ファイルを検出したか検証する
if ($not_found) {
    cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
}

// ファイルを取得する
$table_info =& $file_manager->getFileTable();
$file =& $table_info->getRow($fid);
if ( ! is_object($file) || ! is_a($file, 'GRN_File')) {
    cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
}

// ファイルをダウンロードする
$body =& $file->getCurrentBody();
$body->download(true);

cb_safe_exit();


