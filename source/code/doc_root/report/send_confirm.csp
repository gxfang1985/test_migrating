<?php

use grn\grn\access\service\AppAccess;

global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Parameter
$category_id = @ $G_INPUT['cid'];    //Category ID
$form_id = @ $G_INPUT['fid'];    //Form ID
$event_id = @ $G_INPUT['eid'];    //Event ID for schedule relation
$str_date = @ $G_INPUT['date'];
$date = new CB_Date();
if ( ! $date->parse($str_date)) {
    $date = false;
}

//Get Session Key
require_once('report/controller_util.csp');
require_once('grn/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);

// 未分類でないカテゴリのアクセス権をチェック
if (GRN_REPORT_CATEGORY_NONPARTY_ID != $category_id) {
    require_once('report/controller_util.csp');
    $category_util = GRN_Report_Category_Controller_Utility::getInstance();
    $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);
}

//Get Session
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session_send_form = $session_manager->getSession('report/send_form'
                                                  . $tmp_key);
$session_page = $session_manager->getSession("pagename" . $tmp_key);
$session_page->set("pagename", 'send_form');

//Load Send Form Session (for Design)
$form_for_view = $session_send_form->get('form');
$item_list_for_view = $session_send_form->get('item_list');
$properties_for_view = $session_send_form->get('properties');
$members = $session_send_form->get('members');
$notification = $session_send_form->get('notification');
$operators = $session_send_form->get('operators');
$operator_set = $session_send_form->get('operator_set');
$partner_values = $session_send_form->get('partner_values');
$private = $session_send_form->get('private');

//  ---  GRN-2971  ---
if ( ! is_array($form_for_view) || 0 == count($form_for_view)) {
    // フォームがない
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FORM_NOT_FOUND);
}
//  ---  GRN-2971  ---

//Load Send Form Session (for Data)
$send_form_data_list = $session_send_form->get('send_form_data_list');

$columns = ['col_display_name', 'col_foreign_key', 'col_position', 'col_valid'];

require_once('grn/uum.csp');
global $G_container_base;
$grn_uum = $G_container_base->getInstance('uum');

$report_util = GRN_Report_Report_Controller_Utility::getInstance();
foreach ($item_list_for_view as $key => $item) {
    if ($item['type'] == 1) {
        $subject = $report_util->getSubjectView($item);
        if (strlen($subject) > 0) {
            $form_for_view['subject'] = $subject;
        }
    }
}

if ($private) {
    //Add Title Message for Private 
    foreach ($item_list_for_view as $key => $item) {
        if ($item['type'] == 1) {
            $report_util->addPrivateMessage($item_list_for_view[$key]);
        }
    }
}

//Assign Category ID
$t->assign('category_id', $category_id);
//Assign Form ID
$t->assign('form_id', $form_id);

if (is_numeric($event_id) && $event_id > 0) {
    $t->assign('event_id', $event_id);
    $t->assign('str_date', $str_date);
    $t->assign('event_date', $str_date);

    //もしevent_idが存在するならば、アクセス可能かチェックする
    require_once('schedule/application.csp');
    $app = GRN_Schedule_Application::getInstance();
    $event = $app->getEvent($G_report_login_user, $event_id, $date,
        CB_DATABASE_NO_LOCK, false, GRN_SCHEDULE_GET_MEMBER_ID);
    if ($event) {
        require_once('report/controller_util.csp');
        $sched_util
            = GRN_Report_Report_Schedule_Controller_Utility::getInstance();
        $sched_util->checkRelatable($G_report_login_user->getOID(), $event,
            true);

        $t->assign('event', $event);
    } else {
        cb_throw_error(E_GRN_RPRT_CANNOT_ACCESS_SCHEDULE);
    }
}

require_once('report/partner.csp');
$partners = GRN_ReportPartnerData::createByValues($partner_values);

$t->assign('form', $form_for_view);
$t->assign('item_list', $item_list_for_view);
$t->assign('properties', $properties_for_view);
$t->assign('members', $members);
$t->assign('notificationUsers', $notification);
$t->assign('operators', $operators);
$t->assign('operator_set', $operator_set);
$t->assign('partners', $partners);

require_once('report/address_util.csp');
$t->assign('address_available',
    $address_available = GRN_ReportAddressUtil::isAddressAvailable());
$t->assign('address_available_for_external',
    AppAccess::isAppAvailableExternalAccess('address'));

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$site_position = [];
$site_position[0] = [
    'page' => 'report/index',
    'name' => grn_get_page_display_name('report/index'),
    'sf'   => 1
];
if (is_numeric($event_id) && $event_id > 0) {
    $site_position[1] = [
        'page' => 'report/send',
        'name' => grn_get_page_display_name('report/send'),
        'cid'  => $category_id,
        'eid'  => $event_id,
        'date' => $str_date
    ];
    $site_position[2] = [
        'page'    => 'report/send_form',
        'name'    => grn_get_page_display_name('report/send_form'),
        'cid'     => $category_id,
        'fid'     => $form_id,
        'eid'     => $event_id,
        'date'    => $str_date,
        'sf'      => 1,
        'tmp_key' => $tmp_key
    ];
} else {
    $site_position[1] = [
        'page' => 'report/send',
        'name' => grn_get_page_display_name('report/send'),
        'cid'  => $category_id
    ];
    $site_position[2] = [
        'page'    => 'report/send_form',
        'name'    => grn_get_page_display_name('report/send_form'),
        'cid'     => $category_id,
        'fid'     => $form_id,
        'sf'      => 1,
        'tmp_key' => $tmp_key
    ];
}
$site_position[3] = ['page' => '', 'name' => $page_title];

//site position
$t->assign('site_position', $site_position);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


