<?php

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

$report_id = array_key_exists('rid', $G_INPUT) ? $G_INPUT['rid'] : null;
$sort_params = [];
$sort_keys = [
    'member_user',
    'member_unsubscribe',
    'member_operator',
    'member_reverse',
    'notification_user',
    'notification_unsubscribe',
    'notification_operator',
    'notification_reverse'
];
foreach ($sort_keys as $key) {
    if (array_key_exists($key, $G_INPUT)) {
        $sort_params[$key] = $G_INPUT[$key];
    }
}

require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$member_util = GRN_Report_Member_Controller_Utility::getInstance();
$notification_util = GRN_Report_Notification_Controller_Utility::getInstance();

$report_for_view = $report_util->getSimpleView($report_id);
if ( ! $report_for_view || $report_for_view['draft']) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}
$report_util->setCreatorValid($report_for_view);

$user_id = $G_report_login_user->getOID();
$creator_id = isset($report_for_view['creator'])
    ? $report_for_view['creator'] : null;
$members_for_view = $member_util->getDetailView($report_id, $creator_id,
    $sort_params);
$notification_for_view = $notification_util->getDetailView($report_id,
    $creator_id, $sort_params);
$report_title = $report_util->getReportTitle($report_for_view);
$sort_params_for_view = $report_util->getSortParamsView($report_id,
    $sort_params);

$category_id = $report_for_view['category']
    ?: GRN_REPORT_CATEGORY_NONPARTY_ID;
$accessible_category = false;
$category_util = GRN_Report_Category_Controller_Utility::getInstance();
if ($category_id == GRN_REPORT_CATEGORY_NONPARTY_ID
    || $category_util->checkCategoryAccess($category_id, false)
) {
    $accessible_category = true;
}
//Create Members ID List
$members = [];
foreach ($members_for_view as $key => $value) {
    $members[] = $key;
}
//Create Notification Members ID List
$notificationUsers = [];
foreach ($notification_for_view as $key => $value) {
    $notificationUsers[] = $key;
}
$page_name = cb_get_pagename();
$page_parts = explode('/', $page_name);
if ((strcmp('system', $page_parts[1]) != 0
     && strcmp('operation', $page_parts[1]) != 0)
) {
    // View Access Right check
    if ( ! isViewable($G_report_login_user->getOID(), $creator_id, $members,
        $notificationUsers, $report_for_view['private'], $accessible_category)
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_DENY_ACCESS);
    }
}
$t->assign('members', $members_for_view);
$t->assign('notification_users', $notification_for_view);
$t->assign('report_title', $report_title);
$t->assign('report', $report_for_view);
$t->assign('rid', $report_id);
$t->assign('sort_params', $sort_params_for_view);
$t->assign('is_operatable',
    $report_util->isModifiable($user_id, $creator_id, $report_id));
$t->assign('accessible_category', $accessible_category);

//Check Viewable
function isViewable(
    $login_id,
    $creator_id,
    $members,
    $notification_users,
    $is_private,
    $is_accessible_category
) {
    if ($login_id == $creator_id) {
        return true;
    }

    if (in_array($login_id, $members)) {
        return true;
    }

    if (in_array($login_id, $notification_users)) {
        return true;
    }

    if ( ! $is_private && $is_accessible_category) {
        return true;
    }

    return false;
}
