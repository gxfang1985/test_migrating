<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    //Smarty
    require_once('cellular/smarty.csp');
    $smarty = new GRN_Cellular_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($smarty);
    $form_name = 'report/cellular/follow';
    SmartyValidate::register_form($form_name);

    //Parameter
    $report_id = @ $G_INPUT['rid'];
    $type = @ $G_INPUT['type'];
    $follow = @ $G_INPUT['follow'];

    if (SmartyValidate::is_valid($G_INPUT, $form_name)) {
        //Get Report
        require_once('report/controller_util.csp');
        $report_util = GRN_Report_Report_Controller_Utility::getInstance();
        $report = $report_util->getSimpleView($report_id);

        if ( ! $report || $report['draft'] || ! $report['enable_follow']) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
        }

        //Create Follow
        $properties = [];
        $properties[GRN_REPORT_COLUMN_DATA] = $follow;
        require_once('report/follow_logic.csp');
        $follow_logic = GRN_Report_Follow_Logic::getInstance();
        $dummy = null;
        $follow_id =& $follow_logic->add($report_id, $properties, $dummy);

        // the validation session is finished
        SmartyValidate::unregister_form($form_name);

        // redirect
        require_once('cellular/prepend.csp');
        grn_report_cellular_redirect("report/cellular/look",
            ['rid' => $report_id]);
    } else {
        grn_report_cellular_switch_page($G_pagepath . '/follow');
    }
}
