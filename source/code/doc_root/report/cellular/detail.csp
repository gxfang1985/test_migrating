<?php
//Instantiate an Smarty object
require_once("grn/smarty.csp");
$smarty = new GRN_Smarty;

// ページ情報
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// cellular application
if (isset($G_cellular) && $G_cellular) {
    $smarty->assign('valid_cellular', true);

    $user_config =& $G_cellular->getUserConfig($G_login_user);
    $limit = $user_config->getListMax();
    $width = $user_config->getSubjectWidth();
} else {
    $smarty->assign('valid_cellular', false);

    $limit = 10;
    $width = 14;
}

$smarty->assign('width', $width);

// params
$type = null;
if (array_key_exists('type', $G_INPUT) && strlen($G_INPUT['type'])) {
    $type = $G_INPUT['type'];
}
$report_id = null;
if (array_key_exists('rid', $G_INPUT) && strlen($G_INPUT['rid'])) {
    $report_id = $G_INPUT['rid'];
}
$item_id = null;
if (array_key_exists('iid', $G_INPUT) && strlen($G_INPUT['iid'])) {
    $item_id = $G_INPUT['iid'];
}

//Get Utility
require_once('report/controller_util.csp');
$controller_util = new GRN_Report_ControllerUtil(cb_get_pagename());
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$item_data_util = GRN_Report_ItemData_Controller_Utility::getInstance();

$smarty->assign('type', $type);
$smarty->assign('rid', $report_id);

//Create Parameter Translation Map
$translation_map_report = [
    'rid'                 => '_id',
    //Report ID
    'name'                => 'name',
    //Report Name
    'form'                => 'form',
    //Report Form ID
    'form_name'           => 'form_name',
    //Report Form Name
    'creator'             => 'creator',
    //Report Creator
    'creator_name'        => 'creator_name',
    //Report Creator Name
    'creator_foreign_key' => 'creator_foreign_key',
    //Report Creator Foreign Key
    'ctime'               => 'ctime',
    //Report Create Time
];

//Get Report for view
$report = $report_util->getView($report_id, $translation_map_report);

//Create Parameter Translation Map
$translation_map_item_data = [
    //Item Data Information
    'iid'                => 'itemdata_id',
    //Item Data ID
    'display_name'       => 'itemdata_display_name',
    //Item Data Display Name
    'type'               => 'itemdata_type',
    //Item Data Type
    'option_string'      => 'itemdata_option_string',
    //Item Data Option String
    'option_string_type' => 'itemdata_option_string_type',
    //Item Data Option String Type
    'data_type'          => 'itemdata_data_type',
    //Item Data data type
    'required'           => 'itemdata_required',
    //Item Data Reuired Flag
    'list_index'         => 'itemdata_list_index',
    //Item Data List Index
    'text'               => 'itemdata_text',
    //Item Data text Value
];

$item = $item_data_util->getViewEx($item_id, $translation_map_item_data,
    $report_id);
//var_dump($item);

$view_str = "";
if ($item && $item['data_type'] == 'grn.report.string_multiple') {
    if ($item['option_string_type'] == 1) // pre
    {
        $view_str .= $item['option_string'];
        $view_str .= "\n";
    }
    $view_str .= $item['text'];
    if ($item['option_string_type'] == 2) // post
    {
        $view_str .= "\n";
        $view_str .= $item['option_string'];
    }
}
$smarty->assign('view_str', $view_str);
$smarty->assign('item', $item);

//Display Smarty Template
$smarty->display(cb_get_pagename() . '.tpl');

