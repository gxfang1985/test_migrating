<?php

global $G_uum;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$smarty = new GRN_Smarty;

// ページ情報
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// cellular application
if (isset($G_cellular) && $G_cellular) {
    $smarty->assign('valid_cellular', true);
} else {
    $smarty->assign('valid_cellular', false);
}


$user_id = $G_login_user->getOID();

// params
$type = null;
if (array_key_exists('type', $G_INPUT) && strlen($G_INPUT['type'])) {
    $type = $G_INPUT['type'];
}
$report_id = null;
if (array_key_exists('rid', $G_INPUT) && strlen($G_INPUT['rid'])) {
    $report_id = $G_INPUT['rid'];
}

//Get Instance
require_once('report/controller_util.csp');
$controller_util = new GRN_Report_ControllerUtil(cb_get_pagename());
$report_util = GRN_Report_Report_Controller_Utility::getInstance();

$smarty->assign('type', $type);
$smarty->assign('rid', $report_id);

//Create Parameter Translation Map
$translation_map_report = [
    'rid'                  => '_id',
    //Report ID
    'name'                 => 'name',
    //Report Name
    'form'                 => 'form',
    //Report Form ID
    'form_name'            => 'form_name',
    //Report Form Name
    'category'             => 'category',
    //Category ID
    'creator'              => 'creator',
    //Report Creator
    'creator_name'         => 'creator_name',
    //Report Creator Name
    'creator_foreign_key'  => 'creator_foreign_key',
    //Report Creator Foreign Key
    'ctime'                => 'ctime',
    //Report Create Time
    'modifier'             => 'modifier',
    'modifier_name'        => 'modifier_name',
    'modifier_foreign_key' => 'modifier_foreign_key',
    'mtime'                => 'mtime',
    'enable_follow'        => 'enable_follow',
    'enable_member'        => 'enable_member',
    'enable_partner'       => 'enable_partner',
    'draft'                => 'draft',
];

//Get Report for view
$report = $report_util->getView($report_id, $translation_map_report);

//Get Report Member
require_once('report/member_manager.csp');
$member_manager = GRN_Report_Member_Manager::getInstance();
$member =& $member_manager->getList($report_id);
$member_util = GRN_Report_Member_Controller_Utility::getInstance();
$member_for_view = $member_util->getUsersView($member);
$smarty->assign('member_for_view', $member_for_view);

if ( ! $report_util->isViewable($user_id, $report_id)) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_ACCESS_INVALID_ID);
}

//Assign Report
$smarty->assign('report', $report);

//Confirm Member, Update Read Status
require_once('report/report_logic.csp');
$logic = GRN_Report_Report_Logic::getInstance();
$logic->read($user_id, $report_id);

//Display Smarty Template
$smarty->display(cb_get_pagename() . '.tpl');

