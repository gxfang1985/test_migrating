<?php
//Smarty
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

//Page Information
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// cellular application
if (isset($G_cellular) && $G_cellular) {
    $smarty->assign('valid_cellular', true);

    $user_config =& $G_cellular->getUserConfig($G_login_user);
    $width = $user_config->getSubjectWidth();
} else {
    $smarty->assign('valid_cellular', false);

    $width = 14;
}

//Parameter
$follow_id = @ $G_INPUT['follow_id'];
$report_id = @ $G_INPUT['rid'];
$type = @ $G_INPUT['type'];
if ( ! $report_id) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}
if ( ! $follow_id) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
}

//Get Report
require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getSimpleView($report_id);
if ( ! $report) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}

//Create Parameter Translation Map for Follow
$translation_map_follow = [
    'id'                  => '_id',
    'creator'             => 'creator',
    'creator_foreign_key' => 'creator_foreign_key',
    'creator_name'        => 'creator_name',
    'ctime'               => 'ctime',
    'data'                => 'data',
    'follow_id'           => 'follow_id',
    'html'                => 'html',
    'report'              => 'report',
];

//Get Follow
require_once('report/controller_util.csp');
$follow_util = GRN_Report_Follow_Controller_Utility::getInstance();
$follow = $follow_util->getView($follow_id, $translation_map_follow);
if ( ! $follow) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
}

$user_id = $G_login_user->getOID();
$creator_id = isset($follow['creator']) ? $follow['creator'] : null;
//Check Delete Right
if (is_null($creator_id) || $creator_id != $user_id) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_REMOVABLE);
}

$smarty->assign('rid', $report_id);
$smarty->assign('follow_id', $follow_id);
$smarty->assign('type', $type);
$smarty->assign('follow', $follow);
$smarty->assign('width', $width);

$smarty->display(cb_get_pagename() . '.tpl');
