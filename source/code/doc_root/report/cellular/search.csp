<?php
//Instantiate an Smarty object
require_once("grn/smarty.csp");
$smarty = new GRN_Smarty;

// ページ情報
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// cellular application
if (isset($G_cellular) && $G_cellular) {
    $smarty->assign('valid_cellular', true);

    $user_config =& $G_cellular->getUserConfig($G_login_user);
    $limit = $user_config->getListMax();
    $width = $user_config->getSubjectWidth();
} else {
    $smarty->assign('valid_cellular', false);

    $limit = 10;
    $width = 14;
}

$smarty->assign('width', $width);

// params
$type = null;
if (array_key_exists('type', $G_INPUT) && strlen($G_INPUT['type'])) {
    $type = $G_INPUT['type'];
}
$text = @ $G_INPUT['text'];

//Set Default Type
switch ($type) {
    case GRN_REPORT_SEARCH_TARGET_RECEIVED:
    case GRN_REPORT_SEARCH_TARGET_SEND:
    case GRN_REPORT_SEARCH_TARGET_ALL:
        break;
    default:
        $type = GRN_REPORT_SEARCH_TARGET_RECEIVED;
        break;
}

$smarty->assign('type', $type);

//Get Utility
require_once('report/controller_util.csp');
$controller_util = new GRN_Report_ControllerUtil(cb_get_pagename());
$report_util = GRN_Report_Report_Controller_Utility::getInstance();

//----------------------
// report list
//----------------------
//Create Parameter Translation for Report
$translation_map_report = [
    'id'           => '_id',              //Report ID
    'report_name'  => 'name',             //Report Name
    'form_name'    => 'form_name',        //Report Form Name
    'creator'      => 'creator',          //Report Creator
    'creator_name' => 'creator_name',     //Report Creator Name
    'ctime'        => 'ctime',            //Report Create Time
];

$lists = [];
if (strlen($text)) {
    $smarty->assign('text', $text);

    //Create Criteria
    require_once('report/search_logic.csp');
    $criteria = new GRN_Report_Search_Criteria($G_login_user);
    $criteria->target = $type;
    $criteria->and_or = GRN_REPORT_FILTER_OR;

    //Set Filter
    if (array_key_exists('fid', $G_INPUT) && is_numeric($G_INPUT['fid'])) {
        require_once('report/filter_logic.csp');
        $fid = $G_INPUT['fid'];
        $filter_logic = GRN_Report_Filter_Logic::getInstance();
        $filter = $filter_logic->get($fid);

        if ($filter && $filter["conditions"]) {
            foreach ($filter["conditions"] as $condition) {
                $value = is_null($condition['col_text'])
                    ? $condition['col_number'] : $condition['col_text'];
                $criteria->addCondition($condition['col_type'], $value,
                    $condition['col_condition']);
            }
        }
    }

    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_FORM_NAME, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_REPORT_NAME, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_ITEMDATA, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_CREATOR, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_FOLLOW, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);

    doSearch($criteria, $limit, $smarty);
}

//Target List
require_once('report/controller_util.csp');
$filter_util = GRN_Report_Filter_Controller_Utility::getInstance();
$target_list = $filter_util->getSearchTargetList(@$criteria->target, true);
$smarty->assign('target_list', $target_list);

//Display Smarty Template
$smarty->display(cb_get_pagename() . '.tpl');

function doSearch($criteria, $limit, & $smarty)
{
    global $G_container_base;
    global $G_INPUT;

    $uum = $G_container_base->getInstance('uum');
    $login_user = $uum->getLoginUser();

    //検索にマッチする全件数の取得
    $total_count = GRN_Report_Search_Logic::getCount($criteria);


    //Get Login User Config
    $manager = GRN_UIConfigManager::getInstance();
    $config =& $manager->getUserConfig($login_user);

    //ナビゲーション
    require_once('report/utility.csp');
    $params = [
        'type' => @$G_INPUT['type'],
        'text' => @$G_INPUT['text'],
        'fid'  => @$G_INPUT['fid']
    ];
    $n_navigation_for_view = grn_make_n_navigation($total_count,
        $params, $limit);
    $n_navigation_for_view['limit'] = $limit;

    //ページングに関する条件を追加
    $criteria->index = $n_navigation_for_view['offset'];
    $criteria->count = $n_navigation_for_view['limit'];

    $reports = GRN_Report_Search_Logic::search($criteria);

    foreach ($reports as $rid => $report) {
        $ctime = $report['col_ctime'];
        $ctime_for_view = new CB_TimeStamp();
        $ctime_for_view->unix_ts = $ctime;
        $mtime = $report['col_mtime'];
        $mtime_for_view = new CB_TimeStamp();
        $mtime_for_view->unix_ts = $mtime;
        $reports[$rid]['ctime'] = $ctime_for_view;
        $reports[$rid]['mtime'] = $mtime_for_view;
    }

    $smarty->assign('reports', $reports);
    //Assign View Set
    $smarty->assign('navi', $n_navigation_for_view['navi']);
}

