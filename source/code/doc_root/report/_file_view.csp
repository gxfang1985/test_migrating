<?php
//Get Parameters
require_once('report/resources.csp');
$file_id = @ $G_INPUT['fid'];       //File ID
$report_id = @ $G_INPUT['rid'];       //Report ID
$item_data_id = @ $G_INPUT['iid'];       //Item Data ID
$category_id = @ $G_INPUT['cid'];       //Category ID
$follow_id = @ $G_INPUT['follow_id']; //Follow ID


global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();
$user_id = $login->getOID();

require_once('report/controller_util.csp');

//Get Report and Item Data File Controller Utility
$utility = new GRN_Report_ControllerUtil();
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$item_data_util = GRN_Report_ItemData_Controller_Utility::getInstance();
$item_data_file_util
    = GRN_Report_ItemDataFile_Controller_Utility::getInstance();

//Get Report
$report = $report_util->getSimpleView($report_id);
$category_id = $report['category'];
$form_id = $report['form'];

$t->assign('fid', $file_id);
$t->assign('cid', $category_id);
$t->assign('rid', $report_id);
$t->assign('follow_id', $follow_id);
$t->assign('iid', $item_data_id);
$t->assign('form_id', $form_id);

if ( ! $category_id) {
    $category_id = GRN_REPORT_CATEGORY_NONPARTY_ID;
}

//Get GRN_File Object
require_once('report/file.csp');
$file_manager = new GRN_Report_FileManager_Core();
$file_table =& $file_manager->getFileTable();
$file =& $file_table->getRow($file_id);
if ( ! $file) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
}

//Include Common Controller
$common_view_page = '../grn/_file_view.csp';
if (isset($system_page) || isset($operation_page)) {
    $common_view_page = '../../grn/_file_view.csp';
}
require($common_view_page);

//Get Login User Config
global $G_portal_login_user;
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$config =& $manager->getUserConfig($G_report_login_user);

$rowset =& $file->getLogSet();
$total_count = $rowset->count();
$rowset->destroy();

//N-Navigation
require_once('report/utility.csp');
$params = [
    'fid'       => $file_id,
    'rid'       => @$report_id,
    'follow_id' => @$follow_id,
    'iid'       => @$item_data_id
];
$n_navigation_for_view = grn_make_n_navigation($total_count, $params,
    $config->getListMax());

//Modify File Information
$file_for_view =& $t->get_Template_Vars('file');
$logs_for_view =& $t->get_Template_Vars('logs');
$file_for_view['id'] = $file_id;
$file_for_view['logs'] = $logs_for_view;
$file_for_view['navi'] = $n_navigation_for_view;

if ($file_for_view['creator_uid'] == $user_id) {
    $file_for_view['modifiable'] = true;
    $file_for_view['deletable'] = true;
}

//Create Link Parameter
$linkparams = [
    'fid' => $file_id,
    'rid' => $report_id,
];
if (isset($follow_id)) {
    $linkparams['follow_id'] = $follow_id;
}
if (isset($item_data_id)) {
    $linkparams['iid'] = $item_data_id;
}
if (isset($category_id)) {
    $linkparams['cid'] = $category_id;
}
if (isset($form_id)) {
    $linkparams['frm'] = $form_id;
}

//Assign Link Patameters
$t->assign('linkparams', $linkparams);

//Lock
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$config =& $manager->getSystemConfig();
$t->assign('lockable', $config->getFileLockable());

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$controller_util = new GRN_Report_ControllerUtil();

if (isset($system_page)) {
    $file_for_view['modifiable'] = true;
    $file_for_view['deletable'] = true;

    $pages_info = [
        'system/report_list' => [
            'cid' => $report['category'],
            'fid' => $report['form'],
            'sf'  => 1
        ],
        'system/report_view' => [
            'cid' => $report['category'],
            'fid' => $report['form'],
            'rid' => @$report_id
        ],
        'system/file_view'   => null,
    ];

} elseif (isset($operation_page)) {
    //Check Nonparty Category
    $category_util = GRN_Report_Category_Controller_Utility::getInstance();
    if (GRN_REPORT_CATEGORY_NONPARTY_ID == $category_id) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_MANAGE_DENY_NONPARTY_CATEGORY);
    }

    //Check Category Manage and Access Right
    $category_util->checkManage($category_id, true, CB_DATABASE_NO_LOCK);
    $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);

    $file_for_view['modifiable'] = true;
    $file_for_view['deletable'] = true;

    $pages_info = [
        'index'                 => ['sf' => 1],
        'operation/report_list' => [
            'cid' => $report['category'],
            'fid' => $report['form'],
            'sf'  => 1
        ],
        'operation/report_view' => [
            'cid' => $report['category'],
            'fid' => $report['form'],
            'rid' => @$report_id
        ],
        'operation/file_view'   => null,
    ];
} else {
    // View Access Right
    $user_id = $G_report_login_user->getOID();
    require_once('report/controller_util.csp');
    $report_util = GRN_Report_Report_Controller_Utility::getInstance();

    $report_file_manager = GRN_Report_FileManager::getInstance();

    if ( ! $report_util->isViewable($user_id,
        $report_file_manager->getReport($file_id))
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_DENY_ACCESS);
    }

    $page_view = 'view';
    if (1 == $report['draft']) {
        $page_view = 'view_draft';
    }

    if (is_null($category_id) || strlen($category_id) <= 0) {
        $pages_info = [
            'index'     => ['sf' => 1],
            $page_view  => ['rid' => $report_id],
            'file_view' => null
        ];
    } else {
        $pages_info = [
            'index'     => ['sf' => 1],
            $page_view  => ['rid' => $report_id],
            'file_view' => null
        ];
    }
}

$site_position = $controller_util->makeSitePosition('report/', $pages_info);
$t->assign('site_position', $site_position);


