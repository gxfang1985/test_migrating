<?php

assert('isset($file_upload_page)');
assert('isset($file_view_page)');

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // 引数をチェック
    // インクルード元で変数がセットされていればそれを優先

    if ( ! isset($category_id)) {
        $category_id = @ $G_INPUT['cid'];
    }
    if ( ! isset($form_id)) {
        $form_id = @ $G_INPUT['frm'];
    }
    if ( ! isset($report_id)) {
        if ( ! isset($G_INPUT['rid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
        }
        $report_id = $G_INPUT['rid'];
    }
    if ( ! isset($follow_id)) {
        $follow_id = @ $G_INPUT['follow_id'];
    }
    if ( ! isset($file_id)) {
        if ( ! isset($G_INPUT['fid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
        }
        $file_id = $G_INPUT['fid'];
    }


    // リダイレクト引数をセット

    $redirect_params = [];

    if ($category_id) {
        $redirect_params['cid'] = $category_id;
    }
    if ($form_id) {
        $redirect_params['frm'] = $form_id;
    }

    $redirect_params['rid'] = $report_id;

    if ($follow_id) {
        $redirect_params['follow_id'] = $follow_id;
    }

    $redirect_params['fid'] = $file_id;

    if (array_key_exists('upload', $G_INPUT)) {
        cb_redirect($file_upload_page, $redirect_params);
    }

    // アップロードをキャンセル
    if ($file_view_page == 'report/file_view') {
        require_once('report/controller_util.csp');
        $report_util = GRN_Report_Report_Controller_Utility::getInstance();
        $report = $report_util->getSimpleView($report_id);
        $user_id = $G_report_login_user->getOID();

        $creator_id = isset($report['creator']) ? $report['creator'] : null;
        if ($user_id != $creator_id) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_REPORT_DENY_MODIFY);
        }
    }

    //Get File Object
    require_once('report/file.csp');
    $file_manager = GRN_Report_FileManager::getInstance();
    $file =& $file_manager->getFile($file_id);

    $lock =& $file->getLockObject();
    $lock->releaseLock();

    $redirect_params['sf'] = 1;

    cb_redirect($file_view_page, $redirect_params);
}
