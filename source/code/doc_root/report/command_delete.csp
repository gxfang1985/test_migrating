<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    $report_id = null;
    if (array_key_exists('rid', $G_INPUT)) {
        $report_id = $G_INPUT['rid'];
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $user_id = $login->getOID();

    //Check Delete Right
    require_once('report/controller_util.csp');
    $report_util = GRN_Report_Report_Controller_Utility::getInstance();
    $report = $report_util->getSimpleView($report_id);
    $creator_id = isset($report['creator']) ? $report['creator'] : null;
    if ( ! $report_util->isDeletable($user_id, $creator_id, $report_id)) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_DENY_DELETE);
    }

    //Remove Notification
    require_once('report/notification.csp');
    $notification_logic = GRN_Report_Notification_Listener::getInstance();
    $notification_logic->removeAll($report_id);

    require_once('report/notification_manager.csp');
    $notification_manager = GRN_Report_Notification_Manager::getInstance();
    $notificationUsers =& $notification_manager->getList($report_id);
    //Remove Report
    require_once('report/report_logic.csp');
    $report_logic = GRN_Report_Report_Logic::getInstance();
    $report_logic->delete($report_id);
    //Inspection
    require_once('report/inspection.csp');
    $inspection = GRN_Report_Report_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        if ($report['draft']) {
            $message_type = 'report_draft_delete';
        } else {
            $message_type = 'report_delete';
        }

        $message_args['rid'] = $report_id;

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }

    //Redirect Index Page
    cb_redirect('report/index', ['sf' => 1]);
}


