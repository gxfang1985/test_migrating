<?php

global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Parameter
$report_id = @ $G_INPUT['rid']; //Report ID
if (strlen($report_id) == 0) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_DRAFT_NOT_FOUND);
}

//Get Session Key
require_once('grn/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);

//Check Draft
require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getSimpleView($report_id);
if ( ! $report['draft']) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_DRAFT_NOT_FOUND);
}

//Get Session
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session_send_form =& $session_manager->getSession('report/modify_draft'
                                                   . $tmp_key);
$session_page = &$session_manager->getSession("pagename" . $tmp_key);
$session_page->set("pagename", 'modify_draft');

//Load Send Form Session (for Design)
$form_for_view = $session_send_form->get('form');
$report = $session_send_form->get('report');
$item_list_for_view = $session_send_form->get('item_list');
$properties_for_view = $session_send_form->get('properties');
$members = $session_send_form->get('members');
$notification = $session_send_form->get('notification');
$operators = $session_send_form->get('operators');
$operator_set = $session_send_form->get('operator_set');
$partner_values = $session_send_form->get('partner_values');
$private = $session_send_form->get('private');

//Load Send Form Session (for Data)
$send_form_data_list = $session_send_form->get('send_form_data_list');

//Check Category Access Right
$category_id = $form_for_view['category'];
if (strlen($category_id) == 0) {
    $category_id = GRN_REPORT_CATEGORY_NONPARTY_ID;
}
if (GRN_REPORT_CATEGORY_NONPARTY_ID != $category_id) {
    require_once('report/controller_util.csp');
    $category_util = GRN_Report_Category_Controller_Utility::getInstance();
    $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);
}

foreach ($item_list_for_view as $key => $item) {
    if ($item['type'] == 1) {
        $subject = $report_util->getSubjectView($item);
        if (strlen($subject) > 0) {
            $form_for_view['subject'] = $subject;
        }
    }
}

if ($private) {
    //Add Title Message for Private 
    foreach ($item_list_for_view as $key => $item) {
        if ($item['type'] == 1) {
            $report_util->addPrivateMessage($item_list_for_view[$key]);
        }
    }
}

//スケジュールとの関連を調べる
require_once('report/report_schedule_logic.csp');
$report_schedule_logic = GRN_Report_Report_Schedule_Logic::getInstance();
$event_info = $report_schedule_logic->getRelatedEventId($report_id);
if (is_numeric($event_info['event_id']) && $event_info['event_id'] > 0) {
    $t->assign('event_id', $event_info['event_id']);

    $date = new CB_Date();
    if ( ! $date->parse($event_info['date'])) {
        $date = false;
    }

    //もしevent_idが存在するならば、アクセス可能かチェックする
    require_once('schedule/application.csp');
    $app = GRN_Schedule_Application::getInstance();
    $event = &$app->getEvent($G_report_login_user, $event_info['event_id'],
        $date, CB_DATABASE_NO_LOCK, false, GRN_SCHEDULE_GET_MEMBER_ID);
    if ($event) {
        $t->assign('event', $event);
    }
    $t->assign('event_date', $event_info['date']);
}

require_once('report/partner.csp');
$partners = GRN_ReportPartnerData::createByValues($partner_values);

//Assign
$t->assign('form', $form_for_view);
$t->assign('report', $report);
$t->assign('report_id', $report_id);
$t->assign('item_list', $item_list_for_view);
$t->assign('properties', $properties_for_view);
$t->assign('members', $members);
$t->assign('notificationUsers', $notification);
$t->assign('operators', $operators);
$t->assign('operator_set', $operator_set);
$t->assign('partners', $partners);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$t->assign('site_position', [
        [
            'page' => 'report/index',
            'name' => grn_get_page_display_name('report/index'),
            'sf'   => 1
        ],
        [
            'page' => 'report/view_draft',
            'name' => grn_get_page_display_name('report/view_draft'),
            'rid'  => $report_id
        ],
        [
            'page'    => 'report/modify_draft',
            'name'    => grn_get_page_display_name('report/modify_draft'),
            'rid'     => $report_id,
            'tmp_key' => $tmp_key,
            'sf'      => 1
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


