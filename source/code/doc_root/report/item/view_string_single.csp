<?php

/**
 * Description for Settings Parameters for Single String Item
 *
 * size                   ->      text area size
 * max_input_size         ->      max input charactor size
 * input_chars            ->      input charactor type(0:none/1:hankaku/2:zenkaku)
 * initial_type           ->      initial value type(0:text/1:user)
 * initial_text_value     ->      initial text value
 * initial_user_value     ->      initial user value
 **/

global $G_INPUT;

// instantiate an Smarty object
require_once("grn/smarty.csp");
//$t = $smarty;

//Get Item from Template Variable
$item_for_view = $t->get_template_vars('item');

//Check Table Name
if ($item_for_view['table'] == GRN_REPORT_TABLE_ITEM
    || $item_for_view['table'] == GRN_REPORT_TABLE_ITEMDATA
) {
    if ( ! array_key_exists('text', $item_for_view)) {
        //Get Initial Value From Settings
        if ($item_for_view['settings']['initial_type'] == 0) {
            //Get Text Value From Settings
            $item_for_view['text']
                = $item_for_view['settings']['initial_text_value'];
        } else {
            //User Information
            require_once('grn/sso.csp');
            global $G_report_login_user;
            $id_list = ['user' => $G_report_login_user->getOID()];
            $sso_service = GRN_SSO_Service::getInstance();
            $identifier_list = $sso_service->getIdentifierValueList('uum',
                $id_list);
            global $G_container_base;
            $uum =& $G_container_base->getInstance('uum');
            $prefix = '%grn.common.uum.user.';
            if (array_key_exists($item_for_view['settings']['initial_user_value'],
                $identifier_list)
            ) {
                if (strpos($item_for_view['settings']['initial_user_value'],
                        $prefix) === 0
                ) {
                    $identifier_items = explode('.',
                        $item_for_view['settings']['initial_user_value']);
                    switch ($identifier_items[4]) {
                        case 'extension':
                            //Extention Item
                            $item_id = str_replace('%', '',
                                $identifier_items[5]);
                            $item_property = &$uum->getItemByKey($item_id);
                            $use = $item_property->get('use');
                            if ($use) {
                                $item_for_view['text']
                                    = $identifier_list[$item_for_view['settings']['initial_user_value']];
                            }
                            break;
                        case 'userinfo':
                            //Extention Item
                            $item_id = str_replace('%', '',
                                $identifier_items[5]);
                            $item_property
                                = &$uum->getDefaultItemProperty($item_id);
                            if (array_key_exists('use', $item_property)) {
                                if ($item_property['use']) {
                                    $item_for_view['text']
                                        = $identifier_list[$item_for_view['settings']['initial_user_value']];
                                }
                            }
                            break;
                        default:
                            //Default Item
                            $item_id = str_replace('%', '',
                                $identifier_items[4]);
                            if (strcmp($item_id, 'id') === 0) {
                                $item_for_view['text']
                                    = $identifier_list[$item_for_view['settings']['initial_user_value']];
                            } else {
                                $item_property
                                    = &$uum->getDefaultItemProperty($item_id);
                                if (array_key_exists('use', $item_property)) {
                                    if ($item_property['use']) {
                                        $item_for_view['text']
                                            = $identifier_list[$item_for_view['settings']['initial_user_value']];
                                    }
                                }
                            }
                            break;
                    }
                }
            }
        }
    }
}

//Create Display Name
if ($item_for_view['type'] == 1) {
    $item_for_view['display_name'] = cb_plain_msg(GRN_REPORT_MODULE_ID,
        'form_subject');
}

//Assign Display Information
// Assign Item ID
$t->assign('item_id', $item_for_view['iid']);

// Display
$t->assign('display', $display);

// Assign Item
$t->assign('item', $item_for_view);
// Assign Settings
$t->assign('settings', $item_for_view['settings']);

//-- set page title and site position

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("report/item/view_string_single.tpl");


