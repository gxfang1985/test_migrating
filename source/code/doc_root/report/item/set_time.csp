<?php

global $G_INPUT;

//Get Smarty Instance
//require_once( "grn/smarty.csp" );
//$t = $smarty;

//SmartyValidate should be initialized when an input form is there.
require_once('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form('report/item/set_time', true);

//Get Item
$item_for_view = $t->get_template_vars('item');
if (is_null($item_for_view)) {
    $item_for_view = [];
    $item_for_view['fid'] = $form_id;
    $item_for_view['data_type'] = $selected_data_type;
    $item_for_view['display_name'] = '';
    $item_for_view['option_string'] = '';
    $item_for_view['option_string_type'] = 0;
    $item_for_view['description'] = '';
    $item_for_view['description_type'] = 0;
    $item_for_view['description_editor'] = 0;
    $item_for_view['required'] = 0;

    $item_for_view['settings'] = [];
    $item_for_view['settings']['initial_type']
        = GRN_REPORT_ITEM_TIME_INITIAL_VALUE_NOW_TIME;
    $item_for_view['settings']['initial_hour'] = '';
    $item_for_view['settings']['initial_minute'] = '';
}

//Create Reverse br
$item_for_view['reverse_br'] = ($item_for_view['br'] == 1) ? 0 : 1;

//Get Item Utility List
require_once('report/item_resources.csp');
$item_util_list =& grn_report_get_item_util_list();

//Create Item Options
$item_options = [];
foreach (array_keys($item_util_list) as $data_type) {
    $item_options[$data_type] = [
        'value' => $data_type,
        'label' => cb_plain_msg(GRN_REPORT_MODULE_ID, $data_type),
    ];
    if ($data_type == $selected_data_type) {
        $item_options[$data_type]['selected'] = true;
    }
}

//Create RichEditor Information
$richeditor_for_view = [];
$richeditor_for_view['rows'] = 5;
$richeditor_for_view['cols'] = 40;

// Check HTML or Text Description
if ($item_for_view['description_editor'] == 1) {
    $item_for_view['description_text'] = null;
    $item_for_view['description_html'] = $item_for_view['description'];
} else {
    $item_for_view['description_text'] = $item_for_view['description'];
    $item_for_view['description_html'] = null;
}

//Check and Initialize Settings
if ($item_for_view['data_type'] !== $selected_data_type) {
    $item_for_view['settings']['initial_type']
        = GRN_REPORT_ITEM_TIME_INITIAL_VALUE_NOW_TIME;
    $item_for_view['settings']['initial_hour'] = '';
    $item_for_view['settings']['initial_minute'] = '';
}

//Create Option String Type Options
$option_string_type_options = [];
$option_string_type_options[0]
    = [
    'value' => '0',
    'label' => cb_msg(GRN_REPORT_MODULE_ID, 'option_string_type_0_sample')
];
$option_string_type_options[1]
    = [
    'value' => '1',
    'label' => cb_msg(GRN_REPORT_MODULE_ID, 'option_string_type_1_sample')
];
$option_string_type_options[2]
    = [
    'value' => '2',
    'label' => cb_msg(GRN_REPORT_MODULE_ID, 'option_string_type_2_sample')
];
$option_string_type_options[$item_for_view['option_string_type']]['selected']
    = true;

$initial_time = new CB_Time();
if ($item_for_view['settings']['initial_hour']) {
    $item_for_view['text']['hour'] = $item_for_view['settings']['initial_hour'];
    $initial_time->hour = $item_for_view['settings']['initial_hour'];
}
if ($item_for_view['settings']['initial_minute']) {
    $item_for_view['text']['minute']
        = $item_for_view['settings']['initial_minute'];
    $initial_time->minute = $item_for_view['settings']['initial_minute'];
}

// Assign View Infomation
$t->assign('item_id', $item_id);
$t->assign('display', $display);
$t->assign('item', $item_for_view);
$t->assign('settings', $item_for_view['settings']);
$t->assign('item_options', $item_options);
$t->assign('richeditor', $richeditor_for_view);
$t->assign('option_string_type_options', $option_string_type_options);
$t->assign('selected_data_type', $selected_data_type);
$t->assign('initial_time', $initial_time);

//-- set page title and site position

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("report/item/set_time.tpl");


