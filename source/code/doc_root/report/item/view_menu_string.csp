<?php

/**
 * Description for Settings Parameters for Numeric Item
 *
 * input_numbers          ->      input number check flag(0:no check/1:check by max and min value)
 * max_input_number       ->      max input number for input_numbers check
 * min_input_number       ->      min input number for input_numbers check
 * initial_value          ->      initial value
 * effective_figures      ->      efective figures for input number
 * minus_type             ->      display type for minus(0:-/1:▼/2:▽)
 * right_align            ->      display input number right align
 * split_rank             ->      display input number split rank(10000 -> 10,000)
 **/

global $G_INPUT;

// instantiate an Smarty object
require_once("grn/smarty.csp");
//$t = $smarty;

//Get Item from Template Variable
$item_for_view = $t->get_template_vars('item');

//Check Table Name
if ($item_for_view['table'] == GRN_REPORT_TABLE_ITEM) {
    if ( ! array_key_exists('text', $item_for_view)) {
        //Get Initial Value From Settings
        $item_for_view['text'] = $item_for_view['settings']['initial_value']
                                 == '' ? null
            : $item_for_view['settings']['initial_value'];
    }
}

//Split Menu Items
$first_item = ['' => cb_plain_msg(GRN_REPORT_MODULE_ID, '(please_select)')];

$menu_item_type = null;
if (array_key_exists('menu_item_type', $item_for_view['settings'])) {
    $menu_item_type = $item_for_view['settings']['menu_item_type'];
}

if ($menu_item_type == 1) {
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');

    $uid = $G_INPUT['uid'];
    $login = null;
    $login_id = null;
    if ( ! is_null($uid) && strlen($uid) > 0) {
        $login =& $uum->getUser($uid);
        $login_id = $uid;
    } else {
        $login =& $uum->getLoginUser();
        $login_id = $login->getOID();
    }

    $dynamic_roles = $uum->listGrantedRoles();
    $group_list = [];

    $primary_group = $uum->getUserPrimaryGroupInfo($login_id);
    // 優先する組織
    if ($primary_group !== false) {
        $options_group_id = $primary_group['_id'];
        $options_group_name = $primary_group['col_name'];
        //$group_list[$options_group_id]    = cb_plain_msg( 'grn.common', 'title_primary_group', array( 'name'=>$options_group_name ) );
        $group_list[$options_group_id] = $options_group_name;
    }

    $group_list = $group_list + $first_item;

    // 所属する組織
    $groups = $uum->getUserGroupsInfo($login_id);
    foreach (array_keys($groups) as $options_group_id) {
        $options_group_name = $groups[$options_group_id]['col_name'];
        if (array_key_exists($options_group_id, $group_list)) {
            continue;
        }

        //$group_list[$options_group_id] = cb_plain_msg( 'grn.common', 'title_belonging_group', array( 'name'=>$options_group_name ) );
        $group_list[$options_group_id] = $options_group_name;
    }
    //$menu_items = array_merge($first_item, $group_list);
    $menu_items = $group_list;
} else {
    $menu_items = mb_split("\r\n", $item_for_view['settings']['menu_items']);
    $menu_items = array_merge($first_item, $menu_items);
    foreach (array_keys($menu_items) as $key) {
        $menu_items[$key] = cb_trim($menu_items[$key]);
        if (strlen($menu_items[$key]) == 0) {
            unset($menu_items[$key]);
        }
    }
}

$item_for_view['settings']['menu_items'] = $menu_items;

//Create Menu Options
$menu_options = [];
foreach (array_keys($menu_items) as $key) {
    if ($key === '') {
        $menu_options[$key] = [
            'value' => $key,
            'label' => $menu_items[$key],
        ];
    } else {
        $menu_options[$key] = [
            'value' => $menu_items[$key],
            'label' => $menu_items[$key],
        ];
    }
    if ($item_for_view['text'] == $menu_items[$key]) {
        $menu_options[$key]['selected'] = true;
    }
}

if ( ! is_null($item_for_view['text']) && strlen($item_for_view['text']) < 1) {
    $menu_options[""]['selected'] = true;
}

//Assign Display Information
// Assign Item ID
$t->assign('item_id', $item_for_view['iid']);

// Display
$t->assign('display', $display);

// Assign Item
$t->assign('item', $item_for_view);
// Assign Settings
$t->assign('settings', $item_for_view['settings']);

// Assign Menu Options
$t->assign('menu_options', $menu_options);

//-- set page title and site position

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("report/item/view_menu_string.tpl");


