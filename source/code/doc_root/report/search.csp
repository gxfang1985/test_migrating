<?php
//Instantiate an Smarty object
require_once("grn/smarty.csp");
require_once('report/controller_util.csp');
require_once('report/search_logic.csp');
require_once('report/utility.csp');
require_once('grn/ui.csp');

$t = new GRN_Smarty;
$util = GRN_Report_Filter_Controller_Utility::getInstance();
global $G_INPUT;
global $G_report_login_user;

$text = @$G_INPUT['search_text'];
$criteria = new GRN_Report_Search_Criteria($G_report_login_user);
$criteria->target = getSearchType();
$criteria->and_or = GRN_REPORT_FILTER_OR;

require_once('report/controller_util.csp');
$form_util = new GRN_Report_Form_Controller_Utility();
$item_util = new GRN_Report_Item_Controller_Utility();

$item_map = [
    'id'           => '_id',
    'display_name' => 'display_name',
    'form'         => 'form',
    'type'         => 'type',
    'data_type'    => 'data_type'
];

$form_map = ['name' => 'name', 'category' => 'category'];

if ($fid = getFilterID()) {
    //絞込みIDが指定されている場合、絞込みの条件をcriteriaに注入する
    if (is_numeric($fid)) {
        require_once('report/filter_logic.csp');
        $filter_logic = GRN_Report_Filter_Logic::getInstance();
        $filter = $filter_logic->get($fid);
        $filter_util = GRN_Report_Filter_Controller_Utility::getInstance();

        if ($filter && $filter["conditions"]) {
            //絞込みが存在する場合は全報告書が検索対象
            $criteria->target = GRN_REPORT_SEARCH_TARGET_ALL;

            //Get relational form
            if ($filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_SELECT) {
                $r_form_id = $filter['form_relation']['col_form'];
                $relation_form = $form_util->getView($r_form_id, $form_map);
                if (is_null($relation_form['category'])) {
                    $category_name = cb_msg('grn.report', 'nonparty');
                    $form_name = $relation_form['name'] . " "
                                 . $category_name;
                    $t->assign('report_form_name', $form_name);
                } else {
                    $category_util
                        = new GRN_Report_Category_Controller_Utility();
                    $category_map = ['name' => 'name'];
                    $category
                        = $category_util->getView($relation_form['category'],
                        $category_map, GRN_REPORT_ACCESS_TYPE_SYSTEM);
                    $category_name = $category['name'];
                    $form_name = $relation_form['name'] . " ("
                                 . $category_name . ")";
                    $t->assign('report_form_name', $form_name);
                }
                $t->assign('relation_form', $relation_form);
                $item_list = $item_util->getListView($item_map, $r_form_id);
                $t->assign('relation_form_item_list', $item_list);
            }
            $t->assign('select_form_check', $filter['col_formtype'] > 0);
            $t->assign('select_form_type1_checked',
                $filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_NAME);
            $t->assign('select_form_type2_checked',
                $filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_SELECT);
            $t->assign('filter', $filter);

            $conditions = $filter["conditions"];
            foreach (array_keys($conditions) as $cid) {
                $filter_util->setConditionView($conditions[$cid]);
            }
            $t->assign('conditions', $conditions);
        }
    }
}

//テキスト検索から飛んできた場合
if (strlen(@$G_INPUT['search_text']) > 0) {
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_ITEMDATA, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_CREATOR, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    $criteria->addCondition(GRN_REPORT_FILTER_TYPE_FOLLOW, $text,
        GRN_REPORT_FILTER_CONDITION_INCLUDE);
    //  new dBug($criteria->conditions);die;
    $inputs = [];
    for ($i = 0; $i < count($criteria->conditions); $i++) {
        $c = $criteria->conditions[$i];
        $inputs[$i]['type'] = $c['type'];
        $inputs[$i]['condition'] = $c['condition'];
        $inputs[$i]['cOption'] = $util->getSelectableCondition($c['type']);
        $inputs[$i]['id'] = $i;

        if ($c['type'] == GRN_REPORT_FILTER_TYPE_CREATE_DATE) {
            $d = getdate($c['value']);
            $date = new CB_Date();
            $date->year = $d['year'];
            $date->month = $d['mon'];
            $date->day = $d['mday'];
            $inputs[$i]['date'] = $date;
        }

        if ($c['type'] == GRN_REPORT_FILTER_TYPE_ITEMDATA_DETAIL) {
            $inputs[$i]['type'] = GRN_REPORT_FILTER_TYPE_ITEMDATA;

            $item = $item_util->getView($c['item_id'],
                $item_map);
            $inputs[$i]['item_type'] = $item['data_type'];
            $inputs[$i]['item_id'] = $c['item_id'];
            $inputs[$i]['item_name'] = $item['display_name'];
            $inputs[$i]['cOption']
                = $util->getSelectableConditionByItemDataType($item['data_type']);

            if (strcmp($item['data_type'], GRN_REPORT_CONDITION_ITEM_DATE)
                == 0
            ) {
                $d = getdate($c['value']);
                $date = new CB_Date();
                $date->year = $d['year'];
                $date->month = $d['mon'];
                $date->day = $d['mday'];
                $inputs[$i]['date'] = $date;
            }
        }

        $inputs[$i]['value'] = $c['value'];
    }

    $t->assign('inputs', $inputs);

    $t->assign('autoSearch', true);
} //初回表示
else {
    $manager = GRN_UIConfigManager::getInstance();
    $config = $manager->getUserConfig($G_report_login_user);
    $n_navigation_for_view = grn_make_n_navigation(0, null,
        $config->getListMax());
    //Assign View Set
    $t->assign('navi', $n_navigation_for_view);
}

//Target List
$targetList = $util->getSearchTargetList(@$criteria->target);
$t->assign('targetList', $targetList);

//AND/OR Info
$and_or_info = $util->getFilterTypeList(@$criteria->and_or);
$t->assign('and_or_info', $and_or_info);

//Type Info
$type_info = $util->getConditionTypeList();
$t->assign('type_info', $type_info);

//Condition Info
$condition_info = $util->getTextTypeCondition();
$t->assign('condition_info', $condition_info);

//Setting for category tree
$tree_selected_oid = GRN_REPORT_CATEGORY_ROOT_ID;
$force_tree_initialize = true;
include('_category_tree.csp');

//Page Title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [
        [
            'page' => 'report/index',
            'name' => grn_get_page_display_name('report/index'),
            'sf'   => 1
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

function getFilterID()
{
    if (is_numeric(@$G_INPUT['fid'])) {
        return $G_INPUT['fid'];
    } else {
        $session_manager = CB_SessionManager::getInstance();
        $session = $session_manager->getSession('report/index');
        $fid = $session->get('fid');
        if (is_numeric($fid)) {
            return $fid;
        } else {
            return false;
        }
    }
}

function getSearchType()
{
    global $G_INPUT;

    //パラメータで指定されている場合はパラメータを優先
    //パラメータが無ければセッションから取得
    if (array_key_exists('type', $G_INPUT)) {
        $type = $G_INPUT['type'];
        if ($type == GRN_REPORT_SEARCH_TARGET_SEND) {
            return GRN_REPORT_SEARCH_TARGET_SEND;
        } elseif ($type == GRN_REPORT_SEARCH_TARGET_DRAFT) {
            return GRN_REPORT_SEARCH_TARGET_DRAFT;
        } elseif ($type == GRN_REPORT_SEARCH_TARGET_ALL) {
            return GRN_REPORT_SEARCH_TARGET_ALL;
        } else {
            return GRN_REPORT_SEARCH_TARGET_RECEIVED;
        }
    } else {
        $session_manager = CB_SessionManager::getInstance();
        $session = $session_manager->getSession('report/index');
        $type = $session->get('type');

        if ( ! is_null($type) && $type != 'filter') {
            return $type;
        } else {
            //絞り込みIDが指定されている場合は全報告書を対象にし、
            //そうでない場合は受信一覧を対象にする
            if (getFilterID()) {
                return GRN_REPORT_SEARCH_TARGET_ALL;
            } else {
                return GRN_REPORT_SEARCH_TARGET_RECEIVED;
            }
        }
    }
}
