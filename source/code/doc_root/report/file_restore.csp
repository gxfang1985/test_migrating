<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


if ( ! isset($G_INPUT['rid'])) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}
if ( ! isset($G_INPUT['fid'])) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
}
if ( ! isset($G_INPUT['ver'])) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_LOG_NOT_FOUND);
}

$category_id = @ $G_INPUT['cid'];
$report_id = $G_INPUT['rid'];
$follow_id = @ $G_INPUT['follow_id'];
$file_id = $G_INPUT['fid'];
$restore_version = $G_INPUT['ver'];

require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getSimpleView($report_id);
if ( ! $report) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}

$page_view = 'report/view';
if (1 == $report['draft']) {
    $page_view = 'report/view_draft';
}

$pathinfo = [
    "report/index"     => [
        'cid' => $category_id,
        'sf'  => 1
    ],
    $page_view         => [
        'cid' => $category_id,
        'rid' => $report_id
    ],
    "report/file_view" => [
        'cid'       => $category_id,
        'rid'       => $report_id,
        'follow_id' => $follow_id,
        'fid'       => $file_id
    ],
];

require_once('report/controller_util.csp');
$utility = new GRN_Report_ControllerUtil();

$utility->setSitePosition($t, $pathinfo);

require_once('report/file.csp');
$file_manager = new GRN_Report_FileManager();
$file =& $file_manager->getFile($file_id);
$check_creator = true;
require_once('_file_restore.csp');

$t->display(cb_get_pagename() . ".tpl");

