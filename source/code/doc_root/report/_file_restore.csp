<?php

global $G_INPUT;

if ( ! isset($file) || ! $file) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
}

if ( ! isset($G_INPUT['ver'])) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_LOG_NOT_FOUND);
}

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
}
if ( ! isset($check_creator)) {
    $check_creator = false;
}

// 引数をチェック
// インクルード元で変数がセットされていればそれを優先

if ( ! isset($category_id)) {
    $category_id = @ $G_INPUT['cid'];
}
if ( ! isset($report_id)) {
    $report_id = @ $G_INPUT['rid'];
}
if ( ! isset($follow_id)) {
    $follow_id = @ $G_INPUT['follow_id'];
}
if ( ! isset($form_id)) {
    $form_id = @ $G_INPUT['frm'];
}

$file_id = $file->getOID();
$restore_version = $G_INPUT['ver'];

// 権限チェック
require_once('report/file.csp');
$file_manager = GRN_Report_FileManager::getInstance();
if ( ! $file || ($check_creator && ! $file->isCreator($G_report_login_user))) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
}

// ファイルリンク用のパラメータをセット 
$linkparams = [];

if ($category_id) {
    $linkparams['cid'] = $category_id;
    $t->assign('category_id', $category_id);
}
if ($report_id) {
    $linkparams['rid'] = $report_id;
    $t->assign('report_id', $report_id);
}
if ($follow_id) {
    $linkparams['follow_id'] = $follow_id;
    $t->assign('follow_id', $follow_id);
}
if ($form_id) {
    $linkparams['frm'] = $form_id;
    $t->assign('form_id', $form_id);
}

$t->assign('linkparams', $linkparams);


if ( ! isset($utility) || ! is_a($utility, 'GRN_ControllerUtil')) {
    require_once('grn/controller.csp');
    $utility = new GRN_ControllerUtil();
}

$restore_for_view = $utility->getFileRestoreView($file, $restore_version);
$t->assign('restore', $restore_for_view);


