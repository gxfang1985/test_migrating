<?php
global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Set Application Name
global $G_report_app_name;
$t->assign('app_name', $G_report_app_name);

//Get Parameters
require_once('report/resources.csp');
$category_id = @ $G_INPUT['cid'];         //Category ID
$category_id = $category_id ? $category_id : GRN_REPORT_CATEGORY_ROOT_ID;

//Get Category and Form and Report Controller Utility
require_once('report/controller_util.csp');
$category_util = GRN_Report_Category_Controller_Utility::getInstance();
$filter_util = GRN_Report_Filter_Controller_Utility::getInstance();


//Create Parameter Translation Map for Category
$translation_map_category = [
    //Category Information
    'cid'         => '_id',             //Category ID
    'name'        => 'name',            //Category Name
    'foreign_key' => 'foreign_key',     //Category Foreign key
    'memo'        => 'memo',            //Category Memo
    'parent'      => 'parent',          //Category Parent
    'list_index'  => 'list_index',      //Category List Index
    'count'       => 'count',           //Children Category Count
];

//Get Current Category for View
$category_for_view = $category_util->getView($category_id,
    $translation_map_category, GRN_REPORT_ACCESS_TYPE_SYSTEM);

//Get Child Category List for View
$category_for_view['children'] = $category_util->getChildListView($category_id,
    $translation_map_category, GRN_REPORT_ACCESS_TYPE_SYSTEM);

//Get Tree Category List for View
if ($category_id != GRN_REPORT_CATEGORY_ROOT_ID) {
    $category_for_view['ancestors']
        = $category_util->getTreeListView($category_id,
        $translation_map_category, GRN_REPORT_ACCESS_TYPE_SYSTEM, true, false);
}


//Get Login User Config
global $G_portal_login_user;
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$config = $manager->getUserConfig($G_report_login_user);

$option = [];

//Get Report Total Count
require_once('report/filter_logic_base.csp');
$filter_logic_base = GRN_Report_Filter_Logic_Base::getInstance();
$filter_count = $filter_logic_base->getSystemFilterCount($category_id);

//N-Navigation
require_once('report/utility.csp');
$params = ['cid' => $category_id];
$n_navigation_for_view = grn_make_n_navigation($filter_count, $params,
    $config->getListMax());


//Create List Option
$option['list'] = [];
$option['list']['offset'] = $n_navigation_for_view['offset'];
$option['list']['limit'] = $n_navigation_for_view['limit'];

//Create Parameter Translation for Form
$translation_map_filter = [
    'fid'          => '_id',          //Filter ID
    'name'         => 'name',         //Filter Name
    'cid'          => 'category',     //Category ID
    'creator'      => 'creator',
    'creator_name' => 'creator_name',
    'ctime'        => 'ctime',
    'active'       => 'active',
];

//Get Filter List for View
$filter_list_for_view = $filter_util->getSystemListView($translation_map_filter,
    $category_id, $option);

//Assign Display Information
//Assign Category ID
$t->assign('category_id', $category_id);

//Assign Category
$t->assign('category', $category_for_view);

//Assign Filter List
$t->assign('filters', $filter_list_for_view);

//Assign View Set
$t->assign('navi', $n_navigation_for_view);

$t->assign('enableOrderChange', $filter_count > 1);

//Page Title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");
