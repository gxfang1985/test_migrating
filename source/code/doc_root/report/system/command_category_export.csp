<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // Get Parameters
    $charset = @ $G_INPUT['charset'];
    $item_name = @ $G_INPUT['item_name'];

    // Get Default Charactor Set
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    // Create Tmporary File
    $tempdir = cb_tmpdir();
    $temp_filename = tempnam($tempdir, 'rprt_');

    // Get CSV Writer
    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    // Write Item Name
    if ($item_name) {
        require_once('report/category_logic.csp');
        $category_logic = GRN_Report_Category_Logic::getInstance();
        $category_logic->export_item_name($csv);
    }

    //Write Category Information
    require_once('report/category_logic.csp');
    $category_logic = GRN_Report_Category_Logic::getInstance();

    $root_category_id = GRN_REPORT_CATEGORY_ROOT_ID;
    $category_logic->export($csv, $root_category_id);

    require_once('report/inspection.csp');
    $inspection = GRN_Report_Category_Inspection::getInstance();
    // 監査する
    if ($inspection->isEnabled()) {
        $message_type = 'category_export';
        //Record Inspection
        $inspection->record($message_type, []);
    }

    // Close CSV Writer
    $csv->close();

    // DownLoad CSV File
    cb_prepare_download('report_category.csv', 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    $fsize = filesize($temp_filename);
    if ($fsize > 0) {
        echo fread($fp, $fsize);
    }
    fclose($fp);

    // Remove Temporary File
    unlink($temp_filename);
}

