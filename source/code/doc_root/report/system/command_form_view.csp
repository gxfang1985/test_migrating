<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Get Commond Type
    $commond = @ $G_INPUT['cmd'];

    //Create Parameter Translation Map
    $translation_map = [
        'ids' => '_ids',
        'cid' => '_cid',
        'fid' => '_fid',
    ];

    //Do Parameter Translation
    $properties = [];
    foreach ($translation_map as $view_name => $model_name) {
        $properties[$model_name] = @ $G_INPUT[$view_name];
    }

    require_once('report/item_logic.csp');
    $item_logic = GRN_Report_Item_Logic::getInstance();
    $item_logic->checkIsIncludeStandardItem($properties['_fid'],
        $properties['_ids']);

    //Check Commond
    if ($commond == 'copy') {
        //Check Form Exist
        require_once('report/form_logic_base.csp');
        $column_list = ['_id'];
        $option = [
            'condition' => [
                0 => [
                    'column'   => 'col_deleted',
                    'value'    => '0',
                    'operator' => '='
                ]
            ]
        ];
        $form_logic_base = GRN_Report_Form_Logic_Base::getInstance();
        $form = $form_logic_base->getDirect($properties['_fid'],
            $column_list, $option);

        //Create Copy Item List
        $item_id_list = [];
        $item_list =& $item_logic->getList($properties['_fid']);
        foreach ($properties['_ids'] as $item_id) {
            if (in_array($item_id, array_keys($item_list))) {
                $item_id_list[] = $item_id;
            }
        }

        //Copy Multi Item
        $id_map = $item_logic->copyMulti($item_id_list, $properties['_fid'],
            null, true);

        //Inspection
        require_once('report/inspection.csp');
        $inspection = GRN_Report_Form_Layout_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            $message_type = 'form_layout_copy';

            $message_args['fid'] = $properties['_fid'];
            $message_args['iids'] = $item_id_list;
            //Record Inspection
            $inspection->record($message_type, $message_args);
        }

        //Redirect Next Page
        cb_redirect('report/system/form_view',
            ['cid' => $G_INPUT['cid'], 'fid' => $G_INPUT['fid']]);
    } elseif ($commond == 'delete') {
        //Get Patameters
        $category_id = @ $G_INPUT['cid'];
        $form_id = @ $G_INPUT['fid'];
        $ids = @ $G_INPUT['ids'];

        //Save IDs to Session
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session
            =& $session_manager->getSession('report/system/form_view');
        $session->set('ids', $ids);

        //Redirect Next Page
        cb_redirect('report/system/formlayout_delete_multi',
            ['cid' => $category_id, 'fid' => $form_id]);
    }
}


