<?php

use grn\grn\ThumbnailUtil;

global $G_INPUT;

//Get Parameters
$file_id = @ $G_INPUT['fid'];
$thumbnail = @ $G_INPUT['thumbnail'];
$thumbnail_xsize = @ $G_INPUT['thumbnail_xsize'];
$thumbnail_ysize = @ $G_INPUT['thumbnail_ysize'];

//Get GRN_File Object
require_once('report/file.csp');
$file_manager = GRN_Report_FileManager::getInstance();
$file_object =& $file_manager->getFile($file_id);
if ( ! $file_object) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
}

//Download Current File or Version File
if (cb_at($G_INPUT, 'ver')) {
    $body_object = $file_object->getBody($G_INPUT['ver']);
} else {
    $body_object = $file_object->getCurrentBody();
}

//Set Defaullt X / Y Size, if No Setting
$thumbnail_xsize = ( ! $thumbnail_xsize) ? GRN_REPORT_THUMBNAIL_WIDTH
    : $thumbnail_xsize;
$thumbnail_ysize = ( ! $thumbnail_ysize) ? GRN_REPORT_THUMBNAIL_HEIGHT
    : $thumbnail_ysize;
if ($thumbnail == 1) {
    $mime_type = $body_object->get('mime');    //Get MIME Type
    $util = new ThumbnailUtil();
    cb_prepare_download($body_object->get('name'), $mime_type, true);
    $result
        = $util->makeThumbnailByImageData($body_object->getContents(),
        (int)$thumbnail_xsize, (int)$thumbnail_ysize);
    if ($result === false) {
        $body_object->download(true);
    }
} else {
    $body_object->download(true);
}

cb_safe_exit();

