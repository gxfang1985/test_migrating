<?php
global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Parameter
$category_id = cb_at($G_INPUT, 'cid');   //Category ID
$form_id = cb_at($G_INPUT, 'fid');   //Form ID

// Category ID
$t->assign('cid', $category_id);
// Form ID
$t->assign('fid', $form_id);

require_once('report/controller_util.csp');
$form_util = GRN_Report_Form_Controller_Utility::getInstance();
$form_for_view = $form_util->getSimpleView($form_id);

$item_util = GRN_Report_Item_Controller_Utility::getInstance();
$item_list_for_view = $item_util->getSimpleListView($form_id);

foreach ($item_list_for_view as $key => $item) {
    if ($item['data_type'] == 'grn.report.blank') {
        unset($item_list_for_view[$key]);
    }
}

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$t->assign('form', $form_for_view);
$t->assign('item_list', $item_list_for_view);

if (cb_at($G_INPUT, 'tmp_key')) {
    $tmp_key = cb_at($G_INPUT, 'tmp_key');
    $t->assign('tmp_key', cb_at($G_INPUT, 'tmp_key'));
    //site position
    $t->assign('site_position', [
            [
                'page' => 'report/system/report_list',
                'name' => grn_get_page_display_name('report/system/report_list'),
                'cid'  => $category_id,
                'fid'  => $form_id
            ],
            [
                'page' => 'report/system/report_search',
                'name' => grn_get_page_display_name('report/system/report_search'),
                'cid'  => $category_id,
                'fid'  => $form_id
            ],
            ['page' => '', 'name' => $page_title]
        ]
    );
    $t->assign('last_page', 'report/system/report_search');
} else {
    //site position
    $t->assign('site_position', [
            [
                'page' => 'report/system/report_list',
                'name' => grn_get_page_display_name('report/system/report_list'),
                'cid'  => $category_id,
                'fid'  => $form_id,
                'sf'   => 1
            ],
            ['page' => '', 'name' => $page_title]
        ]
    );
    $t->assign('last_page', 'report/system/report_list');

}

$item_first_id = null;
foreach ($item_list_for_view as $item) {
    $item_first_id = $item['iid'];
    $t->assign('item_first', $item);
    break;
}

//item index
$item_index = [
    $item_first_id,
    "creator",
    "ctime",
    "enable_member",
    "enable_partner"
];
foreach ($item_list_for_view as $item) {
    if ($item['iid'] != $item_first_id) {
        $item_index[] = $item['iid'];
    }
}
$item_index[] = "enable_follow";
$item_index = join(':', $item_index);
$t->assign('item_index', $item_index);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


