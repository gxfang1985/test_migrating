<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // Get Parameters
    $charset = @ $G_INPUT['charset'];

    // Get Default Charactor Set
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    // 項目名の書き出し
    $isExportHeader = true;
    if (array_key_exists('item_name', $G_INPUT)) {
        $isExportHeader = ($G_INPUT['item_name'] == 1) ? true : false;
    }

    //出力対象言語
    $exportLanguageCodeArray = [];
    if (array_key_exists('all', $G_INPUT)) {
        $exportLanguageCodeArray = null;
    } else {
        $i18n = CB_I18N::getInstance();
        $availableLanguageArray = $i18n->getAvailableLanguages();
        foreach ($availableLanguageArray as $languageCode) {
            if (array_key_exists($languageCode, $G_INPUT)) {
                $exportLanguageCodeArray[] = $languageCode;
            }
        }

        if (count($exportLanguageCodeArray) <= 0) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_INVALID_NOT_SELECTED_LANGUAGE);
        }
    }

    require_once('report/category_logic.csp');
    $category_logic = GRN_Report_Category_Logic::getInstance();
    $tempFilename = $category_logic->createCategoryNameCSV($charset,
        $isExportHeader, $exportLanguageCodeArray);

    // DownLoad CSV File
    cb_prepare_download('report_category_name.csv', 'application/csv', false);
    $fp = fopen($tempFilename, 'rb');
    $fsize = filesize($tempFilename);
    if ($fsize > 0) {
        echo fread($fp, $fsize);
    }
    fclose($fp);

    // Remove Temporary File
    unlink($tempFilename);
}

