<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'report/system/form_modify';
    SmartyValidate::register_form($target_name);

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        //Get Parameters
        $form_id = @$G_INPUT['fid'];

        require_once('report/controller_util.csp');
        $form_util = GRN_Report_Form_Controller_Utility::getInstance();
        $form_for_view = $form_util->getSimpleView($form_id);
        $category_id = $form_for_view['category'];
        if (is_null($category_id)) {
            $category_id = GRN_REPORT_CATEGORY_NONPARTY_ID;
        }

        $form_util->checkCategory($category_id);

        include('../_command_form_modify.csp');

        //Validation Session Finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('report/system/form_view',
            [
                'cid' => $category_id,
                'fid' => $form_id
            ]);
    } else {
        // 動的に追加したバリデーションを解除
        SmartyValidate::unregister_form($target_name);
        SmartyValidate::register_form($target_name);

        //Include Sharing Codes With Command_*
        include('_form_modify.csp');

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}


