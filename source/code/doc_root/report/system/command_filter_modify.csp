<?php
require_once('report/filter_logic.csp');
require_once('report/controller_util.csp');
require_once('report/inspection.csp');
require_once('report/resources.csp');

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    require_once('grn/multi_select_utility.csp');
    $G_INPUT = grn_deploy_selected_users('selected_users_sUID', 'sUID',
        $G_INPUT);

    //頻度更新
    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $input_keys = array_keys($G_INPUT);
    foreach ($input_keys as $input_key) {
        if (preg_match('#^selected_users_.*$#', $input_key)) {
            $input_value = $G_INPUT[$input_key];
            $input_values = explode(':', $input_value[0]);
            if ($input_value[0] && is_array($input_values)) {
                $uum_util->selectUsers($G_report_login_user, $input_values);
            }
        }
    }

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'report/system/filter_modify';
    SmartyValidate::register_form($target_name);

    $util = GRN_Report_Filter_Controller_Utility::getInstance();

    $input = [];

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)
        & $util->validate($input)
    ) {
        include('../_command_filter_modify.csp');

        $params = [];
        $params['fid'] = $fid;
        if (is_null($filter['col_category'])) {
            $params['cid'] = GRN_REPORT_CATEGORY_NONPARTY_ID;
        } else {
            $params['cid'] = $filter['col_category'];
        }
        cb_redirect('report/system/filter_view', $params);
    } else {
        // 動的に追加したバリデーションを解除
        SmartyValidate::unregister_form($target_name);
        SmartyValidate::register_form($target_name);

        //Include Sharing Code Get Category for view
        $user_type = GRN_REPORT_ACCESS_TYPE_SYSTEM;
        include('_category.csp');

        include('_filter_modify.csp');

        //Assign Post Parameters
        $t->assign('conditions', $input);

        //selected user
        if (array_key_exists('sUID', $G_INPUT)) {
            $userIds = $G_INPUT['sUID'];
            global $G_container_base;
            $uum =& $G_container_base->getInstance('uum');

            $initialize_users_for_view = [];

            foreach ($userIds as $user_id) {
                $user_name = '';
                $user =& $uum->getUser($user_id);
                if ($user !== false) {
                    $user_name = $user->get('display_name');
                }
                $initialize_users_for_view[$user_id] = $user_name;
            }
            $t->assign('selected_users', $initialize_users_for_view);
        }

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}

