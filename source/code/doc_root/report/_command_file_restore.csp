<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! isset($report_id)) {
        if ( ! isset($G_INPUT['rid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
        }
        $report_id = $G_INPUT['rid'];
    }
    if ( ! isset($follow_id)) {
        $follow_id = @ $G_INPUT['follow_id'];
    }
    if ( ! isset($file_id)) {
        if ( ! isset($G_INPUT['fid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
        }
        $file_id = $G_INPUT['fid'];
    }

    if ( ! isset($check_creator)) {
        $check_creator = false;
    }

    //Get Report
    require_once('report/controller_util.csp');
    $report_util = GRN_Report_Report_Controller_Utility::getInstance();
    $report = $report_util->getSimpleView($report_id);
    if ( ! $report) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
    }

    $category_id = $report['category'];
    $form_id = $report['form'];

    //Get File
    require_once('report/file.csp');
    $file_manager = GRN_Report_FileManager::getInstance();
    $file =& $file_manager->getFile($file_id);
    if ( ! $file
         || ($check_creator
             && ! $file->isCreator($G_report_login_user))
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_report_app_name]);
    }

    $file->restore($G_report_login_user, $G_INPUT['ver'], $G_INPUT['comment']);
    $lock =& $file->getLockObject();
    $lock->releaseLock();

    $params = [];

    $params['rid'] = $report_id;

    if ($follow_id) {
        $params['follow_id'] = $follow_id;
    }

    $params['fid'] = $file_id;
    $params['cid'] = $category_id;
    $params['frm'] = $form_id;

    cb_redirect($file_view_page, $params);
}
