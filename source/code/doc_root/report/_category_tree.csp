<?php

require_once('grn/org_tree.csp');
require_once('report/category_tree.csp');

if ( ! isset($tree_name)) {
    $tree_name = cb_get_pagename();
}
if ( ! isset($category_util)) {
    $category_util = GRN_Report_Category_Controller_Utility::getInstance();
}
if ( ! isset($force_tree_initialize)) {
    $force_tree_initialize = false;
}

$page_parts = explode('/', cb_get_pagename());
$is_system = (@$page_parts[1] === 'system');

$util = GRN_OrgTreeUtil::getInstance();
$tree =& $util->getTree($tree_name, 'GRN_Report_CategoryTree',
    ['system' => $is_system]);

$tree_for_view = [];

if (is_null($tree_selected_oid)) {
    $tree_selected_oid = $tree->getSelectedNode();
}
if ($force_tree_initialize || array_key_exists('top', $G_INPUT)
    || is_null($tree->getRoot())
) {
    $tree->initialize();
    if ($is_system
        || $category_util->checkAccess(GRN_REPORT_CATEGORY_ROOT_ID, false)
    ) {
        $tree_selected_oid = null;
    } else {
        $tree_selected_oid = GRN_REPORT_CATEGORY_NONPARTY_ID;
    }
}

$tree->setSelectedNode($tree_selected_oid);

require_once('report/category_logic.csp');
require_once('report/resources.csp');
$category_logic = GRN_Report_Category_Logic::getInstance();
$cid = $tree_selected_oid;
if ( ! $cid) {
    if ($is_system
        || $category_util->checkAccess(GRN_REPORT_CATEGORY_ROOT_ID, false)
    ) {
        $cid = GRN_REPORT_CATEGORY_ROOT_ID;
    } else {
        $cid = GRN_REPORT_CATEGORY_NONPARTY_ID;
    }
}

$parent_categories = [];

while ($parent_category = $category_logic->getParent($cid)) {
    $cid = $parent_category['_id'];
    if ($cid != 1) {
        array_push($parent_categories, $cid);
    }
}

while ($cid = array_pop($parent_categories)) {
    $tree->buildChild($cid);
}

$util->setTree($tree_name, $tree);

$tree_for_view = [
    'page_name'    => $tree_name,
    'root'         => $tree->getRoot(),
    'async_url'    => $is_system ? 'report/system/category_json'
        : 'report/category_json',
    'link_url'     => $tree_name,
    'selected_oid' => $tree_selected_oid,
    'oid_key'      => 'cid',
    'on_select'    => 'onSelectCategory',
];

if ( ! $is_system
     && ! $category_util->checkAccess(GRN_REPORT_CATEGORY_ROOT_ID, false)
) {
    $tree_for_view['no_root'] = true;
}

if (isset($tree_info) && is_array($tree_info)) {
    $tree_for_view = $tree_info + $tree_for_view;
}

$t->assign('folder_tree', $tree_for_view);

unset($util, $tree, $is_system, $category_logic, $tree_for_view, $tree_name, $category_util, $tree_info, $cid);
