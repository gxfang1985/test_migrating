<?php

assert('isset($file_view_page)');

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // Check Parameters
    // インクルード元で変数がセットされていればそれを優先

    if ( ! isset($category_id)) {
        $category_id = @ $G_INPUT['cid'];
    }
    if ( ! isset($report_id)) {
        if ( ! isset($G_INPUT['rid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
        }
        $report_id = $G_INPUT['rid'];
    }
    if ( ! isset($follow_id)) {
        $follow_id = @ $G_INPUT['follow_id'];
    }
    if ( ! isset($item_data_id)) {
        $item_data_id = @ $G_INPUT['iid'];
    }
    if ( ! isset($file_id)) {
        if ( ! isset($G_INPUT['fid'])) {
            require_once('report/error_code.csp');
            cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
        }
        $file_id = $G_INPUT['fid'];
    }
    if ( ! isset($check_creator)) {
        $check_creator = false;
    }
    // Get Report
    require_once('report/controller_util.csp');
    $report_util = GRN_Report_Report_Controller_Utility::getInstance();
    $report = $report_util->getSimpleView($report_id);
    if ( ! $report) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
    }

    $category_id = $report['category'];

    if ( ! $report_util->isViewable($G_report_login_user->getOID(),
        $report_id)
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_REPORT_DENY_ACCESS);
    }

    // Get File
    require_once('report/file.csp');
    $file_manager = GRN_Report_FileManager::getInstance();
    $file =& $file_manager->getFile($file_id);
    if ( ! $file
         || ($check_creator
             && ! $file->isCreator($G_report_login_user))
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND);
    }

    $force_unlock = false;

    if (isset($is_admin) && $is_admin) {
        $force_unlock = true;
    }

    $lock =& $file->getLockObject();
    $lock->releaseLock($force_unlock);

    $args = [];

    if (isset($category_id)) {
        $args['cid'] = $category_id;
    }

    $args['rid'] = $report_id;

    if (isset($follow_id)) {
        $args['follow_id'] = $follow_id;
    }
    if (isset($item_data_id)) {
        $args['iid'] = $item_data_id;
    }

    $args['fid'] = $file_id;
    $args['sf'] = 1;

    cb_redirect($file_view_page, $args);
}


