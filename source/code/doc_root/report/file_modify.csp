<?php

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

$file_id = @ $G_INPUT['fid'];
$category_id = @ $G_INPUT['cid'];
$item_data_id = @ $G_INPUT['iid'];
$follow_id = @ $G_INPUT['follow_id'];
$report_id = @ $G_INPUT['rid'];

if ($file_id == '') {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_report_app_name]);
}

$t->assign('cid', $category_id);

// page titile
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getSimpleView($report_id);
if ( ! $report) {
    require_once('report/error_code.csp');
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND,
        ['app_name' => $G_report_app_name],
        ['app_name' => $G_report_app_name],
        ['app_name' => $G_report_app_name]);
}

switch ($report['draft']) {
    case '1': // draft report
        $page_view = 'view_draft';
        break;
    default: // draft report
        $page_view = 'view';
        break;
}

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$user =& $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

$page_info = [
    'index'       => [
        'cid' => $category_id,
        'sf'  => 1,
    ],
    $page_view    => [
        'cid' => $category_id,
        'rid' => $report_id,
    ],
    'file_view'   => [
        'fid'       => $file_id,
        'cid'       => $category_id,
        'iid'       => $item_data_id,
        'follow_id' => $follow_id,
        'rid'       => $report_id,
    ],
    'file_modify' => null,
];
$controller_util = new GRN_Report_ControllerUtil();
$site_position = $controller_util->makeSitePosition('report/', $page_info);

$t->assign('site_position', $site_position);

$check_creator = true;
require('_file_modify.csp');


// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

