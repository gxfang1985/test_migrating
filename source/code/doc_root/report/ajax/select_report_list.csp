<?php
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
global $G_state_set;
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);

//Create Parameter Translation Map
$translation_map = [
    'id'                   => '_id',
    //Report ID
    'name'                 => 'name',
    //Report Name
    'form'                 => 'form',
    //Report Form ID
    'form_name'            => 'form_name',
    //Report Form Name
    'creator'              => 'creator',
    //Report Creator
    'creator_name'         => 'creator_name',
    //Report Creator Name
    'creator_foreign_key'  => 'creator_foreign_key',
    //Report Creator Foreign Key
    'modifier'             => 'modifier',
    //Report Modifier
    'modifier_name'        => 'modifier_name',
    //Report Modifier Name
    'modifier_foreign_key' => 'modifier_foreign_key',
    //Report Modifier Foreign Key
    'ctime'                => 'ctime',
    //Report Create Time
    'mtime'                => 'mtime',
    //Report Modify Time
    'private'              => 'private',
    //Report Private
    'draft'                => 'draft',
    //Draft
];

//Get Login User
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

//Create Criteria
require_once('report/search_logic.csp');
$criteria = new GRN_Report_Search_Criteria($user);
$criteria->target = GRN_REPORT_SEARCH_TARGET_SEND;
$criteria->noScheduleRelation = true;
if (array_key_exists('keyword', $G_INPUT) && strlen($G_INPUT['keyword']) > 0) {
    $criteria->and_or = GRN_REPORT_FILTER_OR;
    $criteria->keyword = $G_INPUT['keyword'];
}
$total_count = GRN_Report_Search_Logic::getCount($criteria);

//N-Navigation
require_once('report/utility.csp');
$n_navigation_for_view = grn_make_n_navigation($total_count, null, 10);
//Create List Option
$option['list'] = [];
$option['list']['offset'] = $n_navigation_for_view['offset'];
$option['list']['limit'] = $n_navigation_for_view['limit'];

$criteria->index = $n_navigation_for_view['offset'];
$criteria->count = $n_navigation_for_view['limit'];
$report_list = GRN_Report_Search_Logic::search($criteria);

require_once('report/controller_util.csp');
$filter_util = GRN_Report_Filter_Controller_Utility::getInstance();
foreach ($report_list as $rid => $report) {
    $report_list[$rid]['date'] = $filter_util->formatDate($report['col_mtime']);
    $report_list[$rid]['escaped_name'] = htmlspecialchars($report['col_name'],
        ENT_QUOTES);
}

$t->assign('callback_func', 'reportRelationNaviCallBack');
$t->assign('report_list', $report_list);
$t->assign('navi', $n_navigation_for_view);
//Display Smarty Template
$t->display(cb_get_pagename() . ".tpl");
