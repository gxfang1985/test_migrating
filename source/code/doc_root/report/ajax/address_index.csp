<?php

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

global $G_state_set;
$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);

////////////////////////////////////////////////////////////////

// アドレス帳を取得する
require_once('address/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Address_Application $app */
$app = $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
    cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
}
$book_manager = $app->getBookManager();

// ログインユーザーを取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
$login_id = $login->getOID();

// アドレス帳の設定を取得する
require_once('address/config.csp');
$config_manager = GRN_Address_ConfigManager::getInstance();
$personal_config = $config_manager->getPersonalConfig($login);
require_once('grn/ui.csp');
$ui_config_manager = GRN_UIConfigManager::getInstance();
$ui_config = $ui_config_manager->getUserConfig($login);

// 使用権限を取得する
require_once('address/access.csp');
$access_manager = GRN_Address_AccessManager::getInstance();
if ( ! ($row = $access_manager->getAbstractData(GRN_ADDRESS_AVAILABLE))) {
    assert('FALSE');
}

// ダイナミックロールを取得する
$dynamic_roles = $uum->listGrantedRoles();

// 使用権限を評価する
$authorities = ['shared_address'];
$security_model = $access_manager->getSecurityModel($row);
$access = $access_manager->evaluateAccess($row, $login, $dynamic_roles,
    $authorities, $security_model);

// 共有アドレス帳の使用権限を評価する
$access_for_view = [];
$authorities = ['shared_address'];
$access_for_view['shared_address'] = $access_manager->isAllowedAccess($access,
    $authorities, $security_model);

$allow_books = [];
$books_for_view = [];
$accesses = [];
require_once('address/view_util.csp');
$view_util = GRN_Address_ViewUtil::getInstance();
if ($access_for_view['shared_address']) {
    $books_for_view = $view_util->getAllowedSharedBooksView();
}

$bid = $personal_config->getLastOpenedBook();

// ブックを取得する
$book = null;
if ( ! is_null($bid) && array_key_exists($bid, $books_for_view)) {
    // 共有アドレスブックを取得する
    $book = $book_manager->getSharedAddressBook($bid);
} else {
    $indices = array_keys($books_for_view);
    if (0 < count($indices)) {
        // 表示順番が最初の共有アドレスブックを取得する
        $bid = $indices[0];
        $book = $book_manager->getSharedAddressBook($bid);
    } else {
        require_once('address/error_code.csp');
        cb_throw_error(E_GRN_ADDRESS_SHARED_ADDRESS_BOOK_NOT_FOUND);
    }
}

// 組み込み項目情報一覧を取得する
$builtin_items = $view_util->listBuiltinItems($book);

// 拡張項目情報一覧を取得する
$extended_items = $view_util->listExtendedItems($book);

// 一覧表示フラグを取得する
$personal_config->getDisplayFlag($book, $builtin_items, $extended_items);

// Huy add
$condition = null;

// Incremental Find on Reading name
require_once('address/charmap_util.csp');
$char_map = GRN_Address_CharMap_Util::getInstance();

$selected_hira_char = null;

$t->assign('selected_char', $selected_hira_char);

// n件ナビゲーション情報を取得する
require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();
$offset = $controller_util->getNaviStartPosition();
$controller_util->setNaviStartPosition($offset);
$limit = $ui_config->getListMax();
$data_count = $book->countDatas($condition);
$view_set = $controller_util->makeNaviInformation($offset, $limit,
    $data_count);

// アドレス一覧を取得する
$datas_for_view = $book->listDatasByPronunciationFast($offset, $limit,
    $condition);

// 最後に開いたブックを記録する
$personal_config->setLastOpenedBook($book);

// リソース一覧を生成する
$resources = ['application_name' => $app->getName()];

$t->assign('book_id', $bid);
$t->assign('view_set', $view_set);
$t->assign('access', $access_for_view);
$t->assign('books', $books_for_view);
$t->assign('cards', $datas_for_view);
$t->assign('builtin_items', $builtin_items);
$t->assign('extended_items', $extended_items);
$t->assign('resources', $resources);

////////////////////////////////////////////////////////////////

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


