<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! ($follow_id = @ $G_INPUT['follow_id'])) {
        cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
    }

    //Create Parameter Translation Map for Follow
    $translation_map_follow = [
        'id'                  => '_id',
        'creator'             => 'creator',
        'creator_foreign_key' => 'creator_foreign_key',
        'creator_name'        => 'creator_name',
        'ctime'               => 'ctime',
        'data'                => 'data',
        'follow_id'           => 'follow_id',
        'html'                => 'html',
        'report'              => 'report',
    ];

    //Get Follow
    require_once('report/controller_util.csp');
    $follow_util = GRN_Report_Follow_Controller_Utility::getInstance();
    if ( ! ($follow = $follow_util->getView($follow_id,
        $translation_map_follow))
    ) {
        cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
    }

    $report_id = $follow['report'];
    $user_id = $G_report_login_user->getOID();

    //Get Report
    $report_util = GRN_Report_Report_Controller_Utility::getInstance();
    if ( ! ($report = $report_util->getSimpleView($report_id))) {
        cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
    }

    $category_id = $report['category'];

    if ( ! isset($system_page)) {
        //Set Follow Deletable
        $category_util = GRN_Report_Category_Controller_Utility::getInstance();
        $category_manage = $category_util->checkManage($category_id, false,
            CB_DATABASE_NO_LOCK);

        //Check Delete Right
        $creator_id = isset($follow['creator']) ? $follow['creator'] : null;
        if ( ! $category_manage && $creator_id != $user_id) {
            cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_REMOVABLE);
        }
    }

    //Delete Follow
    require_once('report/follow_logic.csp');
    $follow_logic = GRN_Report_Follow_Logic::getInstance();
    $follow_logic->delete($follow_id, $report_id);

    //Inspection
    require_once('report/inspection.csp');
    $inspection = GRN_Report_Report_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'follow_delete';
        $message_args = [];
        $message_args['rid'] = $report_id;
        $message_args['follow_id'] = $follow_id;

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }
}

