<?php

use grn\grn\access\service\AppAccess;

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

require_once('report/controller_util.csp');

//Get Parameter
$category_id = @ $G_INPUT['cid'];     //Category ID
$form_id = @ $G_INPUT['fid'];     //Form ID
$report_id = @ $G_INPUT['rid'];     //Report ID

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

//Set Input Config
$utility = new GRN_Report_ControllerUtil();
$input_config = $utility->getInputConfigValues($G_report_login_user);
$t->assign('input_config', $input_config);

//Get Report for view
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getReportView($report_id);
$category_id = $report['category'];

GRN_Report_ControllerUtil::operationCheck($category_id);

//Get Item Data List
$item_data_util = GRN_Report_ItemData_Controller_Utility::getInstance();
$item_data_list = $item_data_util->getSimpleListView($report_id);

//Get Follow List for View
$follow_util = GRN_Report_Follow_Controller_Utility::getInstance();
$offset = $utility->getNaviStartPosition();
if (array_key_exists('follow_id', $G_INPUT)) {
    $offset = $follow_util->getOffset($report_id, $G_INPUT['follow_id']);
}
$limit = $follow_util->getLimit($G_report_login_user);
$follow_list = $follow_util->getFollowListView($report_id, $category_id,
    $offset, $limit);

//Get Report Members
require_once('report/member_manager.csp');
$member_manager = GRN_Report_Member_Manager::getInstance();
$members =& $member_manager->getList($report_id);

//Get Report Notification
require_once('report/notification_manager.csp');
$notification_manager = GRN_Report_Notification_Manager::getInstance();
$notificationUsers =& $notification_manager->getList($report_id);

//Get Report Partners
require_once('report/partner_manager.csp');
$partner_manager = GRN_Report_Partner_Manager::getInstance();
$partner_rows =& $partner_manager->getList($report_id);
require_once('report/partner.csp');
$partners = GRN_ReportPartnerData::createByRows($partner_rows);
$t->assign('partners', $partners);

require_once('report/address_util.csp');
$t->assign('address_available',
    $address_available = GRN_ReportAddressUtil::isAddressAvailable());
$t->assign('address_available_for_external',
    AppAccess::isAppAvailableExternalAccess('address'));

//Get Report Unsubscribe Users
require_once('report/subscribe_manager.csp');
$subscribe_manager = GRN_Report_Subscribe_Manager::getInstance();
$unsubscribed_users =& $subscribe_manager->getList($report_id, null,
    GRN_REPORT_UNSUBSCRIBED);
$t->assign('unsubscribed_users', $unsubscribed_users);
$t->assign('unsubscribed_users_num', count($unsubscribed_users));

//Get Schedule Link
require_once('report/report_schedule_logic.csp');
$report_schedule_logic = GRN_Report_Report_Schedule_Logic::getInstance();
$event_info = $report_schedule_logic->getRelatedEventId($report_id);
if (is_numeric($event_info['event_id']) && $event_info['event_id'] > 0) {
    $t->assign('event_id', $event_info['event_id']);

    $report_schedule_util
        = GRN_Report_Report_Schedule_Controller_Utility::getInstance();
    $event =& $report_schedule_util->getEvent($G_report_login_user, $event_info,
        GRN_SCHEDULE_GET_MEMBER_OBJECT, $report['draft']);
    if ($event) {
        require_once('schedule/access_logic.csp');
        $event_access_logic = GRN_Schedule_Access_Logic::getInstance();
        $dynamic_roles = $uum->listGrantedRoles();
        $access
            = $event_access_logic->getEventAccess($G_report_login_user,
            $event, ['read'], $dynamic_roles);
        if ($access['read']) {
            $t->assign('event', $event);
            $t->assign('event_date', $event_info['date']);
        }
    }

    //Make button to delete schedule relation
    $delete_info = [
        'title'      => grn_get_page_display_name('report/delete_relation'),
        'page'       => 'report/operation/delete_relation.tpl',
        'no_confirm' => false,
        'data'       => [
            'rid'    => $report_id,
            'cid'    => $category_id,
            'fid'    => $form_id,
            'eid'    => $event_info['event_id'],
            'date'   => $event_info['date'],
            'report' => $report
        ],
        'handler'    => 'schedule_relation',
    ];
    $t->assign('delete_info', $delete_info);
}

//Assign Display Infomation
$t->assign('category_id', $category_id);
$t->assign('form_id', $form_id);
$t->assign('report_id', $report_id);
$t->assign('report', $report);
$t->assign('item_data_list', $item_data_list);
$t->assign('follow_list', $follow_list);
$t->assign('members', $members);
$t->assign('notificationUsers', $notificationUsers);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
if (isset($report['form_name']) && (isset($report['name']))) {
    $t->assign('page_title',
        $report['form_name'] . '（' . $report['name'] . '）');
    $t->assign('report_title',
        $report['form_name'] . '（' . $report['name'] . '）');
} else {
    $t->assign('page_title', $page_title);
    $t->assign('report_title', $report['name']);
}

//Create Navigation
$count = $follow_util->getCount($report_id);
$params = [
    'cid' => $category_id,
    'rid' => $report_id,
    'fid' => $form_id
];
$navi_for_view = $utility->makeNaviInformation($offset,
    $limit,
    $count,
    $params
);
$navi_for_view['navi']['fragment'] = 'follow';
$t->assign('navi', $navi_for_view);

//site position
$t->assign('site_position', [
        [
            'page' => 'report/index',
            'name' => grn_get_page_display_name('report/index'),
            'sf'   => 1
        ],
        [
            'page' => 'report/operation/report_list',
            'name' => grn_get_page_display_name('report/system/report_list'),
            'cid'  => $category_id,
            'fid'  => $form_id,
            'sf'   => 1
        ],
        ['page' => '', 'name' => $page_title]
    ]
);
$t->assign('app_name', $G_report_app_name);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


