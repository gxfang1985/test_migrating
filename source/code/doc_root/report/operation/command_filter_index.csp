<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Get Command Type
    $command = @ $G_INPUT['cmd'];

    //Check Command
    if ($command == 'copy') {
        //Create Parameter Translation Map
        $translation_map = [
            'ids' => '_ids',
            'cid' => '_cid',
        ];

        //Do Parameter Translation
        $props = [];
        foreach ($translation_map as $view_name => $model_name) {
            $props[$model_name] = @ $G_INPUT[$view_name];
        }

        //Create Copy Filter List
        require_once('report/filter_logic.csp');
        $filter_logic = GRN_Report_filter_Logic::getInstance();
        $filter_list = $filter_logic->getSystemList($props['_cid']);
        foreach (array_keys($filter_list) as $filter_id) {
            if ( ! in_array($filter_id, $props['_ids'])) {
                unset($filter_list[$filter_id]);
            }
        }

        //ID MAP
        $id_map = [];

        //Copy Multi Filter
        $id_map['filter'] = [];
        $id_map['filter'] = $filter_logic->copyMulti(array_keys($filter_list),
            $props['_cid']);

        //Inspection
        require_once('report/inspection.csp');
        $inspection = GRN_Report_Filter_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            $message_type = 'filter_copy';

            $message_args['fids'] = $id_map['filter'];
            //Record Inspection
            $inspection->record($message_type, $message_args);
        }

        //Redirect Next Page
        cb_redirect('report/operation/filter_index',
            ['cid' => $G_INPUT['cid'], 'sf' => 1]);
    } elseif ($command == 'delete') {
        //Get Patameters
        $category_id = @ $G_INPUT['cid'];
        $ids = @ $G_INPUT['ids'];

        //Save IDs to Session
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session
            =& $session_manager->getSession('report/operation/filter_index');
        $session->set('ids', $ids);

        //Redirect Next Page
        cb_redirect('report/operation/filter_delete_multi',
            ['cid' => $category_id, 'sf' => 1]);
    }
}


