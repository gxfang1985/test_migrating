<?php
//Ppage Title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
require_once('report/controller_util.csp');

$util = GRN_Report_Filter_Controller_Utility::getInstance();

$and_or_info = $util->getFilterTypeList();
$type_info = $util->getConditionAnyTypeList();
$condition_info = $util->getAnyTypeCondition();

$filter_id = $G_INPUT['fid'] ?? "";
$logic = GRN_Report_Filter_Logic::getInstance();
$filter = $logic->get($filter_id);
if ( ! $filter) {
    cb_throw_error(E_GRN_RPRT_FILTER_NOT_FOUND);
}
$users = $logic->getDisplayUsers($filter_id);

$category_id = $filter['col_category'];
if ( ! is_numeric($category_id)) {
    $category_id = GRN_REPORT_CATEGORY_NONPARTY_ID;
}

//Include Sharing Code Get Category for view
$user_type = GRN_REPORT_ACCESS_TYPE_MANAGE;
$G_INPUT['cid'] = $category_id;
include('_category.csp');

require_once('report/controller_util.csp');
$form_util = new GRN_Report_Form_Controller_Utility();
$item_util = new GRN_Report_Item_Controller_Utility();
$itemdata_util = new GRN_Report_ItemData_Controller_Utility();

$item_map = [
    'id'           => '_id',
    'display_name' => 'display_name',
    'form'         => 'form',
    'type'         => 'type',
    'data_type'    => 'data_type'
];
$form_map = ['name' => 'name'];

//Get relational form
if ($filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_SELECT) {
    $r_form_id = $filter['form_relation']['col_form'];
    $relation_form = $form_util->getView($r_form_id, $form_map);
    $t->assign('relation_form', $relation_form);
    $item_list = $item_util->getListView($item_map, $r_form_id);
    $t->assign('relation_form_item_list', $item_list);
}


$conditions = $filter["conditions"];
$inputs = [];
foreach ($conditions as $cid => $c) {
    $inputs[$cid] = $util->getInputConditionView($c);
    $inputs[$cid]['id'] = $cid;
}

$selected_users = [];
foreach ($users as $user) {
    $selected_users[$user->getOID()] = $user->get('display_name');
}

$t->assign('selected_users', $selected_users);
$t->assign('filter', $filter);
$t->assign('select_form_check', $filter['col_formtype'] > 0);
$t->assign('select_form_type1_checked',
    $filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_NAME);
$t->assign('select_form_type2_checked',
    $filter['col_formtype'] == GRN_REPORT_FILTER_FORM_TYPE_SELECT);
$t->assign('name', $filter['col_name']);
$t->assign('and_or', cb_at($G_INPUT, 'and_or', $filter['col_or']));
$t->assign('conditions', $inputs);
$t->assign('category_id', $category_id);

$t->assign('plugin', [
    'name'   => 'common',
    'params' => [
        'action'       => null,
        'session_name' => cb_get_pagename(),
        'app_id'       => 'report'
    ]
]);

//Setting for category tree
$tree_selected_oid = $category_id;
$force_tree_initialize = true;
include('../_category_tree.csp');

//Site Position
$t->assign('site_position', [
        [
            'page' => 'report/index',
            'name' => grn_get_page_display_name('report/index'),
            'sf'   => 1
        ],
        [
            'page' => 'report/operation/filter_index',
            'name' => grn_get_page_display_name('report/operation/filter_index'),
            'cid'  => $category_id,
            'sf'   => 1
        ],
        [
            'page' => 'report/operation/filter_view',
            'name' => grn_get_page_display_name('report/operation/filter_view'),
            'cid'  => $category_id,
            'fid'  => $filter_id
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

$t->assign('and_or_info', $and_or_info);
$t->assign('type_info', $type_info);
$t->assign('condition_info', $condition_info);
