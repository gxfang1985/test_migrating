<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    if ( ! array_key_exists('rid', $G_INPUT)
         || ! array_key_exists('fid', $G_INPUT)
    ) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_report_app_name]);
    }

    $file_id = $G_INPUT['fid'];
    $category_id = @ $G_INPUT['cid'];
    $item_data_id = @ $G_INPUT['iid'];
    $follow_id = @ $G_INPUT['follow_id'];
    $report_id = $G_INPUT['rid'];
    $form_id = @ $G_INPUT['frm'];

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user =& $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    //Check File Manage
    require_once('report/file.csp');
    $file_manager = GRN_Report_FileManager::getInstance();
    $file_manager->isManage($file_id);

    //Get File
    $file =& $file_manager->getFile($file_id);
    if ( ! $file) {
        require_once('report/error_code.csp');
        cb_throw_error(E_GRN_RPRT_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_report_app_name]);
    }

    if (array_key_exists('cancel', $G_INPUT)) {
        $lock =& $file->getLockObject();
        $lock->releaseLock();

        cb_redirect('report/operation/file_view',
            [
                'cid'       => $category_id,
                'iid'       => $item_data_id,
                'follow_id' => $follow_id,
                'rid'       => $report_id,
                'fid'       => $file_id,
            ]
        );
    }

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    $target_name = '';
    if (array_key_exists('fn', $G_INPUT)) {
        $target_name = $G_INPUT['fn'];
    }

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if (is_array($files) && count($files) == 1) {
        if ( ! array_key_exists('cancel', $G_INPUT)) {
            $uploaded_file = array_pop($files);
            $file->update($user, $uploaded_file, @ $G_INPUT['comment']);
        }

        $lock =& $file->getLockObject();
        $lock->releaseLock();

        cb_redirect('report/operation/file_view',
            [
                'fid'       => $file_id,
                'cid'       => $category_id,
                'iid'       => $item_data_id,
                'follow_id' => $follow_id,
                'rid'       => $report_id,
            ]
        );
    } else {
        require('../_file_upload.csp');

        //Assign Site Position
        $page_path = [
            "report_list" => ['cid' => $category_id],
            "report_view" => [
                'cid' => $category_id,
                'rid' => $report_id
            ],
            "file_view"   => [
                'cid'       => $category_id,
                'frm'       => $form_id,
                'rid'       => $report_id,
                'follow_id' => $follow_id,
                'fid'       => $file_id
            ],
            "file_upload" => null,
        ];

        $utility = new GRN_Report_ControllerUtil($target_name);
        $site_position = $utility->makeSitePosition('report/operation/',
            $page_path);

        $t->assign('site_position', $site_position);
        $t->assign('err_no_file', true);
        $t->assign('form_name', $target_name);
        $t->assign('comment', @ $G_INPUT['comment']);
        $t->setPageInfo('report/operation/file_upload');

        //generate upload ticket
        include('grn/_upload_prepend.csp');

        $t->display('report/operation/file_upload.tpl');
    }

}
