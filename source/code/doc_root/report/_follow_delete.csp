<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

$category_id = @ $G_INPUT['cid'];
$form_id = @ $G_INPUT['fid'];


if ( ! array_key_exists('rid', $G_INPUT)) {
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}
if ( ! array_key_exists('follow_id', $G_INPUT)) {
    cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
}
$report_id = $G_INPUT['rid'];
$follow_id = $G_INPUT['follow_id'];

//Get Report
require_once('report/controller_util.csp');
$report_util = GRN_Report_Report_Controller_Utility::getInstance();
$report = $report_util->getSimpleView($report_id);
if ( ! $report) {
    cb_throw_error(E_GRN_RPRT_REPORT_NOT_FOUND);
}

//Create Parameter Translation Map for Follow
$translation_map_follow = [
    'id'                  => '_id',
    'creator'             => 'creator',
    'creator_foreign_key' => 'creator_foreign_key',
    'creator_name'        => 'creator_name',
    'ctime'               => 'ctime',
    'data'                => 'data',
    'follow_id'           => 'follow_id',
    'html'                => 'html',
    'report'              => 'report',
];

//Get Follow
require_once('report/controller_util.csp');
$follow_util = GRN_Report_Follow_Controller_Utility::getInstance();
$follow = $follow_util->getView($follow_id, $translation_map_follow);
if ( ! $follow) {
    cb_throw_error(E_GRN_RPRT_FOLLOW_NOT_FOUND);
}

$report_for_view = [
    'rid'         => $report_id,
    'fid'         => $form_id,
    'cid'         => $category_id,
    'follow_id'   => $follow_id,
    'follow_data' => $follow['data'],
];

$t->assign('report', $report_for_view);


