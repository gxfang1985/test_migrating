<?php

global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Parameter
$report_id = @ $G_INPUT['rid']; //Report ID

//Get Session Key
require_once('report/controller_util.csp');
require_once('grn/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);

//Get Session
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session_send_form = $session_manager->getSession('report/reuse' . $tmp_key);
$session_page = &$session_manager->getSession("pagename" . $tmp_key);
$session_page->set("pagename", 'reuse');

//Load Send Form Session (for Design)
$form_for_view = $session_send_form->get('form');
$item_list_for_view = $session_send_form->get('item_list');
$properties_for_view = $session_send_form->get('properties');
$members = $session_send_form->get('members');
$notification = $session_send_form->get('notification');
$operators = $session_send_form->get('operators');
$operator_set = $session_send_form->get('operator_set');
$partner_values = $session_send_form->get('partner_values');
$private = $session_send_form->get('private');

//Load Send Form Session (for Data)
$send_form_data_list = $session_send_form->get('send_form_data_list');

//Check Category Access Right
$category_id = $form_for_view['category'];
if (strlen($category_id) == 0) {
    $category_id = GRN_REPORT_CATEGORY_NONPARTY_ID;
}
if (GRN_REPORT_CATEGORY_NONPARTY_ID != $category_id) {
    require_once('report/controller_util.csp');
    $category_util = GRN_Report_Category_Controller_Utility::getInstance();
    $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);
}

require_once('grn/uum.csp');
global $G_container_base;
$grn_uum =& $G_container_base->getInstance('uum');

$report_util = GRN_Report_Report_Controller_Utility::getInstance();
foreach ($item_list_for_view as $key => $item) {
    if ($item['type'] == 1) {
        $subject = $report_util->getSubjectView($item);
        if (strlen($subject) > 0) {
            $form_for_view['subject'] = $subject;
        }
    }
}

if ($private) {
    //Add Title Message for Private 
    foreach ($item_list_for_view as $key => $item) {
        if ($item['type'] == 1) {
            $report_util->addPrivateMessage($item_list_for_view[$key]);
        }
    }
}

require_once('report/partner.csp');
$partners = GRN_ReportPartnerData::createByValues($partner_values);

//Assign
$t->assign('report_id', $report_id);
$t->assign('form', $form_for_view);
$t->assign('item_list', $item_list_for_view);
$t->assign('properties', $properties_for_view);
$t->assign('members', $members);
$t->assign('notificationUsers', $notification);
$t->assign('operators', $operators);
$t->assign('operator_set', $operator_set);
$t->assign('partners', $partners);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$report = $report_util->getSimpleView($report_id);
$view_page = "report/view";
if ($report['draft']) {
    $view_page = "report/view_draft";
}

//site position
$t->assign('site_position', [
        [
            'page' => 'report/index',
            'name' => grn_get_page_display_name('report/index'),
            'sf'   => 1
        ],
        [
            'page' => $view_page,
            'name' => grn_get_page_display_name($view_page),
            'rid'  => $report_id
        ],
        [
            'page'    => 'report/reuse',
            'name'    => grn_get_page_display_name('report/reuse'),
            'rid'     => $report_id,
            'sf'      => 1,
            'tmp_key' => $tmp_key
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


