<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

require_once('cbwebsrv/common.csp');
require_once('cbwebsrv/tool_define.csp');
$disabled_services_for_view['weather'] = false;
if ( ! grn_cbwebsrv_is_available_service(GRN_CBWEBSRV_SERVICE_WEATHER)) {
    $disabled_services_for_view['weather'] = true;
}
$disabled_services_for_view['six_kinds_of_day'] = false;
if ( ! grn_cbwebsrv_is_available_service(GRN_CBWEBSRV_SERVICE_SIXKINDSOFDAY)) {
    $disabled_services_for_view['six_kinds_of_day'] = true;
}
$t->assign('disabled_services', $disabled_services_for_view);

$settings_for_view = [
    'font_size'        => 'normal',
    'six_kinds_of_day' => true
];

$portlet_settings = @ $portlet['settings'];
if (is_array($portlet_settings)) {
    foreach ($portlet_settings as $key => $value) {
        $settings_for_view[$key] = $value;
    }
}
$t->assign('settings', $settings_for_view);

if ( ! $disabled_service_for_view['weather']) {
    $visible_row_num_for_view = 1;
    $t->assign('visible_row_num', $visible_row_num_for_view);
    if (is_array($portlet_settings)
        && array_key_exists('weather_location_list', $portlet_settings)
        &&
        ! is_null($portlet_settings['weather_location_list'])
    ) {
        // login user
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();

        // start date
        require_once('fw/date.csp');
        $tsx = new CB_TimeStampEx($ts);
        $start = $tsx->getDate();

        // end date
        $end = new CB_DateEx($start);
        $end->moveDays(7);

        require_once('grn/calendar.csp');
        $cal_service = GRN_CalendarService::getInstance();
        $cal_util = GRN_CalendarUtil::getInstance();
        $calendars = $cal_service->getDaysInfo($start, $end, $login,
            [GRN_CALENDAR_TYPE_PUBLICHOLIDAY, GRN_CALENDAR_TYPE_WORKDAY]);
        $date_list_for_view = [];
        for ($i = 0; $i < 7; $i++) {
            $today = [];
            $today['type']
                = $cal_util->getDateType($start,
                $calendars, $login);
            $date_list_for_view[$start->format()] = $today;
            $start->moveDays(1);
        }

        $location_list = $portlet_settings['weather_location_list'];
        require_once('cbwebsrv/weather.csp');
        $ws = GRN_CBWebSrv_WeatherService::getInstance();
        $weather = $ws->getWeather($location_list);

        $weather_for_view = [];
        foreach ($weather as $location_id => $location) {
            $location_info = [];
            $date_info = [];

            foreach ($date_list_for_view as $formatted_date => $dummy) {
                if (array_key_exists($formatted_date, $location['date_list'])) {
                    $date_info[$formatted_date]
                        = $location['date_list'][$formatted_date];
                } else {
                    $date_info[$formatted_date] = [];
                }
            }

            $arr_location_name = json_decode($location['name'],
                true);
            $location_info['name'] = $arr_location_name['pointName'];
            $location_info['date_list'] = $date_info;
            $weather_for_view[$location_id] = $location_info;
        }
        $t->assign('weather', $weather_for_view);

        if ($settings_for_view['six_kinds_of_day']
            &&
            ! $disabled_services_for_view['six_kinds_of_day']
        ) {
            require_once('cbwebsrv/six_kinds_of_day.csp');
            $skod = GRN_CBWebSrv_SixKindsOfDayService::getInstance();
            $skod_info = $skod->getSixKindsOfDay();

            foreach ($date_list_for_view as $format_date => $date_info) {
                if (array_key_exists($format_date, $skod_info)) {
                    $date_list_for_view[$format_date]['six_kinds_of_day']
                        = $skod_info[$format_date];
                }
            }
        }
        $t->assign('date_list', $date_list_for_view);
    }
}

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
//Set Page Title
if ($portlet['title'] === '') {
    $page_title = cb_plain_msg('grn.cbwebsrv', 'portlet_view_weather');
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display('cbwebsrv/portlet/view_weather.tpl');


