<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

// ----------

// are services available?
require_once('cbwebsrv/common.csp');
require_once('cbwebsrv/tool_define.csp');
$disabled_services_for_view['weather'] = false;
if ( ! grn_cbwebsrv_is_available_service(GRN_CBWEBSRV_SERVICE_WEATHER)) {
    $disabled_services_for_view['weather'] = true;
}
$disabled_services_for_view['six_kinds_of_day'] = false;
if ( ! grn_cbwebsrv_is_available_service(GRN_CBWEBSRV_SERVICE_SIXKINDSOFDAY)) {
    $disabled_services_for_view['six_kinds_of_day'] = true;
}
$t->assign('disabled_services', $disabled_services_for_view);

// settings
$settings = @ $portlet['settings'];

// font options
$font_options_for_view = [
    ['value' => 'small', 'label' => cb_msg('grn.cbwebsrv', 'font_size_small')],
    [
        'value' => 'normal',
        'label' => cb_msg('grn.cbwebsrv', 'font_size_normal')
    ],
    ['value' => 'large', 'label' => cb_msg('grn.cbwebsrv', 'font_size_large')],
];
switch (@ $settings['font_size']) {
    case 'small':
        $font_options_for_view[0]['selected'] = true;
        break;
    case 'normal':
        $font_options_for_view[1]['selected'] = true;
        break;
    case 'large':
        $font_options_for_view[2]['selected'] = true;
        break;
    default:
        $font_options_for_view[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options_for_view);

// display settings
$display_keys = ['six_kinds_of_day'];
if (is_array($settings)) {
    foreach ($display_keys as $key) {
        if (array_key_exists($key, $settings)) {
            $t->assign($key, $settings[$key]);
        } else {
            $t->assign($key, true);
        }
    }
} else {
    foreach ($display_keys as $key) {
        $t->assign($key, true);
    }
}

// location list
require_once('cbwebsrv/weather.csp');
$location_list_setting = $settings['weather_location_list'] ?? [];
$location_list = GRN_CBWebSrv_WeatherService::getInstance()
                                            ->getLocationTree($location_list_setting);
$t->assign('location_list', $location_list);

require_once('cbwebsrv/six_kinds_of_day.csp');
$is_received_six_kind_of_days_data
    = GRN_CBWebSrv_SixKindsOfDayService::getInstance()->isReceivedData();
$t->assign('is_received_six_kind_of_days_data',
    $is_received_six_kind_of_days_data);

//Assign include_php Parameter
$t->assign('portlet', $portlet);
$t->assign('display', $display);

// Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$doc_name = 'cbwebsrv/portlet/set_weather';
$t->display("{$doc_name}.tpl");


