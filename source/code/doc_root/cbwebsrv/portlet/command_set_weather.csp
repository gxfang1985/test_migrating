<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;
    require_once('portal/error_code.csp');
    if ( ! isset($portlet)) {
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
    }

    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app_portal */
    $app_portal =& $app_locator->getInstance('portal');
    $portlet_id = $G_INPUT['plid'];

    $setting_keys = ['font_size', 'weather_location_list'];
    $settings = [];
    foreach ($setting_keys as $key) {
        $settings[$key] = @ $G_INPUT[$key];
    }

    require_once('cbwebsrv/six_kinds_of_day.csp');
    $six_kinds_of_day_service
        = GRN_CBWebSrv_SixKindsOfDayService::getInstance();
    if ($six_kinds_of_day_service->isAvailable()) {
        $settings['six_kinds_of_day'] = $G_INPUT['six_kinds_of_day'] ?? null;
    } else {
        $current_setting = $app_portal->getSettingsOfPortlet($portlet_id);
        $settings['six_kinds_of_day'] = $current_setting['six_kinds_of_day'] ??
                                        null;
    }

    $app_portal->setPortletSettings($portlet_id, $settings);

    //Switch Redirect Page
    if ($G_INPUT['display'] === 'set-system') {
        //redirect System page
        cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
    } elseif ($G_INPUT['display'] === 'set-operation') {
        //redirect System page
        cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
    } else {
        //redirect Personal page
        cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
    }
}

