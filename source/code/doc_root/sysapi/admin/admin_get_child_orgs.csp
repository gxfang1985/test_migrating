<?php
/** @var GRN_Util_Api_Service $sysapi_service */
/** @var GRN_Uum $uum */
if (isset($sysapi_service)) {
    // Get parameters from the xml
    $request_params = $sysapi_service->getRequestParameters();

    $values = $sysapi_service->selectNodesValue($request_params, 'parent_orgId',
        true);
    require_once('sysapi/logic.csp');
    $orgId = $values[0];
    if ($orgId === GRN_SYSAPI_ROOT_ORGID) {
        $orgId = null; // In Garoon, the root org is represented by a null value
    }

    $values = $sysapi_service->selectNodesValue($request_params, 'offset');
    if (is_array($values) && count($values) > 0 && is_numeric($values[0])
        && $values[0] >= 0
    ) {
        $offset = $values[0];
    } else {
        $offset = 0;
    }

    $values = $sysapi_service->selectNodesValue($request_params, 'limit');
    if (is_array($values) && count($values) > 0 && is_numeric($values[0])) {
        $limit = $values[0];
    } else {
        $limit = -1;
    }

    // Query the database
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $child_orgs = $uum->getChildGroupsInfo($orgId, $offset, $limit);
    $child_orgIds = [];
    foreach ($child_orgs as $child_org) {
        $child_orgIds[] = $child_org['_id'];
    }

    // Set $parent_orgId of root back to a value understandable in the SysAPI domain
    if (is_null($orgId)) {
        $orgId = GRN_SYSAPI_ROOT_ORGID;
    }

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;


    $t->assign('parent_orgId', $orgId);
    $t->assign('child_orgIds', $child_orgIds);

    $t->assign('xml_namespaces',
        "xmlns:admin=\"http://wsdl.cybozu.co.jp/admin/2008\"");
    grn_util_api_response($t, __FILE__);
}

