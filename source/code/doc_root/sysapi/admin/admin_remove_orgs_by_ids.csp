<?php
/** @var GRN_Util_Api_Service $sysapi_service */
/** @var GRN_Uum $uum */
if (isset($sysapi_service) && ! defined('ON_FOREST')) {
    // Get parameters from the xml
    $request_params = $sysapi_service->getRequestParameters();

    $remove_orgIds = $sysapi_service->selectNodesValue($request_params, 'orgId',
        true);

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $affected_orgIds = [];
    foreach ($remove_orgIds as $remove_orgId) {
        if ( ! is_numeric($remove_orgId)) {
            continue;
        }

        $org = $uum->getGroup($remove_orgId);
        if (is_null($org) || ! is_a($org, 'CB_Group')) {
            continue; // This orgId does not exist
        }
        $result = $uum->removeGroup($remove_orgId);
        if ($result) {
            $affected_orgIds[] = $remove_orgId;
            $uum->execInspection('group', 'delete', [
                'gid'         => $org->getOID(),
                'name'        => $org->get('name'),
                'foreign_key' => $org->get('foreign_key'),
                'memo'        => 'Edited by SysAPI'
            ]);
        }
    }

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    $t->assign('affected_orgIds', $affected_orgIds);

    $t->assign('xml_namespaces',
        "xmlns:admin=\"http://wsdl.cybozu.co.jp/admin/2008\"");
    grn_util_api_response($t, __FILE__);
}
