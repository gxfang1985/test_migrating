<?php
/** @var GRN_Util_Api_Service $sysapi_service */
/** @var GRN_Uum $uum */
if (isset($sysapi_service) && ! defined('ON_FOREST')) {
    require_once('cbpapi/util.csp');

    // Get parameters from the xml
    $request_params = $sysapi_service->getRequestParameters();

    $values = $sysapi_service->selectNodesValue($request_params, 'userId',
        true);
    $userId = $values[0];

    if ( ! is_numeric($userId) || strval($userId) != strval(intval($userId))) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_SYSTEM_INVALID_USER_ID);
    }

    // Get the user to be modified
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getUser($userId);

    // Throw an error if this user does not exist
    if (is_null($user) || ! $user) {
        require_once('sysapi/error_code.csp');
        cb_throw_error(E_GRN_SYSAPI_INVALID_USER, null, ['userId' => $userId],
            ['userId' => $userId]);
    }

    // Set password using password_raw parameter
    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $passwd_raw = $sysapi_service->getPasswordParameter($request_params,
        GRN_UumUtil::INVALID_PASSWORD);
    if ($uum_util->isValidPassword($passwd_raw)) {
        $uum->changePassword($userId, null, $passwd_raw, true, true);
    }

    $values = $sysapi_service->selectSingleNode($request_params,
        'user_info');
    $user_info = $values;

    // 表示優先度
    $value = $sysapi_service->getAttribute($user_info, 'position');
    if ($value !== false && $value > 0) {
        $uum->setUserProperties($userId, ['position' => $value]);
    }

    // ユーザー作成用のプロパティを用意する
    $basic_properties = $sysapi_service->getBasicProperties($request_params,
        $user_info, []);

    // 名前の言語, ニックネーム
    foreach (
        [
            'foreign_key',
            'display_name',
            'display_name_language',
            'nickname'
        ] as $column_name
    ) {
        if (array_key_exists($column_name, $basic_properties)) {
            $uum->setUserProperties($userId,
                [$column_name => $basic_properties[$column_name]]);
        }
    }

    // 使用の停止
    if (isset($basic_properties['valid'])) {
        if ($basic_properties['valid']) {
            $uum->activateUser($userId);
        } else {
            $uum->deactivateUser($userId);
        }
    }

    // 組織へ追加
    $values = $sysapi_service->selectNodesValue($user_info, 'organization');
    $org_ids = [];
    if (is_array($values) && count($values) > 0) {
        foreach ($values as $org_id) {
            $org_ids[$org_id] = $org_id;
        }
        if (is_array($org_ids) && count($org_ids) > 0) {
            $groups = $uum->getGroupInfoList($org_ids);
            if (is_array($groups) && count($groups) > 0) {
                $uum->setUserGroups($userId, array_keys($groups));
            }
        }
    }

    // 優先する組織の設定
    $value = $sysapi_service->getAttribute($user_info, 'primary_group');
    if ($value !== false && array_key_exists($value, $org_ids)) {
        $uum->setUserPrimaryGroup($userId, $value);
    }

    // 組み込み項目を取得する
    $builtin_parameters = $sysapi_service->getBuiltinParameters($user_info);

    // カスタマイズ項目を取得する
    $extended_parameters = $sysapi_service->getExtendedParameters($user_info);

    // 組み込み項目のプロパティを変更する
    require_once('grn/controller.csp');
    $controller_util = new GRN_ControllerUtil();
    $builtin_items = $sysapi_service->getBuiltinProperties();
    $controller_util->setBuiltinItemProperties($builtin_items, $user,
        $builtin_parameters);

    // カスタマイズ項目のプロパティを変更する
    $extended_items = $sysapi_service->getExtendedProperties();
    $controller_util->setExtendedItemProperties($extended_items, $user,
        $extended_parameters);

    // ロケールの設定
    $locale_id = $sysapi_service->getAttribute($user_info, 'locale');
    if ($locale_id !== false) {
        require_once("fw/i18n/locale.csp");
        CB_LocaleManager::setUserLocaleSetting($userId, $locale_id);
    }

    // 拠点の設定
    $base_id = $sysapi_service->getAttribute($user_info, 'base');
    if ($base_id !== false) {
        require_once('fw/i18n/base.csp');
        CB_BaseManager::setUserBaseSetting($userId, $base_id);
    }

    $uum->execInspection('user', 'modify', [
        'uid'     => $userId,
        'name'    => $user->get('display_name'),
        'account' => $user->get('foreign_key'),
        'memo'    => 'Edited by SysAPI'
    ]);

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    $t->assign('login_name', $user->get('foreign_key'));
    $t->assign('display_name', $user->get('display_name'));
    $t->assign('userId', $userId);

    $t->assign('xml_namespaces',
        "xmlns:admin=\"http://wsdl.cybozu.co.jp/admin/2008\"");
    grn_util_api_response($t, __FILE__);
}
