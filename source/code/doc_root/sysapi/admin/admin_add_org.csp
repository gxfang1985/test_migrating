<?php
/** @var GRN_Util_Api_Service $sysapi_service */
/** @var GRN_Uum $uum */
if (isset($sysapi_service) && ! defined('ON_FOREST')) {
    // Get parameters from the xml
    $request_params = $sysapi_service->getRequestParameters();

    $values = $sysapi_service->selectNodesValue($request_params, 'org_code',
        true);
    $org_code = $values[0];

    $values = $sysapi_service->selectNodesValue($request_params, 'org_name',
        true);
    $org_name = $values[0];

    $values = $sysapi_service->selectNodesValue($request_params,
        'parent_orgId');

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    if (is_array($values) && count($values) > 0) {
        $parent_Id = $values[0];

        if ($parent_Id == 0) {
            $parent_Id = null;
        }

        // Check existence of parent_Id, if not exist return an error message
        if ( ! is_null($parent_Id)) {
            $parent = $uum->getGroupInfo($parent_Id);
            if (is_null($parent) || ! $parent) {
                require_once('sysapi/error_code.csp');
                cb_throw_error(E_GRN_SYSAPI_INVALID_ORG, null,
                    ['orgId' => $parent_Id], ['orgId' => $parent_Id]);
            }
        }
    } else {
        $parent_Id = "";
    }

    $properties = [];
    $properties['name'] = $org_name;
    $properties['foreign_key'] = $org_code;

    $group = $uum->addGroupDefaultOnly($properties, $parent_Id);
    $orgId = $group->getOID();

    $uum->execInspection('group', 'create', [
        'gid'         => $group->getOID(),
        'name'        => $group->get('name'),
        'foreign_key' => $group->get('foreign_key'),
        'memo'        => 'Edited by SysAPI'
    ]);

    if ($parent_Id == "") {
        require_once('sysapi/logic.csp');
        $parent_Id = GRN_SYSAPI_ROOT_ORGID;
    }

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('orgId', $orgId);
    $t->assign('org_code', $org_code);
    $t->assign('org_name', $org_name);
    $t->assign('parent_orgId', $parent_Id);

    $t->assign('xml_namespaces',
        "xmlns:admin=\"http://wsdl.cybozu.co.jp/admin/2008\"");
    grn_util_api_response($t, __FILE__);
}
