<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'personal/user/mygroup_modify';
    SmartyValidate::register_form($target_name);

    /** @var \GRN_Uum $uum */
    $uum = $G_container_base->getInstance('uum');

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // POSTされたフォームデータを取得する
        $mygroup_id = @ $G_INPUT['mgid'];       // 選択しているMyグループID

        // Myグループのプロパティを取得する
        $keys = ['name', 'description'];
        $properties = [];
        foreach ($keys as $key) {
            $properties[$key] = @ $G_INPUT[$key];
        }

        require_once('fw/string_util.csp');
        cb_trim_check(@$properties['name'],
            E_GRN_PERSONAL_MYGROUP_NAME_NESSARY);

        $uum = $G_container_base->getInstance('uum');
        $mygroup_row =& $uum->getMyGroup($mygroup_id);
        if ( ! $mygroup_row) {
            cb_throw_error(E_GRN_PERSONAL_MYGROUP_NOT_FOUND);
        }

        require_once('grn/multi_select_utility.csp');
        $G_INPUT = grn_deploy_selected_users('selected_users_sUID',
            'sUIDs', $G_INPUT);
        $G_INPUT
            = grn_deploy_selected_users('selected_users_sITEM',
            'sITEMs', $G_INPUT);
        $properties['selected_users'] = cb_at($G_INPUT, 'sUIDs', []);
        $properties['selected_facilities'] = cb_at($G_INPUT, 'sITEMs', []);

        // Myグループのプロパティを変更する
        if (false === $uum->setMyGroupProperties($mygroup_id, $properties)) {
            cb_throw_error(E_GRN_PERSONAL_INVALID_MYGROUP_ID);
        }

        SmartyValidate::unregister_form($target_name);

        cb_redirect('personal/user/mygroup_list', ['mgid' => $mygroup_id]);
    } else {
        include('_mygroup_modify.csp');
        require_once('_get_mygroup_properties.csp');

        //Assign Template Name
        $t->setPageInfo($target_name);

        $t->display($target_name . '.tpl');
    }
}

