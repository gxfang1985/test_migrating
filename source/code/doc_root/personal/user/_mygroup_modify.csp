<?php

use grn\grn\access\service\AppAccess;
use grn\grn\MemberLogic;
use grn\schedule\ScheduleMemberLogic;

// current mygroup id
$mygroup_id = @ $G_INPUT['mgid'];

$facility_access_right = AppAccess::isAppAvailable('schedule');
$t->assign('facility_access_right', $facility_access_right);

//--mygroup
/** @var GRN_Uum $uum */
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
$login_id = $login->getOID();
$mygroup_row = $uum->getMyGroup($mygroup_id);
if ( ! $mygroup_row) {
    cb_throw_error(E_GRN_PERSONAL_MYGROUP_NOT_FOUND);
}
$user_rows = $uum->getMyGroupUsers($mygroup_id);
$facility_rows = $uum->getMyGroupFacilitiesId($mygroup_id);

$existed_member = [];
if ( ! array_key_exists('selected_users_sUID', $G_INPUT)) {
    $existed_member = MemberLogic::getInstance()
                                 ->getDisplayUsersByUserIds(array_keys($user_rows));
    foreach ($existed_member as &$member) {
        $member[MemberLogic::IS_NOT_USING_APP] = false;
    }
    $t->assign('selected_users', $existed_member);
}

//Facility
if ($facility_access_right) {
    include_once("_prepare_facility_selection_mygroup.csp");

    if ( ! array_key_exists('selected_users_sITEM', $G_INPUT)) {
        $facilities_info
            = $facility_logic->getFacilitiesInfo(array_values($facility_rows),
            CB_DATABASE_DEFAULT_LOCK, ['order_by_ids' => true]);
        $existed_facilities = ScheduleMemberLogic::getInstance()
                                                 ->getFacilitiesRender($facilities_info);
        $t->assign('initialize_item', $existed_facilities);
    }
}


// SmartyにすべてのMyグループ情報を割り当てる
$t->assign('mygroup_id', $mygroup_id);
$t->assign('name', $mygroup_row->get('name'));
$t->assign('description', $mygroup_row->get('description'));


//--------------------------------------------------------------

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
require_once('grn/controller.csp');
$page_infos = [
    'mygroup_list'   => ['mgid' => $mygroup_id],
    'mygroup_modify' => null,
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('personal/user/', $page_infos);
$t->assign('site_position', $site_position);

