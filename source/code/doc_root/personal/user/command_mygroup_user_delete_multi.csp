<?php

// POSTされたフォームデータを取得する
$mygroup_id = @ $G_INPUT['mgid'];

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // POSTされたフォームデータを取得する
    $user_ids = @ $G_INPUT['eid']; // Myグループから除外するユーザーID一覧

    // Myグループに所属するユーザーを取得する
    /** @var GRN_Uum $uum */
    $uum = $G_container_base->getInstance('uum');
    $mygroup = $uum->getMyGroup($mygroup_id);
    $users = $uum->getMyGroupUsers($mygroup_id);
    $facilities = $uum->getMyGroupFacilitiesId($mygroup_id);

    // 選択されているユーザーを除外する
    foreach ($user_ids as $user_id) {
        if (substr($user_id, 0, 1) == 'f') {
            unset($facilities[substr($user_id, 1)]);
        } else {
            unset($users[$user_id]);
        }
    }

    // Myグループの所属するユーザーを変更する
    $properties = [
        'mgid'                => $mygroup_id,
        'name'                => $mygroup->get('name'),
        'description'         => $mygroup->get('description'),
        'selected_users'      => array_keys($users),
        'selected_facilities' => $facilities,
    ];
    if (false === $uum->setMyGroupProperties($mygroup_id, $properties)) {
        cb_throw_error(E_GRN_PERSONAL_INVALID_MYGROUP_ID);
    }
}

cb_redirect('personal/user/mygroup_list', ['mgid' => $mygroup_id]);


