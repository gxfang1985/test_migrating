<?php

require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

require_once('fw/i18n/base.csp');
$base_id = isset($selected_base) ? $selected_base : null;
if (is_null($base_id)) {
    $user_base_setting = CB_UserBaseSetting::select($user->getOID());
    $base_id = is_null($user_base_setting) ? null
        : $user_base_setting->getBase();
}
$bases_param = CB_BaseManager::getBaseSelectParams($base_id);
$t->assign('bases_param', $bases_param);

// Locale Information
require_once('fw/i18n/locale.csp');
if (isset($selected_locale)) {
    $locale_id = $selected_locale;
} else {
    $user_locale_setting
        = CB_LocaleManager::getCurrentLocaleSetting($user->getOID());
    $locale_id = $user_locale_setting->getLocale();
}

$locale = CB_Locale::select($locale_id);
if ($locale == CB_Locale::$NOT_FOUND) {
    $locale_id = CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED;
}

$locales = CB_LocaleManager::getLocales();
$locales_param = [];
$locales_param[] = [
    "value"    => CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED,
    "label"    => cb_msg("fw.common", CB_LocaleManager::getBlank()),
    "selected" => $locale_id == CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED,
];
foreach ($locales as $locale) {
    $locales_param[] = [
        "value"    => $locale->getId(),
        "label"    => $locale->getLocalName(),
        "selected" => $locale->getId() == $locale_id,
    ];
}
$t->assign("locales_param", $locales_param);

if ( ! isset($selected_language)) {
    $selected_language
        = CB_LanguageManager::getLanguageCode($user->get("display_name_language"));
}
$languages_param = [];
foreach (CB_LanguageManager::getAvailableLanguages() as $language_code) {
    $languages_param[] = [
        "value"    => $language_code,
        "label"    => CB_LanguageManager::getLanguageName($language_code),
        "selected" => $selected_language == $language_code,
    ];
}
$t->assign("languages_param", $languages_param);


// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('personal/user/user_modify');
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = [
    'user_view'   => [],
    'user_modify' => null
];
$site_position = $controller_util->makeSitePosition('personal/user/',
    $page_info);
$t->assign('site_position', $site_position);


