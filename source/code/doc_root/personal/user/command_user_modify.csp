<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    // 詳細を表示するユーザーを取得する
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user) || ! is_a($user, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    // 組み込み項目を取得する
    require_once('grn/controller.csp');
    $controller_util = new GRN_ControllerUtil();
    $builtin_items = $controller_util->listBuiltinItems($user);

    // カスタマイズ項目を取得する
    $extended_items = $controller_util->listExtendedItems($user);

    // 入力データからデータを取得
    $properties = grn_wash_input_data($builtin_items, $extended_items,
        'extended_');

    if ($controller_util->hasSmartyValidateItem($builtin_items,
        $extended_items)
    ) {
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        $target_name = 'personal/user/user_modify';
        SmartyValidate::register_form($target_name);

        if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
            SmartyValidate::unregister_form($target_name);

            // 組み込み項目のプロパティを変更する
            $controller_util->setBuiltinItemProperties($builtin_items, $user,
                $properties);

            // カスタマイズ項目のプロパティを変更する
            $controller_util->setExtendedItemProperties($extended_items, $user,
                $properties);

            cb_redirect('personal/user/user_view');
        } else {
            foreach (array_keys($builtin_items) as $item_id) {
                if (array_key_exists($item_id, $properties)) {
                    if ('file' == $builtin_items[$item_id]['type']) {
                        continue;
                    } elseif ('primary_group'
                              == $builtin_items[$item_id]['type']
                    ) {
                        $value_keys
                            = array_keys($builtin_items[$item_id]['value']);
                        foreach ($value_keys as $value_key) {
                            $option_keys
                                = array_keys($builtin_items[$item_id]['value'][$value_key]['group_options']);
                            foreach ($option_keys as $option_key) {
                                if ($builtin_items[$item_id]['value'][$value_key]['group_options'][$option_key]['value']
                                    == $properties[$item_id]
                                ) {
                                    $builtin_items[$item_id]['value'][$value_key]['group_options'][$option_key]['selected']
                                        = true;
                                } else {
                                    $builtin_items[$item_id]['value'][$value_key]['group_options'][$option_key]['selected']
                                        = false;
                                }
                            }
                        }
                    } else {
                        $builtin_items[$item_id]['value']
                            = $properties[$item_id];
                    }
                }
            }
            foreach (array_keys($extended_items) as $item_id) {
                if (array_key_exists($item_id, $properties)) {
                    if ('file' == $extended_items[$item_id]['type']) {
                        continue;
                    } else {
                        $extended_items[$item_id]['value']
                            = $properties[$item_id];
                    }
                }
            }

            $selected_base = isset($G_INPUT['base']) ? $G_INPUT['base'] : null;

            if (isset($G_INPUT["locale"])) {
                $selected_locale = $G_INPUT["locale"];
            }

            include('_user_modify.csp');

            $t->setPageInfo($target_name);
            $t->assign('builtin_items', $builtin_items);
            $t->assign('extended_items', $extended_items);
            $t->display($target_name . '.tpl');
        }
    } else {
        // 組み込み項目のプロパティを変更する
        $controller_util->setBuiltinItemProperties($builtin_items, $user,
            $properties);

        // カスタマイズ項目のプロパティを変更する
        $controller_util->setExtendedItemProperties($extended_items, $user,
            $properties);

        cb_redirect('personal/user/user_view');
    }
}


