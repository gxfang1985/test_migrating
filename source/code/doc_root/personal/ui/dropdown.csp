<?php
require_once('fw/i18n.csp');
require_once('grn/smarty.csp');

use grn\grn\access\service\AppAccess;

global $G_INPUT;

$t = new GRN_Smarty();

require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$system_config = $manager->getSystemConfig();
if ( ! $system_config->getCanUserChangeHistory()) {
    cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
}

require_once('schedule/resources.csp');
require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$is_schedule_available = AppAccess::isAppAvailable(GRN_SCHEDULE_APPLICATION_ID);

$tabs = [];
$tabs[0]
    = [
    'page'       => 'personal/ui/dropdown',
    'page_param' => ['tab' => 0, 'reset' => 1],
    'caption'    => cb_msg('grn.personal.ui', 'dropdown-group'),
    'selected'   => 0,
    'tab_id'     => 'tab_group',
    'file'       => 'personal/ui/dropdown-group.tpl',
];
if ($is_schedule_available) {
    $tabs[1]
        = [
        'page'       => 'personal/ui/dropdown',
        'page_param' => ['tab' => 1, 'reset' => 1],
        'caption'    => cb_msg('grn.personal.ui', 'dropdown-facilitygroup'),
        'selected'   => 0,
        'tab_id'     => 'tab_facilitygroup',
        'file'       => 'personal/ui/dropdown-facilitygroup.tpl',
    ];
}
$tabs[2]
    = [
    'page'       => 'personal/ui/dropdown',
    'page_param' => ['tab' => 2, 'reset' => 1],
    'caption'    => cb_msg('grn.personal.ui', 'dropdown-history'),
    'selected'   => 0,
    'tab_id'     => 'tab_history',
    'file'       => 'personal/ui/dropdown-history.tpl',
];

$tabs[3]
    = [
    'page'       => 'personal/ui/dropdown',
    'page_param' => ['tab' => 3, 'reset' => 1],
    'caption'    => cb_msg('grn.personal.ui', 'dropdown-mygroup'),
    'selected'   => 0,
    'tab_id'     => 'tab_mygroup',
    'file'       => 'personal/ui/dropdown-mygroup.tpl',
];


if ( ! array_key_exists('tab', $G_INPUT)) {
    $tab = 0;
} else {
    $tab = $G_INPUT['tab'];
}


switch ($tab) {
    case 1:
        require_once('_dropdown-facilitygroup.csp');
        $tabs[1]['selected'] = 1;
        break;
    case 2:
        require_once('_dropdown-history.csp');
        $tabs[2]['selected'] = 1;
        break;
    case 3:
        require_once('_dropdown-mygroup.csp');
        $tabs[3]['selected'] = 1;
        break;
    case 0:
    default:
        require_once('_dropdown-group.csp');
        $tabs[0]['selected'] = 1;
        break;
}
$t->assign('tabs', $tabs);
$t->assign('tab', $tab);

$t->assign('is_schedule_available', $is_schedule_available);

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

$t->display(cb_get_pagename() . '.tpl');
