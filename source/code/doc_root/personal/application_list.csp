<?php

use grn\grn\access\service\AppAccess;

require_once("grn/smarty.csp");
$main = new GRN_Smarty;

$selected_app = cb_at($G_INPUT, 'app_id');

require_once('grn/application_util.csp');
$util = GRN_ApplicationUtil::getInstance();
$menu = $util->getPersonalConfigMenu();

if ( ! is_array($menu) || 0 == count(@ $menu[$selected_app])) {
    $selected_app = null;
}

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();

// page title
$positions = [
    [
        'page' => 'index',
        'name' => cb_msg('grn/personal', 'toppage')
    ]
];
if ($selected_app) {
    $positions[] = [
        'page' => 'personal/application_list',
        'name' => grn_get_current_page_display_name()
    ];
    $app = $locator->getInstance($selected_app);
    $page_title = $app->getName();
} else {
    $page_title = grn_get_current_page_display_name();
}

$positions[] = ['page' => '', 'name' => $page_title];
$main->assign('page_title', $page_title);
$main->assign('site_position', $positions);

$t = new GRN_Smarty;

if (array_key_exists('workflow', $menu)) {
    cb_require_role("LoginUser");
    $app = $locator->getInstance('workflow');
    if ( ! $app->isAvailableFor(cb_get_login_user())) {
        unset($menu['workflow']);
    }
}
$applications = [];
foreach (array_keys($menu) as $app_id) {
    $app = $locator->getInstance($app_id);
    if ($app) {
        $applications[$app_id] = $app->getName();
    }
}
$t->assign('applications', $applications);

require_once('fw/i18n.csp'); // for cb_msg
if (array_key_exists($selected_app, $menu)) {
    $t->assign('selected_app', $selected_app);

    $app_menu = $menu[$selected_app];
    $config_categories = array_keys($app_menu);
    $t->assign('categories', $config_categories);

    $config_data = [];
    foreach ($app_menu as $category_name => $category) {
        $category_items = [];
        foreach ($category as $item_config) {
            assert('array_key_exists("page", $item_config)');
            $item = [];
            $item['page'] = $item_config['page'];
            if (array_key_exists('name', $item_config)) {
                $item['name'] = $item_config['name'];
            } else {
                $item['name'] = grn_get_page_display_name($item['page']);
            }
            if (array_key_exists('icon', $item_config)) {
                $item['icon'] = $item_config['icon'];
            } else {
                $item['icon'] = 'general32';
            }
            $category_items[] = $item;
        }

        $cat_item = [];

        $app_name = $locator->getName($selected_app);
        $cat_item['name'] = cb_plain_msg('grn.' . $selected_app,
            $category_name,
            ['application_name' => $app_name]);
        $cat_item['items'] = $category_items;
        $config_data[] = $cat_item;
    }
    $t->assign('config_data', $config_data);
}

$contents = $t->fetch('personal/_application_list.tpl');

// Smarty実行
$main->assign('contents', $contents);
$main->display('personal/application_list.tpl');


