<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

require_once('grn/calendar.csp');
$cm = GRN_CalendarManager::getInstance();
$calendars = $cm->listSystemCalendarNames();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

$shared_cids = $cm->getPreferenceSharedCalendar($login);

$shared_calendars = [];
foreach (array_keys($calendars) as $cid) {
    if (in_array($cid, $shared_cids)) {
        $shared_calendars[$cid] = $calendars[$cid];
    }
}

$cs = GRN_CalendarService::getInstance();
$extensions = $cs->listExtensions();
$for_view_extensions = [];
foreach ($extensions as $extension) {
    $prop = $cs->getExtensionProperties($extension, $login);
    /**
     * @var $logic plugin_grn_common_calendar_weather|plugin_grn_common_calendar_six_kinds_of_day
     */
    $logic = $cs->getLogic($extension);
    $config = $logic->getDisplayItemInfo($prop);
    $for_view_extensions[$extension] = $config;
}
require_once('fw/i18n/base.csp');
$user_base_setting = CB_BaseManager::getCurrentBaseSetting($login->getOID());
$user_base_calendars = $user_base_setting->toViewArray();

$t->assign('user_base_calendars', $user_base_calendars);
$t->assign('extensions', $for_view_extensions);
$t->assign('shared_calendars', $shared_calendars);
$t->assign('calendars', $calendars);

$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$t->assign(
    'site_position',
    [
        ['page' => "", 'name' => $page_title],
    ]
);

$t->display(cb_get_pagename() . '.tpl');


