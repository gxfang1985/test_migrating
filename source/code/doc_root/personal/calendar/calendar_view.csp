<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

require_once('grn/calendar.csp');
$cm = GRN_CalendarManager::getInstance();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
$c = $cm->getPreferenceUserCalendar($login);

$date = new CB_Date;
$bdate = (int)@$G_INPUT['bdate'];
if ($bdate > 0) {
    $year = $bdate;
} else {
    $d = getdate();
    $year = $d['year'];
}
$date->year = $year;
$date->month = 1;
$date->day = 1;

$date_begin = $date;
$date_end = new CB_Date;
$date_end->year = $date_begin->year;
$date_end->month = 12;
$date_end->day = 31;

$selected = [];
$rowset = $c->getDaysInfo($date_begin, $date_end);
while ($row = $rowset->iterate()) {
    $d = $row->get('date');
    $selected['event'][] = [
        'id'     => $row->getOID(),
        'date'   => $d,
        'type'   => $row->get('type'),
        'detail' => $row->get('info')
    ];
}

$rowset = new CB_RowSet($c->getAttributeTable());
$condition = $rowset->queryf("col_calendar='@S'", $c->getOID());
$rowset->addCondition($condition);
$count_rows = $rowset->count();
$not_exist = ! (0 < $count_rows);

$t->assign('selected', $selected);
$t->assign('bdate', $date);
$t->assign('not_exist', $not_exist);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$delete_info_all = [
    'title'         => grn_get_page_display_name('personal/calendar/event_delete_all'),
    'page'          => 'personal/calendar/event_delete_all.tpl',
    'no_confirm'    => false,
    'data'          => [
        'bdate' => $bdate
    ],
    'handler'       => 'lnk_delete_all',
    'before_delete' => 'get_all_checkbox',
];
$t->assign('delete_info_all', $delete_info_all);
$delete_info_multi = [
    'title'        => grn_get_page_display_name('personal/calendar/event_delete_multi'),
    'page'         => 'personal/calendar/event_delete_multi.tpl',
    'no_confirm'   => false,
    'data'         => [
        'bdate' => $bdate
    ],
    'handler'      => 'lnk_delete_multi',
    'multi_target' => 'eid[]',
    'form_target'  => 'personal/calendar/calendar_view',
];
$t->assign('delete_info_multi', $delete_info_multi);
// set site position
$t->assign(
    'site_position',
    [
        ['page' => "", 'name' => $page_title],
    ]
);

// Smarty実行
$t->display(cb_get_pagename() . ".tpl");

