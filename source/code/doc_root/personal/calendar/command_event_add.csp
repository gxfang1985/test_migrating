<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    // force to register
    $target_name = 'personal/calendar/event_add';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        $type = @$G_INPUT['type'];
        $detail = @$G_INPUT['detail'];

        $date = new CB_Date;
        $date->year = @$G_INPUT['year'];
        $date->month = @$G_INPUT['month'];
        $date->day = @$G_INPUT['day'];

        require_once('fw/string_util.csp');
        $detail = cb_trim($detail);
        if (mb_strlen($detail) <= 0) {
            cb_throw_error(E_GRN_CALENDAR_NOT_CONTENTS);
        }

        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();

        require_once('grn/calendar.csp');
        $cm = GRN_CalendarManager::getInstance();
        $c = $cm->getPreferenceUserCalendar($login);
        if ( ! $c) {
            cb_throw_error(E_GRN_CALENDAR_CALENDAR_NOT_FOUND);
        }
        $c->addDayInfo($date, $type, $detail);

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        cb_redirect('personal/calendar/calendar_view',
            ['bdate' => $date->year]);
    } else {
        // include sharing codes with command_*
        include('_event_add.csp');

        //Assign Template Name
        $t->setPageInfo($target_name);

        $t->display($target_name . '.tpl');
    }
}


