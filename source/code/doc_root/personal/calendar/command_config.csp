<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('grn/calendar.csp');
    $cs = GRN_CalendarService::getInstance();

    global $G_INPUT;
    $shared_calendar_ids = array_key_exists('sITEM', $G_INPUT)
        ? $G_INPUT['sITEM'] : [];
    if ( ! is_array($shared_calendar_ids) || count($shared_calendar_ids) == 0) {
        $shared_calendar_ids = [];
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    $cm = GRN_CalendarManager::getInstance();

    // 併用するカレンダー の設定
    foreach ($shared_calendar_ids as $scid) {
        $c = $cm->getSystemCalendar($scid);
        if ( ! $c) {
            cb_throw_error(E_GRN_CALENDAR_CALENDAR_NOT_FOUND);
        }
    }
    $cm->setPreferenceSharedCalendar($login, $shared_calendar_ids);

    // 拡張項目の設定
    $extensions = $cs->listExtensions();
    foreach ($extensions as $extension) {
        /**
         * @var $logic plugin_grn_common_calendar_weather|plugin_grn_common_calendar_six_kinds_of_day
         */
        $logic = $cs->getLogic($extension);
        if ( ! $logic->isAvailable()) {
            continue;
        }
        $parameter = $cs->parseParameter($G_INPUT, $extension . '_');
        $cs->setExtensionProperties($extension, $parameter, $login);
    }
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $sm->destroy(GRN_CALENDAR_MODULEID);

    cb_redirect('personal/common_list', ['id' => 'calendar']);
}


