<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('dezielink/system_logic.csp');
$dezie_system_logic = GRN_DezieLink_SystemLogic::getInstance();

if ($dezie_system_logic->getConnectorAvailable()
    && $dezie_system_logic->getPortletAvailable()
) {
    // get params
    $params = null;
    $dezie_for_view = null;
    if (array_key_exists('settings', $portlet)) {
        $params = $portlet['settings'];
    }

    $t->assign('portlet_id', $portlet['plid']);
    $t->assign('dz_params', $params);

    require_once('dezielink/portlet_logic.csp');
    $dezie_portlet_logic = GRN_DezieLink_PortletLogic::getInstance();

    // get dezie URL from system
    $get_url = $dezie_system_logic->getURL();

    //-- set page title and site position
    //Set Page Title
    if ($portlet['title'] === '') {
        require_once('grn/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();
        $app_name = $app_locator->getName('dezielink');
        $page_title = cb_plain_msg('grn.dezielink', 'portlet_view',
            ['app_name' => $app_name]);
        if ( ! $get_url || 0 >= strlen($params)) {
            $page_title .= ' - ' . cb_plain_msg('grn.dezielink',
                    'grn_dezielink_portlet_url_not_set');
        }
    } else {
        $page_title = $portlet['title'];
        if ( ! $get_url || 0 >= strlen($params)) {
            $page_title .= ' - ' . cb_plain_msg('grn.dezielink',
                    'grn_dezielink_portlet_url_not_set');
        }
    }

    // Assign page title
    $t->assign('page_title', $page_title);
    // parse parameter of the URL
    $parameters = parse_str($params, $output);
    $dezie_did_value = array_key_exists('did', $output) ? $output['did'] : null;
    $parameters = 'page=DBView&' . 'did=' . $dezie_did_value;
    $idx = strpos($get_url, '?');
    if ($idx === false) {
        $get_url .= '?';
    } else {
        $get_url = substr($get_url, 0, $idx + 1);
    }
    $get_url .= $parameters;
    // Assign url to connect to Dezie library
    $t->assign('url', $get_url);
    // Ignore Licence Warnning
    $t->skipWarning();

    // Display Smarty Template
    $t->display('dezielink/portlet/view.tpl');

}
    

