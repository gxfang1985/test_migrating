<?php
if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('dezielink/system_logic.csp');
    $sys_logic = GRN_DezieLink_SystemLogic::getInstance();

    $connector_available = $sys_logic->getConnectorAvailable();
    if ( ! $connector_available) {
        require_once('dezielink/error_code.csp');
        //デヂエ連携の設定が「使用しない」設定になっている場合
        cb_throw_error(E_GRN_DZLK_APP_DISABLED);
    }

    $url = $sys_logic->getURL();

    require_once('dezielink/sync_user_logic.csp');
    $sync_logic = GRN_DezieLink_SyncUserLogic::getInstance($url);

    require_once('dezielink/sync_user_manager.csp');
    $sync_man = GRN_Connector_SyncUserManager::getInstance();
    $sync_man->setSyncLogic($sync_logic);

    $sync_man->runSync();

    //Sync OK Logging
    require_once('dezielink/inspection.csp');
    $logger = GRN_Dezielink_Inspection::getInstance();

    if ($logger->isEnabled()) {
        $log_params = ['url' => $url];
        $logger->writeInspectionLogNotice(GRN_CONNECTOR_SYNC,
            GRN_DZLK_LOGGER_MESSAGE_SYNC_USER, $log_params);
    }

    //Page redirect
    cb_redirect('dezielink/system/dz_link_view');
}
