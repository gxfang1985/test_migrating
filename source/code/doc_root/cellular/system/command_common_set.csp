<?php

require_once('cellular/config.csp');
$config = GRN_Cellular_SystemConfig::getInstance();

require_once('cellular/utils.csp');

$selected_items = [
    'isDisplayItem' => 0,
    'items'         => ['', '']
];

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $display_item = @$G_INPUT['display_user_item'];
    if ($display_item == '' || $display_item == '0') {
        $selected_items['isDisplayItem'] = 0;
    } else {
        $selected_items['isDisplayItem'] = 1;
        $field = @$G_INPUT['display_field1'];
        if ( ! validateField($field)) {
            $field = '';
        }
        $selected_items['items'][0] = $field;

        $field = @$G_INPUT['display_field2'];
        if ( ! validateField($field)) {
            $field = '';
        }
        $selected_items['items'][1] = $field;
    }

    $config->setDisplayedUserItemsAsSearchResult($selected_items);

    //GRN35-652
    $selected_items = [];
    if (array_key_exists("checkbox_allow_auto_login", $G_INPUT)) {
        $selected_items['allow_auto_login'] = 1;
    } else {
        $selected_items['allow_auto_login'] = 0;
    }
    $config->setAllowAutoLogin($selected_items);
    //GRN35-652
    cb_redirect('system/application_list', ['app_id' => 'cellular']);
} else {
    cb_redirect('system/cellular/common_set');
}

function validateField($field_name)
{
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();

//    var_dump( getDisplayExtensionItemList($login, array( 'use', 'show') ) );die();

    if (array_search($field_name, getDisplayDefaultItemIdsList(['use', 'show']))
        !== false
        || array_key_exists($field_name,
            getDisplayExtensionItemList($login, ['use', 'show']))
        || $field_name === ''
    ) {
        return true;
    }

    return false;
}
