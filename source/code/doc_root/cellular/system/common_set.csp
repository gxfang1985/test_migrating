<?php
//require_once( 'grn/file.csp' );
global $G_INPUT;

require_once('cellular/utils.csp');

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$items = [['' => getNoneChoice()], ['' => getNoneChoice()]];

foreach (getDisplayDefaultItemIdsList(['use', 'show']) as $item_id) {
    if ($item_id == 'display_name' || $item_id == 'image') {
        continue;
    }

    $items[0][$item_id] = [
        'selected' => false,
        'name'     => $uum->getRealDefaultItemName($item_id)
    ];
    $items[1][$item_id] = [
        'selected' => false,
        'name'     => $uum->getRealDefaultItemName($item_id)
    ];
}

foreach (
    getDisplayExtensionItemList($login, ['use', 'show']) as $item_id =>
    $item_value
) {
    if ($item_value['type'] == 'image_url' || $item_value['type'] == 'file') {
        continue;
    }

    $items[0][$item_id] = [
        'selected' => false,
        'name'     => $item_value['display_name']
    ];
    $items[1][$item_id] = [
        'selected' => false,
        'name'     => $item_value['display_name']
    ];
}

require_once('cellular/config.csp');
$config = GRN_Cellular_SystemConfig::getInstance();
$selected_items = $config->getDisplayedUserItemsAsSearchResult();
//GRN35-652
$allow_auto_login = $config->getAllowAutoLogin();
$t->assign('allow_auto_login', $allow_auto_login);
//GRN35-652

$t->assign('is_user_item', $selected_items['isDisplayItem']);

//設定後、カスタマイズ項目を削除するなどして、設定した項目が選択肢にないときは
//「なにも表示しない」を選択した状態にする
foreach (array_keys($items) as $key) {
    if (array_key_exists($selected_items['items'][$key], $items[$key])) {
        $items[$key][$selected_items['items'][$key]]['selected'] = true;
    } else {
        $items[$key]['']['selected'] = true;
    }
}
// check display presence
require_once('presence/logic.csp');
$presence_logic = GRN_Presence_Logic::getInstance();
// hide 在席情報 item
if ( ! $presence_logic->isActivePresence()) {
    unset($items[0]['attendee']);
    unset($items[1]['attendee']);
}
$t->assign('items', $items);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$t->assign('site_position', [
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

function getNoneChoice()
{
    return [
        'name'  => cb_msg('grn.cellular.system', 'none_user_item'),
        'value' => ''
    ];
}


