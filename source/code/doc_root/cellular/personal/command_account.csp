<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    //-- prepare
    $target_page = 'cellular/personal/account';

    //-- instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //-- Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    // register the target_form, or you get an error if you go back to the previous page by using 
    // your browser 'back' button
    SmartyValidate::register_form($target_page);

    //-- validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_page)) {

        //-- get parameters
        $password = @ $G_INPUT['password'];

        //-- modify cellular password
        global $G_container_app;
        $uum =& $G_container_app->getInstance('uum');
        require_once('grn/uum_util.csp');
        $uum_util = GRN_UumUtil::getInstance();
        $login = $uum->getLoginUser();
        $uid = $login->getOID();

        /**
         * if ( $uum_util->isValidPassword( $password ) )
         * {
         * $uum->changePassword( $uid, NULL, $password, TRUE );
         * }
         **/

        require_once('cellular/config.csp');
        $config = new GRN_Cellular_UserConfig($login);

        $config->setCellularMailAddress(@ $G_INPUT['cellular_address']);
        $config->setAvailability((@ $G_INPUT['suspension']) ? false : true);

        // the validation session is finished
        SmartyValidate::unregister_form($target_page);

        //-- completed
        cb_redirect('personal/application_list', ['app_id' => 'cellular']);
    } else {
        //-- if error, show the source form

        // page title
        $page_title = grn_get_page_display_name($target_page);
        $t->assign('page_title', $page_title);
        // site position
        $t->assign('site_position', [['page' => '', 'name' => $page_title]]);

        global $G_container_app;
        $uum =& $G_container_app->getInstance('uum');
        $login =& $uum->getLoginUser();

        $t->assign('account', [
                'uid'         => $login->getOID(),
                'name'        => $login->get('display_name'),
                'foreign_key' => $login->get('foreign_key'),
                'address'     => @ $G_INPUT['cellular_address'],
                'available'   => @ $G_INPUT['available']
            ]
        );

        //Assign Template Name
        $t->setPageInfo($target_page);

        $t->display($target_page . '.tpl');
    }

}


