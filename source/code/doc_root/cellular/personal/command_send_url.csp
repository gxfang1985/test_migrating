<?php

if (strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST') == 0) {
    require_once('grn/system_mail.csp');
    $system_mail = GRN_SystemMailConfigManager::getInstance();

    if ( ! $system_mail->isAvailable()) {
        require_once('cellular/error_code.csp');
        cb_throw_error(E_GRN_CELLULAR_SYSTEM_MAIL_NOT_AVAILABLE);
    }

    require_once('cellular/config.csp');
    $system_config = GRN_Cellular_SystemConfig::getInstance();

    $login_url = $system_config->getLoginUrl();

    if (is_null($login_url) || strlen($login_url) < 1) {
        require_once('cellular/error_code.csp');
        cb_throw_error(E_GRN_CELLULAR_LOGIN_URL_NOT_FOUND);
    }

    $login = cb_get_login_user();

    $config = new GRN_Cellular_UserConfig($login);

    $cellular_address = $config->getCellularMailAddress();

    if (is_null($cellular_address) || strlen($cellular_address) < 1) {
        require_once('cellular/error_code.csp');
        cb_throw_error(E_GRN_CELLULAR_CELLULAR_MAIL_NOT_FOUND);
    }

    $sender = $system_mail->getSystemMailSender();

    if ( ! is_object($sender)) {
        require_once('cellular/error_code.csp');
        cb_throw_error(E_GRN_CELLULAR_SYSTEM_MAIL_NOT_AVAILABLE);
    }

    // システムメールアカウントからケータイへログインURLを送信

    require_once('fw/mail_message.csp');
    $composer = new CB_MailComposer();

    $composer->setSubject(cb_msg('grn.cellular', 'login_mail_subject'));
    $composer->setFrom(new CB_MailAddress($system_mail->getMailAddress()));
    $composer->addTo(new CB_MailAddress($cellular_address));
    $composer->setTextBody($login_url);
    //GRN2-3236
    require_once("fw/i18n/locale.csp");
    $locale = CB_LocaleManager::getDefaultLanguage();
    //GRN2-3236

    $message = $composer->getMailMessage();
    $messages = [& $message];
    $sender->sendMails($messages, $locale);

    $sender->commit();
    $sender->disconnect();

    cb_redirect('personal/application_list', ['app_id' => 'cellular']);
}


