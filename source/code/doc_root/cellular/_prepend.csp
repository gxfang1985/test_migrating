<?php

use grn\grn\access\service\AppAccess;

require_once('cellular/prepend.csp');

// app
global $G_cellular;
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
/** @var GRN_Cellular $G_cellular */
$G_cellular = $locator->getInstance('cellular');
unset($locator);

// LoginUser
global $G_cellular_login;
global $G_uum;
global $G_container_app;
$G_uum = $G_container_app->getInstance('uum');
$G_cellular_login = $G_uum->getLoginUser();

if (is_a($G_cellular_login, "CB_User")) {
    // ユーザーのケータイ利用許可（個人設定）をチェック
    require_once('cellular/config.csp');
    $uc = new GRN_Cellular_UserConfig($G_cellular_login);
    if ( ! $uc->getAvailability()) {
        require_once('cellular/error_code.csp');
        cb_throw_error(E_GRN_CELLULAR_UNDER_SUSPENSION);
    }
    unset($uc);

    // アクセスするアプリをチェック
    // ケータイへのアクセスはgrn/prepend.cspでチェックされている
    global $G_INPUT;
    if (isset($G_INPUT['p'])) {
        if (strpos($G_INPUT['p'], '.') !== false
            || strpos($G_INPUT['p'], "\0") !== false
        ) {
            cb_throw_error('FW00043');
        }

        $pages = explode('-', $G_INPUT['p']);
        if (count($pages) > 0 && $pages[0] != 'cellular') {
            $app_id = $pages[0];

            require_once('grn/application.csp');
            $locator = GRN_ApplicationLocator::instance();

            if ($app = $locator->getInstance($app_id)) {
                AppAccess::checkAccess($app_id);

            } else {
                require_once('grn/error_code.csp');
                cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
            }
            unset($app_id, $locator, $app);
        }
        unset($pages);

        // アプリ画面ではコピーライトを表示しない
        global $G_state_set;
        $G_state_set->set('copyright_should_be_written', false);
    }
}


