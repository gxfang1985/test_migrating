<?php
//GTM-129 for server side customization

//force to set cybozu mode
global $G_config_common;
$G_config_common->set('Global', 'php', 'cybozu');

if (cb_is_rest_api()) {
    $page_name = 'api.csp';
} else {
    $page_name = cb_get_pagename();
    if (substr($page_name, -4) !== '.csp') {
        //to make a file name, add extension to the tail of the page name
        $page_name .= '.csp';
    }
}

require_once('grn/CustomUtil.csp');
$custom_util = GRN_Custom_Util::getInstance();

$loaded = false;

if ($custom_util->isCustomized() === true) {
    // load customized file
    $loaded = $custom_util->loadCustomCsp($page_name);
}

if ($loaded === false) {
    $page = cb_basedir() . "/code/doc_root/" . $page_name;
    if (is_readable($page) === false || $page_name === 'root.csp') {
        require_once('fw/error_code.csp');
        cb_throw_error(E_COMMON_URL_INVALID, null,
            ['page' => $_SERVER['PHP_SELF']]);
    }
    $pos = strrpos($page, "/");
    // move to the directory of application's doc_root
    chdir(substr($page, 0, $pos));
    // include standard file
    include $page;
}
