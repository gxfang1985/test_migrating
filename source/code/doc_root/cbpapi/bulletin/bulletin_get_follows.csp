<?php
if (isset($cbpapi_service)) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    // get parameters of SOAP message
    $request = $cbpapi_service->getRequestParameters();
    // check for required fields
    $required_fields = ['topic_id', 'offset', 'limit'];
    foreach ($required_fields as $field) {
        if ( ! isset($request['attributes'][$field])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => $field]);
        }
    }
    $topic_id = $request['attributes']['topic_id'];
    $offset = intval($request['attributes']['offset']);
    $limit = intval($request['attributes']['limit']);
    require_once('bulletin/article.csp');
    $obj_article = GRN_Bulletin_ArticleManager::getInstance();
    if ( ! ($article = $obj_article->getArticle($login, $topic_id,
        GRN_BULLETIN_ACCESS_R, true, CB_DATABASE_NO_LOCK))
    ) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }
    if ( ! $article->isPublished()) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }
    // フォロー
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
    require_once('bulletin/follow_util.csp');
    $list = new GRN_Bulletin_FollowList($login, $article);
    $list->setOffset($offset);
    $list->setLimit($limit);
    $list->setLockMode(CB_DATABASE_NO_LOCK);
    $article_follows_list = [];

    while ( ! is_null(($row = $list->iterate()))) {
        $follow = [];
        $follow = $utility->getFollowView($login, $row);
        $ctime = $follow['ctime'];
        require_once('cbpapi/util.csp');
        // create date
        $create_date = grn_cbpapi_iso8601($ctime);
        $follow['creator_date'] = $create_date;
        $follow['topic_id'] = $topic_id;
        $article_follows_list[$row->getOID()] = $follow;
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('follows', $article_follows_list);

    grn_cbpapi_response($t, __FILE__);
}

