<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    if ( ! isset($request['attributes']['file_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'file_id']);
    }
    $file_id = $request['attributes']['file_id'];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);

    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();
    $app = $locator->getInstance('bulletin');
    $app_name = $app->getName();

    require_once('cbpapi/bulletin_logic.csp');
    $logic = GRN_CBPApi_Bulletin_Logic::getInstance();
    $file = $logic->getFileRelation($login, $file_id);
    if ( ! $file) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
    }
    /** @var GRN_Bulletin_FileBody $body */
    $body = $file->getCurrentBody();
    if ( ! $body) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_FILE_LOG_NOT_FOUND);
    }
    // logging
    require_once('bulletin/table.csp');
    grn_bulletin_write_log("download", "file", [
        'uid'     => $login->getOID(),
        'fid'     => $file->getOID(),
        'version' => $file->get('version'),
        'name'    => $body->get('name')
    ], 'info');

    $file_content = base64_encode($body->getContents());

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('file_content', $file_content);
    grn_cbpapi_response($t, __FILE__);
}

