<?php
if (isset($cbpapi_service)) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    $topics_node = $cbpapi_service->selectNodes($node_parameters, 'topics');
    if ( ! $topics_node) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'topic_id']);
    }

    foreach ($topics_node as $topic) {
        $topic_for_view = [];
        $attributes = array_key_exists('attributes', $topic)
            ? $topic['attributes'] : [];
        $topic_id = array_key_exists('topic_id', $attributes)
            ? $attributes['topic_id'] : null;
        if ( ! $topic_id) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'topic_id']);
        }
        $is_draft = array_key_exists('is_draft', $attributes)
            ? $attributes['is_draft'] : null;
        if ( ! $is_draft) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'is_draft']);
        }
        if ($is_draft == 'true') {
            $is_draft = true;
        } else {
            $is_draft = false;
        }
        if ( ! $is_draft) {
            require_once('bulletin/article.csp');
            $obj_article = GRN_Bulletin_ArticleManager::getInstance();
            if ( ! ($article = $obj_article->getArticle($login, $topic_id))) {
                cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
            }
            $article->delete($login);
        } else {
            require_once('bulletin/draft.csp');
            $obj_draft = GRN_Bulletin_DraftManager::getInstance();
            if ( ! ($draft = $obj_draft->getDraft($login, $topic_id))) {
                cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
            }
            $draft->delete($login);
        }
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);

    grn_cbpapi_response($t, __FILE__);
}
