<?php
require_once('cbpapi/error_code.csp');
if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();

    // start and end date
    $startdate = @$node_parameters['attributes']['start'];
    $enddate = @$node_parameters['attributes']['end'];
    if ( ! isset($startdate)) {
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'start']);
    }

    require_once('cbpapi/util.csp');
    $startdatetime = grn_cbpapi_parse_iso8601($startdate);
    $enddatetime = null;
    if ($enddate) {
        $enddatetime = grn_cbpapi_parse_iso8601($enddate);
        if ( ! $startdatetime || ! $enddatetime) {
            require_once('fw/error_code.csp');
            cb_throw_error(E_COMMON_INVALID_DATETIME);
        }
        $startdatetime_ex = new CB_DateTimeEx($startdatetime);
        if ($startdatetime_ex->compare($enddatetime) > 0) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_INVALID_TERM,
                ['app_name' => cb_msg('grn.bulletin', 'application_name')]);
        }
    }

    $starttimestamp = null;
    $endtimestamp = null;
    require_once('cbpapi/bulletin_logic.csp');
    $cbpapi_bulletin_logic = GRN_CBPApi_Bulletin_Logic::getInstance();
    $starttimestamp = convert_datetime_to_timestamp($startdatetime);
    $endtimestamp = convert_datetime_to_timestamp($enddatetime);

    $folder_ids = [];
    // category
    $children = array_key_exists('children', $node_parameters)
        ? $node_parameters['children'] : null;
    if (count($children) > 0) {
        foreach (array_keys($children) as $children_key) {
            $node = $children[$children_key]['node_name'];
            if ($node == 'category_id') {
                $folder_id = array_key_exists('text', $children[$children_key])
                    ? $children[$children_key]['text'] : '';
                if (is_numeric($folder_id)) {
                    $folder_ids[] = $folder_id;
                }
            }
        }
    }
    $topics_version_list
        = $cbpapi_bulletin_logic->getTopicVersionList($folder_ids,
        $starttimestamp, $endtimestamp);

    // item version
    require_once('cbpapi/util.csp');
    $item_name = 'topic_item';
    $items_version = grn_cbpapi_parse_item_versions($node_parameters,
        $item_name);
    $topics_for_view = grn_cbpapi_compare_item_versions($items_version,
        $topics_version_list);

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('topics', $topics_for_view);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}


