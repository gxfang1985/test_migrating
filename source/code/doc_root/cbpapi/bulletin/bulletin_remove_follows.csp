<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $follow_id_list = $cbpapi_service->selectNodesValue($request, 'follow_id');
    if ( ! isset($follow_id_list)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'follow_id']);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);

    require_once('bulletin/follow.csp');
    $follow_manager = GRN_Bulletin_FollowManager::getInstance();
    foreach ($follow_id_list as $follow_id) {
        require_once('bulletin/error_code.csp');
        if ( ! is_numeric($follow_id)) {
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }

        $row = $follow_manager->_tab_follow->getRow($follow_id);
        if ( ! $row) {
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }
        $factory = GRN_Bulletin_FollowFactory::getInstance();
        $follow = $factory->row2object($row);

        $follow->delete($login);
    }
    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);

    grn_cbpapi_response($t, __FILE__);
}
