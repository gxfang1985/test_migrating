<?php
if (isset($cbpapi_service)) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    $category_ids = [];
    $category_ids = $cbpapi_service->selectNodesValue($node_parameters,
        'category_id');

    if ( ! $category_ids) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'category_id']);
    }
    $categories_for_view = [];
    foreach ($category_ids as $category_id) {
        $articles_for_view = [];
        if ( ! is_numeric($category_id)) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
        }

        if ($category_id == -1) {
            require_once('bulletin/article_util.csp');
            require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

            $conditionObj = new GrnBulletinArticleCondition();
            $conditionObj->setUser($login);
            $conditionObj->setArticleTerm('before');
            $conditionObj->setPersonal(true);

            $coll = new GRN_Bulletin_ArticleBeforeList($conditionObj);

            $articles_for_view['category_id'] = $category_id;
            $articles_for_view['topics'] = $coll->listDatas();
        } elseif ($category_id == -2) {
            require_once('bulletin/controller.csp');
            $utility = new GRN_Bulletin_ControllerUtil();
            require_once('bulletin/draft_util.csp');
            $coll = new GRN_Bulletin_DraftList($login);
            $articles_for_view['category_id'] = $category_id;
            while (($draft = $coll->iterate())) {
                $articles_for_view['topics'][$draft->getOID()]
                    = $utility->getArticleListView($login, $draft, false);
            }
        } else {
            $category = null;
            require_once('bulletin/category.csp');
            $category_manager = GRN_Bulletin_CategoryManager::getInstance();
            if ( ! $category = $category_manager->getCategory($login,
                $category_id)
            ) {
                require_once('bulletin/error_code.csp');
                cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
            }
            unset($category_manager);
            require_once('bulletin/article_util.csp');
            require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

            $conditionObj = new GrnBulletinArticleCondition();
            $conditionObj->setUser($login);
            $conditionObj->setCategory($category);

            $list = new GRN_Bulletin_ArticleList($conditionObj);
            $list->setLockMode(CB_DATABASE_NO_LOCK);
            $articles = $list->searchExecute(false);
            $total_count = $list->count();
            if ($total_count > 0) {
                $articles_for_view['category_id'] = $category_id;
                $articles_for_view['topics']
                    = $list->createDisplayArticleData($articles);
                unset($articles);
            }
        }

        $categories_for_view[$category_id] = $articles_for_view;
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('categories', $categories_for_view);

    grn_cbpapi_response($t, __FILE__);
}

