<?php
if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    $topics_node = $cbpapi_service->selectNodes($node_parameters, 'topics');
    if ( ! $topics_node) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'topic_id']);
    }
    require_once('cbpapi/bulletin_logic.csp');
    $bulletin_logic = GRN_CBPApi_Bulletin_Logic::getInstance();
    $topics_for_view = [];
    foreach ($topics_node as $topic) {
        $topic_for_view = [];
        $attributes = array_key_exists('attributes', $topic)
            ? $topic['attributes'] : [];
        $topic_id = array_key_exists('topic_id', $attributes)
            ? $attributes['topic_id'] : null;
        if ( ! $topic_id) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'topic_id']);
        }
        $is_draft = array_key_exists('is_draft', $attributes)
            ? $attributes['is_draft'] : null;
        if ( ! $is_draft) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'is_draft']);
        }
        if ($is_draft == 'true') {
            $is_draft = true;
        } else {
            $is_draft = false;
        }

        $topic_for_view = $bulletin_logic->getTopicForViewByIds($login,
            [$topic_id], $is_draft);
        $topics_for_view[$topic_id] = $topic_for_view;
    }

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('topics', $topics_for_view);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}

