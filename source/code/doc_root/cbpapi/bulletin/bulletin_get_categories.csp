<?php
if (isset($cbpapi_service)) {
    require_once('fw/string_util.csp');
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    $category = null;
    require_once('bulletin/category.csp');
    $category_manager = GRN_Bulletin_CategoryManager::getInstance();
    if ( ! ($category = $category_manager->getRootCategory($login))) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    unset($category_manager);

    //XML書出用の配列
    $xml_map = api_get_xml_maps();

    //バッファに出力する。
    ob_start();

    //Open XML Document
    $xml_writer = new XMLWriter();
    $xml_writer->openURI("php://output");
    $xml_writer->startDocument('1.0', 'UTF-8');

    // START XML書出し 
    $xml_writer->startElement('categories');
    $xml_writer->startElement('root');

    $xml_writer->writeAttribute('id', $category->getOID());
    $xml_writer->writeAttribute('code',
        cb_remove_invalid_xml_chars($category->get('foreign_key')));

    api_write_category($xml_writer, $login, $category, $xml_map);

    $xml_writer->endElement();
    $xml_writer->endElement();

    //End XML Document
    $xml_writer->endDocument();
    $xml_writer->flush();

    //バッファからXMLを得る
    $result = ob_get_clean();

    //先頭のXML宣言を切り取る
    if (strpos($result, '<?xml version="1.0" encoding="UTF-8"?>') == 0) {
        $result = substr($result,
            strlen('<?xml version="1.0" encoding="UTF-8"?>'), strlen($result));
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('bulletin')]);
    $t->assign('category_info', $result);

    grn_cbpapi_response($t, __FILE__);

}


/**
 * export bulletin category information to xml
 */
function api_write_category($xml_writer, $login, $category, &$xml_map)
{
    // category Data
    api_write_category_data($xml_writer, $category, $xml_map);

    $children = $category->getCategories($login, GRN_BULLETIN_ACCESS_R);

    if ($children) {
        api_write_categories_element_start($xml_writer,
            $category);                 // categories start

        foreach (array_keys($children) as $hid) {
            $child =& $children[$hid];
            api_write_category_element_start($xml_writer,
                $child);          // category start
            // Data部 書出し (自身を呼び出す)
            api_write_category($xml_writer, $login, $child, $xml_map);

            api_write_category_element_end($xml_writer);                      // category end
        }

        api_write_categories_element_end($xml_writer);                             // categories end

    }
}

/**
 * <category>Element START
 * api_write_category_element_end
 *
 */
function api_write_category_element_start($xml_writer, $category)
{
    $xml_writer->startElement('category');                                    // category
    $xml_writer->writeAttribute('id', $category->getOID());
    $xml_writer->writeAttribute('code',
        cb_remove_invalid_xml_chars($category->get('foreign_key')));
    $xml_writer->writeAttribute('list_index', $category->get('list_index'));
}

/**
 * bulletin <category>Element
 *
 */
function api_write_category_data($xml_writer, $category, & $xml_map)
{
    // write category info data to array
    $xml_categoryinfo_map = api_get_category_info_array($category, $xml_map);

    api_xml_write_map_data($xml_writer, $xml_categoryinfo_map);

}

/**
 * bulletin <category>Element END
 * api_write_category_element_end
 *
 */
function api_write_category_element_end($xml_writer)
{
    $xml_writer->endElement();                                              // category
}

///////////////////////////////////


// folders /////////////////////////
function api_write_categories_element_start($xml_writer, $category)
{
    if ($category) {
        $xml_writer->startElement('categories');                                // sub categories
        $xml_writer->writeAttribute('parent_id', $category->getOID());
        $xml_writer->writeAttribute('parent_code',
            cb_remove_invalid_xml_chars($category->get('foreign_key')));
    }
}

function api_write_categories_element_end($xml_writer)
{
    $xml_writer->endElement();                                              // sub categories
}

//////////////////////////////////////


function api_get_category_info_array($category, &$xml_map)
{

    if ($category) {

        $xml_map['name']['value'] = $category->get("name");
        $xml_map['description']['value'] = $category->get("description");


        $xml_map['create_time']['value']
            = api_format_datetime($category->get("ctime"));
        $xml_map['modify_time']['value']
            = api_format_datetime($category->get("mtime"));

        $c_user = $category->get('creator');
        if ($c_user) {
            $xml_map['creator_id']['value'] = $c_user->getOID();
            $xml_map['creator_login_name']['value']
                = $c_user->get("foreign_key");
            $xml_map['creator_display_name']['value']
                = $c_user->get("display_name");
        } else {
            $xml_map['creator_login_name']['value']
                = $category->get("creator_foreign_key");
            $xml_map['creator_display_name']['value']
                = $category->get("creator_name");
        }

        $m_user = $category->get('modifier');
        if ($m_user) {
            $xml_map['modifier_id']['value'] = $m_user->getOID();
            $xml_map['modifier_login_name']['value']
                = $m_user->get("foreign_key");
            $xml_map['modifier_display_name']['value']
                = $m_user->get("display_name");
        } else {
            $xml_map['modifier_login_name']['value']
                = $category->get("modifier_foreign_key");
            $xml_map['modifier_display_name']['value']
                = $category->get("modifier_name");
        }
    }

    return $xml_map;

}


function api_xml_write_map_data($xml_writer, &$xml_map)
{
    // map item key and value
    foreach ($xml_map as $key => $val) {
        if (array_key_exists('writeType', $val)) {
            $xml_writer->startElement($key);

            if (strlen(@$val['value']) > 0) {
                if ($val['writeType'] === 'writeCDATA') {
                    require_once('fw/string_util.csp');
                    $val['value'] = cb_escape_cdata($val['value']);
                }
                call_user_func([$xml_writer, $val['writeType']],
                    cb_remove_invalid_xml_chars($val['value']));
            }

            $xml_writer->endElement();
        }
    }
}

// 日付の書式 2007-04-01T12:00:00+9:00 の形にする
function api_format_datetime($value)
{
    $val = null;

    if (is_a($value, 'cb_timestamp')) {
        $val = date('Y-m-d\TH:i:sO', $value->unix_ts);
    }

    return $val;
}

function api_get_xml_maps()
{
    // XML書出用の配列
    $xml_map = [
        'name'                  => ['item' => '0', 'writeType' => 'text'],
        'description'           => ['item' => '1', 'writeType' => 'writeCDATA'],
        'creator_id'            => ['item' => '2', 'writeType' => 'writeRaw'],
        'creator_login_name'    => ['item' => '3', 'writeType' => 'text'],
        'creator_display_name'  => ['item' => '4', 'writeType' => 'text'],
        'create_time'           => ['item' => '5', 'writeType' => 'text'],
        'modifier_id'           => ['item' => '6', 'writeType' => 'writeRaw'],
        'modifier_login_name'   => ['item' => '7', 'writeType' => 'text'],
        'modifier_display_name' => ['item' => '8', 'writeType' => 'text'],
        'modify_time'           => ['item' => '9', 'writeType' => 'text'],
    ];

    return $xml_map;
}
