<?php

use grn\grn\access\service\AppAccess;

if (isset($cbpapi_service)) {
    // get SOAP action
    $action = $cbpapi_service->getAction();
    $request_param = $cbpapi_service->getRequestParameters();
    $mygroup_ids = $cbpapi_service->selectNodesValue($request_param,
        'my_group_id');

    $mygroup_for_view = [];
    if (is_array($mygroup_ids) && count($mygroup_ids) > 0) {
        // ログインユーザーを取得する
        global $G_container_base;
        /** @var GRN_Uum $uum */
        $uum = $G_container_base->getInstance('uum');
        $login = $uum->getLoginUser();

        // Myグループ一覧を取得する
        $mygroup_rows = $uum->listMyGroups($login);
        $mygroup_list = [];
        foreach (array_keys($mygroup_rows) as $id) {
            $mygroup_row =& $mygroup_rows[$id];

            $mtime = $mygroup_row->get('mtime');
            if ( ! $mtime) {
                $mtime = new CB_TimeStamp();
            }
            $version = $mtime->unix_ts;

            $mygroup_list[$id] = [
                'key'         => $id,
                'name'        => $mygroup_row->get('name'),
                'version'     => $version,
                'description' => $mygroup_row->get('description'),
                'order'       => $mygroup_row->get('list_index'),
            ];
        }

        foreach ($mygroup_ids as $mgid) {
            if ( ! isset($mygroup_list[$mgid])) {
                require_once('grn/error_code.csp');
                cb_throw_error(E_GRN_PERSONAL_MYGROUP_NOT_FOUND);
            }

            $user_rows = $uum->getMyGroupUsers($mgid);
            $mygroup_for_view[$mgid] = $mygroup_list[$mgid];
            $mygroup_for_view[$mgid]['belong_member'] = array_keys($user_rows);

            $facility_ids = [];
            if (AppAccess::isAppAvailable('schedule')) {
                $facility_ids = $uum->getMyGroupFacilitiesId($mgid);
            }
            $mygroup_for_view[$mgid]['belong_facility'] = $facility_ids;
        }
    } else {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'my_group_id']);
    }

    //response SOAP message
    require_once("grn/smarty.csp");

    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('base')]);
    $t->assign('action', $action);
    $t->assign('mygroup', $mygroup_for_view);

    grn_cbpapi_response($t, __FILE__);
}

