<?php

if (isset($cbpapi_service)) {
    global $G_container_base;

    // get SOAP action
    $action = $cbpapi_service->getAction();

    // get parameters of SOAP request
    $request_params = $cbpapi_service->getRequestParameters();
    $user_item_request = grn_cbpapi_parse_item_versions($request_params,
        'user_item');

    // get user list
    $columns = ['_id', 'col_mtime'];
    $uum = $G_container_base->getInstance('uum');
    $users = $uum->getUsersInfo(null, $columns);
    foreach (array_keys($users) as $key) {
        $users[$key] = ['id' => $key, 'version' => $users[$key]['col_mtime']];
    }

    $user_item = grn_cbpapi_compare_item_versions($user_item_request, $users);

    //SOAP response 
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('common')]);
    $t->assign('action', $action);
    $t->assign('user_item', $user_item);

    grn_cbpapi_response($t, __FILE__);
}


