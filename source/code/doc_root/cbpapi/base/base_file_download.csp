<?php
if (isset($cbpapi_service)) {
    // get SOAP action
    $action = $cbpapi_service->getAction();
    $request_param = $cbpapi_service->getRequestParameters();

    if ( ! isset($request_param['attributes']['file_id'])) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'file_id']);
    }

    $file_id = $request_param['attributes']['file_id'];
    if ( ! is_numeric($file_id)) {
        cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
    }

    require_once('grn/file.csp');
    $file_manager = GRN_FileManager::getInstance();
    $table_info = $file_manager->getFileTable();
    $file = $table_info->getRow($file_id);

    if ( ! is_object($file) || ! is_a($file, 'GRN_File')) {
        cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
    }

    $version = $file->getVersion();
    /** @var GRN_FileBody $body */
    $body = $file->getBody($version);
    if ( ! is_object($body) || ! is_a($body, 'GRN_FileBody')) {
        cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
    }
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    if ( ! $uum->checkFileUserActive($file_id)) {
        cb_throw_error(E_GRN_USERFILE_NOT_FOUND);
    }
    $file_content = base64_encode($body->getContents());

    //response SOAP message
    require_once("grn/smarty.csp");

    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('base')]);
    $t->assign('action', $action);
    $t->assign('file_content', $file_content);

    grn_cbpapi_response($t, __FILE__);
}

