<?php

if (isset($cbpapi_service)) {
    global $G_container_base;

    // get SOAP action
    $action = $cbpapi_service->getAction();

    $request_params = $cbpapi_service->getRequestParameters();
    $mygroup_request = grn_cbpapi_parse_item_versions($request_params,
        'my_group_item');

    // get login user
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    // get mygroup list for version comparison
    $mygroup_rows = $uum->listMyGroups($login);
    $mygroup_list = [];
    foreach (array_keys($mygroup_rows) as $id) {
        $mygroup_row =& $mygroup_rows[$id];

        $mtime = $mygroup_row->get('mtime');

        if ( ! $mtime) {
            $mtime = new CB_TimeStamp();
        }

        $mygroup_list[$id] = [
            'id'      => $id,
            'version' => $mtime->unix_ts,
        ];
    }

    $mygroup_modified = grn_cbpapi_compare_item_versions($mygroup_request,
        $mygroup_list);

    //response SOAP message
    require_once("grn/smarty.csp");

    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('base')]);
    $t->assign('action', $action);
    $t->assign('mygroup', $mygroup_modified);

    grn_cbpapi_response($t, __FILE__);
}

