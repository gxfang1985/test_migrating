<?php

use grn\grn\access\utility\AppAvailabilityUtil;

if (isset($cbpapi_service)) {
    // get SOAP action
    $action = $cbpapi_service->getAction();

    require_once('grn/application.csp');
    require_once('workflow/resources.csp');
    require_once('report/resources.csp');

    // get application list
    $app_locator = GRN_ApplicationLocator::instance();
    $app_ids = AppAvailabilityUtil::getApplicationIds();
    $app_list = [];
    foreach ($app_ids as $app_id) {
        $app = $app_locator->getInstance($app_id, true);

        $application = [];
        $application['code'] = $app_id;
        $application['status'] = $app_locator->isActive($app_id) ? 'active'
            : 'deactive';

        if (strcmp($app_id, GRN_WORKFLOW_APPLICATION_ID) == 0) {
            // check license of Workflow
            if ( ! $app->isLicensed()) {
                $application['status'] = 'license_expired';
            }
        }

        if (strcmp($app_id, GRN_REPORT_APPLICATION_ID) == 0) {
            // check license of Report
            if ( ! $app->isLicensed()) {
                $application['status'] = 'license_expired';
            }
        }

        $app_list[$app_id] = $application;
    }
    unset($app_list["job"]);

    //response SOAP message
    require_once("grn/smarty.csp");

    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('base')]);
    $t->assign('action', $action);
    $t->assign('app_list', $app_list);

    grn_cbpapi_response($t, __FILE__);
}


