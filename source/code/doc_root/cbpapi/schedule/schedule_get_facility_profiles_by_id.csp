<?php

if (isset($cbpapi_service)) {
    $node_parameters = $cbpapi_service->getRequestParameters();
    $facility_ids = $cbpapi_service->selectNodesValue($node_parameters,
        'facility_id');
    if ( ! isset($facility_ids)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'facility_id']);
    }

    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();

    // Get facility settings...
    $facilitySettings
        = $facility_logic->getApprovalSettingsOfFacilities($facility_ids);

    $facilitySettingsView = [];
    foreach ($facilitySettings as $facilityId => $setting) {
        $facilitySettingsView[$facilityId] = [
            'approval' => $setting['approval'] == '1' ? 'true' : 'false'
        ];
    }

    $uum = cb_lwc_uum();
    $login = $uum->getLoginUser();
    $dynamic_roles = $uum->listGrantedRoles();

    require_once('schedule/access_logic.csp');
    $acc_logic = GRN_Schedule_Access_Logic::getInstance();
    $facilitySettingsView = $acc_logic->evaluateAccessesById(
        $login, $facilitySettingsView, ['read'], $dynamic_roles, 'facility'
    );

    // response SOAP message
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('schedule')]);
    $t->assign('facility_settings', $facilitySettingsView);

    grn_cbpapi_response($t, __FILE__);
}
