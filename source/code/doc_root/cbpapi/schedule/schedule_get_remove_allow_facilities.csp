<?php

if (isset($cbpapi_service)) {
    // check for valid request.
    $node_parameters = $cbpapi_service->getRequestParameters();

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $dynamic_roles = $uum->listGrantedRoles();

    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();
    $facilities = $facility_logic->getGroupFacilitiesInfo();

    require_once('schedule/access_logic.csp');
    $acc_logic = GRN_Schedule_Access_Logic::getInstance();
    $acc_list = $acc_logic->getFacilityGroupAccessList($login, $facilities,
        ['read', 'delete'], $dynamic_roles);
    $tmp_acc_lists = $acc_logic->getEvaluateAccessesListById($login,
        $facilities, 'facility', ['read', 'delete'], $dynamic_roles);
    $acc_list += $tmp_acc_lists;

    // sort
    ksort($acc_list);

    //response SOAP message
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('schedule')]);
    $t->assign('acc_list', $acc_list);
    grn_cbpapi_response($t, __FILE__);
}

