<?php

use grn\schedule\api\adapter\events\ModifyEventSoapAdapter;

if (isset($cbpapi_service)) {
    //response SOAP message
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();

    $events = modifyEvents($node_parameters);

    $t->assign('events', $events);
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('schedule')]);

    grn_cbpapi_response($t, __FILE__);
}

function modifyEvents($params)
{
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    require_once('cbpapi/schedule_logic.csp');
    $cbpapi_base_logic = GRN_CBPApi_Schedule_Logic::getInstance();

    $events_ids = [];
    $event_params = $cbpapi_base_logic->getInputParamerters($login, $params);
    foreach (array_keys($event_params) as $key) {
        $param = $event_params[$key];
        //頻度更新
        require_once('grn/uum_util.csp');
        $uum_util = GRN_UumUtil::getInstance();
        $input_keys = array_keys($param);
        foreach ($input_keys as $input_key) {
            if (preg_match('#^selected_users_.*$#', $input_key)) {
                $input_value = $param[$input_key];
                if (is_array($input_value) && count($input_value) > 0) {
                    $input_values = explode(':', $input_value[0]);
                    if ($input_value[0] && is_array($input_values)) {
                        $uum_util->selectUsers($login, $input_values);
                    }
                }
            } elseif (preg_match('#^selected_groups_.*$#', $input_key)) {
                $input_value = $param[$input_key];
                if (is_array($input_value) && count($input_value) > 0) {
                    $input_values = explode(':', $input_value[0]);
                    if ($input_value[0] && is_array($input_values)) {
                        $uum_util->selectGroups($login, $input_values);
                    }
                }
            }
        }

        $adapter = new ModifyEventSoapAdapter();
        $eid = $adapter->modifyEvent(cb_get_login_user(), $param);
        if ($eid) {
            $events_ids[] = $eid;
        }
    }

    // commit schedule tables
    $cbpapi_base_logic->saveNow();

    $events_for_view = $cbpapi_base_logic->getEventsForViewByIds($login, $events_ids);

    return $events_for_view;
}


