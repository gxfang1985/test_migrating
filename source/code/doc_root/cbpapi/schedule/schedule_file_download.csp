<?php
//GTM-1136
if (isset($cbpapi_service)) {
    require_once('schedule/error_code.csp');

    require_once('schedule/system_logic.csp');
    $systemlogic = GRN_Schedule_SystemLogic::getInstance();
    if ($systemlogic->getAllowFileAttachment() != '1') {
        cb_throw_error(E_GRN_SCHD_DEACTIVATED_FILE);
    }

    $request = $cbpapi_service->getRequestParameters();
    if ( ! isset($request['attributes']['file_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'file_id']);
    }
    $file_id = $request['attributes']['file_id'];

    require_once('cbpapi/schedule_logic.csp');
    $logic = GRN_CBPApi_Schedule_Logic::getInstance();
    $event_id = $logic->getEventIDFromFile($file_id);
    if ( ! $event_id) {
        cb_throw_error(E_GRN_SCHD_NOTFOUND_FILE);
    }
    $file = $logic->getFile($event_id, $file_id);
    if ( ! $file) {
        cb_throw_error(E_GRN_SCHD_NOTFOUND_FILE);
    }
    $body = $file->getCurrentBody();
    if ( ! $body) {
        cb_throw_error(E_GRN_SCHD_NOTFOUND_FILE_LOG);
    }

    //logging
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $schedule_log = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    $log_params = [
        'eid'       => $event_id,
        'fid'       => $file_id,
        'file_name' => $body->get('name'),
        'version'   => $file->get('version')
    ];
    $schedule_log->infoEx('download', 'file', $log_params);

    $file_content = base64_encode($body->getContents());

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('schedule')]);
    $t->assign('file_content', $file_content);
    grn_cbpapi_response($t, __FILE__);
}
