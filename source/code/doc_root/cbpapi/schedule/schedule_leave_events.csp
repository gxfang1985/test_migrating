<?php

use grn\schedule\AttendanceStatusLogic;

if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $event_ids = $cbpapi_service->selectNodesValue($request, 'event_id');
    if ( ! isset($event_ids) || ! is_array($event_ids)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'event_id']);
    }

    require_once('schedule/application.csp');
    $app = GRN_Schedule_Application::getInstance();
    require_once('cbpapi/schedule_logic.csp');
    $logic = GRN_CBPApi_Schedule_Logic::getInstance();

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $login_id = $login->getOID();

    $event_id_list = []; // left event id list.
    $date = null;

    foreach ($event_ids as $event_id) {
        if (array_key_exists($event_id, $event_id_list)) {
            continue;
        }
        if ( ! is_numeric($event_id)) {
            cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
        }
        $event = $app->getEvent($login, $event_id, $date, CB_DATABASE_NO_LOCK,
            GRN_SCHEDULE_GET_MEMBER_ID);
        if ( ! $event) {
            cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
        }

        //Check access privilige
        require_once('schedule/access_logic.csp');
        $acc_logic = GRN_Schedule_Access_Logic::getInstance();
        $dynamic_role = $uum->listGrantedRoles();
        $access = $acc_logic->getEventAccess($login, $event,
            ['read', 'modify'], $dynamic_role);
        if ($access['read'] == GRN_SCHD_ACCESS_DENY) {
            cb_throw_error(E_GRN_SCHD_ACCESSDENY_EVENT);
        }
        if ($access['modify'] == GRN_SCHD_ACCESS_DENY) {
            cb_throw_error(E_GRN_SCHD_ACCESSDENY_EVENT);
        }

        // throw error when event is not a nomal or banner event.
        if (is_a($event, 'GRN_Schedule_RepeatEvent')) {
            cb_throw_error(E_GRN_SCHD_IS_REPEAT_EVENT);
        }
        if (is_a($event, 'GRN_Schedule_TemporaryEvent')) {
            cb_throw_error(E_GRN_SCHD_IS_TEMPORARY_EVENT);
        }

        require_once('schedule/facility_system_logic.csp');
        $facility_logic = GRN_Facility_SystemLogic::getInstance();
        $modify_user = $facility_logic->getFacilityModifyUser();
        // Registered user only has a modification permission.
        if ($modify_user === 'creator') {
            // 
            if (is_array($event->facilities) && count($event->facilities) > 0) {
                require_once('schedule/facility_privilege.csp');
                $privilege_logic = GRN_Facility_Privilege_Logic::getInstance();
                if ( ! $privilege_logic->hasPrivilegeOfFacilities($login,
                        $event->facilities, 'OR')
                     && ((is_a($event->creator, 'CB_User')
                          && $login_id != $event->creator->getOID())
                         || is_string($event->creator))
                ) {
                    cb_throw_error(E_GRN_FCLT_DENY_MODIFY);
                }
            }
        }

        // Leave
        $b_found = false;
        if (is_array($event->users)) {
            foreach (array_keys($event->users) as $index) {
                $user = &$event->users[$index];
                if ($user->getOID() == $login_id) {
                    unset($event->users[$index]);
                    $b_found = true;
                    break;
                }
            }
        }
        $event->modifier = &$login;
        if ($b_found) {
            if (count($event->users) == 0) {
                $event->users = null;
                $event_type = $event->getEventType();
                // 削除
                $app->deleteEvent($login, $event_id, $event_type);
            } else {
                $app->checkEventData($event);
                $event_id = $app->modifyEventWithoutDateTime($event);

                // ----- GRN2-4506 -----
                if ($event instanceof GRN_Schedule_NormalEvent) {
                    // 通常予定（終日以外）も、イベントのタイムゾーンに変更する
                    if ($event->setdatetime instanceof CB_DateTimeEx) {
                        require_once('fw/i18n.csp');
                        $settimestamp = new CB_TimeStampEx(null,
                            $event->timezone);
                        $settimestamp->setDateTime($event->setdatetime,
                            CB_I18N::getInstance()->getCurrentTimezone());
                        $event->setdatetime = $settimestamp->getDateTime();
                        if (isset($event->enddatetime)) {
                            $endtimestamp = new CB_TimeStampEx(null,
                                $event->timezone);
                            $endtimestamp->setDateTime($event->enddatetime,
                                CB_I18N::getInstance()->getCurrentTimezone());
                            $event->enddatetime = $endtimestamp->getDateTime();
                        } else {
                            $event->enddatetime = $event->setdatetime;
                        }
                    }

                    // Remove attendance status when attendee leaved
                    $attendanceStatLogic = new AttendanceStatusLogic();
                    $attendanceStatLogic->deleteAttendanceStatusByEventIdAndUserId($event->id,
                        $login_id);
                }
                // ----- GRN2-4506 -----

                if ($event_id) {
                    if ($event->private === 0) {
                        $event_id_list[$event_id] = $event_id;
                    }
                    $logic->createNotification($login, $event, null, null,
                        GRN_SCHEDULE_NOTIFY_MODIFY);
                }
            }
        }
    }

    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    $logic->saveNow();
    $logic->commit();
    $schedule_events = [];
    if (count($event_id_list) > 0) {
        $schedule_events = $logic->getEventsForViewByIds($login,
            $event_id_list);
    }
    //response SOAP message
    $t->assign('xml_namespaces', [
        grn_cbpapi_get_namespace('common'),
        grn_cbpapi_get_namespace('schedule')
    ]);
    $t->assign('events', $schedule_events);
    grn_cbpapi_response($t, __FILE__);
}

