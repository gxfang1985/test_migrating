<?php

/**
 * API schedule_get Read_allow_facilities : get facilities according to login user's access
 *
 * @author : Tien Nguyen
 **/
if (isset($cbpapi_service)) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $dynamic_roles = $uum->listGrantedRoles();
    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();
    $facilities_tmp = $facility_logic->getGroupFacilitiesInfo(null, 0, 0,
        CB_DATABASE_NO_LOCK);
    $facilities_order = array_keys($facilities_tmp);

    require_once('schedule/access_logic.csp');
    $acc_logic = GRN_Schedule_Access_Logic::getInstance();
    $evaluated = [];
    $facilities_tmp = $acc_logic->evaluateAccessesById($login, $facilities_tmp,
        ['read'], $dynamic_roles, 'facility');
    $facilities = [];
    foreach ($facilities_order as $key) {
        // アクセス権があったものだけ返す
        if (array_key_exists($key, $facilities_tmp)) {
            $facilities[$key] = $facilities_tmp[$key];
        }
    }
    require_once "grn/smarty.csp";
    $t = new GRN_Smarty;
    $t->assign('facilities', $facilities);
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('schedule')]);
    grn_cbpapi_response($t, __FILE__);
}
