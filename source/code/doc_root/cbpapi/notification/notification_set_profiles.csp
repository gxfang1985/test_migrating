<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $profile = $cbpapi_service->selectSingleNode($request, 'personal_profile');
    if ( ! isset($profile)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'personal_profile']);
    }
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);

    require_once('grn/notification.csp');
    $notification_service = GRN_Notification_Service::getInstance();
    $personal_config = $notification_service->getPersonalConfig($login);
    $savedays_options = [-1, 0, 1, 2, 3, 4, 5, 10, 15, 30, 90, 180, 365];

    $notify_savedays = null;
    if (isset($profile['attributes']['save_notification_duration'])
        &&
        ! is_null($profile['attributes']['save_notification_duration'])
    ) {
        $notify_savedays = $profile['attributes']['save_notification_duration'];
        if ( ! is_numeric($notify_savedays)
             || array_search($notify_savedays, $savedays_options) === false
        ) {
            require_once('notification/error_code.csp');
            cb_throw_error(E_GRN_NTFC_INVALID_PERSONAL_PROFILE_DATA);
        }
        $result = $personal_config->setSaveDays('notify', $notify_savedays);
        if ( ! $result) {
            cb_throw_error(E_GRN_CMMN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
        }
    }

    $history_savedays = null;
    if (isset($profile['attributes']['save_notification_history_duration'])
        &&
        ! is_null($profile['attributes']['save_notification_history_duration'])
    ) {
        $history_savedays
            = $profile['attributes']['save_notification_history_duration'];
        if ( ! is_numeric($history_savedays)
             || array_search($history_savedays, $savedays_options) === false
        ) {
            require_once('notification/error_code.csp');
            cb_throw_error(E_GRN_NTFC_INVALID_PERSONAL_PROFILE_DATA);
        }
        $result = $personal_config->setSaveDays('history', $history_savedays);
        if ( ! $result) {
            cb_throw_error(E_GRN_CMMN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
        }

    }
    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('notification')]);
    $t->assign('notify_savedays', $notify_savedays);
    $t->assign('history_savedays', $history_savedays);

    grn_cbpapi_response($t, __FILE__);
}
