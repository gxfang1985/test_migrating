<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $notifications = $cbpapi_service->selectNodes($request, 'notification_id');
    if ( ! isset($notifications)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'notification_id']);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);

    require_once("notification/application.csp");
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Notification_App $notification_app */
    $notification_app = $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
    // Get notification save days
    $notification_service = $notification_app->getNotificationService();
    $savedays = null;
    $pesonal_config = $notification_service->getPersonalConfig($login);
    $pesonal_config->getSaveDays('notify', $savedays);
    unset($app_locator, $notification_service, $pesonal_config);

    require_once('cbpapi/notification_logic.csp');
    $cbpapi_logic = GRN_CBPApi_Notification_Logic::getInstance();

    $notifications_for_view = [];
    foreach (array_keys($notifications) as $key) {
        $notification =& $notifications[$key];
        if ( ! isset($notification['attributes']['item'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'item']);
        }
        if ( ! isset($notification['attributes']['module_id'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'module_id']);
        }
        //$module_id = 'grn.'.$notification['attributes']['module_id'];
        $external_module_id = $notification['attributes']['module_id'];
        $unique_id = $notification['attributes']['item'];

        $internal_module_id
            = $cbpapi_logic->convertToInternalModuleId($external_module_id);
        $sub_module_id = $cbpapi_logic->getSubModuleId($external_module_id);

        $result = $cbpapi_logic->getNotifyDataPropertiesFast($login,
            $internal_module_id, $unique_id, 'notify', $sub_module_id);
        if ( ! is_null($result)) {
            $is_read = ($result['col_read'] == '1'
                        || strcmp('confirmed', $result['col_status']) == 0);
            if ( ! $is_read) {
                $notification = [$result['_id']];
                $notification_app->confirmDatas($login, $notification);
                if ($savedays != 0) {
                    $notify = $cbpapi_logic->getNotificationForView($login,
                        $external_module_id, $unique_id, 'notify');
                    if ( ! is_null($notify)) {
                        $notifications_for_view[] = $notify;
                    }
                }
            }
        }
    }


    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('notification')]);
    $t->assign('notifications', $notifications_for_view);
    grn_cbpapi_response($t, __FILE__);
}
