<?php
if (isset($cbpapi_service)) {
    // check admin right
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();
    if ( ! $system->isSuperAdmin($login)) {
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }

    $action = $cbpapi_service->getAction();
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    $server_ids = $cbpapi_service->selectNodesValue($node_parameters,
        'server_id');
    if ( ! $server_ids) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'server_id']);
    }

    //remove similar server_id
    $temp = $server_ids;
    for ($i = 0; $i < count($temp) - 1; $i++) {
        for ($j = $i + 1; $j < count($temp); $j++) {
            if ($temp[$i] == $temp[$j]) {
                unset($server_ids[$i]);
            }
        }
    }

    //GRN2-4341
    $search = ["%"];
    $replace = ["&#37"];
    foreach ($server_ids as $key => $server_id) {
        require_once('mail/system_config.csp');
        $system_config = GRN_Mail_SystemConfig::getInstance();
        $server_ids[$key] = str_replace($search, $replace, $server_id);
        $server_data = $system_config->getServerData($server_ids[$key]);
    }
    //GRN2-4341
    // remove mail server
    require_once('mail/system_config.csp');
    $system_config = GRN_Mail_SystemConfig::getInstance();
    $system_config->deleteServerDatas($server_ids);

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}
