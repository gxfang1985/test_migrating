<?php
if (isset($cbpapi_service)) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $login_id = $login->getOID();

    //check is a Admin?
    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();
    if ( ! $system->adminApplication('mail', $login)) {
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }
    //get Parametter
    $request = $cbpapi_service->getRequestParameters();
    $user_accounts = $cbpapi_service->selectNodes($request,
        'delete_user_accounts');

    //check param require?
    $user_accounts = checkParam($user_accounts);
    if (count($user_accounts) == 0) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'params']);
    }

    //remove similar account_id
    $temp = $user_accounts;
    for ($i = 0; $i < count($temp) - 1; $i++) {
        for ($j = $i + 1; $j < count($temp); $j++) {
            if ($temp[$i]['attributes']['account_id']
                == $temp[$j]['attributes']['account_id']
            ) {
                unset($user_accounts[$i]);
            }
        }
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $system_config = $utility->getSystemConfig();

    foreach ($user_accounts as $user_acc) {
        $account_ids = [$user_acc['attributes']['account_id']];
        require_once('cbpapi/error_code.csp');
        $system_config->getAccountData($user_acc['attributes']['account_id'],
            true, true);
        if (isset($user_acc['attributes']['delete_all_email'])
            && $user_acc['attributes']['delete_all_email'] == 'true'
        ) {
            $mail_delete = true;
        } else {
            $mail_delete = false;
        }
        $system_config->deleteAccountDatas($account_ids, $mail_delete);
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('action', $cbpapi_service->getAction());
    grn_cbpapi_response($t, __FILE__);
}

function checkParam($user_accounts)
{
    $search = ["&", "%"];
    $replace = ["", ""];
    if (count($user_accounts) > 1) {
        foreach ($user_accounts as $key => $user_acc) {
            if ( ! isset($user_acc['attributes']['account_id'])) {
                unset($user_accounts[$key]);
                continue;
            } else {
                $user_accounts[$key]['attributes']['account_id']
                    = str_replace($search, $replace,
                    $user_acc['attributes']['account_id']);
            }
        }

        return $user_accounts;
    } else {
        if ( ! isset($user_accounts[0]['attributes']['account_id'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'account_id']);
        } else {
            $user_accounts[0]['attributes']['account_id'] = str_replace($search,
                $replace, $user_accounts[0]['attributes']['account_id']);
        }

        return $user_accounts;
    }
}
