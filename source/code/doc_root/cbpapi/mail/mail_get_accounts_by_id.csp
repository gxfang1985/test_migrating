<?php
if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();

    $account_ids = [];
    $account_ids = $cbpapi_service->selectNodesValue($node_parameters,
        'account_id');
    if ( ! $account_ids) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'account_id']);
    }
    foreach ($account_ids as $account_id) {
        // check account id
        if (strlen($account_id) > 0 && is_numeric($account_id)) {
            require_once('mail/utility.csp');
            $utility = GRN_Mail_Utility::getInstance();
            $personal_config = $utility->getPersonalConfig($login);
            $account = $personal_config->getAccountData($account_id);
            if (is_null($account)) {
                require_once('mail/error_code.csp');
                cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
            }
            if ( ! array_key_exists('user_id', $account)
                 || $account['user_id'] != $login->getOID()
            ) {
                require_once('mail/error_code.csp');
                cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
            }
            $folder = $utility->getFolderLogic();
            // initialize special folders
            $folder->initSpecialFolders($login, $account_id);
        } else {
            require_once('mail/error_code.csp');
            cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
        }
    }
    require_once('cbpapi/mail_logic.csp');
    $mail_logic = GRN_CBPApi_Mail_Logic::getInstance();
    $mail_accounts_for_view = $mail_logic->getMailAccountForViewByIds($login,
        $account_ids);
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('accounts', $mail_accounts_for_view);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}

