<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    if ( ! isset($node_parameter['attributes']['mail_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'mail_id']);
    }
    $mail_id = $node_parameter['attributes']['mail_id'];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/table.csp');
    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $mail_logic = $utility->getMailLogic();

    if ( ! is_numeric($mail_id)) {
        cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
    }

    $mail_data = $mail_logic->getMailData($mail_id, false);
    if (is_null($mail_data)) {
        cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
    }
    if ( ! array_key_exists('user_id', $mail_data)
         || $mail_data['user_id'] != $user->getOID()
    ) {
        cb_throw_error(E_GRN_MAIL_MAIL_ACCESS_DENIED);
    }

    $source_data =& $mail_logic->getMailSourceData($mail_id);
    $file_content = null;
    if ( ! is_null($source_data)) {
        $file_content = base64_encode($source_data);
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('file_content', $file_content);

    grn_cbpapi_response($t, __FILE__);
}
