<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    if ( ! isset($node_parameter['attributes']['file_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'file_id']);
    }
    $file_id = $node_parameter['attributes']['file_id'];

    if ( ! isset($node_parameter['attributes']['mail_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'mail_id']);
    }
    $mail_id = $node_parameter['attributes']['mail_id'];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $mail_logic = $utility->getMailLogic();

    if ( ! is_numeric($mail_id)) {
        cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
    }
    $mail_data =& $mail_logic->getMailData($mail_id, false);
    if ( ! is_array($mail_data) || ! array_key_exists('user_id', $mail_data)
         || $mail_data['user_id'] != $user->getOID()
    ) {
        cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
    }
    if ( ! is_numeric($file_id)) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_FILE_DATA_NOT_FOUND);
    }
    $file_body = $mail_logic->getMailFileBody($mail_id, $file_id);
    if ( ! is_object($file_body)) {
        require_once('mail/error_code.csp');
        cb_throw_error(E_GRN_MAIL_FILE_DATA_NOT_FOUND);
    }
    $file_content = null;
    if ($mail_data['sent'] && $mail_data['import_mail'] === false
        || (isset($mail_data['draft']) && $mail_data['draft'] == 1)
    ) {
        $file_content = base64_encode($file_body->getContents());
    } // mail part file
    else {
        $file_body = $file_body->getContent();
        $file_content = base64_encode($file_body);
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('file_content', $file_content);

    grn_cbpapi_response($t, __FILE__);
}
