<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    if ( ! isset($node_parameter['attributes']['account_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'account_id']);
    }
    $account_id = $node_parameter['attributes']['account_id'];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $personal_config = $utility->getPersonalConfig($user);
    // check account id
    if ( ! is_numeric($account_id)) {
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    $account_data = $personal_config->getAccountData($account_id, false, true);
    if ( ! is_array($account_data)
         || ! array_key_exists('user_id', $account_data)
         || $account_data['user_id'] != $user->getOID()
    ) {
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    $signature_for_view = $personal_config->getSignatureDataList($account_id,
        true);

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('signatures', $signature_for_view);

    grn_cbpapi_response($t, __FILE__);
}
