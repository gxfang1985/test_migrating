<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    $operations = $cbpapi_service->selectNodes($node_parameter,
        'operation');
    if ( ! isset($operations)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'opertion']);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $folder_logic = $utility->getFolderLogic();
    $mail_logic = $utility->getMailLogic();

    $mail_ids = [];
    foreach ($operations as $operation) {
        if ( ! isset($operation['attributes']['folder_id'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'folder_id']);
        }
        if ( ! isset($operation['attributes']['mail_id'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'mail_id']);
        }
        $folder_id = $operation['attributes']['folder_id'];
        $mail_id = $operation['attributes']['mail_id'];
        // check mail id
        if (is_null($mail_id) || strlen($mail_id) == 0
            || ! is_numeric($mail_id)
        ) {
            cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
        }
        $mail_data =& $mail_logic->getMailData($mail_id, false);
        if ( ! array_key_exists('user_id', $mail_data)
             || $mail_data['user_id'] != $user->getOID()
        ) {
            cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
        }
        // ignore moving if mail_id is already processed
        if (array_search($mail_id, $mail_ids) !== false) {
            continue;
        }
        // check folder id
        if ( ! is_numeric($folder_id)) {
            cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
        }
        $folder_data =& $folder_logic->getFolderData($folder_id, false);
        if ( ! array_key_exists('user_id', $folder_data)
             || $folder_data['user_id'] != $user->getOID()
        ) {
            cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
        }
        $move_mails = [$mail_id];
        $count = $mail_logic->moveMailDatas($move_mails, $folder_id);
        // Get moved $mail_id
        if ($count > 0) {
            $mail_ids[] = $mail_id;
        }
    }
    require_once('cbpapi/mail_logic.csp');
    $logic = GRN_CBPApi_Mail_Logic::getInstance();
    $mails_for_view = $logic->getMailForViewByIds($user, $mail_ids);

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('mails', $mails_for_view);

    grn_cbpapi_response($t, __FILE__);
}

