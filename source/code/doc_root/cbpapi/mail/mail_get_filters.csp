<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    if ( ! isset($node_parameter['attributes']['account_id'])) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'account_id']);
    }
    $account_id = $node_parameter['attributes']['account_id'];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $folder_logic = $utility->getFolderLogic();
    $personal_config = $utility->getPersonalConfig($user);
    // check account id
    if ( ! is_numeric($account_id)) {
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }
    $account_data = $personal_config->getAccountData($account_id, false, true);
    if ( ! is_array($account_data)
         || ! array_key_exists('user_id', $account_data)
         || $account_data['user_id'] != $user->getOID()
    ) {
        cb_throw_error(E_GRN_MAIL_ACCOUNT_DATA_NOT_FOUND);
    }

    require_once('mail/status.csp');
    $target_translate_map = [
        'SB' => 'Subject',
        'FR' => 'From',
        'TO' => 'To',
        'CC' => 'CC',
        'HD' => 'Header',
        'SZ' => 'Mail'
    ];
    $method_translate_map = [
        'CO'  => 'Including',
        'NCO' => 'Excluding',
        'SA'  => 'Equal',
        'NSA' => 'NotEqual',
        'BE'  => 'Begin',
        'GE'  => 'GreaterThanOrEqual',
        'LE'  => 'LessThanOrEqual'
    ];
    $filters_for_view = [];
    $filter_list = $personal_config->getFilterDataList($account_id,
        true);
    foreach (array_keys($filter_list) as $key) {
        $filter_data =& $filter_list[$key];
        $folder_id = $filter_data['folder_id'];
        $folder_name = $folder_logic->getFolderName($folder_id);
        $conditions = [];
        foreach ($filter_data['conditions'] as $index => $condition) {
            $conditions[$index] = [
                'target'  => $target_translate_map[$condition['type']],
                'method'  => $method_translate_map[$condition['expr']],
                'content' => $condition['string'],
                'expr'    => $condition['expr']
            ];
        }

        $filters_for_view[$key] = [
            'name'        => $filter_data['name'],
            'folder_name' => ! is_null($folder_name) ? $folder_name : '',
            'operation'   => $filter_data['or'] == '0' ? 'AND' : 'OR',
            'status'      => grn_mail_get_status($filter_data['status_id']),
            'conditions'  => $conditions
        ];
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('filters', $filters_for_view);

    grn_cbpapi_response($t, __FILE__);
}
