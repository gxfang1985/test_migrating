<?php
if (isset($cbpapi_service)) {
    $node_parameter = $cbpapi_service->getRequestParameters();
    $folder_ids = $cbpapi_service->selectNodesValue($node_parameter,
        'folder_id');
    if ( ! isset($folder_ids)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'folder_id']);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
    if ( ! is_object($user)) {
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    }

    require_once('mail/utility.csp');
    $utility = GRN_Mail_Utility::getInstance();
    $folder_logic = $utility->getFolderLogic();

    foreach ($folder_ids as $folder_id) {
        if ( ! is_numeric($folder_id)) {
            cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
        }
        $folder_data = $folder_logic->getFolderData($folder_id);
        // check folder data
        if ( ! array_key_exists('user_id', $folder_data)
             || $folder_data['user_id'] != $user->getOID()
        ) {
            cb_throw_error(E_GRN_MAIL_FOLDER_DATA_NOT_FOUND);
        }
        if (isset($folder_data['code']) && is_string($folder_data['code'])
            && (strlen($folder_data['code']) > 0)
        ) {
            cb_throw_error(E_GRN_MAIL_CANNOT_DELETE_FOLDER_DATA);
        }

        // delete folder
        $folder_logic->deleteFolderData($folder_id);
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());

    grn_cbpapi_response($t, __FILE__);
}

