<?php
if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    $mail_ids = $cbpapi_service->selectNodesValue($node_parameters,
        'mail_id');
    if ( ! $mail_ids) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'mail_id']);
    }
    if (is_array($mail_ids) && (count($mail_ids) > 0)) {
        require_once('mail/utility.csp');
        $utility = GRN_Mail_Utility::getInstance();
        $mail_logic = $utility->getMailLogic();

        foreach ($mail_ids as $mail_id) {
            // check mail id
            if (strlen($mail_id) > 0 && is_numeric($mail_id)) {
                $mail_data = $mail_logic->getMailData($mail_id, false);
                if (is_null($mail_data)) {
                    require_once('mail/error_code.csp');
                    cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
                }
                if ( ! array_key_exists('user_id', $mail_data)
                     || $mail_data['user_id'] != $login->getOID()
                ) {
                    require_once('mail/error_code.csp');
                    cb_throw_error(E_GRN_MAIL_MAIL_ACCESS_DENIED);
                }
            }
        }

        // メールデータの削除
        $mail_logic->deleteMailDatas($mail_ids);
    }
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}

