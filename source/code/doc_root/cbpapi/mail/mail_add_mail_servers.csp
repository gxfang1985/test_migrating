<?php
if (isset($cbpapi_service)) {
    // check admin right
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();
    if ( ! $system->isSuperAdmin($login)) {
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }

    $action = $cbpapi_service->getAction();
    // get parameters of SOAP message
    $node_parameters = $cbpapi_service->getRequestParameters();
    require_once('cbpapi/mail_logic.csp');
    $mail_logic = GRN_CBPApi_Mail_Logic::getInstance();
    $params = $mail_logic->getMailServerParamerters($cbpapi_service,
        $node_parameters);

    // add mail server
    require_once('mail/system_config.csp');
    $system_config = GRN_Mail_SystemConfig::getInstance();
    $server_ids = [];
    foreach ($params as $param) {
        $server_id = $system_config->addServerData($param['foreign_key'],
            $param['name'], null, $param['server_info']);
        $server_ids[] = $server_id;
    }

    $servers_for_view = $mail_logic->getMailServerForViewByIds($server_ids);

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('mail')]);
    $t->assign('action', $action);
    $t->assign('servers', $servers_for_view);
    grn_cbpapi_response($t, __FILE__);
}
