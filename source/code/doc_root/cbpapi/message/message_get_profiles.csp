<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $include_system_profile = false;
    if (isset($request['attributes']['include_system_profile'])) {
        $include_system_profile = (strcmp('true',
                $request['attributes']['include_system_profile']) == 0);
    }

    // get user
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    // get personal configurations
    require_once('message/personal_logic.csp');
    $personal_logic = GRN_Message_PersonalLogic::getInstance();
    $use_trash = $personal_logic->getUseGarbageBoxAttribute($user);
    $stored_term = $personal_logic->getStoredTermAttribute($user);
    // get system configurations
    $check_send_confirm = false;
    $confirm_action = '';
    if ($include_system_profile) {
        require_once('message/system_logic.csp');
        $system_logic = GRN_Message_SystemLogic::getInstance();

        $check_send_confirm = $system_logic->getConfirmConfigAttribute();
        $confirm_actions = ['Manual', 'Auto'];
        $confirm_action
            = $confirm_actions[$system_logic->getConfirmModeConfigAttribute()];
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('message')]);
    $t->assign('use_trash', $use_trash);
    $t->assign('duration', $stored_term);
    $t->assign('include_system_profile', $include_system_profile);
    $t->assign('check_send_confirm', $check_send_confirm);
    $t->assign('confirm_action', $confirm_action);

    grn_cbpapi_response($t, __FILE__);
}

