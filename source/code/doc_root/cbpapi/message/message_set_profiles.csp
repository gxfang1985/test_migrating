<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    $personal_profile = $cbpapi_service->selectSingleNode($request,
        'personal_profile');
    if ( ! isset($personal_profile)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'personal_profile']);
    }
    $use_trash = 0;
    $stored_term = 5; // default
    if (isset($personal_profile['attributes']['use_trash'])) {
        $use_trash = (strcmp('true',
                $personal_profile['attributes']['use_trash']) == 0) ? 1 : 0;
    }
    if (isset($personal_profile['attributes']['trash_duration'])) {
        $stored_term = $personal_profile['attributes']['trash_duration'];
    }

    $duration_options = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    if ( ! is_numeric($stored_term)
         || array_search($stored_term, $duration_options) === false
    ) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_INVALID_DATA_PROFILE);
    }

    // get user
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    // get personal configurations
    require_once('message/personal_logic.csp');
    $personal_logic = GRN_Message_PersonalLogic::getInstance();
    $ret1 = $personal_logic->setUseGarbageBoxAttribute($user,
        $use_trash);
    $ret2 = $personal_logic->setStoredTermAttribute($user,
        $stored_term);
    if ($ret1 === false || $ret2 === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_PROFILE_DATA_NOT_UPDATED);
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('message')]);
    $t->assign('use_trash', $use_trash);
    $t->assign('duration', $stored_term);

    grn_cbpapi_response($t, __FILE__);
}

