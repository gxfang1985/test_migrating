<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();
    // check for required fields
    $required_fields = ['thread_id', 'offset', 'limit'];
    foreach ($required_fields as $field) {
        if ( ! isset($request['attributes'][$field])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => $field]);
        }
    }
    $relation_id = $request['attributes']['thread_id'];
    $offset = intval($request['attributes']['offset']);
    $limit = intval($request['attributes']['limit']);

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    unset($uum);

    require_once('cbpapi/message_logic.csp');
    $logic = GRN_CBPApi_Message_Logic::getInstance();
    $follows_for_view = $logic->getFollows($login, $relation_id, $offset,
        $limit);
    foreach ($follows_for_view as $follow_id => $follow) {
        $date = grn_cbpapi_iso8601($follow['ctime']);
        $follows_for_view[$follow_id]['creator_date'] = $date;
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('message')]);
    $t->assign('follows', $follows_for_view);

    grn_cbpapi_response($t, __FILE__);
}
