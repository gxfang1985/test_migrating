<?php
if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $login_id = $login->getOID();

    require_once('workflow/config.csp');
    $config = GRN_Workflow_Configs::getInstance();
    $config = $config->getSystemConfig();

    $proxies = $config->getAgent($login_id);
    $proxies_for_view = [];
    $proxies_for_view[$login_id] = [];
    foreach ($proxies as $type => $proxy) {
        if ( ! isset($proxy)) {
            continue;
        }
        if ($proxy['agent_type'] == GRN_WORKFLOW_AGENT_TYPE_PETITION) {
            $proxies_for_view[$login_id]['proxy_applicant'] = $proxy['agent'];
        } elseif ($proxy['agent_type'] == GRN_WORKFLOW_AGENT_TYPE_APPROVAL) {
            $proxies_for_view[$login_id]['proxy_approver'] = $proxy['agent'];
        }
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('workflow')]);
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('proxies', $proxies_for_view);
    $t->assign('has_proxy', count($proxies_for_view[$login_id]));

    grn_cbpapi_response($t, __FILE__);
}
