<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

require_once('cbpapi/error_code.csp');

if (isset($cbpapi_service)) {
    $request = $cbpapi_service->getRequestParameters();

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $contentNodes = $cbpapi_service->selectNodes($request, 'content');
    if (is_array($contentNodes) && isset($contentNodes[0]['text'])) {
        $content = $contentNodes[0]['text'];
    } else {
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'content']);
    }

    $name = @$request['attributes']['name'];
    $hid = @$request['attributes']['hid'];
    $version = @$request['attributes']['version'];
    $title = @$request['attributes']['title'];
    $desc = @$request['attributes']['description'];
    if (is_null($hid)) {
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'hid']);
    }
    if ( ! is_numeric($hid)) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }

    if (is_null($name)) {
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'name']);
    }

    if (is_numeric($version)) {
        require_once('grn/file.csp');
        $config = GRN_FileManagerConfig::getInstance();
        $system_max_version = $config->getMaxVersion();


        if ($system_max_version == GRN_FILE_CONFIG_VERSION_INFINITE) {
            if ($version < 0) {
                $version = -1;
            }

            if ($version > GRN_FILE_NUMERIC_MAX_VERSION) {
                $version = GRN_FILE_NUMERIC_MAX_VERSION;
            }
        } else {
            if ($version < 0) {
                $version = 0;
            }

            if ($version > $system_max_version) {
                $version = $system_max_version;
            }
        }
    }

    $locator = GRN_ApplicationLocator::instance();
    if ( ! ($G_cabinet = $locator->getInstance('cabinet'))) {
        cb_throw_error(E_GRN_CABINET_DEACTIVATED);
    }
    $folder = null;
    if ( ! ($folder = $G_cabinet->getFolder($login, $hid))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $file = [];
    $file['content'] = $content;
    $file['name'] = $name;

    $fileinfo = cbpapi_upload_file($file);
    $file =& $G_cabinet->createFile($login, $folder, $fileinfo, null);
    if (is_numeric($version)) {
        $file->setMaxVersion($version);
    }
    if ( ! is_null($title)) {
        $file->setTitle($title);
    }
    if ( ! is_null($desc)) {
        $file->setDescription($desc);
    }

    $file->onCreate($login);

    $locator = GRN_ApplicationLocator::instance();
    $cabinet = $locator->getInstance('cabinet');
    $cabinet->readFile($login, $file);

    // Write log: create file
    require_once('cabinet/inspection.csp');
    $inspection = GRN_Cabinet_Inspection::getInstance();
    $inspection->writeLogFile("create", $file, $folder);

    $lock = $file->getLockObject();
    $lock->releaseLock();

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
    $t->assign('action', $cbpapi_service->getAction());
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('cabinet')]);

    require_once('cabinet/controller.csp');
    $utility = new GRN_Cabinet_ControllerUtil();

    $file_for_view = $utility->getFileView($file);
    $file_for_view['folder_id'] = $hid;
    $file_for_view['description'] = $desc;
    $file_for_view['creator_login_name'] = $login->get('foreign_key');

    // for Full Text Search logic
    if (FtsApplication::isAvailable()) {
        $searchService = new IndexService();
        $searchService->createFileIndex($file);
    }

    $t->assign('file', $file_for_view);
    grn_cbpapi_response($t, __FILE__);
}
