<?php

if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();
    $node_parameters =& $cbpapi_service->getRequestParameters();
    $my_address_groups =& $cbpapi_service->selectNodes($node_parameters,
        'my_address_group');
    if ( ! isset($my_address_groups)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'my_address_group']);
    }
    foreach ($my_address_groups as $group) {
        if ( ! isset($group['attributes']['name'])) {
            require_once('cbpapi/error_code.csp');
            cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
                ['param' => 'name']);
        }
    }

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user =& $uum->getLoginUser();

    require_once('address/mygroup_logic.csp');
    $mygroup = GRN_Address_MyGroup_Logic::getInstance();

    $my_groups_for_view = [];
    foreach ($my_address_groups as $group) {
        $name = $group['attributes']['name'];
        $memo = @$group['attributes']['description'];
        $group = $mygroup->addMyGroup($user, $name, $memo);

        // make group for view
        $mgid = $group->getOID();
        $my_groups_for_view[$mgid]['id'] = $mgid;
        $my_groups_for_view[$mgid]['name'] = $group->get('name');
        $my_groups_for_view[$mgid]['description'] = $group->get('description');
        $mtime = $group->get('mtime');
        $my_groups_for_view[$mgid]['version'] = $mtime->unix_ts;
    }

    //response SOAP message
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('address')]);
    $t->assign('action', $action);
    $t->assign('my_groups', $my_groups_for_view);

    grn_cbpapi_response($t, __FILE__);
}

