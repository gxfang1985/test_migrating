<?php
if (isset($cbpapi_service)) {
    $node_parameter =& $cbpapi_service->getRequestParameters();
    $action = $cbpapi_service->getAction();

    // Get login user
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();

    // Check access permission
    require_once('address/access.csp');
    $access_manager = GRN_Address_AccessManager::getInstance();
    if ( ! ($row =& $access_manager->getAbstractData(GRN_ADDRESS_AVAILABLE))) {
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }

    // Get dynamic roles
    $dynamic_roles = $uum->listGrantedRoles();

    // Evaluate use permission
    $authorities = ['private_address', 'shared_address'];
    $security_model = $access_manager->getSecurityModel($row);
    $access = $access_manager->evaluateAccess($row, $login,
        $dynamic_roles, $authorities, $security_model);

    // Evaluate permission on personal address
    $authorities = ['private_address'];
    $use_personal_book = $access_manager->isAllowedAccess($access, $authorities,
        $security_model);

    // Evaluate permission on shared address
    $authorities = ['shared_address'];
    $use_shared_book = $access_manager->isAllowedAccess($access, $authorities,
        $security_model);

    // Get attendee menu
    require_once('address/config.csp');
    $config_manager = GRN_Address_ConfigManager::getInstance();
    // Get Personal config
    $config =& $config_manager->getPersonalConfig($login);
    // Get attendee items
    $items = $config->listAttendeeItems();
    $str_attendee_menu = '';
    foreach ($items as $item) {
        $str_attendee_menu .= $item . "\r\n";
    }

    // SOAP response
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('address')]);
    $t->assign('action', $action);
    $t->assign('items', $str_attendee_menu);
    $t->assign('use_personal_book', $use_personal_book);
    $t->assign('use_shared_book', $use_shared_book);

    grn_cbpapi_response($t, __FILE__);
}
