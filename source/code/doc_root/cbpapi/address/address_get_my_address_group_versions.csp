<?php

if (isset($cbpapi_service)) {
    $action = $cbpapi_service->getAction();

    require_once('cbpapi/util.csp');
    $item_name = 'my_address_group_item';
    $node_parameters =& $cbpapi_service->getRequestParameters();
    $items_version = grn_cbpapi_parse_item_versions($node_parameters,
        $item_name);

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();

    require_once('address/mygroup_logic.csp');
    $mygroup_logic = GRN_Address_MyGroup_Logic::getInstance();
    $mygroups = $mygroup_logic->getMyGroupList($login);

    $candidate_items_version = [];
    foreach ($mygroups as $key => $item) {
        $candidate_items_version[$key] = [
            'id'      => $item['id'],
            'version' => $item['mtime']->unix_ts
        ];
    }

    $mygroups_for_view = grn_cbpapi_compare_item_versions($items_version,
        $candidate_items_version);

    //response SOAP message
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('address')]);
    $t->assign('mygroups', $mygroups_for_view);
    $t->assign('action', $action);
    grn_cbpapi_response($t, __FILE__);
}

