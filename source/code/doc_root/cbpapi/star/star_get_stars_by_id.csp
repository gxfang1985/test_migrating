<?php

if (isset($cbpapi_service)) {
    $parameters = $cbpapi_service->getRequestParameters();
    $star_ids = $cbpapi_service->selectNodesValue($parameters, 'star_id');
    if ( ! isset($star_ids)) {
        require_once('cbpapi/error_code.csp');
        cb_throw_error(E_GRN_CBPAPI_MISSING_PARAMETER, null,
            ['param' => 'star_id']);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    // update star list
    require_once('star/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Star_Application $star_app */
    $star_app = $app_locator->getInstance('star');
    $star_app->updateStarList($login, true);

    require_once('star/logic.csp');
    $star_logic = GRN_Star_StarLogic::getInstance();

    $stars_for_view = [];
    require_once('cbpapi/star_logic.csp');
    $logic = GRN_CBPApi_StarLogic::getInstance();
    $stars_for_view = $logic->getStarsForViewByIDs($login, $star_ids);

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;
    $t->assign('xml_namespaces', [grn_cbpapi_get_namespace('star')]);
    $t->assign('star_for_view', $stars_for_view);
    $t->assign('action', $cbpapi_service->getAction());
    grn_cbpapi_response($t, __FILE__);
}


