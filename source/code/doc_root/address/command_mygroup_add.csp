<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    $target_name = 'address/mygroup_add';

    global $G_INPUT;

    $mygroup_id = null;
    if (array_key_exists('mgid', $G_INPUT)) {
        $mygroup_id = $G_INPUT['mgid'];
    }

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');
        $user =& $uum->getLoginUser();

        require_once('address/mygroup_logic.csp');
        $mygroup = GRN_Address_MyGroup_Logic::getInstance();

        $name = $G_INPUT['group_name'];
        $memo = $G_INPUT['memo'];
        $group = $mygroup->addMyGroup($user, $name, $memo);

        cb_redirect('address/mygroup_list', ['mgid' => $group->getOID()]);
    } else {
        $t->setPageInfo($target_name);

        // page title
        $page_title = grn_get_page_display_name('address/mygroup_add');
        $t->assign('page_title', $page_title);

        // page navigation
        $page_info = [
            'mygroup_list' => ['mgid' => $mygroup_id],
            'mygroup_add'  => null
        ];
        require_once('grn/controller.csp');
        $controller_util = new GRN_ControllerUtil();
        $site_position = $controller_util->makeSitePosition('address/',
            $page_info);
        $t->assign('site_position', $site_position);

        $t->assign('mygroup_id', $mygroup_id);

        $t->assign('group_name', cb_at($G_INPUT, 'group_name'));
        $t->assign('memo', cb_at($G_INPUT, 'memo'));

        $t->display($target_name . '.tpl');
    }
}


