<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$reset = null;
if (array_key_exists('reset', $G_INPUT)) {
    $reset = $G_INPUT['reset'];
}

$session_name = 'address.system.availability_add';
$ous_params = [];
$can_select_role = true;
$search_login_name = true;
require_once('grn/org_user_role_select.csp');
$t->assign('ous_params', $ous_params);

$t->assign('listbox_size', $navigation_info['navi']['number_on_page'] + 1);

// tree link page
$t->assign('link_page', cb_get_pagename());

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$t->assign('site_position',
    [
        [
            'page'  => 'address/system/availability_list',
            'name'  => grn_get_page_display_name('address/system/availability_list'),
            'reset' => 1
        ],
        ['page' => null, 'name' => $page_title],
    ]
);

// 使用権限を取得する
require_once('address/access.csp');
$access_manager = GRN_Address_AccessManager::getInstance();
if ( ! ($row = $access_manager->getAbstractData(GRN_ADDRESS_AVAILABLE))) {
    assert('FALSE');
}
$security_model = $access_manager->getSecurityModel($row);
$security_model_flg = GRN_ADDRESS_SECURITYMODEL_REVOKE == $security_model
    ? 'revoke' : 'grant';
$t->assign('is_grant', $security_model_flg == 'grant');

// セッションから権限の値を取得する
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session
    = $session_manager->getSession('address.system.availability_list');
$access_value = $session->get('access_value');

if (is_null($access_value) || $reset) {
    $access_value = GRN_ADDRESS_AUTHORITY_PRIVATE_ADDRESS
                    | GRN_ADDRESS_AUTHORITY_SHARED_ADDRESS;
    $session->set('access_value', $access_value);
}

$private_address = [];
$shared_address = [];
$all_address = [];
$private_address['value'] = GRN_ADDRESS_AUTHORITY_PRIVATE_ADDRESS;
$private_address['selected'] = $access_value == $private_address['value'];
$shared_address['value'] = GRN_ADDRESS_AUTHORITY_SHARED_ADDRESS;
$shared_address['selected'] = $access_value == $shared_address['value'];
$all_address['value'] = $private_address['value']
                        + $shared_address['value'];
$all_address['selected'] = $access_value == $all_address['value'];
if (GRN_ADDRESS_SECURITYMODEL_REVOKE == $security_model) {
    $private_address['label'] = cb_msg('grn.address', 'shared_only');
    $shared_address['label'] = cb_msg('grn.address', 'private_only');
    $all_address['label'] = cb_msg('grn.address', 'no_available');
} else {
    $all_address['label'] = cb_msg('grn.address', 'all_available');
    $private_address['label'] = cb_msg('grn.address', 'private_only');
    $shared_address['label'] = cb_msg('grn.address', 'shared_only');
}

$authority_types = [
    $all_address,
    $private_address,
    $shared_address
];

$t->assign('authority_types', $authority_types);
// exec smarty
$t->display(cb_get_pagename() . '.tpl');

