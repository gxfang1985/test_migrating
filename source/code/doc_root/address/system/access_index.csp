<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

require_once('_access_util.csp');

// 共有アドレスブック一覧を取得する
$node_rows = $book_manager->listSharedAddressBooks();

// ブック情報一覧を取得する
require_once('address/view_util.csp');
$view_util = GRN_Address_ViewUtil::getInstance();
$node_list = $view_util->listBooks($node_rows, $node_rows, 'access');

// ブックにかけられたアクセス権の総数を取得する
$objects = [];
foreach (array_keys($node_list) as $nid) {
    $node_row =& $node_rows[$nid];
    $row =& $node_row->getRow();
    $objects[$nid] =& $row;
}
require_once('address/access.csp');
$access_manager = GRN_Address_AccessManager::getInstance();
$authorities = ['browse', 'editing'];
$access_counts = $access_manager->listAccessCounts($objects, $authorities);

// ビューに割り当てるブック情報を生成する
foreach (array_keys($node_list) as $nid) {
    $node =& $node_list[$nid];
    $node['access_count'] = $access_counts[$nid];
    if (GRN_ADDRESS_SECURITYMODEL_REVOKE == $node['security_model']) {
        $node['security_model'] = 'revoke';
    } else {
        $node['security_model'] = 'grant';
    }
}

$t->assign('node_id', $node_id);
$t->assign('node_list', $node_list);

////////////////////////////////////////////////////////////////

require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = ['access_index' => null];
$site_position = $controller_util->makeSitePosition('address/system/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


