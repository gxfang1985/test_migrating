<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'address/system/item_add';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // GET/POSTされたパラメータを取得する
        $bid = null;
        if (array_key_exists('bid', $G_INPUT)) {
            $bid = $G_INPUT['bid'];
        }
        if (0 == strlen($bid)) {
            cb_throw_error(E_GRN_ADDRESS_INVALID_BOOK_ID);
        }
        $properties = [];
        require_once('fw/string_util.csp');
        $properties['display_name'] = cb_trim_check(@ $G_INPUT['display_name'],
            E_COMMON_MISSING_MANDATORY);
        $properties['id'] = cb_trim_check(@ $G_INPUT['id'],
            E_COMMON_MISSING_MANDATORY);
        $properties['type'] = @ $G_INPUT['type'];
        $properties['use'] = @ $G_INPUT['use'];
        $properties['necessary'] = @ $G_INPUT['necessary'];
        $properties['not_modify'] = @ $G_INPUT['not_modify'];
        $properties['display'] = @ $G_INPUT['display'];
        $properties['sso'] = @ $G_INPUT['sso'];

        // アドレス帳を取得する
        require_once('address/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();
        /** @var GRN_Address_Application $app */
        $app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
        if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
            cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
        }

        // ログインユーザーを取得する
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');
        $login =& $uum->getLoginUser();
        if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
            cb_throw_error(E_GRN_USER_NOT_FOUND);
        }
        $login_id = $login->getOID();
        $properties['user'] =& $login;

        // ブックを取得する
        $book_manager =& $app->getBookManager();
        if (0 > $bid) {
            if ( ! ($book
                =& $book_manager->getPrivateAddressBookByUserId($login_id))
            ) {
                if ( ! ($book =& $book_manager->addPrivateAddressBook('cyde',
                    $login_id, []))
                ) {
                    cb_throw_error(E_GRN_ADDRESS_PRIVATE_ADDRESS_BOOK_NOT_FOUND);
                }
            }
        } else {
            if ( ! ($book =& $book_manager->getSharedAddressBook($bid))) {
                cb_throw_error(E_GRN_ADDRESS_SHARED_ADDRESS_BOOK_NOT_FOUND);
            }
        }

        // ブックに項目を追加する
        if ( ! $book->addItem($properties)) {
            cb_throw_error(E_GRN_ADDRESS_COLLISION_ID_OF_ITEM);
        }

        SmartyValidate::unregister_form($target_name);

        cb_redirect('address/system/item_list', ['bid' => $bid]);
    } else {
        $t->setPageInfo($target_name);
        include('_item_add.csp');

        $t->display($target_name . '.tpl');
    }
}


