<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    // GET/POSTされたパラメータを取得する
    $bid = null;
    if (array_key_exists('bid', $G_INPUT)) {
        $bid = $G_INPUT['bid'];
    }
    if (0 == strlen($bid)) {
        cb_throw_error(E_GRN_ADDRESS_INVALID_BOOK_ID);
    }
    if (array_key_exists('charset', $G_INPUT)) {
        $charset = $G_INPUT['charset'];
    }
    if (0 == strlen($charset)) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }
    $title = false;
    if (array_key_exists('title', $G_INPUT)) {
        $title = $G_INPUT['title'];
    }
    $filename = null;
    if (array_key_exists('filename', $G_INPUT)) {
        $filename = $G_INPUT['filename'];
    }
    if (0 == strlen($filename)) {
        $filename = 'address_access.csv';
    }

    // アドレス帳を取得する
    require_once('address/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
    if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }
    $book_manager =& $app->getBookManager();

    if (0 > $bid) {
        $books = $book_manager->listSharedAddressBooks();
    } else {
        if ( ! ($book =& $book_manager->getSharedAddressBook($bid))) {
            cb_throw_error(E_GRN_ADDRESS_INVALID_BOOK_ID);
        }

        $books = [];
        $books[$bid] =& $book;
    }

    $temp_dir = cb_tmpdir();
    $temp_filename = tempnam($temp_dir, 'grn_addr_');

    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    if ($title) {
        require_once('fw/i18n.csp');
        $header = [];
        $header[] = cb_msg('grn.address', 'access_csv_code');
        $header[] = cb_msg('grn.address', 'access_csv_item');
        $header[] = cb_msg('grn.address', 'access_csv_value');
        $header[] = cb_msg('grn.address', 'access_csv_target');
        $csv->writeLine($header);
    }

    require_once('address/access.csp');
    $access_manager = GRN_Address_AccessManager::getInstance();
    foreach (array_keys($books) as $book_id) {
        $book =& $books[$book_id];
        $access_manager->exportAccessToCSV($csv, $book->getRow());
    }
    $csv->close();

    cb_prepare_download('address_access.csv', 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    $size = filesize($temp_filename);
    if (0 < $size) {
        echo fread($fp, $size);
    }
    fclose($fp);

    unlink($temp_filename);
}

// 監査する
require_once('address/inspection.csp');
$inspection = GRN_Address_Inspection::getInstance();
if ($inspection->isEnabled()) {
    $section = GRN_ADDRESS_INSPECTION_EXPORT;
    $message = GRN_ADDRESS_INSPECTION_SHARED_ADDRESS_BOOK_ACCESS;
    $params = ['bid' => $bid];

    $inspection->record($section, $message, $params);
}


