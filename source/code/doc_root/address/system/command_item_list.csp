<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('address/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();

    require_once('address/config.csp');
    $config_manager = GRN_Address_ConfigManager::getInstance();

    require_once('address/inspection.csp');
    $inspection = GRN_Address_Inspection::getInstance();

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');

    // GET/POSTされたパラメータを取得する
    $bid = @ $G_INPUT['bid'];
    if (0 == strlen($bid)) {
        cb_throw_error(E_GRN_ADDRESS_INVALID_BOOK_ID);
    }
    $builtin_items = @ $G_INPUT['builtin_items'];
    $extended_items = @ $G_INPUT['extended_items'];

    // アドレス帳を取得する
    /** @var GRN_Address_Application $app */
    $app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
    if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }
    $book_manager =& $app->getBookManager();

    // ログインユーザーを取得する
    $login =& $uum->getLoginUser();
    if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }
    $login_id = $login->getOID();

    // ブックを取得する
    if (0 > $bid) {
        if ( ! ($book
            =& $book_manager->getPrivateAddressBookByUserId($login_id))
        ) {
            if ( ! ($book =& $book_manager->addPrivateAddressBook('cyde',
                $login_id, []))
            ) {
                cb_throw_error(E_GRN_ADDRESS_PRIVATE_ADDRESS_BOOK_NOT_FOUND);
            }
        }
    } else {
        if ( ! ($book =& $book_manager->getSharedAddressBook($bid))) {
            cb_throw_error(E_GRN_ADDRESS_SHARED_ADDRESS_BOOK_NOT_FOUND);
        }
    }

    // 組み込み項目情報一覧の設定を変更する
    $config =& $config_manager->getSystemConfig();
    $config->setBuiltinItems($book, $builtin_items, false);

    if ($inspection->isEnabled()) {
        require_once('address/view_util.csp');
        $view_util = GRN_Address_ViewUtil::getInstance();

        $section = GRN_ADDRESS_INSPECTION_CONFIG;
        $params = [];
        if (0 > $bid) {
            $message = GRN_ADDRESS_INSPECTION_PRIVATE_ADDRESS_CARD_ITEM;
        } else {
            $message = GRN_ADDRESS_INSPECTION_SHARED_ADDRESS_CARD_ITEM;
            $params['bid'] = $bid;
        }

        $items = $view_util->listBuiltinItems($book);
        unset($items['subject']);
        unset($items['route_detail']);
        foreach ($items as $item_id => $item) {
            $params['iid'] = $item_id;

            $informations = [];
            $informations['use'] = @ $item['use'];
            if (is_null($informations['use'])) {
                $informations['use'] = '0';
            }

            $informations['necessary'] = @ $item['necessary'];
            if (is_null($informations['necessary'])) {
                $informations['necessary'] = '0';
            }

            $informations['not_modify'] = @ $item['not_modify'];
            if (is_null($informations['not_modify'])) {
                $informations['not_modify'] = '0';
            }

            $informations['display'] = @ $item['display'];
            if (is_null($informations['display'])) {
                $informations['display'] = '0';
            }
            $inspection->record($section, $message, $params, $informations);
        }
    }

    // 拡張項目情報一覧の設定を変更する
    $items = $book->listItems();
    $keys = [
        'use',
        'necessary',
        'not_modify',
        'display'
    ];
    foreach (array_keys($items) as $item_id) {
        $extended_item =& $extended_items[$item_id];

        $properties = [];
        foreach ($keys as $key) {
            $properties[$key] = @ $extended_item[$key];
        }
        $book->setItemProperties($item_id, $properties);
    }

    // set modification timestamp
    $mtime = new CB_TimeStamp();
    $mtime->unix_ts = time();
    $properties = [
        'modifier'      => $login,
        'modifier_name' => $login->get('display_name'),
        'mtime'         => $mtime
    ];
    $book->setProperties($properties);

    cb_redirect('address/system/item_index');
}


