<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
$nid = @ $G_INPUT['nid'];

$reset = null;
if (array_key_exists('reset', $G_INPUT)) {
    $reset = $G_INPUT['reset'];
}

$session_name = 'address.system.access_add';
$ous_params = ['nid' => $nid];
$can_select_role = true;
$search_login_name = true;
require_once('grn/org_user_role_select.csp');
$t->assign('ous_params', $ous_params);

$t->assign('listbox_size', $navigation_info['navi']['number_on_page'] + 1);

// tree link page
$t->assign('link_page', cb_get_pagename());

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$t->assign('site_position',
    [
        [
            'page' => 'address/system/access_index',
            'name' => grn_get_page_display_name('address/system/access_index'),
            'nid'  => $nid
        ],
        [
            'page'  => 'address/system/access_list',
            'name'  => grn_get_page_display_name('address/system/access_list'),
            'nid'   => $nid,
            'reset' => 1
        ],
        ['page' => null, 'name' => $page_title],
    ]
);

// （ビューで表示するための）権限情報一覧を取得する
$authority_types = [
    'browse'  => cb_msg('grn.address', 'browse'),
    'editing' => cb_msg('grn.address', 'editing')
];
$t->assign('authority_types', $authority_types);
$t->assign('authority_count', count($authority_types));

// アドレス帳を取得する
require_once('address/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Address_Application $app */
$app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
    cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
}
$book_manager =& $app->getBookManager();

if (0 < strlen($nid)) {
    // 共有アドレスブックを取得する
    $node = [];
    $node_row =& $book_manager->getSharedAddressBook($nid);
    if ( ! $node_row) {
        cb_throw_error(E_GRN_ADDRESS_SHARED_ADDRESS_BOOK_NOT_FOUND);
    }

    // 共有アドレスブック情報を取得する
    require_once('address/view_util.csp');
    $view_util = GRN_Address_ViewUtil::getInstance();
    $node = $view_util->getBook($node_row, 'access');
}

$security_model = $node['security_model'];
$check_security_model = GRN_ADDRESS_SECURITYMODEL_REVOKE == $security_model
    ? 'revoke' : 'grant';
$t->assign('is_grant', $check_security_model == 'grant');

// （GRANTの）権限一覧を取得する
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session
    =& $session_manager->getSession('address.system.access_list');
$authority_browse = $session->get('authority_browse');
$authority_editing = $session->get('authority_editing');
$authorities = [];
if ((is_null($authority_browse) && is_null($authority_editing)) || $reset) {
    if (GRN_ADDRESS_SECURITYMODEL_REVOKE == $security_model) {
        $authority_browse = 0;
        $authority_editing = 0;
    } else {
        $authority_browse = 1;
        $authority_editing = 1;
    }
    $session->set('authority_browse', $authority_browse);
    $session->set('authority_editing', $authority_editing);
}
$authorities['browse'] = $authority_browse;
$authorities['editing'] = $authority_editing;
$t->assign('authorities', $authorities);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

