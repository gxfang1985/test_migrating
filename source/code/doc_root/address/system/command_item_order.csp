<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // GET/POSTされたパラメータを取得する
    $bid = @ $G_INPUT['bid'];
    if (0 == strlen($bid)) {
        cb_throw_error(E_GRN_ADDRESS_INVALID_BOOK_ID);
    }
    $iids = @ $G_INPUT['iid'];
    if (0 < count($iids)) {
        require_once('address/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();

        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');

        // アドレス帳を取得する
        /** @var GRN_Address_Application $app */
        $app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
        if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
            cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
        }

        // ログインユーザーを取得する
        $login =& $uum->getLoginUser();
        if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
            cb_throw_error(E_GRN_USER_NOT_FOUND);
        }
        $login_id = $login->getOID();

        // ブックを取得する
        $book_manager =& $app->getBookManager();
        if (0 > $bid) {
            if ( ! ($book
                =& $book_manager->getPrivateAddressBookByUserId($login_id))
            ) {
                if ( ! ($book =& $book_manager->addPrivateAddressBook('cyde',
                    $login_id, []))
                ) {
                    cb_throw_error(E_GRN_ADDRESS_PRIVATE_ADDRESS_BOOK_NOT_FOUND);
                }
            }
        } else {
            if ( ! ($book =& $book_manager->getSharedAddressBook($bid))) {
                cb_throw_error(E_GRN_ADDRESS_SHARED_ADDRESS_BOOK_NOT_FOUND);
            }
        }

        // 拡張項目一覧の表示順番を変更する
        $items = $book->listItems();

        foreach ($iids as $list_index => $item_id) {
            $properties = ['list_index' => $list_index];
            if ( ! $book->setItemProperties($item_id, $properties,
                GRN_ADDRESS_INSPECTION_ORDER)
            ) {
                cb_throw_error(E_GRN_ADDRESS_EXTENDED_ITEM_NOT_FOUND);
            }
        }
    }
    cb_redirect('address/system/item_list', ['bid' => $bid]);
}


