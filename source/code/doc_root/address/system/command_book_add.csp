<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    //get language values
    require_once('fw/i18n.csp');
    $inputLocalNameArray
        = getMultiLanguageText(GRN_ADDRESS_ELEMENT_NAME_SHAREDBOOK, $G_INPUT);

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'address/system/book_add';
    SmartyValidate::register_form($target_name);

    // GET/POSTされたパラメータを取得する
    $book_type = null;
    if (array_key_exists('type', $G_INPUT)) {
        $book_type = $G_INPUT['type'];
    }

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        require_once('fw/string_util.csp');
        $foreignKey = cb_trim_check($G_INPUT['id'], E_COMMON_MISSING_MANDATORY);

        // ブックマネージャーを取得する
        require_once('address/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();
        /** @var GRN_Address_Application $app */
        $app = $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
        if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
            cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
        }
        $book_manager = $app->getBookManager();


        // 共有アドレスブックを生成する
        $book_manager->addSharedBook($book_type, $inputLocalNameArray,
            $foreignKey);


        SmartyValidate::unregister_form($target_name);

        cb_redirect('address/system/book_list');
    } else {
        $t->setPageInfo($target_name);
        include('_book_add.csp');

        $t->assign('id', cb_at($G_INPUT, 'id'));
        $t->assign('type', cb_at($G_INPUT, 'type'));

        $multiLanguageInfoArray = [];
        $multiLanguageInfoArray['element_name']
            = GRN_ADDRESS_ELEMENT_NAME_SHAREDBOOK;
        $multiLanguageInfoArray['values'] = $inputLocalNameArray;
        $t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

        $t->display($target_name . '.tpl');
    }
}


