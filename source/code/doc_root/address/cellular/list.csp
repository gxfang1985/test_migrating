<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// 
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app =& $locator->getInstance('cellular');
$user_config =& $cellular_app->getUserConfig($G_login_user);
$limit = (int)($user_config->getListMax() / 2);
$width = $user_config->getSubjectWidth();

$page = (isset($G_INPUT['pg'])) ? $G_INPUT['pg'] : null;
$gid = (isset($G_INPUT['gid'])) ? $G_INPUT['gid'] : null;

$smarty->assign('width', $width);

$tab = [
    'mode'   => 'b',
    'page'   => cb_get_pagename(),
    'params' => null,
    'add'    => [
        [ // 検索tab
          'mode' => 's',
          'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

$smarty->assign('access_plugin', null);

if ( ! strlen($gid)) {
    $smarty->assign('gid', 'b');
} else {
    // gid分割
    $smarty->assign('gid', $gid);
    if (($p = strpos($gid, ':')) !== false) {
        $group_id = substr($gid, 0, $p);
    } else {
        $group_id = $gid;
    }
    $prefix = substr($group_id, 0, 1);
    if ( ! is_numeric($prefix)) {
        $group_id = substr($group_id, 1);
    } else {
        $prefix = 'g';
    }
    $tab['mode'] = $prefix;

    $display_obj = [];
    $members = [];
    if ($prefix == 's') {
        // 検索ページにswitch
        grn_cellular_switch_page($G_pagepath . '/search1');
    } elseif ($prefix == 'm') {
        if (strlen($group_id)) {
            // Myグループ
            if ( ! ($group = &$G_uum->getMyGroup($group_id))) {
                cb_throw_error(E_GRN_MYGROUP_NOT_FOUND);
            }
            // ユーザーの取得
            $members = $G_uum->getMyGroupUsers($group->getOID());
        }
    } elseif ($prefix == 'u') {
        // 最近選択したユーザー
        $lists = $G_uum->getFrequentUsersInfo($G_login_user->getOID());
        foreach (array_keys($lists) as $_id) {
            $members[$_id] = $G_uum->getUser($_id);
        }
    } else {
        if (strlen($group_id)) {
            // 組織
            if ( ! ($group = &$G_uum->getGroup($group_id))) {
                cb_throw_error(E_GRN_GROUP_NOT_FOUND);
            }
            $smarty->assign('organize', [
                'mid'  => 'g' . $group->getOID(),
                'name' => $group->get('name')
            ]);
            // ユーザーの取得
            $members = $G_uum->getGroupUsers($group->getOID());
        }
    }

    // 絞り込む
    if ($members) {
        require_once('cellular/config.csp');
        require_once('cellular/utils.csp');
        $config = GRN_Cellular_SystemConfig::getInstance();
        $config_selected_items = $config->getDisplayedUserItemsAsSearchResult();
        foreach ($members as $id => $obj) {
            $selected_items = [
                getSelectedFieldInformation($config_selected_items['items'][0],
                    $obj),
                getSelectedFieldInformation($config_selected_items['items'][1],
                    $obj)
            ];
            $selected_item_codes = $config_selected_items['items'];

            array_push($display_obj, [
                'mid'        => $id,
                'name'       => $obj->get('display_name'),
                'item_codes' => $selected_item_codes,
                'items'      => $selected_items
            ]);
        }
    }

    //ページ毎に表示するリストを取得。
    $total_count = count($display_obj);
    if ($total_count > $limit) {
        $start_point = ($page) * $limit;
        $end_point = ($page + 1) * $limit;

        $temp = [];
        for ($i = $start_point; $i < $end_point; $i++) {
            if (isset($display_obj[$i])) {
                array_push($temp, $display_obj[$i]);
            }
        }
        if ($end_point < $total_count) {
            $next = $page + 1;
            $smarty->assign('next_page', $next);
            $smarty->assign('next', true);
        }
        if ($page > 0) {
            $before = $page - 1;
            $smarty->assign('before_page', $before);
            $smarty->assign('before', true);
        }
        $smarty->assign('objects', $temp);
    } else {
        $smarty->assign('objects', $display_obj);
    }
}

$G_cellular_session->set('back-from-address-view', $G_INPUT);


$smarty->assign('tab', $tab);
$smarty->display(cb_get_pagename() . '.tpl');


