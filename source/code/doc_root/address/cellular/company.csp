<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

require_once('address/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
require_once('address/access.csp');
$access_manager = GRN_Address_AccessManager::getInstance();
require_once('address/config.csp');
$config_manager = GRN_Address_ConfigManager::getInstance();
require_once('address/view_util.csp');
$view_util = GRN_Address_ViewUtil::getInstance();

// GET/POSTされたパラメータを取得する
$bid = (isset($G_INPUT['bid'])) ? $G_INPUT['bid'] : null;
if (0 == strlen($bid)) {
    assert('FALSE');
}
$cid = (isset($G_INPUT['cid'])) ? $G_INPUT['cid'] : null;
if (0 == strlen($cid)) {
    assert('FALSE');
}
$smarty->assign('bid', $bid);
$smarty->assign('cid', $cid);


// アドレス帳を取得する
/** @var GRN_Address_Application $app */
$app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
    cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
}
$book_manager =& $app->getBookManager();
// ログインユーザー
$login_id = $G_login_user->getOID();

// アドレス帳の設定を取得する
$system_config =& $config_manager->getSystemConfig();
$personal_config =& $config_manager->getPersonalConfig($G_login_user);

// 使用権限を取得する
if ( ! ($row =& $access_manager->getAbstractData(GRN_ADDRESS_AVAILABLE))) {
    assert('FALSE');
}

// ダイナミックロールを取得する
$dynamic_roles = $G_uum->listGrantedRoles();

// 使用権限を評価する
$authorities = ['private_address', 'shared_address'];
$security_model = $access_manager->getSecurityModel($row);
$access = $access_manager->evaluateAccess($row, $G_login_user,
    $dynamic_roles, $authorities, $security_model);

// 個人アドレス帳の使用権限を評価する
$authorities = ['private_address'];
$access_for_view = [];
$access_for_view['private_address'] = $access_manager->isAllowedAccess($access,
    $authorities, $security_model);

// 共有アドレス帳の使用権限を評価する
$authorities = ['shared_address'];
$access_for_view['shared_address'] = $access_manager->isAllowedAccess($access,
    $authorities, $security_model);

$books = [];
$allow_books = [];
if ($access_for_view['shared_address']) {
    // 共有アドレスブック一覧を取得する
    $books = $book_manager->listSharedAddressBooks();

    if (0 < count($books)) {
        // 閲覧、編集権限を持つ共有アドレスブック一覧を取得する
        $rows = [];
        foreach (array_keys($books) as $book_id) {
            $book =& $books[$book_id];
            $rows[$book_id] =& $book->getRow();
        }

//        $authorities = array( 'browse', 'editing' );
        $authorities = ['browse'];
        $allow_books = $access_manager->pickAllowedObjects($rows, $G_login_user,
            $dynamic_roles, $authorities);
    }
}

// ブックを取得する
$allow_count = 0;
$access_editing = true;
if (0 > $bid) {
    if ( ! $access_for_view['private_address']) {
        cb_throw_error(E_GRN_ADDRESS_ACCESS_DENY_PRIVATE_ADDRESS);
    }

    if ( ! ($book =& $book_manager->getPrivateAddressBookByUserId($login_id))) {
        if ( ! ($book =& $book_manager->addPrivateAddressBook('cyde', $login_id,
            []))
        ) {
            cb_throw_error(E_GRN_ADDRESS_PRIVATE_ADDRESS_BOOK_NOT_FOUND);
        }
    }
} else {
    if ( ! $access_for_view['shared_address']) {
        cb_throw_error(E_GRN_ADDRESS_ACCESS_DENY_SHARED_ADDRESS);
    }

    if ( ! array_key_exists($bid, $allow_books)) {
        $book =& $books[$bid];
        $row =& $book->getRow();
        $authorities = ['browse'];

        $access = $access_manager->evaluateAccess($row, $G_login_user,
            $dynamic_roles, $authorities);
        if ( ! $access_manager->isAllowedAccess($access, $authorities,
            $security_model)
        ) {
            cb_throw_error(E_GRN_ADDRESS_ACCESS_DENY_BROWSE);
        }
        $access_editing = false;
    } else {
        $book =& $books[$bid];
    }
    $allow_count = 1;
}

// アドレスデータを取得する
if ( ! ($data = $book->getData($cid))) {
    cb_throw_error(E_GRN_ADDRESS_CARD_NOT_FOUND);
}
$data_for_view = $view_util->getData($data, $bid);

$smarty->assign('book_data', $data_for_view);

$smarty->display(cb_get_pagename() . '.tpl');

