<?php

$mygroup_id = null;
if (array_key_exists('mgid', $G_INPUT)) {
    $mygroup_id = $G_INPUT['mgid'];
}

if (is_null($mygroup_id) || 0 == strlen($mygroup_id)) {
    cb_throw_error(E_GRN_ADDRESS_MYGROUP_NOT_FOUND);
}

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();

    require_once('address/mygroup_logic.csp');
    $mygroup = GRN_Address_MyGroup_Logic::getInstance();
    $group = $mygroup->getMyGroup($login, $mygroup_id);

    require_once('address/mygroup_data_logic.csp');

    if ($group === false) {
        cb_throw_error(E_GRN_ADDRESS_MYGROUP_NOT_FOUND);
    }

    require_once('grn/multi_select_utility.csp');
    $G_INPUT = grn_deploy_selected_users('selected_sUID', 'sUID', $G_INPUT,
        ",");

    $selected_address_users = [];
    if (array_key_exists('sUID', $G_INPUT)) {
        $selected_address_users = $G_INPUT['sUID'];
    }

    $address_items = [];
    foreach ($selected_address_users as $value) {
        $value = explode(":", $value);
        if (count($value) < 2) {
            cb_throw_error(E_GRN_ADDRESS_CARD_NOT_FOUND);
        }

        $type = $value[0];
        $id = $value[1];

        switch ($type) {
            case 'sharedbook':
                $type = GRN_ADDRESS_MYGROUP_DATA_TYPE_SHARED;
                break;
            case 'privatebook':
                $type = GRN_ADDRESS_MYGROUP_DATA_TYPE_PRIVATE;
                break;
            case 'user':
                $type = GRN_ADDRESS_MYGROUP_DATA_TYPE_USER;
                break;
            default:
                cb_throw_error(E_GRN_ADDRESS_CARD_NOT_FOUND);
        }
        $address_items[] = ['id' => $id, 'address_type' => $type];
    }

    // アドレス帳を取得する
    require_once('address/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Address_Application $app */
    $app =& $app_locator->getInstance(GRN_ADDRESS_APPLICATION_ID);
    if ( ! is_object($app) || ! is_a($app, 'GRN_Address_Application')) {
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }
    $book_manager =& $app->getBookManager();

    include('_mygroup_book_access.csp');

    $mygroup_data = GRN_Address_MyGroupData_Logic::getInstance();
    $mygroup_data->changeGroupData($group, $address_items, $allow_books);
}

cb_redirect('address/mygroup_list', ['mgid' => $mygroup_id]);


