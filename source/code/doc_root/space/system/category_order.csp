<?php

use grn\space\common\data\bean\Category;
use grn\space\common\utility\CategoryUtility;
use grn\space\service\SpaceService;

global $G_INPUT;
$parent_cid = @$G_INPUT['cid'];
if ( ! $parent_cid) {
    $parent_cid = Category::ROOT_ID;
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

require_once("fw/i18n.csp");
$i18n = \CB_I18N::getInstance();
$languageCode = $i18n->getCurrentLanguage();

$service = SpaceService::getInstance();
$parent_category = $service->getSpaceCategory($parent_cid,
    $login->getOID(), $languageCode);
$parent_category_for_view = CategoryUtility::getView($parent_category);

$child_categories = $service->getChildCategoryList($parent_cid, $languageCode);

$category_information_for_view = $parent_category_for_view;
$category_information_for_view['child_categories'] = [];
/** @var \grn\space\common\data\bean\Category $child_category */
foreach ($child_categories as $child_category) {
    $category_information_for_view['child_categories'][$child_category->getId()]
        = $child_category->getCategoryName();
}

$pagename = grn_get_current_page_display_name();
$sitePosition = [
    [
        "name"      => grn_get_page_display_name('space/system/category_list'),
        "page"      => 'space/system/category_list',
        "cid"       => $parent_cid,
        "filter_id" => cb_at($G_INPUT, 'filter_id'),
    ],
    [
        "name"      => grn_get_page_display_name('space/system/category_view'),
        "page"      => 'space/system/category_view',
        "cid"       => $parent_cid,
        "filter_id" => cb_at($G_INPUT, 'filter_id'),
    ],
    ['name' => $pagename]
];

require_once('grn/smarty.csp');
$smarty = new GRN_Smarty();
$smarty->assign('category', $category_information_for_view);
$smarty->assign('site_position', $sitePosition);
$smarty->display(cb_get_pagename() . '.tpl');
