<?php

use grn\space\common\data\bean\Category;
use grn\space\common\utility\CategoryUtility;
use grn\space\common\data\condition\CategorySearchCondition;
use grn\space\service\SpaceService;
use grn\space\screen\SystemCategoryMove;

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

global $G_INPUT;
$target_cid = array_key_exists('cid', $G_INPUT) ? $G_INPUT['cid']
    : Category::ROOT_ID;
$selected_cid = array_key_exists('ss', $G_INPUT) ? $G_INPUT['s_cid']
    : $target_cid;

$screen = SystemCategoryMove::createInstance($login->getOID());
$service = SpaceService::getInstance();

require_once('grn/smarty.csp');
$smarty = new GRN_Smarty();

//Get Target Category
$target_category = $screen->getSpaceCategoryUsingLoginUserLanguage($target_cid);
$target_category_for_view = CategoryUtility::getView($target_category);

// Get Parent Category
$parent_category
    = $screen->getSpaceCategoryUsingLoginUserLanguage($target_category->getParentCategoryId());
$target_category_for_view['parent']
    = CategoryUtility::getView($parent_category);
$target_category_for_view['parent']['path']
    = $screen->getPath($parent_category);

$category_information_for_view = $target_category_for_view;
$category_information_for_view['child_categories'] = [];
$child_categories
    = $service->getChildCategoryList($target_cid);
/** @var \grn\space\common\data\bean\Category $child_category */
foreach ($child_categories as $child_category) {
    $category_information_for_view['child_categories'][$child_category->getId()]
        = CategoryUtility::getView($child_category);
}
$smarty->assign('target', $category_information_for_view);

//Check Search Flag
if (array_key_exists('text', $G_INPUT)) {
    $condition = new CategorySearchCondition();
    $condition->setSearchStringArray([$G_INPUT['text']]);
    $condition->setSearchItemBit(CategorySearchCondition::SEARCH_ITEM_CATEGORY_NAME);
    $condition->setSearchCategoryId(Category::ROOT_ID);
    $condition->setSearchScopeType(CategorySearchCondition::SEARCH_SCOPE_CATEGORY_DESCENDANT);
    $condition->setOrderSortArray([CategorySearchCondition::SORT_DISPLAY_ORDER_ASC]);
    $search_categories
        = $service->searchSpaceCategoryBySearchCondition($condition,
        $login->getOID());
    $search_categories_for_view = [];
    /** @var \grn\space\common\data\bean\Category $category */
    foreach ($search_categories as $category) {
        if ( ! $screen->isSelectable($target_category, $category)) {
            continue;
        }

        $search_categories_for_view[$category->getId()]
            = CategoryUtility::getView($category);
        $search_categories_for_view[$category->getId()]['path']
            = $screen->getPath($category);
    }

    $search_information_for_view = [];
    $search_information_for_view['result'] = $search_categories_for_view;
    $search_information_for_view['count'] = count($search_categories_for_view);
    $search_information_for_view['text'] = $G_INPUT['text'];

    $smarty->assign('category_id', $target_cid);
    $smarty->assign('set_category_id', $selected_cid);
    $smarty->assign('search', $search_information_for_view);
} else {
    $selected_category
        = $screen->getSpaceCategoryUsingLoginUserLanguage($selected_cid);
    $selected_category_for_view
        = CategoryUtility::getView($selected_category);
    $selected_category_for_view['category_name']
        = $selected_category->getCategoryName();

    $selected_category_children
        = $screen->getChildCategoryListUsingLoginUserLanguage($selected_cid);
    $selected_category_for_view['children'] = [];
    foreach ($selected_category_children as $child_category) {
        if ( ! $screen->isSelectable($target_category, $child_category)) {
            continue;
        }

        $selected_category_for_view['children'][$child_category->getId()]
            = CategoryUtility::getView($child_category);
    }

    // set ancestors 
    $condition = new CategorySearchCondition();
    $condition->setSearchCategoryId($selected_cid);
    $condition->setSearchScopeType(CategorySearchCondition::SEARCH_SCOPE_CATEGORY_ANCESTOR);
    $condition->setOrderSortArray([CategorySearchCondition::SORT_HIERARCHY_LEVEL_ASC]);
    $ancestors
        = $screen->searchSpaceCategoryBySearchConditionUsingLoginUserLanguage($condition);
    $selected_category_for_view['ancestors'] = [];
    /** @var \grn\space\common\data\bean\Category $ancestor */
    foreach ($ancestors as $ancestor) {
        $ancestor_for_view = [];
        $ancestor_for_view['cid'] = $ancestor->getId();
        $ancestor_for_view['name']
            = $ancestor->getCategoryName();
        $selected_category_for_view['ancestors'][] = $ancestor_for_view;
    }
    array_pop($selected_category_for_view['ancestors']);
    $smarty->assign('category', $selected_category_for_view);
    $smarty->assign('set_category_id', $selected_cid);
    $smarty->assign('category_id', $target_cid);
}

$page_title = grn_get_current_page_display_name();
$sitePosition = [
    [
        "name" => grn_get_page_display_name('space/system/category_list'),
        "page" => 'space/system/category_list',
        "cid"  => $target_cid
    ],
    [
        "name" => grn_get_page_display_name('space/system/category_view'),
        "page" => 'space/system/category_view',
        "cid"  => $target_cid
    ],
    [
        "name" => $page_title
    ]
];
$smarty->assign('page_title', $page_title);
$smarty->assign('site_position', $sitePosition);
$smarty->display(cb_get_pagename() . '.tpl');



