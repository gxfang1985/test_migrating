<?php

use grn\space\service\KintoneService;
use grn\space\logic\SpaceSystemLogic;
use grn\space\common\logic\legacy\SpaceLogLogic;
use grn\space\data\bean\log\SystemGeneralSettingLog;

define('DEFAULT_DAYS_EXPIRATION_DATE', 0);
define('ALLOW_UNLIMITED_EXPIRATION_DATE', '1');

if (strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST') == 0) {
    global $G_INPUT;
    if (cb_at($G_INPUT, 'default_expiration_date')
        == ALLOW_UNLIMITED_EXPIRATION_DATE
    ) {
        $G_INPUT['default_public_limited'] = DEFAULT_DAYS_EXPIRATION_DATE;
    }
    require_once('grn/smarty.csp');
    $smarty = new GRN_Smarty();
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($smarty);
    $form_name = 'space/system/common_set';
    SmartyValidate::register_form($form_name);

    if (SmartyValidate::is_valid($G_INPUT, $form_name)) {
        $default_days_expiration_date = DEFAULT_DAYS_EXPIRATION_DATE;
        $privacy_default = cb_at($G_INPUT, 'privacy_default',
            true);
        $space_system_logic = new SpaceSystemLogic();
        $space_system_logic->setDefaultPrivacy((bool)$privacy_default);

        $is_allowed_unlimited = cb_at($G_INPUT, 'allow_unlimited');
        $space_system_logic->setIsUnlimitedExpirationDate((bool)$is_allowed_unlimited);
        $default_expiration_date_type = cb_at($G_INPUT,
            'default_expiration_date');
        $allow_unlimited = false;
        $space_system_logic->setDefaultExpirationDateType((bool)$default_expiration_date_type);

        if ($default_expiration_date_type === ALLOW_UNLIMITED_EXPIRATION_DATE) {
            $allow_unlimited = true;
        } else {
            $default_days_expiration_date = cb_at($G_INPUT,
                'default_public_limited');
        }
        $space_system_logic->setDefaultDaysExpirationDate((int)$default_days_expiration_date);
        $general_setting_log_bean = new SystemGeneralSettingLog();
        $general_setting_log_bean->setPrivacyDefault((bool)$privacy_default);
        $general_setting_log_bean->setAllowUnlimitedPeriod((bool)$is_allowed_unlimited);
        $general_setting_log_bean->setDefaultExpirationDate($allow_unlimited,
            $default_days_expiration_date);
        require_once("space/GrnSpaceApplication.csp");
        $space_log_logic
            = new SpaceLogLogic(\GrnSpaceApplication::GRN_SPACE_MODULE_ID);

        require_once('kintone/Logic.csp');
        $logic = new GRN_Kintone_Logic();
        if (GRN_Kintone_Logic::isAvailable()) {
            $available = cb_at($G_INPUT, 'use_kintone', false);
            $service = KintoneService::getInstance();
            $service->setAvailable((bool)$available);

            $general_setting_log_bean->setEnableKintoneConnector((bool)$available);
            if ((bool)$available) {
                $general_setting_log_bean->setKintoneUrl($logic->getKintoneURL());
            }

            $space_log_logic->info($general_setting_log_bean);
        } else {
            $space_log_logic->notice($general_setting_log_bean);
        }

        cb_redirect('system/application_list', ['app_id' => 'space']);
    } else {
        require_once('_common_set.csp');
        require_once('kintone/Logic.csp');
        $privacy_default = (bool)cb_at($G_INPUT, 'privacy_default');
        $smarty->assign('privacy_default', $privacy_default);
        if (GRN_Kintone_Logic::isAvailable()) {
            $service = KintoneService::getInstance();
            $available = $G_INPUT['use_kintone'] ?? $service->isAvailable();
            $smarty->assign('url', GRN_Kintone_Logic::getKintoneURL());
            $smarty->assign('available', (int)$available);
        } else {
            $smarty->assign('no_kintone_connector', true);
        }
        $smarty->assign('allow_unlimited',
            (bool)cb_at($G_INPUT, 'allow_unlimited'));
        $smarty->assign('is_default_limited', true);
        $smarty->assign('is_disable_days_after', false);
        $smarty->assign('default_public_limited',
            cb_at($G_INPUT, 'default_public_limited'));
        $smarty->setPageInfo($form_name);
        $smarty->display($form_name . '.tpl');
    }
}
