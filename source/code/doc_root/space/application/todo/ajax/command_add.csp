<?php

use grn\space\screen\application\todo\TodoAdd;
use grn\space\screen\common\ApplicationScreenCommon;
use grn\space\screen\GenericScreenBase;

$G_state_set->set('html_should_be_closed', false);
$G_state_set->set('copyright_should_be_written', false);
$G_state_set->set('error_page_type', 'json');

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;
    require_once('grn/multi_select_utility.csp');
    $G_INPUT = grn_deploy_selected_users('selected_users_todo_sUID',
        'todo_sUID', $G_INPUT);

    $screen = new ApplicationScreenCommon(new TodoAdd($G_INPUT));
    $newTodo = $screen->post($G_INPUT);

    $from = @ $G_INPUT[GenericScreenBase::ARG_FROM];
    $url = '';
    switch ($from) {
        case GenericScreenBase::FROM_DISCUSSION_INDEX:
            $url = cb_pageurl('space/application/discussion/index',
                ['spid' => @$G_INPUT['spid']], 'tid=' . $G_INPUT['tid']);
            break;
        case GenericScreenBase::FROM_TODO_INDEX:
        default:
            $url = cb_pageurl('space/application/todo/index',
                ['spid' => @$G_INPUT['spid'], 'tid' => @$G_INPUT['tid']]);
            break;
    }
    echo json_encode([
        'redirect' => $url,
        'todo_id'  => $newTodo->getId(),
        'from'     => $from
    ]);
}
