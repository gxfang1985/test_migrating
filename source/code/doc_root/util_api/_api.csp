<?php

$page_path = strtolower(cb_get_pagename());
$page_parts = explode('/', $page_path);

$app_id = $page_parts[1];

cb_require_role('LoginUser');

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app_ids = $locator->getApplicationIds();

$is_application = true;
if ( ! in_array($app_id, $app_ids)) {
    $app_id = 'common';
    $is_application = false;
}

if ($is_application && $app =& $locator->getInstance($app_id)) {
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    // Check application license.
    if ($redirect = $app->forceRedirect($page_parts) !== false) {
        cb_throw_error(E_GRN_UTIL_API_LICENSE_EXPIRED);
    }
    // availability check
    if ( ! $app->isAvailableFor($uum->getLoginUser())) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }
} else {
    // activity check
    if (in_array($app_id, $app_ids)) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
    }
}

// execute SOAP action
require_once('util_api/logic.csp');
grn_util_api_service_execute();


