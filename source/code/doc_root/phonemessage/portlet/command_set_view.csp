<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('portal/error_code.csp');
    if ( ! isset($portlet)) {
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session
        =& $session_manager->getSession('phonemessage/portlet/set_view');

    if (array_key_exists('cancel', $G_INPUT)) {
        $session->set('portlet', null);

        if ('set-personal' == @ $G_INPUT['display']) {
            $page = 'portal/personal/view';
        } elseif ('set-operation' == @ $G_INPUT['display']) {
            $page = 'portal/operation/view';
        } else {
            $page = 'portal/system/view';
        }

        cb_redirect($page, ['pid' => $G_INPUT['pid']]);
    }

    if ( ! array_key_exists('apply', $G_INPUT)) {
        $portlet = $session->get('portlet');
        $portlet['settings']['gid'] = @ $G_INPUT['gid'];
        $session->set('portlet', $portlet);

        if ('set-personal' == @ $G_INPUT['display']) {
            $page = 'portal/personal/portlet_display_modify';
        } elseif ('set-operation' == @ $G_INPUT['display']) {
            $page = 'portal/operation/portlet_display_modify';
        } else {
            $page = 'portal/system/portlet_display_modify';
        }

        $params = [
            'pid'   => $G_INPUT['pid'],
            'plid'  => $G_INPUT['plid'],
            'ppid'  => $G_INPUT['ppid'],
            'ss'    => 1,
            's_hid' => @ $G_INPUT['s_hid'],
            'apply' => 1
        ];

        if (array_key_exists('top', $G_INPUT)) {
            $params['top'] = $G_INPUT['top'];
        }

        cb_redirect($page, $params);
    }

    if ( ! array_key_exists('group', $G_INPUT)) {
        cb_throw_error(E_GRN_SCHEDULE_CANTSELECT_GROUP);
    }

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');

    switch ($G_INPUT['group']) {
        case 'all':
            $gid = -1;
            break;
        case 'primary_group':
            $gid = null;
            break;
        case 'org':
            if (array_key_exists('gid', $G_INPUT)) {
                $gid = $G_INPUT['gid'];
                $group =& $uum->getGroup($gid);
                if ( ! is_object($group) || ! is_a($group, 'CB_Group')) {
                    cb_throw_error(E_GRN_GROUP_NOT_FOUND);
                }
            } else {
                cb_throw_error(E_GRN_SCHEDULE_CANTSELECT_GROUP);
            }
            break;
        case 'other':
            if (array_key_exists('ItemID', $G_INPUT)) {
                $gid = $G_INPUT['ItemID'];
                $my_group =& $uum->getMyGroup(mb_substr($gid, 1));
                if ( ! is_object($my_group)
                     || ! is_a($my_group, 'GRN_MyGroup')
                ) {
                    cb_throw_error(E_GRN_MYGROUP_NOT_FOUND);
                }
            } else {
                cb_throw_error(E_GRN_SCHEDULE_CANTSELECT_GROUP);
            }
            break;
        default:
            cb_throw_error(E_GRN_SCHEDULE_CANTSELECT_GROUP);
    }

    $properties_map = [
        'pid'       => '_pid',
        'plid'      => '_plid',
        'ppid'      => '_ppid',
        'font_size' => 'font_size'
    ];

    $properties = [];
    foreach ($properties_map as $view_name => $property_name) {
        $value = null;
        if (array_key_exists($view_name, $G_INPUT)) {
            $value = $G_INPUT[$view_name];
        }
        $properties[$property_name] = $value;
    }

    $properties['gid'] = $gid;

    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app */
    $app =& $app_locator->getInstance('portal');
    $app->setPortletSettings($properties['_plid'], $properties);

    if ('set-system' == @ $G_INPUT['display']) {
        $page = 'portal/system/view';
    } elseif ('set-operation' == @ $G_INPUT['display']) {
        $page = 'portal/operation/view';
    } else {
        $page = 'portal/personal/view';
    }

    cb_redirect($page, ['pid' => $G_INPUT['pid']]);
}


