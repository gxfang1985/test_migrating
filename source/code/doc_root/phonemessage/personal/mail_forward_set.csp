<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// 電話メモを取得する
require_once('phonemessage/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_PhoneMessage_Application $app */
$app = $app_locator->getInstance(GRN_PHONEMESSAGE_APPLICATION_ID);
if ( ! is_object($app) || ! is_a($app, 'GRN_PhoneMessage_Application')) {
    cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
}
$application_name = $app->getName();

// ログインユーザーを取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// 電話メモの設定を取得する
require_once('phonemessage/config.csp');
$config_manager = GRN_PhoneMessage_ConfigManager::getInstance();
$personal_config = $config_manager->getPersonalConfig($login);

// システムメールアカウントの状態を取得する
$available_system_email = false;
require_once('grn/system_mail.csp');
$system_email_config_manager = GRN_SystemMailConfigManager::getInstance();
if ($system_email_config_manager->isAvailable()) {
    $available_system_email = true;
}

// 電話メモをメール転送するか取得する
$forward_email = $personal_config->getForwardEmailFlag();

// 電話メモをユーザー情報のメールアドレスで受け取るか取得する
$forward_user_email = $personal_config->getForwardUserEmailFlag();

// 電話メモを受け取るメールアドレスを取得する
$other_email_address = $personal_config->getOtherEmailAddress();

// ユーザー情報のメールアドレスを取得する
$user_email_address = $login->get('email_address');

$t->assign('application_name', $application_name);
$t->assign('available_system_email', $available_system_email);
$t->assign('forward_email', $forward_email);
$t->assign('forward_user_email', $forward_user_email);
$t->assign('user_email_address', $user_email_address);
$t->assign('other_email_address', $other_email_address);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title
    = grn_get_page_display_name('phonemessage/personal/mail_forward_set');
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$page_info = ['mail_forward_set' => null];
$site_position = $controller_util->makeSitePosition('phonemessage/personal/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


