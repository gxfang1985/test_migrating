<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // 電話メモを取得する
    require_once('phonemessage/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_PhoneMessage_Application $app */
    $app = $app_locator->getInstance(GRN_PHONEMESSAGE_APPLICATION_ID);
    if ( ! is_object($app) || ! is_a($app, 'GRN_PhoneMessage_Application')) {
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }

    // GET/POSTされたパラメータを取得する
    $forward_email = false;
    if (array_key_exists('forward_email', $G_INPUT)) {
        $forward_email = $G_INPUT['forward_email'];
    }
    $forward_user_email = false;
    if (array_key_exists('forward_user_email', $G_INPUT)) {
        $forward_user_email = $G_INPUT['forward_user_email'];
    }
    $other_email_address = null;
    if (array_key_exists('other_email_address', $G_INPUT)) {
        $other_email_address = $G_INPUT['other_email_address'];
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    // システム管理を取得する
    require_once('phonemessage/config.csp');
    $config_manager = GRN_PhoneMessage_ConfigManager::getInstance();
    $personal_config = $config_manager->getPersonalConfig($login);

    // 電話メモをメール転送するか設定する
    $personal_config->setForwardEmailFlag($forward_email);

    // 電話メモをユーザー情報のメールアドレスで受け取るか設定する
    $personal_config->setForwardUserEmailFlag($forward_user_email);

    // 電話メモを受け取るメールアドレスを設定する
    $personal_config->setOtherEmailAddress($other_email_address);

    // 監査する
    require_once('phonemessage/inspection.csp');
    $inspection = GRN_PhoneMessage_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $section = GRN_PHONEMESSAGE_INSPECTION_CONFIG;
        $message = GRN_PHONEMESSAGE_INSPECTION_FORWARD_MAIL;
        $params = [];
        $informations = [];
        if ($forward_email) {
            if ($forward_user_email) {
                $informations['forward_email'] = 'user_info';
            } else {
                $informations['forward_email'] = 'user_established';
                $informations['email_address'] = $other_email_address;
            }
        } else {
            $informations['forward_email'] = 'off';
        }
        $inspection->record($section, $message, $params, $informations);
    }

    cb_redirect('personal/application_list', ['app_id' => 'phonemessage']);
}


