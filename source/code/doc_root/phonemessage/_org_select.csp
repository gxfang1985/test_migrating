<?php

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

require_once('grn/uum_util.csp');
$uum_util = GRN_UumUtil::getInstance();

// ログインユーザーを取得する
$login = &$uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    assert('FALSE');
}

$group_tree = null;
$is_candidate_organization = false;

if ( ! $gid) {
    $gid = '0';
    $group_tree = $uum_util->getGroupSelectionTree($gid);
} elseif ('m' == $gid{0}) {
    $mygroup_id = mb_substr($gid, 1);
    if ( ! ($group = &$uum->getMyGroup($mygroup_id))) {
        $gid = '0';
    }
    $group_tree = $uum_util->getGroupSelectionTree('0');
} else {
    if ( ! ($group = &$uum->getGroup($gid))) {
        $gid = '0';
    } else {
        $t->assign('set_organization_id', $gid);
    }
    $group_tree = $uum_util->getGroupSelectionTree($gid);
}

$organization = [];

if (is_array($group_tree)) {
    $organization['hid'] = @ $group_tree['oid'];
    $organization['title'] = @ $group_tree['title'];

    if (array_key_exists('ancestors', $group_tree)
        && is_array($group_tree['ancestors'])
    ) {
        $organization['path'] = [];
        foreach ($group_tree['ancestors'] as $group) {
            $group_data = ['hid' => $group['oid'], 'title' => $group['title']];

            if (@ $group['child']) {
                $group_data['num_children'] = 1;
            }

            $organization['path'][] = $group_data;
        }
    }
    if (array_key_exists('siblings', $group_tree)
        && is_array($group_tree['siblings'])
    ) {
        $organization['organizations'] = [];

        foreach ($group_tree['siblings'] as $group) {
            $group_data = ['hid' => $group['oid'], 'title' => $group['title']];
            if (@ $group['child']) {
                $group_data['num_children'] = 1;
            }
            $organization['organizations'][] = $group_data;
        }
    }
    if (array_key_exists('children', $group_tree)
        && is_array($group_tree['children'])
    ) {
        $organization['child_organizations'] = [];
        foreach ($group_tree['children'] as $group) {
            $group_data = ['hid' => $group['oid'], 'title' => $group['title']];
            if (@ $group['child']) {
                $group_data['num_children'] = 1;
            }
            $organization['child_organizations'][] = $group_data;
        }
    }
}

$t->assign('organization', $organization);
$t->assign('is_candidate_organization', $is_candidate_organization);

$others_list = [];

$mygroups = $uum->listMyGroups($login);
if (is_array($mygroups) && count($mygroups)) {
    foreach (array_keys($mygroups) as $mygroup_id) {
        $mygroup =& $mygroups[$id];
        if ( ! $mygroup) {
            $mygroup_name = $my_group->get('name');
            $args = ['name' => $mygroup_name];
            $mygroup_name = cb_msg('grn.common', 'title_my_group',
                $args);
            $others_list['m' . $id] = html_entity_decode($mygroup_name);
        }
    }
}

$t->assign('others_list', [0 => ['item' => $others_list]]);


