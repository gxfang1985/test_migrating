<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    $charset = null;
    if (array_key_exists('charset', $G_INPUT)) {
        $charset = $G_INPUT['charset'];
    }
    if (0 == strlen($charset)) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }
    $item_name = 0;
    if (array_key_exists('item_name', $G_INPUT)) {
        $item_name = $G_INPUT['item_name'];
    }

    $temp_dir = cb_tmpdir();
    $temp_filename = tempnam($temp_dir, 'grn_phnm_');

    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    if ($item_name) {
        require_once('fw/i18n.csp');
        $header = [];
        $header[] = cb_msg('grn.phonemessage', 'access_csv_object');
        $header[] = cb_msg('grn.phonemessage', 'access_csv_code');
        $header[] = cb_msg('grn.phonemessage', 'access_csv_item');
        $header[] = cb_msg('grn.phonemessage', 'access_csv_value');
        $header[] = cb_msg('grn.phonemessage', 'access_csv_target');
        $csv->writeLine($header);
    }

    require_once('phonemessage/access.csp');
    $access_manager = GRN_PhoneMessage_AccessManager::getInstance();
    $access_manager->exportAccessToCSV($csv);

    $csv->close();

    cb_prepare_download('phonemessage_access.csv', 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    $size = filesize($temp_filename);
    if (0 < $size) {
        echo fread($fp, $size);
    }
    fclose($fp);

    unlink($temp_filename);

    // 監査する
    require_once('phonemessage/inspection.csp');
    $inspection = GRN_PhoneMessage_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $section = GRN_PHONEMESSAGE_INSPECTION_EXPORT;
        $message = GRN_PHONEMESSAGE_INSPECTION_ACCESS;

        $inspection->record($section, $message);
    }
}

