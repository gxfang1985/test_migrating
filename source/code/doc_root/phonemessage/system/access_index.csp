<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// GET/POSTされたパラメータを取得する
$tid = null;
if (array_key_exists('tid', $G_INPUT)) {
    $tid = $G_INPUT['tid'];
}
$oid = null;
if (array_key_exists('oid', $G_INPUT)) {
    $oid = $G_INPUT['oid'];
}

// 電話メモを取得する
//tv
/*require_once( 'phonemessage/application.csp' );
$app_locator = GRN_ApplicationLocator::instance();
$app =& $app_locator->getInstance( GRN_PHONEMESSAGE_APPLICATION_ID );
if( ! is_object( $app ) || ! is_a( $app, 'GRN_PhoneMessage_Application' ) )
{
    cb_throw_error( E_GRN_APPLICATION_NOT_AVAILABLE );
}*/

$page_name = cb_get_pagename();

// アクセス権情報一覧を取得する
global $G_container_base;
/** @var GRN_Uum $uum */
$uum =& $G_container_base->getInstance('uum');
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$access_info = [];
if ('role' == $tid) {
    // スタティックロール一覧を取得する
    $roles = $uum->listStaticRoles();

    // スタティックロール情報一覧を取得する
    $access_info['role_list'] = $controller_util->listStaticRoles($roles);
} else {
    // 組織情報を取得する
    if (0 > $oid) {
        $access_info = $controller_util->getNoGroup();
    } else {
        $access_info = $controller_util->getGroup($oid);
    }

    // ユーザー情報一覧を取得する
    require_once('grn/org_util.csp');
    if (0 < strlen($oid)) {
        $params = ['oid' => $oid];
        if (0 > $oid) {
            // 組織に未所属
            $user_count = $uum->getNoGroupUserCount();
            $view_set = grn_get_user_navigation_info($user_count, $params);
            $users = $uum->getNoGroupUsers($view_set['offset'],
                $view_set['limit']);
        } else {
            // 組織に所属する
            $user_count = $uum->getGroupUserCount($oid);
            $view_set = grn_get_user_navigation_info($user_count, $params);
            $users = $uum->getGroupUsers($oid, $view_set['offset'],
                $view_set['limit']);
        }
        $access_info['navi_info'] = $view_set;
        $access_info['user_list']
            = $controller_util->listUsersForAccess($users);
    }

    //-- initialize organization tree view
    require_once('grn/org_tree.csp');

    $util = GRN_OrgTreeUtil::getInstance();
    $tree =& $util->getTree($page_name);
    if (is_null($oid)) {
        $org_id = $tree->getSelectedNode();
    }

    if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
        $tree->initialize();
        $org_id = null;
    }

    $tree->setSelectedNode($oid);
    $util->setTree($page_name, $tree);
    $org = $tree->getRoot();

    $t->assign('org', $org);
    $t->assign('async_page', 'phonemessage/system/org_json');
    $t->assign('link_page', 'phonemessage/system/access_index');
    //--
}

$t->assign('target', $tid);
$t->assign('org_id', $oid);
$t->assign('info', $access_info);
if ('role' != $tid) {
    $t->assign('is_nogroups', 0 > $oid);
    $t->assign('is_root', ! $oid);
}

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = ['access_index' => null];
$site_position = $controller_util->makeSitePosition('phonemessage/system/',
    $page_info);
$t->assign('site_position', $site_position);

$t->assign('page_name', $page_name);
// Smartyを実行する
$t->display($page_name . '.tpl');


