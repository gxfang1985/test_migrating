<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// 電話メモを取得する
//tv
/*require_once( 'phonemessage/application.csp' );
$app_locator = GRN_ApplicationLocator::instance();
$app =& $app_locator->getInstance( GRN_PHONEMESSAGE_APPLICATION_ID );
if( ! is_object( $app ) || ! is_a( $app, 'GRN_PhoneMessage_Application' ) )
{
    cb_throw_error( E_GRN_APPLICATION_NOT_AVAILABLE );
}*/

// GET/POSTされたパラメータを取得する
$tid = null;
if (array_key_exists('tid', $G_INPUT)) {
    $tid = $G_INPUT['tid'];
}
$oid = null;
if (array_key_exists('oid', $G_INPUT)) {
    $oid = $G_INPUT['oid'];
}
$uid = null;
if (array_key_exists('uid', $G_INPUT)) {
    $uid = $G_INPUT['uid'];
}
$rid = null;
if (array_key_exists('rid', $G_INPUT)) {
    $rid = $G_INPUT['rid'];
}
$poid = null;
if (array_key_exists('poid', $G_INPUT)) {
    $poid = $G_INPUT['poid'];
}
$itype = null;
if (array_key_exists('itype', $G_INPUT)) {
    $itype = $G_INPUT['itype'];
}
$itid = null;
if (array_key_exists('itid', $G_INPUT)) {
    $itid = $G_INPUT['itid'];
}

require_once('_access_util.csp');

if ( ! $itype || ! $itid) {
    cb_throw_error(E_GRN_PHONEMESSAGE_INVALID_TARGET);
}

// アクセス制御するターゲットを取得する
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
require_once('grn/access_resources.csp');
switch ($itype) {
    case GRN_ACCESS_TARGET_TYPE_DYNAMIC_ROLE:
        $target = $itid;
        break;
    case GRN_ACCESS_TARGET_TYPE_STATIC_ROLE:
        $target =& $uum->getStaticRole($itid);
        break;
    case GRN_ACCESS_TARGET_TYPE_GROUP:
        $target =& $uum->getGroup($itid);
        break;
    case GRN_ACCESS_TARGET_TYPE_USER:
        $target =& $uum->getUser($itid);
        break;
    default:
        cb_throw_error(E_GRN_PHONEMESSAGE_INVALID_TARGET);
}

$row =& grn_get_phonemessage_access_object($tid, $oid, $uid, $rid);

// 付与されたアクセス権を取得する
require_once('phonemessage/access.csp');
$access_manager = GRN_PhoneMessage_AccessManager::getInstance();
$object =& $access_manager->getObject($row);
$access =& $access_manager->getAccess($object, $target);

// 付与されたアクセス権情報を取得する
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$access_for_view = $controller_util->getAccess($access);
$access_for_view['type'] = $itype;

// セキュリティモデルを取得する
$security_model = $access_manager->getSecurityModel($object);
// セキュリティモデル情報を取得する
$security_model_for_view = $controller_util->getSecurityModel($security_model);

$t->assign('access_item', $access_for_view);
$t->assign('security_model', $security_model_for_view);

$t->assign('auth_disable_change_on_off', true);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = [
    'access_index'  => ['sf' => 1, 'tid' => $tid, 'oid' => $oid],
    'access_list'   => [
        'tid'  => $tid,
        'oid'  => $oid,
        'uid'  => $uid,
        'rid'  => $rid,
        'poid' => $poid
    ],
    'access_modify' => null
];
$site_position = $controller_util->makeSitePosition('phonemessage/system/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


