<?php

global $G_INPUT;
global $G_config_common;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

if (array_key_exists('file', $G_INPUT)) {
    $file_id = $G_INPUT['file'];
} else {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

$charset = null;
if (array_key_exists('charset', $G_INPUT)) {
    $charset = $G_INPUT['charset'];
}
if (0 == strlen($charset)) {
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$skip = null;
if (array_key_exists('skip', $G_INPUT)) {
    $skip = $G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
}

$t->assign('file_id', $file_id);
$t->assign('charset', $charset);
$t->assign('skip', $skip);

require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session
    =& $session_manager->getSession('phonemessage/system/access_import1');
$files = $session->getFiles('import_files');

if ( ! is_array($files) && 0 == count($files)) {
    cb_throw_error(E_GRN_PHONEMESSAGE_NOT_FOUND_CSV_FILE);
}
if ( ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_PHONEMESSAGE_NOT_FOUND_CSV_FILE);
}
if ( ! $files[$file_id]->exists()) {
    cb_throw_error(E_GRN_PHONEMESSAGE_NOT_FOUND_CSV_FILE);
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

// 表示するサンプルの行数
$read_lines = 5;

$skip_lines = (int)@$G_INPUT['skip'];
if ($skip_lines) {
    $line = $csv->readLine();
}

// サンプル行の読み込み
$lines = [];
for ($i = 0; $i < $read_lines; ++$i) {
    if (($line = $csv->readLine()) !== false) {
        $lines[] = $line;
    } else {
        break;
    }
}

$t->assign('csv_datas', $lines);
$t->assign('app_id', 'phonemessage');

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$page_info = ['access_import2' => null];
$site_position = $controller_util->makeSitePosition('phonemessage/system/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


