<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'phonemessage/system/access_import1';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession($target_name);

        $file_infos = $session->getFiles('import_files');
        if (is_array($file_infos) && 0 < count($file_infos)) {
            foreach (array_keys($file_infos) as $file_id) {
                $session->unsetFile('import_files', $file_id);
            }
        }

        $file = $_FILES['file'];
        if ($file['error']) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }
        $file_id = $session->addFile('import_files', $file);

        SmartyValidate::unregister_form($target_name);

        cb_redirect('phonemessage/system/access_import2',
            [
                'charset' => $G_INPUT['charset'],
                'skip'    => $G_INPUT['skip'],
                'file'    => $file_id
            ]);
    } else {
        include('_access_import1.csp');
        $t->setPageInfo($target_name);
        $t->assign('charset', @ $G_INPUT['charset']);
        $t->assign('skip', @ $G_INPUT['skip']);
        $t->display($target_name . '.tpl');
    }

}
