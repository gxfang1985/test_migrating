<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// GET/POSTされたパラメータを取得する
$tid = null;
if (array_key_exists('tid', $G_INPUT)) {
    $tid = $G_INPUT['tid'];
}
$rid = null;
if (array_key_exists('rid', $G_INPUT)) {
    $rid = $G_INPUT['rid'];
}
$oid = null;
if (array_key_exists('oid', $G_INPUT)) {
    $oid = $G_INPUT['oid'];
}
$uid = null;
if (array_key_exists('uid', $G_INPUT)) {
    $uid = $G_INPUT['uid'];
}

require_once('_access_util.csp');

$row =& grn_get_phonemessage_access_object($tid, $oid, $uid, $rid);

// 電話メモを取得する
//tv
/*require_once( 'phonemessage/application.csp' );
$app_locator = GRN_ApplicationLocator::instance();
$app =& $app_locator->getInstance( GRN_PHONEMESSAGE_APPLICATION_ID );
if( ! is_object( $app ) || ! is_a( $app, 'GRN_PhoneMessage_Application' ) )
{
    cb_throw_error( E_GRN_APPLICATION_NOT_AVAILABLE );
}*/

// セキュリティ・モデルを取得する
require_once('phonemessage/access.csp');
$access_manager = GRN_PhoneMessage_AccessManager::getInstance();
$object =& $access_manager->getObject($row);
$security_model = $access_manager->getSecurityModel($object);

// セキュリティ・モデル情報を取得する
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$security_model_for_view = $controller_util->getSecurityModel($security_model);
$access_for_view = ['security_model' => $security_model_for_view];

$t->assign('access', $access_for_view);
$t->assign('is_grant', GRN_PHONEMESSAGE_SECURITYMODEL_GRANT == $security_model);
$t->assign('is_revoke',
    GRN_PHONEMESSAGE_SECURITYMODEL_REVOKE == $security_model);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = [
    'access_index'         => ['sf' => 1, 'tid' => $tid, 'oid' => $oid],
    'access_list'          => [
        'tid'  => $tid,
        'oid'  => $oid,
        'uid'  => $uid,
        'rid'  => $rid,
        'poid' => $poid
    ],
    'access_model_modify1' => null
];

$site_position = $controller_util->makeSitePosition('phonemessage/system/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


