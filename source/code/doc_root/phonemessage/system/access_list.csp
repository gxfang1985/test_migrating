<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

// GET/POSTされたパラメータを取得する
$tid = null;
if (array_key_exists('tid', $G_INPUT)) {
    $tid = $G_INPUT['tid'];
}
$rid = null;
if (array_key_exists('rid', $G_INPUT)) {
    $rid = $G_INPUT['rid'];
}
$oid = null;
if (array_key_exists('oid', $G_INPUT)) {
    $oid = $G_INPUT['oid'];
}
$uid = null;
if (array_key_exists('uid', $G_INPUT)) {
    $uid = $G_INPUT['uid'];
}

require_once('_access_util.csp');

// 電話メモを取得する
//tv
/*require_once( 'phonemessage/application.csp' );
$app_locator = GRN_ApplicationLocator::instance();
$app = $app_locator->getInstance( GRN_PHONEMESSAGE_APPLICATION_ID );
if( ! is_object( $app ) || ! is_a( $app, 'GRN_PhoneMessage_Application' ) )
{
    cb_throw_error( E_GRN_APPLICATION_NOT_AVAILABLE );
}*/

// アクセスを制御する対象を取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
if (0 < strlen($rid)) {
    $row = $uum->getStaticRole($rid);
    $class_name = 'CB_Role';
} elseif (0 < strlen($uid)) {
    $row = $uum->getUser($uid);
    $class_name = 'CB_User';
} elseif (0 < strlen($oid)) {
    $row = $uum->getGroup($oid);
    $class_name = 'CB_Group';
} else {
    cb_throw_error(E_GRN_PHONEMESSAGE_INVALID_TARGET);
}

if ( ! is_object($row) || ! is_a($row, $class_name)) {
    cb_throw_error(E_GRN_PHONEMESSAGE_INVALID_TARGET);
}

// セキュリティ・モデルを取得する
require_once('phonemessage/access.csp');
$access_manager = GRN_PhoneMessage_AccessManager::getInstance();
$object = $access_manager->getObject($row);
$security_model = $access_manager->getSecurityModel($object);

// セキュリティ・モデル情報を取得する
require_once('phonemessage/controller.csp');
$controller_util = new GRN_PhoneMessage_ControllerUtil();
$security_model_for_view = $controller_util->getSecurityModel($security_model);

$accesses_for_view = [];
if (is_object($object)) {
    // 付与されたアクセス権一覧を取得する
    $accesses = $access_manager->listAccesses($object);
    // 付与されたアクセス権情報一覧を取得する
    $accesses_for_view = $controller_util->listAccesses($accesses,
        $security_model);
}

// GTM-529 tuning
$users_id = [];
foreach ($accesses_for_view as $access_item) {
    if ('user' == $access_item['type']) {
        $users_id[] = $access_item['tid'];
    }
}

$login =& $uum->getLoginUser();

require_once('grn/controller.csp');
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id, $login);
$t->assign('users_info', $users_info);
// GTM-529 tuning

// アクセス権数を取得する
$access_count = count($accesses_for_view);

$access_for_view = [
    'security_model' => $security_model_for_view,
    'list'           => $accesses_for_view,
    'count'          => $access_count
];

$ours_params = $G_INPUT;
unset($ours_params['reset']);

$t->assign('access', $access_for_view);
$t->assign('is_grant', GRN_PHONEMESSAGE_SECURITYMODEL_GRANT == $security_model);
$t->assign('is_revoke',
    GRN_PHONEMESSAGE_SECURITYMODEL_REVOKE == $security_model);

require_once('grn/org_util.csp');
require_once('grn/org_util_search.csp');

// search
$text = '';
if (array_key_exists('text', $G_INPUT)) {
    $text = $G_INPUT['text'];
    $t->assign('text', $text);
}

require_once('fw/string_util.csp');
$is_search = (strlen(cb_trim($text)) > 0);
$t->assign('is_search', $is_search);

$poid = null;
if (isset($G_INPUT['poid'])) {
    $poid = $G_INPUT['poid'];
}
if ($poid === 'role' && $is_search) {
    unset($G_INPUT['poid']);
    $poid = null;
    $t->assign('poid', $poid);
}

if ($is_search) {
    $org_row = null;
    $org = [];
    if (0 < $poid) {
        $org_row =& grn_get_org_row($poid);
        $org =& grn_get_org_info($org_row, true);
        $org['ancestors'] =& grn_get_org_ancestors($org_row);
        $org['children'] =& grn_get_org_children($poid);
    } elseif (-1 == $poid) {
        $org_row =& grn_get_org_row('0');
        $org =& grn_get_org_info($org_row, true);
        $org['ancestors'] = $org_row;
        $org['children'] = null;
    } else {
        $org_row =& grn_get_org_row('0');
        $org =& grn_get_org_info($org_row, true);
        $org['ancestors'] = $org_row;
        $org['children'] =& grn_get_org_children('0');
        $poid = null;
    }

    $system_flg = true;
    $condition = grn_get_user_info_search_condition($poid, $text,
        $system_flg);
    $count = grn_get_user_info_search_count($poid, $condition);
    $org['navi_info'] = grn_get_user_navigation_info($count, $G_INPUT, 10);
    $org['user_list'] =& grn_search_user_info($poid, $condition,
        $org['navi_info']);
    unset($ours_params['text']);
    $t->assign('org', $org);
} else {
    $org =& grn_get_user_or_role_list($poid, $ours_params, 10);
    if ( ! array_key_exists('user_list', $org)) {
        $org['navi_info'] = grn_get_user_navigation_info(0, $G_INPUT, 10);
    }
    $t->assign('org', $org);
}

unset($ours_params['poid']);
if (isset($ours_params['sp'])) {
    unset($ours_params['sp']);
}
$t->assign('ours_params', $ours_params);

$authority_types = [
    'browse' => cb_msg(GRN_PHONEMESSAGE_MODULE_ID, 'access_browse'),
    'add'    => cb_msg(GRN_PHONEMESSAGE_MODULE_ID, 'access_add')
];
$t->assign('authority_types', $authority_types);
$t->assign('authority_count', count($authority_types));
$t->assign('auth_disable_change_on_off', true);

require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session
    = $session_manager->getSession('phonemessage.system.access_list');
$authorities = $session->get('authorities');
if (@ $G_INPUT['reset'] || ! is_array($authorities)) {
    if (GRN_PHONEMESSAGE_SECURITYMODEL_REVOKE == $security_model) {
        $authorities = ['browse' => 0, 'add' => 0];
    } else {
        $authorities = ['browse' => 1, 'add' => 1];
    }
    $session->set('authorities', $authorities);
}
$t->assign('authorities', $authorities);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_info = [
    'access_index' => ['sf' => 1, 'tid' => $tid, 'oid' => $oid],
    'access_list'  => null
];
$site_position = $controller_util->makeSitePosition('phonemessage/system/',
    $page_info);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


