<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

if ( ! isset($utility) || ! is_a($utility, 'GRN_Bulletin_ControllerUtil')) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
}

if ( ! ($category_id = @ $G_INPUT['cid'])) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}
$t->assign('category_id', $category_id);


$session =& $utility->getSession();


if (@ $G_INPUT['sf']) {
    $items = $session->get('search_items');
    $text = cb_trim($session->get('search_text'));
    $input_text = $session->get('search_text');
    $scid = $session->get('search_cid');
    $sub = $session->get('search_sub');
    $sensitive = $session->get('search_sensitive');
    $term = $session->get('search_term');
    $limit = $session->get('search_limit');
} else {
    $items = [];
    //if( @ $G_INPUT['ca'] ) $items['category'] = 1;
    if (@ $G_INPUT['su']) {
        $items['subject'] = 1;
    }
    if (@ $G_INPUT['da']) {
        $items['data'] = 1;
    }
    if (@ $G_INPUT['cr']) {
        $items['creator_name'] = 1;
    }
    if (@ $G_INPUT['fo']) {
        $items['follow'] = 1;
    }

    $text = cb_trim(@ $G_INPUT['text']);
    $input_text = @ $G_INPUT['text'];
    $scid = @ $G_INPUT['scid'];
    $sub = @ $G_INPUT['sb'];
    $sensitive = @ $G_INPUT['se'];
    $term = @ $G_INPUT['te'];
    $limit = @ $G_INPUT['li'];

    if ( ! @ $G_INPUT['in']) {
        // パラメータ初期化
        if ( ! array_key_exists('scid', $G_INPUT)) {
            $scid = $category_id;
        }

        // デフォルトでは全項目を検索する
        /*
        if( ! array_key_exists( 'ca', $G_INPUT ) )
            $items['category'] = 1;
        */
        if ( ! array_key_exists('su', $G_INPUT)) {
            $items['subject'] = 1;
        }
        if ( ! array_key_exists('da', $G_INPUT)) {
            $items['data'] = 1;
        }
        if ( ! array_key_exists('cr', $G_INPUT)) {
            $items['creator_name'] = 1;
        }
        if ( ! array_key_exists('fo', $G_INPUT)) {
            $items['follow'] = 1;
        }

        // デフォルトではサブフォルダを検索する
        if ( ! array_key_exists('sb', $G_INPUT)) {
            $sub = 1;
        }

        // デフォルトでは過去3ヶ月の更新を検索する
        if ( ! array_key_exists('li', $G_INPUT)) {
            $limit = 3;
        }

        // デフォルトでは大文字小文字を区別しない
        if ( ! array_key_exists('se', $G_INPUT)) {
            $sensitive = false;
        }

        // デフォルトでは期間を問わず検索する
        if ( ! array_key_exists('te', $G_INPUT)) {
            $term = 'all';
        }

        // デフォルトでは3ヶ月前までを検索する
        if ( ! array_key_exists('li', $G_INPUT)) {
            $limit = 3;
        }
    } else {
        if ($term == 'before') {
            // 掲示開始待ちの場合は検索期限がdisabledされるのでセッションから値をとる
            $limit = $session->get('search_limit');
        }
    }

    if (strlen($scid) < 1) {
        $scid = $category_id;
    }
}


$pages = explode('/', cb_get_pagename());

if ('operation' == $pages[1]) {
    $scid = $category_id;
    $sub = false;
    if (array_key_exists('category', $items)) {
        unset($items['category']);
    }
}

$session->set('search_items', $items);
$session->set('search_text', $input_text);
$session->set('search_cid', $scid);
$session->set('search_sub', $sub);
$session->set('search_sensitive', $sensitive);
$session->set('search_term', $term);
$session->set('search_limit', $limit);

$category = null;
if ($category_id) {
    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $t->assign('category',
        ['name' => $category->get('name'), 'cid' => $category_id]);
}

$search_category = null;
if ($scid > 0) {
    if ( ! ($search_category =& $G_bulletin->getCategory($G_bulletin_login,
        $scid))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
}


require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$ui_config =& $cm->getUserConfig($G_bulletin_login);

$aitems = $items;

$search_count = 0;

if (strlen($text) && array_key_exists('category', $items)
    && $items['category']
) {
    unset($aitems['category']);

    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinCategoryCondition.csp');

    $searchCategoryCondition = new GrnBulletinCategoryCondition();
    $searchCategoryCondition->setCategoryId($search_category);
    $searchCategoryCondition->setEnableSubCategory(true);
    $searchCategoryCondition->setOffset($utility->getNaviStartPosition('fsp'));
    $searchCategoryCondition->setLimit($ui_config->getListMax());
    $searchCategoryCondition->setText($text);
    $searchCategoryCondition->setSensitive($sensitive);

    $search = new GRN_Bulletin_CategorySearch($G_bulletin_login,
        searchCategoryCondition);

    $resultCategoryList = $search->searchExecute();
    $categories_for_view = [];
    foreach ($resultCategoryList as $id => $category) {
        $categories_for_view[$id] = [
            'cid'  => $id,
            'name' => $category->get('name'),
            'path' => grn_bulletin_get_category_path_string($category),
        ];
    }

    $t->assign('search_category', ['result' => $categories_for_view]);

    $search_count = $search->count();

    unset($search);
}

$navi_params = [
    'cid' => $category_id,
    'sf'  => 1
];

$navi_information
    = $utility->makeNaviInformation($utility->getNaviStartPosition('fsp'),
    $ui_config->getListMax(),
    $search_count,
    $navi_params);

$t->assign('category_navi', $navi_information);


$search_count = 0;
$result = [];

if (strlen($text) && $aitems) {
    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $searchArticleCondition = new GrnBulletinArticleCondition();
    $searchArticleCondition->setUser($G_bulletin_login);
    $searchArticleCondition->setCategoryId($search_category);
    $searchArticleCondition->setEnableSubCategory($sub);
    $searchArticleCondition->setOffset($utility->getNaviStartPosition());
    $searchArticleCondition->setLimit($ui_config->getListMax());
    $searchArticleCondition->setText($text);
    $searchArticleCondition->setItems($aitems);
    $searchArticleCondition->setSensitive($sensitive);
    $searchArticleCondition->setArticleTerm($term);

    if ('system' == $pages[1] || 'operation' == $pages[1]) {
        $searchArticleCondition->setPersonal(false);
    } else {
        $searchArticleCondition->setPersonal(true);
    }

    if (($term != 'before') && $limit) {
        require_once('fw/date.csp');
        $now = new CB_TimeStampEx();
        $today = $now->getDateTime();
        $today->hour = 0;
        $today->minute = 0;
        $today->second = 0;
        $today->moveMonths(-intval($limit));
        $now->setDateTime($today);

        $limit_params = [
            'column'   => 'ntime',
            'operator' => '>=',
            'value'    => null
        ];
        $limit_params['value'] = $now->unix_ts;
        $searchArticleCondition->setLimitColumn($limit_params);
    }

    $search = new GRN_Bulletin_ArticleSearch($G_bulletin_login,
        $searchArticleCondition);
    $resultArticleOrFollowList = $search->searchExecute();

    foreach ($resultArticleOrFollowList as $articleOrFollowRow) {
        $row_for_view = null;

        if (is_a($articleOrFollowRow, 'GRN_Bulletin_Follow')) {
            $articleRow = $articleOrFollowRow->get('article');
            $row_for_view
                = $utility->getFollowListView($G_bulletin_login,
                $articleOrFollowRow, true);
            $row_for_view['dtype'] = 'f';
            $row_for_view['published'] = $articleRow->isPublished();
            $row_for_view['expired'] = $articleRow->isExpired();
        } else {
            $row_for_view = $utility->getArticleListView($G_bulletin_login,
                $articleOrFollowRow, ('system' != @ $pages[1]));
            $row_for_view['dtype'] = 'a';
            $row_for_view['published'] = $articleOrFollowRow->isPublished();
            $row_for_view['expired'] = $articleOrFollowRow->isExpired();
        }

        $result[] = $row_for_view;
    }

    $search_count = $search->count();
}

$t->assign('users_info',
    $utility->getUserInfoToShowUserName($utility->getUsersInArticle($result),
        $G_bulletin_login));


$navi_params = [
    'cid' => $category_id,
    'sf'  => 1
];

$navi_information
    = $utility->makeNaviInformation($utility->getNaviStartPosition(),
    $ui_config->getListMax(),
    $search_count,
    $navi_params);

$t->assign('search', [
        'result'    => $result,
        'text'      => $input_text,
        'items'     => $items,
        'sub'       => $sub,
        'sensitive' => $sensitive,
        'scid'      => $scid,
        'term'      => $term,
        'limit'     => $limit,
    ]
);

$t->assign('navi', $navi_information);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));


