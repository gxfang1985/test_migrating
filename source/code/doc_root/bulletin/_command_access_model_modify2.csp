<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! array_key_exists('nid', $G_INPUT)) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $node_id = $G_INPUT['nid'];

    if ( ! ($node_row =& $G_bulletin->getCategory($G_bulletin_login,
        $node_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    $poid = @ $G_INPUT['poid'];

    $security_model = @ $G_INPUT['security_model'];

    //--check
    if ($security_model != 'revoke' && $security_model != 'grant') {
        cb_throw_error(E_GRN_BULLETIN_ACCESS_INVALID_SECURITY_MODEL);
    }

    // access information
    require_once('bulletin/access.csp');
    $am = GRN_Bulletin_AccessManager::getInstance();

    if ($security_model == 'revoke') {
        $am->setSecurityModel($G_bulletin_login, $node_row,
            GRN_BULLETIN_SECURITY_MODEL_REVOKE);
    } else {
        $am->setSecurityModel($G_bulletin_login, $node_row,
            GRN_BULLETIN_SECURITY_MODEL_GRANT);
    }

    $page_parts = explode('/', cb_get_pagename());
    $page_parts[count($page_parts) - 1] = 'access_list';

    if (count($page_parts) > 1) {
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession(implode('.',
            $page_parts));
        $session->set('authorities', null);
    }

    cb_redirect(implode('/', $page_parts),
        ['nid' => $node_id, 'poid' => $poid, 'reset' => 1]);
}

