<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    unset($G_INPUT['add']);

    if ( ! array_key_exists('nid', $G_INPUT)) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $category_id = $G_INPUT['nid'];

    if ( ! ($category = $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    $text = null;
    if (array_key_exists('text', $G_INPUT)) {
        $text = $G_INPUT['text'];
    }

    $func = $G_INPUT['func'];
    if ($func == 'search') {
        $params = $G_INPUT;
        unset($params['func']);
        cb_redirect($target, $params);
    }

    //$aid = @ $G_INPUT['aid'];
    if (is_array($aid)) {
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');

        require_once('grn/uum_util.csp');
        $uum_util = GRN_UumUtil::getInstance();
        $dynamic_roles = $uum_util->listDynamicRoles();

        foreach (array_keys($aid) as $item) {
            $ids = explode(':', $item);
            if (count($ids) < 2) {
                continue;
            }
            $id = $ids[1];
            switch ($ids[0]) {
                case 'user':
                    if (($user = $uum->getUser($id))) {
                        $category->setNotificationTarget($user, true);
                    }
                    break;

                case 'group':
                    if (($group = $uum->getGroup($id))) {
                        $category->setNotificationTarget($group, true);
                    }
                    break;

                case 'static_role':
                    if (($role = $uum->getStaticRole($id))) {
                        $category->setNotificationTarget($role, true);
                    }
                    break;

                case 'dynamic_role':
                    if (array_key_exists($id, $dynamic_roles)) {
                        $category->setNotificationTarget($id, true);
                    }
                    break;
            }
        }

        _bulletin_rebuild_folder_tree($category_id);
    }
}

