<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! array_key_exists('cid', $G_INPUT) || strlen($G_INPUT['cid']) < 1
         || $G_INPUT['cid'] < 1
    ) {
        $category_id = 1;
    } else {
        $category_id = $G_INPUT['cid'];
    }

    $set_category_id = null;
    if (array_key_exists('s_cid', $G_INPUT) && strlen($G_INPUT['s_cid']) > 0) {
        $set_category_id = $G_INPUT['s_cid'];
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();

    if ( ! isset($session_id)) {
        $session_id = 'category_select';
    }

    if ($target_name) {
        $session =& $session_manager->getSession($target_name);
    } else {
        $session =& $session_manager->getSession(cb_get_pagename());
    }

    $ignore_categories = $session->get($session_id . '_ignore');
    $candidate_categories = $session->get($session_id . '_candidate');

    assert('!is_null($ignore_categories)');
    assert('!is_null($candidate_categories)');

    // 候補の追加
    if (array_key_exists('add', $G_INPUT)) {
        if ( ! isset($target_name)) {
            assert('FALSE');
        }

        // カテゴリの複数選択対応
        $cids = @ $G_INPUT['candidate_categories'];
        if (is_array($cids) && count($cids)) {
            require_once('bulletin/functions.csp');

            foreach ($cids as $cid) {
                if ( ! $cid) {
                    continue;
                }

                if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
                    $cid))
                ) {
                    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
                }

                $candidate_categories[$category->getOID()] = [
                    'cid'  => $category->getOID(),
                    'name' => $category->get('name'),
                    'path' => grn_bulletin_get_category_path_string($category),
                ];
            }

            $session->set($session_id . '_candidate', $candidate_categories);
        }
        /**
         * if( $set_category_id )
         * {
         * if( ! array_key_exists( $set_category_id, $ignore_categories ) )
         * {
         * if( !($category =& $G_bulletin->getCategory( $G_bulletin_login, $set_category_id )) )
         * {
         * cb_throw_error( E_GRN_BULLETIN_CATEGORY_NOT_FOUND );
         * }
         *
         * require_once( 'bulletin/functions.csp' );
         *
         * $candidate_categories[$category->getOID()] = array(
         * 'cid'  => $category->getOID(),
         * 'name' => $category->get( 'name' ),
         * 'path' => grn_bulletin_get_category_path_string( $category ),
         * );
         *
         * $session->set( $session_id .'_candidate', $candidate_categories );
         * }
         * }
         */
        cb_redirect($target_name,
            ['cid' => $category_id, 's_cid' => $set_category_id, 'ss' => 1]);
    }

    // 候補の削除
    if (array_key_exists('remove', $G_INPUT)) {
        if ( ! isset($target_name)) {
            assert('FALSE');
        }

        if (array_key_exists('selected_categories', $G_INPUT)) {
            $remove_categories = $G_INPUT['selected_categories'];

            foreach ($remove_categories as $cid) {
                if (array_key_exists($cid, $candidate_categories)) {
                    unset($candidate_categories[$cid]);
                }
            }
            $session->set($session_id . '_candidate', $candidate_categories);
        }

        cb_redirect($target_name,
            ['cid' => $category_id, 's_cid' => $set_category_id, 'ss' => 1]);
    }

    // セッションをクリア
    $session->set($session_id . '_ignore', null);
    $session->set($session_id . '_candidate', null);


    // 候補への追加、削除以外はこのファイルをインクルードするコントローラで
    // $ignore_categories, $candidate_categories を使って処理する

}
