<?php

global $G_INPUT;

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$page_path = [
    'bulletin/index'      => null,
    'bulletin/draft_list' => null,
];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $page_path);

$session =& $utility->getSession();


if (@ $G_INPUT['sf']) {
    $items = $session->get('search_items');
    $text = $session->get('search_text');
    $sensitive = $session->get('search_sensitive');
} else {
    $items = [];
    if (@ $G_INPUT['su']) {
        $items['subject'] = 1;
    }
    if (@ $G_INPUT['da']) {
        $items['data'] = 1;
    }

    $text = @ $G_INPUT['text'];
    $sensitive = @ $G_INPUT['se'];

    if ( ! @ $G_INPUT['in']) {
        // パラメータ初期化
        if ( ! array_key_exists('su', $G_INPUT)) {
            $items['subject'] = 1;
        }
        if ( ! array_key_exists('da', $G_INPUT)) {
            $items['data'] = 1;
        }
    }
}

$session->set('search_items', $items);
$session->set('search_text', $text);
$session->set('search_sensitive', $sensitive);


require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$uiconf =& $cm->getUserConfig($G_bulletin_login);

$result = [];
$total_count = 0;

if (strlen($text) && $items) {
    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $searchCondition = new GrnBulletinArticleCondition();
    $searchCondition->setOffset($utility->getListOffset());
    $searchCondition->setLimit($uiconf->getListMax());
    $searchCondition->setText($text);
    $searchCondition->setItems($items);
    $searchCondition->setSensitive($sensitive);

    $search = new GRN_Bulletin_DraftSearch($G_bulletin_login, $searchCondition);

    while ( ! is_null($object = $search->iterate())) {
        $row_for_view = $utility->getArticleListView($G_bulletin_login,
            $object, false);
        $result[$object->getOID()] = $row_for_view;
    }

    $total_count = $search->count();
}

$navi_params = ['sf' => 1];

$navi_information = $utility->makeNaviInformation($utility->getListOffset(),
    $uiconf->getListMax(),
    $total_count,
    $navi_params);

$t->assign('search', [
    'result'    => $result,
    'text'      => $text,
    'items'     => $items,
    'sensitive' => $sensitive,
]);

$t->assign('navi', $navi_information);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));

/*
// site position
$t->assign(
    'site_position',
    array(
        array('page'=>"bulletin/index",'name'=>"掲示板"),
        array('page'=>"",'name'=>"検索"),
    )
);

// 検索結果
$t->assign(
    'search',array(

        'category_name' => '開発部',           //選択カテゴリ
        'search_text' => 'ほにゃ',             //検索文字列
        'search_numbers' => '3',               //ヒットした件数
        'search_item' => array(
            '000001' => array(                 //key
                'url' => '#',                  //url
                'title' => '開発部のみなさん', //タイトル
                'data' => 'ええええ',          //カテゴリ
                'category' => '開発',          //内容
                'type' => '本文',              //種類　本文とかフォローとか
            ),
            '000002' => array(
                'url' => '#',
                'title' => '営業部のみなさん',
                'data' => 'ああああ',
                'category' => '開発',
                'type' => 'フォロー',
            ),
        ),
        'view_id_start' => '1', //現在表示している件数の初め
        'view_id_end' => '2', //現在表示している件数の終わり
        'all_id' => '2', //全件数
    )
);

*/

// Smarty実行
$t->display(cb_get_pagename() . ".tpl");

