<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

if ( ! array_key_exists('aid', $G_INPUT) || strlen($G_INPUT['aid']) < 1
     || $G_INPUT['aid'] < 1
) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
$article_id = $G_INPUT['aid'];
$t->assign('article_id', $article_id);

if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

// 移動権限をチェック
$article->isMovable($G_bulletin_login, true);

$category =& $article->get('category');
$category_id = $category->getOID();

// 掲示の情報を取得

$article_for_view = [
    'aid'   => $article->getOID(),
    'title' => $article->get('subject'),
];

$t->assign('article', $article_for_view);


// 現在の位置を取得

require_once('bulletin/functions.csp');

$current_for_view = [
    'cid'  => $category->getOID(),
    'path' => grn_bulletin_get_category_path_string($category),
    'name' => $category->get('name')
];

$t->assign('current', $current_for_view);

// parameters for category_select.tpl
$t->assign('params', ['aid' => $article_id]);

if ( ! isset($utility)) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
}

$t->assign('config', $utility->getConfigValues($G_bulletin_login));


