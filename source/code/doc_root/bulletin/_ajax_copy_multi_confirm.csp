<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    $cid = null;
    if ( ! array_key_exists('cid', $G_INPUT) || strlen($G_INPUT['cid']) < 1) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $cid = $G_INPUT['cid'];

    $target_ids = null;
    if ( ! array_key_exists('ids', $G_INPUT)) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $target_ids = $G_INPUT['ids'];

    require_once('bulletin/category.csp');
    $factory = GRN_Bulletin_CategoryFactory::getInstance();
    if ( ! ($category = $factory->get($cid))) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $category_name = $category->get('name');
    $source_info = ['key' => 'cid', 'id' => $cid, 'name' => $category_name];
    $t->assign('source_info', $source_info);

    $page_parts = explode('/', cb_get_pagename());
    $is_system = (@$page_parts[1] === 'system');

    $target_list = [];
    foreach ($target_ids as $id) {
        if ( ! ($category = $factory->get($id))) {
            cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
        }
        if ( ! $is_system) {
            $category->privileged($G_bulletin_login, ['operation'], true);
        }

        $category_name = $category->get('name');
        $target_list[] = ['id' => $id, 'name' => $category_name];
    }

    $targets = [];
    $targets['list'] = $target_list;
    $targets['count'] = count($targets['list']);
    $t->assign('targets', $targets);

    $t->display(cb_get_pagename() . ".tpl");
}
