<?php

global $G_INPUT;

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// ApplicationLocator
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app =& $locator->getInstance('cellular');
$user_config =& $cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();
// 幅
$smarty->assign('width', $width);

$bulletin_app =& $locator->getInstance('bulletin');

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$text = @ $G_INPUT['text'];
$smarty->assign('text', $text);

if (strlen($text)) {
    // 内容検索
    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $items = [
        'subject'      => 1,
        'data'         => 1,
        'creator_name' => 1,
        'follow'       => 1
    ];
    $start_position = $utility->getNaviStartPosition();

    // 期間は指定無し（全検索
    $searchArticleCondition = new GrnBulletinArticleCondition();
    $searchArticleCondition->setUser($G_login_user);
    $searchArticleCondition->setCategoryId(null);             // 全カテゴリ
    $searchArticleCondition->setEnableSubCategory(1);         // サブフォルダも検索
    $searchArticleCondition->setPersonal(false);              // ログインユーザーが差出人の掲示に限定しない
    $searchArticleCondition->setSensitive(false);             // 大文字小文字を区別しない
    $searchArticleCondition->setArticleTerm('published');     // 公開された掲示だけを検索
    $searchArticleCondition->setItems($items);                // 全項目を検索
    $searchArticleCondition->setOffset($start_position);      // 表示場所
    $searchArticleCondition->setLimit($limit);                // 件数
    $searchArticleCondition->setText($text);                  // 検索文字列

    $search = new GRN_Bulletin_ArticleSearch($G_login_user,
        $searchArticleCondition);
    $resultArticleOrFollowList = $search->searchExecute();

    $result = [];
    foreach ($resultArticleOrFollowList as $articleOrFollowRow) {
        $row_for_view = null;
        $article = null;

        if (is_a($articleOrFollowRow, 'GRN_Bulletin_Follow')) {
            $article = $articleOrFollowRow->get('article');
        } else {
            $article = $articleOrFollowRow;
        }

        $row_for_view = $utility->getArticleListView($G_login_user,
            $article, true);
        $row_for_view['dtype'] = 'a';

        if ( ! is_null($row_for_view['manually_enter_sender'])
             && ($row_for_view['mtime'] == $row_for_view['ntime']
                 || ($article->get('start_is_datetime') == 1
                     && $article->get('start_timestamp')
                        == $row_for_view['ntime'])
             )
        ) {
            $row_for_view['notifier_name']
                = $row_for_view['manually_enter_sender'];
        }

        $result[] = $row_for_view;
    }

//var_dump($result);
    $smarty->assign('result', $result);

    $search_count = $search->count();

    $navi_params = [
        'text' => $text,
        'sf'   => 1
    ];

    $navi_information = $utility->makeNaviInformation($start_position,
        $limit,
        $search_count,
        $navi_params);

    $smarty->assign('navi', $navi_information);
}

// display
$smarty->display(cb_get_pagename() . '.tpl');

