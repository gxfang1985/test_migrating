<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // Smarty をインスタンス化
    require_once('cellular/smarty.csp');
    $smarty = new GRN_Cellular_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($smarty);
    $form_name = 'bulletin/cellular/follow';
    SmartyValidate::register_form($form_name);

    // 使用するパラメータの定義
    $article_id = @ $G_INPUT['aid'];
    $follow_str = @ $G_INPUT['follow'];

    if (SmartyValidate::is_valid($G_INPUT, $form_name)) {

        // 記事の取得
        require_once('grn/application.csp');
        $locator = GRN_ApplicationLocator::instance();
        $bulletin_app =& $locator->getInstance('bulletin');

        if ( ! ($article =& $bulletin_app->getArticle($G_login_user,
            $article_id, GRN_BULLETIN_ACCESS_R, true,
            CB_DATABASE_EXCLUSIVE_LOCK))
        ) {
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
        }
        if ( ! $article->isPublished()) {
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
        }
        if ($article->isExpired()) {
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_EXPIRED);
        }

        // 書き込み可能かどうかのチェック
        require_once('bulletin/controller.csp');
        $utility = new GRN_Bulletin_ControllerUtil();
        $article_for_view = $utility->getArticleView($G_login_user, $article,
            true);
        if ( ! $article_for_view['can_follow']
             || ! $article_for_view['category_auth']['follow']
        ) {
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_EXPIRED);
        }


        //フォローの書込み処理
        $properties = ['data' => $follow_str, 'html' => ""];

        $follow =& $article->writeFollow($G_login_user, $properties, $_FILES);

        // the validation session is finished
        SmartyValidate::unregister_form($form_name);

        // redirect
        require_once('cellular/prepend.csp');
        grn_cellular_redirect("bulletin/cellular/look1",
            ['aid' => $article_id]);
    } else {
        /*
                $smarty->setPageInfo( $form_name );

                $smarty->assign( $G_INPUT );
                $smarty->assign( 'follow', mb_substr($follow_str,0,1024) );

                // ページタイトル
                $smarty->assign( 'pagetitle', grn_get_current_page_display_name() );

                $smarty->display( $form_name .'.tpl' );
        */
        // error. switch form page
        grn_cellular_switch_page($G_pagepath . '/follow');
    }
}

