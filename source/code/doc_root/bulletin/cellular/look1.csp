<?php

// 使用するパラメータの定義
$article_id = @ $G_INPUT['aid'];
$body_page = @ $G_INPUT['bp'];
$is_fp_numeric = is_numeric($G_INPUT['fp'] ?? null);
$follow_page = $is_fp_numeric ? $G_INPUT['fp'] : null;

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// 記事の取得
$bulletin_app = $locator->getInstance('bulletin');
if ( ! ($article = $bulletin_app->getArticle($G_login_user, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ( ! $article->isPublished()) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ($article->isExpired()) {
    //cb_throw_error( E_GRN_BULLETIN_ARTICLE_EXPIRED );
    $smarty->assign('is_expired_flag', true);
}


// 記事の表示データ取得
require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
$article_for_view = $utility->getArticleView($G_login_user, $article, true);
//echo "<pre>".nl2br(print_r($article_for_view,true))."</pre>";

$smarty->assign('bbsdata', $article_for_view);

$smarty->assign('category_auth', $article_for_view['category_auth']);

// フォロー一覧
require_once('bulletin/follow_util.csp');
$collection = new GRN_Bulletin_FollowList($G_login_user, $article);
//$collection->setHeadFollowID( $follow_id );

if (isset($G_INPUT['uf'])) {
    if ($collection->count() > 0) {
        grn_cellular_switch_page($G_pagepath . "/look2");
    }
}

$follow_offset = $follow_page * $limit;
$follow_limit = $limit + 1;

$collection->setOffset($follow_offset);
$collection->setLimit($follow_limit);

$follows_for_view = [];

while ( ! is_null(($follow = $collection->iterate()))) {
    $i = 0;
    if ($i == 0) {
        $start_id = $follow->getOID();
    }
    $i++;
    $follows_for_view[$follow->getOID()]
        = $utility->getFollowView($G_login_user, $follow);

}

if ($follow_page > 0) {
    $smarty->assign('prev', true);
    $smarty->assign('prev_page', $follow_page - 1);
}
if (count($follows_for_view) == $follow_limit) {
    //次のページがある時、最後の行を消す
    array_pop($follows_for_view);
    $smarty->assign('next', true);
    $smarty->assign('next_page', $follow_page + 1);
}

$smarty->assign('followlist', $follows_for_view);

// カテゴリ
$category = $article->get('category');
$smarty->assign('cid', $category->getOID());

// 記事を既読にする
$article->read($G_login_user);

$smarty->assign('aid', $article_id);
$smarty->assign('bp', $body_page);
$smarty->assign('fp', $follow_page);
$smarty->assign('width', $width);

// display
$smarty->display(cb_get_pagename() . '.tpl');


