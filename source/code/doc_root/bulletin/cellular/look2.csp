<?php

// 使用するパラメータの定義
$article_id = @ $G_INPUT['aid'];
$follow_id = @ $G_INPUT['fid'];
$page_num = @ $G_INPUT['pg'];

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// 記事の取得
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$bulletin_app =& $locator->getInstance('bulletin');
if ( ! ($article =& $bulletin_app->getArticle($G_login_user, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

if ( ! $article->isPublished()) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ($article->isExpired()) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_EXPIRED);
}


// 記事の表示データ取得
require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
$article_for_view = $utility->getArticleView($G_login_user, $article, true);

$smarty->assign('title', $article_for_view['title']);
$smarty->assign('bbsdata', $article_for_view);
$smarty->assign('category_auth', $article_for_view['category_auth']);


// フォロー
if (strlen($follow_id)) {
    $follow =& $article->getFollow($follow_id);
    if ( ! $follow) {
        cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
    }
} else {
    if (isset($G_INPUT['uf'])) {
        require_once('bulletin/follow_util.csp');
        $collection = new GRN_Bulletin_FollowList($G_login_user, $article);
        if (is_null(($follow =& $collection->iterate()))) {
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }
        $follow_id = $follow->getOID();
    } else {
        cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
    }
}

$follow_for_view = $utility->getFollowView($G_login_user, $follow);

$smarty->assign('followdata', $follow_for_view);

// 前後フォロー
require_once('bulletin/follow_util.csp');
$collection = new GRN_Bulletin_FollowList($G_login_user, $article);
$collection->setHeadFollowID($follow_id);
$smarty->assign('fid_p', $collection->getPreviousID($follow));
$smarty->assign('fid_n', $collection->getNextID($follow));

// カテゴリ
$category =& $article->get('category');
$smarty->assign('cid', $category->getOID());

// 記事を既読にする
$article->read($G_login_user);

// assign
$smarty->assign('fid', $follow_id);
$smarty->assign('aid', $article_id);

// display
$smarty->display(cb_get_pagename() . '.tpl');

