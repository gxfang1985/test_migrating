<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページ情報
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// ページ構成情報
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);

$list_limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();
$menu_limit = 20;

$smarty->assign('width', $width);

// params
$cid = null;
$list_page = 0;
if (array_key_exists('cid', $G_INPUT) && strlen($G_INPUT['cid'])) {
    $cid = $G_INPUT['cid'];
}
if (array_key_exists('pg', $G_INPUT) && strlen($G_INPUT['pg'])) {
    $list_page = $G_INPUT['pg'];
}

// カテゴリのselectbox
$categories_for_view = [];
$categories_list = [];

// cid 解析
$menu_page = 0;
$current_cid = GRN_BULLETIN_ROOT_CATEGORY_ID;
if ( ! is_null($cid)) {
    if (($p = strpos($cid, ':')) !== false) {
        $menu_page = substr($cid, $p + 1);
        if ( ! strlen($menu_page)) {
            $menu_page = 0;
        }
        $current_cid = substr($cid, 0, $p);
        if ( ! strlen($current_cid)) {
            $current_cid = GRN_BULLETIN_ROOT_CATEGORY_ID;
        }
    } else {
        $current_cid = $cid;
    }
}

$smarty->assign('current_cid', $current_cid);

// bulletin アプリ
$bulletin_app = $locator->getInstance('bulletin');

if ($current_cid != GRN_BULLETIN_ROOT_CATEGORY_ID) {
    // root選択肢追加
    $root = $bulletin_app->getRootCategory($G_login_user);
    $categories_for_view[] = [
        'cid'  => $root->getOID(),
        'name' => cb_msg('grn.cellular.common', 'selectbox_root',
            ['rootname' => $root->get('name')])
    ];

    if ( ! ($category = $bulletin_app->getCategory($G_login_user,
        $current_cid))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    if (($parent = $category->get('parent'))) {
        // 一つ上へ選択肢追加
        $categories_for_view[] = [
            'cid'  => $parent->getOID(),
            'name' => cb_msg('grn.cellular.common', 'selectbox_up')
        ];
    }
} else {
    $category = $bulletin_app->getRootCategory($G_login_user);
}

// カレントの選択肢追加
$categories_for_view[] = [
    'cid'  => $category->getOID(),
    'name' => $category->get('name')
];

$categories = $category->getCategories($G_login_user);

$menu_prev = null;
$menu_next = null;
if ( ! is_null($categories)) {
    if (count($categories) > $menu_limit) {
        $_chunk = array_chunk($categories, $menu_limit, true);
        if ( ! is_null($current_cid)) {
            foreach ($_chunk as $_page => $_categories) {
                if (array_key_exists($current_cid, $_categories)) {
                    $menu_page = $_page;
                }
            }
        }
        if (array_key_exists($menu_page - 1, $_chunk)) {
            $menu_prev = $menu_page - 1;
        }
        if (array_key_exists($menu_page + 1, $_chunk)) {
            $menu_next = $menu_page + 1;
        }
        $categories_list = &$_chunk[$menu_page];
    } else {
        $categories_list = &$categories;
    }

    if ( ! is_null($menu_prev)) {
        $categories_for_view[] = [
            'cid'  => $current_cid . ':' . $menu_prev,
            'name' => cb_msg('grn.cellular.common', 'selectbox_back')
        ];
    }
    foreach ($categories_list as $_category) {
        $categories_for_view[] = [
            'cid'  => $_category->getOID(),
            'name' => cb_msg('grn.cellular.common', 'selectbox_tree')
                      . $_category->get('name')
        ];
    }
    if ( ! is_null($menu_next)) {
        $categories_for_view[] = [
            'cid'  => $current_cid . ':' . $menu_next,
            'name' => cb_msg('grn.cellular.common', 'selectbox_next')
        ];
    }
}
$smarty->assign('categories_count', count($categories_for_view));
$smarty->assign('categories', $categories_for_view);


if ($category) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
    $offset = $utility->getListOffset();

    // 一覧ソート
    $order_column = $utility->getListOrderColumn(null, 'ntd');

    require_once('bulletin/article_util.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $conditionObj = new GrnBulletinArticleCondition();
    $conditionObj->setUser($G_login_user);
    $conditionObj->setCategory($category);
    $conditionObj->setOffset($offset);
    $conditionObj->setLimit($list_limit);
    $conditionObj->addSort($order_column['column'], $order_column['order']);

    $list = new GRN_Bulletin_ArticleList($conditionObj);

    $articleList = $list->searchExecute();
    $articles_for_view = [];
    foreach ($articleList as $article) {
        $for_view = [
            'aid'   => $article->getOID(),
            'title' => $article->get('subject'),
        ];

        $utility->getNotifierView($article, $for_view);
        $mtime = $article->get('mtime');
        $manually_enter_sender = $article->get('manually_enter_sender');
        if ( ! is_null($manually_enter_sender)
             && ($mtime == $for_view['ntime']
                 || ($article->get('start_is_datetime') == 1
                     && $article->get('start_timestamp') == $for_view['ntime'])
             )
        ) {
            $for_view['notifier_name'] = $manually_enter_sender;
        }

        $articles_for_view[$article->getOID()] = $for_view;
    }

    $smarty->assign('articles', $articles_for_view);

    $params = ['cid' => @$G_INPUT['cid'], 'sf' => 1];

    $smarty->assign('navi',
        $utility->makeNaviInformation($offset, $list_limit, $list->count(),
            $params));
}

// display
$smarty->display(cb_get_pagename() . '.tpl');

