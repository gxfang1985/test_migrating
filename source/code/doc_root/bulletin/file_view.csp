<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


if ( ! @ $G_INPUT['aid']) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ( ! @ $G_INPUT['fid']) {
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}

$article_id = $G_INPUT['aid'];
$follow_id = @ $G_INPUT['follow_id'];
$file_id = $G_INPUT['fid'];

if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$category = $article->get('category');
$category_id = $category ? $category->getOID() : null;

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

if ($article->isPublished()) {
    // GRN35-209
    if ($category_id) {
        $utility->prepareMakeSitePosition($t, $category_id, $article_id, null,
            null, null, null, null, null, null, null, null,
            @$G_INPUT['follow_id']);
    } else {
        $page_path = [
            "bulletin/index" => ['cid' => $category_id],
            "bulletin/view"  => [
                'cid'       => $category_id,
                'aid'       => $article_id,
                'follow_id' => $follow_id
            ],
        ];
        $utility->setSitePosition($t, $page_path);
    }
    // GRN35-209
    $t->assign('published', 1);
} else {
    $page_path = [
        "bulletin/index"     => null,
        "bulletin/wait_list" => null,
        "bulletin/wait_view" => ['aid' => $article_id],
    ];
    $utility->setSitePosition($t, $page_path);
}


/**
 * 変数「$owner」「$file」は「_file_view.csp」で必要
 */

if ($follow_id) {
    if ( ! ($owner =& $article->getFollow($follow_id))) {
        cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
    }
} else {
    $owner =& $article;
}

$file =& $owner->getFile($file_id);

require_once('_file_view.csp');

$target_name = 'bulletin/file_delete';
$delete_file = [
    'title'   => grn_get_page_display_name($target_name),
    'page'    => $target_name . '.tpl',
    'data'    => [
        'category_id' => $category_id,
        'article_id'  => $article_id,
        'follow_id'   => $follow_id,
        'file'        => $file_for_view
    ],
    'handler' => 'lnk_delete'
];
$t->assign('delete_file', $delete_file);

$t->display(cb_get_pagename() . ".tpl");
