<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


if ( ! array_key_exists('aid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
$article_id = $G_INPUT['aid'];


// site position
$page_path = [
    "bulletin/index"     => null,
    "bulletin/wait_list" => null,
];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $page_path);


// 記事の取得
if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

// まだ公開されていないことを確認
if ($article->isPublished()) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_IS_PUBLISHED);
}

// 記事の詳細情報を取得
$article_for_view = $utility->getArticleView($G_bulletin_login, $article);


// 前後へのナビゲーション
$list_utility = new GRN_Bulletin_ControllerUtil('bulletin/wait_list');
$navi_for_view = $list_utility->getNeighborsView($G_bulletin_login, $article,
    'stu');


$t->assign('article', $article_for_view);
$t->assign('navi', $navi_for_view);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
require_once("grn/controller.csp");
$users_info
    = GRN_ControllerUtil::getUserInfoToShowUserName(array_keys(GRN_Bulletin_ControllerUtil::getUsersInArticle($article_for_view)),
    $uum->getLoginUser());
$t->assign("users_info", $users_info);

$delete_info = [
    'title'   => grn_get_page_display_name('bulletin/wait_delete'),
    'page'    => 'bulletin/wait_delete.tpl',
    'handler' => 'lnk_delete',
    'data'    => [
        'article' => [
            'aid'   => $article_for_view['aid'],
            'title' => $article_for_view['title']
        ]
    ]
];
$t->assign('delete_info', $delete_info);

// FAVORITE
require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$use_star = $star_logic->isActive();
$t->assign('use_star', $use_star);
if ($use_star) {
    $t->assign('star_infos',
        $star_logic->getStatusByIDs($G_bulletin_login, 'grn.bulletin',
            [$article_id]));
}
// End FAVORITE

$t->display(cb_get_pagename() . ".tpl");

