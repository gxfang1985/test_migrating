<?php

// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}
// set parameters default
$default_parameters = [
    'sort'    => 'last_mtime',
    'reverse' => false
];
$params = [];
foreach ($default_parameters as $key => $value) {
    $params[$key] = cb_at($G_INPUT, $key);
    if ($params[$key] == '') {
        $params[$key] = $value;
    }
}
// limit
$limit = $G_bulletin_login_config->getListMax();

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
// 一覧開始位置
$offset = $utility->getListOffset();
$utility->setNaviStartPosition($offset);
$sort_list = ['creator', 'last_mtime', 'category'];
$sort_params_for_view = [];
foreach ($sort_list as $sort_key) {
    $sort_param = [];
    $sort_param['reverse'] = false;
    $sort_param['disable'] = true;
    $sort_params_for_view[$sort_key] = $sort_param;
}
$sort_params_for_view[$params['sort']]['reverse'] = ! $params['reverse'];
$sort_params_for_view[$params['sort']]['disable'] = false;

$t->assign('sort_params', $sort_params_for_view);

require_once('bulletin/notification.csp');
$notification = new GRN_Bulletin_NotificationManager();
$arrayCategory = $notification->getNotifiedCategoryIds($user, false);
require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');
require_once('bulletin/controller.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($user);
$conditionObj->setCategory(array_keys($arrayCategory));
$conditionObj->setAcknowledgement(true);
$conditionObj->setLimit($limit + 1);
$conditionObj->setOffset($offset);
$conditionObj->addSort($params['sort'], $params['reverse']);
$bulletin_logic = new GRN_Bulletin_ArticleList($conditionObj);
$bulletin_logic->setLockMode(CB_DATABASE_NO_LOCK);
$bulletins = $bulletin_logic->listDatas();
if ($bulletins === false) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_WRONG_PARAMETER);
}
$isNextPageExists = (count($bulletins) > $limit);
if ($isNextPageExists) {
    array_pop($bulletins);
}
$navi_info_for_view = [];
$navi_info_for_view = $utility->makeSimpleNaviInformation($offset, $limit,
    count($bulletins), $isNextPageExists,
    ['sort' => $params['sort'], 'reverse' => $params['reverse']]);
$t->assign('navi_info', $navi_info_for_view);
$t->assign('bulletins', $bulletins);
$t->assign('config', $utility->getConfigValues($user));
//Set Page Title
require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_name = $app_locator->getName('bulletin');
$page_title = cb_plain_msg('grn.bulletin', 'porlet_view_acknowledgement',
    ['app_name' => $app_name]);

$t->assign('page_title', $page_title);
$t->assign('app_name', $app_name);

