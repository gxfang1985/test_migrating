<?php
$cid = null;    // source category id
if ( ! array_key_exists('cid', $G_INPUT) || strlen($G_INPUT['cid']) < 1) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}
$cid = $G_INPUT['cid'];

$node_id = null;    // select category id
if (array_key_exists('focused_id', $G_INPUT)
    && strlen($G_INPUT['focused_id']) > 0
) {
    $node_id = $G_INPUT['focused_id'];
} else {
    $node_id = $cid;
}

$checked_ids = null;
if (array_key_exists('ids', $G_INPUT)) {
    $checked_ids = $G_INPUT['ids'];
}
$reflection_info = [
    'source_key' => 'cid',
    'source_oid' => $cid
];
$check_info = [
    'id_prefix' => 'ids_',
    'name'      => 'ids[]',
    'on_click'  => 'grn.component.check_tree.onClickTreeCheckbox'
];
$tree_info = [
    'link_url'        => cb_get_pagename(),
    'link_url_params' => ['cid' => $cid],
    'oid_key'         => 'focused_id',
    'on_select'       => 'grn.component.check_tree.onSelectCategory',
    'reflection_info' => $reflection_info,
    'check_info'      => $check_info,
    'checked_ids'     => $checked_ids
];

$tree_selected_oid = $node_id;

$page_parts = explode('/', cb_get_pagename());
$is_system = (@$page_parts[1] === 'system');
$force_hide_notification = true;
$view_checkbox = true;
include('_category_tree.csp');
$node_id = $tree_selected_oid ? $tree_selected_oid
    : GRN_BULLETIN_ROOT_CATEGORY_ID;

if ( ! ($node_row =& $G_bulletin->getCategory($G_bulletin_login, $node_id))) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

require_once('bulletin/hierarchy.csp');
$hierarchy = GRN_Bulletin_Hierarchy::getInstance();
$node = $hierarchy->build($G_bulletin_login, $node_row);

$t->assign('node_id', $node_id);
$t->assign('node', $node);
$ous_params = ['nid' => $cid];
$t->assign('ous_params', $ous_params);
