<?php

if ( ! @ $utility || ! is_a($utility, 'GRN_Bulletin_ControllerUtil')) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
}

$order_column = $utility->getListOrderColumn(null, 'ctd');
$t->assign('sort', $order_column['param']);


if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$category =& $article->get('category');

$article_for_view = [];
$article_for_view['aid'] = $article->getOID();
$article_for_view['cid'] = $category->getOID();
$article_for_view['category_title'] = $category->get('name');
$article_for_view['title'] = $article->get('subject');

require_once('bulletin/file_util.csp');
$coll = new GRN_Bulletin_FileList($article);
$coll->addOrderColumn($order_column['column'], $order_column['order']);

$files_for_view = [];

$users_id = [];
while ( ! is_null(($row = $coll->iterate()))) {
    $file =& $row['file'];
    $body =& $file->getCurrentBody();
    $follow =& $row['follow'];

    $title = $file->getTitle();

    if (is_null($title) || strlen($title) < 1) {
        $title = $body->get('name');
    }

    $for_view = [
        'title'     => $title,
        'filename'  => $body->get('name'),
        'abstruct'  => $follow ? $follow->get('data') : $article->get('data'),
        'aid'       => $article->getOID(),
        'follow_id' => $follow ? $follow->getOID() : null,
        'fid'       => $file->getOID(),
    ];

    $utility->getCreatorView($file, $for_view);

    $files_for_view[$file->getOID()] = $for_view;
    $users_id[] = $for_view['creator_uid'];
}

$article_for_view['all_attach_files'] = $files_for_view;

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
require_once("grn/controller.csp");
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
    $uum->getLoginUser());
$t->assign('users_info', $users_info);

$t->assign('article', $article_for_view);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));


