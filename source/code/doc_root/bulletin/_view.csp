<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
}

// システム設定をSmartyにセット
$conf = $utility->getConfigValues($G_bulletin_login, true);
$t->assign('config', $conf);

if ( ! array_key_exists('aid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$article_id = $G_INPUT['aid'];
$follow_id = array_key_exists('follow_id', $G_INPUT) ? $G_INPUT['follow_id']
    : null;
if (array_key_exists('follow_id_autolink', $G_INPUT)) {
    require_once('bulletin/follow.csp');
    $fm = GRN_Bulletin_FollowManager::getInstance();
    $follow_id_autolink = array_key_exists('follow_id_autolink', $G_INPUT)
        ? $G_INPUT['follow_id_autolink'] : -1;
    $follow_id = $fm->getFollowByOffset($article_id,
        $follow_id_autolink);
}

// 一覧件数
$limit = $G_bulletin_login_config->getFollowMax();

// 一覧開始位置
$offset = $utility->getListOffset();

// 記事の取得
if ( ! isset($article)) {
    if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login,
        $article_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }
}


// 記事の表示データ取得
$article_for_view = $utility->getArticleView($G_bulletin_login, $article, true);

// 記事が変更されている場合は、記事の内容に変更されたことを示す色をつける
if ($article->getReadTimestamp($G_bulletin_login) < $article_for_view['mtime']
    && $G_bulletin_login->getOID() !== $article_for_view['modifier_uid']
) {
    $article_for_view['modified'] = true;
}

// アクセス権を取得
$article_for_view['auth'] = $article->getAuthorities($G_bulletin_login);

// 削除権限をチェック
$article_for_view['deletable'] = $article->isDeletable($G_bulletin_login);

// 移動権限をチェック
$article_for_view['movable'] = $article->isMovable($G_bulletin_login);

// 変更権限をチェック
$article_for_view['modifiable'] = $article->isModifiable($G_bulletin_login);

$article_for_view['is_maintainer'] = $article->isMaintainer($G_bulletin_login);

// フォロー一覧

require_once('bulletin/follow_util.csp');
$list = new GRN_Bulletin_FollowList($G_bulletin_login, $article);
$list->setHeadFollowID($follow_id);
$list->setOffset($offset);
$list->setLimit($limit);
$list->setLockMode(CB_DATABASE_NO_LOCK);

$users_id = [];
$article_follows_for_view = [];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
$config = $utility->getInputConfigValues($G_bulletin_login);
$t->assign('enable_follow_autolink', $config['enable_follow_autolink']);
$base_url = cb_pageurl('bulletin/view',
    ['cid' => $category_id, 'aid' => $article_id, 'follow_id_autolink' => '']);

require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$use_star = $star_logic->isActive();
$t->assign('use_star', $use_star);

if ($config['enable_follow_autolink']) {
    while ( ! is_null(($follow =& $list->iterate()))) {
        $follow_id_sel = $follow->getOID();

        $article_follows_for_view[$follow_id_sel]
            = $utility->getFollowView($G_bulletin_login, $follow);

        if ($article_follows_for_view[$follow_id_sel]['html']) {
            $article_follows_for_view[$follow_id_sel]['html']
                = makeAutoLinkForHtmlEditor($article_follows_for_view[$follow_id_sel]['html'],
                htmlspecialchars('>>'), $base_url);
        }
        //GRN35-34
        $article_follows_for_view[$follow_id_sel]['full_url']
            = cb_get_full_url('bulletin/view', [
            'cid'                => $category_id,
            'aid'                => $article_id,
            'follow_id_autolink' => $article_follows_for_view[$follow_id_sel]['id']
        ]);
        $article_follows_for_view[$follow_id_sel]['full_url']
            = $article_follows_for_view[$follow_id_sel]['full_url'] . '#follow';
        //GRN35-34

        $users_id[]
            = $article_follows_for_view[$follow->getOID()]['creator_uid'];
    }
} else {
    while ( ! is_null(($follow =& $list->iterate()))) {
        $follow_id_sel = $follow->getOID();
        $article_follows_for_view[$follow_id_sel]
            = $utility->getFollowView($G_bulletin_login, $follow);

        //GRN35-34
        $article_follows_for_view[$follow_id_sel]['full_url']
            = cb_get_full_url('bulletin/view', [
            'cid'                => $category_id,
            'aid'                => $article_id,
            'follow_id_autolink' => $article_follows_for_view[$follow_id_sel]['id']
        ]);
        $article_follows_for_view[$follow_id_sel]['full_url']
            = $article_follows_for_view[$follow_id_sel]['full_url'] . '#follow';
        //GRN35-34

        $users_id[] = $article_follows_for_view[$follow_id_sel]['creator_uid'];
    }
}

// for favour
$favours_list = $favour_service->getFavourersCount($G_bulletin_login->getOID(),
    \GRN_Bulletin::GRN_BULLETIN_MODULE_ID,
    \GRN_Bulletin::FAVOUR_BULLETIN_COMMENT,
    array_keys($article_follows_for_view)
);

foreach ($article_follows_for_view as $follow_id => $follow_data) {
    if (isset($favours_list[$follow_id])) {
        $favour_info = $favours_list[$follow_id];
    } else {
        $favour_info = ['type_value' => $follow_id];
    }
    if ($is_favour_active) {
        $favour_info['module_id'] = \GRN_Bulletin::GRN_BULLETIN_MODULE_ID;
        $favour_info['sub_module_id']
            = \GRN_Bulletin::GRN_BULLETIN_SUB_MODULE_ID;
        $favour_info['type'] = \GRN_Bulletin::FAVOUR_BULLETIN_COMMENT;
        $favour_info['params'] = [
            'cid'       => $category_id,
            'aid'       => $article_id,
            'follow_id' => $follow_id
        ];
    }
    $article_follows_for_view[$follow_id]['favour_info'] = $favour_info;
}

$article_for_view['follows'] = $article_follows_for_view;

$users_id[] = $article_for_view['creator_uid'];
$users_id[] = $article_for_view['modifier_uid'];

$users_info = $utility->getUserInfoToShowUserName($users_id, $G_bulletin_login);

// User icon setting
$imageIcon = GRN_ControllerUtil::getUserIconFormat($G_bulletin_login);
$t->assign('imageIcon', $imageIcon);

// for user image icon
if ($imageIcon) {
    $users_info = GRN_ControllerUtil::addPhotoUrlForUsersInfo($users_info,
        GRN_ControllerUtil::getUserProfilePhotoSmallSize());
    $t->assign('iconSize', GRN_ControllerUtil::ICON_SIZE_SMALL);
}
$t->assign('loginId', $G_bulletin_login->getOID());
$t->assign('users_info', $users_info);

// 一覧ナビゲーションのパラメータ

$navi_for_view = $utility->makeNaviInformation(
    $list->getOffset(),
    $limit,
    $list->count(),
    ['cid' => $category_id, 'aid' => $article_id]
);

// フォローのN件送り用のパラメータをセット
$navi_for_view['navi']['fragment'] = 'follow';


// 前後のナビゲーション
$list_utility = null;
$default = 'ntd';

switch (cb_get_pagename()) {
    case 'bulletin/view':
        if ( ! $article->isExpired()) {
            $list_utility = new GRN_Bulletin_ControllerUtil('bulletin/index');
        }
        break;
    case 'bulletin/wait_view':
        $list_utility = new GRN_Bulletin_ControllerUtil('bulletin/wait_list');
        $default = 'stu';
        break;
    case 'bulletin/system/bulletin_view':
        $list_utility
            = new GRN_Bulletin_ControllerUtil('bulletin/system/bulletin_list');
        break;
    case 'bulletin/system/wait_view':
        $list_utility
            = new GRN_Bulletin_ControllerUtil('bulletin/system/wait_list');
        $default = 'stu';
        break;
}

if ( ! is_null($list_utility)) {
    $navi_for_view += $list_utility->getNeighborsView($G_bulletin_login,
        $article, $default);

    if (array_key_exists('prev', $navi_for_view)) {
        $navi_for_view['prev']['page_params']['cid'] = $category_id;
    }
    if (array_key_exists('next', $navi_for_view)) {
        $navi_for_view['next']['page_params']['cid'] = $category_id;
    }
}

// 記事を既読にする
$article->read($G_bulletin_login);
$t->assign('article', $article_for_view);
if (isset($article_for_view['title'])) {
    $t->assign('page_title', $article_for_view['title']);
}
$t->assign('navi', $navi_for_view);

$t->assign('data', @ $G_INPUT['data']);
$t->assign('editor', @ $G_INPUT['editor']);

require_once('fw/ui.csp');
$browser = cb_ui_get_browser();
$t->assign('browser', $browser);


