<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! array_key_exists('aid', $G_INPUT)) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    $article_id = $G_INPUT['aid'];

    if ( ! ($article = $G_bulletin->getArticle($G_bulletin_login, $article_id,
        GRN_BULLETIN_ACCESS_R, true, CB_DATABASE_EXCLUSIVE_LOCK))
    ) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
        require_once('grn/controller.csp');
        $properties['data'] = grn_strip_tags($G_INPUT['data']);
        $properties['html'] = $G_INPUT['data'];
    } else {
        $properties['data'] = $G_INPUT['data'];
        $properties['html'] = null;
    }

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if (is_null($properties['data'])
        || strlen(cb_trim($properties['data'])) < 1
    ) {
        if ( ! $files || count($files) == 0) {
            cb_throw_error(E_GRN_BULLETIN_EMPTY_FOLLOW);
        }
    }

    $follow = $article->writeFollow($G_bulletin_login, $properties, $files);

    assert('$follow !== FALSE');

    cb_redirect('bulletin/view',
        ['cid' => @$G_INPUT['cid'], 'aid' => $article_id], 'follow');

}
