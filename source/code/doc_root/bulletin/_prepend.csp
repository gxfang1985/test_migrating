<?php

use grn\grn\Validate;

require_once('grn/application.csp');

use grn\grn\access\service\AppAccess;

global $G_bulletin, $G_bulletin_login, $G_bulletin_login_config;

$locator = GRN_ApplicationLocator::instance();
$G_bulletin = null;
if ( ! ($G_bulletin = $locator->getInstance('bulletin'))) {
    cb_throw_error(E_GRN_BULLETIN_DEACTIVATED);
}
/* @var GRN_Bulletin $G_bulletin */

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$G_bulletin_login = $uum->getLoginUser();
/* @var CB_User $G_bulletin_login */
unset($uum);

AppAccess::checkInternalAccess('bulletin');
unset($locator);

require_once('grn/ui.csp');
$uim = GRN_UIConfigManager::getInstance();
$G_bulletin_login_config = $uim->getUserConfig($G_bulletin_login);
unset($uim);

use grn\bulletin\screen\mobile\MobileBulletinScreenBase;

global $G_state_set, $G_INPUT;
if ($G_state_set->get('is_cybozu_browser')
    && strpos(cb_get_pagename(), 'file_download') === false
) {
    MobileBulletinScreenBase::redirectMobilePage($G_INPUT);
}
///////////////////////////////////////

require_once('grn/multi_select_utility.csp');
$G_INPUT = grn_deploy_selected_users('selected_users_sUID', 'sUID', $G_INPUT);
if (isset($G_INPUT['selected_users_sUID'])) {
    unset($G_INPUT['selected_users_sUID']);
}

function _bulletin_rebuild_folder_tree($expand_oid = null)
{
    require_once('bulletin/folder_tree.csp');
    $list_page = 'bulletin/index';
    grn_bulletin_rebuild_folder_tree($list_page, $expand_oid);
}

switch (cb_get_pagename()) {
    case 'bulletin/command_send':
    case 'bulletin/command_draft_reuse':
    case 'bulletin/command_draft_send':
    case 'bulletin/command_modify':
    case 'bulletin/command_reuse':
    case 'bulletin/command_wait_modify':
    case 'bulletin/command_wait_reuse':
        // This code is required by validate_criteria.grn_bulletin_senderNotEmpty,
        // otherwise it causes validation error when the "manually_sender" field is disabled.
        if ( ! array_key_exists('manually_sender', $G_INPUT)) {
            $G_INPUT['manually_sender'] = '';
        }
        break;
    default:
        break;
}
