<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
}

// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form(cb_get_pagename(), true);

if ( ! array_key_exists('cid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

$category_id = $G_INPUT['cid'];

if ( ! ($category = $G_bulletin->getCategory($G_bulletin_login,
    $category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

$t->assign('category_id', $category_id);
$t->assign('memo', $category->get('description'));
$t->assign('foreign_key', $category->get('foreign_key'));

// 親カテゴリ情報
if (($parent =& $category->get('parent'))) {
    $t->assign('parent_name', $parent->get('name'));
}


require_once('bulletin/resources.csp');
require_once('bulletin/category.csp');
$categoryMgr = GRN_Bulletin_CategoryManager::getInstance();
$localLanguageValues
    = $categoryMgr->createMultiLanguageValuesArray($category_id);

$multiLanguageInfoArray = [];
$multiLanguageInfoArray['element_name'] = GRN_BULLETIN_ELEMENT_NAME_CATEGORY;
$multiLanguageInfoArray['values'] = $localLanguageValues;
$t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

if ($parent) {
    $privileges = $parent->getPrivileges($G_bulletin_login);
    $page_parts = explode('/', cb_get_pagename());
    $is_system = (cb_at($page_parts, 1) === 'system');

    if ($privileges['operation'] || $is_system) {
        require_once('bulletin/folder_tree.csp');
        $params = [
            'system'                  => $is_system,
            'force_hide_notification' => true
        ];
        $tree = new GRN_Bulletin_FolderTree($params);
        $tree_for_access = $tree->getTreeForView($parent, $is_system,
            'tree_for_access',
            'grn.page.category_form.access_dropdown.selectCategory');
        $tree_for_notification = $tree->getTreeForView($parent, $is_system,
            'tree_for_notification',
            'grn.page.category_form.notification_dropdown.selectCategory');

        $t->assign('tree_for_access', $tree_for_access);
        $t->assign('tree_for_notification', $tree_for_notification);
        $t->assign('tree_params', $params);
    }
}
