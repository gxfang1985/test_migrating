<?php

global $G_INPUT;

if ( ! @ $utility || ! is_a($utility, 'GRN_Bulletin_ControllerUtil')) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
}

/**
 * このスクリプトをインクルードするファイルで宣言される変数
 * $t : GRN_Smartyオブジェクト
 */

$category_id = @ $G_INPUT['cid'];
$t->assign('category_id', $category_id);

$session =& $utility->getSession();


if (@ $G_INPUT['sf']) {
    $items = $session->get('search_items');
    $text = cb_trim($session->get('search_text'));
    $input_text = $session->get('search_text');
    $scid = $session->get('search_cid');
    $sub = $session->get('search_sub');
    $limit = $session->get('search_limit');
    $sensitive = $session->get('search_sensitive');
} else {
    $items = [];
    if (@ $G_INPUT['ca']) {
        $items['category'] = 1;
    }
    if (@ $G_INPUT['su']) {
        $items['subject'] = 1;
    }
    if (@ $G_INPUT['da']) {
        $items['data'] = 1;
    }
    if (@ $G_INPUT['cr']) {
        $items['creator_name'] = 1;
    }
    if (@ $G_INPUT['fo']) {
        $items['follow'] = 1;
    }

    $text = cb_trim(@ $G_INPUT['text']);
    $input_text = @ $G_INPUT['text'];
    $scid = @ $G_INPUT['scid'];
    $sub = @ $G_INPUT['sb'];
    $limit = @ $G_INPUT['li'];
    $sensitive = @ $G_INPUT['se'];

    if ( ! @ $G_INPUT['in']) {
        // パラメータ初期化

        // デフォルトでは全項目を検索する
        $items = [
            'category'     => 1,
            'subject'      => 1,
            'data'         => 1,
            'creator_name' => 1,
            'follow'       => 1
        ];

        // デフォルトではサブフォルダを検索する
        $sub = 1;

        // デフォルトでは過去3ヶ月の更新を検索する
        $limit = 3;

        // デフォルトでは大文字小文字を区別しない
        $sensitive = false;

    }
    if (strlen($scid) < 1) {
        $scid = $category_id;
    }
}

if (@ $article_term == 'before') {
    if (array_key_exists('category', $items)) {
        unset($items['category']);
    }
    if (array_key_exists('creator_name', $items)) {
        unset($items['creator_name']);
    }
    if (array_key_exists('follow', $items)) {
        unset($items['follow']);
    }
}

$session->set('search_items', $items);
$session->set('search_text', $input_text);
$session->set('search_cid', $scid);
$session->set('search_sub', $sub);
$session->set('search_limit', $limit);
$session->set('search_sensitive', $sensitive);

$category = null;

if ($category_id) {
    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    $t->assign('category',
        ['name' => $category->get('name'), 'cid' => $category_id]);
}

$search_category = null;

if ($scid > 0) {
    if ( ! ($search_category =& $G_bulletin->getCategory($G_bulletin_login,
        $scid))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
}


require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$ui_config =& $cm->getUserConfig($G_bulletin_login);

$aitems = $items;

$search_count = 0;

if (strlen($text) && array_key_exists('category', $items)
    && $items['category']
) {
    unset($aitems['category']);

    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinCategoryCondition.csp');

    $searchCategoryCondition = new GrnBulletinCategoryCondition();
    $searchCategoryCondition->setCategoryId($search_category);
    $searchCategoryCondition->setEnableSubCategory($sub);
    $searchCategoryCondition->setOffset($utility->getNaviStartPosition('fsp'));
    $searchCategoryCondition->setLimit($ui_config->getListMax());
    $searchCategoryCondition->setText($text);
    $searchCategoryCondition->setSensitive($sensitive);

    $search = new GRN_Bulletin_CategorySearch($G_bulletin_login,
        $searchCategoryCondition);

    $resultCategoryList = $search->searchExecute();
    $categories_for_view = [];
    foreach ($resultCategoryList as $id => $category) {
        $categories_for_view[$id] = [
            'cid'  => $id,
            'name' => $category->get('name'),
            'path' => grn_bulletin_get_category_path_string($category),
        ];
    }

    $t->assign('search_category', ['result' => $categories_for_view]);

    $search_count = $search->count();
    unset($search);
}

$navi_params = [
    'cid' => $category_id,
    'sf'  => 1
];

$navi_information
    = $utility->makeNaviInformation($utility->getNaviStartPosition('fsp'),
    $ui_config->getListMax(),
    $search_count,
    $navi_params);

$t->assign('category_navi', $navi_information);


$search_count = 0;
$result = null;

if (strlen($text) && $aitems) {
    require_once('bulletin/include_search.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $searchArticleCondition = new GrnBulletinArticleCondition();
    $searchArticleCondition->setUser($G_bulletin_login);
    $searchArticleCondition->setCategoryId($search_category);
    $searchArticleCondition->setEnableSubCategory($sub);
    $searchArticleCondition->setOffset($utility->getNaviStartPosition());
    $searchArticleCondition->setLimit($ui_config->getListMax());
    $searchArticleCondition->setText($text);
    $searchArticleCondition->setItems($aitems);
    $searchArticleCondition->setSensitive($sensitive);
    /**
     * $personal_search はこのスクリプトをインクルードするファイルで定義される
     * $personal_search == TRUE : ログインユーザーが差出人の掲示に限定する
     */
    $searchArticleCondition->setPersonal(@ $personal_search);

    if ($limit) {
        require_once('fw/date.csp');
        $now = new CB_TimeStampEx();
        $today = $now->getDateTime();
        $today->hour = 0;
        $today->minute = 0;
        $today->second = 0;
        $today->moveMonths(-intval($limit));
        $now->setDateTime($today);

        $limit_params = [
            'column'   => 'ntime',
            'operator' => '>=',
            'value'    => null
        ];
        $limit_params['value'] = $now->unix_ts;
        $searchArticleCondition->setLimitColumn($limit_params);
    }

    /**
     * $article_term はこのスクリプトをインクルードするファイルで定義される
     * $article_term == 'before' : 掲示待ちを検索する
     * $article_term != 'before' : 公開掲示を検索する
     */
    if (@ $article_term == 'before') {
        $searchArticleCondition->setArticleTerm($article_term);
    } else {
        $searchArticleCondition->setArticleTerm('published');
    }

    $search = new GRN_Bulletin_ArticleSearch($G_bulletin_login,
        $searchArticleCondition);
    $resultArticleOrFollowList = $search->searchExecute();

    $result = [];
    $users_id = [];

    foreach ($resultArticleOrFollowList as $articleOrFollowRow) {
        $row_for_view = null;

        if (is_a($articleOrFollowRow, 'GRN_Bulletin_Follow')) {
            $row_for_view = $utility->getFollowListView($G_bulletin_login,
                $articleOrFollowRow, true);
            $row_for_view['dtype'] = 'f';
        } else {
            if (( ! @ $article_term || $article_term != 'before')) {
                $row_for_view = $utility->getArticleListView($G_bulletin_login,
                    $articleOrFollowRow, true);
            } else {
                $row_for_view = $utility->getArticleListView($G_bulletin_login,
                    $articleOrFollowRow, false);
            }

            $row_for_view['dtype'] = 'a';
        }

        $result[] = $row_for_view;
        $users_id[] = $row_for_view['creator_uid'];
    }

    $search_count = $search->count();
    $users_info = $utility->getUserInfoToShowUserName($users_id,
        $G_bulletin_login);

    $t->assign('users_info', $users_info);
}

$navi_params = [
    'cid' => $category_id,
    'sf'  => 1
];

$navi_information
    = $utility->makeNaviInformation($utility->getNaviStartPosition(),
    $ui_config->getListMax(),
    $search_count,
    $navi_params);

$t->assign('search', [
        'result'    => $result,
        'text'      => $input_text,
        'items'     => $items,
        'sub'       => $sub,
        'limit'     => $limit,
        'sensitive' => $sensitive,
        'scid'      => $scid,
        'term'      => @ $article_term,
        'personal'  => @ $personal_search,
    ]
);

$t->assign('navi', $navi_information);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));


