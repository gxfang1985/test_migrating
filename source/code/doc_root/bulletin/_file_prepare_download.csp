<?php

global $G_INPUT;

if ( ! @$G_INPUT['fid']) {
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}

$file_id = (int)$G_INPUT['fid'] ?: null;

if ( ! $file_id) {
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}
/* @var int $file_id */

require_once('bulletin/file.csp');
$manager = GRN_Bulletin_FileManager::getInstance();
$article_id = $manager->getArticleId($file_id);
$follow_id = $manager->getFollowId($file_id);

/** @var GRN_Bulletin $G_bulletin */
/** @var CB_User $G_bulletin_login */
if ( ! ($article = $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$file = null;

if ($follow_id) {
    if ( ! ($follow = $article->getFollow($follow_id))) {
        cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
    }
    /** @var GRN_Bulletin_File $file */
    $file = $follow->getFile($file_id);
} else {
    /** @var GRN_Bulletin_File $file */
    $file = $article->getFile($file_id);
}
$file_name = $file->getCurrentBody()->get('name');
