<?php
global $G_state_set;
$G_state_set->set("html_should_be_closed", false);
$G_state_set->set("copyright_should_be_written", false);
$G_state_set->set("error_page_type", "json");

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! array_key_exists('aid', $G_INPUT)) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    $article_id = $G_INPUT['aid'];

    if ( ! ($article = $G_bulletin->getArticle($G_bulletin_login, $article_id,
        GRN_BULLETIN_ACCESS_R, true, CB_DATABASE_EXCLUSIVE_LOCK))
    ) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    $properties['data'] = $G_INPUT['data'];
    $properties['html'] = null;

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if (is_null($properties['data'])
        || strlen(cb_trim($properties['data'])) < 1
    ) {
        if ( ! $files || count($files) == 0) {
            cb_throw_error(E_GRN_BULLETIN_EMPTY_FOLLOW);
        }
    }

    $follow = $article->writeFollow($G_bulletin_login, $properties, $files);

    assert('$follow !== FALSE');
}

echo json_encode(["succeed" => 1]);
