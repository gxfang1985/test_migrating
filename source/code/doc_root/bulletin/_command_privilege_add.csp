<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    $node_id = cb_at($G_INPUT, 'nid');
    $node_row = $G_bulletin->getCategory($G_bulletin_login, $node_id);
    if ( ! $node_row) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    require_once('bulletin/privilege.csp');
    $privilege_manager = GRN_Bulletin_PrivilegeManager::getInstance();

    $authorities = ['operation' => 1];

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');

    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $dynamic_roles = $uum_util->listDynamicRoles();

    foreach (array_keys($aid) as $item) {
        $ids = explode(':', $item);
        if (count($ids) < 2) {
            continue;
        }
        $id = $ids[1];
        switch ($ids[0]) {
            case 'user':
                if (($user = $uum->getUser($id))) {
                    $privilege_manager->modifyTarget($node_row, $user,
                        $authorities, true);
                }
                break;

            case 'group':
                if (($group = $uum->getGroup($id))) {
                    $privilege_manager->modifyTarget($node_row, $group,
                        $authorities, true);
                }
                break;

            case 'static_role':
                if (($role = $uum->getStaticRole($id))) {
                    $privilege_manager->modifyTarget($node_row, $role,
                        $authorities, true);
                }
                break;

            case 'dynamic_role':
                if (array_key_exists($id, $dynamic_roles)) {
                    $privilege_manager->modifyTarget($node_row, $id,
                        $authorities, true);
                }
                break;
        }
    }
}
