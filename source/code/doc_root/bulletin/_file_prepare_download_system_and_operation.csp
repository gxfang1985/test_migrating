<?php
global $G_INPUT;

if ( ! isset($G_INPUT['aid'])) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ( ! isset($G_INPUT['fid'])) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}

$article_id = $G_INPUT['aid'];
$follow_id = @ $G_INPUT['follow_id'];
$file_id = $G_INPUT['fid'];

/** @var GRN_Bulletin $G_bulletin */
/** @var CB_User $G_bulletin_login */
if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$file_manager = GRN_Bulletin_FileManager::getInstance();

if ($follow_id) {
    if ( ! ($follow = $article->getFollow($follow_id))) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
    }
    /** @var GRN_Bulletin_File $file */
    $file = $file_manager->getFile($follow, $file_id);
} else {
    /** @var GRN_Bulletin_File $file */
    $file = $file_manager->getFile($article, $file_id);
}

if ( ! $file) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}
$file_name = $file->getCurrentBody()->get('name');
