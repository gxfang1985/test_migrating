<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

// site position
$utility->setSitePosition($t, null);

$category_id = null;
if (array_key_exists('cid', $G_INPUT) && strlen($G_INPUT['cid']) > 0
    && $G_INPUT['cid'] != GRN_BULLETIN_ROOT_CATEGORY_ID
) {
    $category_id = $G_INPUT['cid'];
}

// --- category tree
$tree_info = [
    'link_url' => 'bulletin/system/category_list',
    'oid_key'  => 'cid'
];
$tree_selected_oid = $category_id;
include('../_category_tree.csp');
$category_id = $tree_selected_oid ? $tree_selected_oid
    : GRN_BULLETIN_ROOT_CATEGORY_ID;
// --- end: category tree

$t->assign('category_id', $category_id);

$limit = $G_bulletin_login_config->getListMax();

// 一覧開始位置
$offset = $utility->getListOffset();

// 一覧ソート
$order_column = $utility->getListOrderColumn(null, 'ntd');
$t->assign('sort', $order_column['param']);


// カテゴリツリーの取得

$category = null;

if ($category_id) {
    // 指定されたカテゴリを取得
    if ( ! ($category = $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
}

require_once('bulletin/hierarchy.csp');
$hierarchy = GRN_Bulletin_Hierarchy::getInstance();

$category_for_view = $hierarchy->buildUsingTree($G_bulletin_login, $category,
    $tree);

// 記事一覧の取得
require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($G_bulletin_login);
$conditionObj->setCategory($category);
$conditionObj->setArticleTerm('all');
$conditionObj->setOffset($offset);
$conditionObj->setLimit($limit);
$conditionObj->addSort($order_column['column'], $order_column['order']);

$coll = new GRN_Bulletin_ArticleList($conditionObj);


$article_for_view = [];

$articleList = $coll->searchExecute();
foreach ($articleList as $article) {
    $for_view = $utility->getArticleListView($G_bulletin_login, $article);

    $for_view['published'] = $article->isPublished();
    $for_view['expired'] = $article->isExpired();

    $article_for_view[$article->getOID()] = $for_view;
}

$t->assign('users_info',
    $utility->getUserInfoToShowUserName($utility->getUsersInArticle($article_for_view),
        $G_bulletin_login));

// 一覧ナビゲーション

$navi_for_view = $utility->makeNaviInformation($offset,
    $limit,
    $coll->count(),
    ['cid' => $category_id, 'sf' => 1]);

$articles_for_view = ['article' => $article_for_view];

$t->assign('category', $category_for_view);
$t->assign('articles', $articles_for_view);
$t->assign('navi', $navi_for_view);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));

$t->display(cb_get_pagename() . ".tpl");

