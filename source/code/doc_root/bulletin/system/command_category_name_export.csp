<?php


if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // 文字コード
    $charset = @ $G_INPUT['charset'];
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    // 項目名の書き出し
    $isExportHeader = true;
    if (array_key_exists('item_name', $G_INPUT)) {
        $isExportHeader = ($G_INPUT['item_name'] == 1) ? true : false;
    }

    //出力対象言語
    $exportLanguageCodeArray = [];
    if (array_key_exists('all', $G_INPUT)) {
        $exportLanguageCodeArray = null;
    } else {
        $i18n = CB_I18N::getInstance();
        $availableLanguageArray = $i18n->getAvailableLanguages();
        foreach ($availableLanguageArray as $languageCode) {
            if (array_key_exists($languageCode, $G_INPUT)) {
                $exportLanguageCodeArray[] = $languageCode;
            }
        }

        if (count($exportLanguageCodeArray) <= 0) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_INVALID_NOT_SELECTED_LANGUAGE);
        }
    }


    require_once('bulletin/category.csp');
    $categoryMgr = GRN_Bulletin_CategoryManager::getInstance();
    $tempFilename = $categoryMgr->createCategoryNameCSV($charset,
        $isExportHeader, $exportLanguageCodeArray);


    // 一時ファイルに書き出した内容をファイルとして出力
    cb_prepare_download('category_name.csv', 'application/csv', false);
    $fp = fopen($tempFilename, 'rb');
    if (($size = filesize($tempFilename)) > 0) {
        echo fread($fp, $size);
    }
    fclose($fp);


    // 一時ファイルの削除
    unlink($tempFilename);
}
