<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if ( ! ($category_id = @ $G_INPUT['cid'])) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}
if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
    $category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

if ( ! ($parent =& $category->get('parent'))) {
    cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
}

if (array_key_exists('s_cid', $G_INPUT) && strlen($G_INPUT['s_cid']) > 0) {
    $set_category_id = $G_INPUT['s_cid'];
} else {
    $set_category_id = $parent->getOID();
}

$page_path = [
    'bulletin/system/category_list' => ['cid' => $category_id],
    'bulletin/system/category_view' => ['cid' => $category_id],
];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $page_path);


// 移動カテゴリ

$target_for_view = [
    'name' => $category->get('name'),
    'cid'  => $category->getOID()
];

if (($parent =& $category->get('parent'))) {
    require_once('bulletin/functions.csp');

    $target_for_view['parent'] = [
        'name' => $parent->get('name'),
        'path' => grn_bulletin_get_category_path_string($parent),
    ];
}

$t->assign('target', $target_for_view);

if ( ! array_key_exists('ss', $G_INPUT) || ! $G_INPUT['ss']) {
    $ignore_root_category = $category->getOID();
    $ignore_categories = [$category->getOID() => & $category];
}

require_once('../_category_select.csp');

$t->display(cb_get_pagename() . ".tpl");

