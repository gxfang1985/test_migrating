<?php

use grn\bulletin\logic\BulletinAdjustSubscribeLogic;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! ($category_id = @ $G_INPUT['cid'])) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    $set_category_id = @ $G_INPUT['s_cid'];

    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    if ( ! $set_category_id) {
        $dummy = null;
        $category->setParent($G_bulletin_login, $dummy);
    } else {
        if ( ! ($parent =& $G_bulletin->getCategory($G_bulletin_login,
            $set_category_id))
        ) {
            cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
        }
        $category->setParent($G_bulletin_login, $parent);
        if ($set_category_id) {
            BulletinAdjustSubscribeLogic::getInstance()
                                        ->applySubscribeFromParentCategory($category_id,
                                            $set_category_id);
        }
    }

    _bulletin_rebuild_folder_tree($set_category_id);

    cb_redirect('bulletin/system/category_view',
        ['cid' => $category->getOID()]);
}
