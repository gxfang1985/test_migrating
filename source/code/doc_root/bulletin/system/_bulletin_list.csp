<?php

global $G_INPUT;

if ( ! isset($list_category_id)) {
    $list_category_id = @ $G_INPUT['cid'];
}
if ( ! isset($list_category)) {
    $list_category = null;
}

if ( ! $list_category_id) {
    $list_category_id = GRN_BULLETIN_ROOT_CATEGORY_ID;
}

require_once('bulletin/controller.csp');
$list_utility
    = new GRN_Bulletin_ControllerUtil('bulletin/system/bulletin_list');


// 指定されたカテゴリを取得
if ( ! ($list_category =& $G_bulletin->getCategory($G_bulletin_login,
    $list_category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}


// 記事の一覧を取得

// 一覧件数
$limit = $G_bulletin_login_config->getListMax();

// 一覧開始位置
$offset = $list_utility->getListOffset();

// 一覧ソート
$order_column = $list_utility->getListOrderColumn(null, 'ntd');
$t->assign('sort', $order_column['param']);


$list_session =& $list_utility->getSession();

$list_item = @ $G_INPUT['list_item'];

if (cb_get_pagename() != 'bulletin/system/bulletin_list' || @ $G_INPUT['sf']) {
    $list_item = $list_session->get('list_item');
}
if ( ! $list_item) {
    $list_item = 'all'; // 絞り込みの初期値
}

require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($G_bulletin_login);
$conditionObj->setCategory($list_category);
$conditionObj->setOffset($offset);
$conditionObj->setLimit($limit);
$conditionObj->addSort($order_column['column'], $order_column['order']);


$coll = null;

if ($list_item == 'all') {
    // 全て
    $conditionObj->setArticleTerm('all');
    $coll = new GRN_Bulletin_ArticleList($conditionObj);
} elseif ($list_item == 'before') {
    // 掲示開始待ちのみ
    $conditionObj->setArticleTerm('before');
    $conditionObj->setPersonal(true);
    $coll = new GRN_Bulletin_ArticleBeforeList($conditionObj);
} elseif ($list_item == 'expired') {
    // 期限切れのみ
    $conditionObj->setArticleTerm('expired');
    $coll = new GRN_Bulletin_ArticleExpiredList($conditionObj);
} else {
    // 公開のみ
    $coll = new GRN_Bulletin_ArticleList($conditionObj);
}

$coll->searchExecute();

if (cb_get_pagename() == 'bulletin/system/bulletin_list') {
    $list_session->set('list_item', $list_item);
    $t->assign('list_item', $list_item);

    $navi_for_view = $list_utility->makeNaviInformation($offset,
        $limit,
        $coll->count(),
        ['cid' => $category_id, 'sf' => 1]);

    $t->assign('navi', $navi_for_view);
}


