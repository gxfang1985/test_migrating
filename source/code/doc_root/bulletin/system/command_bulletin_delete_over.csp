<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $category_id = null;
    if (array_key_exists('cid', $G_INPUT)) {
        $category_id = $G_INPUT['cid'];
    }

    $category = null;

    if ($category_id) {
        if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
            $category_id))
        ) {
            cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
        }
    }

    require_once('bulletin/article_util.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

    $conditionObj = new GrnBulletinArticleCondition();
    $conditionObj->setUser($G_bulletin_login);
    $conditionObj->setCategory($category);
    $conditionObj->setArticleTerm('expired');

    $coll = new GRN_Bulletin_ArticleExpiredList($conditionObj);

    /**
     * 100件を削除するごとに実行時間をチェックして、1分経過で一旦終了する
     */

    $limit = 60;
    $start = time();
    $counter = 0;
    $remain = false;

    $articleList = $coll->searchExecute();

    foreach ($articleList as $article) {
        if (++$counter >= 100) {
            $now = time();
            if (($now - $start) >= $limit) {
                $remain = true;
                break;
            }
        }
        $article->delete($G_bulletin_login);
    }

    if ($remain) {
        cb_redirect('bulletin/system/bulletin_delete_over',
            ['cid' => $category_id, 'cont' => 1]);
    }

    cb_redirect('bulletin/system/bulletin_list',
        ['cid' => $category_id, 'sf' => 1]);

}
