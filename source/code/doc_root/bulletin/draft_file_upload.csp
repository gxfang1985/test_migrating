<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;


if ( ! isset($G_INPUT['aid'])) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
}
if ( ! isset($G_INPUT['fid'])) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
}

$article_id = $G_INPUT['aid'];
$file_id = $G_INPUT['fid'];

if ( ! ($article =& $G_bulletin->getDraft($G_bulletin_login, $article_id))) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
}

$pathinfo = [
    "bulletin/index"           => null,
    "bulletin/draft_list"      => null,
    "bulletin/draft_view"      => ['aid' => $article_id],
    "bulletin/draft_file_view" => ['aid' => $article_id, 'fid' => $file_id],
];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $pathinfo);

$file =& $article->getFile($file_id);

require_once('_file_upload.csp');

//generate upload ticket
include('grn/_upload_prepend.csp');

// Smarty実行
$t->display(cb_get_pagename() . ".tpl");

