<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

require_once('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form(cb_get_pagename(), true);

// 設定をセット
$config_values = [];
$system_config
    =& $G_bulletin->getSystemConfig($G_bulletin_login);
$config_values['enable_htmleditor'] = $system_config->getEnableHtmlEditor();
$config_values['enable_follow'] = $system_config->getEnableFollow();
require_once('grn/ui.csp');
$ucm = GRN_UIConfigManager::getInstance();
$user_config =& $ucm->getUserConfig($G_bulletin_login);
$config_values['area_width'] = $user_config->getAreaWidth();
$config_values['area_height'] = $user_config->getAreaHeight();
$t->assign('config', $config_values);
$t->assign('can_follow', $config_values['enable_follow']);

$enable_manually_enter_sender = $system_config->getEnableManuallyEnterSender();
$t->assign('enable_manually_enter_sender', $enable_manually_enter_sender);

if ( ! isset($utility) || ! is_a($utility, 'GRN_Bulletin_ControllerUtil')) {
    require_once('bulletin/controller.csp');
    $utility = new GRN_Bulletin_ControllerUtil();
}

if ( ! isset($category_id)) {
    $category_id = @ $G_INPUT['cid'];
}
$t->assign('category_id', $category_id);

if ( ! isset($article_id)) {
    if ( ! isset($G_INPUT['aid'])) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }
    $article_id = $G_INPUT['aid'];
}

$t->assign('article_id', $article_id);

// 記事の取得
if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
if ( ! $article->isModifiable($G_bulletin_login)) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_MODIFY);
}

$category_id = $article->getId('category');

// カテゴリ情報の取得
if (isset($category_id) && $category_id) {
    if (($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        if ($category->access($G_bulletin_login, GRN_BULLETIN_ACCESS_W)) {
            $t->assign('category_id', $category_id);
            $t->assign('category_name', $category->get('name'));
        }
    }
}

//sender type
if ($enable_manually_enter_sender) {
    $manually_enter_sender = $article->get('manually_enter_sender');
    if ( ! is_null($manually_enter_sender)) {
        $t->assign('is_sender_type_custom', true);
        $t->assign('manually_sender_data', $manually_enter_sender);
    } else {
        $t->assign('is_sender_type_creator', true);
    }
}

//maintainers
require_once('grn/controller.csp');
require_once('bulletin/BulletinFacade.csp');
$dao = new BulletinFacade();
$maintainer_list = $dao->getOperatorListByArticleId([],
    $article->getOID());
$maintainer_list_view = [];
if (count($maintainer_list) > 0) {
    $t->assign('is_maintainer_type_other', true);
    $maintainer_list_view = $dao->getOperatorListForView($maintainer_list,
        false, false);
} else {
    $t->assign('is_maintainer_type_sender', true);
}
$t->assign('maintainers', $maintainer_list_view);

$choose_group_checked = false;
$choose_group_disbaled = false;
$select_group_disabled = true;
$group_options = [];
$group_selected = null;
if ($article) {
    $group_selected = $article->get('creator_group');
    $article_creator = $article->get('creator');

    if (is_null($article_creator)) {
        // 掲示の差出人が削除されている場合
        $choose_group_checked = false;
        $choose_group_disbaled = true;
        $select_group_disabled = true;

        if (is_null($group_selected)) {
            // creator_groupがない(指定されていない、もしくは削除された)
            // 場合、空のセレクトボックスを表示する
            $group_options[0]['value'] = '';
            $group_options[0]['label'] = '';
        } else {
            // 掲示の差出人の組織が指定されている場合
            $group_options[0]['value'] = $group_selected->getOID();
            $group_options[0]['label'] = $group_selected->get('name');
            $choose_group_checked = true;
        }
    } else {
        $group_options
            = $G_bulletin->getUserGroupOptions($article_creator->getOID(),
            $group_selected);
        if ( ! is_null($group_selected)) {
            foreach ($group_options as $group) {
                if (array_key_exists('selected', $group)) {
                    $choose_group_checked = true;
                    $select_group_disabled = false;
                    break;
                }
            }
        }
        if (count($group_options) > 0 && ! $group_options[0]['value']) {
            $choose_group_disbaled = true;
        }
    }
}

$t->assign('group_options', $group_options);
$t->assign('choose_group_checked', $choose_group_checked);
$t->assign('choose_group_disbaled', $choose_group_disbaled);
$t->assign('select_group_disabled', $select_group_disabled);

require_once('fw/date.csp');

$start_ts = $article->get('start_timestamp');
$end_ts = $article->get('end_timestamp');
//
$start_is_datetime = $article->get('start_is_datetime');
$end_is_datetime = $article->get('end_is_datetime');
$start_time = null;
$end_time = null;

$sdate = null;
$edate = null;

if ($start_ts && $start_ts->unix_ts != 0) {
    $start_ts_ex = new CB_TimeStampEx($start_ts);
    $sdate = $start_ts_ex->getDateTime();

    $start_time = $start_ts_ex->getTime();
    if ($start_time->hour == 0 && ! $start_is_datetime) {
        $start_time = null;
    }
}

if ($end_ts && $end_ts->unix_ts != 0) {
    $end_ts_ex = new CB_TimeStampEx($end_ts);
    $edate = $end_ts_ex->getDate();

    $end_time = $end_ts_ex->getTime();
    if ($end_time->hour == 0 && ! $end_is_datetime) {
        $end_time = null;
        // 記事に設定されている終了日は1日進められているので戻す
        $edate->moveDays(-1);
    }
}
$t->assign('start_time', $start_time);
$t->assign('end_time', $end_time);
$t->assign('minute_interval', 5);

$t->assign('aid', $article->getOID());

$t->assign('title', $article->get('subject'));
$t->assign('stime', $sdate);
$t->assign('etime', $edate);
$t->assign('data', $article->get('data'));
$t->assign('html', $article->get('html'));
$t->assign('can_follow', $article->get('can_follow'));
$t->assign('published', $article->isPublished());
$t->assign('acknowledgement',
    $article->get('reserve_int1'));//This is acknowledgement field in db

if ( ! is_null($sdate) || ! is_null($edate)) {
    $t->assign('set_limit', true);
} else {
    $tsex = new CB_TimeStampEx();
    $t->assign('etime', $tsex->getDate());

    $t->assign('set_limit', false);
}

if ($article->get('html')) {
    if ($config_values['enable_htmleditor']) {
        $t->assign('editor', 1);
    }
}

//generate upload ticket
include('grn/_upload_prepend.csp');

$files = $article->getFiles();

if ($creator =& $article->get('creator')) {
    $t->assign('creator_name', $creator->get('display_name'));
    $t->assign('creator_uid', $creator->getOID());
} else {
    $t->assign('creator_name', $article->get('creator_name'));
}

$t->assign('plugin',
    ['name' => 'bulletin', 'params' => ['category_id' => $category_id]]);

// セッションにファイルはコピーしない
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);
$files_for_view = grn_init_attached_file(cb_get_pagename() . $tmp_key, $files,
    true, 'bulletin');

$t->assign('attach_files', $files_for_view);



