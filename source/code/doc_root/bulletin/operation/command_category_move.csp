<?php

use grn\bulletin\logic\BulletinAdjustSubscribeLogic;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! @ $G_INPUT['cid']) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    // 変更するカテゴリID
    $category_id = $G_INPUT['cid'];
    // 親カテゴリ
    $parent_cid = @ $G_INPUT['s_cid'];

    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    if ( ! $category->privileged($G_bulletin_login, ['operation'])) {
        cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
    }

    if ( ! $parent_cid) {
        cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
        //$dummy = null;
        //$category->setParent( $G_bulletin_login, $dummy );
    } else {
        if ( ! ($parent =& $G_bulletin->getCategory($G_bulletin_login,
            $parent_cid))
        ) {
            cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
        }
        if ( ! $parent->privileged($G_bulletin_login, ['operation'])) {
            cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
        }
        $category->setParent($G_bulletin_login, $parent);
        if ($parent_cid) {
            BulletinAdjustSubscribeLogic::getInstance()
                                        ->applySubscribeFromParentCategory($category_id,
                                            $parent_cid);
        }
    }

    _bulletin_rebuild_folder_tree($parent_cid);

    cb_redirect('bulletin/operation/category_view',
        ['cid' => $category->getOID()]);
}
