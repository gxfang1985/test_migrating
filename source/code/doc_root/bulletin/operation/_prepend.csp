<?php

use grn\grn\Validate;

require_once('grn/application.csp');

global $G_INPUT;

$locator = GRN_ApplicationLocator::instance();
global $G_bulletin;
$G_bulletin = null;
if ( ! ($G_bulletin =& $locator->getInstance('bulletin'))) {
    cb_throw_error(E_GRN_BULLETIN_DEACTIVATED);
}
unset($locator);

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
global $G_bulletin_login;
$G_bulletin_login =& $uum->getLoginUser();
unset($uum);

require_once('grn/ui.csp');
$uim = GRN_UIConfigManager::getInstance();
global $G_bulletin_login_config;
$G_bulletin_login_config =& $uim->getUserConfig($G_bulletin_login);
unset($uim);

/**
 * In operation folder, 'cid' or 'nid' are required.
 * And it is necessary that the login-user has the operational administrator of cid and nid.
 */
$cid = cb_at($G_INPUT, 'cid');
$nid = cb_at($G_INPUT, 'nid');
if ( ! $nid && ! $cid) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

require_once('bulletin/privilege.csp');
$pm = GRN_Bulletin_PrivilegeManager::getInstance();

if ($cid) {
    $category = $G_bulletin->getCategory($G_bulletin_login, $cid);
    if ( ! $category) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    if ( ! $pm->privileged($G_bulletin_login, $category, ['operation'])) {
        cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
    }
}

if ($nid) {
    $category = $G_bulletin->getCategory($G_bulletin_login, $nid);
    if ( ! $category) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    if ( ! $pm->privileged($G_bulletin_login, $category, ['operation'])) {
        cb_throw_error(E_GRN_BULLETIN_OPERATION_NOT_GRANTED);
    }
}
unset($category, $pm, $cid, $nid);

///////////////////////////////////////

function _bulletin_rebuild_folder_tree($expand_oid = null)
{
    require_once('bulletin/folder_tree.csp');
    $list_page = 'bulletin/index';
    grn_bulletin_rebuild_folder_tree($list_page, $expand_oid);
}

require_once('grn/multi_select_utility.csp');
$G_INPUT = grn_deploy_selected_users('selected_users_sUID', 'sUID', $G_INPUT);
if (isset($G_INPUT['selected_users_sUID'])) {
    unset($G_INPUT['selected_users_sUID']);
}

switch (cb_get_pagename()) {
    case 'bulletin/operation/command_bulletin_modify':
        // This code is required by validate_criteria.grn_bulletin_senderNotEmpty,
        // otherwise it causes validation error when the "manually_sender" field is disabled.
        if ( ! array_key_exists('manually_sender', $G_INPUT)) {
            $G_INPUT['manually_sender'] = '';
        }
        break;
    default:
        break;
}

