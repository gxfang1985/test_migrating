<?php

global $G_INPUT;


if ( ! isset($list_category_id)) {
    if (isset($category_id)) {
        $list_category_id = $category_id;
    } else {
        $list_category_id = @ $G_INPUT['cid'];
    }
}
if ( ! isset($list_category)) {
    $list_category = null;
}

require_once('bulletin/controller.csp');
$list_utility
    = new GRN_Bulletin_ControllerUtil('bulletin/operation/bulletin_list');

$limit = $G_bulletin_login_config->getListMax();

// 一覧開始位置
$offset = $list_utility->getListOffset();

// 一覧ソート
$order_column = $list_utility->getListOrderColumn(null, 'ntd');
$t->assign('sort', $order_column['param']);


// 指定されたカテゴリを取得
if ( ! ($list_category =& $G_bulletin->getCategory($G_bulletin_login,
    $list_category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}


// 記事の一覧を取得
$list_session =& $list_utility->getSession();

$list_item = @ $G_INPUT['list_item'];

if (cb_get_pagename() != 'bulletin/operation/bulletin_list'
    || @ $G_INPUT['sf']
) {
    $list_item = $list_session->get('list_item');
}
if ( ! $list_item) {
    $list_item = 'all';
}


require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($G_bulletin_login);
$conditionObj->setCategory($list_category);
$conditionObj->setOffset($offset);
$conditionObj->setLimit($limit);
$conditionObj->addSort($order_column['column'], $order_column['order']);

$list = null;

if ($list_item == 'all') {
    // 全て
    $conditionObj->setArticleTerm('all');
    $list = new GRN_Bulletin_ArticleList($conditionObj);
} elseif ($list_item == 'before') {
    // 掲示開始待ちのみ
    $conditionObj->setArticleTerm('before');
    $conditionObj->setPersonal(true);
    $list = new GRN_Bulletin_ArticleBeforeList($conditionObj);
} elseif ($list_item == 'expired') {
    // 期限切れのみ
    $conditionObj->setArticleTerm('expired');
    $list = new GRN_Bulletin_ArticleExpiredList($conditionObj);
} else {
    // 公開のみ
    $list = new GRN_Bulletin_ArticleList($conditionObj);
}

$list->searchExecute();

if (cb_get_pagename() == 'bulletin/operation/bulletin_list') {
    $list_session->set('list_item', $list_item);
    $t->assign('list_item', $list_item);

    $navi_for_view = $list_utility->makeNaviInformation($offset,
        $limit,
        $list->count());

    $navi_for_view['navi']['params'] = [
        'cid'  => $list_category_id,
        'sort' => $order_column['param']
    ];

    $t->assign('navi', $navi_for_view);
}

