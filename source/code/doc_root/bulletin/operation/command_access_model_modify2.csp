<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    if ( ! ($category_id = @ $G_INPUT['nid'])) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    if ( ! ($security_model = @ $G_INPUT['security_model'])) {
        cb_throw_error(E_GRN_BULLETIN_INVALID_SECURITY_MODEL);
    }

    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    require_once('bulletin/access.csp');
    $acc = GRN_Bulletin_AccessManager::getInstance();

    if ($security_model == 'revoke') {
        $security_model = GRN_BULLETIN_SECURITY_MODEL_REVOKE;
    } else {
        $security_model = GRN_BULLETIN_SECURITY_MODEL_GRANT;
    }

    $acc->setSecurityModel($G_bulletin_login, $category, $security_model);

    if ( ! $acc->access($G_bulletin_login, $category, GRN_BULLETIN_ACCESS_R)) {
        if ($acc->getSecurityModel($category)
            == GRN_BULLETIN_SECURITY_MODEL_GRANT
        ) {
            $acc->addTarget($category, $G_bulletin_login,
                ['read' => 1, 'write' => 1, 'follow' => 1]);
        }
    }

    cb_redirect('bulletin/operation/access_list',
        ['nid' => $category_id, 'poid' => @$G_INPUT['poid'], 'reset' => 1]);
}


