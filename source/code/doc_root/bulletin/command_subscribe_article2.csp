<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! @ $G_INPUT['aid']) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    $category_id = @$G_INPUT['cid'];
    $article_id = $G_INPUT['aid'];

    if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login,
        $article_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }

    $subscription = $article->isSubscribed($G_bulletin_login);
    if ($subscription) {
        if (($ret = $article->subscribe($G_bulletin_login, false))) {
            $subscription = false;
        }
    } else {
        if (($ret = $article->subscribe($G_bulletin_login, true))) {
            $subscription = true;
        }
    }

    global $G_config_grn;
    $i18n = CB_I18N::getInstance();

    $charset = mb_preferred_mime_name(cb_get_http_output_encoding());
    // Content-Typeの変更
    cb_prepare_download('', 'application/xml; charset=' . $charset, false);

    $xml_writer = new XMLWriter();
    $xml_writer->openURI('php://output');
    $xml_writer->setIndentString("\t");
    $xml_writer->setIndent(true);
    $xml_writer->startDocument('1.0', $charset);
    $xml_writer->startElement('garoon');
    $xml_writer->writeAttribute('version',
        $G_config_grn->get('System', 'version'));
    $xml_writer->writeAttribute('xml:lang', $i18n->getCurrentLanguage());
    $ts = new CB_TimeStampEx();
    $ts->setTimezone('UTC');
    $dt = $ts->getDateTime();
    $xml_writer->writeAttribute('datetime',
        sprintf('%04d-%02d-%02dT%02d:%02d:%02dZ', $dt->year, $dt->month,
            $dt->day, $dt->hour, $dt->minute, $dt->second));

    $xml_writer->startElement('data');

    if ($ret) {
        $xml_writer->startElement('result');
        $xml_writer->text('true');
        $xml_writer->endElement();   // result
        $xml_writer->startElement('subscription');
        $xml_writer->text($subscription ? 'on' : 'off');
        $xml_writer->endElement();   // subscription
    } else {
        $xml_writer->startElement('result');
        $xml_writer->text('false');
        $xml_writer->endElement();   // result
    }

    $xml_writer->endElement();   // data
    $xml_writer->endElement();   // garoon
    $xml_writer->endDocument();
    $xml_writer->flush();
}
