<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

global $G_INPUT;

//Create Font Options Array
$font_options = [
    ['value' => 'small', 'label' => cb_msg('grn.bulletin', 'font_size_small')],
    [
        'value' => 'normal',
        'label' => cb_msg('grn.bulletin', 'font_size_normal')
    ],
    ['value' => 'large', 'label' => cb_msg('grn.bulletin', 'font_size_large')],
];
$font_size = @$portlet['settings']['font_size'];
switch ($font_size) {
    case 'small':
        $font_options[0]['selected'] = true;
        break;
    case 'normal':
        $font_options[1]['selected'] = true;
        break;
    case 'large':
        $font_options[2]['selected'] = true;
        break;
    default:
        $font_options[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options);

//Crerate Select Number Array
$select_numbers = [];
for ($i = 1; $i < 21; ++$i) {
    $select_numbers[] = $i;
}
$t->assign('select_numbers', $select_numbers);

// セッションから値を取り出す
// ss はフォルダ選択時のポストから戻った場合のフラグ
if (@ $G_INPUT['ss']) {
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $session =& $sm->getSession('bulletin/portlet/settings');

    $session_portlet = $session->get('portlet');
    if ($session_portlet) {
        $portlet =& $session_portlet;
    }
}

if ( ! array_key_exists('settings', $portlet)) {
    $portlet['settings'] = [
        'cid'          => null,
        'rows'         => 5,
        'hide_columns' => [
            'abstract' => 0,
            'creator'  => 0,
            'mtime'    => 0
        ]
    ];
} else {
    if ( ! array_key_exists('rows', $portlet['settings'])) {
        $portlet['settings']['rows'] = 5;
    }
    if ( ! array_key_exists('hide_columns', $portlet['settings'])) {
        $portlet['settings']['hide_columns'] = [
            'abstract' => 0,
            'creator'  => 0,
            'mtime'    => 0
        ];
    }
}

// 表示カテゴリを取得

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$bulletin =& $locator->getInstance('bulletin');

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

$category_id = @ $portlet['settings']['cid'];

if (array_key_exists('s_cid', $G_INPUT) && strlen($G_INPUT['s_cid']) > 0) {
    $category_id = $G_INPUT['s_cid'];
}

if ( ! $category_id) {
    require_once('bulletin/table.csp');
    $category_id = GRN_BULLETIN_ROOT_CATEGORY_ID;
}

$category = null;
if ($category_id) {
    if (($category =& $bulletin->getCategory($login, $category_id,
            GRN_BULLETIN_ACCESS_R, false)) === false
    ) {
        $portlet['settings']['cid'] = null;
    }
}

if (array_key_exists('text', $G_INPUT)) {
    // カテゴリ検索

    $result_for_view = [];

    if (array_key_exists('text', $G_INPUT) && strlen($G_INPUT['text']) > 0) {
        $t->assign('text', $G_INPUT['text']);

        require_once('bulletin/category.csp');
        $cm = GRN_Bulletin_CategoryManager::getInstance();

        $categories = $cm->search($login, $G_INPUT['text']);

        require_once('bulletin/functions.csp');

        foreach (array_keys($categories) as $cid) {
            $item =& $categories[$cid];

            $result_for_view[$cid] = [
                'name' => $item->get('name'),
                'cid'  => $cid,
                'path' => grn_bulletin_get_category_path_string($item),
            ];
        }

    }

    $t->assign('search', [
            'result' => $result_for_view,
            'count'  => count($result_for_view),
            'text'   => $G_INPUT['text'],
        ]
    );

    if (count($result_for_view) < 1) {
        $t->assign('set_category_id', null);
    }

} else {
    // 通常のフォルダツリーからの選択画面を表示する場合

    require_once('bulletin/category.csp');
    $cm = GRN_Bulletin_CategoryManager::getInstance();

    if (($category =& $cm->getCategory($login, $category_id,
            GRN_BULLETIN_ACCESS_R, false)) === false
    ) {
        $category_id = GRN_BULLETIN_ROOT_CATEGORY_ID;
    }

    require_once('bulletin/hierarchy.csp');
    $hierarchy = GRN_Bulletin_Hierarchy::getInstance();

    $category_for_view = $hierarchy->build($login, $category);

    // カテゴリツリー
    $t->assign('category', $category_for_view);
}

$t->assign('set_category_id', $category_id);

$params = [
    'pid'     => $portlet['pid'],
    'plid'    => $portlet['plid'],
    'ppid'    => $portlet['ppid'],
    'display' => $portlet['display'],
];

// ツリー表示リンクのパラメータ
$t->assign('params', $params);

$t->assign('set_category_id', $category_id);

if (@ $portlet['settings']['cid']) {
    if (($category =& $bulletin->getCategory($login,
            $portlet['settings']['cid'], GRN_BULLETIN_ACCESS_R, false))
        !== false
    ) {
        $t->assign('current', ['name' => $category->get('name')]);
    }
}


// フォルダ選択時のポストからリダイレクトされる場合以外はセッションに保存
if ( ! @ $G_INPUT['ss']) {
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $session =& $sm->getSession('bulletin/portlet/settings');
    $session->set('portlet', $portlet);
}


//Assign include_php Parameter
$t->assign('portlet', $portlet);
$t->assign('display', $display);

// Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("bulletin/portlet/settings.tpl");

