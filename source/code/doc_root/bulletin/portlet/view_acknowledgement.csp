<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}
//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
$settings = $portlet['settings'];

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

require_once('bulletin/notification.csp');
$notification = new GRN_Bulletin_NotificationManager();
$arrayCategory = $notification->getNotifiedCategoryIds($login, false);

if (is_array($arrayCategory) && count(($arrayCategory)) > 0) {
    if ( ! is_null($portlet['settings'])) {
        $rows = cb_at($portlet['settings'], 'rows');
    }
    if ( ! $rows) {
        $rows = 5;
    }

    require_once('bulletin/article_util.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');
    require_once('bulletin/controller.csp');

    $utility = new GRN_Bulletin_ControllerUtil();
    $order_column = $utility->getListOrderColumn('ntd', 'ntd');

    $conditionObj = new GrnBulletinArticleCondition();
    $conditionObj->setUser($login);
    $conditionObj->setCategory(array_keys($arrayCategory));
    $conditionObj->setAcknowledgement(true);
    $conditionObj->setLimit($rows);
    $conditionObj->addSort($order_column['column'], $order_column['order']);
    $coll = new GRN_Bulletin_ArticleList($conditionObj);
    $coll->setLockMode(CB_DATABASE_NO_LOCK);
    $articles_for_view = $coll->listDatas();
    $t->assign('articles', $articles_for_view);
    $t->assign('config', $utility->getConfigValues($login));
    // start GRB-15186
    $users_id = [];
    foreach ($articles_for_view as $article) {
        if ($article['creator_uid'] > 0) {
            $users_id[] = $article['creator_uid'];
        }
    }
    //check the using privilege
    require_once("grn/controller.csp");
    $users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
        $login, 'bulletin');
    $t->assign('users_info', $users_info);
    // end GRB-15186
}

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('bulletin');
    $page_title = cb_plain_msg('grn.bulletin', 'portlet_view',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("bulletin/portlet/view_acknowledgment.tpl");

