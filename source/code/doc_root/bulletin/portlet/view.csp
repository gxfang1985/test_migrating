<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$settings = $portlet['settings'];

$category_id = $settings['cid'];

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$bulletin =& $locator->getInstance('bulletin');

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

if (($category =& $bulletin->getCategory($login, $category_id,
        GRN_BULLETIN_ACCESS_R, false)) !== false
) {
    $rows = @ $portlet['settings']['rows'];
    if ( ! $rows) {
        $rows = 5;
    }

    require_once('bulletin/article_util.csp');
    require_once('bulletin/bean/GrnBulletinArticleCondition.csp');
    require_once('bulletin/controller.csp');

    $utility = new GRN_Bulletin_ControllerUtil();
    $order_column = $utility->getListOrderColumn('ntd', 'ntd');

    $conditionObj = new GrnBulletinArticleCondition();
    $conditionObj->setUser($login);
    $conditionObj->setCategory($category);
    $conditionObj->setLimit($rows);
    $conditionObj->addSort($order_column['column'], $order_column['order']);

    $coll = new GRN_Bulletin_ArticleList($conditionObj);
    $coll->setLockMode(CB_DATABASE_NO_LOCK);

    $articles_for_view = $coll->listDatas();
    // start GRB-15186
    $users_id = [];
    foreach ($articles_for_view as $article) {
        if ($article['creator_uid'] > 0) {
            $users_id[] = $article['creator_uid'];
        }
    }
    //check the using privilege
    require_once("grn/controller.csp");
    $users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
        $login, 'bulletin');
    $t->assign('users_info', $users_info);
    // end GRB-15186

    $t->assign('category',
        ['name' => $category->get('name'), 'cid' => $category_id]);
    $t->assign('articles', $articles_for_view);
    $t->assign('config', $utility->getConfigValues($login));
    // FAVORITE
    require_once('star/logic.csp');
    $star_logic = GRN_Star_StarLogic::getInstance();
    $use_star = $star_logic->isActive();
    $use_star = ($use_star && count($articles_for_view) > 0);
    $t->assign('use_star', $use_star);
    if ($use_star) {
        $star_infos = $star_logic->getStatusByIDs($login, 'grn.bulletin',
            array_keys($articles_for_view));
        $t->assign('star_infos', $star_infos);
    }
    // End FAVORITE
}

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('bulletin');
    $page_title = cb_plain_msg('grn.bulletin', 'portlet_view',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);
$t->assign('display_name_mode', $portlet['display_name_mode']);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("bulletin/portlet/view.tpl");


