<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    // validate after a POST
    if (@ $G_INPUT['cancel'] || (is_array($files) && count($files) == 1)) {
        if ( ! isset($G_INPUT['aid'])) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
        }
        if ( ! isset($G_INPUT['fid'])) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
        }

        $article_id = $G_INPUT['aid'];
        $file_id = $G_INPUT['fid'];

        if ( ! isset($G_INPUT['cancel'])) {
            if ( ! ($article =& $G_bulletin->getDraft($G_bulletin_login,
                $article_id))
            ) {
                require_once('bulletin/error_code.csp');
                cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
            }

            $article->access($G_bulletin_login, GRN_BULLETIN_ACCESS_W, true);

            if ( ! ($file =& $article->getFile($file_id))) {
                require_once('bulletin/error_code.csp');
                cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
            }

            $uploaded_file = array_pop($files);
            $file->update($G_bulletin_login, $uploaded_file,
                @ $G_INPUT['comment']);
        }

        cb_redirect('bulletin/draft_file_view',
            ['aid' => $article_id, 'fid' => $file_id]);

    } else {
        $target_name = 'bulletin/draft_file_upload';
        $t->assign('err_no_file', true);
        $t->setPageInfo($target_name);

        $article_id = $G_INPUT['aid'];
        $file_id = $G_INPUT['fid'];

        if ( ! ($article =& $G_bulletin->getDraft($G_bulletin_login,
            $article_id))
        ) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
        }

        $pathinfo = [
            "bulletin/index"           => null,
            "bulletin/draft_list"      => null,
            "bulletin/draft_view"      => ['aid' => $article_id],
            "bulletin/draft_file_view" => [
                'aid' => $article_id,
                'fid' => $file_id
            ],
        ];

        require_once('bulletin/controller.csp');
        $utility = new GRN_Bulletin_ControllerUtil($target_name);

        $utility->setSitePosition($t, $pathinfo);

        $t->assign('comment', @ $G_INPUT['comment']);

        $file = $article->getFile($file_id);


        // ファイルリンク用のパラメータをセット 
        $linkparams = [];

        $linkparams['aid'] = $article_id;
        $t->assign('article_id', $article_id);

        $t->assign('linkparams', $linkparams);

        // ファイルの表示データ
        $file_for_view = $utility->getFileView($file);
        $t->assign('file', $file_for_view);

        //generate upload ticket
        include('grn/_upload_prepend.csp');
        $t->assign('upload_ticket', @$G_INPUT['upload_ticket']);

        // Smarty実行
        $t->display("{$target_name}.tpl");
    }
}
