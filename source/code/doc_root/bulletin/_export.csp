<?php

global $G_INPUT;

if ( ! array_key_exists('aid', $G_INPUT) || ! $G_INPUT['aid']) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
$article_id = $G_INPUT['aid'];

if ( ! ($article = $G_bulletin->getArticle($G_bulletin_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

// GRN35-209
require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

// 出力文字コードを取得
if ( ! isset($position)) {
    $position = $utility->makeSitePosition($view_page, $page_path);
}
// GRN35-209
require_once('grn/ui.csp');
$charset = grn_ui_export_charset($G_bulletin_login, $view_page, $position);
assert('!is_null($charset)');


$category = $article->get('category');
$creator = $article->get('creator');
//
$group_name = null;
$user_group = $article->get('creator_group');
if ( ! is_null($user_group)) {
    $group_name = $user_group->get('name');
}
$article_for_view = [];
$article_for_view['group_name'] = $group_name;
$article_for_view['aid'] = $article->getOID();
$article_for_view['cid'] = $category->getOID();
$article_for_view['category_name'] = $category->get('name');
$article_for_view['title'] = $article->get('subject');
$article_for_view['data'] = $article->get('data');
$article_for_view['stime']
    = $utility->getTermStartDate($article);
$article_for_view['etime'] = $utility->getTermEndDate($article);
$article_for_view['start_is_datetime'] = $article->get('start_is_datetime');
$article_for_view['end_is_datetime'] = $article->get('end_is_datetime');
$article_for_view['creator_uid'] = $creator ? $creator->getOID() : 0;
$article_for_view['creator_name'] = $article->get('creator_name');
$article_for_view['ctime'] = $article->get('ctime');
$article_for_view['manually_enter_sender']
    = $article->get('manually_enter_sender');


// 添付ファイル

$files = $article->getFiles();

$files_for_view = [];

foreach (array_keys($files) as $fid) {
    $file = $files[$fid];
    $body = $file->getCurrentBody();
    $files_for_view[$fid] = [
        'name' => $body->get('name'),
        'mime' => $body->get('mime'),
        'size' => $body->get('size'),
        'fid'  => $fid
    ];
}

$article_for_view['attach_files'] = $files_for_view;


// フォロー

require_once('bulletin/follow_util.csp');
$coll = new GRN_Bulletin_FollowList($G_bulletin_login, $article);
$coll->addOrderColumn('_id', false);

$article_follows_for_view = [];

while ( ! is_null(($follow = $coll->iterate()))) {
    $follow_creator_uid = 0;
    $follow_creator_name = $follow->get('creator_name');

    if (($creator = $follow->get('creator'))) {
        $follow_creator_uid = $creator->getOID();
    }

    $follow_for_view = [
        'follow_id'    => $follow->getOID(),
        'creator_uid'  => $follow_creator_uid,
        'creator_name' => $follow_creator_name,
        'data'         => $follow->get('data'),
        'ctime'        => $follow->get('ctime'),
        'id'           => $follow->get('follow_id'),
    ];

    $files = $follow->getFiles();

    $files_for_view = [];

    foreach (array_keys($files) as $fid) {
        $file = $files[$fid];
        $body = $file->getCurrentBody();
        $files_for_view[$fid] = [
            'name' => $body->get('name'),
            'mime' => $body->get('mime'),
            'size' => $body->get('size'),
            'fid'  => $fid
        ];
    }

    $follow_for_view['attach_files'] = $files_for_view;

    $article_follows_for_view[$follow->getOID()] = $follow_for_view;
}

$article_for_view['follows'] = $article_follows_for_view;

$users_id = $utility->getUsersInArticle($article_for_view);
$users_info = $utility->getUserInfoToShowUserName($users_id, $G_bulletin_login);

require_once('grn/smarty.csp');
if ( ! isset($t)) {
    $t = new GRN_Smarty();
}

$t->assign('article', $article_for_view);
$t->assign('users_info', $users_info);

cb_prepare_download('notitle.txt', 'text/plain', false);

echo grn_ui_export_content($t, cb_get_pagename(), $charset);

cb_safe_exit();


