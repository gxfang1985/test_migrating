<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}
if ( ! isset($utility) || ! is_a($utility, 'GRN_Bulletin_ControllerUtil')) {
    require_once("bulletin/controller.csp");
    $utility = new GRN_Bulletin_ControllerUtil();
}

if ( ! array_key_exists('cid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}
$category_id = $G_INPUT['cid'];

if ( ! ($category = $G_bulletin->getCategory($G_bulletin_login,
    $category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

$t->assign('category_id', $category_id);


// 選択されたカテゴリの情報を取得

$category_for_view = [];
$category_for_view['cid'] = $category->getOID();
$category_for_view['name'] = $category->get('name');
$category_for_view['memo'] = $category->get('description');
$category_for_view['foreign_key'] = $category->get('foreign_key');

$utility->getCreatorView($category, $category_for_view);
$utility->getModifierView($category, $category_for_view);


// 親カテゴリ情報

if (($parent = $category->get('parent'))) {
    $parent_for_view = [];
    $parent_for_view['cid'] = $parent->getOID();
    $parent_for_view['name'] = $parent->get('name');
    $parent_for_view['child_count']
        = $parent->getNumCategories($G_bulletin_login);
    if (isset($need_prilivileges) && $need_prilivileges) {
        $parent_for_view['privileges']
            = $parent->getPrivileges($G_bulletin_login);
    }

    $category_for_view['parent'] = $parent_for_view;
}

// サブカテゴリ情報の取得

$children = $category->getCategories($G_bulletin_login);

if (count($children) > 0) {
    $child_categories_for_view = [];
    foreach (array_keys($children) as $cid) {
        $child =& $children[$cid];
        $child_for_view = [];
        $child_for_view['name'] = $child->get('name');
        $child_for_view['cid'] = $child->getOID();
        $child_for_view['child_count']
            = $child->getNumCategories($G_bulletin_login);

        $child_categories_for_view[$cid] = $child_for_view;
    }
    $category_for_view['children'] = $child_categories_for_view;
}

$category_for_view['child_count'] = count($children);
$category_for_view['deletable'] = $category->isDeletable($G_bulletin_login);

if (isset($need_prilivileges) && $need_prilivileges) {
    $category_for_view['movable'] = false;

    // 移動する権限があり、移動先もある場合に許可とする
    if ($category->isMovable($G_bulletin_login)) {
        $category_for_view['movable'] = true;
    }
}
//GRN2-4038
if (array_key_exists("foreign_key", $category_for_view)
    && $category_for_view['foreign_key'] == "ROOT_CATEGORY"
) {
    $category_for_view['creator_uid'] = 1;
    if (array_key_exists("modifier_name", $category_for_view)
        && $category_for_view['modifier_name'] == "Administrator"
    ) {
        if (array_key_exists("modifier_uid", $category_for_view)
            && $category_for_view['modifier_uid'] == 0
        ) {
            $category_for_view['modifier_uid'] = 1;
        }
    }
}
//GRN2-4038
$t->assign('category', $category_for_view);


