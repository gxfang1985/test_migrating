<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();
}

if ( ! isset($category_id)) {
    if ( ! array_key_exists('cid', $G_INPUT) || strlen($G_INPUT['cid']) < 1
         || $G_INPUT['cid'] < 1
    ) {
        $category_id = GRN_BULLETIN_ROOT_CATEGORY_ID;
    } else {
        $category_id = $G_INPUT['cid'];
    }
}

if ( ! isset($set_category_id)) {
    $set_category_id = $category_id;

    if (array_key_exists('s_cid', $G_INPUT) && strlen($G_INPUT['s_cid']) > 0) {
        $set_category_id = $G_INPUT['s_cid'];
    }
}

$t->assign('category_id', $category_id);
$t->assign('set_category_id', $set_category_id);


// セッションに保存した購読カテゴリを取得

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();

if (isset($target_name)) {
    $session =& $sm->getSession($target_name);
} else {
    $session =& $sm->getSession(cb_get_pagename());
}

if ( ! isset($session_id)) {
    $session_id = 'category_select';
}

if ( ! array_key_exists('ss', $G_INPUT) || ! $G_INPUT['ss']) {
    // 初期化

    if ( ! isset($ignore_categories)) {
        $ignore_categories = [];
    }
    if ( ! isset($candidate_categories)) {
        $candidate_categories = [];
    }
    if ( ! isset($ignore_root_category)) {
        $ignore_root_category = null;
    }
    if ( ! isset($category_privileges)) {
        $category_privileges = null;
    }


    /**
     * インクルードしているコントローラから渡されるのはIDをキーとしたオブジェクト配列
     * その配列をセッションに保存するデータへ変換する
     */

    $for_session = [];
    foreach (array_keys($ignore_categories) as $key) {
        $item =& $ignore_categories[$key];

        $for_session[$key] = [
            'cid'  => $item->getOID(),
            'name' => $item->get('name'),
        ];
    }
    $ignore_categories = $for_session;

    $for_session = [];
    foreach (array_keys($candidate_categories) as $key) {
        if (array_key_exists($key, $ignore_categories)) {
            continue;
        }

        $item =& $candidate_categories[$key];

        require_once('bulletin/functions.csp');

        $for_session[$key] = [
            'cid'  => $item->getOID(),
            'name' => $item->get('name'),
            'path' => grn_bulletin_get_category_path_string($item),
        ];
    }
    $candidate_categories = $for_session;
} else {
    $ignore_categories = $session->get($session_id . '_ignore');
    $candidate_categories = $session->get($session_id . '_candidate');
    $ignore_root_category = $session->get($session_id . '_ignore_root');
    $category_privileges = $session->get($session_id . '_privileges');

    if (is_null($ignore_categories)) {
        $ignore_categories = [];
    }
    if (is_null($candidate_categories)) {
        $candidate_categories = [];
    }
}

if (array_key_exists('text', $G_INPUT)) {
    // カテゴリ検索

    $result_for_view = [];

    if (array_key_exists('text', $G_INPUT) && strlen($G_INPUT['text']) > 0) {
        $t->assign('text', $G_INPUT['text']);

        require_once('bulletin/category.csp');
        $cm = GRN_Bulletin_CategoryManager::getInstance();

        $categories = $cm->search($G_bulletin_login, $G_INPUT['text']);

        require_once('bulletin/functions.csp');

        foreach (array_keys($categories) as $cid) {
            if (array_key_exists($cid, $ignore_categories)) {
                continue;
            }
            if (array_key_exists($cid, $candidate_categories)) {
                continue;
            }
            if ( ! is_null($ignore_root_category)
                 && $cm->isParent($categories[$cid], $ignore_root_category)
            ) {
                continue;
            }
            if (isset($category_privileges)
                && ! $categories[$cid]->privileged($G_bulletin_login,
                    $category_privileges)
            ) {
                continue;
            }

            $item =& $categories[$cid];

            $result_for_view[$cid] = [
                'name' => $item->get('name'),
                'cid'  => $cid,
                'path' => grn_bulletin_get_category_path_string($item),
            ];
        }
    }

    $t->assign('search', [
            'result' => $result_for_view,
            'count'  => count($result_for_view),
            'text'   => $G_INPUT['text'],
        ]
    );

    if (count($result_for_view) < 1) {
        $t->assign('set_category_id', null);
    }
} else {
    // 通常のカテゴリツリーからの選択画面を表示する場合

    if ( ! ($category =& $G_bulletin->getCategory($G_bulletin_login,
        $set_category_id))
    ) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }

    require_once('bulletin/hierarchy.csp');
    $hierarchy = GRN_Bulletin_Hierarchy::getInstance();

    if (isset($hierarchy_notification) && $hierarchy_notification) {
        $hierarchy->setNotificationCategories(true);
    }

    if (isset($hierarchy_subscription) && $hierarchy_subscription) {
        $hierarchy->setSubscriptionCategories(true);
    }

    if (isset($category_privileges) && count($category_privileges) > 0) {
        $hierarchy->setPrivileges($category_privileges);
    }

    $category_for_view = $hierarchy->build($G_bulletin_login, $category);

    if ($set_category_id == $ignore_root_category) {
        $category_for_view['children'] = null;
        $category_for_view['child_count'] = 0;
    } elseif (array_key_exists('children', $category_for_view)
              && is_array($category_for_view['children'])
    ) {
        foreach (array_keys($category_for_view['children']) as $cid) {
            if ($cid == $ignore_root_category) {
                unset($category_for_view['children'][$cid]);
                $category_for_view['child_count']
                    = count($category_for_view['children']);
                break;
            }
        }
    }

    // カテゴリツリー
    $t->assign('category', $category_for_view);
}

$session->set($session_id . '_ignore', $ignore_categories);
$session->set($session_id . '_candidate', $candidate_categories);
$session->set($session_id . '_ignore_root', $ignore_root_category);
$session->set($session_id . '_privileges', $category_privileges);

$t->assign('candidate_categories', $candidate_categories);

if (array_key_exists($set_category_id, $candidate_categories)) {
    $t->assign('disable_select', true);
}
if ($set_category_id == $ignore_root_category) {
    $t->assign('disable_select', true);
}
if (isset($category_privileges)) {
    if (($parent =& $category->get('parent'))) {
        if ( ! $parent->privileged($G_bulletin_login, $category_privileges)) {
            $t->assign('disable_select', true);
        }
    } else {
        $t->assign('disable_select', true);
    }
}





