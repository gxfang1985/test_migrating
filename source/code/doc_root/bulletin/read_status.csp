<?php

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

$category_id = cb_at($G_INPUT, 'cid');
$article_id = cb_at($G_INPUT, 'aid');

if ($category_id == '' || $article_id == '') {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
// limit
$limit = $G_bulletin_login_config->getListMax();
require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
$offset = $utility->getListOffset();


require_once("grn/smarty.csp");
$t = new GRN_Smarty;
$article = $G_bulletin->getArticle($G_bulletin_login, $article_id,
    GRN_BULLETIN_ACCESS_R, true, CB_DATABASE_NO_LOCK);
if ( ! $article) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
$subject = $article->get('subject');
$t->assign('message', ['subject' => $subject]);

require_once('bulletin/BulletinFacade.csp');
$dao = new BulletinFacade();
$acknowledgementUsers = $dao->getAcknowledgementList($article_id, $limit + 1,
    $offset);
$isNextPageExists = (count($acknowledgementUsers) > $limit);
if ($isNextPageExists) {
    array_pop($acknowledgementUsers);
}

//GTM-529 GRB-15046 tv Tuning
require_once("grn/controller.csp");
$users_info
    = GRN_ControllerUtil::getUserInfoToShowUserName(array_keys($acknowledgementUsers),
    $user);
$t->assign('users_info', $users_info);
//end

$user_info_for_view = [];
foreach ($acknowledgementUsers as $item) {
    $voice_for_view = [];
    $voice_for_view['uid'] = $item['_id'];
    $voice_for_view['name'] = $item['display_name'];
    $voice_for_view['position'] = $item['position'];
    if ($item['first_timestamp'] < 9999999999) {
        $ts = new CB_TimeStamp();
        $ts->unix_ts = $item['first_timestamp'];
        $tsex = new CB_TimeStampEx($ts);
        $first_timestamp = $tsex->getDateTime();
        $voice_for_view['vtime'] = $first_timestamp;
    }
    $user_info_for_view[] = $voice_for_view;
}
$user_info = $user_info_for_view;

$t->assign('user_info', $user_info);

$params = [
    "aid" => $article_id,
    "cid" => $category_id
];// not use this case
$navi_info_for_view = [];
$navi_info_for_view = $utility->makeSimpleNaviInformation($offset, $limit,
    count($user_info), $isNextPageExists,
    ['aid' => $params['aid'], 'cid' => $params['cid']]);
$t->assign('navi_info', $navi_info_for_view);

//Site possion
require_once('bulletin/category.csp');
$category_manager = new GRN_Bulletin_CategoryManager();

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();
if (isset($article_for_view['cid'])) {
    $utility->prepareMakeSitePosition($t, $article_for_view['cid']);
} elseif (cb_at($G_INPUT, 'cid')) {
    $utility->prepareMakeSitePosition($t, $G_INPUT['cid'], $article_id);
} else {
    $page_path = ['bulletin/index' => ['cid' => cb_at($G_INPUT, 'cid')]];
}
$t->assign('page_title', $article->get('subject'));
$t->assign('sub_title', grn_get_current_page_display_name());
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");
