<?php

use grn\fts\Application as FtsApplication;

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


$page_path = ["bulletin/index" => null];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $page_path);


// 一覧件数
$limit = $G_bulletin_login_config->getListMax();

// 一覧開始位置
$offset = $utility->getListOffset();

// 一覧ソート
$order_column = $utility->getListOrderColumn(null, 'stu');
$t->assign('sort', $order_column['param']);


// カテゴリツリー
require_once('bulletin/hierarchy.csp');
$hierarchy = GRN_Bulletin_Hierarchy::getInstance();
$hierarchy->setSubscriptionCategories(true);
$hierarchy->setNotificationCategories(true);

$category = $G_bulletin->getRootCategory($G_bulletin_login);
$category_for_view = $hierarchy->createNode($G_bulletin_login, $category);

//-- category tree
$tree_info = [
    'link_url' => 'bulletin/index',
    'oid_key'  => 'cid'
];
$tree_name = 'bulletin/index';
$tree_selected_oid = -1;
include('_category_tree.csp');
//--end: category tree

// 掲示待ちの一覧を取得

require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($G_bulletin_login);
$conditionObj->setOffset($offset);
$conditionObj->setLimit($limit + 1);
$conditionObj->setPersonal(true);
$conditionObj->setArticleTerm('before');
$conditionObj->addSort($order_column['column'], $order_column['order']);

$coll = new GRN_Bulletin_ArticleBeforeList($conditionObj);

$articles_for_view = [];

$articles_for_view = $coll->listDatas();
$isExistsNextPage = count($articles_for_view) > $limit;
if ($isExistsNextPage) {
    array_pop($articles_for_view);
}

// 一覧ナビゲーションのパラメータ
$navi_for_view = $utility->makeSimpleNaviInformation($offset,
    $limit,
    count($articles_for_view),
    $isExistsNextPage,
    ['sf' => 1]);

$t->assign('category', $category_for_view);
$t->assign('articles', $articles_for_view);
$t->assign('navi', $navi_for_view);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));

$delete_multi = [
    'title'        => grn_get_page_display_name('bulletin/wait_delete_multi'),
    'page'         => 'bulletin/wait_delete_multi.tpl',
    'data'         => null,
    'handler'      => ['btn_delete_multi1', 'btn_delete_multi2'],
    'multi_target' => 'eid[]',
    'form_target'  => 'bulletin/wait_list'
];
$t->assign('delete_multi', $delete_multi);
// FAVORITE
require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$use_star = $star_logic->isActive();
$t->assign('use_star', $use_star);
if ($use_star) {
    $unique_ids = array_keys($articles_for_view);
    $t->assign('star_infos',
        $star_logic->getStatusByIDs($G_bulletin_login, 'grn.bulletin',
            $unique_ids));
}
// End FAVORITE

if (FtsApplication::isAvailable()) {
    $t->assign('no_search', true);
}

$t->display(cb_get_pagename() . ".tpl");

