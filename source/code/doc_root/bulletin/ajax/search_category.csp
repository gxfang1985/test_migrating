<?php

use grn\grn\JSONResponse;

global $G_INPUT;
global $G_state_set;

$G_state_set->set("html_should_be_closed", false);
$G_state_set->set("copyright_should_be_written", false);
$G_state_set->set("error_page_type", "json");

if (strcasecmp(@ $_SERVER["REQUEST_METHOD"], "POST") === 0) {
    $keyword = cb_at($G_INPUT, "keyword");
    $login = cb_get_login_user();

    require_once("bulletin/include_search.csp");
    require_once("bulletin/bean/GrnBulletinCategoryCondition.csp");
    $search_category_condition = new GrnBulletinCategoryCondition();
    $search_category_condition->setText($keyword);
    $search_category_condition->setSensitive(false);
    $search_category_condition->setOffset(0);
    $search_category_condition->setLimit(100);

    $search = new GRN_Bulletin_CategorySearch($login,
        $search_category_condition);
    $category_list = $search->searchExecute();

    $categories_for_view = [];
    foreach ($category_list as $category_id => $category) {
        $categories_for_view[] = [
            "cid"  => $category_id,
            "name" => $category->get("name"),
            "path" => grn_bulletin_get_category_path_string($category)
        ];
    }

    $json = JSONResponse::create();
    $json->response(["category" => $categories_for_view]);
}

