<?php

use grn\fts\Application as FtsApplication;
use grn\fts\bulletin\IndexService;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // フォーム名（アップロード画面名と同一）
    assert('isset($target_name)');
    // アップロード画面パス
    assert('isset($upload_pathinfo)');

    global $G_INPUT;

    // 引数チェック
    // インクルード元で変数がセットされていればそれを優先する

    if ( ! isset($category_id)) {
        $category_id = @ $G_INPUT['cid'];
    }

    if ( ! isset($article_id)) {
        if ( ! isset($G_INPUT['aid'])) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
        }
        $article_id = $G_INPUT['aid'];
    }

    if ( ! isset($follow_id)) {
        if (isset ($G_INPUT['follow_id'])
            && strlen($G_INPUT['follow_id']) > 0
        ) {
            $follow_id = $G_INPUT['follow_id'];
        } else {
            $follow_id = null;
        }
    }

    if ( ! isset($file_id)) {
        if ( ! isset($G_INPUT['fid'])) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
        }
        $file_id = $G_INPUT['fid'];
    }

    // 掲示

    /** @var $article GRN_Bulletin_Article */
    if ( ! ($article =& $G_bulletin->getArticle($G_bulletin_login,
        $article_id))
    ) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
    }
    $article_id = $article->getOID();

    require_once('bulletin/file.csp');
    $fm = GRN_Bulletin_FileManager::getInstance();

    if (strlen($follow_id) > 0) {
        // フォロー添付の場合

        if ( ! ($follow =& $article->getFollow($follow_id))) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
        }
        /** @var $file GRN_Bulletin_File */
        if ( ! ($file =& $follow->getFile($file_id))) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
        }

        // ファイルの変更権限をチェック
        $fm->isModifiable($G_bulletin_login, $follow, $file, true);
        $follow_id = $follow->getOID();
    } else {
        /** @var $file GRN_Bulletin_File */
        if ( ! ($file =& $article->getFile($file_id))) {
            require_once('bulletin/error_code.csp');
            cb_throw_error(E_GRN_BULLETIN_FILE_NOT_FOUND);
        }

        // ファイルの変更権限をチェック
        $fm->isModifiable($G_bulletin_login, $article, $file, true);
    }

    assert('isset($file)');

    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);


    if (isset($G_INPUT['cancel'])) {
        // キャンセルの場合はロックを解除して終了

        $lock =& $file->getLockObject();
        $lock->releaseLock();

        $args = [];

        if ($category_id) {
            $args['cid'] = $category_id;
        }

        $args['aid'] = $article_id;

        if ($follow_id) {
            $args['follow_id'] = $follow_id;
        }

        $args['fid'] = $file_id;
        $upload_pathinfo_keys = array_keys($upload_pathinfo);
        $file_view = array_pop($upload_pathinfo_keys);

        cb_redirect($file_view, $args);
    }


    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if (is_array($files) && count($files) == 1) {
        // アップロード実行
        $uploaded_file = array_pop($files);

        $file->update($G_bulletin_login, $uploaded_file, @ $G_INPUT['comment']);

        if (FtsApplication::isAvailable()) {
            $category_id = $article->get('category')->getOID();
            $searchService = new IndexService();
            $searchService->updateFileIndex($file, $article_id, $category_id,
                $follow_id);
        }

        // ロック解除

        $lock =& $file->getLockObject();
        $lock->releaseLock();

        $args = [];

        if ($category_id) {
            $args['cid'] = $category_id;
        }

        $args['aid'] = $article_id;

        if ($follow_id) {
            $args['follow_id'] = $follow_id;
        }

        $args['fid'] = $file_id;

        $upload_pathinfo_keys = array_keys($upload_pathinfo);
        $file_view = array_pop($upload_pathinfo_keys);

        cb_redirect($file_view, $args);
    } else {
        // バリデーション違反、画面再表示
        $t->assign('err_no_file', true);
        $t->setPageInfo($target_name);

        require_once('bulletin/controller.csp');
        $utility = new GRN_Bulletin_ControllerUtil($target_name);

        $utility->setSitePosition($t, $upload_pathinfo);

        $t->assign('comment', @ $G_INPUT['comment']);

        // ファイルリンク用のパラメータをセット 
        $linkparams = [];

        if ($category_id) {
            $linkparams['cid'] = $category_id;
            $t->assign('category_id', $category_id);
        }
        if ($article_id) {
            $linkparams['aid'] = $article_id;
            $t->assign('article_id', $article_id);
        }
        if ($follow_id) {
            $linkparams['follow_id'] = $follow_id;
            $t->assign('follow_id', $follow_id);
        }

        $t->assign('linkparams', $linkparams);

        // ファイルの表示データ
        $file_for_view = $utility->getFileView($file);
        $t->assign('file', $file_for_view);

        //generate upload ticket
        include('grn/_upload_prepend.csp');
        $t->assign('upload_ticket', @$G_INPUT['upload_ticket']);

        // Smarty実行
        $t->display("{$target_name}.tpl");
    }
}
