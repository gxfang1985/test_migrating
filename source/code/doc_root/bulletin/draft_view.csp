<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if ( ! array_key_exists('aid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
}

$draft_id = $G_INPUT['aid'];


// site position
$page_path = [
    "bulletin/index"      => null,
    "bulletin/draft_list" => null,
];

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

$utility->setSitePosition($t, $page_path);


if ( ! ($draft =& $G_bulletin->getDraft($G_bulletin_login, $draft_id))) {
    cb_throw_error(E_GRN_BULLETIN_DRAFT_NOT_FOUND);
}

$draft_for_view = $utility->getArticleView($G_bulletin_login, $draft, false);


// 前後へのナビゲーション
$list_utility = new GRN_Bulletin_ControllerUtil('bulletin/draft_list');
$navi_for_view = $list_utility->getNeighborsView($G_bulletin_login, $draft,
    'mtd');


$t->assign('article', $draft_for_view);
$t->assign('navi', $navi_for_view);
$t->assign('config', $utility->getConfigValues($G_bulletin_login));
if (isset($draft_for_view['title'])) {
    $t->assign('page_title', $draft_for_view['title']);
}

$delete_info = [
    'title'   => grn_get_page_display_name('bulletin/draft_delete'),
    'page'    => 'bulletin/draft_delete.tpl',
    'handler' => 'lnk_delete',
    'data'    => [
        'article' => [
            'aid'   => $draft_for_view['aid'],
            'title' => $draft_for_view['title']
        ]
    ]
];
$t->assign('delete_info', $delete_info);

// FAVORITE
require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$use_star = $star_logic->isActive();
$t->assign('use_star', $use_star);
if ($use_star) {
    $unique_id = 'draft_' . $draft_id;
    $t->assign('star_infos',
        $star_logic->getStatusByIDs($G_bulletin_login, 'grn.bulletin',
            [$unique_id]));
}
// End FAVORITE

$t->display(cb_get_pagename() . ".tpl");

