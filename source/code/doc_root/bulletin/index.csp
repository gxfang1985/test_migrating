<?php

use grn\fts\Application as FtsApplication;

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

require_once('bulletin/controller.csp');
$utility = new GRN_Bulletin_ControllerUtil();

// site position
$utility->setSitePosition($t, null);

// 一覧表示件数
$limit = $G_bulletin_login_config->getListMax();

// 一覧開始位置
$offset = $utility->getListOffset();

// 一覧ソート
$order_column = $utility->getListOrderColumn(null, 'ntd');
$t->assign('sort', $order_column['param']);


// カテゴリID
$category_id = null;
if (array_key_exists('cid', $G_INPUT)
    && $G_INPUT['cid'] != GRN_BULLETIN_ROOT_CATEGORY_ID
) {
    $category_id = $G_INPUT['cid'];
}

// --- category tree
if ( ! ($root_category = $G_bulletin->getCategory($G_bulletin_login, 1))) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

require_once('bulletin/notification.csp');
$notify_man = GRN_Bulletin_NotificationManager::getInstance();

$root_subcribled = $notify_man->isNotified($G_bulletin_login, $root_category)
                   || $notify_man->isSubscribed($G_bulletin_login,
        $root_category);
$tree_info = [
    'link_url'        => 'bulletin/index',
    'oid_key'         => 'cid',
    'root_subcribled' => $root_subcribled
];

$tree_selected_oid = $category_id;

include('_category_tree.csp');

if ($tree_selected_oid == -1) {
    cb_redirect('bulletin/wait_list');
}
if ($tree_selected_oid == -2) {
    cb_redirect('bulletin/draft_list');
}
$category_id = $tree_selected_oid;
// --- end: category tree

// デフォルトでルートにセット
if (is_null($category_id) || strlen($category_id) < 1 || $category_id < 1) {
    $category_id = 1;
}
$t->assign('category_id', $category_id);


if ( ! ($category = $G_bulletin->getCategory($G_bulletin_login,
    $category_id))
) {
    cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
}

require_once('bulletin/hierarchy.csp');
$hierarchy = GRN_Bulletin_Hierarchy::getInstance();
$hierarchy->setSubscriptionCategories(true);
$hierarchy->setNotificationCategories(true);
$hierarchy->setPrivileges(true);

$category_for_view = $hierarchy->buildUsingTree($G_bulletin_login, $category,
    $tree);

// 記事の一覧を取得
require_once('bulletin/article_util.csp');
require_once('bulletin/bean/GrnBulletinArticleCondition.csp');

$conditionObj = new GrnBulletinArticleCondition();
$conditionObj->setUser($G_bulletin_login);
$conditionObj->setCategory($category);
$conditionObj->setOffset($offset);
$conditionObj->setLimit($limit + 1);
$conditionObj->addSort($order_column['column'], $order_column['order']);

$articleListManagerObj = new GRN_Bulletin_ArticleList($conditionObj);
$articleListManagerObj->setLockMode(CB_DATABASE_NO_LOCK);

$articleList = $articleListManagerObj->listDatas();
$isExistsNextPage = count($articleList) > $limit;
if ($isExistsNextPage) {
    array_pop($articleList);
}

$articles_for_view = [];
$articles_for_view['article'] = [];
if (count($articleList) > 0) {
    $articles_for_view['article'] = $articleList;
}

$users_id = [];
foreach ($articles_for_view['article'] as $article) {
    $users_id[] = $article['creator_uid'];
}

$users_info = $utility->getUserInfoToShowUserName($users_id, $G_bulletin_login);

$t->assign('category', $category_for_view);
$t->assign('articles', $articles_for_view);
$t->assign('users_info', $users_info);

$system_config = $G_bulletin->getSystemConfig($G_bulletin_login);
$t->assign('show_members_dialog',
    $system_config->getEnableConfirmAuthorityReadAndNotificationUsers());

// 一覧ナビゲーションのパラメータ

$navi_info = $utility->makeSimpleNaviInformation($offset, $limit,
    count($articleList), $isExistsNextPage, ['cid' => $category_id, 'sf' => 1]);

// 一覧ナビゲーション
$t->assign('navi', $navi_info);
// 表示設定
$t->assign('config', $utility->getConfigValues($G_bulletin_login));

// FAVORITE
require_once('star/logic.csp');
$star_logic = GRN_Star_StarLogic::getInstance();
$use_star = $star_logic->isActive();
$t->assign('use_star', $use_star);
if ($use_star) {
    $unique_ids = array_keys($articles_for_view['article']);
    $star_infos = $star_logic->getStatusByIDs($G_bulletin_login, 'grn.bulletin',
        $unique_ids);
    $t->assign('star_infos', $star_infos);
}

if (FtsApplication::isViewable()) {
    $t->assign('use_fts', true);
}

$t->display(cb_get_pagename() . ".tpl");


