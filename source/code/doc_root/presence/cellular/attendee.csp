<?php

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

require_once('SmartyValidate.class.php');
SmartyValidate::connect($smarty);
$form_name = 'presence/cellular/attendee';
SmartyValidate::register_form($form_name, true);

$smarty->assign('form_name', $form_name);
// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

//--------------------------------------------------------------

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

$login =& $uum->getLoginUser();

$smarty->assign('str', isset($G_INPUT['str']) ? $G_INPUT['str'] : '');

// 在席情報を取得する
//get Presence
require_once('presence/logic.csp');
$presence_logic = GRN_Presence_Logic::getInstance();
//get presence info
$presence_info = $presence_logic->getPresence($login->getOID());
$smarty->assign('attendee', $presence_info);

// 在席情報の項目を取得/生成する
//get status combobox
require_once('presence/config.csp');
$config_manager = GRN_Presence_ConfigManager::getInstance();
$options = $config_manager->getStatusCombobox($login);

// status available
if ($presence_info['status']) {
    $status_input = $presence_info['mode'] . ':' . $presence_info['status'];
    foreach (array_keys($options) as $key) {
        if ($options[$key]['value'] === $status_input) {
            $options[$key]['selected'] = true;
            break;
        }
    }
} else // no status
{
    // no memo
    if ( ! trim($presence_info['memo'])) {
        $options[0]['selected'] = true; // show At desk default
    } else // only memo
    {
        foreach (array_keys($options) as $key) {
            if ($options[$key]['value'] === '') {
                $options[$key]['selected'] = true;
                break;
            }
        }
    }
}

$smarty->assign('options', $options);

//--------------------------------------------------------------
$smarty->display(cb_get_pagename() . '.tpl');


