<?php
// check show page
require_once('presence/config.csp');
$config_manager = GRN_Presence_ConfigManager::getInstance();
$system_config =& $config_manager->getSystemConfig();
if ( ! $system_config->getShowProxySettingsMenu()) {
    require_once('presence/error_code.csp');
    cb_throw_error(E_GRN_PRESENCE_PROXY_SETTINGS_DISABLED);
}

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();
$t->assign('uid', $login->getOID());

// access information
require_once('presence/access_logic.csp');
$sal = GRN_Presence_Access_Logic::getInstance();

// force to security model GRANT
$sal->setSecurityModel($login, 'grant');

// for view
$access_user_view = [];
$access_group_view = [];

// get access user
$access_user = $sal->getAccesses($login);
foreach ($access_user as $ac) {
    if ($ac['type'] === 'user') {
        $access_user_view[] = $ac;
    } elseif ($ac['type'] === 'group') {
        $access_group_view[] = $ac;
    }
}

// get access of groups contains user.
$groups = $uum->getUserGroupsInfo($login->getOID());
foreach ($groups as $group) {
    $obj_group =& $uum->getGroup($group['_id']);
    $access_group = $sal->getAccesses($obj_group);
    foreach ($access_group as $ac) {
        if ($ac['type'] === 'user') {
            $access_user_view[] = $ac;
        } elseif ($ac['type'] === 'group') {
            $access_group_view[] = $ac;
        }
    }
}

// get selected users
$selected_users = [];
// group
foreach ($access_group_view as $group) {
    $group_id = $group['tid'];
    $group_info = $uum->getGroupInfo($group_id);
    $selected_users['g' . $group_id] = '[' . $group_info['col_name'] . ']';
}
// user
$users_id = array_map(function ($user) {
    return $user['tid'];
}, $access_user_view);
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id, $login);
foreach ($access_user_view as $user) {
    $selected_users[$user['tid']]
        = GRN_ControllerUtil::getUserNameText($login->getOID(), $user['tid'],
        $users_info);
}

$t->assign('selected_users', $selected_users);

// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('presence/personal/agent_set');
$t->assign('page_title', $page_title);
$t->assign('site_position', [['page' => "", 'name' => $page_title]]);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


