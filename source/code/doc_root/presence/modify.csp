<?php
//check exist of user
$uid = array_key_exists('uid', $G_INPUT) ? $G_INPUT['uid'] : '';
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$presence_user =& $uum->getUser($uid, false);
//check access modify authority
require_once('presence/logic.csp');
$presence_logic = GRN_Presence_Logic::getInstance();
$presence_logic->checkAccessModify($uid);
//Smarty
require_once('grn/smarty.csp');
$t = new GRN_Smarty;
$t->assign('uid', $uid);

//get presence info
$presence_info = $presence_logic->getPresence($uid);

//get status combobox
require_once('presence/config.csp');
$config_manager = GRN_Presence_ConfigManager::getInstance();
$options = $config_manager->getStatusCombobox($presence_user);

// status available
if ($presence_info['status']) {
    $status_input = $presence_info['mode'] . ':' . $presence_info['status'];
    foreach (array_keys($options) as $key) {
        if ($options[$key]['value'] === $status_input) {
            $options[$key]['selected'] = true;
            break;
        }
    }
} else // no status
{
    // no memo
    if ( ! trim($presence_info['memo'])) {
        $options[0]['selected'] = true; // show At desk default
    } else // only memo
    {
        foreach (array_keys($options) as $key) {
            if ($options[$key]['value'] === '') {
                $options[$key]['selected'] = true;
                break;
            }
        }
    }
}

$t->assign('options', $options);
$t->assign('memo', $presence_info['memo']);

// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('presence/modify');
$t->assign('page_title', $page_title);
// get previous page
$previous_page_info = $presence_logic->getPreviousPage();
$site_position = [
    $previous_page_info,
    ['page' => '', 'name' => $page_title]
];
$t->assign('site_position', $site_position);
// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');
