<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

//check Address active
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$disable_address = $locator->isActive('address') ? false : true;
$t->assign('disable_address', $disable_address);

//get Presence
require_once('presence/logic.csp');
$presence_logic = GRN_Presence_Logic::getInstance();

require_once('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form('view_attendee', true);

//--------------------------------------------------------------
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

//get presence info
$presence_info = $presence_logic->getPresence($login->getOID());
$t->assign('presence', $presence_info);

//get status combobox
require_once('presence/config.csp');
$config_manager = GRN_Presence_ConfigManager::getInstance();
$options = $config_manager->getStatusCombobox($login);

// status available
if ($presence_info['status']) {
    $status_input = $presence_info['mode'] . ':' . $presence_info['status'];
    foreach (array_keys($options) as $key) {
        if ($options[$key]['value'] === $status_input) {
            $options[$key]['selected'] = true;
            break;
        }
    }
} else // no status
{
    // no memo
    if ( ! trim($presence_info['memo'])) {
        $options[0]['selected'] = true; // show At desk default
    } else // only memo
    {
        foreach (array_keys($options) as $key) {
            if ($options[$key]['value'] === '') {
                $options[$key]['selected'] = true;
                break;
            }
        }
    }
}

$t->assign('options', $options);

if ($portlet['title'] === '') {
    $page_title = cb_plain_msg('grn.presence', 'view_attendee');
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

$t->skipWarning();
$t->display('presence/portlet/view_attendee.tpl');


