<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
$oid = @ $G_INPUT['oid'];
$uid = @ $G_INPUT['uid'];

// アクセスを制御する対象を取得する
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
if (0 < strlen($uid)) {
    $object =& $uum->getUser($uid);
    if ( ! $object) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }
} elseif (0 < strlen($oid)) {
    $object =& $uum->getGroup($oid);
    if ( ! $object) {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }
} else {
    cb_throw_error(E_GRN_PRESENCE_ACCESS_NOT_SELECT_OBJECT);
}

$session_name = 'presence.system.access_add';
$ous_params = ['oid' => $oid, 'uid' => $uid];
$can_select_role = false;
$search_login_name = true;
require_once('grn/org_user_role_select.csp');
$t->assign('ous_params', $ous_params);

$t->assign('listbox_size', $navigation_info['navi']['number_on_page'] + 1);

// tree link page
$t->assign('link_page', cb_get_pagename());

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$site_position = [
    [
        'page' => 'presence/system/access_index',
        'name' => grn_get_page_display_name('presence/system/access_index'),
        'oid'  => $oid,
        'sf'   => '1'
    ],
    [
        'page'  => 'presence/system/access_list',
        'name'  => grn_get_page_display_name('presence/system/access_list'),
        'oid'   => $oid,
        'uid'   => $uid,
        'reset' => 1
    ],
    ['page' => '', 'name' => $page_title],
];
$t->assign('site_position', $site_position);

// （ビューで表示するための）権限情報一覧を取得する
$authority_types = null;
$t->assign('authority_types', $authority_types);
$t->assign('authority_count', count($authority_types));

//Get Security Model
require_once('presence/access_logic.csp');
$access_manager = GRN_Presence_Access_Logic::getInstance();
// force to security model GRANT
$access_manager->setSecurityModel($object, 'grant');
$security_model = $access_manager->getSecurityModel($object);
$t->assign('is_grant', $security_model == 'grant');

// （GRANTの）権限一覧を取得する
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession('presence.system.access_list');
$authorities = $session->get('authorities');
if (array_key_exists('reset', $G_INPUT) || ! is_array($authorities)) {
    $authorities = ['modify' => 1];
}

$t->assign('authorities', $authorities);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

