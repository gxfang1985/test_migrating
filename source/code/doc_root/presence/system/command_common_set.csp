<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // log
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $logger = $lm->getLogger('grn.presence');

    // get config
    require_once('presence/config.csp');
    $config_manager = GRN_Presence_ConfigManager::getInstance();
    $system_config = $config_manager->getSystemConfig();

    // auto change presence info
    $auto_set_presence = array_key_exists('auto_set_presence', $G_INPUT)
        ? $G_INPUT['auto_set_presence'] : 0;
    $auto_set_absence = array_key_exists('auto_set_absence', $G_INPUT)
        ? $G_INPUT['auto_set_absence'] : 0;
    $system_config->setAutoChangePresenceInfo([
        'auto_set_presence' => $auto_set_presence,
        'auto_set_absence'  => $auto_set_absence
    ]);
    $auto_change_log_param = [
        'auto_set_presence' => $auto_set_presence ? 'ON' : 'OFF',
        'auto_set_absence'  => $auto_set_absence ? 'ON' : 'OFF'
    ];
    $logger->noticeEx('config', 'common', $auto_change_log_param);

    // show agent modify menu
    $show_proxy_settings_menu = array_key_exists('show_proxy_settings_menu',
        $G_INPUT) ? $G_INPUT['show_proxy_settings_menu'] : 0;
    $system_config->setShowProxySettingsMenu($show_proxy_settings_menu);

    $show_proxy_settings_menu_param
        = [
        'personal_proxy_setting' => $show_proxy_settings_menu ? 'ON' : 'OFF'
    ];
    $logger->noticeEx('config', 'common', $show_proxy_settings_menu_param);

    cb_redirect('system/application_list', ['app_id' => 'presence']);
}
