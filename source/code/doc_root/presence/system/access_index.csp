<?php

//-- instantiate Smarty object
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

//-- get parameters from URL parameters
$org_id = @ $G_INPUT['oid'];        // organization id

//-- prepare uum and uum_util
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

$page_name = cb_get_pagename();

//-- prepare presence access logic
require_once('presence/access_logic.csp');
$al = GRN_Presence_Access_Logic::getInstance();

//-- initialize organization tree view
require_once('grn/org_tree.csp');
$util = GRN_OrgTreeUtil::getInstance();
$tree =& $util->getTree($page_name);
if (is_null($org_id)) {
    $org_id = $tree->getSelectedNode();
}

if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
    $tree->initialize();
    $org_id = null;
}

$tree->setSelectedNode($org_id);
$util->setTree($page_name, $tree);
$org = $tree->getRoot();

$t->assign('org', $org);
$t->assign('async_page', 'presence/org_json');
$t->assign('link_page', 'presence/system/access_index');
//--

require_once('grn/org_access_util.csp');
$navi_params = ['oid' => $org_id];
$info =& grn_get_org_access_info(null, $org_id, $navi_params, $al);


require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession('presence.system.access_list');
$session->unset_by('authorities');

//-- set variables for view
$t->assign('org_id', $org_id);
$t->assign('info', $info);

$t->assign('is_nogroups', 0 > $org_id);
$t->assign('is_root', ! $org_id);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$site_position = [
    ['page' => '', 'name' => $page_title],
];
$t->assign('site_position', $site_position);

$t->assign('page_name', $page_name);

if (@$G_INPUT['top']) {
    $t->assign('top', 1);
}

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

