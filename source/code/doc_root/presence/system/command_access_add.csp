<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    unset($G_INPUT['add']);

    require_once('_access_util.csp');

    $aid = null;
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();

    $session_name = 'presence.system.access_add';
    $session =& $session_manager->getSession($session_name);

    $aid = $session->get('target_ids');

    //$aid = @ $G_INPUT['aid'];
    $func = @ $G_INPUT['func'];
    if ( ! is_array($aid) || $func == 'search') {
        unset($G_INPUT['aid']);
        unset($G_INPUT['func']);
        unset($G_INPUT['authority_modify']);
        cb_redirect('presence/system/access_list', $G_INPUT);
    }

    // access object
    $object =& grn_get_presence_access_object($org_id, $user_id);

    require_once('presence/access_logic.csp');
    $sal = GRN_Presence_Access_Logic::getInstance();
    //$security_model = $sal->getSecurityModel( $object );
    $authorities = [];
    //grant
    $authorities = ['browse' => 1, 'modify' => 1];
    $authorities_type = null;
    $security_model = null;

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session
        =& $session_manager->getSession('presence.system.access_list');
    $session->set('authorities', $authorities);

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');

    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $dynamic_roles = $uum_util->listDynamicRoles();

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l =& $lm->getLogger('grn.presence');
    if (is_a($object, 'CB_User')) {
        $object_id_type = 'uid';
        $object_name = $object->get('display_name');
    } elseif (is_a($object, 'CB_Group')) {
        $object_id_type = 'oid';
        $object_name = $object->get('name');
    }
    $agent_uids = [];
    $agent_oids = [];
    foreach (array_keys($aid) as $item) {
        $ids = explode(':', $item);
        if (count($ids) < 2) {
            continue;
        }
        $id = $ids[1];
        switch ($ids[0]) {
            case 'user':
                if (($target = &$uum->getUser($id))) {
                    $sal->setAccess($object, GRN_PRESENCE_TARGET_TYPE_USER, $id,
                        $authorities);
                    $agent_uids[] = $id;
                }
                break;

            case 'group':
                if (($target = &$uum->getGroup($id))) {
                    $sal->setAccess($object, GRN_PRESENCE_TARGET_TYPE_GROUP,
                        $id, $authorities);
                    $agent_oids[] = $id;
                }
                break;
        }
    }

    $log_params = [
        $object_id_type => $object->getOID(),
        'agent_uid'     => implode(',', $agent_uids),
        'agent_oid'     => implode(',', $agent_oids)
    ];
    $l->noticeEx('add', 'agent_modify', $log_params);

    $params = $G_INPUT;
    unset($params['aid']);
    unset($params['func']);
    unset($params['authority_modify']);
    cb_redirect('presence/system/access_list', $params);
}


