<?php

use grn\grn\JSONResponse;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;
    $json = JSONResponse::create();

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Get Session Key
    require_once('workflow/controller_util.csp');
    require_once('grn/controller.csp');
    $tmp_key = grn_get_temporary_key();

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/send_form_draft_proxy';
    $session_target = $target_name . $tmp_key;
    SmartyValidate::register_form($session_target);

    //Skip form validation if no required item exists
    $skip_validation_flag = false;
    if (array_key_exists('SmartyValidate', $_SESSION)
        && array_key_exists($session_target, $_SESSION['SmartyValidate'])
        && array_key_exists('validators',
            $_SESSION['SmartyValidate'][$session_target])
        && ! count($_SESSION['SmartyValidate'][$session_target]['validators'])
    ) {
        $skip_validation_flag = true;
    }

    //Get Parameter
    $folder_id = @ $G_INPUT['fid'];  //Folder ID
    $petition_id = @ $G_INPUT['pid'];  //Petition ID
    $mode = @ $G_INPUT['mode']; //Mode
    $command = @ $G_INPUT['cmd'];  //Command
    $simple = @ $G_INPUT['simple'];
    $sf = @ $G_INPUT['sf'];

    //Create Parameter Translation Map for Petition
    $translation_map_petition = [
        'ptid'       => '_id',        //Petition ID
        'user'       => 'user',       //User
        'status'     => 'status',     //Status
        'agent_user' => 'agent_user', //Agent User
        'form'       => 'form'
    ];

    $petition_util = GRN_Workflow_Petition_Controller_Utility::getInstance();
    $petition = $petition_util->getView($petition_id,
        $translation_map_petition);

    //Check Petition Owner
    global $G_workflow_login_user;
    if ($petition['user'] != $G_workflow_login_user->getOID()
        && $petition['agent_user'] != $G_workflow_login_user->getOID()
    ) {
        //Petition Not Found
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_PETITION_NOT_FOUND);
    }

    //Check Command Parameter
    switch ($command) {
        case 'cancel':
            grn_workflow_cleanup_session($t, 'draft_proxy', $tmp_key);
            //Redirect Back Page
            if (defined('AJAX_REQUEST')) {
                $json->response([
                    'link' => cb_get_full_url('workflow/view', [
                        'fid'    => $folder_id,
                        'pid'    => $petition_id,
                        'simple' => $simple
                    ])
                ]);
                cb_safe_exit();
            }
            cb_redirect('workflow/view', [
                'fid'    => $folder_id,
                'pid'    => $petition_id,
                'simple' => $simple
            ]);
            break;
        default:
            break;
    }

    //Get Session
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession($session_target);

    //Update Form and Item List
    $send_form_data_list = [];
    require_once('workflow/item_resources.csp');
    $form =& $session->get('form');
    if ( ! is_array($form) || 0 == count($form)) {
        // フォームがない
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_DENY_REQUEST_DATA);
    }

    $item_list =& $session->get('item_list');
    foreach (array_keys($item_list) as $item_id) {
        $item_util
            =& grn_workflow_get_item_util($item_list[$item_id]['foreign_key']);
        if ($item_util) {
            $parsed_input_data = $item_util->parseItemData($G_INPUT,
                'item', $item_list[$item_id]);
            $send_form_data_list[$item_id] = $parsed_input_data;

            if ($item_list[$item_id]['type'] == 1) {
                if (0 == strlen($parsed_input_data)) {
                    $parsed_input_data = cb_msg(GRN_WORKFLOW_MODULE_ID,
                        'untitled');
                }
                $form['subject'] = $parsed_input_data;
            }
        }
    }

    //Priority
    $petition_properties =& $session->get('properties');
    $priority = $G_INPUT['priority'];
    $petition_properties['priority'] = $priority;

    $session->set('form', $form);
    $session->set('item_list', $item_list);
    $session->set('send_form_data_list', $send_form_data_list);
    $session->set('properties', $petition_properties);

    //Check Command Parameter
    if ($command == 'save') {
        require_once('command_send_draft_draft_proxy.csp');
    }

    //Validate After POST
    if ($skip_validation_flag
        || SmartyValidate::is_valid($G_INPUT, $session_target)
    ) {
        //Create Parameter Translation Map
        $translation_map = [
            'fid'    => '_fid',
            'pid'    => '_pid',
            'cmd'    => 'cmd',
            'mode'   => 'mode',
            'simple' => 'simple',
        ];

        //Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }

        $form_id = $petition['form'];
        require_once('workflow/controller_util.csp');
        $grn_controller = new GRN_Workflow_ControllerUtil();
        $pop_up_check = $grn_controller->checkScheduleRegister($form_id,
            $session_target, $petition['agent_user']);
        $response
            = [
            'link' => cb_get_full_url('workflow/send_path_draft_proxy', [
                'fid'     => $properties['_fid'],
                'pid'     => $properties['_pid'],
                'mode'    => $properties['mode'],
                'simple'  => $properties['simple'],
                'sf'      => $sf,
                'tmp_key' => $tmp_key
            ])
        ];
        if ($pop_up_check) {
            $response['success_do'] = "pop_up";
        }
        //Redirect Next Page
        if (defined('AJAX_REQUEST')) {
            $json->response($response);
            cb_safe_exit();
        }
        cb_redirect('workflow/send_path_draft_proxy', [
            'fid'     => $properties['_fid'],
            'pid'     => $properties['_pid'],
            'mode'    => $properties['mode'],
            'simple'  => $properties['simple'],
            'sf'      => $sf,
            'tmp_key' => $tmp_key
        ]);
    } else {
        if (defined('AJAX_REQUEST')) {
            header(CB_ERROR_HEADER . 'error_validation');
            $json->response([
                'validation'    => false,
                'error_message' => $t->fetch('grn/show_validation_errors.tpl')
            ]);
            cb_safe_exit();
        }
    }
}


