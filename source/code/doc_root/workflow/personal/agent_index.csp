<?php

require_once('workflow/error_code.csp');

//-- instantiate Smarty object
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

//-- prepare uum and uum_util
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login_user =& $uum->getLoginUser();
if ( ! is_object($login_user) || ! is_a($login_user, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
$login_id = $login_user->getOID();

require_once('workflow/config.csp');
$logic = GRN_Workflow_Configs::getInstance();
$logic =& $logic->getSystemConfig();

// 個人の代理人設定の許可
$personal_agent_setting = $logic->getPersonalAgentSetting();
if ( ! $personal_agent_setting) {
    cb_throw_error(E_GRN_WRKF_AGENT_PERSONAL_SETTING_NOTUSE);
}

// 代理申請の許可
$substitute_application = $logic->getSubstituteApplication();
// 代理承認の許可
$substitute_approval = $logic->getSubstituteApproval();

$t->assign('substitute_application', $substitute_application);
$t->assign('substitute_approval', $substitute_approval);

$agents = $logic->getAgent($login_id);
if ( ! is_array($agents)) {
    cb_throw_error(E_GRN_WRKF_AGENT_NOT_FOUND);
}

$agent_list_info = [];
$agent_list_info[GRN_WORKFLOW_AGENT_TYPE_PETITION] = null;
$agent_list_info[GRN_WORKFLOW_AGENT_TYPE_APPROVAL] = null;
if (is_array($agents)) {
    foreach ($agents as $agent) {
        $agent_info = [];
        $agent_uid = $agent['agent'];
        $agent_type = $agent['agent_type'];
        $user_info = $uum->getUserInfo($agent_uid);
        if ($user_info != false) {
            $agent_info['uid'] = $agent_uid;
            $agent_info['display_name']
                = GRN_ControllerUtil::getUserNameText($login_user->getOID(),
                $agent_uid);
            $agent_list_info[$agent_type][$agent_uid] = $agent_info;
        }
    }
} else {
    $agent_user_info[GRN_WORKFLOW_AGENT_TYPE_PETITION] = null;
    $agent_user_info[GRN_WORKFLOW_AGENT_TYPE_APPROVAL] = null;
}
$t->assign('agent_list', $agent_list_info);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$site_position = [
    ['page' => '', 'name' => $page_title],
];
$t->assign('site_position', $site_position);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');


