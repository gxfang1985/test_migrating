<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    $forward_email = @$G_INPUT['forward_email'];
    $forward_user_email = @$G_INPUT['forward_user_email'];
    $other_email_address = @$G_INPUT['other_email_address'];

    // personal config
    require_once('workflow/config.csp');
    $personal_configs = GRN_Workflow_Configs::getInstance();
    $personal_config = $personal_configs->getPersonalConfig($login->getOID());

    $personal_config->setForwardEmail($forward_email);
    $personal_config->setForwardUserEmail($forward_user_email);
    if ( ! $forward_user_email) {
        $personal_config->setOtherEmailAddress($other_email_address);
    }

    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Config_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'mail_forward';
        $args = [];
        if ($forward_email) {
            $args['forward'] = 'ON';
            if ($forward_user_email) {
                $args['email'] = $login->get('email_address');
            } else {
                $args['email'] = $other_email_address;
            }
        } else {
            $args['forward'] = 'OFF';
        }

        // write log
        $inspection->record($message_type, $args);
    }

    cb_redirect('personal/application_list', ['app_id' => 'workflow']);
}

