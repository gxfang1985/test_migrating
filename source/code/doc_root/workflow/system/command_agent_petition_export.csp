<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // Get Parameters
    $charset = @ $G_INPUT['charset'];
    $item_name = @ $G_INPUT['item_name'];

    // Get Default Charactor Set
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    // Create Tmporary File
    $tempdir = cb_tmpdir();
    $temp_filename = tempnam($tempdir, 'wf_');

    // Get CSV Writer
    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    // Execute to Write
    require_once('workflow/agent_logic.csp');
    $agent_logic = GRN_Workflow_Agent_Logic::getInstance();

    // Write Item Name
    if ($item_name) {
        $agent_logic->export_item_name($csv, GRN_WORKFLOW_AGENT_TYPE_PETITION);
    }

    // Write agent Information
    $agent_logic->export($csv, GRN_WORKFLOW_AGENT_TYPE_PETITION);

    // Close CSV Writer
    $csv->close();

    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Agent_Inspection::getInstance();
    // 監査する
    if ($inspection->isEnabled()) {
        $message_type = 'agent_petition_export';
        //Record Inspection
        $inspection->record($message_type, []);
    }

    // DownLoad CSV File
    cb_prepare_download('workflow_access.csv', 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    $fsize = filesize($temp_filename);
    if ($fsize > 0) {
        echo fread($fp, $fsize);
    }
    fclose($fp);

    // Remove Temporary File
    unlink($temp_filename);
}

