<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;;

    if ( ! @$G_INPUT['file_id']) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $file_id = $G_INPUT['file_id'];

    require_once('fw/session_manager.csp');

    $session_manager = CB_SessionManager::getInstance();
    $session
        =& $session_manager->getSession('workflow/system/access_import1');
    $files = $session->getFiles('import_files');

    if ( ! array_key_exists($file_id, $files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $charset = @$G_INPUT['charset'];
    $skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;

    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    require_once('fw/csv.csp');
    $csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

    // 先頭行をスキップ
    for ($i = 0; $i < $skip; ++$i) {
        $csv->readLine();
    }

    //監査
    $inspection_foreign_key = [];
    $inspection_access_item = [];
    $inspection_access_value = [];
    $inspection_target_name = [];

    $csv_columns = [
        GRN_WORKFLOW_CSV_READ_ACCESS_FOREIGN_KEY
        ,
        GRN_WORKFLOW_CSV_READ_ACCESS_ITEM
        ,
        GRN_WORKFLOW_CSV_READ_ACCESS_VALUE
        ,
        GRN_WORKFLOW_CSV_READ_ACCESS_TARGET_NAME
    ];
    $csv_columns_num = count($csv_columns);

    // アクセス権を読み込む
    require_once('workflow/access_logic.csp');
    $am = GRN_Workflow_Category_Access_Logic::getInstance();
    while (($line = $csv->readLine()) !== false) {
        $am->import($line);

        //監査
        if (count($line) >= ($csv_columns_num - 1)) {
            $inspection_foreign_key[]
                = $line[GRN_WORKFLOW_CSV_READ_ACCESS_FOREIGN_KEY];
            $inspection_access_item[]
                = strtolower($line[GRN_WORKFLOW_CSV_READ_ACCESS_ITEM]);
            $inspection_access_value[]
                = $line[GRN_WORKFLOW_CSV_READ_ACCESS_VALUE];

            $csv_target_name = null;
            if (count($line) === $csv_columns_num) {
                $inspection_target_name[]
                    = $line[GRN_WORKFLOW_CSV_READ_ACCESS_TARGET_NAME];
            } else {
                $inspection_target_name[] = null;
            }
        }
    }

    $csv->close();

    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Category_Accesses_Inspection::getInstance();
    // 監査する
    if ($inspection->isEnabled()) {
        $message_type = 'category_accesses_import';

        $message_args['foreign_key'] = $inspection_foreign_key;
        $message_args['item'] = $inspection_access_item;
        $message_args['value'] = $inspection_access_value;
        $message_args['name'] = $inspection_target_name;

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }

    foreach (array_keys($files) as $id) {
        $session->unsetFile('import_files', $id);
    }

    cb_redirect('workflow/system/import_index');
}

