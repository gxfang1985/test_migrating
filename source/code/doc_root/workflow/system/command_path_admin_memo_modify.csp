<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    $page_name = 'workflow/system/path_admin_memo_modify';

    $path_id = null;
    if (array_key_exists('pid', $G_INPUT)) {
        $path_id = $G_INPUT['pid'];
    }

// TODO: 運用管理はここでアクセス権をチェック

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();

    require_once('workflow/path.csp');
    $logic = GRN_Workflow_Paths::getInstance();
    $properties = [
        'col_admin_memo'           => $G_INPUT['col_admin_memo'],
        'col_modifier'             => $login->getOID(),
        'col_modifier_name'        => $login->get('display_name'),
        'col_modifier_foreign_key' => $login->get('foreign_key'),
        'col_mtime'                => time()
    ];
    $logic->modify($path_id, $properties);

    //監査する
    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Path_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'admin_memo_modify';

        $message_args['pid'] = $path_id;
        $message_args['admin_memo'] = $properties['col_admin_memo'];

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }
    cb_redirect('workflow/system/path_view', ['pid' => $path_id]);
}


