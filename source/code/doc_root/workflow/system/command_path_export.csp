<?php

require_once('workflow/path.csp');
$logic = GRN_Workflow_Paths::getInstance();
if (0 == $logic->getCount(GRN_WORKFLOW_PUBLIC_PATH)) {
    cb_throw_error(E_GRN_WRKF_EMPTY_PUBLIC_PATH);
}

$page_name = 'workflow/system/path_export.csp';

require_once('fw/csv.csp');
$temp_dir = cb_tmpdir();
$temp_file_name = tempnam($temp_dir, 'path_');

require_once('workflow/controller_util.csp');
$controller_util = new GRN_Workflow_ControllerUtil($page_name);
$controller_util->export($temp_file_name);

//監査する
require_once('workflow/inspection.csp');
$inspection = GRN_Workflow_Path_Inspection::getInstance();
if ($inspection->isEnabled()) {
    $message_type = 'path_export';
    $inspection->record($message_type, []);
}

cb_prepare_download('paths.xml', 'application/xml', false);
$fp = fopen($temp_file_name, 'rb');
$file_size = filesize($temp_file_name);
if (0 < $file_size) {
    echo fread($fp, $file_size);
}
fclose($fp);
unlink($temp_file_name);


