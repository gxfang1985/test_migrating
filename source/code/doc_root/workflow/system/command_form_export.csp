<?php

global $G_INPUT;

// Get Parameter
$category_id = $G_INPUT['cid'];

// Open Temprary File
$temp_dir = cb_tmpdir();
$temp_file_name = tempnam($temp_dir, 'form_');

// Export
require_once('workflow/controller_util.csp');
$form_util = GRN_Workflow_Form_Controller_Utility::getInstance();
$form_util->export($category_id, $temp_file_name);

// 監査する
require_once('workflow/inspection.csp');
$inspection = GRN_Workflow_Form_Inspection::getInstance();
if ($inspection->isEnabled()) {
    $message_type = 'form_export';
    //Record Inspection
    $inspection->record($message_type, []);
}

// Download and Unlink Temporary File
cb_prepare_download('form.xml', 'application/xml', false);

$fp = fopen($temp_file_name, 'rb');

$file_size = filesize($temp_file_name);
if (0 < $file_size) {
    echo fread($fp, $file_size);
}

fclose($fp);
unlink($temp_file_name);


