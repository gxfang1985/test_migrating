<?php

use grn\grn\access\service\AppAccess;

// workflow/cellular function
require_once('workflow/cellular.csp');

global $G_INPUT;

// LoginUser
global $G_login_user;
global $G_cellular_login;
global $G_uum;
global $G_container_app;
if ( ! isset($G_uum)) {
    $G_uum = $G_container_app->getInstance('uum');
}
if ( ! isset($G_cellular_login)) {
    $G_cellular_login = $G_uum->getLoginUser();
}
$G_login_user = $G_cellular_login;

global $G_workflow_login_user;
$G_workflow_login_user = $G_login_user;

// ワークフローケータイの利用権限をチェック
if (is_object($G_login_user)) {
    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Workflow_Application $wf */
    if ( ! ($wf = $locator->getInstance('workflow'))) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
    }

    $lic = $wf->getLicenseInfo();
    if ( ! is_array($lic) || count($lic) < 1) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_APPLICATION_NOT_AVAILABLE);
    }

    require_once('grn/license.csp');
    $lm = GRN_LicenseManager::getInstance();
    if ( ! $lm->isDemoLicense($lic['type'])) {
        AppAccess::checkInternalAccess('workflow');
    }
    unset($lm);

    // ライセンスの状態に関わらず利用停止設定を参照する

    require_once('workflow/config.csp');
    $configs = GRN_Workflow_Configs::getInstance();
    $config = $configs->getPersonalConfig($G_login_user->getOID());

    if ( ! $config->getSuspension()) {
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_CELLULAR_UNDER_SUSPENSION);
    }
    unset($locator, $wf, $lic, $configs, $config);
}

// ケータイアプリをチェック
global $G_cellular;
unset($G_cellular);

require_once('workflow/cellular.csp');
if (__grn_workflow_is_cellular_application()) {
    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();
    $G_cellular = $locator->getInstance('cellular');
    unset($locator);
}

// Page Path
global $G_pagepath;
$G_pagepath = dirname(cb_get_pagename());

if ( ! __grn_workflow_is_cellular_application()) {
    // 基本はコピーライトを表示しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
}


