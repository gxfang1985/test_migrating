<?php

global $G_INPUT;

// Get Parameter
$category_id = $G_INPUT['cid'];

// ログインユーザーが運用管理権限を持つか確認
require_once('workflow/controller_util.csp');
$category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
if ( ! $category_util->evaluateManage()) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
}

// 未分類カテゴリか確認
if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $category_id) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
}

// 未分類カテゴリ以外は運用管理権限とアクセス権を確認
$category_util->checkManage($category_id, true, CB_DATABASE_NO_LOCK);
$category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);

// Open Temprary File
$temp_dir = cb_tmpdir();
$temp_file_name = tempnam($temp_dir, 'form_');

// Export
require_once('workflow/controller_util.csp');
$form_util = GRN_Workflow_Form_Controller_Utility::getInstance();
$form_util->export($category_id, $temp_file_name);

// 監査する
require_once('workflow/inspection.csp');
$inspection = GRN_Workflow_Form_Inspection::getInstance();
if ($inspection->isEnabled()) {
    $message_type = 'form_export';
    //Record Inspection
    $inspection->record($message_type, []);
}

// Download and Unlink Temporary File
cb_prepare_download('form.xml', 'application/xml', false);

$fp = fopen($temp_file_name, 'rb');

$file_size = filesize($temp_file_name);
if (0 < $file_size) {
    echo fread($fp, $file_size);
}

fclose($fp);
unlink($temp_file_name);


