<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    include('_access_util.csp');

    //Get Parameters
    $node_id = @ $G_INPUT['nid'];

    //Get Category Access Logic
    require_once('workflow/access_logic.csp');
    $category_access_logic = GRN_Workflow_Category_Access_Logic::getInstance();

    //Get Category Access List
//    $target_type_list = array('user', 'group', 'static_role', 'dynamic_role');
//    foreach ($target_type_list as $target_type)
//    {
    $category_access_logic->removeAccessAll($node_id);
//    }

    //Get Category Controller Utility
    require_once('workflow/controller_util.csp');
    $category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
    //Keep Login User Access Right
    $refresh = true;
    if ( ! $category_util->checkAccess($node_id, false, CB_DATABASE_NO_LOCK,
        $refresh)
    ) {
        //Can't Change Login User Access
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_MANAGE_CANNOT_CHANGE_ACCESS);
    }

    //監査する
    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Category_Accesses_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'access_delete_all';
        $message_args['cid'] = $node_id;
        //Record Inspection
        $inspection->record($message_type, $message_args);
    }

    //Redirect Next Page
    cb_redirect('workflow/operation/access_list', $G_INPUT);
}

