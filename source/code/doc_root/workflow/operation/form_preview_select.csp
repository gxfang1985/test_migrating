<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Folder ID from Session
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session_form_list
    =& $session_manager->getSession('workflow/operation/form_list');
$folder_id = $session_form_list->get('folder_id');

//-- Category and Form ID
$category_id = @ $G_INPUT['cid'];
$form_id = @ $G_INPUT['fid'];

//Check Category Exists
require_once('workflow/resources.csp');
if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID != $category_id) {
    require_once('workflow/category_logic_base.csp');
    $category_logic_base = GRN_Workflow_Category_Logic_Base::getInstance();
    $category =& $category_logic_base->get($category_id);
}

//Check Form Exist
require_once('workflow/form_logic_base.csp');
$column_list = ['_id'];
$option = [
    'condition' => [
        0 => [
            'column'   => 'col_deleted',
            'value'    => '0',
            'operator' => '='
        ]
    ]
];
$form_logic_base = GRN_Workflow_Form_Logic_Base::getInstance();
$form = $form_logic_base->get($form_id, $category_id, $column_list,
    $option);

// ログインユーザーが運用管理権限を持つか確認
require_once('workflow/controller_util.csp');
$category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
if ( ! $category_util->evaluateManage()) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
}

// 未分類カテゴリか確認
if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $category_id) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
}

// 未分類カテゴリ以外は運用管理権限とアクセス権を確認
$category_util->checkManage($category_id, true, CB_DATABASE_NO_LOCK);
$category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);

//-- get parameters from URL parameters
$org_id = @ $G_INPUT['oid'];        // organization id

//-- prepare uum and uum_util
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

require_once('grn/org_util.csp');

require_once('grn/org_tree.csp');

// ページ名を取得
$page_name = cb_get_pagename();

$util = GRN_OrgTreeUtil::getInstance();

// セッションからツリーオブジェクトを取得
// 引数がツリーのIDとなる。IDが変わると、別のツリーとみなされる（通常はページ名をセット）。
$tree =& $util->getTree($page_name);

if (is_null($org_id)) {
    // パラメータに組織IDが設定されていないので、セッションに保存されている組織IDを取得。
    // （前回選択された組織を再度選択させるため）
    $org_id = $tree->getSelectedNode();
}

if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
    // 「トップ」をクリックしたか、セッションにデータがないため初期化処理を行う。
    $tree->initialize();

    // ルート選択
    $org_id = null;
}

// 選択済み組織IDをセット
$tree->setSelectedNode($org_id);

// ツリーオブジェクトをセッションに保存
$util->setTree($page_name, $tree);

// ツリーデータを取得
$org = $tree->getRoot();

//--group information structure
$navi_info = [];
$user_list = [];
//--group information structure

//GTM-529
if ($org_id == -1 || $org_id > 0) {
    $navi_params = ['cid' => $category_id, 'fid' => $form_id, 'oid' => $org_id];
    $user_list = grn_get_group_by_application($org_id, 'workflow',
        $navi_params, null, $navi_info);
}
//GTM-529

//-- set variables for view
$t->assign('category_id', $category_id);
$t->assign('form_id', $form_id);
$t->assign('org_id', $org_id);
$t->assign('org', $org);
$t->assign('is_nogroups', 0 > $org_id);
$t->assign('is_root', ! $org_id);

$t->assign('navi_info', $navi_info);
$t->assign('user_list', $user_list);

$t->assign('page_name', $page_name);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$site_position = [
    [
        'page' => 'workflow/index',
        'name' => grn_get_page_display_name('workflow/index'),
        'fid'  => $folder_id,
        'sf'   => 1
    ],
    [
        'page' => 'workflow/operation/form_list',
        'name' => grn_get_page_display_name('workflow/operation/form_list'),
        'cid'  => $category_id,
        'sf'   => 1
    ],
    [
        'page' => 'workflow/operation/form_view',
        'name' => grn_get_page_display_name('workflow/operation/form_view'),
        'cid'  => $category_id,
        'fid'  => $form_id
    ],
    ['page' => '', 'name' => $page_title]
];
$t->assign('site_position', $site_position);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

