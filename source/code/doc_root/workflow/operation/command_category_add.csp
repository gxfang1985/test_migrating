<?php

use \grn\workflow\screen\CommandCategoryAdd as command;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //get language values
    require_once('fw/i18n.csp');
    $inputLocalNameArray
        = getMultiLanguageText(GRN_WORKFLOW_ELEMENT_NAME_CATEGORY, $G_INPUT);

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/operation/category_add';
    SmartyValidate::register_form($target_name);

    //Get Folder ID from Session
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session_form_list
        =& $session_manager->getSession('workflow/operation/form_list');
    $folder_id = $session_form_list->get('folder_id');

    $cid = null;
    if (array_key_exists('cid', $G_INPUT)) {
        $cid = $G_INPUT['cid'];
    }

    // ログインユーザーが運用管理権限を持つか確認
    require_once('workflow/controller_util.csp');
    $category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
    if ( ! $category_util->evaluateManage()) {
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
    }

    // 未分類カテゴリか確認
    if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $cid) {
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
    }

    // 未分類カテゴリ以外は運用管理権限とアクセス権を確認
    $category_util->checkManage($cid, true, CB_DATABASE_NO_LOCK);
    $category_util->checkAccess($cid, true, CB_DATABASE_NO_LOCK);

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $foreignKey = @ $G_INPUT['foreign_key'];
        $memo = @ $G_INPUT['memo'];

        //Add Category
        require_once('workflow/category_logic.csp');
        $category_logic = GRN_Workflow_Category_Logic::getInstance();
        $category_id = $category_logic->addCategory($inputLocalNameArray,
            $foreignKey, $memo, $cid);

        //Validation Session Finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('workflow/operation/form_list', ['cid' => $cid, 'sf' => 1]);
    } else {
        $page_title = grn_get_current_page_display_name();


        //Get Parameters
        $category_id = cb_at($G_INPUT, 'cid');
        if (0 == strlen($category_id) || -1 >= $category_id) {
            // Category ID Error
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_CATEGORY_INVALID_ID);
        }
        //Get Parent Category for view
        $parent_category_id = $category_id;
        include('_category_parent.csp');

        //Assign Category ID
        $t->assign('category_id', $category_id);

        command::commandWhenInvalidPost($t, $G_INPUT, $page_title, $target_name,
            $inputLocalNameArray);
        command::assignSitePosition($t,
            [
                [
                    'page' => 'workflow/index',
                    'name' => grn_get_page_display_name('workflow/index'),
                    'fid'  => $folder_id,
                    'sf'   => 1
                ],
                [
                    'page' => 'workflow/operation/form_list',
                    'name' => grn_get_page_display_name('workflow/operation/form_list'),
                    'cid'  => command::categoryId($G_INPUT),
                    'sf'   => 1
                ],
                ['page' => '', 'name' => $page_title]
            ]
        );

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}


