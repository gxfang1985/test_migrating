<?php

//Get Parameter
$parent_category_id = @ $G_INPUT['pcid'];   //Parent Category ID

//Check Parent Category ID
require_once('workflow/resources.csp');
$parent_category_id = $parent_category_id ? $parent_category_id
    : GRN_WORKFLOW_CATEGORY_ROOT_ID;

// ログインユーザーが運用管理権限を持つか確認
require_once('workflow/controller_util.csp');
$category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
if ( ! $category_util->evaluateManage()) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
}

// 未分類カテゴリか確認
if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $parent_category_id) {
    require_once('workflow/error_code.csp');
    cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
}

// 未分類カテゴリ以外は運用管理権限とアクセス権を確認
$category_util->checkManage($parent_category_id, true, CB_DATABASE_NO_LOCK);
$category_util->checkAccess($parent_category_id, true, CB_DATABASE_NO_LOCK);

//Create Parameter Translation Map
$translation_map = [
    'cid'  => '_id',
    'name' => 'name',
];

//Get Parent Category for View
$parent_category_for_view = $category_util->getView($parent_category_id,
    $translation_map, GRN_WORKFLOW_ACCESS_TYPE_MANAGE);

//Get Child Category List for View
$child_category_list_for_view
    = $category_util->getChildListView($parent_category_id, $translation_map,
    GRN_WORKFLOW_ACCESS_TYPE_MANAGE);

//Create Category Information
$category_information_for_view = $parent_category_for_view;
foreach ($child_category_list_for_view as $child_category_for_view) {
    $category_information_for_view['child_categories'][$child_category_for_view['cid']]
        = $child_category_for_view['name'];
}

//Assign Portlet Display Infomation
//Assign Parent Category Name
$t->assign('category', $category_information_for_view);
