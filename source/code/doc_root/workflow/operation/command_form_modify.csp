<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/operation/form_modify';
    SmartyValidate::register_form($target_name);

    $auto_export = null;
    if (array_key_exists('auto_export', $G_INPUT)) {
        $auto_export = $G_INPUT['auto_export'];
    }

    ///  Dynamic Register Smarty Validation  ///
    require_once($t->_get_plugin_filepath('function', 'validate'));
    $standard_params = [
        'form'   => $target_name,
        'field'  => 'initial_text_value',
        'append' => 'validation_errors'
    ];

    // 動的にバリデーションを追加
    if ($auto_export) {
        $params['form'] = $target_name;
        $params['field'] = 'export_folder';
        $params['append'] = 'validation_errors';
        $params['criteria'] = 'notEmpty';
        $params['message'] = cb_plain_msg(GRN_WORKFLOW_MODULE_ID,
            'validate_export_folder');
        smarty_function_validate($params, $t);
    }

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // Create Parameter Translation Map
        $translation_map = [
            'fid'               => '_id',
            'name'              => 'name',
            'foreign_key'       => 'foreign_key',
            'memo'              => 'memo',
            'cid'               => '_cid',
            'auto_export'       => 'auto_export',
            'export_folder'     => 'export_folder',
            'login_name_export' => 'login_name_export',
            'top_line_export'   => 'export_top_line',
        ];

        //Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }

        // ログインユーザーが運用管理権限を持つか確認
        require_once('workflow/controller_util.csp');
        $category_util
            = GRN_Workflow_Category_Controller_Utility::getInstance();
        if ( ! $category_util->evaluateManage()) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
        }

        // 未分類カテゴリか確認
        if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $properties['_cid']) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
        }

        // 未分類カテゴリ以外は運用管理権限とアクセス権を確認
        $category_util->checkManage($properties['_cid'], true,
            CB_DATABASE_NO_LOCK);
        $category_util->checkAccess($properties['_cid'], true,
            CB_DATABASE_NO_LOCK);

        //Check Category Exists
        require_once('workflow/category_logic_base.csp');
        $category_logic_base = GRN_Workflow_Category_Logic_Base::getInstance();
        $category =& $category_logic_base->get($properties['_cid']);

        //Modify Form
        require_once('workflow/form_logic.csp');
        $form_logic = GRN_Workflow_Form_Logic::getInstance();
        $form_id =& $form_logic->modify($properties['_id'],
            $properties['name'],
            $properties['foreign_key'],
            $properties['memo'],
            $properties['_cid'],
            false,
            $properties['auto_export'],
            $properties['export_folder'],
            $properties['login_name_export'],
            $properties['export_top_line']
        );

        //監査する
        require_once('workflow/inspection.csp');
        $inspection = GRN_Workflow_Form_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            $message_type = 'form_modify';

            $message_args['fid'] = $properties['_id'];
            $message_args['name'] = $properties['name'];
            $message_args['foreign_key'] = $properties['foreign_key'];
            $message_args['memo'] = $properties['memo'];

            if ( ! defined('ON_FOREST')) {
                $message_args['auto_export']
                    = $inspection->setFlag($properties['auto_export']);
                $message_args['export_folder']
                    = $properties['export_folder'];
                $message_args['login_name_export']
                    = $inspection->setFlag($properties['login_name_export']);
                $message_args['export_top_line']
                    = $inspection->setFlag($properties['export_top_line']);
            }

            //Record Inspection
            $inspection->record($message_type, $message_args);
        }
        //Validation Session Finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('workflow/operation/form_view',
            ['cid' => $properties['_cid'], 'fid' => $properties['_id']]);
    } else {
        // 動的に追加したバリデーションを解除
        SmartyValidate::unregister_form($target_name);
        SmartyValidate::register_form($target_name);

        //Include Sharing Codes With Command_*
        include('_form_modify.csp');

        //Set Form Information
        $form_for_view =& $t->get_template_vars('form');
        $form_for_view['name'] = @ $G_INPUT['name'];
        $form_for_view['foreign_key'] = @ $G_INPUT['foreign_key'];
        $form_for_view['memo'] = @ $G_INPUT['memo'];
        $form_for_view['cid'] = @ $G_INPUT['cid'];
        $form_for_view['auto_export'] = @ $G_INPUT['auto_export'];
        $form_for_view['export_folder'] = @ $G_INPUT['export_folder'];
        $form_for_view['login_name_export'] = @ $G_INPUT['login_name_export'];
        $form_for_view['top_line_export'] = @ $G_INPUT['top_line_export'];

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}


