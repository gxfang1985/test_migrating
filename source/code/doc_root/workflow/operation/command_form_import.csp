<?php

//Check HTTP-POST Method
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    //Smarty object
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    //Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/operation/form_import';
    SmartyValidate::register_form($target_name);

    // Validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // Get Parameter
        $category_id = $G_INPUT['cid'];

        // ログインユーザーが運用管理権限を持つか確認
        require_once('workflow/controller_util.csp');
        $category_util
            = GRN_Workflow_Category_Controller_Utility::getInstance();
        if ( ! $category_util->evaluateManage()) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
        }

        // 未分類カテゴリか確認
        if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $category_id) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
        }

        // 未分類カテゴリ以外は運用管理権限とアクセス権を確認
        $category_util->checkManage($category_id, true, CB_DATABASE_NO_LOCK);
        $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);

        //Create Parameter Translation Map
        $translation_map = [
            'file' => 'file',
        ];

        //Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $_FILES[$view_name];
        }

        //Import
        require_once('workflow/controller_util.csp');
        $form_util = GRN_Workflow_Form_Controller_Utility::getInstance();
        $form_util->import($properties['file']['tmp_name'], $category_id);

        //the Validation Session is finished
        SmartyValidate::unregister_form($target_name);

        cb_redirect('workflow/operation/form_list', ['cid' => $category_id]);
    } else {
        //include sharing codes with command_*
        include('_form_import.csp');

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display("{$target_name}.tpl");
    }
}

