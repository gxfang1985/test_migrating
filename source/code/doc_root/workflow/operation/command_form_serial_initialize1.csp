<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/operation/form_serial_initialize1';
    SmartyValidate::register_form($target_name);

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        //Get Parameters
        $category_id = @ $G_INPUT['cid'];            //Category ID
        $form_id = @ $G_INPUT['fid'];            //Form ID
        $serial_number = @ $G_INPUT['serial_number'];  //Serial Number

        //Check Category Exists
        require_once('workflow/resources.csp');
        if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID != $category_id) {
            require_once('workflow/category_logic_base.csp');
            $category_logic_base
                = GRN_Workflow_Category_Logic_Base::getInstance();
            $category =& $category_logic_base->get($category_id);
        }

        // ログインユーザーが運用管理権限を持つか確認
        require_once('workflow/controller_util.csp');
        $category_util
            = GRN_Workflow_Category_Controller_Utility::getInstance();
        if ( ! $category_util->evaluateManage()) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY);
        }

        // 未分類カテゴリか確認
        if (GRN_WORKFLOW_CATEGORY_NONPARTY_ID == $category_id) {
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_MANAGE_DENY_NONPARTY_CATEGORY);
        }

        // 未分類カテゴリ以外は運用管理権限とアクセス権を確認
        $category_util->checkManage($category_id, true, CB_DATABASE_NO_LOCK);
        $category_util->checkAccess($category_id, true, CB_DATABASE_NO_LOCK);

        //Validation Session Finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('workflow/operation/form_serial_initialize2',
            ['cid' => $category_id, 'fid' => $form_id, 'sn' => $serial_number]);
    } else {
        //Include Sharing Codes With Command_*
        include('_form_serial_initialize1.csp');

        //Assign Post Parameters
        $t->assign('serial_number', cb_at($G_INPUT, 'serial_number'));

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}


