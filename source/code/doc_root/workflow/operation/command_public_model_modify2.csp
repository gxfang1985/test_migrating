<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    include('_public_util.csp');

    //Get Parameters
    $node_id = @ $G_INPUT['nid'];             //Category ID
    $security_model = @ $G_INPUT['security_model'];  //Security Model

    //Set Security Model
    require_once('workflow/public_logic.csp');
    $category_public_logic = GRN_Workflow_Category_Public_Logic::getInstance();
    $category_public_logic->setSecurityModel($node_id, $security_model);


    //Get Category Controller Utility
    require_once('workflow/controller_util.csp');
    $category_util = GRN_Workflow_Category_Controller_Utility::getInstance();
    //Keep Login User Public Right
    /*
    if (!$category_util->checkPublic($node_id, FALSE, CB_DATABASE_NO_LOCK, TRUE))
    {
        //Add Login User Public
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');
        //Get Login User
        $login_user =& $uum->getLoginUser();
        $authorities = array('browse' => 1);
        $category_public_logic->addPublic($node_id, $login_user->getOID(), GRN_WORKFLOW_PUBLIC_TARGET_TYPE_USER, $authorities);
    }
    */

    //監査する
    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Category_Public_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'public_model_modify';

        $message_args['cid'] = $node_id;
        $message_args['security_model'] = $security_model;

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }

    $params = $G_INPUT;
    unset($params['security_model']);

    //Redirect Next Page
    cb_redirect('workflow/operation/public_list', $params);
}

