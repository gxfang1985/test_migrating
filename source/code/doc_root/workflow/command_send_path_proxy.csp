<?php

use grn\grn\JSONResponse;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;
    $json = JSONResponse::create();

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Get Parameter
    $category_id = @ $G_INPUT['cid'];    //Category ID
    $form_id = @ $G_INPUT['fid'];    //Form ID
    $command = @ $G_INPUT['cmd'];    //Command
    $simple = @ $G_INPUT['simple'];
    $mid = @ $G_INPUT['mid'];

    //Get Session Key
    require_once('workflow/controller_util.csp');
    require_once('grn/controller.csp');
    $tmp_key = grn_get_temporary_key();

    //Check Command Parameter
    switch ($command) {
        case 'back':
            //Redirect Back Page
            if (defined('AJAX_REQUEST')) {
                $json->response([
                    'link' => cb_get_full_url('workflow/send_form_proxy', [
                        'cid'     => $category_id,
                        'fid'     => $form_id,
                        'simple'  => $simple,
                        'sf'      => 1,
                        'mid'     => $mid,
                        'tmp_key' => $tmp_key
                    ])
                ]);
                cb_safe_exit();
            }
            cb_redirect('workflow/send_form_proxy', [
                'cid'     => $category_id,
                'fid'     => $form_id,
                'simple'  => $simple,
                'sf'      => 1,
                'mid'     => $mid,
                'tmp_key' => $tmp_key
            ]);
        case 'cancel':
            grn_workflow_cleanup_session($t, 'proxy', $tmp_key);
            //Redirect Back Page
            if (defined('AJAX_REQUEST')) {
                $json->response([
                    'link' => cb_get_full_url('workflow/send_proxy', [
                        'cid'    => $category_id,
                        'simple' => $simple,
                        'mid'    => $mid
                    ])
                ]);
                cb_safe_exit();
            }
            cb_redirect('workflow/send_proxy',
                ['cid' => $category_id, 'simple' => $simple, 'mid' => $mid]);
            break;
        default:
            break;
    }

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'workflow/send_path_proxy';
    $session_target = $target_name . $tmp_key;
    SmartyValidate::register_form($session_target);

    //Prepare Path Step Validation
    $send_path_data_list = [];
    foreach (array_keys($G_INPUT) as $key) {
        if (strpos($key, 'all_path_step_') === 0) {
            $keys = explode('_', $key);
            $values = $G_INPUT[$key];
            if (is_array($values) && count($values) > 0) {
                $send_path_data_list[$keys[3]] = $values;
                $G_INPUT["path_step_{$keys[3]}_sUID"] = count($values);
            } else {
                $G_INPUT["path_step_{$keys[3]}_sUID"] = null;
            }
        }
    }

    //Get Session
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession($session_target);
    //Add Path Step Data To Session
    $session->set('send_path_data_list', $send_path_data_list);

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $session_target)) {
        // 最終承認の処理者の（省略）を禁止
        $session = $session_manager->getSession('workflow/send_form_proxy'
                                                . $tmp_key);
        $path_steps = $session->get('path_step_list');
        if ( ! is_array($path_steps) || 0 == count($path_steps)) {
            // フォームがない
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_DENY_REQUEST_DATA);
        }
        foreach (array_keys($path_steps) as $path_step_id) {
            $path_step =& $path_steps[$path_step_id];
            if (array_key_exists($path_step_id, $send_path_data_list)) {
                $path_step['col_activate'] = true;
            } else {
                $path_step['col_activate'] = false;
            }
        }
        $controller_util = new GRN_Workflow_ControllerUtil($target_name);
        $controller_util->connectPathStepLink($path_steps);

        $top_path_step = current($path_steps);
        if ($controller_util->isOnlyCircularPathSteps($top_path_step)) {
            $is_skip = true;
            foreach ($send_path_data_list as $send_path_data) {
                $is_skip &= false !== array_search(0, $send_path_data);
            }

            if ($is_skip) {
                // すべての回覧経路ステップを省略できない
                require_once('workflow/error_code.csp');
                cb_throw_error(E_GRN_WRKF_DENY_ALL_SKIP_PATH_STEP_DATA);
            }
        } else {
            if ($path_step
                =& $controller_util->getLastAcceptancePathStep($top_path_step)
            ) {
                $send_path_data = $send_path_data_list[$path_step['_id']];
                if (false !== array_search(0, $send_path_data)) {
                    // 最終承認の経路ステップは省略できない
                    require_once('workflow/error_code.csp');
                    cb_throw_error(E_GRN_WRKF_DENY_SKIP_PATH_STEP_DATA);
                }
            }
        }

        //Create Parameter Translation Map
        $translation_map = [
            'cid' => '_cid',
            'fid' => '_fid',
        ];

        //Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }

        //Validation Session Finished
        SmartyValidate::unregister_form($session_target);

        //Redirect Next Page
        $json->response([
            'link' => cb_get_full_url('workflow/send_confirm_proxy', [
                'cid'     => $properties['_cid'],
                'fid'     => $properties['_fid'],
                'simple'  => $simple,
                'sf'      => 1,
                'tmp_key' => $tmp_key
            ])
        ]);
        cb_safe_exit();
    } else {
        $session_send_form
            = $session_manager->getSession('workflow/send_form_proxy'
                                           . $tmp_key);
        //Load Send Form Session (for Design)
        $form_for_view = $session_send_form->get('form');
        if ( ! is_array($form_for_view) || 0 == count($form_for_view)) {
            // フォームがない
            require_once('workflow/error_code.csp');
            cb_throw_error(E_GRN_WRKF_DENY_REQUEST_DATA);
        }

        header(CB_ERROR_HEADER . 'error_validation');
        $json->response([
            'validation'    => false,
            'error_message' => $t->fetch('grn/show_validation_errors.tpl')
        ]);
        cb_safe_exit();
    }
}


