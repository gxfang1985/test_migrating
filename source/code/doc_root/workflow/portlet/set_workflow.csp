<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// ----------
$settings = @ $portlet['settings'];
$folder_type = @ $settings['folder_type'];

//Login User
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$user =& $uum->getLoginUser();
$user_id = $user->getOID();

//Create Parameter Translation for Folder
$translation_map_folder = [
    'fid'  => '_id',            //Folder ID
    'name' => 'name',           //Folder Name
    'type' => 'folder_type',    //Folder Type
];

//Get Folder Controller Utility
require_once('workflow/controller_util.csp');
$folder_util = GRN_Workflow_Folder_Controller_Utility::getInstance();

//Get Folder List for View
$folder_list = $folder_util->getListView($translation_map_folder,
    $user_id);
$folder_list_for_view = [];
// 受信一覧、送信一覧、下書きのみに
foreach ($folder_list as $id => $folder) {
    if ($folder_type == $folder['type']) {
        $folder['selected'] = true;
    } else {
        $folder['selected'] = false;
    }

    switch ($folder['type']) {
        case GRN_WORKFLOW_FOLDER_TYPE_IN_ID:
            $folder_list_for_view[0] = $folder;
            break;
        case GRN_WORKFLOW_FOLDER_TYPE_OUT_ID:
            $folder_list_for_view[1] = $folder;
            break;
        case GRN_WORKFLOW_FOLDER_TYPE_TEMP_ID:
            $folder_list_for_view[2] = $folder;
//        $t->assign( 'temp_folder_id', $folder['fid'] );
            break;
    }
}
$t->assign('folder_list', $folder_list_for_view);

// font options
$font_options_for_view = [
    [
        'value' => 'small',
        'label' => cb_msg(GRN_WORKFLOW_MODULE_ID, 'font_size_small')
    ],
    [
        'value' => 'normal',
        'label' => cb_msg(GRN_WORKFLOW_MODULE_ID, 'font_size_normal')
    ],
    [
        'value' => 'large',
        'label' => cb_msg(GRN_WORKFLOW_MODULE_ID, 'font_size_large')
    ],
];
switch (@ $settings['font_size']) {
    case 'small':
        $font_options_for_view[0]['selected'] = true;
        break;
    case 'normal':
        $font_options_for_view[1]['selected'] = true;
        break;
    case 'large':
        $font_options_for_view[2]['selected'] = true;
        break;
    default:
        $font_options_for_view[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options_for_view);

// display columns
$display_keys = ['number', 'priority', 'status', 'transactor', 'time'];
if (is_array($settings)) {
    foreach ($display_keys as $key) {
        if (array_key_exists($key, $settings)) {
            $t->assign($key, $settings[$key]);
        } else {
            $t->assign($key, true);
        }
    }
} else {
    foreach ($display_keys as $key) {
        $t->assign($key, true);
    }
}

// row number
$t->assign(
    'select1', [
        'name'    => 'rows',
        'options' => [
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20
        ],
        'padding' => '&nbsp;',
    ]
);

$settings_for_view = [];
$rows_for_view = @ $settings['rows'];
if ($rows_for_view == '') {
    $rows_for_view = 5;
}
$settings_for_view['rows'] = $rows_for_view;
$t->assign('settings', $settings_for_view);

//Assign include_php Parameter
$t->assign('folder_type', $folder_type);
$t->assign('portlet', $portlet);
$t->assign('display', $display);

// Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$doc_name = 'workflow/portlet/set_workflow';
$t->display("{$doc_name}.tpl");


