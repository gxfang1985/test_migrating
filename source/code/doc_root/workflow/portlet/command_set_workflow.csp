<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('portal/error_code.csp');
    if ( ! isset($portlet)) {
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
    }

    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $setting_keys = [
        'folder_type',
        'font_size',
        'number',
        'priority',
        'status',
        'transactor',
        'time',
        'rows'
    ];
    $settings = [];
    foreach ($setting_keys as $key) {
        $value = @ $G_INPUT[$key];
        if (($key == 'number') || ($key == 'status') || ($key == 'transactor')
            || ($key == 'time')
            || ($key == 'priority')
        ) {
            $value = is_null($value) ? 0 : 1;
        }

        $settings[$key] = $value;
    }

    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app_portal */
    $app_portal =& $app_locator->getInstance('portal');
    $app_portal->setPortletSettings($G_INPUT['plid'], $settings);

    //監査する
    require_once('workflow/inspection.csp');
    $inspection = GRN_Workflow_Portlet_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $message_type = 'portlet_set';

        $message_args['folder_type'] = $settings['folder_type'];
        $message_args['font_size'] = $settings['font_size'];
        $message_args['number']
            = $inspection->setFlag($settings['number']);
        $message_args['priority']
            = $inspection->setFlag($settings['priority']);
        $message_args['status']
            = $inspection->setFlag($settings['status']);
        $message_args['transactor']
            = $inspection->setFlag($settings['transactor']);
        $message_args['time'] = $inspection->setFlag($settings['time']);
        $message_args['rows'] = $settings['rows'];

        //Record Inspection
        $inspection->record($message_type, $message_args);
    }

    //Switch Redirect Page
    if ($G_INPUT['display'] === 'set-system') {
        //redirect System page
        cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
    } elseif ($G_INPUT['display'] === 'set-operation') {
        //redirect Operation page
        cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
    } else {
        //redirect Personal page
        cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
    }
}

