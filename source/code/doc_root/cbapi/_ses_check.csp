<?php

$credential = array_key_exists('s_para', $G_INPUT) ? $G_INPUT['s_para'] : null;
$type = array_key_exists('typ', $G_INPUT) ? $G_INPUT['typ'] : null;

if (is_null($credential) || is_null($type)) {
    require_once('cbapi/error_code.csp');
    grn_cbapi_throw_error(E_GRN_CBAPI_NO_PARAMETER);
}

// type: 1 - PC, 2 - cellular
if ((strcmp($type, '1') !== 0 && strcmp($type, '2') !== 0)) {
    require_once('cbapi/error_code.csp');
    grn_cbapi_throw_error(E_GRN_CBAPI_INVALID_BROWSER_TYPE);
}

// validate the session parameter
require_once('grn/authentication.csp');
$util = GRN_Authentication_Crypt_Utility::getInstance();
$decrypted_credential = $util->decrypt2($credential);
if ($decrypted_credential === false) {
    $decrypted_credential = '';
}
$user_info = explode(':', $decrypted_credential);
if (count($user_info) != 2) {
    require_once('cbapi/error_code.csp');
    grn_cbapi_throw_error(E_GRN_CBAPI_INVALID_PASSWORD);
}

$uid = $user_info[0];
$pwd = $user_info[1];

// login
global $G_container_base;
$tm =& $G_container_base->getInstance('table_manager');
$table =& $tm->getTableInfo('CB_User');
$user =& $table->getRow($uid);
if (is_null($user) || ! is_null($user->get('deleted'))) {
    require_once('cbapi/error_code.csp');
    grn_cbapi_throw_error(E_GRN_CBAPI_NO_USER);
}
if (strcmp($pwd, $user->get('password')) !== 0) {
    require_once('cbapi/error_code.csp');
    grn_cbapi_throw_error(E_GRN_CBAPI_INVALID_PASSWORD);
}

$t->assign('uid', $uid);


