<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    if ( ! @$G_INPUT['file_id']) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $file_id = $G_INPUT['file_id'];

    $target_name = '';
    if (array_key_exists('fn', $G_INPUT)) {
        $target_name = $G_INPUT['fn'];
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession($target_name);

    $files = $session->getFiles('import_files');

    if ( ! array_key_exists($file_id, $files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $charset = @$G_INPUT['charset'];
    $skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;

    if ( ! $charset) {
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    require_once('fw/csv.csp');
    $csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

    // 先頭行をスキップ
    for ($i = 0; $i < $skip; ++$i) {
        $csv->readLine();
    }

    require_once('rss/system.csp');
    $system = GRN_RSS_SystemLogic::getInstance();

    $url_list = [];
    while (($line = $csv->readLine()) !== false) {
        if (count($line) !== 3 || strlen($line[1]) == 0) {
            require_once('rss/error_code.csp');
            cb_throw_error(E_GRN_RSS_CSV_INVALID_COLUMNS);
        }

        if (in_array($line[1], $url_list)) {
            require_once('rss/error_code.csp');
            cb_throw_error(E_GRN_RSS_SITE_DUPLICATION);
        }

        $url_list[] = $line[1];

        $system->import($G_rss_login, $line);
    }

    $csv->close();

    foreach (array_keys($files) as $id) {
        $session->unsetFile('import_files', $id);
    }

    // update scheduling date
    require_once('rss/logic.csp');
    $logic = new GRN_RSS_ReaderLogic();
    $logic->setSchedulingDate();

    cb_redirect('rss/system/list');

}

