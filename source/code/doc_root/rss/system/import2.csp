<?php

//print_r( $G_INPUT ); die;

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- assign smarty parameters

// page title
$page_title = grn_get_page_display_name(cb_get_pagename());
$t->assign('page_title', $page_title);

if ( ! @ $G_INPUT['file']) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
$file_id = $G_INPUT['file'];
$t->assign('charset', $charset);
$t->assign('skip', $skip);
$t->assign('file_id', $file_id);

if ( ! $charset) {
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$target_name = '';
if (array_key_exists('fn', $G_INPUT)) {
    $target_name = $G_INPUT['fn'];
}
$t->assign('form_name', $target_name);

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session =& $sm->getSession($target_name);

$files = $session->getFiles('import_files');

if ( ! $files || ! array_key_exists($file_id, $files)) {
    require_once('rss/error_code.csp');
    cb_throw_error(E_GRN_RSS_TEMPORARY_FILE_NOT_FOUND);
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

// 表示するサンプルの行数
$read_lines = 5;

// folder csv files column number
$csv_columns_num = 3;

// サンプル行の読み込み
$csv_datas = [];

$count = 0;
while (($line = $csv->readLine()) !== false) {
    if ($skip > 0) {
        $skip--;
        continue;
    }

    if (count($line) != $csv_columns_num) {
        require_once('rss/error_code.csp');
        cb_throw_error(E_GRN_RSS_CSV_INVALID_COLUMNS);
    } else {
        $csv_datas[] = $line;
    }

    $count++;

    if ($count >= $read_lines) {
        break;
    }
}

/*
$csv_datas = array(
    array( 'ヤフー Japan!', 'http://www.yahoo.co.jp/' ),
    array( 'MSN', 'http://www.msn.co.jp/' ),
    );
 */
$t->assign('csv_datas', $csv_datas);

// page title
$page_title = grn_get_page_display_name(cb_get_pagename());
$t->assign('page_title', $page_title);

// site position
$site_position = [
    ['page' => null, 'name' => $page_title],
];
$t->assign('site_position', $site_position);

$t->assign('form', ['hiddens' => ['fn' => $target_name]]);

//-- show page
$t->display(cb_get_pagename() . ".tpl");

