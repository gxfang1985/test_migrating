<?php
//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('rss/system.csp');
$system = GRN_RSS_SystemLogic::getInstance();
if (strcmp($system->getUsePersonalAttribute(), '0') === 0) {
    require_once('rss/error_code.csp');
    cb_throw_error(E_GRN_RSS_NO_PERSONAL_PERMISSION);
}

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

require_once('rss/personal.csp');
$personal = GRN_RSS_PersonalLogic::getInstance();
$relation_list = $personal->getPersonalRelationList($G_rss_login);

require_once('rss/logic.csp');
$logic = new GRN_RSS_ReaderLogic();

$sites_for_view = [];
foreach ($relation_list as $rid => $relation) {
    $site = [];
    $site['title'] = $relation['title'];
    switch (intval($relation['type'])) {
        case GRN_RSS_RELATION_TYPE_FOLDER:
            break;
        case GRN_RSS_RELATION_TYPE_CHANNEL:
            if ($relation['has_error']) {
                $site['has_error'] = true;
                $site['error']
                    = $logic->getErrorMessage($relation['error']);
            }
            break;
        case GRN_RSS_RELATION_TYPE_DELIMITER:
            $site['separator'] = true;
            break;
    }

    $sites_for_view[$rid] = $site;
}
$t->assign('sites', $sites_for_view);

//-- show page
$t->display(cb_get_pagename() . ".tpl");

