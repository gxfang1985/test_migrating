<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}
//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$default_settings = [
    'font_size' => 'normal',
    'channel'   => '',
    'blank'     => true,
    'rows'      => 5
];

// get portlet settings
if (array_key_exists('settings', $portlet)) {
    $portlet_settings = $portlet['settings'];
} else {
    $portlet_settings = [];
}

// set portlet settings
$settings_for_view = [];
foreach ($default_settings as $key => $value) {
    if (array_key_exists($key, $portlet_settings)) {
        $settings_for_view[$key] = $portlet_settings[$key];
    } else {
        $settings_for_view[$key] = $value;
    }
}

if ($settings_for_view['channel'] !== '') {
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user =& $uum->getLoginUser();

    // get navi parameter
    require_once('grn/ui.csp');
    $cm = GRN_UIConfigManager::getInstance();
    $user_config =& $cm->getUserConfig($user);
    $subject_width = $user_config->getSubjectWidth();
    $t->assign('subject_width', $subject_width);

    require_once('rss/logic.csp');
    require_once('rss/system.csp');
    require_once('rss/personal.csp');
    $logic = new GRN_RSS_ReaderLogic();
    $system = GRN_RSS_SystemLogic::getInstance();
    $personal = GRN_RSS_PersonalLogic::getInstance();

    // initialize
    $personal->initialize($user);

    // folder relation id
    $rid = substr($settings_for_view['channel'], 1);

    // channel info
    if (strpos($settings_for_view['channel'], 's') === 0) // shared channel
    {
        $channel = $system->getSharedChannelInfo($rid);
    } else                                                     // personal channel
    {
        if ($system->getUsePersonalAttribute() === '1') {
            $channel = $personal->getPersonalChannelInfo($user, $rid);
        } else {
            // cannot access personal channels
            $channel = false;
        }
    }

    if ($channel === false) {
        unset($settings_for_view['channel']);
    } else {
        // set channel info
        $settings_for_view['channel_name'] = $channel['title'];
        $settings_for_view['has_error'] = $channel['has_error'];
        $settings_for_view['channel_url'] = $channel['url'];
        if (is_null($channel['url'])) {
            if (strpos(strtolower($channel['id']), 'http://') === false
                && strpos(strtolower($channel['id']), 'https://') === false
            ) {
                $channel['id'] = 'http://' . $channel['id'];
            }
            $settings_for_view['channel_url'] = $channel['id'];
        }

        // update data
        $logic->onDemandSyncDataByURL($channel['id']);

        // update access time
        $counts = $logic->getNewItemNumber($user, [$channel['oid']]);
        if ( ! $channel['has_error']
             ||
             ! ( ! array_key_exists($channel['oid'], $counts)
                 || (array_key_exists($channel['oid'], $counts)
                     && $counts[$channel['oid']] > 0))
        ) {
            $logic->updateChannelAccessTime($user, $channel['id']);
        }

        $settings_for_view['new_item_num'] = $counts[$channel['oid']];

        // channel access time
        $access_time = $logic->getChannelAccessTime($user, $channel['id']);

        // get item list
        $manager = GRN_RSS_Manager::getInstance();
        $item_list = $manager->getItemList($channel['id'], 0,
            $settings_for_view['rows']);

        $items_for_view = [];
        foreach ($item_list as $item_data) {
            $item = [];
            $item['title'] = $item_data['title'];
            $item['link'] = $item_data['url'];
            $item['date'] = $item_data['ptime'];
            $item['is_new'] = intval($item_data['utime']->unix_ts)
                              > $access_time;

            $items_for_view[] = $item;
        }
        $t->assign('items', $items_for_view);
    }
}

$t->assign('settings', $settings_for_view);

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('fw/i18n.csp');
    require_once('grn/application.csp');
    require_once('rss/resources.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $page_title = cb_plain_msg(GRN_RSS_APP_MODULEID, 'portlet_item_list',
        ['app_name' => $app_locator->getName('rss')]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);
$t->assign('display_name_mode', $portlet['display_name_mode']);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display('rss/portlet/view_item_list.tpl');


