<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// ----------

$settings = [];
if (array_key_exists('settings', $portlet)) {
    $settings = $portlet['settings'];
}

// font options
require_once('rss/resources.csp');
$font_options_for_view = [
    [
        'value' => 'small',
        'label' => cb_msg(GRN_RSS_APP_MODULEID, 'font_size_small')
    ],
    [
        'value' => 'normal',
        'label' => cb_msg(GRN_RSS_APP_MODULEID, 'font_size_normal')
    ],
    [
        'value' => 'large',
        'label' => cb_msg(GRN_RSS_APP_MODULEID, 'font_size_large')
    ],
];
$font_size = 'normal';
if (array_key_exists('font_size', $settings)) {
    $font_size = $settings['font_size'];
}
switch ($font_size) {
    case 'small':
        $font_options_for_view[0]['selected'] = true;
        break;
    case 'normal':
        $font_options_for_view[1]['selected'] = true;
        break;
    case 'large':
        $font_options_for_view[2]['selected'] = true;
        break;
    default:
        $font_options_for_view[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options_for_view);

// checkboxes
$blank_for_view = true;
if (array_key_exists('blank', $settings)) {
    $blank_for_view = $settings['blank'];
}
$t->assign('blank', $blank_for_view);

// channel tree

// selected channel
$channel_for_view = '';
if (array_key_exists('channel', $settings)) {
    $channel_for_view = $settings['channel'];
}

$channel_list_for_view = [];
// shared channels
require_once('rss/system.csp');
require_once('rss/resources.csp');
$system = GRN_RSS_SystemLogic::getInstance();
$shared_list = $system->getSharedRelationList();
foreach ($shared_list as $rid => $channel_data) {
    if ($channel_data['type'] === GRN_RSS_RELATION_TYPE_CHANNEL) {
        $channel = [];
        $channel['value'] = 's' . strval($rid);
        $channel['label'] = $channel_data['title'];
        if ($channel_data['has_error'] === true) {
            $channel['label'] .= ' ( ! ) ';
        }
        $channel_list_for_view[$channel['value']] = $channel;
    }
}

if (strcmp($display, 'set-personal') === 0) {
    // personal channels
    if (strcmp($system->getUsePersonalAttribute(), '1') === 0) {
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');
        $user =& $uum->getLoginUser();

        require_once('rss/personal.csp');
        $personal = GRN_RSS_PersonalLogic::getInstance();

        $personal->initialize($user);

        $personal_list = $personal->getPersonalRelationList($user);
        foreach ($personal_list as $rid => $channel_data) {
            if ($channel_data['type'] === GRN_RSS_RELATION_TYPE_CHANNEL) {
                $channel = [];
                $channel['value'] = 'p' . strval($rid);
                $channel['label'] = $channel_data['title'];
                if ($channel_data['has_error'] === true) {
                    $channel['label'] .= ' ( ! ) ';
                }
                $channel_list_for_view[$channel['value']] = $channel;
            }
        }
    }
}
if (count($channel_list_for_view) > 0) {
    require_once('fw/i18n.csp');
    $tmp = array_reverse($channel_list_for_view);
    $tmp['0'] = [
        'value' => '0',
        'label' => cb_msg(GRN_RSS_APP_MODULEID, 'portlet_select')
    ];
    $channel_list_for_view = array_reverse($tmp);
    $t->assign('has_channel', true);
}
if (array_key_exists($channel_for_view, $channel_list_for_view)) {
    $channel_list_for_view[$channel_for_view]['selected'] = true;
}
$t->assign('channel_list', $channel_list_for_view);
$t->assign('channel', $channel_for_view);

// row number
$t->assign('rows_numbers',
    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]);
$settings_for_view = [];
$rows_for_view = 5;
if (array_key_exists('rows', $settings)) {
    $rows_for_view = $settings['rows'];
}
$t->assign('rows', $rows_for_view);

// ----------

//Assign include_php Parameter
$t->assign('portlet', $portlet);
$t->assign('display', $display);

// Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display('rss/portlet/set_item_list.tpl');


