<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! array_key_exists('date', $G_INPUT)) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_DATE_NOT_FOUND);
    }

    $date = new CB_Date();
    $date->parse($G_INPUT['date']);

    require_once('fw/date.csp');
    $ts = new CB_TimeStampEx();
    $today = $ts->getDate();

    require_once('timecard/logic.csp');
    $logic = GRN_Timecard_Logic::getInstance();

    if ( ! $logic->isToday($ts)) {
        $today->moveDays(-1);
    }

    if ($today->compare($date) != 0) {
        require_once('timecard/error_code.csp');
        cb_throw_error(E_GRN_TIMECARD_INVALID_DATE);
    }

    global $G_container_app;
    $uum =& $G_container_app->getInstance('uum');
    $login =& $uum->getLoginUser();

    if (@ $G_INPUT['start']) {
        $logic->punchOut($login, GRN_TIMECARD_RECORD_IN);
    } elseif (@ $G_INPUT['finish']) {
        $logic->punchOut($login, GRN_TIMECARD_RECORD_OUT);
    } elseif (@ $G_INPUT['trip']) {
        $logic->punchOut($login, GRN_TIMECARD_ABSENCE_OUT);
    } elseif (@ $G_INPUT['back']) {
        $logic->punchOut($login, GRN_TIMECARD_ABSENCE_IN);
    }
    cb_redirect('portal/index', ['pid' => @$G_INPUT['pid']]);
}
