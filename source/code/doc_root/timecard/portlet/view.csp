<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

if ($login) {
    require_once('timecard/logic.csp');
    $logic = GRN_Timecard_Logic::getInstance();

    require_once('timecard/controller.csp');
    $utility = new GRN_Timecard_ControllerUtil();
    $config = $utility->getConfigValues();

    $portlet['config'] = $config;

    require_once('fw/date.csp');

    // 今日
    $tsex = new CB_TimeStampEx();
    $today = $tsex->getDate();

    if ( ! $logic->isToday($tsex)) {
        $today->moveDays(-1);
    }

    $card = [];

    if ( ! is_null(($record =& $logic->getRecord($login, $today)))) {
        $card = $utility->getRecordView($record);
    }
    $card['date'] = $today->format();

    $portlet['card'] = $card;
}
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('timecard');
    $page_title = cb_plain_msg('grn.timecard', 'portlet_view',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

$t->skipWarning();

$t->display("timecard/portlet/view.tpl");


