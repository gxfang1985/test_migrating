<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
$org_id = @ $G_INPUT['oid'];


require_once('timecard/logic.csp');
$logic = GRN_Timecard_Logic::getInstance();

require_once('fw/date.csp');
$ts = new CB_TimeStampEx();
$today = $ts->getDate();

if ( ! $logic->isToday($ts)) {
    $today->moveDays(-1);
}
$date = clone $today;


// 引き数から日付を取得
if (array_key_exists('date', $G_INPUT)) {
    $date->parse($G_INPUT['date']);
}
// 月と日は無視
$date->month = 1;
$date->day = 1;

// 現在年表示用
$date_for_view = [];
$date_for_view['curr'] = ['year' => $date->year];

// 前年移動リンク用
$tmp_date = clone $date;
$tmp_date->moveYears(-1);
$date_for_view['prev'] = $tmp_date->format();

// 次年移動リンク用
$tmp_date = clone $date;
$tmp_date->moveYears(1);
$date_for_view['next'] = $tmp_date->format();

// 各月のリンク表示用データ
$months_for_view = [];
$tmp_date = clone $date;

// set start day equals to tally start day setting
if ( ! isset($utility) || is_null($utility)) {
    require_once('timecard/controller.csp');
    $utility = new GRN_Timecard_ControllerUtil();
}
$config = $utility->getConfigValues();
$tmp_date->day = intval($config['offset_day']);

for ($i = 1; $i <= 12; ++$i) {
    $months_for_view[$i] = [
        'this_month' => ($today->year == $tmp_date->year
                         && $today->month == $i),
        'value'      => $tmp_date->format()
    ];
    $tmp_date->moveMonths(1);
}
$date_for_view['months'] = $months_for_view;

$t->assign('date', $date_for_view);


//-- prepare uum and uum_util
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

require_once('grn/org_tree.csp');

$page_name = cb_get_pagename();

$util = GRN_OrgTreeUtil::getInstance();
$tree =& $util->getTree($page_name);

if (is_null($org_id)) {
    $org_id = $tree->getSelectedNode();
}

if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
    $tree->initialize();
    $org_id = null;
}
$tree->setSelectedNode($org_id);
$util->setTree($page_name, $tree);
$org = $tree->getRoot();


require_once('timecard/controller.csp');
$utility = new GRN_Timecard_ControllerUtil();


if ($org_id) {
    if (0 > $org_id) {
        $number_of_all = $uum->getNoGroupUserCount();
        if (false === $number_of_all) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_GROUP_NOT_FOUND);
        }
    } else {
        // count of user belonging to the selected group
        $number_of_all = $uum->getGroupUserCount($org_id);
        if ($number_of_all === false) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_GROUP_NOT_FOUND);
        }
    }

    //--number on page
    require_once('grn/ui.csp');
    $ucm = GRN_UIConfigManager::getInstance();
    $login =& $uum->getLoginUser();
    $uc =& $ucm->getUserConfig($login);
    $number_on_page = $uc->getListMax();

    //------------------
    // N件ナビゲーション

    // 現在位置
    $offset = $utility->getListOffset();

    // n件ナビゲーション情報を取得する
    $navigation_info = $utility->makeNaviInformation($offset,
        $number_on_page,
        $number_of_all,
        ['date' => $date->format(), 'oid' => $org_id]);

    //-- get users and convert them to users for view
    if (0 > $org_id) {
        $users_on_logic = $uum->getNoGroupUsers($offset, $number_on_page);
    } else {
        $users_on_logic = $uum->getGroupUsers($org_id, $offset,
            $number_on_page);
    }
    if ($users_on_logic === false) {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }

    $user_list = [];
    foreach (array_keys($users_on_logic) as $user_id) {
        $user =& $users_on_logic[$user_id];
        $user_list[$user_id] = [
            'uid'          => $user->getOID(),
            'display_name' => $user->get('display_name'),
        ];
    }
}

//-- set variables for view
$t->assign('org_id', $org_id);
$t->assign('org', $org);
$t->assign('page_name', $page_name);
$t->assign('user_list', @ $user_list);
$t->assign('navi_info', @ $navigation_info);
$t->assign('is_nogroups', 0 > $org_id);
$t->assign('is_root', ! $org_id);
if ( ! $org_id) {
    $t->assign('group_count', $uum->getGroupCount());
    $t->assign('user_count', $uum->getUserCount());
}

$utility->setSitePosition($t, null);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

