<?php

global $G_INPUT;

// Smarty をインスタンス化
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

//------------------

// 選択したユーザーをセッションから取得する
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();

$session_name = 'grn.timecard.system.export_cards1';
$session =& $session_manager->getSession($session_name);

$user_ids = $session->get('user_ids');

$org_id = @ $G_INPUT['oid'];

if ($org_id != -1 && ( ! is_array($user_ids) || count($user_ids) < 1)) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');

$user_list_for_view = [];
foreach (array_keys($user_ids) as $uid) {
    if (($user =& $uum->getUser($uid))) {
        $user_list_for_view[$uid] = ['name' => $user->get('display_name')];
    }
}
$t->assign('user_list', $user_list_for_view);

$t->assign('org_id', $org_id);


require_once('timecard/controller.csp');
$utility = new GRN_Timecard_ControllerUtil();

$utility->setSitePosition($t, null);

require('../_export.csp');

$t->assign('cancel_params', ['app_id' => 'timecard']);


// Smarty実行
$t->display(cb_get_pagename() . ".tpl");


