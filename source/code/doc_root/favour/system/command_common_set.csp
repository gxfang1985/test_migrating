<?php

use grn\grn\access\utility\AppAvailabilityUtil;
use grn\favour\service\FavourService;

if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD'), 'POST')) {
    global $G_INPUT;
    $apps = FavourService::$appsCheckingRespond;

    $list_apps_available = AppAvailabilityUtil::getActiveApplicationIds();
    if ( ! in_array('favour', $list_apps_available)) {
        cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
    };

    $available_apps = [];
    foreach ($apps as $app) {
        $available_apps[$app] = false;
        if (in_array($app, $list_apps_available)) {
            $available_apps[$app] = true;
        }
    }

    //Only update app's setting when app is active
    if (in_array(true, $available_apps)) {
        $favour_service = new FavourService();
        $favour_apps_setting = $favour_service->getAllowApplicationsRespond();
        $favour_apps_setting = $favour_apps_setting === false
            ? array_fill_keys(array_values($apps), 0)
            : $favour_apps_setting;

        foreach ($apps as $app) {
            if ($available_apps[$app]) {
                null != cb_at($G_INPUT, 'checked_' . $app) ?
                    $favour_apps_setting[$app] = 1
                    : $favour_apps_setting[$app] = 0;
            }
        }
        $favour_service->setAllowApplicationsRespond($favour_apps_setting);

        require_once('grn/logger.csp');
        $logger_manager = CB_LoggerManager::getInstance();
        $logger = $logger_manager->getLogger('grn.favour');
        $log_message = [];
        $app_id_prefix = FavourService::$appsIdPrefix;
        foreach ($favour_apps_setting as $app_id => $app_value) {
            if ($available_apps[$app_id]) {
                $log_message[] = sprintf('%s: %s', $app_id_prefix[$app_id],
                    $app_value);
            }
        }
        $log_message = implode($log_message, ', ');
        $log_message = ['allow_respond' => $log_message];
        $logger->noticeEx('config', 'common', $log_message);
    }

    cb_redirect('system/application_list', ['app_id' => 'favour']);
}
