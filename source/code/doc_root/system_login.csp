<?php

define('GRN_COOKIE_ACCOUNT', 'GRN_Account');

// 'LoginUser' ロールが必要だが、ログイン手続き中でない場合に
// 飛ばされるページ。通常はログイン画面を表示する。

// このフォームは、 CB_UumDefaultServiceProvider に合わせたもの。
// サービスプロバイダが異なればフォーム変数なども違うだろう。

require_once('grn/smarty.csp');
$t = new GRN_Smarty();

if (array_key_exists(GRN_COOKIE_ACCOUNT, $_COOKIE)) {
    $t->assign('login_cookie', ['foreign_key' => $_COOKIE[GRN_COOKIE_ACCOUNT]]);
}

$path_info = array_key_exists('PATH_INFO', $_SERVER) ? $_SERVER['PATH_INFO']
    : '';
$uri = $_SERVER['SCRIPT_NAME'] . $path_info;
$t->assign('url', $uri);

require_once('grn/customer.csp');
$customer = GRN_Customer::getInstance();
$t->assign('company_name', $customer->getProperty('company_name'));

require_once('grn/system_logic.csp');
$system = GRN_System::getInstance();
$t->assign('necessary_password', ! $system->getPasswordEmptyLogin());
$t->assign('password_autocomplete', $system->getPasswordAutocomplete());

global $G_state_set;
$G_state_set->set('not_show_mobile_view', true);

global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');

// Don't display a login page when alreadey logged-in
$login = $uum->getLoginUser();
if ($login) {
    cb_redirect('system/index');
}

if (defined('ON_FOREST')) {
    require_once('fw/slash_util.csp');
    CB_SlashUtil::redirectToLogin();
}

require_once('fw/login.csp');
$params = cb_get_page_params();
$t->assign('params', $params);

$t->display('system_login.tpl');
