<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if (@ $G_INPUT['tid']) {
        require_once('grn/application.csp');
        $locator = GRN_ApplicationLocator::instance();
        $app = $locator->getInstance('todo');

        global $G_container_app;
        $uum = $G_container_app->getInstance('uum');
        $login = $uum->getLoginUser();

        if ( ! @ $G_INPUT['tid']) {
            cb_throw_error(E_GRN_TODO_NOT_FOUND);
        }

        if ( ! ($todo = $app->get($login, $G_INPUT['tid']))) {
            cb_throw_error(E_GRN_TODO_NOT_FOUND);
        }

        $todo->setFinish(true);
        $todo->onUpdate();
        //write log
        require_once('todo/inspection.csp');
        $inspection = GRN_ToDo_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            $inspection->record('finish', 'todo', ['tid' => $G_INPUT['tid']]);
        }
    }
    cb_redirect('todo/index', ['cid' => @$G_INPUT['cid']]);

}
