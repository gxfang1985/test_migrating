<?php

use grn\space\service\TodoService;
use grn\space\common\data\bean\SpaceMember;
use grn\space\common\exception\GrnDataNotFoundException;
use grn\space\common\exception\ErrorCode;

// check input
$todoIds = [];
global $G_INPUT;
if ( ! isset($G_INPUT['eid']) || ! is_array($G_INPUT['eid'])) {
    throw new GrnDataNotFoundException(ErrorCode::GRN_INVALID_TODO_ID);
}
foreach ($G_INPUT['eid'] as $todoId) {
    if ( ! ctype_digit($todoId)) {
        throw new GrnDataNotFoundException(ErrorCode::GRN_INVALID_TODO_ID);
    }
    $todoIds[] = intval($todoId);
}

// prepare to complete todos
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$loginUser = $uum->getLoginUser();

$operationUser = new SpaceMember();
$operationUser->setMemberID($loginUser->getOID());
$operationUser->setUserName($loginUser->get('display_name'));

// complete todos
$todoService = TodoService::getInstance();
$todoService->completeTodos($todoIds, $loginUser->getOID(), $operationUser);

cb_redirect('todo/shared');
