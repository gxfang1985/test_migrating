<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'todo/add';
    // force to register
    SmartyValidate::register_form($target_name);
    $cid = cb_at($G_INPUT, 'cid');
    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        require_once('grn/application.csp');
        $locator = GRN_ApplicationLocator::instance();
        $app = $locator->getInstance('todo');

        global $G_container_app;
        $uum = $G_container_app->getInstance('uum');
        $login = $uum->getLoginUser();

        $expiration = null;

        if ( ! @ $G_INPUT['nolimit']) {
            $expiration = new CB_Date();
            $expiration->year = $G_INPUT['ldate_year'];
            $expiration->month = $G_INPUT['ldate_month'];
            $expiration->day = $G_INPUT['ldate_day'];
        }

        $category = $app->getCategory($login, $G_INPUT['category']);

        $properties = [
            'title'      => $G_INPUT['title'],
            'memo'       => $G_INPUT['memo'],
            'expiration' => $expiration,
            'priority'   => $G_INPUT['priority'],
            'category'   => &$category,
        ];

        $todo = $app->create($login, $properties);

        cb_redirect('todo/index', ['cid' => $cid]);
    } else {
        //-- if error, show the source form

        $t->setPageInfo($target_name);

        //-- include common codes
        require_once('_add.csp');
        if (array_key_exists('ldate_year', $G_INPUT)
            && array_key_exists('ldate_month', $G_INPUT)
            && array_key_exists('ldate_day', $G_INPUT)
        ) {
            $ldate = new CB_Date();
            $ldate->year = $G_INPUT['ldate_year'];
            $ldate->month = $G_INPUT['ldate_month'];
            $ldate->day = $G_INPUT['ldate_day'];
            $t->assign('ldate', $ldate);
        }
        $title = cb_at($G_INPUT, 'title', '');
        $memo = cb_at($G_INPUT, 'memo');
        $priority = cb_at($G_INPUT, 'priority');
        $category = cb_at($G_INPUT, 'category');

        $t->assign('title', $title);
        $t->assign('memo', $memo);
        $t->assign('priority', $priority);
        $t->assign('category', ['cid' => $category]);
        $t->assign('category_id', $cid);
        //-- show page
        $t->display("{$target_name}.tpl");

    }
}
