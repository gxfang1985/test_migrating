<?php

global $G_INPUT;

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app =& $locator->getInstance('cellular');
$user_config =& $cellular_app->getUserConfig($G_login_user);
$width = $user_config->getSubjectWidth();

$smarty->assign('width', $width);

// 使用するパラメータの定義
$offset = 0;
if (array_key_exists('sp', $G_INPUT) && strlen($G_INPUT['sp']) > 0) {
    $offset = intval($G_INPUT['sp']);
    $smarty->assign('sp', $offset);
}

if ($offset < 0) {
    $offset = 0;
}

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app =& $locator->getInstance('cellular');

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

//ToDo情報を取得

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app =& $locator->getInstance('todo');

require_once('todo/controller.csp');
$utility = new GRN_ToDo_ControllerUtil();

$smarty->assign('config', [
    'list_max'      => $user_config->getListMax(),
    'subject_width' => $user_config->getSubjectWidth(),
    'use_mail'      => $user_config->getUseWebMail(),
]);


// ToDo一覧
require_once('todo/list.csp');
$list = new GRN_ToDo_UserList($login);

// sort
$list->addSortColumn('limited', true);
$list->addSortColumn('expiration', false);
$list->addSortColumn('priority', true);

$limit = $user_config->getListMax();

$list->setOffset($offset);
$list->setLimit($limit);
$list->setFinish(false);

$todo_for_view = [];
while ( ! is_null(($row = $list->iterate()))) {
    $todo_for_view[$row->getOID()] = $utility->getToDoView($row);
}

$total = $list->count();

if ($total > $limit) {
    $navi_for_view = ['prev' => -1, 'next' => -1];

    if ($offset > 0) {
        if ($offset >= $limit) {
            $navi_for_view['prev'] = $offset - $limit;
        } else {
            $navi_for_view['prev'] = 0;
        }
    }

    if (($offset + $limit) < $total) {
        $navi_for_view['next'] = $offset + $limit;
    }

    $smarty->assign('navi', $navi_for_view);
}

$tmp = null;
$todo_for_cellular_view = [];

require_once("fw/date.csp");
$todays = new CB_TimeStamp();
$todays->unix_ts = time();
$this_year = new CB_TimeStampEx($todays);
$day_of_today = $this_year->getDate();

foreach ($todo_for_view as $oid => $data) {
    if ($data['ldate']) {
        $tsex = new CB_TimeStampEx($data['ldate']);
        $date = $tsex->getDate();

        if ($date->year == $day_of_today->year) {
            $tmp = cb_date_format('DateShort_MD', $date);
        } else {
            $tmp = cb_date_format('DateMiddle_YMD', $date);
        }
    } else {
        $tmp = 'null';
    }
    $todo_for_cellular_view[$tmp][$oid] = $data;
}

$smarty->assign('todo_list', $todo_for_cellular_view);
//echo "<pre>".nl2br(print_r($todo_for_cellular_view,true))."</pre>";

$smarty->display(cb_get_pagename() . '.tpl');

