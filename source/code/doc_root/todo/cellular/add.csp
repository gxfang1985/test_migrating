<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

require_once('SmartyValidate.class.php');
SmartyValidate::connect($smarty);
$form_name = 'todo/cellular/add';
SmartyValidate::register_form($form_name, true);

$smarty->assign('form_name', $form_name);

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

// 使用するパラメータの定義
if (isset($G_INPUT['retry'])) {
    $title = (isset($G_INPUT['title'])) ? $G_INPUT['title'] : null;
    $category = (isset($G_INPUT['category'])) ? $G_INPUT['category'] : null;
    $priority = (isset($G_INPUT['priority'])) ? $G_INPUT['priority'] : 1;
    $memo = (isset($G_INPUT['memo'])) ? $G_INPUT['memo'] : null;
    $dl = (isset($G_INPUT['dl'])) ? true : false;
    $yy = @ $G_INPUT['yy'];
    $mm = @ $G_INPUT['mm'];
    $dd = @ $G_INPUT['dd'];

    if (mb_strlen($memo) > 1024) {
        $memo = mb_substr($memo, 0, 1024);
    }
    $smarty->assign('valid_date', checkdate($mm + 0, $dd + 0, $yy + 0));
} else {
    $title = null;
    $category = null;
    $priority = 1;
    $memo = null;
    $dl = true;
    // 日付時刻（タイムスタンプ）クラス生成
    require_once("fw/date.csp");
    $ts = new CB_TimeStamp();
    $ts->unix_ts = time();
    $tsex = new CB_TimeStampEx($ts);
    $day_today = $tsex->getDate();
    // 今日をdefault
    $yy = $day_today->year;
    $mm = $day_today->month;
    $dd = $day_today->day;
    $smarty->assign('valid_date', true);
}

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$smarty->assign('no_deadline_checked', $dl);
$smarty->assign('title', $title);
$smarty->assign('memo', $memo);
$smarty->assign('priority', $priority);

// カテゴリ
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app =& $locator->getInstance('todo');

$categories = $app->listCategories($login);

$cat_data = [];
$cat_id = 0;
foreach (array_keys($categories) as $cid) {
    $cat_data[] = [
        'cat_id'   => $cid,
        'cat_name' => $categories[$cid]->get('title')
    ];
}
$smarty->assign('cat_data', $cat_data);
$smarty->assign('category', $category);

$smarty->assign('yy', $yy);
$smarty->assign('mm', $mm);
$smarty->assign('dd', $dd);

$smarty->display(cb_get_pagename() . '.tpl');


