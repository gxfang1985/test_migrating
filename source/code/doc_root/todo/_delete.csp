<?php

global $G_INPUT;

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app =& $locator->getInstance('todo');

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

require_once('todo/controller.csp');
$utility = new GRN_ToDo_ControllerUtil();

require_once('grn/ui.csp');
$uicm = GRN_UIConfigManager::getInstance();
$uic =& $uicm->getUserConfig($login);

if ( ! @ $G_INPUT['tid']) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}
$tid = $G_INPUT['tid'];

if ( ! ($todo =& $app->get($login, $tid))) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}

$todo_for_view = $utility->getToDoView($todo);
$t->assign('todo', $todo_for_view);

$category_id = @ $G_INPUT['cid'];
$t->assign('category_id', $category_id);


if ( ! @ $history) {
    $page_path = [
        'todo/index' => ['cid' => $category_id],
        'todo/view'  => ['tid' => $tid, 'cid' => $category_id]
    ];
} else {
    $page_path = [
        'todo/history'      => ['cid' => $category_id],
        'todo/history_view' => ['tid' => $tid, 'cid' => $category_id]
    ];
}

$utility->setSitePosition($t, $page_path);


