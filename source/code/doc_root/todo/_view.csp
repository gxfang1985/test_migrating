<?php

global $G_INPUT;

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app = $locator->getInstance('todo');

global $G_container_app;
$uum = $G_container_app->getInstance('uum');
$login = $uum->getLoginUser();

require_once('todo/controller.csp');
$utility = new GRN_ToDo_ControllerUtil();

require_once('grn/ui.csp');
$uicm = GRN_UIConfigManager::getInstance();
$uic = $uicm->getUserConfig($login);

if ( ! @ $G_INPUT['tid']) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}
$tid = $G_INPUT['tid'];

if ( ! ($todo = $app->get($login, $tid))) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}

$todo_for_view = $utility->getToDoView($todo);
$t->assign('todo', $todo_for_view);


$category_id = @$G_INPUT['cid'];

if ( ! ($category = $app->getCategory($login, $category_id))) {
    $category_id = null;
}
$t->assign('category_id', $category_id);


require_once('todo/list.csp');
$list = new GRN_ToDo_UserList($login);

if ( ! @ $history) {
    $list_utility = new GRN_ToDo_ControllerUtil('todo/index');
    $order_column = $list_utility->getListOrderColumn();

    if ($order_column['column'] == 'expiration') {
        $list->addSortColumn('limited', $order_column['order'] ? false : true);
        $list->addSortColumn($order_column['column'], $order_column['order']);
    } else {
        $list->addSortColumn($order_column['column'], $order_column['order']);

        $list->addSortColumn('limited', $order_column['order']);
        $list->addSortColumn('expiration',
            $order_column['order'] ? false : true);
    }
    $list->setFinish(false);
} else {
    $list->addSortColumn('finish', true);
    $list->setFinish(true);
}

$list->setCategory($category_id);


$navi_for_view = ['prev' => null, 'next' => null];

$prev_id = $list->getPrevious($tid);
$next_id = $list->getNext($tid);

if ( ! @ $history) {
    $view_page = 'todo/view';
} else {
    $view_page = 'todo/history_view';
}

if ($prev_id !== false) {
    $navi_for_view['prev'] = [
        'page'        => $view_page,
        'page_params' => ['tid' => $prev_id, 'cid' => $category_id]
    ];
}
if ($next_id !== false) {
    $navi_for_view['next'] = [
        'page'        => $view_page,
        'page_params' => ['tid' => $next_id, 'cid' => $category_id]
    ];
}

$t->assign('navi', $navi_for_view);

if ( ! @ $history) {
    $prev_page = 'todo/index';
} else {
    $prev_page = 'todo/history';
}

$page_path = [$prev_page => ['cid' => $category_id]];

$utility->setSitePosition($t, $page_path);


