<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('portal/error_code.csp');
    if ( ! isset($portlet)) {
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
    }

    /**
     * require_once( 'fw/session_manager.csp' );
     * $sm = CB_SessionManager::getInstance();
     * $session =& $sm->getSession( 'todo/portlet/settings' );
     **/

    if (@ $G_INPUT['cancel']) {
        if ('set-personal' == @ $G_INPUT['display']) {
            cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
        } elseif ('set-operation' == @ $G_INPUT['display']) {
            cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
        } else {
            cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
        }
    }

    $settings = [
        'rows'        => $G_INPUT['rows'],
        'priority'    => $G_INPUT['priority'],
        'sort_column' => $G_INPUT['sort_column'],
        'font_size'   => $G_INPUT['font_size'],
    ];

    if (@ ! $G_INPUT['apply']) {

        if ('set-personal' == @ $G_INPUT['display']) {
            $page = 'portal/personal/portlet_display_modify';
        }
        if ('set-operation' == @ $G_INPUT['display']) {
            $page = 'portal/operation/portlet_display_modify';
        } else {
            $page = 'portal/system/portlet_display_modify';
        }

        cb_redirect($page,
            [
                'pid'   => $G_INPUT['pid'],
                'plid'  => $G_INPUT['plid'],
                'ppid'  => $G_INPUT['ppid'],
                'ss'    => 1,
                's_cid' => $G_INPUT['s_cid'],
            ]
        );
    }

    //Get Portal Application
    require_once("grn/application.csp");
    $locator = GRN_ApplicationLocator::instance();
    if ($locator->isActive('portal')) {
        $portal =& $locator->getInstance('portal');
        $portal->setPortletSettings($G_INPUT['plid'], $settings);
    }

    if ('set-personal' == @ $G_INPUT['display']) {
        cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
    } elseif ('set-operation' == @ $G_INPUT['display']) {
        cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
    } else {
        cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
    }
}

