<?php

global $G_INPUT;

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app =& $locator->getInstance('todo');

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

if ( ! @ $G_INPUT['tid']) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}
$tid = $G_INPUT['tid'];

if ( ! ($todo =& $app->get($login, $tid)) || $todo->isFinished()) {
    cb_throw_error(E_GRN_TODO_NOT_FOUND);
}
$t->assign('tid', $tid);

$category_id = @ $G_INPUT['cid'];
$t->assign('category_id', $category_id);


// カテゴリ
$categories = $app->listCategories($login);

$categories_for_view = [];

foreach (array_keys($categories) as $id) {
    $categories_for_view[] = [
        'cid'   => $id,
        'title' => $categories[$id]->get('title')
    ];
}

$t->assign('categories', ['category' => $categories_for_view]);

// 選択カテゴリ

if (isset($initialize) && $initialize) {
    $category =& $todo->get('category');
} else {
    $cid = $category_id;

    // バリデーションに引っかかった場合
    if (array_key_exists('category', $G_INPUT)) {
        $cid = $G_INPUT['cid'];
    }

    $category =& $app->getCategory($login, $cid);
}

if ( ! is_null($category)) {
    $category_for_view = [
        'cid'   => $category->getOID(),
        'title' => $category->get('title')
    ];
    $t->assign('category', $category_for_view);
}


require_once('todo/controller.csp');
$utility = new GRN_ToDo_ControllerUtil('todo/modify');

$page_path = [
    'todo/index' => ['cid' => @$G_INPUT['cid']],
    'todo/view'  => ['tid' => @$G_INPUT['tid'], 'cid' => @$G_INPUT['cid']]
];

$utility->setSitePosition($t, $page_path);

$t->assign('config', $utility->getInputConfigValues($login));

if (($date = $todo->get('expiration'))) {
    require_once('fw/date.csp');
    $date = new CB_TimeStampEx($date);
    $date = $date->getDateTime();
    $date = $date->getDate();
    $t->assign('ldate', $date);
}

$t->assign('title', $todo->get('title'));
$t->assign('priority', $todo->get('priority'));
$t->assign('memo', $todo->get('memo'));
