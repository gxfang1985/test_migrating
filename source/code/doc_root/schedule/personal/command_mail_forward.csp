<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    /*
        // instantiate an Smarty object
        require_once( "grn/smarty.csp" );
        $t = new GRN_Smarty;

        // Validation check
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        // validate after a POST
        if(SmartyValidate::is_valid($G_INPUT)) {
            // the validation session is finished
            SmartyValidate::disconnect();
    */
    // --------
    // brabrabra after success
    // --------
    require_once('fw/string_util.csp');
    require_once('schedule/personal_logic.csp');
    $logic = GRN_Schedule_PersonalLogic::getInstance();

    // ログインユーザーの取得
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    $forward_mail = @ $G_INPUT['forward_mail'];
    if ( ! $forward_mail) {
        $forward_mail = false;
    } else {
        $forward_mail = true;
    }
    $logic->setForwardMail($login, $forward_mail);

    $forward_facility_rely_mail = @ $G_INPUT['forward_facility_rely_mail'];
    if ( ! $forward_facility_rely_mail) {
        $forward_facility_rely_mail = false;
    } else {
        $forward_facility_rely_mail = true;
    }
    $logic->setForwardFacilityRelyMail($login, $forward_facility_rely_mail);

    $forward_type = @ $G_INPUT['mail'];
    if ( ! $forward_type) {
        $forward_type = GRN_SCHD_FORWARD_TYPE_MAIL;
    } else {
        $forward_type = GRN_SCHD_FORWARD_TYPE_OTHER;
    }
    $logic->setForwardMailType($login, $forward_type);

    $forward_address = @ $G_INPUT['other_mail'];
    if ( ! $forward_address) {
        $forward_address = '';
    }
    $forward_address = cb_trim($forward_address);


    $logic->setForwardMailAddress($login, $forward_address);

    $log_params = [];
    $notic_string = '';
    if ($forward_mail) {
        $log_params['forward'] = 'ON';
        //$notic_string .= 'ON:';
        if ($forward_type) {
            $log_params['email'] = $forward_address;
        } else {
            $log_params['email'] = $login->get('email_address');
        }
    } else {
        $log_params['forward'] = 'OFF';
    }
    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    $l->noticeEx('config', 'forward_mail', $log_params);

    if ($forward_facility_rely_mail) {
        $log_params['forward'] = 'ON';
        if ($forward_type) {
            $log_params['email'] = $forward_address;
        } else {
            $log_params['email'] = $login->get('email_address');
        }
    } else {
        $log_params['forward'] = 'OFF';
    }
    $l->noticeEx('config', 'forward_facility_rely_mail', $log_params);
    /*
        } else {
            // if error, show the source form

            //Assign Template Name
            $t->setPageInfo($target_name);

            cb_redirect( 'schedule/personal/export1' );
        }
    */

}

cb_redirect('personal/application_list', ['app_id' => 'schedule']);

