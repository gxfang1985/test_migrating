<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    /*
        // instantiate an Smarty object
        require_once( "grn/smarty.csp" );
        $t = new GRN_Smarty;

        // Validation check
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        // validate after a POST
        if(SmartyValidate::is_valid($G_INPUT)) {
            // the validation session is finished
            SmartyValidate::disconnect();
    */
    require_once('schedule/error_code.csp');

    $file_id = @ $G_INPUT['file_id'];
    // セッションに関連付けてあったファイルを取得する。
    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession('schedule/personal/import1');
    $file_infos = $session->getFiles('schedule_files');
    $import_option = $session->get('import_option');

    // ファイルがない
    if ( ! is_array($file_infos)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }

    if ( ! array_key_exists($file_id, $file_infos)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }

    $csv_columns = [
        'setdate',    // 開始日
        'settime',    // 開始時刻
        'enddate',    // 終了日
        'endtime',    // 終了時刻
        'menu',       // 予定
        'detail',     // 予定詳細
        'memo',       // メモ
    ];
    $csv_columns_num = count($csv_columns);

    $charset = @ $import_option['charset'];
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    $skip_lines = @ $import_option['skip'];

    // スケジュールのインクルード
    require_once('schedule/application.csp');
    $logic = GRN_Schedule_Application::getInstance();

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    $log_params = [];
    $l->noticeEx('import', 'personal_event', $log_params);

    require_once('fw/csv.csp');
    $csv = new CB_CSVReader($charset, $file_infos[$file_id]->getPath());
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    $login_id = $login->getOID();

    require_once('schedule/normal_event_logic.csp');
    while (($line = $csv->readLine()) !== false) {
        if ($skip_lines > 0) {
            $skip_lines--;
            continue;
        }

        if (count($line) < $csv_columns_num) {
            cb_throw_error(E_GRN_SCHD_CSV_INVALID_COLUMNS);
        }

        $event = new GRN_Schedule_NormalEvent();

        $setdate = new CB_Date();

        $str_date = $line[0];
        $str_date = mb_ereg_replace('/', '-', $str_date);
        // 開始日のチェック
        if ( ! $setdate->parse($str_date)
             || ! cb_date_validate_date($setdate)
        ) {
            cb_throw_error(E_GRN_SCHD_INVALID_SETDATE);
        }

        $settime = new CB_Time();
        if (strlen($line[1]) === 0) {
            $event->setdatetime =& $setdate;
        } elseif ( ! $settime->parse($line[1])) {
            cb_throw_error(E_GRN_SCHD_INVALID_SETTIME);
        } else {
            if ( ! cb_date_validate_time($settime)) {
                cb_throw_error(E_GRN_SCHD_INVALID_SETTIME);
            }

            $event->setdatetime = new CB_DateTime();
            $event->setdatetime->year = $setdate->year;
            $event->setdatetime->month = $setdate->month;
            $event->setdatetime->day = $setdate->day;
            $event->setdatetime->hour = $settime->hour;
            $event->setdatetime->minute = $settime->minute;
            $event->setdatetime->second = $settime->second;
        }

        $enddate = new CB_Date();

        $str_date = $line[2];
        $str_date = mb_ereg_replace('/', '-', $str_date);
        // 終了日
        if ( ! $enddate->parse($str_date)
             || ! cb_date_validate_date($enddate)
        ) {
            cb_throw_error(E_GRN_SCHD_INVALID_ENDDATE);
        }

        // 終了時刻
        $endtime = new CB_Time();
        if (strlen($line[3]) === 0) {
            $event->enddatetime =& $enddate;
        } elseif ( ! $endtime->parse($line[3])) {
            cb_throw_error(E_GRN_SCHD_INVALID_ENDTIME);
        } else {
            if ( ! cb_date_validate_time($endtime)) {
                cb_throw_error(E_GRN_SCHD_INVALID_ENDTIME);
            }

            $event->enddatetime = new CB_DateTime();
            $event->enddatetime->year = $enddate->year;
            $event->enddatetime->month = $enddate->month;
            $event->enddatetime->day = $enddate->day;
            $event->enddatetime->hour = $endtime->hour;
            $event->enddatetime->minute = $endtime->minute;
            $event->enddatetime->second = $endtime->second;
        }


        // 開始時刻のみの予定とする
        if (is_a($event->setdatetime, 'CB_DateTime')
            && is_a($event->enddatetime, 'CB_Date')
        ) {
            $event->enddatetime = null;
        }

        // 内容
        $event->menu = $line[4];
        $event->detail = $line[5];
        $event->memo = $line[6];
        $event->private = 0;

        // 参加者
        $event->users = [];
        $event->users[1] = &$login;
        $event->creator = &$login;

        // データのチェック
        $logic->checkEventData($event);
        // データの登録
        $logic->entryEvent($event);

    }

    // セッションデータの後始末
    $session->unset_by('import_option');
    $session->unsetFile('schedule_files', $file_id);


    cb_redirect('personal/application_list', ['app_id' => 'schedule']);
    /*
        } else {
            // if error, show the source form

            //Assign Template Name
            $t->setPageInfo($target_name);

            cb_redirect( 'schedule/personal/import2' );
        }
    */
}
