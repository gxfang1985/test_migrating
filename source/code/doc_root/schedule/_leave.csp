<?php

//------------------

$user_id = @ $G_INPUT['uid'];
$group_id = @ $G_INPUT['gid'];
$str_date = @ $G_INPUT['bdate'];
$event_id = @ $G_INPUT['event'];

require_once('schedule/application.csp');
$app = GRN_Schedule_Application::getInstance();
require_once('schedule/view_util.csp');
$util = GRN_Schedule_View_Util::getInstance();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');

$login = $uum->getLoginUser();
$login_id = $login->getOID();

$date = new CB_Date();
if ( ! $date->parse($str_date)) {
    $date = null;
}

$event = $app->getEvent($login, $event_id, $date);
if ( ! $event) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
}
$participation = false;
$index_current_user = -1;
if (is_array($event->users) && count($event->users) > 0) {
    foreach (array_keys($event->users) as $key) {
        $_user = &$event->users[$key];
        if ($_user->getOID() == $login_id) {
            $participation = $login_id;
            $index_current_user = $key;
            break;
        }
    }
}
if ($participation === false) {
    cb_throw_error(E_GRN_SCHD_LEAVE);
}

unset($event->users[$index_current_user]);
if (count($event->users) == 0) {
    $event->users = null;
}
$app->checkEventData($event);
if ( ! $date) {
    $date = $event->setdatetime;
}

/* -------------- VCBSCH0010 START ----------------- */
require_once('schedule/netmeeting_event_logic.csp');
$vcb_event_logic = GRN_Netmeeting_EventLogic::getInstance();

// NETMEETING連携あり
if ($vcb_event_logic->isNetmeetingAvailable($event)) {
    // 選択されている施設がある場合
    $vcb_facility = $vcb_event_logic->getNetmeetingFacilityById($event);
    if (isset($vcb_facility)) {
        // 連携データ取得
        $coop_data
            = $vcb_event_logic->getNetmeetingCoopDataByEventId($event_id);

        // 連携データあり
        if (isset($coop_data)) {
            // 連携が正常終了している場合
            if ($coop_data->cooperation_status
                == GRN_NETMEETING_COOPERATION_STATUS_COMPLETE
            ) {
                // 時間のチェック
                $event_status
                    = $vcb_event_logic->getEventStatus($event->setdatetime,
                    $event->enddatetime);

                if ($event_status !== GRN_NETMEETING_MEETING_STATUS_END) {
                    $t->assign('netmeeting', true);
                }
            }
        }
    }
}
/* -------------- VCBSCH0010 END   ----------------- */

$t->assign(
    'schedule_event', [
        'event_id' => $event->id,
        //予定のID
        'type'     => $util->getViewEventType($event->getEventType(),
            $event->isShared()),
        //予定の種類
        'date'     => $date->format(),
        //予定の日付
        'str_date' => cb_date_format('DateFull_YMDW', $date),
        //予定の日付
        'data'     => html_entity_decode($event->getTitle()),
        //予定のタイトル
    ]
);
$t->assign('user_id', $user_id);
$t->assign('group_id', $group_id);
$t->assign('bdate', $date);

$referer_key = array_key_exists('referer_key', $G_INPUT)
    ? $G_INPUT['referer_key'] : null;
$referer_exists = false;
if ($referer_key) {
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('schedule.referer');
    $referer = $session->get($referer_key);
    if (is_array($referer)) {
        // page title
        $page_title = grn_get_current_page_display_name();
        $t->assign('page_title', $page_title);
        // site position 
        $t->assign(
            'site_position', [
                $referer,
                [
                    'page'        => "schedule/view",
                    'name'        => grn_get_page_display_name('schedule/view'),
                    'event'       => $event_id,
                    'bdate'       => $str_date,
                    'referer_key' => $referer_key
                ],
                ['page' => "", 'name' => $page_title]
            ]
        );
        $referer_exists = true;
    }
}

if ($referer_exists === false) {
    // page title
    $page_title = grn_get_current_page_display_name();
    $t->assign('page_title', $page_title);
    // site position 
    $t->assign(
        'site_position', [
            [
                'page' => 'schedule/index',
                'name' => grn_get_page_display_name('schedule/schedule_index')
            ],
            [
                'page'  => 'schedule/view',
                'name'  => grn_get_page_display_name('schedule/view'),
                'bdate' => $str_date,
                'event' => $event_id,
                'uid'   => $user_id,
                'gid'   => $group_id
            ],
            ['page' => '', 'name' => $page_title]
        ]
    );
}

$t->assign('referer_key', $referer_key);

