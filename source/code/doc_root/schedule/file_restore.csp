<?php
//GTM-1136

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('schedule/error_code.csp');

require_once('schedule/system_logic.csp');
$systemlogic = GRN_Schedule_SystemLogic::getInstance();
if ($systemlogic->getAllowFileAttachment() != '1') {
    cb_throw_error(E_GRN_SCHD_DEACTIVATED_FILE);
}

$event_id = cb_at($G_INPUT, 'event');
if ( ! $event_id) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
}

require_once('schedule/application.csp');
$app = GRN_Schedule_Application::getInstance();
$login = cb_get_login_user();
if ( ! ($event = $app->getEvent($login, $event_id))) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
}

require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_Logic::getInstance();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$dynamic_roles = $uum->listGrantedRoles();

$access = $acc_logic->getEventAccess($login, $event, ['read', 'modify'],
    $dynamic_roles);
if ($access['read'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_FILE_VIEW);
}
if ($access['modify'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_FILE_MODIFY);
}

$t->assign('event_id', $event_id);

$file_id = cb_at($G_INPUT, 'fid');
if ( ! $file_id) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_FILE);
}

require_once('schedule/file.csp');
$fm = GRN_Schedule_FileManager::getInstance();
if ( ! ($file = $fm->getFile($event_id, $file_id))) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_FILE);
}

$t->assign('file_id', $file_id);

$restore_version = cb_at($G_INPUT, 'ver');

$linkparams = [];
$linkparams['event'] = $event_id;

$t->assign('linkparams', $linkparams);

require_once('grn/controller.csp');
$utility = new GRN_ControllerUtil();

$restore_for_view = $utility->getFileRestoreView($file, $restore_version);
$t->assign('restore', $restore_for_view);

$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$t->assign(
    'site_position', [
        [
            'page' => 'schedule/index',
            'name' => grn_get_page_display_name('schedule/schedule_index')
        ],
        [
            'page'  => "schedule/view",
            'name'  => grn_get_page_display_name('schedule/view'),
            'event' => $event_id
        ],
        [
            'page'  => "schedule/file_view",
            'name'  => grn_get_page_display_name('schedule/file_view'),
            'event' => $event_id,
            'fid'   => $file_id
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

$t->display(cb_get_pagename() . ".tpl");
