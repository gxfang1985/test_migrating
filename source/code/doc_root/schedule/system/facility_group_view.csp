<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'schedule');

$fagid = @ $G_INPUT['fagid'];

require_once('schedule/facility_system_logic.csp');
$fsl = GRN_Facility_SystemLogic::getInstance();

$facilitygroup = $fsl->getFacilityGroup($fagid);
if ($facilitygroup === false) {
    cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITYGROUP);
}


$view_data = [];
$view_data['fagid'] = $fagid;
$view_data['title'] = $facilitygroup->get('name');

$view_data['ctime'] = $facilitygroup->get('ctime');
$creator = $facilitygroup->get('creator');
if ( ! $creator) {
    $view_data['creator_name'] = $facilitygroup->get('creator_name');
} else {
    $view_data['creator_uid'] = $creator->getOID();
}
$view_data['mtime'] = $facilitygroup->get('mtime');
$modifier = $facilitygroup->get('modifier');
if ( ! $modifier) {
    $view_data['modify_name'] = $facilitygroup->get('modifier_name');
} else {
    $view_data['modify_uid'] = $modifier->getOID();
}

$facilities = $fsl->getGroupFacilities($fagid);
$temp = [];
foreach (array_keys($facilities) as $faid) {
    $facility = $facilities[$faid];
    if ( ! $facility) {
        continue;
    }

    $temp[$faid] = ['faid' => $faid, 'title' => $facility->get('name')];
}

if (is_array($facilities)) {
    $view_data['count'] = count($facilities);
} else {
    $view_data['count'] = 0;
}
$view_data['facility'] = $temp;

$ancestors = [];
$tmp_facilitygroup = $facilitygroup->get('parent');
for ($i = 0; $i < GRN_SCHD_MAX_FACILITY_GROUP_TREE - 1; $i++) {
    if ( ! $tmp_facilitygroup) {
        break;
    }
    $ancestors[] = ['title' => $tmp_facilitygroup->get('name')];
    $tmp_facilitygroup = $tmp_facilitygroup->get('parent');
}

$view_data['code'] = $facilitygroup->get('foreign_key');
$view_data['memo'] = $facilitygroup->get('memo');

$view_data['ancestors'] = array_reverse($ancestors);
$t->assign('facility_group', $view_data);

$t->assign('is_movable', $fsl->isMovable($fagid));

// page title
$page_title = grn_get_current_page_display_name();
if (isset($view_data['title'])) {
    $t->assign('page_title', $view_data['title']);
} else {
    $t->assign('page_title', $page_title);
}
// site position
$t->assign(
    'site_position', [
        [
            'page' => "schedule/system/facility_group",
            'name' => grn_get_page_display_name('schedule/system/facility_group'),
            'sf'   => '1',
            'oid'  => $fagid
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


