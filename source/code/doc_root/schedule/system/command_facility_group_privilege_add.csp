<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    //unset( $G_INPUT['add'] );
    $node_id = @ $G_INPUT['nid'];
    if (0 == strlen($node_id)) {
        assert('FALSE');
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();

    $session_name = 'schedule.system.facility_group_privilege_add';
    $session =& $session_manager->getSession($session_name);

    require_once('_access_util.csp');

    $aid = $session->get('target_ids');
    $func = @ $G_INPUT['func'];
    if ( ! is_array($aid) || $func == 'search') {
        unset($G_INPUT['aid']);
        unset($G_INPUT['func']);
        cb_redirect('schedule/system/facility_group_privilege_list', $G_INPUT);
    }

    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();

    require_once('schedule/facility_privilege.csp');
    $privilege_logic = GRN_Facility_Privilege_Logic::getInstance();

    $nid = null;
    if (array_key_exists('nid', $G_INPUT)) {
        $nid = $G_INPUT['nid'];
    }

    $facilitygroup = $facility_logic->getFacilityGroup($nid);
    if ($facilitygroup === false) {
        cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITYGROUP);
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');

    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $dynamic_roles = $uum_util->listDynamicRoles();

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);

    $object_id = $facilitygroup->getOID();
    $object_name = $facilitygroup->get('name');

    foreach (array_keys($aid) as $item) {
        $ids = explode(':', $item);
        if (count($ids) < 2) {
            continue;
        }
        $id = $ids[1];
        switch ($ids[0]) {
            case 'user':
                if (($target = &$uum->getUser($id))) {
                    $privilege_logic->setPrivilege($facilitygroup, $target,
                        'user');
                    // 監査ログ
                    $log_params = [
                        'fgid'          => $object_id,
                        'uid'           => $id,
                        'facilitygroup' => $object_name
                    ];
                    $l->noticeEx('create', 'privilege', $log_params);
                }
                break;

            case 'group':
                if (($target = &$uum->getGroup($id))) {
                    $privilege_logic->setPrivilege($facilitygroup, $target,
                        'group');
                    // 監査ログ
                    $log_params = [
                        'fgid'          => $object_id,
                        'oid'           => $id,
                        'facilitygroup' => $object_name
                    ];
                    $l->noticeEx('create', 'privilege', $log_params);
                }
                break;

            case 'static_role':
                if (($target =& $uum->getStaticRole($id))) {
                    $privilege_logic->setPrivilege($facilitygroup, $target,
                        'static_role');
                    // 監査ログ
                    $log_params = [
                        'fgid'          => $object_id,
                        'rid'           => $id,
                        'facilitygroup' => $object_name
                    ];
                    $l->noticeEx('create', 'privilege', $log_params);
                }
                break;

            case 'dynamic_role':
                if (array_key_exists($id, $dynamic_roles)) {
                    $privilege_logic->setPrivilege($facilitygroup, $id,
                        'dynamic_role');
                    // 監査ログ
                    $log_params = [
                        'fgid'          => $object_id,
                        'dynamic_role'  => $id,
                        'facilitygroup' => $object_name
                    ];
                    $l->noticeEx('create', 'privilege', $log_params);
                }
                break;
        }
    }

    $params = $G_INPUT;
    unset($params['aid']);
    unset($params['func']);

    cb_redirect('schedule/system/facility_group_privilege_list', $params);
}


