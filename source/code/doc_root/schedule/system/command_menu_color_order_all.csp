<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;
    require_once('schedule/system_logic.csp');
    $logic = GRN_Schedule_SystemLogic::getInstance();
    $cur_menus = $logic->getMenus();
    $menus = $G_INPUT['order'];
    $menus_serialize = [];

    if (is_array($menus)
        && count($menus) > 0
    )//reorder screen, the format text;#color;#index
    {
        foreach ($menus as $menu) {
            if (preg_match('/(.*)(;#)(\d+)$/', $menu, $matches)) {
                if (preg_match('/(.*)(;#)(\d+)$/', $matches[1], $matches1)) {
                    $menus_serialize[] = [
                        $matches1[1],
                        $matches1[3]
                    ];//menuName, menucolor
                }
            }
        }
    }
    foreach ($menus_serialize as $key => $value) {
        if ( ! in_array($value, $cur_menus)) {
            cb_throw_error(E_GRN_SCHD_MENU_ITEM_NOT_FOUND);
            unset($menus_serialize[$key]);
        }
    }
    $logic->setMenus($menus_serialize, true);
    //logging for reorder menu-color
    $action_log = 'config';
    $log_name = 'reorder_menu';
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    $log_params = [];
    foreach ($menus_serialize as $key => $value) {
        $log_params[] = $value[0];
    }
    $strlog = "[" . $action_log . "] " . $log_name . "('" . implode("','",
            $log_params) . "')";
    $l->noticeEx($action_log, $log_name, $strlog);
    cb_redirect('schedule/system/menu_set');
}
