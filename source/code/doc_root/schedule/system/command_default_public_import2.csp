<?php

use grn\schedule\ScheduleDefaultPublicLogic;

if (strcasecmp(@ $_SERVER["REQUEST_METHOD"], "POST") == 0) {
    global $G_INPUT;
    $file_id = cb_at($G_INPUT, "file_id");

    require_once("fw/session_manager.csp");
    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession("schedule/system/default_public_import1");
    $files = $session->getFiles("import_files");

    // If the file does not exist.
    if ( ! is_array($files)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }
    if ( ! array_key_exists($file_id, $files)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }

    $file_path = $files[$file_id]->getPath();
    ScheduleDefaultPublicLogic::getInstance()
                              ->importFromCSV($G_INPUT, $file_path);

    foreach (array_keys($files) as $id) {
        $session->unsetFile("import_files", $id);
    }

    cb_redirect("schedule/system/import_index");
}
