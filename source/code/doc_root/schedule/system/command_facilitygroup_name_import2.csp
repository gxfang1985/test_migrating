<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // -------- 
    // brabrabra after success
    // --------
    require_once('schedule/error_code.csp');

    $file_id = @ $G_INPUT['file_id'];

    // セッションに関連付けてあったファイルを取得する。
    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession('schedule/system/facilitygroup_name_import1');
    $file_infos = $session->getFiles('facilitygroup_name_files');
    $import_option = $session->get('import_option');

    // ファイルがない
    if ( ! is_array($file_infos)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }
    if ( ! array_key_exists($file_id, $file_infos)) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }
    if ( ! $file_infos[$file_id]->exists()) {
        cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
    }

    $charset = @ $import_option['charset'];
    $skip = @$import_option['skip'] ? intval($import_option['skip']) : 0;

    // CSVの読み込み
    require_once('schedule/facility_system_logic.csp');
    $facilityLogic = GRN_Facility_SystemLogic::getInstance();
    $facilityLogic->importFacilitygroupNameWithCSV($file_infos[$file_id]->getPath(),
        $charset, $skip);

    //ファイルの削除
    foreach (array_keys($file_infos) as $id) {
        $session->unsetFile('facilitygroup_name_files', $id);
    }

    cb_redirect('schedule/system/import_index');
}

