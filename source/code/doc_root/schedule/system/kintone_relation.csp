<?php

use grn\kintone\AppRelationSettingLogic;

require_once("grn/smarty.csp");
$t = new GRN_Smarty();

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

require_once('kintone/Logic.csp');
require_once('fw/slash_util.csp');
if ( ! GRN_Kintone_Logic::isAvailable()
     || ! CB_SlashUtil::isGaiaLicenseapiRequest()
) {
    cb_throw_error(E_GRN_LICENSE_EXPIRED);
}

require_once('schedule/system_logic.csp');
$systemlogic = GRN_Schedule_SystemLogic::getInstance();

$temp_menus = $systemlogic->getMenus();
$system_setting_appointment_menus = [];


foreach ($temp_menus as $value) {
    $system_setting_appointment_menus[$value[0]] = $value[0];
}

/**
 * prepare relation setting data for tpl
 */
$appRelationLogic = new AppRelationSettingLogic();
$settings = $appRelationLogic->getAllRelationSettings('schedule/add');
foreach ($settings as $key => $value) {
    $allMenu = cb_at($value, 'allMenu');
    if ( ! is_null($allMenu)) {
        $settings[$key]['menus'] = cb_msg('grn.schedule.system',
            'all_appointment_type');
        unset($settings[$key]['allMenu']);
    }

    $menus = cb_at($value, 'menus');
    if (is_array($menus)) {
        foreach ($menus as $menusK => $menusV) {
            if ( ! array_key_exists($menusV,
                $system_setting_appointment_menus)
            ) {
                $menus[$menusK] = '-----';
            }
        }
        $settings[$key]['menus'] = implode(',', $menus);
    }

    foreach ($value['kintone_app'] as $k => $v) {
        $field_code = cb_at($v, 'field_code');
        if (is_array($field_code)) {
            $settings[$key]['kintone_app'][$k]['field_code'] = implode(',',
                $field_code);
        }
    }
}
$t->assign('relation_info', $settings);


$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$t->assign('site_position', [['page' => '', 'name' => $page_title]]);
$t->display(cb_get_pagename() . ".tpl");
