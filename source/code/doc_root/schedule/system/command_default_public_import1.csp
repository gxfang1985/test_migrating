<?php

if (strcasecmp(@ $_SERVER["REQUEST_METHOD"], "POST") == 0) {
    // get parameters from URL parameters
    global $G_INPUT;
    $charset = cb_at($G_INPUT, "charset");
    $skip = cb_at($G_INPUT, "skip");

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $smarty = new GRN_Smarty;

    // Validation check
    require_once("SmartyValidate.class.php");
    SmartyValidate::connect($smarty);
    $target_name = "schedule/system/default_public_import1";
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        require_once("fw/session_manager.csp");

        $session_manager = CB_SessionManager::getInstance();
        $session
            = $session_manager->getSession("schedule/system/default_public_import1");
        $file_infos = $session->getFiles("import_files");
        if (is_array($file_infos)) {
            foreach (array_keys($file_infos) as $id) {
                $session->unsetFile("import_files", $id);
            }
        }

        $file = $_FILES["file"];
        if ($file["error"]) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }

        // save the attached files with session.
        $file_id = $session->addFile("import_files", $file);

        SmartyValidate::unregister_form($target_name);

        cb_redirect("schedule/system/default_public_import2"
            , [
                "charset" => $charset
                ,
                "skip"    => $skip
                ,
                "file"    => $file_id
            ]);

    } else {

        include("_default_public_import1.csp");

        $smarty->setPageInfo($target_name);

        $smarty->assign("charset", $charset);
        $smarty->assign("skip", $skip);

        $smarty->display("{$target_name}.tpl");
    }

}
