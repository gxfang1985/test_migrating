<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    // GET/POSTされたパラメータを取得する
    $biid = null;
    if (array_key_exists('biid', $G_INPUT)) {
        $biid = $G_INPUT['biid'];
    }
    $eiid = null;
    if (array_key_exists('eiid', $G_INPUT)) {
        $eiid = $G_INPUT['eiid'];
    }

    // GET/POSTされたパラメータを取得する
    $properties = [];
    $properties['display'] = @ $G_INPUT['display'];

    // ログインユーザーを取得する
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }
    $login_id = $login->getOID();

    require_once('schedule/facility_system_logic.csp');
    $system_logic = GRN_Facility_SystemLogic::getInstance();


    if (0 < strlen($biid)) {
        // 組み込み項目情報を変更する
        //$properties['display']
        list($title_purpose, $title_name)
            = $system_logic->getFacilityTitleEach();

        if ($biid == 'title_purpose') {
            $title_purpose = $properties['display'];
        } elseif ($biid == 'title_name') {
            $title_name = $properties['display'];
        }

        $system_logic->setFacilityTitleEach($title_purpose, $title_name);

        cb_redirect('schedule/system/item_list');
    } elseif (0 < strlen($eiid)) {
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        $target_name = 'schedule/system/item_modify';
        SmartyValidate::register_form($target_name);


        if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
            require_once('fw/string_util.csp');
            $properties['display_name']
                = cb_trim_check(@ $G_INPUT['display_name'],
                E_COMMON_MISSING_MANDATORY);
            $properties['id'] = cb_trim_check(@ $G_INPUT['id'],
                E_COMMON_MISSING_MANDATORY);
            $properties['type'] = @ $G_INPUT['type'];
            $properties['item_menu_textarea']
                = @ $G_INPUT['item_menu_textarea'];
            $properties['item_menu_text'] = @ $G_INPUT['item_menu_text'];
            $properties['use'] = @ $G_INPUT['use'];
            $properties['display_item_name'] = @ $G_INPUT['display_item_name'];

            // 拡張項目情報を変更する
            if ( ! $system_logic->setItemProperties($eiid, $properties)) {
                cb_throw_error(E_GRN_DUPLICATE_USER_COLUMN_ID, null,
                    ['id' => $properties['id']]);
            }

            // 監査
            require_once('schedule/inspection.csp');
            $inspection = GRN_Schedule_Inspection::getInstance();

            if ($inspection->isEnabled()) {
                if (is_null($properties['use'])) {
                    $properties['use'] = '0';
                }
                if (is_null($properties['display'])) {
                    $properties['display'] = '0';
                }
                if (is_null($properties['display_item_name'])) {
                    $properties['display_item_name'] = '0';
                }
                $inspection->record('modify', 'facility_item',
                    [
                        'eiid'              => $eiid,
                        'display_name'      => $properties['display_name'],
                        'id'                => $properties['id'],
                        'type'              => $properties['type'],
                        'use'               => $properties['use'],
                        'display'           => $properties['display'],
                        'display_item_name' => $properties['display_item_name']
                    ]
                );
            }

            SmartyValidate::unregister_form($target_name);

            cb_redirect('schedule/system/item_list');
        } else {
            $t->setPageInfo($target_name);
            include('_item_modify.csp');
            $t->display($target_name . '.tpl');
        }
    }
}
