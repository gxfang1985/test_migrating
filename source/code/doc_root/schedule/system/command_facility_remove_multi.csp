<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('schedule/facility_system_logic.csp');
    $fsl = GRN_Facility_SystemLogic::getInstance();

    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();

    $org_id = @ $G_INPUT['oid'];
    // set modification timestamp
    $group = $fsl->getFacilityGroup($org_id);
    if ($group !== false) {
        $fsl->setLastModifyTime($login, $group);
    }

    $fid = @ $G_INPUT['fid'];

    if ( ! is_array($fid)) {
        $fid = [$fid];
    }
    $facilities = $fsl->getFacilitiesInfo($fid, CB_DATABASE_NO_LOCK);
    $nonGroup = null;
    foreach ($facilities as $facility) {
        $fsl->moveFacility($login, $facility['_id'], $nonGroup);
    }

    cb_redirect('schedule/system/facility_group', ['oid' => $org_id]);
}
