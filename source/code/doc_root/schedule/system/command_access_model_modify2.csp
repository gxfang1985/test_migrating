<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once '_access_util.csp';
    $security_model = @ $G_INPUT['security_model'];

    //--check
    if ($security_model != 'revoke' && $security_model != 'grant') {
        cb_throw_error(E_GRN_SCHD_ACCESS_INVALID_SECURITY_MODEL);
    }

    // access object
    $object = grn_get_schedule_access_object($target, $org_id, $user_id,
        $role_id, $facility_id, $fgroup_id);

    // access information
    require_once('schedule/access_logic.csp');
    $sal = GRN_Schedule_Access_Logic::getInstance();
    $sal->setSecurityModel($object, $security_model);

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    if (is_a($object, 'CB_User')) {
        $log_params = [
            'uid'            => $object->getOID(),
            'security_model' => $security_model
        ];
        $l->noticeEx('modify', 'access', $log_params);
    } elseif (is_a($object, 'CB_Group')) {
        $log_params = [
            'oid'            => $object->getOID(),
            'security_model' => $security_model
        ];
        $l->noticeEx('modify', 'access', $log_params);
    } elseif (is_a($object, 'CB_Role')) {
        $log_params = [
            'rid'            => $object->getOID(),
            'security_model' => $security_model
        ];
        $l->noticeEx('modify', 'access', $log_params);
    } elseif (is_a($object, 'GRN_Facility_Facility')) {
        $log_params = [
            'fid'            => $object->getOID(),
            'security_model' => $security_model
        ];
        $l->noticeEx('modify', 'access', $log_params);
    } elseif (is_a($object, 'GRN_Facility_FacilityGroup')) {
        $log_params = [
            'fgid'           => $object->getOID(),
            'security_model' => $security_model
        ];
        $l->noticeEx('modify', 'access', $log_params);
    }

    $params = $G_INPUT;
    unset($params['security_model']);
    $params['reset'] = 1;
    cb_redirect('schedule/system/access_list', $params);
}

