<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'schedule');

//-- set page title and site position
require('SmartyValidate.class.php');
SmartyValidate::connect($t);

require_once('schedule/error_code.csp');
//------------------
$file_id = @ $G_INPUT['file_id'];
if ( ! $file_id) {
    cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
}
// セッションに関連付けてあったファイルを取得する。
$session_manager = CB_SessionManager::getInstance();
$session
    =& $session_manager->getSession('schedule/system/facility_import1');
$file_infos = $session->getFiles('facility_files');
$import_option = $session->get('import_option');

// ファイルがない
if ( ! is_array($file_infos)) {
    cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
}


if ( ! array_key_exists($file_id, $file_infos)) {
    cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
}

if ( ! $file_infos[$file_id]->exists()) {
    cb_throw_error(E_GRN_SCHD_NOT_FOUND_CSV_FILE);
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($import_option['charset'],
    $file_infos[$file_id]->getPath());

$skip = @ $import_option['skip'];
if ( ! $skip) {
    $skip = 0;
} else {
    $skip = 1;
}

$line = 0;
$records = [];
while (($cols = $csv->readLine())) {
    if ($skip > 0) {
        $skip--;
        continue;
    }

    $records[] = $cols;
    $line++;

    if ($line == 5) {
        break;
    }
}

$t->assign('csv_datas', $records);
$t->assign('file_id', $file_id);
$t->assign('skip', $import_option['skip']);
$t->assign('charset', $import_option['charset']);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => 'schedule/system/import_index',
            'name' => grn_get_page_display_name('schedule/system/import_index')
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

