<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // GET/POSTされたパラメータを取得する
    $iids = @ $G_INPUT['iid'];
    if (0 < count($iids)) {
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');

        // ログインユーザーを取得する
        $login = $uum->getLoginUser();
        if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
            cb_throw_error(E_GRN_USER_NOT_FOUND);
        }
        $login_id = $login->getOID();

        require_once('schedule/facility_system_logic.csp');
        $system_logic = GRN_Facility_SystemLogic::getInstance();

        // 拡張項目一覧の表示順番を変更する
        $items = $system_logic->listItems();

        foreach ($iids as $list_index => $item_id) {
            $properties = ['list_index' => $list_index];
            if ( ! $system_logic->setItemProperties($item_id, $properties)) {
                cb_throw_error(E_GRN_FCLT_EXTENDED_ITEM_NOT_FOUND);
            }

            // 監査
            $item = $items[$item_id];

            require_once('schedule/inspection.csp');
            $inspection = GRN_Schedule_Inspection::getInstance();

            if ($inspection->isEnabled()) {
                $inspection->record('order', 'facility_item',
                    [
                        'eiid'       => $item_id,
                        'list_index' => $properties['list_index']
                    ]
                );
            }
        }
    }
    cb_redirect('schedule/system/item_list');
}


