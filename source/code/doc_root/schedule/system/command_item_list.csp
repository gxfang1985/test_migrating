<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // --------
    // brabrabra after success
    // --------
    require_once('schedule/facility_system_logic.csp');
    $logic = GRN_Facility_SystemLogic::getInstance();

    // 予定内容
    $title_purpose = @ $G_INPUT['title_purpose'];
    if ( ! $title_purpose) {
        $title_purpose = '0';
    }

    // 登録者
    $title_name = @ $G_INPUT['title_name'];
    if ( ! $title_name) {
        $title_name = '0';
    }

    // 組み込み項目の設定を変更する
    $logic->setFacilityTitleEach($title_purpose, $title_name);

    // カスタマイズ項目取得
    $items = $logic->listItems();

    // カスタマイズ項目情報一覧の設定を変更する
    $extended_items = @ $G_INPUT['extended_items'];

    $keys = [
        'use',
        'display',
        'display_item_name'
    ];

    // 監査
    require_once('schedule/inspection.csp');
    $inspection = GRN_Schedule_Inspection::getInstance();

    foreach (array_keys($items) as $item_id) {
        $extended_item =& $extended_items[$item_id];

        $properties = [];
        foreach ($keys as $key) {
            $properties[$key] = @ $extended_item[$key];
        }
        $logic->setItemProperties($item_id, $properties);

        // 監査する
        $item = $items[$item_id];

        if ($inspection->isEnabled()) {
            if (is_null($properties['use'])) {
                $properties['use'] = '0';
            }
            if (is_null($properties['display'])) {
                $properties['display'] = '0';
            }
            if (is_null($properties['display_item_name'])) {
                $properties['display_item_name'] = '0';
            }
            $inspection->record('modify', 'facility_item',
                [
                    'eiid'              => $item_id,
                    'display_name'      => $item['display_name'],
                    'id'                => $item['id'],
                    'type'              => $item['type'],
                    'use'               => $properties['use'],
                    'display'           => $properties['display'],
                    'display_item_name' => $properties['display_item_name']
                ]
            );
        }
    }

    cb_redirect('system/application_list', ['app_id' => 'schedule']);
}
