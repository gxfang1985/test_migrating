<?php
/**
 * システム設定 V-CUBE連携の設定
 *
 * @create:
 *    2011/06/08 VCBSCH0010 Sync for V-CUBE
 */

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {


    require_once('schedule/netmeeting_resources.csp');
    require_once('schedule/error_code.csp');

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'schedule/system/netmeeting_set';
    SmartyValidate::register_form($target_name);

    // **$G_INPUTから値を取得
    // V-CUBE連携
    $available = @ $G_INPUT['available'];
    if ( ! $available) {
        $available = '0';
    }
    // 招待URLの表示
    $invite_url_schedule_display = @ $G_INPUT['invite_url_schedule_display'];
    if ( ! $invite_url_schedule_display) {
        $invite_url_schedule_display = '0';
    }
    // 招待URLのE-mail通知
    $invite_url_email_notification
        = @ $G_INPUT['invite_url_email_notification'];
    if ( ! $invite_url_email_notification) {
        $invite_url_email_notification = '0';
    }
    // 外部招待者入力欄表示行数
    $outside_member_input_rows = @ $G_INPUT['outside_member_input_rows'];
    // 招待者タイプの使用
    $outside_guest_type_display = @ $G_INPUT['outside_guest_type_display'];
    if ( ! $outside_guest_type_display) {
        $outside_guest_type_display = '0';
    }
    // V-CUBEシステムURL
    $netmeeting_meeting_system_url
        = @ $G_INPUT['netmeeting_meeting_system_url'];
    // ログインID
    $netmeeting_login_id = @ $G_INPUT['netmeeting_login_id'];
    // パスワード
    $netmeeting_login_password = @ $G_INPUT['netmeeting_login_password'];
    $netmeeting_vcube_version = cb_at($G_INPUT, 'netmeeting_vcube_version',
        null);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        require_once('schedule/netmeeting_system_logic.csp');
        $logic = GRN_NETMEETING_SystemLogic::getInstance();

        // 外部招待者入力欄表示件数を整数にする。
        $outside_member_input_rows = (int)$outside_member_input_rows;


        // **実際の保存
        $logic->setNetmeetingAvailable($available);                        // V-CUBE利用の有無
        $logic->setNetmeetingUrlDisplay($invite_url_schedule_display);     // 招待URLの表示
        $logic->setNetmeetingUrlMailSend($invite_url_email_notification);  // 招待URLのE-mail通知
        $logic->setNetmeetingOutsideMemberInputRows($outside_member_input_rows);   // 外部招待者入力欄表示行数

        $logic->setNetmeetingURL($netmeeting_meeting_system_url);               // V-CUBEシステムURL
        $logic->setNetmeetingLoginId($netmeeting_login_id);                     // V-CUBEログインID
        $logic->setNetmeetingVcubeVersion($netmeeting_vcube_version);

        // V-CUBEパスワード（入力されている場合のみ更新する。)
        if (strcmp($netmeeting_login_password, '***************') !== 0) {
            $logic->setNetmeetingLoginPassword($netmeeting_login_password);
        }

        // ログイン確認
        if ($available) {
            require_once('schedule/netmeeting_sync_logic.csp');
            $sync_logic = GRN_Netmeeting_SyncLogic::getInstance();
            if ($sync_logic->netmeeting_login(true)
                === false
            )            //-- Upd VCBSCH0040
            {
                require_once('schedule/netmeeting_error_code.csp');
                cb_throw_error(E_GRN_NETMEETING_LOGIN_ERROR);
            }
        }

        // 監査ログ
        require_once('grn/logger.csp');
        $lm = CB_LoggerManager::getInstance();
        $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);

        $log_params = [];
        if ($available == '1') {
            $log_params['available'] = 'ON';
        } else {
            $log_params['available'] = 'OFF';
        }

        $log_params['netmeeting_version'] = $netmeeting_vcube_version;

        if ($invite_url_schedule_display == '1') {
            $log_params['invite_url_schedule_display'] = 'ON';
        } else {
            $log_params['invite_url_schedule_display'] = 'OFF';
        }

        if ($invite_url_email_notification == '1') {
            $log_params['invite_url_email_notification'] = 'ON';
        } else {
            $log_params['invite_url_email_notification'] = 'OFF';
        }

        $log_params['outside_member_input_rows'] = $outside_member_input_rows;

        $log_params['netmeeting_meeting_system_url']
            = $netmeeting_meeting_system_url;

        $log_params['netmeeting_login_id'] = $netmeeting_login_id;

        $log_params['netmeeting_login_password'] = $netmeeting_login_password;

        $l->noticeEx('config', 'netmeeting', $log_params);

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        cb_redirect('system/application_list', ['app_id' => 'schedule']);

    } else {
        $t->setPageInfo($target_name);
        require_once('_netmeeting_set.csp');
        $t->display($target_name . '.tpl');
    }

}

