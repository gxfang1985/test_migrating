<?php

$faid = @ $G_INPUT['faid'];

require_once('schedule/facility_system_logic.csp');
$system_logic = GRN_Facility_SystemLogic::getInstance();
$facility = $system_logic->getFacility($faid);

if ($facility === false) {
    cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITY);
}

$view_data = [];
$view_data['faid'] = $faid;
$view_data['code'] = $facility->get('foreign_key');
$view_data['memo'] = $facility->get('memo');

// 所属している施設グループを最上位まで辿る
$affiliationGroup = $system_logic->getFacilityAffiliationGroup($faid);
$ancestors = [];
for ($i = 0; $i < GRN_SCHD_MAX_FACILITY_GROUP_TREE; $i++) {
    if ($affiliationGroup) {
        $ancestors[] = ['title' => $affiliationGroup->get('name')];
        $affiliationGroup = $affiliationGroup->get('parent');   //上書き
    } else {
        break;
    }
}
$view_data['ancestors'] = array_reverse($ancestors);

$t->assign('facility', $view_data);


require_once('schedule/resources.csp');
$localeValues = $system_logic->createFacilityMultiLanguageValuesArray($faid);
$multiLanguageInfoArray = [];
$multiLanguageInfoArray['element_name'] = GRN_SCHEDULE_ELEMENT_NAME_FACILITY;
$multiLanguageInfoArray['values'] = $localeValues;
$t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);


//--- add VCBSCH0010 ---s
$netmeeting_data = [];

// システムのV-CUBEを使用可否を取得
require_once('schedule/netmeeting_system_logic.csp');
$netmeeting_system_logic = GRN_Netmeeting_SystemLogic::getInstance();
$netmeeting_system_available
    = $netmeeting_system_logic->getNetmeetingAvailable();
if ( ! $netmeeting_system_available) {
    $available = '0';
}
$netmeeting_data['system_available'] = $netmeeting_system_available;

// 施設のV-CUBEの情報を取得
$netmeeting_data['available']
    = $facility->get('netmeeting_available');                // V-CUBE連携可否
$netmeeting_data['guests_normal_limit']
    = $facility->get('netmeeting_guests_normal_limit');      // 通常ユーザー招待人数の上限

// V-CUBEの使用情報セット
$t->assign('netmeeting', $netmeeting_data);
//--- add VCBSCH0010 ---e

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => 'schedule/system/facility_group',
            'name' => grn_get_page_display_name('schedule/system/facility_group'),
            'sf'   => '1'
        ],
        [
            'page' => "schedule/system/facility_view",
            'name' => grn_get_page_display_name('schedule/system/facility_view'),
            'faid' => $faid
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

