<?php
require_once('grn/smarty.csp');
$t = new GRN_Smarty();

require_once('schedule/facility_system_logic.csp');
$fsl = GRN_Facility_SystemLogic::getInstance();

$is_search = array_key_exists('search_text', $G_INPUT);
$search_text = @ $G_INPUT['search_text'];

$result = $fsl->searchFacilityGroupsInfo($search_text);

$ancestors = $fsl->getAncestors($result);
$fgroups_list = [];
foreach ($ancestors as $ancestor) {
    foreach ($ancestor as $a) {
        $fgroups_list[$a] = $a;
    }
}
$fgroups_info = $fsl->getFacilityGroupsInfo($fgroups_list);
$search_result = [];
foreach (array_keys($result) as $r_id) {
    $values = ['fagid' => $r_id];
    $values['ancestor'] = [];
    foreach ($ancestors[$r_id] as $a) {
        $values['ancestor'][] = $fgroups_info[$a];
    }
    $values['ancestor'] = array_reverse($values['ancestor']);
    $search_result[] = $values;
}
$t->assign('search_text', $search_text);
$t->assign('search_result', $search_result);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position

$t->assign(
    'site_position', [
        [
            'page' => "schedule/system/facility_group",
            'name' => grn_get_page_display_name('schedule/system/facility_group'),
            'sf'   => '1'
        ],
        ['page' => "", 'name' => $page_title]
    ]
);


$t->display(cb_get_pagename() . '.tpl');

