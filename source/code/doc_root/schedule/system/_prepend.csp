<?php
function _schedule_rebuild_facility_group_tree($expanded_fagid = null)
{
    $tree_session_page = 'schedule/system/facility_group';
    require_once('schedule/facility_tree.csp');

    require_once('schedule/facility_system_logic.csp');
    $fsl = GRN_Facility_SystemLogic::getInstance();

    $util = GRN_OrgTreeUtil::getInstance();
    $tree =& $util->getTree($tree_session_page, 'GRN_FacilityTree');
    $tree->rebuild();

    // update init time
    $modules = ['schedule', 'grn', 'personal'];
    $util->updateInitPageList($modules, $tree);

    if ( ! is_null($expanded_fagid)) {
        $ancestors = $fsl->getAncestors([$expanded_fagid => $expanded_fagid]);
        $ancestors[$expanded_fagid][] = null;
        $ancestors
            = array_reverse($ancestors[$expanded_fagid]);
    } else {
        $ancestors = [null];
    }

    foreach ($ancestors as $ancestor) {
        $tree->buildChild($ancestor);
    }
    $util->setTree($tree_session_page, $tree);
}
