<?php

// Smarty をインスタンス化
require_once('grn/smarty.csp');
$t = new GRN_Smarty;

// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);

global $G_INPUT;

global $G_container_base;
$uum = $G_container_base->getInstance('uum');

//------------------
$group_id = array_key_exists('gid', $G_INPUT) ? $G_INPUT['gid'] : false;

if ($group_id === false) {
    $user = $uum->getLoginUser();
    $primary_group = $uum->getUserPrimaryGroupInfo($user->getOID());
    $group_id = ($primary_group === false) ? false : $primary_group['_id'];
}

if (array_key_exists('return_url', $G_INPUT)) {
    $return_url = $G_INPUT['return_url'];
} else {
    assert('FALSE');
}
$t->assign('return_url', $return_url);

if (array_key_exists('tp', $G_INPUT)) {
    $t->assign('tp', $G_INPUT['tp']);
}

if (array_key_exists('ppid', $G_INPUT)) {
    $t->assign('ppid', $G_INPUT['ppid']);
}

// schedule flag
$G_INPUT['ss'] = '1';

include('portlet/_organization_select.csp');
$t->assign('set_organization_id', $group_id);

//--user list
if ($group_id) {
    $user_rows = $uum->getGroupUsers($group_id, 0, 11);
    $user_list = [];
    foreach (array_keys($user_rows) as $uid) {
        $user_row =& $user_rows[$uid];
        $user_list[$uid] = $user_row->get('display_name');
    }
    $is_ten_over = count($user_list) > 10;
    if ($is_ten_over) {
        array_pop($user_list);
    }
    $t->assign('user_list', $user_list);
    $t->assign('is_ten_over', $is_ten_over);
}

// date
$t->assign('bdate',
    array_key_exists('bdate', $G_INPUT) ? $G_INPUT['bdate'] : null);

//app_name
require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_name = $app_locator->getName('schedule');
$t->assign('app_name', $app_name);

// page title
$page_title = cb_msg('grn.common', 'popup_group');
$t->assign('page_title', $page_title);

// site position 
$t->assign(
    'site_position', [
        ['page' => '', 'name' => $page_title]
    ]
);

// Smarty実行
//$t->display( cb_get_pagename() . ".tpl" );
$t->display('grn/popup_group.tpl');

