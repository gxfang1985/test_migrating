<?php
require_once('grn/application.csp');

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// 日付
$day = @ $G_INPUT['day'];
require_once("fw/date.csp");
$date = new CB_Date();
if ( ! $date->parse($day)) {
    $date = null;
} else {
    $smarty->assign('day', $date->format());
}

// 
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// セッション内に呼び出し元の情報
// セッション切れが起きた場合はTOPへリダイレクト
$page_group = $G_cellular_session->get('schedule_search_group');
if ( ! strlen($page_group)) {
    grn_cellular_switch_page("cellular/menu");
}
$page_user = $G_cellular_session->get('schedule_search_user');
if ( ! strlen($page_user)) {
    $smarty->assign('group_search_only', true);
    $smarty->assign('submit_group', true);
}
$is_access = $G_cellular_session->get('schedule_search_access');
$lax_evaluate = false;
foreach ($is_access as $author) {
    if ($author == 'modify') {
        $lax_evaluate = true;
    }
}

// パラメータ情報
$from = (isset($G_INPUT['from'])) ? $G_INPUT['from'] : '';
$str = (isset($G_INPUT['str'])) ? $G_INPUT['str'] : '';
$page = (isset($G_INPUT['pg'])) ? $G_INPUT['pg'] : 0;
$gid = (isset($G_INPUT['gid'])) ? $G_INPUT['gid'] : null;

$params = (isset($G_INPUT)) ? $G_INPUT : null;
unset($params['str']);
unset($params['pg']);
unset($params['gid']);
unset($params['submit_group']);
unset($params['submit_user']);
$smarty->assign('params', $params);

$tab = [
    'mode'   => 's',
    'page'   => cb_get_pagename(),
    'params' => $params,
    'add'    => [
        // 検索tab
        [
            'mode' => 's',
            'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

if (strcmp($page_group, 'schedule/cellular/add_user')) {
    // 施設タブ
    array_unshift($tab['add'], [
        'mode' => 'f',
        'name' => cb_msg('grn.schedule.cellular', 'tab_facility'),
    ]);
}

if (strlen($gid)) {
    $prefix = mb_substr($gid, 0, 1);
    if ($prefix != 's') {
        // selectページにswitch
        grn_cellular_switch_page($page_group);
    }
}

$smarty->assign('gid', $gid);

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();

// アクセス権logic
$dynamic_roles = $G_uum->listGrantedRoles();
require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_logic::getInstance();

if (strlen($str)) {
    $smarty->assign('str', $str);

    if (array_key_exists('submit_group', $G_INPUT)) {
        $smarty->assign('submit_group', true);
        $smarty->assign('to_page', $page_group);

        require_once('fw/string_util.csp');
        $keywords = cb_parse_search_text($str);

        // 検索
        $groups = $G_uum->getGroupListByNames($keywords);

        // アクセス権 絞り込み（組織はreadだけ）
        $groups = $acc_logic->evaluateAccesses($G_login_user, $groups, ['read'],
            $dynamic_roles, "group");

        $lists = [];
        foreach ($groups as $_group) {
            $lists['g' . $_group->getOID()] = $_group->get('name');
        }
    } elseif (array_key_exists('submit_user', $G_INPUT)) {
        $smarty->assign('submit_user', true);
        $smarty->assign('to_page', $page_user);

        require_once('grn/org_util.csp');
        require_once('grn/org_util_search.csp');
        $org_id = '';
        $system_flg = false;
        $condition = grn_get_user_info_search_condition($org_id, $str,
            $system_flg, false, true);
        //$count = grn_get_user_info_search_count( $org_id, $condition );

        $navi_params = [];
        $navi_params['str'] = $str;

        $users = grn_search_user_info_by_application($org_id, $condition,
            $navigation_info, false, $navi_params, null,
            GRN_SCHEDULE_APPLICATION_ID);
        //$navigation_info = grn_get_user_navigation_info( $count, $navi_params );

        // 検索
        //$users = grn_search_user_info( $org_id, $condition, $navigation_info, TRUE );

        // アクセス権 絞り込み
        $users = $acc_logic->evaluateAccessesById($G_login_user, $users,
            $is_access, $dynamic_roles, "user", false, $lax_evaluate);

        $lists = [];
        foreach ($users as $uid => $_user) {
            $lists[$uid] = $_user['display_name'];
        }
    }

    // ページ切り替え
    $page = $page - 0;
    if (isset($lists)) {
        $page_lists = array_chunk($lists, $limit, true);
    }
//    $page_lists = array_chunk($lists, $limit, TRUE);
    $smarty->assign('lists',
        isset($page_lists[$page]) ? $page_lists[$page] : null);

    if ($page > 0) {
        $smarty->assign(['prev' => true, 'prev_page' => $page - 1]);
    }
    if (isset($page_lists[$page + 1]) && count($page_lists[$page + 1])) {
        $smarty->assign(['next' => true, 'next_page' => $page + 1]);
    }
}

$smarty->assign('tab', $tab);

// 遷移先（遷移してきた元に戻る
if ($from == 'add') {
    $to_pagename = $G_pagepath . '/command_add_02';
    $sess_event = $G_cellular_session->get('sess_sche_add');
    $eid = 'null';
} else {
    $to_pagename = $G_pagepath . '/command_change_body';
    $sess_event = $G_cellular_session->get('sess_sche_edit');
    $eid = $sess_event['eid'];
}

$smarty->assign('page_group', $page_group);
$smarty->assign('to_pagename', $to_pagename);

// 既登録者を識別するためにスケジュール情報をパラメータに引き渡す
$smarty->assign('sess_event', $sess_event);

// ユーザ情報の詳細画面から戻るときに使う
$G_cellular_session->set('back-from-address-view', $G_INPUT);


// smartyの出力
$smarty->display(cb_get_pagename() . '.tpl');



