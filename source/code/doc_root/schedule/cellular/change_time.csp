<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// アプリケーション名
$smarty->assign('appname', $G_application->getName());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$day = (isset($G_INPUT['day'])) ? $G_INPUT['day'] : null;
$eid = (isset($G_INPUT['eid'])) ? $G_INPUT['eid'] : null;
$mid = (isset($G_INPUT['mid'])) ? $G_INPUT['mid']
    : $G_login_user->getOID();    // 自分をdefault

$date = new CB_Date();
if ( ! $date->parse($day)) {
    $date = null;
}

require_once('schedule/application.csp');
$app = GRN_Schedule_Application::getInstance();
require_once('schedule/view_util.csp');
$util = GRN_Schedule_View_Util::getInstance();
//event 取得
$event = $app->getEvent($G_login_user, $eid, $date);

if ( ! $event) {
    cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
}

// アクセス権のチェック
require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_Logic::getInstance();
$dynamic_role = $G_uum->listGrantedRoles();
$access = $acc_logic->getEventAccess($G_login_user, $event,
    ['read', 'modify', 'delete', 'add'], $dynamic_role);

if ($access['read'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_EVENT);
}

if ($access['modify'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_MODIFY);
}

require_once('schedule/system_logic.csp');
$systemlogic = GRN_Schedule_SystemLogic::getInstance();

$schedule_event = [
    'eid'             => $eid,
    'minute_interval' => $systemlogic->getScheduleUnit(),
    //                         'use_private'     => $systemlogic->getUsePrivate()
];

// 時間の設定
if (isset($event->setdatetime) && is_a($event->setdatetime, 'CB_Date')) {
    $schedule_event['start_date'] = $event->setdatetime;
} elseif (isset($event->setdatetime)
          && is_a($event->setdatetime, 'CB_DateTime')
) {
    $schedule_event['start_date'] = $event->setdatetime->getDate();
    $schedule_event['start_time'] = $event->setdatetime->getTime();
}


if (isset($event->enddatetime) && is_a($event->enddatetime, 'CB_Date')) {
    $schedule_event['end_date'] = $event->enddatetime;
} elseif (isset($event->enddatetime)
          && is_a($event->enddatetime, 'CB_DateTime')
) {
    $schedule_event['end_date'] = $event->enddatetime->getDate();
    $schedule_event['end_time'] = $event->enddatetime->getTime();
} elseif ( ! isset($event->enddatetime)) {
    if (isset($event->setdatetime) && is_a($event->setdatetime, 'CB_Date')) {
        $schedule_event['end_date'] = $event->setdatetime;
    } elseif (isset($event->setdatetime)
              && is_a($event->setdatetime, 'CB_DateTime')
    ) {
        $schedule_event['end_date'] = $event->setdatetime->getDate();
    }
}

// schedule type
if (($event->getEventType() & GRN_SCHEDULE_EVENT_TYPE_BANNER)
    == GRN_SCHEDULE_EVENT_TYPE_BANNER
) {
    $schedule_event['banner_type'] = true;

    $schedule_event['start_date'] = $event->setdate;
    $schedule_event['end_date'] = $event->enddate;

} elseif (($event->getEventType() & GRN_SCHEDULE_EVENT_TYPE_ALLDAY)
          == GRN_SCHEDULE_EVENT_TYPE_ALLDAY
) {
    $schedule_event['allday_type'] = true;
}
//echo "<pre>".print_r($schedule_event,true)."</pre>";
$smarty->assign('schedule_event', $schedule_event);

$smarty->assign('syy', $schedule_event['start_date']->year);
$smarty->assign('smm', $schedule_event['start_date']->month);
$smarty->assign('sdd', $schedule_event['start_date']->day);
$smarty->assign('eyy', $schedule_event['end_date']->year);
$smarty->assign('emm', $schedule_event['end_date']->month);
$smarty->assign('edd', $schedule_event['end_date']->day);
$smarty->assign('mid', $mid);
$smarty->assign('day', $date->format());

$smarty->display(cb_get_pagename() . '.tpl');

