<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// アプリケーション名
$smarty->assign('appname', $G_application->getName());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$mid =  $G_INPUT['mid'] ?? '';
$eid =  $G_INPUT['eid'] ?? '';
$day =  $G_INPUT['day'] ?? '';
$mode = $G_INPUT['mode'] ?? null;
$is_page_numeric = is_numeric($G_INPUT['pg'] ?? null);
$page = $is_page_numeric ? $G_INPUT['pg'] : null;

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$width = $user_config->getSubjectWidth();
$limit = $user_config->getListMax();


if ( ! $mid) {
    $mid = $G_login_user->getOID();
}    // 自分をdefault

// スケジュールＩＤ
$smarty->assign('eid', $eid);
$smarty->assign('mid', $mid);
$smarty->assign('day', $day);
$smarty->assign('mode', $mode);

//$member =  $G_uum->getUser( $mid );
require_once('schedule/application.csp');
$app = GRN_Schedule_Application::getInstance();

$date = new CB_Date();
if ( ! $date->parse(@$day)) {
    $date = null;
}
// スケジュール情報
$event = $app->getEvent($G_login_user, $eid, $date);

// アクセス権のチェック
require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_Logic::getInstance();
$dynamic_role = $G_uum->listGrantedRoles();
$access = $acc_logic->getEventAccess($G_login_user, $event,
    ['read', 'modify', 'delete', 'add'], $dynamic_role);
if ($access['read'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_EVENT);
}

$event_title = $event->getTitle();

$smarty->assign('event_title', $event_title);

$offset = $page * $limit;
$limit = $limit + 1;

$members = [];
$point = 0;
if ($mode == 'f') {
    // 施設
    if ($event->facilities) {
        foreach ($event->facilities as $facility) {
            if ($point < $offset) {
                $point++;
                continue;
            }
            if ($point >= $offset + $limit) {
                break;
            }
            $members[$facility->getOID()] = $facility->get('name');
            $point++;
        }
    }
} else {
    // 参加者の設定
    if ($event->groups) {
        foreach ($event->groups as $group) {
            if ($point < $offset) {
                $point++;
                continue;
            }
            if ($point >= $offset + $limit) {
                break;
            }
            $members['g' . $group->getOID()] = $group->get('name');
            $point++;
        }
    }

    if ($event->users) {
        foreach ($event->users as $user) {
            if ($point < $offset) {
                $point++;
                continue;
            }
            if ($point >= $offset + $limit) {
                break;
            }
            $members[$user->getOID()] = $user->get('display_name');
            $point++;
        }
    }
}


if ($page > 0) {
    $smarty->assign(['prev' => true, 'prev_p' => $page - 1]);
}
if (count($members) == $limit) {
    array_pop($members);
    $smarty->assign(['next' => true, 'next_p' => $page + 1]);
}


$smarty->assign('list', $members);

$smarty->display(cb_get_pagename() . '.tpl');

