<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// アプリケーション名
$smarty->assign('appname', $G_application->getName());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// G_INPUT
$fid = $G_INPUT['fid'];
$day = $G_INPUT['day'];
$mid = $G_INPUT['mid'];
$eid = $G_INPUT['eid'];

// assign
$smarty->assign('mid', $mid);
$smarty->assign('eid', $eid);
$smarty->assign('day', $day);

require_once('schedule/application.csp');
$app = GRN_Schedule_Application::getInstance();

$limit = 0;
$offset = 0;

$date = new CB_Date();
if ( ! $date->parse($day)) {
    $date = null;
}

//スケジュールタイトルの取得
$event = $app->getEvent($G_login_user, $eid, $date);
$title = $event->getTitle();
$smarty->assign('title', $title);

// アクセス権のチェック
require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_Logic::getInstance();
$dynamic_role = $G_uum->listGrantedRoles();
$access = $acc_logic->getEventAccess($G_login_user, $event,
    ['read', 'modify', 'delete', 'add'], $dynamic_role);
if ($access['read'] == GRN_SCHD_ACCESS_DENY) {
    cb_throw_error(E_GRN_SCHD_ACCESSDENY_EVENT);
}

if (($access['add'] != GRN_SCHD_ACCESS_DENY)
    || ($access['delete'] != GRN_SCHD_ACCESS_DENY)
    || ($access['modify'] != GRN_SCHD_ACCESS_DENY)
) {
    $event_follow = true;
} else {
    $event_follow = false;
}
$smarty->assign('event_follow', $event_follow);

//フォロー取得
$follows = $app->getEventFollows($G_login_user, $eid, $offset, $limit);

$temp_follow = [];
$counter = 0;
foreach ($follows as $fo_id => $follow) {
    $counter++;
//    if( $counter > $limit )
//        break;

    $tsex = new CB_TimeStampEx($follow['ctime']);
    $datetime = $tsex->getDateTime();

    $temp_follow[] = [
        'follow_id'    => $fo_id,
        'creator_uid'  => $follow['creator_id'],
        'creator_name' => $follow['creator_name'],
        'ctime'        => $datetime->format(),
        'data'         => $follow['data']
    ];
}

for ($i = 0; $i < count($temp_follow); $i++) {
    if ($temp_follow[$i]['follow_id'] == $fid) {
        $number = $i;
    }
}
$fid_p = @ $temp_follow[$number - 1]['follow_id'];
$fid_n = @ $temp_follow[$number + 1]['follow_id'];

$smarty->assign('fid', @$fid);
$smarty->assign('follow', $temp_follow[$number]);
$smarty->assign('fid_p', $fid_p);
$smarty->assign('fid_n', $fid_n);

// display
$smarty->display(cb_get_pagename() . '.tpl');


