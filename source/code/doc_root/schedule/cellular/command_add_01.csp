<?php
// このページで使用するセッション情報の取得
$sess_sche_add = $G_cellular_session->get('sess_sche_add');

if ( ! isset($sess_sche_add['flag'])) {
    // セッション未設定（初期化
    $sess_sche_add = [];
}

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// アプリケーション名
$smarty->assign('appname', $G_application->getName());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

$mid = (isset($G_INPUT['mid'])) ? $G_INPUT['mid'] : null;

// 日付チェック
/*
require_once( "fw/date.csp" );
$day_tmp = new CB_Date();

if( !$day_tmp->parse(@$G_INPUT['syy'].'-'.@$G_INPUT['smm'].'-'.@$G_INPUT['sdd']) ||
    !$day_tmp->parse(@$G_INPUT['eyy'].'-'.@$G_INPUT['emm'].'-'.@$G_INPUT['edd']) )
{
    grn_cellular_switch_page( $G_pagepath."/add_01" );
}
else
{
*/
require_once("schedule/view_util.csp");
$sche_date_util = GRN_Schedule_View_Util::getInstance();
//
$s_time = $sche_date_util->createDateTimeFromParameters(@$G_INPUT['syy'],
    @$G_INPUT['smm'],
    @$G_INPUT['sdd'],
    $G_INPUT['start_hour'],
    $G_INPUT['start_minute']);
$e_time = $sche_date_util->createDateTimeFromParameters(@$G_INPUT['eyy'],
    @$G_INPUT['emm'],
    @$G_INPUT['edd'],
    $G_INPUT['end_hour'],
    $G_INPUT['end_minute']);

require_once('schedule/application.csp');
$sche_app = GRN_Schedule_Application::getInstance();
//日付の前後などのチェック。
$sess_sche_add['facility_flag'] = true;
$sess_sche_add['all_day'] = false;
if (isset($G_INPUT['normal_submit'])) {
    // 日付のチェック
    $sche_app->checkDateTime($s_time, $e_time);

    if (is_a($s_time, 'CB_DateTime') && is_a($e_time, 'CB_DateTime')) {
        $sess_sche_add['facility_flag'] = true;
    } elseif (is_a($s_time, 'CB_DateTime') && is_a($e_time, 'CB_Date')) {
        if (($s_time->year != $e_time->year)
            || ($s_time->month != $e_time->month)
            || ($s_time->day != $e_time->day)
        ) {
            cb_throw_error(E_GRN_SCHD_INVALID_ENDDATE);
        }

        $e_time = null;
        $sess_sche_add['facility_flag'] = false;
    } elseif (is_a($s_time, 'CB_Date') && is_a($e_time, 'CB_Date')) {
        $sess_sche_add['all_day'] = true;
        $sess_sche_add['facility_flag'] = false;
    }
    $sess_sche_add['start_date'] = serialize($s_time);
    $sess_sche_add['end_date'] = serialize($e_time);
    $sess_sche_add['banner_flag'] = false;
} else {
    $s_day = new CB_Date();
    $s_day->year = $s_time->year;
    $s_day->month = $s_time->month;
    $s_day->day = $s_time->day;
    $e_day = new CB_Date();
    $e_day->year = $e_time->year;
    $e_day->month = $e_time->month;
    $e_day->day = $e_time->day;
    // 日付のチェック
    $sche_app->_checkDate($s_day, $e_day);

    $sess_sche_add['facility_flag'] = false;
    $sess_sche_add['banner_flag'] = true;
    $sess_sche_add['start_date'] = serialize($s_day);
    $sess_sche_add['end_date'] = serialize($e_day);
}
/*
}
*/

$smarty->assign('mid', $mid);
$sess_sche_add['mid'] = $mid;
$sess_sche_add['flag'] = true;

// 共有者情報（default）
$sess_sche_add['joint'] = [];
$sess_sche_add['joint_edit'] = true;
$sess_sche_add['facilities'] = [];
$sess_sche_add['facilities_edit'] = true;
// 対象
if (mb_substr($mid, 0, 1) == 'f') {
    // 施設
    if ( ! $sess_sche_add['facility_flag']) {
        // 施設選択されてるのに、時刻の入力が無く施設が登録できない
        $G_INPUT['error_facility'] = true;
        grn_cellular_switch_page($G_pagepath . "/add_01");
    }
    $facility_id = mb_substr($mid, 1);
    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();
    $facility = $facility_logic->getFacility($facility_id);
    if ($facility !== false) {
        $sess_sche_add['facilities'][$facility_id] = $facility->get('name');
    }
}
if (mb_substr($mid, 0, 1) == 'g') {
    // 組織
    $group_id = mb_substr($mid, 1);
    $group = $G_uum->getGroup($group_id);
    if ($group) {
        $sess_sche_add['joint'][$mid] = $group->get('name');
    }
} else {
    // 人物
    $user = $G_uum->getUser($mid);
    if ($user) {
        $sess_sche_add['joint'][$mid] = $user->get('display_name');
    }
}
// 自分
$sess_sche_add['joint'][$G_login_user->getOID()]
    = $G_login_user->get('display_name');


$G_cellular_session->set('sess_sche_add', $sess_sche_add);

grn_cellular_switch_page($G_pagepath . "/add_02");

