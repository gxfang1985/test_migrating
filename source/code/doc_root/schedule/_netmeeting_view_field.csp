<?php
/**
 * @updated:
 *    2011/06/08 VCBSCH0010 Sync for V-CUBE
 */
require_once('schedule/netmeeting_event_logic.csp');
/** @var $vcb_event_logic \GRN_Netmeeting_EventLogic */
$vcb_event_logic = GRN_Netmeeting_EventLogic::getInstance();

require_once('schedule/netmeeting_view_field_logic.csp');
/** @var $vcb_view_logic \GRN_Netmeeting_VIewFieldLogic */
$vcb_view_logic = GRN_Netmeeting_ViewFieldLogic::getInstance();

// NETMEETING連携あり
if ($vcb_event_logic->isNetmeetingAvailable($event2)) {
    // 選択されている施設がある場合
    $vcb_facility = $vcb_event_logic->getNetmeetingFacilityById($event2);
    if (isset($vcb_facility)) {
        $netmeeting_data = null;
        $b_netmeeting_retry = true;

        // 時間のチェック
        $event_status = $vcb_event_logic->getEventStatus($event2->setdatetime,
            $event2->enddatetime);

        // ログインユーザーのチェック
        $b_creator = $vcb_view_logic->checkCreator($event2, $login_id);

        // 連携データ取得
        $coop_data
            = $vcb_event_logic->getNetmeetingCoopDataByEventId($event_id);

        // 連携データあり
        if (isset($coop_data)) {
            // 連携が正常終了している場合
            if ($coop_data->cooperation_status
                == GRN_NETMEETING_COOPERATION_STATUS_COMPLETE
            ) {
                // リトライボタン非表示
                $b_netmeeting_retry = false;

                // 招待情報を取得
                $vcb_view_logic->setInviteDisp($event_status, $login_id,
                    $b_login, $b_creator, $coop_data);

                // 外部ユーザーセット
                $vcb_view_logic->setOutsideMembersDisp($coop_data, $b_login,
                    $b_creator);
            }
        }

        // リトライボタン表示
        $vcb_view_logic->setRetryBtnDisp($vcb_facility, $b_netmeeting_retry,
            $b_login, $b_creator, $event_status);
        if (is_array($vcb_view_logic->netmeeting_data)) {
            $temp['netmeeting'] = $vcb_view_logic->netmeeting_data;
        }
    }
}

