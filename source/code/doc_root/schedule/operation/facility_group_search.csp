<?php
require_once('grn/smarty.csp');
$t = new GRN_Smarty();

$org_id = @ $G_INPUT['oid'];

require_once('schedule/facility_system_logic.csp');
$fsl = GRN_Facility_SystemLogic::getInstance();
require_once('schedule/facility_privilege.csp');
$priv = GRN_Facility_Privilege_Logic::getInstance();

$uum = $G_container_base->getInstance('uum');
$dynamic_roles = $uum->listGrantedRoles();
$login = $uum->getLoginUser();

$is_search = array_key_exists('search_text', $G_INPUT);
$search_text = @ $G_INPUT['search_text'];

$t->assign('is_search_facilitygroup', true);
$result = $fsl->searchFacilityGroupsInfo($search_text);

# 運用管理権限がない施設グループをリストから外す
foreach (array_keys($result) as $r_id) {
    if ( ! $priv->hasPrivilegeOfFacilityGroupByID($login, $r_id)) {
        unset($result[$r_id]);
    }
}

$ancestors = $fsl->getAncestors($result);

# $ancestors を reverse して、さらに運用管理権限がない上位の施設グループを削除する
$auth_fgroups = $priv->getFacilityGroupWithAuthority($login);
$auth_fgroups_ids = [];
foreach ($auth_fgroups as $auth_fgroup) {
    $auth_fgroups_ids[] = $auth_fgroup->getOID();
}
foreach (array_keys($ancestors) as $f_id) {
    $ancestor = &$ancestors[$f_id];
    $ancestor = array_reverse($ancestor);
    foreach ($ancestor as $id) {
        if (array_search($id, $auth_fgroups_ids) !== false) {
            break;
        } else {
            array_shift($ancestor);
        }
    }
}
unset($ancestor);

$fgroups_list = [];
foreach ($ancestors as $ancestor) {
    foreach ($ancestor as $a) {
        $fgroups_list[$a] = $a;
    }
}
$fgroups_info = $fsl->getFacilityGroupsInfo($fgroups_list);

$search_result = [];
foreach (array_keys($result) as $r_id) {
    $values = ['fagid' => $r_id];
    $values['ancestor'] = [];
    foreach ($ancestors[$r_id] as $a) {
        $values['ancestor'][] = $fgroups_info[$a];
    }
    $search_result[] = $values;
}
$t->assign('search_result', $search_result);

$t->assign('org_id', $org_id);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position

$t->assign(
    'site_position', [
        [
            'page' => "schedule/operation/facility_list",
            'name' => grn_get_page_display_name('schedule/operation/facility_list'),
            'oid'  => $org_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

$t->assign('search_text', $search_text);
$t->display(cb_get_pagename() . '.tpl');

