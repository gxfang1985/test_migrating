<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'schedule');

$fagid = @ $G_INPUT['fagid'];

require_once('schedule/facility_system_logic.csp');
$fsl = GRN_Facility_SystemLogic::getInstance();

$facilitygroup = $fsl->getFacilityGroup($fagid);
if ($facilitygroup === false) {
    cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITYGROUP);
} else {
    $fagid = $facilitygroup->getOID();
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

// 権限があるかどうかのチェック
require_once('schedule/facility_privilege.csp');
$privilege_logic = GRN_Facility_Privilege_Logic::getInstance();

if ( ! empty($fagid)) {
    // 権限があるかどうか
    if ( ! $privilege_logic->hasPrivilegeOfFacilityGroupByID($login, $fagid)) {
        cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
    }
} else {
    if ( ! $privilege_logic->hasPrivilege($login)) {
        cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
    }
}

$view_data = [];
$view_data['fagid'] = $fagid;
$view_data['title'] = $facilitygroup->get('name');

$view_data['ctime'] = $facilitygroup->get('ctime');
$creator = $facilitygroup->get('creator');
if ( ! $creator) {
    $view_data['creator_name'] = $facilitygroup->get('creator_name');
} else {
    $view_data['creator_uid'] = $creator->getOID();
}
$view_data['mtime'] = $facilitygroup->get('mtime');
$modifier = $facilitygroup->get('modifier');
if ( ! $modifier) {
    $view_data['modify_name'] = $facilitygroup->get('modifier_name');
} else {
    $view_data['modify_uid'] = $modifier->getOID();
}

$facilities = $fsl->getGroupFacilities($fagid);
$temp = [];
foreach (array_keys($facilities) as $faid) {
    $facility = $facilities[$faid];
    if ( ! $facility) {
        continue;
    }

    $temp[$faid] = ['faid' => $faid, 'title' => $facility->get('name')];
}

if (is_array($facilities)) {
    $view_data['count'] = count($facilities);
} else {
    $view_data['count'] = 0;
}
$view_data['facility'] = $temp;
$ancestors = [];

$tmp_group = $facilitygroup->get('parent');

// 権限がある施設グループだけでツリーを作る
$priv_facility_group
    = $privilege_logic->getFacilityGroupWithAuthorityEx($login);
for ($i = 0; $i < GRN_SCHD_MAX_FACILITY_GROUP_TREE - 1; $i++) {
    if ( ! $tmp_group) {
        break;
    }
    if ( ! array_key_exists($tmp_group->getOID(), $priv_facility_group)) {
        break;
    }
    $ancestors[] = ['title' => $tmp_group->get('name')];
    $tmp_group = $tmp_group->get('parent');
}

$view_data['code'] = $facilitygroup->get('foreign_key');
$view_data['memo'] = $facilitygroup->get('memo');
$view_data['ancestors'] = array_reverse($ancestors);

$t->assign('facility_group', $view_data);

$is_movable = false;
if ($fsl->isMovable($fagid, $login)) {
    $is_movable = true;
}
$t->assign('is_movable', $is_movable);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $view_data['title']);

// site position
$t->assign(
    'site_position',
    [
        [
            'page' => 'schedule/index',
            'name' => grn_get_page_display_name('schedule/schedule_index')
        ],
        [
            'page' => "schedule/operation/facility_list",
            'name' => grn_get_page_display_name('schedule/operation/facility_list'),
            'oid'  => $fagid,
            'sf'   => 1
        ],
        [
            'page'  => "",
            'name'  => $page_title,
            'fagid' => $fagid
        ]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


