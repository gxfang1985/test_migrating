<?php

use grn\schedule\screen\FacilityApproveDetailUtil;
use grn\grn\JSONResponse;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT, $G_state_set, $G_container_base;

    $G_state_set->set('html_should_be_closed', false);
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('error_page_type', 'json');
    $G_INPUT['updateReadNotification'] = true;

    (new FacilityApproveDetailUtil())->processForPost($G_INPUT);

    $eid = cb_at($G_INPUT, 'event');
    require_once('schedule/eventfactory.csp');
    $event_factory = GRN_Schedule_EventFactory::getInstance();
    $event = $event_factory->getEvent($eid);
    if ( ! $event) {
        cb_throw_error(E_GRN_SCHD_NOTFOUND_EVENT);
    }

    $schedule_line = cb_msg('grn.schedule',
        'attendance_list_time_connection_line');
    $start_date = cb_date_format('DateShort_MD', $event->setdatetime);
    $using_time = $start_date;
    $using_time_html = $start_date;

    $start_time = cb_date_format('TimeShort_HM', $event->setdatetime);
    $using_time .= ' ' . $start_time;
    $using_time_html .= '<span class="mLeft15">' . $start_time . $schedule_line;

    $using_time .= $schedule_line;
    if (cb_date_format('DateShort_MD', $event->setdatetime)
        != cb_date_format('DateShort_MD', $event->enddatetime)
    ) {
        $end_date = cb_date_format('DateShort_MD', $event->enddatetime);
        $using_time .= $end_date . ' ';
        $using_time_html .= $end_date . ' ';
    }
    $end_time = cb_date_format('TimeShort_HM', $event->enddatetime);
    $using_time .= $end_time;
    $using_time_html .= $end_time . '</span>';

    $json = JSONResponse::create();
    $json->response(
        ['using_time' => $using_time, 'using_time_html' => $using_time_html]
    );

}
