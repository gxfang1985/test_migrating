<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once '_access_util.csp';

    // access object
    $object = grn_get_schedule_access_object($target, $org_id, $user_id,
        $role_id, $facility_id, $fgroup_id);

    // access information
    require_once('schedule/access_logic.csp');
    $sal = GRN_Schedule_Access_Logic::getInstance();

    // 登録されているアクセス権をすべて取得
    $accesses = $sal->getAccesses($object);

    // 現在の設定をすべてクリアする
    $sal->deleteAccesses($object, $accesses);

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l = $lm->getLogger(GRN_SCHEDULE_MODULE_ID);
    if (is_a($object, 'CB_User')) {
        $log_params = ['uid' => $object->getOID()];
        $l->noticeEx('delete_all', 'access', $log_params);
    } elseif (is_a($object, 'CB_Group')) {
        $log_params = ['oid' => $object->getOID()];
        $l->noticeEx('delete_all', 'access', $log_params);
    } elseif (is_a($object, 'CB_Role')) {
        $log_params = ['rid' => $object->getOID()];
        $l->noticeEx('delete_all', 'access', $log_params);
    } elseif (is_a($object, 'GRN_Facility_Facility')) {
        $log_params = ['fid' => $object->getOID()];
        $l->noticeEx('delete_all', 'access', $log_params);
    } elseif (is_a($object, 'GRN_Facility_FacilityGroup')) {
        $log_params = ['fgid' => $object->getOID()];
        $l->noticeEx('delete_all', 'access', $log_params);
    }

    cb_redirect('schedule/operation/access_list', $G_INPUT);
}

