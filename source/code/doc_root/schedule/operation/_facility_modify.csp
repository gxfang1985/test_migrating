<?php

$fagid = @ $G_INPUT['fagid'];

$faid = @ $G_INPUT['faid'];

require_once('schedule/facility_system_logic.csp');
$system_logic = GRN_Facility_SystemLogic::getInstance();
$facility = $system_logic->getFacility($faid);
if ($facility === false) {
    cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITY);
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
// 権限があるかどうかのチェック
require_once('schedule/facility_privilege.csp');
$privilege_logic = GRN_Facility_Privilege_Logic::getInstance();

if ( ! $privilege_logic->hasPrivilegeOfFacility($login, $facility)) {
    cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
}

$view_data = [];
$view_data['fagid'] = $fagid; // 施設グループID
$view_data['faid'] = $faid;
$view_data['title'] = $facility->get('name');
$view_data['code'] = $facility->get('foreign_key');
$view_data['memo'] = $facility->get('memo');

// 所属している施設グループ
$group = $system_logic->getFacilityAffiliationGroup($faid);
$ancestors = [];
$tmp_group = $group;

// 権限がある施設グループだけでツリーを作る
$priv_facility_group
    = $privilege_logic->getFacilityGroupWithAuthorityEx($login);
for ($i = 0; $i < GRN_SCHD_MAX_FACILITY_GROUP_TREE; $i++) {
    if ( ! $tmp_group) {
        break;
    }
    if ( ! array_key_exists($tmp_group->getOID(), $priv_facility_group)) {
        break;
    }
    $ancestors[] = ['title' => $tmp_group->get('name')];
    $tmp_group = $tmp_group->get('parent');
}
$view_data['ancestors'] = array_reverse($ancestors);

$t->assign('facility', $view_data);

require_once('schedule/resources.csp');
$localeValues = $system_logic->createFacilityMultiLanguageValuesArray($faid);
$multiLanguageInfoArray = [];
$multiLanguageInfoArray['element_name'] = GRN_SCHEDULE_ELEMENT_NAME_FACILITY;
$multiLanguageInfoArray['values'] = $localeValues;
$t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

//--- add VCBSCH0010 ---s
$netmeeting_data = [];

// システムのV-CUBEを使用可否を取得
require_once('schedule/netmeeting_system_logic.csp');
$netmeeting_system_logic = GRN_Netmeeting_SystemLogic::getInstance();
$netmeeting_system_available
    = $netmeeting_system_logic->getNetmeetingAvailable();
if ( ! $netmeeting_system_available) {
    $available = '0';
}
$netmeeting_data['system_available'] = $netmeeting_system_available;

// 施設のV-CUBEの情報を取得
$netmeeting_data['available']
    = $facility->get('netmeeting_available');                // V-CUBE連携可否
$netmeeting_data['guests_normal_limit']
    = $facility->get('netmeeting_guests_normal_limit');      // 通常ユーザー招待人数の上限

// V-CUBEの使用情報セット
$t->assign('netmeeting', $netmeeting_data);
//--- add VCBSCH0010 ---e

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => 'schedule/index',
            'name' => grn_get_page_display_name('schedule/schedule_index')
        ],
        [
            'page' => 'schedule/operation/facility_list',
            'name' => grn_get_page_display_name('schedule/operation/facility_list'),
            'oid'  => $fagid,
            'sf'   => '1'
        ],
        [
            'page'  => 'schedule/operation/facility_view',
            'name'  => grn_get_page_display_name('schedule/operation/facility_view'),
            'fagid' => $fagid,
            'faid'  => $faid
        ],
        ['page' => '', 'name' => $page_title]
    ]
);



