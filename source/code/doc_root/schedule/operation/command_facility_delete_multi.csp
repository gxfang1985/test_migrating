<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    /*
        // instantiate an Smarty object
        require_once( "grn/smarty.csp" );
        $t = new GRN_Smarty;

        // Validation check
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        // validate after a POST
        if(SmartyValidate::is_valid($G_INPUT)) {
            // the validation session is finished
            SmartyValidate::disconnect();
    */
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    // 権限があるかどうかのチェック
    require_once('schedule/facility_privilege.csp');
    $privilege_logic = GRN_Facility_Privilege_Logic::getInstance();

    if ( ! $privilege_logic->hasPrivilege($login)) {
        cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
    }

    // --------
    // brabrabra after success
    // --------
    require_once('schedule/facility_system_logic.csp');
    $facility_logic = GRN_Facility_SystemLogic::getInstance();

    $fagid = @ $G_INPUT['fagid'];
    $faids = @ $G_INPUT['faid'];
    if ( ! is_array($faids) || count($faids) == 0) {
        cb_throw_error(E_GRN_FCLT_NOTSELECT_DELETE);
    }

    foreach ($faids as $faid) {
        $facility = $facility_logic->getFacility($faid);
        if ($facility === false) {
            continue;
        }

        if ( ! $privilege_logic->hasPrivilegeOfFacility($login, $facility)) {
            cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
        }

        $facility_logic->removeFacility($faid);
    }
    // ゴミデータとなるカスタマイズ項目データを削除する
    $facility_logic->removeGarbageData();

    cb_redirect('schedule/operation/facility_list',
        ['oid' => $fagid, 'sf' => 1]);
    /*
        } else {
            // if error, show the source form

            //Assign Template Name
            $t->setPageInfo($target_name);

            cb_redirect( 'schedule/operation/facility_list' );
        }
    */
}


