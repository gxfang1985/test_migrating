<?php

require_once('schedule/facility_system_logic.csp');
$fsl = GRN_Facility_SystemLogic::getInstance();


global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

// 権限があるかどうかのチェック
require_once('schedule/facility_privilege.csp');
$priv = GRN_Facility_Privilege_Logic::getInstance();

if ( ! empty($fagid)) {
    // 権限があるかどうか
    if ( ! $priv->hasPrivilegeOfFacilityGroupByID($login, $fagid)) {
        cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
    }
} else {
    if ( ! $priv->hasPrivilege($login)) {
        cb_throw_error(E_GRN_SCHD_PRIVILEGE_ACCESS_DENY);
    }
}

$facility_group = [];

$fagid = @$G_INPUT['fagid'];

if ($fagid == 0 || $fagid == -1
    || $fagid == -2
) // 0: （トップ）から -1: （施設グループに未所属の施設）から -2: （全施設）から
{
    $facility_group = null;
} else {
    $tmp_facilitygroup = $fsl->getFacilityGroup($fagid);
    if ($tmp_facilitygroup === false) {
        cb_throw_error(E_GRN_FCLT_NOTFOUND_FACILITYGROUP);
    }
    $ancestors = $fsl->getAncestors([$fagid => $fagid]);
    $ancestors = array_reverse($ancestors[$fagid]);

    $auth_fgroups = $priv->getFacilityGroupWithAuthority($login);

    $auth_fgroups_ids = [];
    foreach ($auth_fgroups as $auth_fgroup) {
        $auth_fgroups_ids[] = $auth_fgroup->getOID();
    }

    foreach ($ancestors as $id) {
        if (array_search($id, $auth_fgroups_ids) !== false) {
            break;
        } else {
            array_shift($ancestors);
        }
    }
    $group_ids = [];

    foreach ($ancestors as $id) {
        $group_ids[$id] = $id;
    }
    $tmp_facility_group = $fsl->getFacilityGroupsInfo($group_ids);
    foreach ($ancestors as $id) {
        $facility_group[] = $tmp_facility_group[$id];
    }
}

$t->assign('ancestors', $facility_group);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('fagid', $fagid);

// site position
$t->assign(
    'site_position', [
        [
            'page' => 'schedule/index',
            'name' => grn_get_page_display_name('schedule/schedule_index')
        ],
        [
            'page' => 'schedule/operation/facility_list',
            'name' => grn_get_page_display_name('schedule/operation/facility_list'),
            'oid'  => $fagid,
            'sf'   => 1
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

// multilanguage Infomation
require_once('schedule/resources.csp');
$multiLanguageInfoArray = [];
$multiLanguageInfoArray['element_name']
    = GRN_SCHEDULE_ELEMENT_NAME_FACILITYGROUP;
$multiLanguageInfoArray['values'] = null;
$t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);


