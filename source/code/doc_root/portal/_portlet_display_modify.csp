<?php

/** @var GRN_Portal_Portlet $portlet */
$portlet_id = $portlet->getOID();

// Create Parameter Translation Map
$translation_map_portlet = [
    'pid'           => '_id',                  //Portal ID
    'ppid'          => '_id',                  //Portlet ID
    'plid'          => '_id',                  //Portlet Layout ID
    'type'          => 'type',                 //Portlet Type
    'version'       => 'version',              //Portlet Version
    'settings'      => 'settings',             //Portlet Settings
    'set_template'  => 'set_template',         //Portlet Setting Tamplate
    'view_template' => 'view_template',        //Portlet View template
    'source'        => 'source',               //Portlet Source
    'myportal'      => 'available_myportal',   //Portlet Available MyPortal
    'editor'        => 'editor',               //Portlet Editor
];

// Do Parameter Translation
$portlet_for_view = [];
foreach ($translation_map_portlet as $view_name => $model_name) {
    if ($view_name === 'ppid') {
        $portlet_for_view[$view_name] = $portlet_id;
    } elseif ($view_name === 'plid') {
        $portlet_for_view[$view_name] = $layout->getOID();
    } elseif ($view_name === 'pid') {
        $portlet_for_view[$view_name] = $portal_id;
    } elseif ($view_name === 'settings') {
        $serialized_settings = $layout->get($model_name);
        if ( ! is_null($serialized_settings)) {
            $settings = @cb_unserialize($layout->get($model_name),
                ["allowed_classes" => false]);
            $portlet_for_view[$view_name] = $settings;
        }
    } else {
        $portlet_for_view[$view_name] = $portlet->get($model_name);
    }
}

// Assign Portlet Display Infomation
$t->assign('portlet', $portlet_for_view);

//-- set page title and site position

// page title
$elements = explode('.', $portlet_for_view['type']);
$app_id = $elements[1];
$module_id = $elements[0] . '.' . $elements[1];

//Get Application name
require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$app_name = $app_locator->getName($app_id);

$page_title = sprintf('%sï¼ˆ%sï¼‰',
    grn_get_current_page_display_name(),
    cb_plain_msg($module_id, $portlet_for_view['type'],
        ['app_name' => $app_name])
);

$t->assign('page_title', $page_title);
