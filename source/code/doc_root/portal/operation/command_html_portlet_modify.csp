<?php

// Check HTTP-POST Method
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //get language values
    require_once('fw/i18n.csp');
    $inputLocalNameArray = getMultiLanguageText(GRN_PRTL_ELEMENT_NAME_PORTLET,
        $G_INPUT);

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'portal/operation/html_portlet_modify';
    SmartyValidate::register_form($target_name);

    //既存処理をそのままにしているが、下記の処理結果を使ってないんじゃ？ このロジックの目的は何？
    $portlet_group_id = $G_INPUT['portlet_group'];
    //Get Portlet Group
    require_once('portal/portlet_group_logic.csp');
    $portlet_group_logic = GRN_Portal_SystemPortletGroupLogic::getInstance();
    $portlet_group =& $portlet_group_logic->get($portlet_group_id);

    //Evaluate Group Manage Right
    require_once('portal/manage_logic.csp');
    $manage_logic = GRN_Portal_SystemPortletGroupManageLogic::getInstance();
    $manage_logic->evaluateManage($portlet_group, true);

    require_once('portal/system_portlet_logic.csp');
    $logic = GRN_Portal_SystemHTMLPortletLogic::getInstance();

    //Evaluate Portlet Manage Right
    $portletId = @ $G_INPUT['plid'];
    require_once('portal/manage_logic.csp');
    $portlet =& $logic->get($portletId);
    $manage_logic->evaluateManagePortlet($portlet, true);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $availableMyportal = @ $G_INPUT['checkbox'];
        $editor = @ $G_INPUT['editor'];
        $source = @ $G_INPUT['data'];


        //Get RichEditor File List
        if (isset($G_INPUT['data_fileids'])) {
            //Get File ID List
            $fileIdList = $G_INPUT['data_fileids'];
            $fileIdList = explode(',', $fileIdList);
        } else {
            $fileIdList = [];
        }


        //Modify Portlet

        $logic->modifyPortlet($portletId, $inputLocalNameArray,
            $portlet_group_id, $availableMyportal, $editor, $source,
            $fileIdList);


        // the validation session is finished
        SmartyValidate::unregister_form($target_name);


        //Redirect Next Page
        cb_redirect('portal/operation/html_portlet_view',
            ['plid' => $portletId]);
    } else {
        //include sharing codes with command_*
        include('_html_portlet_modify.csp');

        //Rewrite Only Portal Title
        $portlet_for_view = &$t->get_template_vars('portlet');
        $portlet_for_view['plid'] = @ $G_INPUT['plid'];
        $portlet_for_view['my_portal'] = @ $G_INPUT['checkbox'];
        $portlet_for_view['editor'] = @ $G_INPUT['editor'];
        $portlet_for_view['data'] = @ $G_INPUT['data'];
        if ($portlet_for_view['editor'] == 1) {
            $portlet_for_view['text'] = null;
            $portlet_for_view['html'] = $portlet_for_view['data'];
        } else {
            $portlet_for_view['text'] = $portlet_for_view['data'];
            $portlet_for_view['html'] = null;
        }

        // multilanguage Infomation
        $multiLanguageInfoArray = [];
        $multiLanguageInfoArray['element_name'] = GRN_PRTL_ELEMENT_NAME_PORTLET;
        $multiLanguageInfoArray['values'] = $inputLocalNameArray;
        $t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}
