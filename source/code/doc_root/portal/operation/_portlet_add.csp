<?php

use grn\grn\access\service\AppAccess;

$app_ids_availability
    = AppAccess::getAvailabilityAppIdsInternalByUserId(cb_get_login_user()->getOID());
$portal_send = true;
if ( ! array_key_exists('message', $app_ids_availability)
     || ! $app_ids_availability['message']
) {
    if ( ! array_key_exists('mail', $app_ids_availability)
         || ! $app_ids_availability['mail']
    ) {
        $portal_send = false;
    }
}

//Get Portal ID
$portal_id = @ $G_INPUT['pid'];

//Get Portal Position
$portal_position = @ $G_INPUT['position'];

//Get Portal
require_once('portal/portal_logic.csp');
$system_portallogic = GRN_Portal_SystemPortalLogic::getInstance();
$portal =& $system_portallogic->get($portal_id);

//Evaluate Access Right of Portal
require_once('portal/access_logic.csp');
$access_logic = GRN_Portal_SystemPortalAccessLogic::getInstance();
$access_logic->evaluateAccess($portal);

//Evaluate Manage Right for Portal
require_once('portal/manage_logic.csp');
$manage_logic = GRN_Portal_SystemPortalManageLogic::getInstance();
$manage_logic->evaluateManage($portal, true);

// Register Application Portlet
require_once('portal/system_portlet_logic.csp');
$system_embedded_portallogic
    = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();
$system_embedded_portallogic->register();

//Get System Portlet Group List
require_once('portal/portlet_group_logic.csp');
$system_portlet_grouplogic = GRN_Portal_SystemPortletGroupLogic::getInstance();
$portlet_group_list = $system_portlet_grouplogic->getlist();

//Evaluate Manage Right
require_once('portal/manage_logic.csp');
$manage_logic = GRN_Portal_SystemPortletGroupManageLogic::getInstance();
$allow_portlet_group_list
    = $manage_logic->evaluateManageList($portlet_group_list);

// Get System Portlet List
require_once('portal/system_portlet_logic.csp');
$system_embedded_portletlogic
    = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();
$embedded_portlet_list = $system_embedded_portletlogic->getList();
$system_html_portletlogic = GRN_Portal_SystemHTMLPortletLogic::getInstance();
$html_portlet_list = $system_html_portletlogic->getList();

$system_php_portletlogic = GRN_Portal_SystemPHPPortletLogic::getInstance();
$php_portlet_list = $system_php_portletlogic->getList();

$portlet_list = $embedded_portlet_list + $html_portlet_list + $php_portlet_list;

// Create Parameter Translation Map for portlet
$translation_map_portlet = [
    'ppid'  => '_id',
    'title' => 'name',
];

// Create Parameter Translation Map for portlet group
$translation_map_group = [
    'pgid'    => '_id',                  //Portlet Group ID
    'title'   => 'name',                 //Portlet Name
    'portlet' => 'portlet',              //Portlet Name
];

// Do Parameter Translation for Portlet
$portlet_list_for_view = [];
foreach (array_keys($portlet_list) as $portlet_id) {
    $app_id = explode(".", $portlet_list[$portlet_id]->get('type'));
    if (array_key_exists($app_id[1], $app_ids_availability)) {
        if ( ! $app_ids_availability[$app_id[1]]) {
            continue;
        }
    }
    if ( ! $portal_send) {
        if ($app_id[1] == 'portal' && $app_id[2] == 'send') {
            continue;
        }
    }

    //Evaluate Manage Right for Portlet
    $portlet_group =& $portlet_list[$portlet_id]->get(GRN_PRTL_PROPERTY_GROUP);
    if ($portlet_group) {
        if ( ! array_key_exists($portlet_group->getOID(),
            $allow_portlet_group_list)
        ) {
            continue;
        }
    }

    $portlet_for_view = [];
    foreach ($translation_map_portlet as $view_name => $model_name) {
        switch ($model_name) {
            case '_id':
                $portlet_for_view[$view_name] = $portlet_id;
                break;
            case 'name':
                $portlet_type = $portlet_list[$portlet_id]->get('type');
                if ($portlet_type === GRN_PRTL_PORTLET_TYPE_HTML
                    || $portlet_type === GRN_PRTL_PORTLET_TYPE_PHP
                ) {
                    $portlet_for_view[$view_name]
                        = $portlet_list[$portlet_id]->get($model_name);
                } else {
                    $layout = false;
                    $portlet_for_view[$view_name]
                        = $system_embedded_portletlogic->getDisplayName($portlet_list[$portlet_id],
                        $layout);
                }
                break;
            default:
                break;
        }
    }

    $key = 'p' . $portlet_for_view['ppid'];
    $portlet_list_for_view = $portlet_list_for_view
                             + [$key => $portlet_for_view['title']];
}

// Do Parameter Translation for Portlet Group
$temp_array[0] = [];
$temp_array = $temp_array + $allow_portlet_group_list;
$allow_portlet_group_list = $temp_array;
$portlet_group_list_for_view = [];
foreach (array_keys($allow_portlet_group_list) as $portlet_group_id) {
    $portlet_group_for_view = [];
    foreach ($translation_map_group as $view_name => $model_name) {
        switch ($model_name) {
            case '_id':
                $portlet_group_for_view[$view_name] = $portlet_group_id;
                break;
            case 'name':
                if ($portlet_group_id == 0) {
                    $portlet_group_for_view[$view_name]
                        = cb_plain_msg('grn.portal', 'all_embedded_portlet');
                } else {
                    $portlet_group_for_view[$view_name]
                        = $allow_portlet_group_list[$portlet_group_id]->get($model_name);
                }
                break;
            case 'portlet':
                $group_portlet_list = [];
                if ($portlet_group_id == 0) {
                    $group_portlet_list = $embedded_portlet_list;
                } else {
                    $group_portlet_list
                        = $allow_portlet_group_list[$portlet_group_id]->getPortletList();
                }
                $group_portlet_list_for_view = [];
                foreach (array_keys($group_portlet_list) as $group_portlet_id) {
                    $app_id = explode(".",
                        $group_portlet_list[$group_portlet_id]->get('type'));
                    if (array_key_exists($app_id[1], $app_ids_availability)) {
                        if ( ! $app_ids_availability[$app_id[1]]) {
                            continue;
                        }
                    }
                    if ( ! $portal_send) {
                        if ($app_id[1] == 'portal' && $app_id[2] == 'send') {
                            continue;
                        }
                    }

                    $group_portlet_for_view = [];
                    foreach (
                        $translation_map_portlet as $view_name => $model_name
                    ) {
                        if ($model_name === '_id') {
                            $group_portlet_for_view[$view_name]
                                = $group_portlet_id;
                        } else {
                            $portlet_type
                                = $group_portlet_list[$group_portlet_id]->get('type');
                            if ($portlet_type === GRN_PRTL_PORTLET_TYPE_HTML
                                || $portlet_type === GRN_PRTL_PORTLET_TYPE_PHP
                            ) {
                                $group_portlet_for_view[$view_name]
                                    = $group_portlet_list[$group_portlet_id]->get($model_name);
                            } else {
                                $layout = false;
                                $group_portlet_for_view[$view_name]
                                    = $system_embedded_portletlogic->getDisplayName($group_portlet_list[$group_portlet_id],
                                    $layout);
                            }
                        }
                    }
                    $key = 'p'
                           . $group_portlet_for_view['ppid'];
                    $group_portlet_list_for_view = $group_portlet_list_for_view
                                                   + [$key => $group_portlet_for_view['title']];
                }
                $portlet_group_for_view['portlet']
                    = $group_portlet_list_for_view;
                break;
            default:
                break;
        }
    }
    $portlet_group_list_for_view[$portlet_group_id] = $portlet_group_for_view;
}

// Assign Portal ID DisplayInfomation
$t->assign('portal_id', $portal_id);
// Assign Portal Position Display Infomation
$t->assign('portal_position', $portal_position);
// Assign All Portlet Display Infomation
$t->assign('all_portlet', $portlet_list_for_view);
// Assign Portlet Group Display Infomation
$t->assign('group', $portlet_group_list_for_view);

$index = @ $G_INPUT['index'];

//-- set page title and site position
$t->assign('index', $index);
// page title
$page_title = grn_get_current_page_display_name();

$t->assign('page_title', $page_title);

// site position 
$t->assign(
    'site_position', [
        [
            'page' => "portal/operation/view",
            'name' => grn_get_page_display_name('portal/operation/view'),
            'pid'  => $portal_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);


