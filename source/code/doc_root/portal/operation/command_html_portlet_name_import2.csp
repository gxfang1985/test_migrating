<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! @$G_INPUT['file_id']) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $file_id = $G_INPUT['file_id'];

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession('portal/operation/html_portlet_name_import1');
    $files = $session->getFiles('import_files');

    if ( ! is_array($files) || 0 == count($files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }
    if ( ! array_key_exists($file_id, $files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }
    if ( ! $files[$file_id]->exists()) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    $charset = @$G_INPUT['charset'];
    $skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;

    // CSVの読み込み
    require_once('portal/operation_portlet_logic.csp');
    $logic = GRN_Portal_OperationHTMLPortletLogic::getInstance();
    $logic->importHTMLPortletNameWithCSV($files[$file_id]->getPath(), $charset,
        $skip);

    //ファイルの削除
    foreach (array_keys($files) as $id) {
        $session->unsetFile('import_files', $id);
    }

    cb_redirect('portal/operation/html_portlet_list', ['sf' => 1]);
}
