<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once("_access_util.csp");

    //アクセス権対象オブジェクトを取得
    if (0 < intval($layout_id)) {
        require_once('portal/portlet_layout_logic.csp');
        $layout_logic = GRN_Portal_PortletLayoutLogic::getInstance();
        $object =& $layout_logic->get($layout_id);
        if ( ! $object) {
            require_once('portal/error_code.csp');
            cb_throw_error(E_GRN_PRTL_PORTLET_LAYOUT_NOT_FOUND);
        }
    } else {
        require_once('portal/portal_logic.csp');
        $portal_logic = GRN_Portal_SystemPortalLogic::getInstance();
        $object_list = $portal_logic->getList();
        $object =& $object_list[$portal_id];
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession(GRN_PRTL_MODULE_ID);

    // セキュリティ・モデルを変更する
    $security_model = $session->get('security_model');
    $logic->setSecurityModel($object_id, $security_model);

    // 運用管理者自身のアクセス権は維持
    if ( ! $logic->evaluateAccess($object, false)) {
        // アクセス権の追加
        global $G_portal_login_user;
        $authorities = ['browse' => 1];
        $logic->addAccess($object_id, GRN_PRTL_TARGET_TYPE_USER,
            $G_portal_login_user->getOID(), $authorities);
    }

    // アクセス権ページにリダイレクトする
    cb_redirect('portal/operation/access_list',
        [
            'pid'  => $portal_id,
            'plid' => $layout_id
        ]);
}


