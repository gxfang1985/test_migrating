<?php

// Check HTTP-POST Method
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('portal/error_code.csp');
    if ( ! isset($portlet)) {
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
    }

    global $G_INPUT;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Create Parameter Translation Map
    $translation_map = [
        'pid'         => '_pid',
        'plid'        => '_plid',
        'ppid'        => '_ppid',
        'data'        => 'data',
        'editor'      => 'editor',
        'use_frame'   => 'use_frame',
        'frame_style' => 'frame_style'
    ];

    //Do Parameter Translation
    $properties = [];
    foreach ($translation_map as $view_name => $model_name) {
        $properties[$model_name] = @ $G_INPUT[$view_name];
    }

    //Check RichEditor
    if ($properties['editor']) {
        //Wash Script Code
        require_once('grn/controller.csp');
        $properties['data']
            = grn_wash_script_without_style_attribute($properties['data']);
    }

    //Create Infomation Portlet Settings
    $settings = [
        'data'        => $properties['data'],        //Information Data
        'editor'      => $properties['editor'],      //Information Editor
        'use_frame'   => $properties['use_frame'],   //Information Frame
        'frame_style' => $properties['frame_style'] //Information Frame Color
    ];

    // GRN2-6685
    $limit = 65000; // bytes
    if (strlen($properties['data']) > $limit) {
        require_once('portal/error_code.csp');
        cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_CONTENT, null,
            ['limit' => $limit]);
    }
    // GRN2-6685

    //Set Infomation Portlet Settings Application
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app_portal */
    $app_portal =& $app_locator->getInstance('portal');
    $app_portal->setPortletSettings($properties['_plid'], $settings);

    //Switch Redirect Page
    if ($G_INPUT['display'] === 'set-system') {
        //redirect System page
        cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
    } elseif ($G_INPUT['display'] === 'set-operation') {
        //redirect Operation page
        cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
    } else {
        //redirect Personal page
        cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
    }
}


