<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

if ( ! defined('ON_FOREST')) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;


    // Create Parameter Translation Map
    $translation_map = [
        'source' => 'source',   //Portlet Source
    ];


    // Do Parameter Translation
    $portlet_for_view = [];
    foreach ($translation_map as $view_name => $model_name) {
        $portlet_for_view[$view_name] = $portlet[$model_name];
    }

    // Get Identifier Value List
    require_once('grn/sso.csp');
    $sso_service = GRN_SSO_Service::getInstance();
    $identifier_value_list = $sso_service->getIdentifierValueList();

    // Replace Identifier value List
    $source
        = $sso_service->replaceIdentifierValueList($portlet_for_view['source'],
        $identifier_value_list);

    // Get CSRF Ticket
    require_once('fw/csrf.csp');
    require_once('portal/resources.csp');
    $source = str_replace(GRN_PRTL_PORTLET_CSRF_IDENTIFIER, cb_csrf_get_token(),
        $source);

    // Eval PHP Portlet Source
    ob_start();
    try {
        eval('?> ' . $source . '<?php ');
    } catch (ParseError $e) {
        $message = sprintf('%s: %s in %s:%d', get_class($e), $e->getMessage(),
            $e->getFile(), $e->getLine());
        require_once($t->_get_plugin_filepath('modifier', 'escape'));
        echo smarty_modifier_escape($message);
    }
    $result = ob_get_clean();

    // Assign Portlet Group Display Information
    $t->assign('result', $result);

    //-- set page title and site position

    // Ignore Licence Warnning
    $t->skipWarning();

    // Display Smarty Template
    $doc_name = cb_get_pagename();
    $t->display("portal/portlet/view_php.tpl");
}
