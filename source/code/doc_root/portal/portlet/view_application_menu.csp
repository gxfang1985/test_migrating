<?php

use grn\grn\access\utility\AppAvailabilityUtil;
use grn\grn\access\service\AppAccess;

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;


//Get applications id for user login or uid

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();
if ( ! is_object($login) || ! is_a($login, 'CB_User')) {
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
$user_id = $login->getOID();
global $G_INPUT;
if (array_key_exists('uid', $G_INPUT)
    && 0 != @intval($G_INPUT['uid'])
    && $uum->getUser($G_INPUT['uid']) !== false
) {
    $user_id = $G_INPUT['uid'];
}
$app_ids_extension = AppAvailabilityUtil::getAppIdsExtension();

if (cb_is_system_page() || cb_is_operation_page()) {
    $app_ids = AppAccess::getAvailableAppIdsInternalByUserId($user_id);
} else {
    $app_ids = AppAccess::getAvailableAppIdsByUserId($user_id);
}

//Get Extended Application Menu
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$extended_application_menu = $manager->getDefaultApplicationMenu();
$extended_application_list = $extended_application_menu->listMenu();

// Create Parameter Translation Map For Extended Application
$translation_map_extended_application = [
    'app_id'   => 'app_id',   //Application ID
    'name'     => 'name',     //Application Name
    'location' => 'location', //Application Location
    'icon'     => 'icon',     //Application Icon
];

$extended_application_list_for_view = [];
foreach (array_keys($extended_application_list) as $extended_application_index) {
    $extended_application
        = $extended_application_list[$extended_application_index];

    //Exclude Not Active Application
    $app_id = $extended_application['app_id'];
    if ( ! is_null($app_id) && ! in_array($app_id, $app_ids)
         && ! in_array($app_id, $app_ids_extension)
    ) {
        continue;
    }

    $extended_application_for_view = [];
    foreach ($translation_map_extended_application as $view_name => $model_name) {
        $extended_application_for_view[$view_name]
            = $extended_application[$model_name];
        switch ($model_name) {
            case 'location':
                if ( ! is_null($extended_application['app_id'])) {
                    if ($extended_application_for_view['app_id']
                        == GRN_SCHEDULE_APPLICATION_ID
                        && strpos($extended_application_for_view['location'],
                            "schedule/facility_index") !== false
                    ) {
                        $extended_application_for_view['app_id'] = "facility";
                    }
                    $extended_application_for_view[$view_name]
                        = cb_format_url($extended_application[$model_name]);
                } else {
                    $extended_application_for_view[$view_name]
                        = $extended_application[$model_name];
                }
                break;
            default:
                $extended_application_for_view[$view_name]
                    = $extended_application[$model_name];
                break;
        }
    }
    $extended_application_list_for_view[] = $extended_application_for_view;
}

//Check Portlet Settings
//Initialize Portlet Settings
if ( ! array_key_exists('settings', $portlet)) {
    $portlet['settings'] = [];
    $portlet['settings']['font_size'] = 'normal';    //Default Font Size
    $portlet['settings']['use_turnup'] = '0';         //Default Use Turnup
    $portlet['settings']['turnup_size'] = '5';         //Default Turnup Size
    $portlet['settings']['display_type'] = '0';         //Default Display Type
}

//Assign Display Information
//Assign Portlet Settings View Information
$t->assign('settings', $portlet['settings']);

//Assign Extended Application View Information
$t->assign('extended_application', $extended_application_list_for_view);

//-- set page title and site position

//Set Page Title
if ($portlet['title'] === '') {
    global $G_portal_app_name;
    $page_title = cb_plain_msg('grn.portal', 'portlet_view_application_menu',
        ['app_name' => $G_portal_app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

// Ignore Licence Warning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("portal/portlet/view_application_menu.tpl");


