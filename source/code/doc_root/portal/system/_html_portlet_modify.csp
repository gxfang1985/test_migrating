<?php

//Get HTML Portlet ID
$portlet_id = @ $G_INPUT['plid'];

//Get Display HTML Portlet
require_once('portal/system_portlet_logic.csp');
$system_html_portletlogic = GRN_Portal_SystemHTMLPortletLogic::getInstance();
$portlet =& $system_html_portletlogic->get($portlet_id);

//Get Portlet Group
require_once('portal/portlet_group_logic.csp');
$system_portlet_grouplogic = GRN_Portal_SystemPortletGroupLogic::getInstance();
$portlet_group_list = $system_portlet_grouplogic->getList();

// Create Parameter Translation Map for Portlet
$translation_map_portlet = [
    'plid'      => '_id',                  //Portlet ID
    'plgid'     => '_id',                  //Portlet Group ID
    'group'     => 'group',                //Portlet Group Name
    'type'      => 'type',                 //Portlet Type
    'my_portal' => 'available_myportal',   //Available MyPortlet
    'editor'    => 'editor',               //Use HTML Editor Flag
    'data'      => 'source',               //Portlet Source
];

// Create Parameter Translation Map for Portlet Group
$translation_map_group = [
    'plgid' => '_id',          //Portlet Group ID
    'title' => 'name',         //Portlet Group Name
];

// Do Parameter Translation for Portlet
$portlet_for_view = [];
foreach ($translation_map_portlet as $view_name => $model_name) {
    if ($view_name === 'plid') {
        $portlet_for_view[$view_name] = $portlet->getOID();
    } elseif ($view_name === 'plgid') {
        $portlet_group = $portlet->get('group');
        if ($portlet_group) {
            $portlet_for_view[$view_name] = $portlet_group->getOID();
        }
    } elseif ($view_name === 'group') {
        $portlet_group = $portlet->get('group');
        if ($portlet_group) {
            $portlet_for_view[$view_name] = $portlet_group->get('name');
        }
    } else {
        $portlet_for_view[$view_name] = $portlet->get($model_name);
    }
}

// Check HTML or Text Data
if ($portlet_for_view['editor'] == 1) {
    $portlet_for_view['text'] = null;
    $portlet_for_view['html'] = $portlet_for_view['data'];
} else {
    $portlet_for_view['text'] = $portlet_for_view['data'];
    $portlet_for_view['html'] = null;
}

// Do Parameter Translation for Portlet Group
$portlet_group_list_for_view = [];
foreach (array_keys($portlet_group_list) as $portlet_group_id) {
    $portlet_group_for_view = [];
    foreach ($translation_map_group as $view_name => $model_name) {
        if ($model_name === '_id') {
            $portlet_group_for_view[$view_name]
                = $portlet_group_list[$portlet_group_id]->getOID();
        } else {
            $portlet_group_for_view[$view_name]
                = $portlet_group_list[$portlet_group_id]->get($model_name);
        }
    }

    $portlet_group_list_for_view[$portlet_group_id] = $portlet_group_for_view;
}

//Get User Config
global $G_portal_login_user;
require_once('grn/ui.csp');
$config_manager = GRN_UIConfigManager::getInstance();
$user_config = $config_manager->getUserConfig($G_portal_login_user);

//Create RichEditor Information
$richeditor_for_view = [];
$richeditor_for_view['rows'] = $user_config->getAreaHeight();
$richeditor_for_view['cols'] = $user_config->getAreaWidth();

// Assign Portlet and Poetlet Group Display Infomation
$t->assign('portlet', $portlet_for_view);
$t->assign('portlet_group', $portlet_group_list_for_view);
// Assign RichEditor Display Infomation
$t->assign('richeditor', $richeditor_for_view);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "portal/system/html_portlet_list",
            'name' => grn_get_page_display_name('portal/system/html_portlet_list'),
            'sf'   => 1
        ],
        [
            'page' => "portal/system/html_portlet_view",
            'name' => grn_get_page_display_name('portal/system/html_portlet_view'),
            'plid' => $portlet_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);


