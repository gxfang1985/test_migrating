<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if (0 == strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD', ''), 'POST')) {
    require_once('portal/access_logic.csp');

    $logic = GRN_Portal_MyPortalAccessLogic::getInstance();
    $object = $logic->getObject();
    $object_id = $object->getOID();

    $uum = $G_container_base->getInstance('uum');
    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $dynamic_roles = $uum_util->listDynamicRoles();

    // 入力フォームデータを取得する
    $eid = cb_at($G_INPUT, 'eid', []);   // アクセス権キーの一覧

    // 削除するアクセス権リスト作成
    $accesses = [];
    foreach ($eid as $item) {
        $ids = explode(':', $item);
        if (count($ids) < 2) {
            continue;
        }
        $id = $ids[1];
        switch ($ids[0]) {
            case 'user':
                if ( ! ($uum->getUser($id))) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_USER_ID);
                }

                // アクセス権が設定されているかチェック
                if ($access = $logic->getAccess($object_id, $ids[0], $ids[1])) {
                    // アクセス権の削除リストに追加
                    array_push($accesses, $access);
                }
                break;

            case 'group':
                if ( ! ($uum->getGroup($id))) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_GROUP_ID);
                }

                // アクセス権が設定されているかチェック
                if ($access = $logic->getAccess($object_id, $ids[0], $ids[1])) {
                    // アクセス権の削除リストに追加
                    array_push($accesses, $access);
                }
                break;

            case 'static_role':
                if ( ! ($uum->getStaticRole($id))) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_ROLE_ID);
                }

                // アクセス権が設定されているかチェック
                if ($access = $logic->getAccess($object_id, $ids[0], $ids[1])) {
                    // アクセス権の削除リストに追加
                    array_push($accesses, $access);
                }
                break;

            case 'dynamic_role':
                if ( ! (array_key_exists($id, $dynamic_roles))) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_ROLE_ID);
                }

                // アクセス権が設定されているかチェック
                if ($access = $logic->getAccess($object_id, $ids[0], $ids[1])) {
                    // アクセス権の削除リストに追加
                    array_push($accesses, $access);
                }
                break;
        }
    }

    // アクセス権の一覧を削除する
    $logic->deleteAccesses($object_id, $accesses);

    // Myポータルの使用権限ページにリダイレクトする
    cb_redirect('portal/system/availability_list');
}

