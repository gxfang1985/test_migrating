<?php
//--current organization id
$poid = cb_at($G_INPUT, 'poid', null);

if (isset($t) && ! is_null($t)) {
    $t->assign('poid', $poid);
}

//--category
// 入力フォームデータを取得する
$portlet_id = cb_at($G_INPUT, 'plid', null);   // ポートレットID
$layout_id = cb_at($G_INPUT, 'ppid', null);    // ポートレット配置情報ID

$ours_params = [];
$ours_params['ppid'] = $portlet_id;
$ours_params['plid'] = $layout_id;

$node_id = cb_at($G_INPUT, 'nid', null);
if (is_null($node_id)) {
    $node_id = $portlet_id;
}

$node = [];
if ($node_id) {
    require_once('portal/manage_logic.csp');
    $portlet_logic = GRN_Portal_SystemPortletGroupManageLogic::getInstance();
    $portlet = $portlet_logic->getObject($node_id);
    if ( ! $portlet) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    // Smartyにシステムポータル情報を割り当てる
    $portlet_name = $portlet->get('name');

    $node['nid'] = $node_id;
    $node['name'] = $portlet_name;
    $node['type'] = 'portlet';

    if (0 < intval($layout_id)) {
        $logic = GRN_Portal_PortletLayoutAccessLogic::getInstance();
        $layout = $logic->getObject($layout_id);
        $portlet = $layout->get('portlet');

        // Smartyにポートレット配置情報を割り当てる
        $portlet_type = $portlet->get('type');
        if ($portlet_type === GRN_PRTL_PORTLET_TYPE_HTML
            || $portlet_type === GRN_PRTL_PORTLET_TYPE_PHP
        ) {
            require_once('portal/system_portlet_logic.csp');
            $system_portletlogic_base
                = GRN_Portal_SystemPortletLogicBase::getInstance();
            $portlet_name = $system_portletlogic_base->getDisplayName($portlet,
                $layout);
        } else {
            require_once('portal/system_portlet_logic.csp');
            $system_embedded_portletlogic
                = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();
            $portlet_name
                = $system_embedded_portletlogic->getDisplayName($portlet,
                $layout);
        }

        $node['name'] = $portlet_name;
        $node['type'] = 'portlet';

        $object_id = $layout_id;
    } elseif (0 < intval($node_id)) {
        $object_id = $node_id;
    } else {
        cb_throw_error(E_GRN_PRTL_ACCESS_INVALID_OBJECT_ID);
    }
}

if (isset($t) && ! is_null($t)) {
    unset($ours_params['sp']);
    $t->assign('ours_params', $ours_params);
    $t->assign('node_id', $node_id);
    $t->assign('node', $node);
}

