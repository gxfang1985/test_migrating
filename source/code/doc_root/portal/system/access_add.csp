<?php

use grn\grn\access\service\AppAccess;

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$pid = @ $G_INPUT['pid'];     // ポータルID
$plid = @ $G_INPUT['plid'];   // ポートレット配置情報ID
$ppid = @ $G_INPUT['ppid'];

$ous_params = [];
if (0 < strlen($pid)) {
    $ous_params = ['pid' => $pid];

}

if (0 < strlen($plid)) {
    $ous_params = array_merge($ous_params, ['plid' => $plid]);
}

if (0 < strlen($ppid)) {
    $ous_params = array_merge($ous_params, ['ppid' => $ppid]);
}

// GTM-529
//Get Column Items
require_once('portal/portal_logic.csp');
$system_portalLogic = GRN_Portal_SystemPortalLogic::getInstance();
$column_items
    =& $system_portalLogic->getColumnItemsWithoutPrivilege($pid);

//Get Layout Object
$layout = null;
foreach (array_keys($column_items) as $column_key) {
    $layout_items =& $column_items[$column_key];
    foreach (array_keys($layout_items) as $layout_key) {
        if ($layout_items[$layout_key]->getOID() === $plid) {
            $layout =& $layout_items[$layout_key];
        }
    }
}

$app_id = null;
if ($layout) {
    $portlet =& $layout->get('portlet');
    if ( ! $portlet) {
        /** Portlet Not Found **/
        cb_throw_error(E_GRN_PRTL_PORTLET_NOT_FOUND);
    }

    $app_ids_availability
        = AppAccess::getAvailabilityAppIdsInternalByUserId(cb_get_login_user()->getOID());
    $portlet_type = explode(".", $portlet->get('type'));
    $app_id = $portlet_type[1];
    if (array_key_exists($app_id, $app_ids_availability)) {
        if ( ! $app_ids_availability[$app_id]) {
            cb_throw_error(E_GRN_PRTL_PORTLET_NOT_AVAILABLE);
        }
    } else {
        if ($portlet_type[2] != 'send') {
            $app_id = null;
        } else {
            if ( ! array_key_exists('message', $app_ids_availability)
                 || ! $app_ids_availability['message']
            ) {
                if ( ! array_key_exists('mail', $app_ids_availability)
                     || ! $app_ids_availability['mail']
                ) {
                    cb_throw_error(E_GRN_PRTL_PORTLET_NOT_AVAILABLE);
                }
            }
        }
    }
}

$session_name = 'portal.system.access_add';
$can_select_role = true;
$search_login_name = true;
require_once('grn/org_user_role_select.csp');
$t->assign('ous_params', $ous_params);

$t->assign('listbox_size', $navigation_info['navi']['number_on_page'] + 1);

// tree link page
$t->assign('link_page', cb_get_pagename());

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_info = [
    'list'        => [],
    'view'        => ['pid' => $pid],
    'access_list' => $ous_params,
    'access_add'  => null
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('portal/system/', $page_info);
$t->assign('site_position', $site_position);

// （ビューで表示するための）権限情報一覧を取得する
$authority_types = ['browse' => cb_msg('grn.portal.lang', 'access_browse')];
$t->assign('authority_types', $authority_types);
$t->assign('authority_count', count($authority_types));

//Get Security Model
$node_id = @ $G_INPUT['nid'];
if (is_null($node_id)) {
    $node_id = $pid;
}

if ($node_id) {
    require_once('portal/access_logic.csp');
    $portal_logic = GRN_Portal_SystemPortalAccessLogic::getInstance();
    $portal =& $portal_logic->getObject($node_id);
    if ( ! $portal) {
        cb_throw_error(E_GRN_BULLETIN_CATEGORY_NOT_FOUND);
    }
    if (0 < intval($plid)) {
        $logic = GRN_Portal_PortletLayoutAccessLogic::getInstance();
        require_once('portal/portlet_util.csp');
        $layout = GRN_Portal_PortletUtil::getPortletLayout($plid);
        if ( ! $layout) {
            require_once('portal/error_code.csp');
            cb_throw_error(E_GRN_PRTL_PORTLET_LAYOUT_NOT_FOUND);
        }
        $object_id = $plid;
    } elseif (0 < intval($node_id)) {
        $logic =& $portal_logic;
        $object_id = $node_id;
    } else {
        cb_throw_error(E_GRN_PRTL_ACCESS_INVALID_OBJECT_ID);
    }
}
$security_model = $logic->getSecurityModel($object_id);
$t->assign('is_grant', $security_model == 'grant');

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

