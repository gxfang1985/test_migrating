<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// Get Selected Oganization ID
$organization_id = @$G_INPUT['oid'];
$organization_id = is_null($organization_id) ? 0 : $organization_id;

// Get Organization Portal ID
require_once('portal/system_logic.csp');
$portal_systemlogic = GRN_Portal_SystemLogic::getInstance();
$portal_id
    = $portal_systemlogic->getOrganizationLoginPortal($organization_id);

// Get Organization Portal
require_once('portal/portal_logic.csp');
$system_portallogic = GRN_Portal_SystemPortalLogic::getInstance();
$portal_list = $system_portallogic->getList();
$portal_name = '';
if (array_key_exists(intval($portal_id), $portal_list)) {
    $portal_name = $portal_list[$portal_id]->get(GRN_PRTL_PROPERTY_NAME);
} else {
    $portal_id = 0;
    $portal_name = '';
}

// Get My Portlet Template ID
require_once("portal/system_logic.csp");
$system_logic = GRN_Portal_SystemLogic::getInstance();
$my_portal_template_id = $system_logic->getMyPortaltemplate();

// Create Parameter Translation Map for Set Portal
$translation_map_set_portal = [
    'pid'   => '_id',                  //Portal ID
    'title' => 'name',                 //Portal Name
    'open'  => 'is_open',              //Portal Open Flag
];

// Create Parameter Translation Map for Portal
$translation_map_portal = [
    'pid'   => '_id',                  //Portal ID
    'title' => 'name',                 //Portal Name
    'open'  => 'is_open',              //Portal Open Flag
];

// Do Parameter Translation for Set Portal
$set_portal_for_view = [];
foreach ($translation_map_set_portal as $view_name => $model_name) {
    if ($model_name === '_id') {
        $set_portal_for_view[$view_name] = $portal_id;
    } elseif ($model_name === 'name') {
        $set_portal_for_view[$view_name] = $portal_name;
    }
}

// Do Parameter Translation for Portal
$portal_list_for_view = [];
foreach (array_keys($portal_list) as $portal_id) {
    $portal_for_view = [];

    //Exclude My Portal Template from Portal List
    if (intval($portal_id) === intval($my_portal_template_id)) {
        continue;
    }

    foreach ($translation_map_portal as $view_name => $model_name) {
        if ($model_name === '_id') {
            $portal_for_view[$view_name] = $portal_id;
        } else {
            $portal_for_view[$view_name]
                = $portal_list[$portal_id]->get($model_name);
        }
    }

    $portal_list_for_view[$portal_id] = $portal_for_view;
}

// Assign First Portal Display Infomation
// Assign Selected Organization ID
$t->assign('organization_id', $organization_id);
// Assign Set Portal Display Infomation
$t->assign('set_portal', $set_portal_for_view);
// Assign Selected Portal List Display Infomation
$t->assign('portal', $portal_list_for_view);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position 
$t->assign(
    'site_position', [
        [
            'page' => "portal/system/first_portal_list",
            'name' => grn_get_page_display_name('portal/system/first_portal_list'),
            'oid'  => $organization_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


