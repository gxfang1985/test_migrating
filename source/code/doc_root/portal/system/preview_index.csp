<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- portal id
$portal_id = @ $G_INPUT['pid'];

//-- get parameters from URL parameters
$org_id = @ $G_INPUT['oid'];        // organization id

//-- prepare uum and uum_util
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

require_once('grn/org_tree.csp');

$page_name = cb_get_pagename();

$util = GRN_OrgTreeUtil::getInstance();
$tree =& $util->getTree($page_name);

if (is_null($org_id)) {
    $org_id = $tree->getSelectedNode();
}

if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
    $tree->initialize();
    $org_id = null;
}
$tree->setSelectedNode($org_id);
$util->setTree($page_name, $tree);
$org = $tree->getRoot();

require_once('grn/org_util.csp');

//--group information structure
$navi_info = null;
$user_list = null;
if ($org_id) {
    //--N-navigation
    $navi_params = ['pid' => $portal_id, 'oid' => $org_id];
    $navi_info = grn_get_user_list_info($org_id, $navi_params);

    //--user list
    $user_list = grn_get_user_list($org_id, $navi_info);
}

//-- set variables for view
$t->assign('portal_id', $portal_id);
$t->assign('org_id', $org_id);
$t->assign('page_name', $page_name);
$t->assign('org', $org);
$t->assign('navi_info', $navi_info);
$t->assign('user_list', $user_list);
$t->assign('is_nogroups', 0 > $org_id);
$t->assign('is_root', ! $org_id);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$site_position = [
    [
        'page' => 'portal/system/list',
        'name' => grn_get_page_display_name('portal/system/list')
    ],
    [
        'page' => 'portal/system/view',
        'name' => grn_get_page_display_name('portal/system/view'),
        'pid'  => $portal_id
    ],
    ['page' => '', 'name' => $page_title],
];
$t->assign('site_position', $site_position);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

