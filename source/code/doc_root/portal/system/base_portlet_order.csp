<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Portal ID
$portal_id = @ $G_INPUT['pid'];
$position = @ $G_INPUT['position'];

//Get Portal and Column Items
require_once('portal/portal_logic.csp');
$system_portallogic = GRN_Portal_SystemPortalLogic::getInstance();
$portal =& $system_portallogic->get($portal_id);
$column_items
    =& $system_portallogic->getColumnItemsWithoutPrivilege($portal_id);

//Get Layout Items
$column_list = [];
$position = @ $G_INPUT['position'];
switch ($position) {
    case 'top':
        $layout_items =& $column_items[0];
        break;
    case 'left':
        $layout_items =& $column_items[1];
        break;
    case 'center':
        $layout_items =& $column_items[2];
        break;
    case 'right':
        $layout_items =& $column_items[3];
        break;
    default:
        $layout_items =& $column_items[0];
        break;
}

//Create Parameter Translation Map for Portal
$translation_map_portal = [
    'pid'  => '_id',              //Portal ID
    'name' => 'name',             //Portal Name
];

//Do Parameter Translation for Portal
$portal_for_view = [];
foreach ($translation_map_portal as $view_name => $model_name) {
    switch ($model_name) {
        case '_id':
            $portal_for_view[$view_name] = $portal->getOID();
            break;
        default:
            $portal_for_view[$view_name] = $portal->get($model_name);
            break;
    }
}

//check $layout Item Count
if (count($layout_items) != 0) {
    //Get Embedded Portlet Logic
    require_once('portal/system_portlet_logic.csp');
    $embedded_portlet_logic
        = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();

    // Create Parameter Translation Map for Portlet Layout
    $translation_map_portlet_layout = [
        'pid'   => '_id',          //Portal ID
        'ppid'  => '_id',          //Portlet layout ID
        'plid'  => '_id',          //Portlet ID
        'name'  => 'display_name', //Portlet Display Name
        'title' => 'name',         //Portlet Name
    ];

    //Do Parameter Translation for Portlet Layout
    $layout_items_for_view = [];
    foreach (array_keys($layout_items) as $layout_key) {
        $layout_item_for_view = [];
        $portlet =& $layout_items[$layout_key]->get('portlet');

        //Check Avaliable MyPortal Flag
        $available_myportal
            = $portlet->get(GRN_PRTL_PROPERTY_AVAILABLE_MYPORTAL);
        if ($available_myportal != 1) {
            continue;
        }

        foreach ($translation_map_portlet_layout as $view_name => $model_name) {
            switch ($view_name) {
                case 'pid':
                    $layout_item_for_view[$view_name] = $portal->getOID();
                    break;
                case 'plid':
                    $layout_item_for_view[$view_name]
                        = $layout_items[$layout_key]->getOID();
                    break;
                case 'ppid':
                    $layout_item_for_view[$view_name] = $portlet->getOID();
                    break;
                case 'title':
                    $portlet_type = $portlet->get('type');
                    if ($portlet_type === GRN_PRTL_PORTLET_TYPE_HTML
                        || $portlet_type === GRN_PRTL_PORTLET_TYPE_PHP
                    ) {
                        $layout_item_for_view[$view_name]
                            = $portlet->get($model_name);
                    } else {
                        $dummy = null;
                        $layout_item_for_view[$view_name]
                            = $embedded_portlet_logic->getDisplayName($portlet,
                            $dummy);
                    }
                    break;
                case 'name':
                    $layout_item_for_view[$view_name]
                        = $layout_items[$layout_key]->get($model_name);
                    break;
                default:
                    $layout_item_for_view[$view_name]
                        = $portlet->get($model_name);
                    break;
            }
        }

        $layout_items_for_view[$layout_item_for_view['plid']]
            = $layout_item_for_view;
    }

    //Create Portlet Options
    $portlet_options = [];
    foreach (array_keys($layout_items_for_view) as $layout_id) {
        $name = $layout_items_for_view[$layout_id]['name'];
        $title
            = $layout_items_for_view[$layout_id]['title'];
        $portlet_options[$layout_id] = $name ? $name : $title;
    }
} else {
    //Portlet Empty
    $portlet_options = [];
}

//Assign Display Infomation
//Assign Portal ID
$t->assign('portal_id', $portal_id);
//Assign Portal
$t->assign('portal', $portal_for_view);
//Assign Position
$t->assign('position', $position);
//Assign Portlet Options
$t->assign('portlet_options', $portlet_options);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$t->assign(
    'site_position', [
        [
            'page' => "portal/system/base_view",
            'name' => grn_get_page_display_name('portal/system/base_view'),
            'pid'  => $portal_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


