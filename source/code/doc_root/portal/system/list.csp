<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// for site position
$t->assign('app_id', 'portal');

//Get System Embadded Portlet Logic
require_once('portal/system_portlet_logic.csp');
$system_embedded_portletlogic
    = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();

//Get System Portal List
require_once('portal/portal_logic.csp');
$system_portallogic = GRN_Portal_SystemPortalLogic::getInstance();
$portal_rows = $system_portallogic->getList();

// Get My Portlet Template ID
require_once("portal/system_logic.csp");
$system_logic = GRN_Portal_SystemLogic::getInstance();
$my_portal_template_id = $system_logic->getMyPortaltemplate();

require_once('portal/access_logic.csp');
$al = GRN_Portal_SystemPortalAccessLogic::getInstance();

$portal_list = [];
foreach (array_keys($portal_rows) as $id) {
    //Exclde My Portal Template from Portal List
    if (intval($id) === intval($my_portal_template_id)) {
        continue;
    }

    $accesses = $al->getAccesses($id);

    $portal_row = $portal_rows[$id];

    $portal_list[$id] = [
        'pid'            => $id,
        'name'           => $portal_row->get('name'),
        'is_open'        => $portal_row->get('is_open'),
        'security_model' => $al->getSecurityModel($id),
        'access_count'   => count($accesses),
    ];
}

$t->assign('portal_list', $portal_list);
$t->assign('portal_count', count($portal_list));

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


