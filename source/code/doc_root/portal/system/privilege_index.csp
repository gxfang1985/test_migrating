<?php
// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'portal');

//Get Selected Portal ID
$selected_portal_id = @ $G_INPUT['pid'];

//Get System Portal List
require_once('portal/portal_logic.csp');
$system_portal_logic = GRN_Portal_SystemPortalLogic::getInstance();
$portal_list = $system_portal_logic->getList();

//Get My Portlet Template ID
require_once("portal/system_logic.csp");
$system_logic = GRN_Portal_SystemLogic::getInstance();
$my_portal_template_id = $system_logic->getMyPortaltemplate();

//Get Selected Portal ID
if (is_null($selected_portal_id) || strlen($selected_portal_id) == 0) {
    //Get Selected Portal
    $selected_portal_id = null;
    foreach (array_keys($portal_list) as $portal_id) {
        if ($portal_id != $my_portal_template_id) {
            $selected_portal_id = $portal_id;
            break;
        }
    }
}

//Create Parameter Translation Map for Portal List
$translation_map_for_portal = [
    'nid'          => '_pid',
    'name'         => 'name',
    'access_count' => 'focus',
];

// Do Parameter Translation
$portal_list_for_view = [];
foreach (array_keys($portal_list) as $portal_id) {
    //Exclde My Portal Template from Portal List
    if (intval($portal_id) === intval($my_portal_template_id)) {
        continue;
    }

    //Get Management Count
    require_once('portal/manage_logic.csp');
    $portal_manage_logic = GRN_Portal_SystemPortalManageLogic::getInstance();
    $manage_list = $portal_manage_logic->getManageList($portal_id);
    $access_count = count($manage_list);

    $portal_for_view = [];
    foreach ($translation_map_for_portal as $view_name => $model_name) {
        switch ($model_name) {
            case '_pid':
                $portal_for_view[$view_name] = $portal_id;
                break;
            case 'focus':
                $portal_for_view[$view_name] = $access_count;
                break;
            default:
                $portal_for_view[$view_name]
                    = $portal_list[$portal_id]->get($model_name);
                break;
        }
    }
    $portal_list_for_view[$portal_id] = $portal_for_view;
}

//Assign Display Infomation
//Assign Portal List
$t->assign('node_list', $portal_list_for_view);

//-- set page title and site position

require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$page_info = ['privilege_index' => null];
$site_position = $controller_util->makeSitePosition('portal/system/',
    $page_info);
$t->assign('site_position', $site_position);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

