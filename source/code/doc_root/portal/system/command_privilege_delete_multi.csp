<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once '_access_util.csp';

    //Get Parameters
    $selected_portal_id = $G_INPUT['nid'];  //Selected Poatal ID
    $eid = @ $G_INPUT['eid'];
    if ( ! is_array($eid)) {
        cb_redirect('portal/system/privilege_list', $G_INPUT);
    }

    //Get System Portal Manage Logic
    require_once('portal/manage_logic.csp');
    $manage_logic = GRN_Portal_SystemPortalManageLogic::getInstance();

    //Get UUM Instance
    require_once('fw/uum_core.csp');
    $uum =& $G_container_base->getInstance('uum');

    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $dynamic_roles = $uum_util->listDynamicRoles();

    $authorities = ['manage' => 1];
    foreach ($eid as $item) {
        $ids = explode(':', $item);
        if (count($ids) < 2) {
            continue;
        }
        $id = $ids[1];
        switch ($ids[0]) {
            // ���[�U�[�ɃA�N�Z�X����t�^����
            case 'user':
                if ( ! $uum->getUser($id)) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_TARGET_ID);
                }
                // �A�N�Z�X�����ݒ肳��Ă��邩�`�F�b�N
                if ($access =& $manage_logic->getManage($object_id, $ids[0],
                    $ids[1])
                ) {
                    // �A�N�Z�X���̒ǉ�
                    $manage_logic->deleteManageList($selected_portal_id,
                        [$access]);
                }
                break;

            // �g�D�ɃA�N�Z�X����t�^����
            case 'group':
                if ( ! $uum->getGroup($id)) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_TARGET_ID);
                }
                // �A�N�Z�X�����ݒ肳��Ă��邩�`�F�b�N
                if ($access =& $manage_logic->getManage($object_id, $ids[0],
                    $ids[1])
                ) {
                    // �A�N�Z�X���̒ǉ�
                    $manage_logic->deleteManageList($selected_portal_id,
                        [$access]);
                }
                break;

            // �X�^�e�B�b�N���[���ɃA�N�Z�X����t�^����
            case 'static_role':
                if ( ! $uum->getStaticRole($id)) {
                    cb_throw_error(E_GRN_PRTL_MANAGE_INVALID_TARGET_ID);
                }
                // �A�N�Z�X�����ݒ肳��Ă��邩�`�F�b�N
                if ($access =& $manage_logic->getManage($object_id, $ids[0],
                    $ids[1])
                ) {
                    // �A�N�Z�X���̒ǉ�
                    $manage_logic->deleteManageList($selected_portal_id,
                        [$access]);
                }
                break;

            // �_�C�i�~�b�N���[���ɃA�N�Z�X����t�^����
            case 'dynamic_role':
                if ( ! (array_key_exists($id, $dynamic_roles))) {
                    cb_throw_error(GRN_PRTL_TARGET_TYPE_DYNAMIC_ROLE);
                }
                // �A�N�Z�X�����ݒ肳��Ă��邩�`�F�b�N
                if ($access =& $manage_logic->getManage($object_id, $ids[0],
                    $ids[1])
                ) {
                    // �A�N�Z�X���̒ǉ�
                    $manage_logic->deleteManageList($selected_portal_id,
                        [$access]);
                }
                break;
        }
    }

    $params = $G_INPUT;
    unset($params['aid']);
//    cb_redirect( 'portal/system/privilege_list', $params );
    cb_redirect('portal/system/privilege_list', ['nid' => $selected_portal_id]);
}

