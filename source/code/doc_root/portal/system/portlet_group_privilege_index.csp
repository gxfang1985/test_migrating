<?php
// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'portal');

//Get Selected Portlet Group ID
$selected_portlet_group_id = @ $G_INPUT['pgid'];

//Get System Portlet Group List
require_once('portal/portlet_group_logic.csp');
$system_portlet_group_logic = GRN_Portal_SystemPortletGroupLogic::getInstance();
$portlet_group_list = $system_portlet_group_logic->getList();
if (is_null($selected_portlet_group_id)
    || strlen($selected_portlet_group_id) == 0
) {
    if (is_array($portlet_group_list) && count($portlet_group_list) !== 0) {
        $portlet_group_list_keys = array_keys($portlet_group_list);
        $selected_portlet_group_id = current($portlet_group_list_keys);
    } else {
        $selected_portlet_group_id = null;
    }
}

//Create Parameter Translation Map for Portlet Group List
$translation_map_for_portlet_group = [
    'nid'          => '_pgid',
    'name'         => 'name',
    'access_count' => 'focus',
];

// Do Parameter Translation
$portlet_group_list_for_view = [];
foreach (array_keys($portlet_group_list) as $portlet_group_id) {
    //Get Management Count
    require_once('portal/manage_logic.csp');
    $manage_logic = GRN_Portal_SystemPortletGroupManageLogic::getInstance();
    $manage_list = $manage_logic->getManageList($portlet_group_id);
    $access_count = count($manage_list);

    $portlet_group_for_view = [];
    foreach ($translation_map_for_portlet_group as $view_name => $model_name) {
        switch ($model_name) {
            case '_pgid':
                $portlet_group_for_view[$view_name] = $portlet_group_id;
                break;
            case 'focus':
                $portlet_group_for_view[$view_name] = $access_count;
                break;
            default:
                $portlet_group_for_view[$view_name]
                    = $portlet_group_list[$portlet_group_id]->get($model_name);
                break;
        }
    }
    $portlet_group_list_for_view[$portlet_group_id] = $portlet_group_for_view;
}

//Assign Display Infomation
//Assign Portal List
$t->assign('node_list', $portlet_group_list_for_view);
//-- set page title and site position

require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//-- site position
$page_info = ['portlet_group_privilege_index' => null];
$site_position = $controller_util->makeSitePosition('portal/system/',
    $page_info);
$t->assign('site_position', $site_position);

// exec smarty
$t->display(cb_get_pagename() . '.tpl');

