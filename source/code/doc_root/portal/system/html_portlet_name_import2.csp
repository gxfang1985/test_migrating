<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// site position
$page_title = grn_get_current_page_display_name();
$t->assign(
    'site_position', [
        [
            'page' => "portal/system/portlet_import_index",
            'name' => grn_get_page_display_name('portal/system/portlet_import_index')
        ],
        ['page' => "", 'name' => $page_title]
    ]
);


if ( ! @ $G_INPUT['file_id']) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
$file_id = $G_INPUT['file_id'];

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$t->assign('charset', $charset);
$t->assign('skip', $skip);
$t->assign('file_id', $file_id);

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session = $sm->getSession('portal/system/html_portlet_name_import1');
$files = $session->getFiles('import_files');

if ( ! is_array($files) || 0 == count($files)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}
if ( ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}
if ( ! $files[$file_id]->exists()) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

// サンプル行の読み込み
require_once('portal/system_portlet_logic.csp');
$logic = GRN_Portal_SystemHTMLPortletLogic::getInstance();
$lines = $logic->readLinesCSV($files[$file_id]->getPath(), $charset, $skip, 5);

$t->assign('csv_datas', $lines);

$t->display(cb_get_pagename() . ".tpl");

