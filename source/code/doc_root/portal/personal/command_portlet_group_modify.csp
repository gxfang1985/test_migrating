<?php

//Evaluate access of My portal function.
require_once('portal/access_logic.csp');
$myportal_logic = GRN_Portal_MyPortalAccessLogic::getInstance();
$myportal_logic->evaluateAccess();

// Check HTTP-POST Method
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'portal/personal/portlet_group_modify';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // Create Parameter Translation Map
        $translation_map = [
            'plgid' => '_id',
            'title' => 'name',
        ];

        // Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }

        //Modify My Portlet Group
        require_once('portal/portlet_group_logic.csp');
        $my_portlet_group_logic = GRN_Portal_MyPortletGroupLogic::getInstance();
        $portlet_group
            =& $my_portlet_group_logic->modify($properties['_id'],
            $properties['name']);

        //Check Inspection Message Enabled
        require_once('portal/inspection.csp');
        $inspection = GRN_Portal_My_Portlet_Group_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            //Write Inspection Message
            $message_type = 'my_portlet_group_modify';
            $message_args = [
                'pgid'               => $portlet_group->getOID(),
                'portlet_group_name' => $portlet_group->get('name')
            ];
            $inspection->record($message_type, $message_args);
        }

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('portal/personal/portlet_group_view',
            ['plgid' => $properties['_id']]);
    } else {
        //include sharing codes with command_*
        include('_portlet_group_modify.csp');

        //Portlet Group Parameters
        $portlet_for_view = &$t->get_template_vars('portlet_group');
        $portlet_for_view['plid'] = @ $G_INPUT['plid'];
        $portlet_for_view['title'] = @ $G_INPUT['title'];

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }

}
