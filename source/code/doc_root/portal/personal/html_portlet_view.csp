<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// Evaluate access of My portal function.
require_once('portal/access_logic.csp');
$myportal_logic = GRN_Portal_MyPortalAccessLogic::getInstance();
$myportal_logic->evaluateAccess();

//Get HTML Portlet ID
$portlet_id = @ $G_INPUT['plid'];

//Get Display HTML Portlet
require_once('portal/my_portlet_logic.csp');
$my_html_portletlogic = GRN_Portal_MyHTMLPortletLogic::getInstance();
$portlet =& $my_html_portletlogic->get($portlet_id);

// Create Parameter Translation Map
$translation_map = [
    'plid'         => '_id',                  //Portlet ID
    'plgid'        => '_id',                  //Portlet Group ID
    'group'        => 'group',                //Portlet Group Name
    'title'        => 'name',                 //Portlet Name
    'type'         => 'type',                 //Portlet Type
    'my_portal'    => 'available_myportal',   //Available MyPortlet
    'data'         => 'source',               //Portlet Source
    'ctime'        => 'ctime',                //Create Time
    'creator_uid'  => 'creator',              //Creator ID
    'creator_name' => 'creator_name',         //Portal Creator Name
    'mtime'        => 'mtime',                //Modify Time
    'modify_uid'   => 'modifier',             //Modifier ID
    'modify_name'  => 'modifier_name',        //Portal Modifier Name
    'editor'       => 'editor',               //Use HTML Editor Flag
];

// Do Parameter Translation
$portlet_for_view = [];
foreach ($translation_map as $view_name => $model_name) {
    if ($view_name === 'plid') {
        $portlet_for_view[$view_name] = $portlet->getOID();
    } elseif ($view_name === 'plgid') {
        $portlet_group =& $portlet->get('group');
        if ($portlet_group) {
            $portlet_for_view[$view_name] = $portlet_group->getOID();
        }
    } elseif ($view_name === 'group') {
        $portlet_group =& $portlet->get('group');
        if ($portlet_group) {
            $portlet_for_view[$view_name] = $portlet_group->get('name');
        }
    } elseif ($view_name === 'creator_uid' || $view_name === 'modify_uid') {
        $user =& $portlet->get($model_name);
        if ($user) {
            $portlet_for_view[$view_name] = $user->getOID();
        }
    } else {
        $portlet_for_view[$view_name] = $portlet->get($model_name);
    }
}

// Assign Portlet Display Infomation
$t->assign('portlet', $portlet_for_view);

// delete portlet setup
$delete_info_page_name = 'portal/personal/html_portlet_delete';
$delete_info = [
    'title'   => grn_get_page_display_name($delete_info_page_name),
    'page'    => $delete_info_page_name . '.tpl',
    'handler' => 'lnk_delete',
    'data'    => [
        'portlet' => [
            'plid'  => $portlet_for_view['plid'],
            'title' => $portlet_for_view['title']
        ]
    ]

];
$t->assign('delete_info', $delete_info);
//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "portal/personal/html_portlet_list",
            'name' => grn_get_page_display_name('portal/personal/html_portlet_list'),
            'sf'   => 1
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


