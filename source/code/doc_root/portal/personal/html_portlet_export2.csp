<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// Evaluate access of My portal function.
require_once('portal/access_logic.csp');
$myportal_logic = GRN_Portal_MyPortalAccessLogic::getInstance();
$myportal_logic->evaluateAccess();

//Load Portlet ID List
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession(GRN_PRTL_MODULE_ID);
$portlet_id_list =& $session->get('selected_portlet_id_list');

//Check HTML Portlet Exists
require_once('portal/my_portlet_logic.csp');
$my_html_portletlogic = GRN_Portal_MyHTMLPortletLogic::getInstance();
$portlet_list = $my_html_portletlogic->getList();
if ($portlet_list) {
    foreach ($portlet_id_list as $portlet_id) {
        if (array_key_exists($portlet_id, $portlet_list)) {
            $eid[] = $portlet_id;
        }
    }
}

//Get HTML Portlet
require_once('portal/my_portlet_logic.csp');
$my_html_portlet_logic = GRN_Portal_MyHTMLPortletLogic::getInstance();
$portlet_list = $my_html_portlet_logic->getList();

// Create Parameter Translation Map
$translation_map = [
    'id'                 => '_id',                  //Portlet ID
    'name'               => 'name',                 //Portlet Name
    'group'              => 'group',                //Portlet Group Name
    'available_myportal' => 'available_myportal',   //Available My Portal Flag
];

// Do Parameter Translation for Portlet Group
$portlet_list_for_view = [];
foreach ($eid as $portlet_id) {
    $portlet_for_view = [];
    foreach ($translation_map as $view_name => $model_name) {
        switch ($model_name) {
            case '_id':
                $portlet_for_view[$view_name] = $portlet_id;
                break;
            case 'group':
                $portlet_group =& $portlet_list[$portlet_id]->get($model_name);
                if ($portlet_group) {
                    $portlet_for_view[$view_name] = $portlet_group->get('name');
                }
                break;
            default:
                $portlet_for_view[$view_name]
                    = $portlet_list[$portlet_id]->get($model_name);
                break;
        }
    }
    $portlet_list_for_view[$portlet_id] = $portlet_for_view;
}

// Assign Portlet Display Infomation
//Export Item
$t->assign(
    'export_item', [
        'export_numbers' => count($eid),
        'portlet'        => $eid,
    ]
);

//Export Portlet List
$t->assign('portlet_list', $portlet_list_for_view);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


