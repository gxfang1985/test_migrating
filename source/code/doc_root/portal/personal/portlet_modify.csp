<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Portal ID
$portal_id = @ $G_INPUT['pid'];

//Get Layout ID
$layout_id = @ $G_INPUT['plid'];

// Evaluate access of My portal function.
require_once('portal/access_logic.csp');
$myportal_logic = GRN_Portal_MyPortalAccessLogic::getInstance();
$myportal_logic->evaluateAccess();

//Get Display My Portal
require_once('portal/portal_logic.csp');
$my_portallogic = GRN_Portal_MyPortalLogic::getInstance();
$portal =& $my_portallogic->get($portal_id);

//Get Embadded Portlet Logic
require_once('portal/system_portlet_logic.csp');
$embedded_portlet_logic = GRN_Portal_SystemEmbeddedPortletLogic::getInstance();

//Get Layout
require_once('portal/portlet_util.csp');
$layout = GRN_Portal_PortletUtil::getPortletLayout($layout_id);
if ( ! $layout) {
    require_once('portal/error_code.csp');
    cb_throw_error(E_GRN_PRTL_PORTLET_LAYOUT_NOT_FOUND);
}
$portal =& $layout->get('portal');
if ( ! $portal) {
    //Portal Not Found
    require_once('portal/error_code.csp');
    cb_throw_error(E_GRN_PRTL_PORTAL_NOT_FOUND);
}
$user =& $portal->get('user');
if ($user->getOID() != $G_portal_login_user->getOID()) {
    //Portlet Layout Not Found
    require_once('portal/error_code.csp');
    cb_throw_error(E_GRN_PRTL_PORTLET_LAYOUT_NOT_FOUND);
}

//Create Parameter Translation Map for Portlet Layout
$translation_map_portlet_layout = [
    'pid'   => '_id',          //Portal ID
    'ppid'  => '_id',          //Portlet layout ID
    'plid'  => '_id',          //Portlet ID
    'name'  => 'display_name', //Portlet Display Name
    'title' => 'name',         //Portlet Name
];

//Do Parameter Translation for Portlet Layout
$layout_item_for_view = [];
$portlet =& $layout->get('portlet');

foreach ($translation_map_portlet_layout as $view_name => $model_name) {
    switch ($view_name) {
        case 'pid':
            $layout_item_for_view[$view_name] = $portal_id;
            break;
        case 'plid':
            $layout_item_for_view[$view_name] = $layout->getOID();
            break;
        case 'ppid':
            $layout_item_for_view[$view_name] = $portlet->getOID();
            break;
        case 'title':
            $portlet_type = $portlet->get('type');
            if ($portlet_type === GRN_PRTL_PORTLET_TYPE_HTML
                || $portlet_type === GRN_PRTL_PORTLET_TYPE_PHP
            ) {
                $layout_item_for_view[$view_name] = $portlet->get($model_name);
            } else {
                $dummy = null;
                $layout_item_for_view[$view_name]
                    = $embedded_portlet_logic->getDisplayName($portlet,
                    $dummy);
            }
            break;
        case 'name':
            $layout_item_for_view[$view_name] = $layout->get($model_name);
            break;
        default:
            break;
    }
}

// Assign Portlet Display Infomation
$t->assign('portlet', $layout_item_for_view);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position 
$t->assign(
    'site_position', [
        [
            'page' => "portal/personal/list",
            'name' => grn_get_page_display_name('portal/personal/list')
        ],
        [
            'page' => "portal/personal/view",
            'name' => grn_get_page_display_name('portal/personal/view'),
            'pid'  => $portal_id
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


