<?php
// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$form_name = cb_get_pagename();
// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form($form_name, true);

global $G_INPUT;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}
$t->assign('app_name', $G_message_name);
$user_id = $user->getOID();

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$mail_logic = $utility->getMailLogic();
$send_logic = $utility->getSendLogic();

if ( ! array_key_exists('mail_id', $G_INPUT)) {
    cb_throw_error(E_GRN_MAIL_MAIL_DATA_NOT_FOUND);
}
$mail_id = @ $G_INPUT['mail_id'];
$t->assign('mail_id', $mail_id);

$mail_data = $mail_logic->getMailData($mail_id, true);

if ($mail_data['content_type']) {
    $files = $send_logic->makeForwardFiles($user, $mail_data);
} else {
    $files = $send_logic->makeReuseFiles($mail_data);
}

require_once('grn/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);
$reuse_files = grn_init_attached_file('message/transfer_mail_to_message'
                                      . $tmp_key, $files);

require_once('message/system_logic.csp');
$system_logic = GRN_Message_SystemLogic::getInstance();

$message_for_view = [
    'subject'        => $mail_data['subject'],
    'data'           => GRN_Mail_Utility::htmlEntityDecodeExt($mail_data['data']),
    'attached_files' => $reuse_files,
    'confirm'        => $system_logic->getConfirmConfigAttribute(),
];
$t->assign('message', $message_for_view);

// page title
$page_title
    = grn_get_current_page_display_name(['app_name' => $G_message_name]);
$t->assign('page_title', $page_title);

// site position
$page_index = 'message/index';

require_once('message/folder_logic.csp');
$folder = new GRN_Message_FolderLogic();
$category_id = $folder->getSpecificFolderID($user, GRN_MESSAGE_RECEIVINGFOLDER);
$t->assign('category_id', $category_id);

$site_position = [
    [
        'page' => $page_index,
        'name' => grn_get_page_display_name($page_index),
        'sf'   => 0
    ],
    [
        'page' => $page_index,
        'name' => grn_get_page_display_name('message/inbox'),
        'cid'  => $category_id,
        'sf'   => 1
    ],
    [
        'page' => '',
        'name' => $page_title
    ],
];
$t->assign('site_position', $site_position);

$t->assign('use_editor', $system_logic->getUseREConfigAttribute());

$t->assign('rows', $G_message_ui_config->getAreaHeight());
$t->assign('cols', $G_message_ui_config->getAreaWidth());

//generate upload ticket
include('grn/_upload_prepend.csp');

$t->assign('plugin', [
    'name'   => 'common',
    'params' => [
        'action'       => null,
        'session_name' => cb_get_pagename(),
        'app_id'       => 'message'
    ]
]);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

