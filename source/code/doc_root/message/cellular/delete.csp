<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// 使用するパラメータの定義
$message_id = @ $G_INPUT['mid'];
$relation_id = @ $G_INPUT['rid'];

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app_name = $locator->getName('message');

// メッセージ関連 instance
require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$folder_logic = new GRN_Message_FolderLogic();

// 
$my_message = $message_logic->hasPrivilege($G_login_user, $message_id,
    $relation_id);
if ($my_message === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $app_name],
        ['app_name' => $app_name],
        ['app_name' => $app_name]);
}
$category_id = $my_message['cid'];
$relation_id = $my_message['rid'];
$message_id = $my_message['mid'];

$smarty->assign('cid', $category_id);
$smarty->assign('rid', $relation_id);
$smarty->assign('mid', $message_id);

// メッセージ取得
$message = $message_logic->getMessage(
    $G_login_user,                       // user
    $relation_id,                        // relation_id
    $message_id                          // message_id
// follow offset
// follow limit
// 既読フラグの制御(TRUE:off)
);

// subject
$smarty->assign('title', $message['subject']);

// 下書きか
if ($message['message_type'] == GRN_MESSAGE_TYPE_DRAFT) {
    $smarty->assign('is_draft', true);
}

// 自分が差出人か管理者、あるいは自分が宛先にいて管理者が誰もいない
if (_grn_message_regard_operator($message['addressees'],
    $message['creator_id'])
) {
    $smarty->assign('is_operator', true);
}

// ごみ箱を利用するか
$garbage_folder_id = null;
if ($personal_logic->getUseGarbageBoxAttribute($G_login_user)) {
    // ごみ箱ID
    $garbage_folder_id = $folder_logic->getSpecificFolderID($G_login_user,
        GRN_MESSAGE_GARBAGEFOLDER);
    $smarty->assign('use_garbage', true);

    // ゴミ箱か
    if ($message['folder_id'] == $garbage_folder_id) {
        $smarty->assign('is_garbage', true);
    }
}

// display
$smarty->display(cb_get_pagename() . '.tpl');

