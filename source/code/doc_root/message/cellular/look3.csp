<?php

// 使用するパラメータの定義
$message_id = @ $G_INPUT['mid'];
$relation_id = @ $G_INPUT['rid'];
//$page_num    = @ $G_INPUT['pg'];

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$G_cellular_app = $locator->getInstance('cellular');
$user_config = $G_cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();

$app_name = $locator->getName('message');

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

// メッセージ取得 instance
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();

$my_message = $message_logic->hasPrivilege($G_login_user, $message_id,
    $relation_id);
if ($my_message === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $app_name],
        ['app_name' => $app_name],
        ['app_name' => $app_name]);
}
$category_id = $my_message['cid'];
$relation_id = $my_message['rid'];
$message_id = $my_message['mid'];

// メッセージ取得
$message = $message_logic->getMessage(
    $G_login_user,                       // user
    $relation_id,                        // relation_id
    $message_id                          // message_id
// follow offset
// follow limit
// 既読フラグの制御(TRUE:off)
);

// subject
$smarty->assign('title', $message['subject']);

$smarty->assign('is_snapshot', $message['is_snapshot']);
$smarty->assign('del_time', $message['delete_time']);

$sendto = [];
$del_count = 0;
foreach ($message['addressees'] as $address) {
    if ($address['dtime']->unix_ts > 0 || $address['delete_flag']) {
        $del_count++;
        continue;
    }
    $sendto[] = $address['name'];
}
$smarty->assign('del_user', $del_count);
$smarty->assign('sendto', $sendto);

// assign
$smarty->assign('cid', $category_id);
$smarty->assign('rid', $relation_id);
$smarty->assign('mid', $message_id);

// display
//var_dump($sendto);
$smarty->display(cb_get_pagename() . '.tpl');

