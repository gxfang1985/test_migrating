<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// 
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// パラメータ情報
$str = (isset($G_INPUT['str'])) ? $G_INPUT['str'] : '';
$page = (isset($G_INPUT['pg'])) ? $G_INPUT['pg'] : 0;
$gid = (isset($G_INPUT['gid'])) ? $G_INPUT['gid'] : null;

$params = (isset($G_INPUT)) ? $G_INPUT : null;
unset($params['str']);
unset($params['pg']);
unset($params['gid']);
unset($params['submit_group']);
unset($params['submit_user']);
$smarty->assign('params', $params);

// 携帯用セッションInstance（$G_cellular_session）
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$G_cellular_session = $session_manager->getSession('cellular');
$sess_message = $G_cellular_session->get('sess_message');

// 遷移先
$page_group = $G_pagepath . '/add_user';
if (@$sess_message['create']) {
    $page_user = $G_pagepath . '/command_create';
} elseif (@$sess_message['change']) {
    $page_user = $G_pagepath . '/command_change';
} else {
    // session error
    grn_cellular_switch_page("cellular/menu");
}
$smarty->assign('page_group', $page_group);
$smarty->assign('page_user', $page_user);

$tab = [
    'mode'   => 's',
    'page'   => cb_get_pagename(),
    'params' => $params,
    'add'    => [
        // 検索tab
        [
            'mode' => 's',
            'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

if (strlen($gid)) {
    $prefix = mb_substr($gid, 0, 1);
    if ($prefix != 's') {
        // selectページにswitch
        grn_cellular_switch_page($page_group);
    }
}

$smarty->assign('gid', $gid);

// config
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);
$limit = $user_config->getListMax();

if (strlen($str)) {
    $smarty->assign('str', $str);

    if (array_key_exists('submit_group', $G_INPUT)) {
        $smarty->assign('submit_group', true);

        require_once('fw/string_util.csp');
        $keywords = cb_parse_search_text($str);

        // 検索
        $groups = $G_uum->getGroupListByNames($keywords);

        $lists = [];
        foreach ($groups as $_group) {
            $lists[] = [
                'gid'  => $_group->getOID(),
                'name' => $_group->get('name'),
            ];
        }
    } elseif (array_key_exists('submit_user', $G_INPUT)) {
        $smarty->assign('submit_user', true);
        //start GTM-529
        require_once('grn/org_util.csp');
        require_once('grn/org_util_search.csp');
        $org_id = '';
        $system_flg = false;
        $condition = grn_get_user_info_search_condition($org_id, $str,
            $system_flg, false, true);

        $navi_params = [];
        $navi_params['str'] = $str;

        $users = grn_search_user_info_by_application($org_id, $condition,
            $navigation_info, false, $navi_params, null, GRN_MESSAGE_APPID);
        $lists = [];
        foreach ($users as $_user) {
            $lists[] = [
                'mid'  => $_user['uid'],
                'name' => $_user['display_name'],
                'set'  => array_key_exists($_user['uid'],
                    $sess_message['users']),
            ];
        }
        //end GTM-529
    }

    // ページ切り替え
    $page = $page - 0;
    if (isset($lists)) {
        $page_lists = array_chunk($lists, $limit, true);
    }
    $smarty->assign('lists',
        isset($page_lists[$page]) ? $page_lists[$page] : null);

    if ($page > 0) {
        $smarty->assign(['prev' => true, 'prev_page' => $page - 1]);
    }
    if (isset($page_lists[$page + 1]) && count($page_lists[$page + 1])) {
        $smarty->assign(['next' => true, 'next_page' => $page + 1]);
    }
}

$smarty->assign('tab', $tab);

// this value will be used to come back from /address/cellular/view 
$G_cellular_session->set('back-from-address-view', $G_INPUT);

// smartyの出力
$smarty->display(cb_get_pagename() . '.tpl');


