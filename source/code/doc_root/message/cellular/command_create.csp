<?php

require_once("grn/smarty.csp");
$smarty = new GRN_Smarty;

// SmartyValidate should be initialized when an input form is there.
require_once('SmartyValidate.class.php');
SmartyValidate::connect($smarty);
$form_name = 'message/cellular/create';
SmartyValidate::register_form($form_name);
$smarty->assign('form_name', $form_name);

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app_name = $locator->getName('message');

// 携帯用セッションInstance（$G_cellular_session）
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$G_cellular_session = $session_manager->getSession('cellular');
$sess_message = $G_cellular_session->get('sess_message');

if ( ! @$sess_message['create']) {
    // redirect
    grn_cellular_switch_page($G_pagepath . "/create", ['cs' => '1']);
}

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'GET') == 0) {
    //GET

    if (isset($G_INPUT['mid'])) {
        //参加者追加処理
        if ( ! array_key_exists($G_INPUT['mid'], $sess_message['users'])) {
            $user_id = (int)$G_INPUT['mid'];
            $user = $G_uum->getUser($user_id);
            if ($user) {
                $sess_message['users'][$user_id] = $user->get('display_name');
            }

            $sess_message['edit_users'] = (count($sess_message['users']) <= 30
                ? true : false);
        }
    }
    $G_cellular_session->set('sess_message', $sess_message);

    // redirect
    grn_cellular_switch_page($G_pagepath . "/create",
        ['cid' => @$G_INPUT['cid']]);
} else {
    //POST

    // not is_valid
    if (array_key_exists('add_user', $G_INPUT)) {
        $G_INPUT['address'] = $G_INPUT['add_user'];
    }

    $sess_message['title'] = @$G_INPUT['title'];
    if (@$G_INPUT['edit_info']) {
        $sess_message['info'] = @$G_INPUT['info'];
    }
    $sess_message['confirm'] = @$G_INPUT['confirm'];

    if ( ! SmartyValidate::is_valid($G_INPUT, $form_name)) {
        // validate error
        $G_cellular_session->set('sess_message', $sess_message);
        // redirect
        grn_cellular_switch_page($G_pagepath . "/create",
            ['cid' => @$G_INPUT['cid']]);
    }

    if (array_key_exists('add_user', $G_INPUT)) {
        //参加者追加ページへ
        $G_cellular_session->set('sess_message', $sess_message);
        // redirect
        grn_cellular_switch_page($G_pagepath . "/add_user",
            ['cid' => @$G_INPUT['cid']]);
    } elseif (array_key_exists('delete_user', $G_INPUT)) {
        //参加者削除
        $delete_users = array_keys($G_INPUT['delete_user']);
        foreach ($delete_users as $_id) {
            unset($sess_message['users'][$_id]);
        }
        $G_cellular_session->set('sess_message', $sess_message);
        // redirect
        grn_cellular_switch_page($G_pagepath . "/create",
            ['cid' => @$G_INPUT['cid']]);
    } else {
        // create message data
        $message = [];
        $message['subject'] = $sess_message['title'];
        $message['format_type'] = 0;
        $message['data'] = $sess_message['info'];
        $message['confirm'] = ($sess_message['confirm'] ? 1 : 0);

        // create addressees data
        $addressees = [];
        $creator_id = $G_login_user->getOID();
        if (count($sess_message['users'])) {
            $key = 1;
            foreach ($sess_message['users'] as $_id => $_name) {
                $addressee = [];
                $addressee['addressee_id'] = $_id;
                $addressee['addressee_order'] = $key++;
                if ($_id == $creator_id) {
                    $addressee['addressee_is_operator'] = true;
                } else {
                    $addressee['addressee_is_operator'] = false;
                }

                $addressees[] = $addressee;
            }
        }

        require_once('message/message_logic.csp');
        $message_logic = new GRN_Message_Logic();
        $files = [];
        $ret = $message_logic->sendMessage($G_login_user, $message,
            $addressees, $files);
        if ($ret === false) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_FAIL_TO_SEND_MESSAGE,
                ['app_name' => $app_name],
                ['app_name' => $app_name]);
        }

        if ($sess_message['is_draft']) {
            // delete a draft message
            $message_row = $message_logic->deleteDraft($G_login_user,
                $sess_message['mid']);
            if ($message_row === false) {
                require_once('message/error_code.csp');
                cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                    ['app_name' => $app_name],
                    ['app_name' => $app_name],
                    ['app_name' => $app_name]);
            }
        }

        // 後処理
        $G_cellular_session->unset_by('sess_message');
        SmartyValidate::unregister_form($form_name);

        // redirect
        require_once('message/folder_logic.csp');
        $folder = new GRN_Message_FolderLogic();
        $category_id = $folder->getSpecificFolderID($G_login_user,
            GRN_MESSAGE_SENDINGFOLDER);
        grn_cellular_redirect($G_pagepath . "/list", ['cid' => $category_id]);
    }
}

