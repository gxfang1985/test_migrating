<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページ情報
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

// ページ構成情報
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular_app = $locator->getInstance('cellular');
$user_config = $cellular_app->getUserConfig($G_login_user);

$list_limit = $user_config->getListMax();
$width = $user_config->getSubjectWidth();

$smarty->assign('width', $width);

// メッセージ関連 instance
require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$folder_logic = new GRN_Message_FolderLogic();
require_once('message/search_logic.csp');
$search = new GRN_Message_SearchLogic();

// ごみ箱を利用するか
$garbage_folder_id = null;
if ($personal_logic->getUseGarbageBoxAttribute($G_login_user)) {
    // ごみ箱ID
    $garbage_folder_id = $folder_logic->getSpecificFolderID($G_login_user,
        GRN_MESSAGE_GARBAGEFOLDER);
}

$text = @ $G_INPUT['text'];
$smarty->assign('text', $text);

if (strlen($text)) {
    // 検索項目
    $search_keys = [
        'subject'   => true,
        'data'      => true,
        'sender'    => true,
        'addressee' => true,
        'follow'    => true,
        'sub'       => true,
    ];

    // 検索文字列
    $search_text =& $text;

    // 検索対象期間
    $start_ts = null;
    $last_ts = null;

    // ルートから検索
    $hid = '-1';

    // サブフォルダも検索
    $subfolder = true;

    require_once("cellular/controller.csp");
    $controller_util = new GRN_Cellular_ControllerUtil();
    $offset = $controller_util->getListOffset();

    $message_num = $search->getSearchItemCount($G_login_user,
        $search_keys, $search_text,
        $start_ts, $last_ts,
        $hid, $subfolder);

    $navigation_info = $controller_util->makeNaviInformation($offset,
        $list_limit,
        $message_num,
        ['text' => $text]);

//    $search_count = $navigation_info['end_count'] - $navigation_info['start_count'] + 1;
    $search_count = $list_limit;

    $retval = [];
    if ($message_num > 0) {
        $retval = $search->getSearchItems($G_login_user,
            $search_keys, $search_text,
            $offset, $search_count,
            $start_ts, $last_ts,
            $hid, $subfolder);
        if (count($retval) > 0) {
            foreach (array_keys($retval) as $_id) {
                $item =& $retval[$_id];
                // ゴミ箱
                $item['is_garbage'] = ($item['cid'] == $garbage_folder_id);
            }
        }
//var_dump($retval);
    }

    $smarty->assign('result', $retval);
    $smarty->assign('navi', $navigation_info['navi']);
}

// display
$smarty->display(cb_get_pagename() . '.tpl');

