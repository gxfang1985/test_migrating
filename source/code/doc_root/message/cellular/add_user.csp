<?php
// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;
/** @var GRN_Uum $G_uum */
// 
$smarty->assign('pagetitle', grn_get_current_page_display_name());
$smarty->assign('pagepath', $G_pagepath);
$smarty->assign('pagename', cb_get_pagename());

$gid =  $G_INPUT['gid'] ?? '';
$is_page_numeric = is_numeric($G_INPUT['pg'] ?? null);
$page = $is_page_numeric ? $G_INPUT['pg'] : null;

$params = (isset($G_INPUT)) ? $G_INPUT : null;
unset($params['pg']);
unset($params['gid']);
$smarty->assign('params', $params);

// 携帯用セッションInstance（$G_cellular_session）
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$G_cellular_session = $session_manager->getSession('cellular');
$sess_message = $G_cellular_session->get('sess_message');

// 遷移先（遷移してきた元に戻る
if (@$sess_message['create']) {
    $to_pagename = $G_pagepath . '/command_create';
} elseif (@$sess_message['change']) {
    $to_pagename = $G_pagepath . '/command_change';
} else {
    // session error
    grn_cellular_switch_page("cellular/menu");
}
$smarty->assign('to_pagename', $to_pagename);

$tab = [
    'mode'   => 'b',
    'page'   => cb_get_pagename(),
    'params' => $params,
    'add'    => [
        // 検索tab
        [
            'mode' => 's',
            'name' => cb_msg('grn.cellular.common', 'tab_search'),
        ],
    ],
];

$smarty->assign('access_plugin', null);

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cellular = $locator->getInstance('cellular');
$uconfig = $cellular->getUserConfig($G_login_user);
$limit = $uconfig->getListMax();

if ( ! strlen($gid)) {
    $smarty->assign('gid', 'b');
} else {
    // gid分割
    $smarty->assign('gid', $gid);
    if (($p = strpos($gid, ':')) !== false) {
        $group_id = substr($gid, 0, $p);
    } else {
        $group_id = $gid;
    }
    $prefix = substr($group_id, 0, 1);
    if ( ! is_numeric($prefix)) {
        $group_id = substr($group_id, 1);
    } else {
        $prefix = 'g';
    }
    $tab['mode'] = $prefix;

    $display_obj = [];
    $members = [];

    if ($prefix == 's') {
        // 検索ページにswitch
        grn_cellular_switch_page($G_pagepath . '/add_search');
    } elseif ($prefix == 'm') {
        if ($group_id) {
            // Myグループ
            $group = $G_uum->getMyGroup($group_id);
            // ユーザーの取得
            $members = $G_uum->getMyGroupUsers($group->getOID(), 0, -1, null,
                null, GRN_MESSAGE_APPID); //GTM-529
        }
    } elseif ($prefix == 'u') {
        // 最近選択したユーザー
        $lists = $G_uum->getFrequentUsersInfo($G_login_user->getOID(), -1, null,
            GRN_MESSAGE_APPID); //GTM-529
        foreach (array_keys($lists) as $_id) {
            $members[$_id] = $G_uum->getUser($_id);
        }
    } else {
        if ($group_id) {
            // 組織
            $group = $G_uum->getGroup($group_id);
            // ユーザーの取得
            $members = $G_uum->getGroupUsers($group->getOID(), 0, -1, null,
                null, GRN_MESSAGE_APPID); //GTM-529
        }
    }

    // 絞り込む
    if ($members) {
        foreach ($members as $id => $obj) {
            $display_obj[] = [
                'mid'  => $obj->getOID(),
                'name' => $obj->get('display_name'),
                'set'  => array_key_exists($obj->getOID(),
                    $sess_message['users']),
            ];
        }
    }

    $total_count = count($display_obj);
    if ($total_count > $limit) {
        $start_point = ($page) * $limit;
        $end_point = ($page + 1) * $limit;

        $temp = [];
        for ($i = $start_point; $i < $end_point && $i < $total_count; $i++) {
            if ($display_obj[$i]) {
                array_push($temp, $display_obj[$i]);
            }
        }
        if ($end_point < $total_count) {
            $next = $page + 1;
            $smarty->assign('next_page', @$next);
            $smarty->assign('next', true);
        }
        if ($page > 0) {
            $before = $page - 1;
            $smarty->assign('prev_page', @$before);
            $smarty->assign('prev', true);
        }
        $smarty->assign('objects', $temp);
    } else {
        $smarty->assign('objects', $display_obj);
    }

}

$smarty->assign('tab', $tab);

// this value will be used to come back from /address/cellular/view 
$G_cellular_session->set('back-from-address-view', $G_INPUT);

$smarty->display(cb_get_pagename() . '.tpl');


