<?php

// 使用するパラメータの定義
$message_id = @ $G_INPUT['mid'];
$relation_id = @ $G_INPUT['rid'];
$send_cancel = @ $G_INPUT['send_cancel'];

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$app_name = $locator->getName('message');

// メッセージ関連 instance
require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$folder_logic = new GRN_Message_FolderLogic();

// ごみ箱を利用するか
$use_garbagebox = $personal_logic->getUseGarbageBoxAttribute($G_login_user);
$garbage_folder_id = null;
if ($use_garbagebox) {
    // ごみ箱ID
    $garbage_folder_id = $folder_logic->getSpecificFolderID($G_login_user,
        GRN_MESSAGE_GARBAGEFOLDER);
}

$my_message = $message_logic->hasPrivilege($G_login_user, $message_id,
    $relation_id);
if ($my_message === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $app_name],
        ['app_name' => $app_name],
        ['app_name' => $app_name]);
}
$category_id = $my_message['cid'];
$relation_id = $my_message['rid'];
$message_id = $my_message['mid'];

if (array_key_exists('send_cancel', $G_INPUT) && $G_INPUT['send_cancel']) {
    $ret = $message_logic->deleteMessageData($G_login_user, [$message_id]);
    if ( ! $ret) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_DELETED,
            ['app_name' => $app_name],
            ['app_name' => $app_name],
            ['app_name' => $app_name]);
    }
} else {
    if ($use_garbagebox && $category_id != $garbage_folder_id) {
        $ret = $message_logic->moveMessages2GarbageBox($G_login_user,
            $category_id, [$relation_id]);
        if ( ! $ret) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                ['app_name' => $app_name],
                ['app_name' => $app_name],
                ['app_name' => $app_name]);
        }
    } else {
        $ret = $message_logic->deleteMessages($G_login_user,
            [$relation_id => $message_id]);
        if ( ! $ret) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                ['app_name' => $app_name],
                ['app_name' => $app_name],
                ['app_name' => $app_name]);
        }
    }
}

grn_cellular_redirect("message/cellular/list", ['cid' => $category_id]);

