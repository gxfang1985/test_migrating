<?php

// 使用するパラメータの定義
$message_id = @ $G_INPUT['mid'];
$relation_id = @ $G_INPUT['rid'];
$follow_id = @ $G_INPUT['fid'];
$page_num = @ $G_INPUT['pg'];

// Smarty をインスタンス化
require_once('cellular/smarty.csp');
$smarty = new GRN_Cellular_Smarty;

// ページタイトル
$smarty->assign('pagetitle', grn_get_current_page_display_name());
// パス情報
$smarty->assign('pagepath', $G_pagepath);

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
if ($notify_app = $locator->getInstance('notification')) {
    $smarty->assign('enable_notification', true);
}
$app_name = $locator->getName('message');

// 初期定義
// follow view map
$assign_follow_map = [
    'creator_name' => 'creator_name',   //
    'date'         => 'ctime',          //
    'body'         => 'data',           //
    'attach_files' => 'has_files',      //
    'next_fid'     => 'prev_fid',       //
    'prev_fid'     => 'next_fid',       //
    'id'           => 'id',             //
];

// メッセージ関連 instance
require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$folder_logic = new GRN_Message_FolderLogic();

// ごみ箱を利用するか
$garbage_folder_id = null;
if ($personal_logic->getUseGarbageBoxAttribute($G_login_user)) {
    // ごみ箱ID
    $garbage_folder_id = $folder_logic->getSpecificFolderID($G_login_user,
        GRN_MESSAGE_GARBAGEFOLDER);
}

$my_message = $message_logic->hasPrivilege($G_login_user, $message_id,
    $relation_id);
if ($my_message === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $app_name],
        ['app_name' => $app_name],
        ['app_name' => $app_name]);
}
$category_id = $my_message['cid'];
$relation_id = $my_message['rid'];
$message_id = $my_message['mid'];

// メッセージ取得
$message = $message_logic->getMessage(
    $G_login_user,                       // user
    $relation_id,                        // relation_id
    $message_id                          // message_id
// follow offset
// follow limit
// 既読フラグの制御(TRUE:off)
);

// subject
$smarty->assign('title', $message['subject']);
$smarty->assign('message_type', $message['message_type']);
$smarty->assign('is_snapshot', $message['is_snapshot']);

// ゴミ箱
if ($message['folder_id'] == $garbage_folder_id) {
    $smarty->assign('is_garbage', true);
}

// 該当するフォロー
$follow = $message_logic->getFollowDetail(
    $message_id,                      // message_id
    $follow_id                        // follow_id
// HTMLデータ取得(default: FALSE)
);

// viewに渡す為のマッピング
$follow_view = [];
foreach ($assign_follow_map as $view_name => $data_name) {
    $follow_view[$view_name] =& $follow[$data_name];
}

// 既読情報
$follow_view['read'] = @ $messageinfo['notification_status'];

// assign
$smarty->assign('follow', $follow_view);

$smarty->assign('cid', $category_id);
$smarty->assign('rid', $relation_id);
$smarty->assign('mid', $message_id);
$smarty->assign('fid', $follow_id);

// display
$smarty->display(cb_get_pagename() . '.tpl');

