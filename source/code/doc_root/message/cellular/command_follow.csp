<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // 使用するパラメータの定義
    $message_id = @ $G_INPUT['mid'];
    $relation_id = @ $G_INPUT['rid'];
    $follow_str = @ $G_INPUT['follow'];

    // Smarty をインスタンス化
    require_once('cellular/smarty.csp');
    $smarty = new GRN_Cellular_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($smarty);
    $form_name = 'message/cellular/follow';
    SmartyValidate::register_form($form_name);

    if (SmartyValidate::is_valid($G_INPUT, $form_name)) {
        //正常

        // メッセージinstance
        require_once('message/message_logic.csp');
        $message_logic = new GRN_Message_Logic();

        // フォローの情報
        $writeData = [
            'creator'     => & $G_login_user,
            // 発言者 CB_User オブジェクト
            'data'        => $follow_str,
            // 本文/HTML本文
            'format_type' => 0,
            // フォーマットタイプ(0: plain text, 1: HTML)
        ];

        // フォロー書き込み
        $message_logic->writeFollow(
            $G_login_user,
            $message_id,
            $writeData,
            $_FILES
        );

        $message = $message_logic->getMessage(
            $G_login_user,      // user
            $relation_id,       // relation_id
            $message_id,        // message_id
            0,                  // follow offset
            0,                  // follow limit
            false               // 既読フラグの制御(TRUE:off)
        );

        // the validation session is finished
        SmartyValidate::unregister_form($form_name);

        require_once('cellular/prepend.csp');
        grn_cellular_redirect($G_pagepath . "/look1",
            ['rid' => $relation_id, 'mid' => $message_id]);

    } else {
        // error. switch form page
        grn_cellular_switch_page($G_pagepath . '/follow');
    }
}

