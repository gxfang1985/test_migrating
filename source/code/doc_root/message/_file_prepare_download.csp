<?php
require_once('grn/application.csp');

$rfile_id = @ $G_INPUT['rfid'];

if ($rfile_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

require_once('message/file.csp');
$file_manager = new GRN_Message_FileManager();

if ( ! $file_manager->hasPrivilege($G_message_login, $rfile_id)) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$file = $file_manager->getFile($rfile_id);
if ( ! $file) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$body = null;

$log_ver = array_key_exists('ver', $G_INPUT) ? $G_INPUT['ver'] : '';
if ($log_ver != '') {
    $app_locator = GRN_ApplicationLocator::instance();
    $dbconn = $app_locator->getConnection('message');

    $rowset = $file->getLogSet();
    $rowset->addCondition("col_version ='" . $dbconn->escape($log_ver) . "'");

    $log = $rowset->iterate();
    $rowset->destroy();

    if ( ! $log) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    $body = $log->get('body');
} else {
    $body = $file->getCurrentBody();
}
$file_name = $body->get('name');
