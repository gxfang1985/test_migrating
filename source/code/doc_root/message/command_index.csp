<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    require_once('message/error_code.csp');
    require_once('message/message_logic.csp');
    $t = new GRN_Smarty;
    $ids = $G_INPUT['ids'] ?? null;
    $user = cb_lwc_uum()->getLoginUser();
    $command = $G_INPUT['cmd'] ?? '';

    switch ($command) {
        case 'move':
        case 'unread':
            $source_cid = @ $G_INPUT['cid'];
            $destination_cid = @ $G_INPUT['dcid'];

            if ($source_cid == '' || $destination_cid == '') {
                cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
            }

            if (is_array($ids)) {
                if ( ! $user) {
                    require_once('grn/error_code.csp');
                    cb_throw_error(E_GRN_USER_NOT_FOUND);
                }

                $message_logic = new GRN_Message_Logic();
                $relations = [];
                foreach ($ids as $id) {
                    list($relations[], $dummy1, $dummy2, $dummy3) = explode(',', $id);
                }

                if ($command == 'move') {
                    $ret = $message_logic->moveMessages($user, $source_cid, $destination_cid, $relations);
                    if ( ! $ret) {
                        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_MOVED,
                            ['app_name' => $G_message_name],
                            ['app_name' => $G_message_name],
                            ['app_name' => $G_message_name]);
                    }
                }

                if ($command == 'unread') {
                    $ret = $message_logic->markAsUnreadMessages($user, $relations);
                    if ( ! $ret) {
                        cb_throw_error(E_GRN_MESSAGE_NOT_MARK_UNREAD);
                    }
                }

            }

            cb_redirect('message/index', ['cid' => $source_cid, 'sf' => 1]);
            break;
        case 'delete':
            $params = [];
            $params['cid'] = @ $G_INPUT['cid'];
            $params['ctype'] = @ $G_INPUT['ctype'];

            if ($params['cid'] == '' || $params['ctype'] == '') {
                cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
            }

            if (is_array($ids)) {
                require_once('fw/session_manager.csp');
                $sm = CB_SessionManager::getInstance();
                $session = $sm->getSession('message/index');
                $session->set('message_ids', $ids);
                cb_redirect('message/delete_multi', $params);
            } else {
                cb_redirect('message/index',
                    ['cid' => $params['cid'], 'sf' => 1]);
            }
            break;
        default:
            cb_throw_error(E_GRN_MESSAGE_WRONG_PARAMETER);
    }
}
