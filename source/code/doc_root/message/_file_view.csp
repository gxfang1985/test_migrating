<?php

$frm = 'vw';
if (array_key_exists('frm', $G_INPUT) && strcmp($G_INPUT['frm'], 'ac') === 0) {
    $frm = 'ac';
}

$linkparams_for_view = [
    'cid'  => $category_id,
    'rid'  => $relation_id,
    'mid'  => $message_id,
    'rfid' => $rfile_id,
    'frm'  => $frm,
    'sort' => array_key_exists('sort', $G_INPUT) ? $G_INPUT['sort'] : null,
];

$t->assign('linkparams', $linkparams_for_view);

require_once('grn/controller.csp');
$utility = new GRN_ControllerUtil();

$offset = $utility->getNaviStartPosition();
$sort = $utility->getSortParameter();

$sortinfo = [
    'td' => ['column' => 'record_time', 'order' => true],
    'tu' => ['column' => 'record_time', 'order' => false],
    'ud' => ['column' => 'recorder_name', 'order' => true],
    'uu' => ['column' => 'recorder_name', 'order' => false],
    'nd' => ['column' => 'filename', 'order' => true],
    'nu' => ['column' => 'filename', 'order' => false],
];

if ( ! $sort || ! array_key_exists($sort, $sortinfo)) {
    $sort = 'td';
}

$sort_column = $sortinfo[$sort]['column'];
$sort_order = $sortinfo[$sort]['order'];

$utility->setSortParameter($sort);
$t->assign('sort', $sort);

//global $G_message_ui_config;
$limit = $G_message_ui_config->getListMax();

$file = $file_manager->getFile($rfile_id);
if ( ! $file) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$file_for_view = $utility->getFileDetailView($file,
    $offset, $limit,
    $sort_column, $sort_order);
$file_for_view['navi']['navi']['params'] = $linkparams_for_view;

// ファイルの作成者あるいは許可がある人が変更/削除できるようにする
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$message_files = $message_logic->getMessageFiles($message_id);
$addressee_list = $message_logic->getAddressees($G_message_login, $message_id);
$creator_id = $message_logic->getMessageCreatorId($message_id);
$is_operator = _grn_message_regard_operator($addressee_list, $creator_id);
if ( ! array_key_exists($rfile_id, $message_files)) {
    $is_operator = false;
}
if ((array_key_exists('creator_uid', $file_for_view)
     && $file_for_view['creator_uid'] == $G_message_login->getOID())
    || $is_operator
) {
    $file_for_view['modifiable'] = true;
    $file_for_view['deletable'] = true;
}

$t->assign('file', $file_for_view);

$users_id = [];
$users_id[] = @$file_for_view['creator_uid'];
$users_id[] = @$file_for_view['modifier_uid'];

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
require_once("grn/controller.csp");
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
    $uum->getLoginUser());
$t->assign('users_info', $users_info);

$t->assign('name_width', $G_message_ui_config->getNameWidth());


// TENTATIVE
$t->assign('enable_lock', true);



