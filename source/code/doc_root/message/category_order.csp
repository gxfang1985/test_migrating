<?php

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);

//------------------

$category_id = @ $G_INPUT['cid'];
if ($category_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$t->assign('cid', $category_id);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$page_index = 'message/index';
$page_category_list = 'message/category_list';

require_once('message/folder_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();
$folder_info = $folder_logic->getFolderInfo($user, $category_id);

if ( ! $folder_info) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$sf = 0;
if ($folder_info['folder_type'] == GRN_MESSAGE_RECEIVINGFOLDER) {
    $sf = 1;
}

$t->assign(
    'site_position',
    [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index),
            'sf'   => $sf
        ],
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_category_list),
            'cid'  => $category_id,
            'sf'   => 1
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

require_once('message/folder_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();
$folders = $folder_logic->getSiblingFolders($user, $category_id);

if ( ! $folders) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$category_for_view = [];
foreach ($folders as $folder_id => $folder_name) {
    $category_for_view[$folder_id] = $folder_name;
}

$t->assign('category', $category_for_view);

/*
// page title
$page_title = "フォルダの順番変更";
$t->assign( 'page_title', $page_title );
// site position
$t->assign(
    'site_position',array(
        array(
            'page' => "message/index",
            'name' => "メッセージ"
        ),
        array(
            'page' => "message/category_list",
            'name' => "フォルダ"
        ),
        array(
            'page' => "",
            'name' => $page_title
        )
    )
);

// フォルダ情報
$t->assign(
    'category',array(
            'cid' => '001', //カテゴリID
            'title' => 'フォルダ１', //カテゴリ名
            'child_categories' =>  array( //同階層カテゴリたち
                '001' => 'フォルダ１', //カテゴリID カテゴリタイトル
                '002' => 'フォルダ２', //カテゴリID カテゴリタイトル
                '003' => 'フォルダ３', //カテゴリID カテゴリタイトル
            ),
    )
);
 */

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

