<?php
$app_locator = GRN_ApplicationLocator::instance();
if ( ! $app_locator->isActive('portal')) {
    assert('FALSE');
}
/** @var GRN_Portal_Application $app */
$app = $app_locator->getInstance('portal');

$portal_page = $app->getConfig('index');
if (0 == strlen($portal_page)) {
    $portal_page = 'index';
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if (array_key_exists('read', $G_INPUT)) {
    $G_message = null;
    if ( ! ($G_message = $app_locator->getInstance('message'))) {
        require_once('message/error_code.csp');
        $name = $app_locator->getName('message');
        $name = htmlspecialchars($name);
        cb_throw_error(E_GRN_MESSAGE_DEACTIVATED,
            ['app_name' => $name],
            ['app_name' => $name]);
    }
    $G_message_name = $G_message->getName();

    require_once('message/message_logic.csp');
    $message_logic = new GRN_Message_Logic();

    $message_ids = $G_INPUT['read'];
    if (is_array($message_ids)) {
        foreach ($message_ids as $message_id) {
            $ret = $message_logic->finishViewMessage($user, $message_id);
            if ( ! $ret) {
                require_once('message/error_code.csp');
                cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
                    ['app_name' => $G_message_name],
                    ['app_name' => $G_message_name],
                    ['app_name' => $G_message_name]);
            }
        }
    }
}
cb_redirect($portal_page);
