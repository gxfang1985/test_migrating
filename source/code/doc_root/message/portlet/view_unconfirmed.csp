<?php
require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

// personal config
require_once('grn/ui.csp');
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();
$cm = GRN_UIConfigManager::getInstance();
$config = $cm->getUserConfig($login);
$t->assign('subject_width', $config->getSubjectWidth());
$t->assign('name_width', $config->getNameWidth());

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();

// get new messages
$message_logic->receiveMessages($user);

// portlet settings
$settings_for_view = [
    'font_size' => 'normal',
    'sender'    => true,
    'time'      => true,
    'folder'    => true,
    'rows'      => 5
];
$portlet_settings = [];
if (array_key_exists('settings', $portlet)) {
    $portlet_settings = $portlet['settings'];
}
if (is_array($portlet_settings)) {
    foreach ($portlet_settings as $key => $value) {
        $settings_for_view[$key] = $value;
    }
}
$t->assign('settings', $settings_for_view);

$messages = $message_logic->getUnconfirmedMessageList($user, 'last_mtime',
    false, 0,
    $settings_for_view['rows']);
if ($messages === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_WRONG_PARAMETER);
}

if (count($messages) > 0) {
    $t->assign('has_messages', true);
}
$t->assign('messages', $messages);

$uids = [];
foreach ($messages as $message) {
    $uids[] = $message['creator_id'];
}
require_once("grn/controller.csp");
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($uids, $user,
    "message");
$t->assign('users_info', $users_info);

// page title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('message');
    $page_title = cb_plain_msg('grn.message', 'portlet_view_unconfirmed',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "",
            'name' => $page_title
        ]
    ]
);

$t->assign('portlet', $portlet);

$t->skipWarning();

// Smarty実行
$doc_name = 'message/portlet/view_unconfirmed';
$t->display("{$doc_name}.tpl");

