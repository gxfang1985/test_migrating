<?php

//uum
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

//頻度更新
require_once('grn/uum_util.csp');
$uum_util = GRN_UumUtil::getInstance();
$input_keys = array_keys($G_INPUT);
foreach ($input_keys as $input_key) {
    if (preg_match('/^selected_users_.*$/', $input_key)) {
        $input_value = $G_INPUT[$input_key];
        if ($input_value) {
            $input_values = explode(':', $input_value);
            $uum_util->selectUsers($user, $input_values);
        }
    } elseif (preg_match('/^selected_groups_.*$/', $input_key)) {
        $input_value = $G_INPUT[$input_key];
        if ($input_value) {
            $input_values = explode(':', $input_value);
            $uum_util->selectGroups($user, $input_values);
        }
    }
}

$subject = @ $G_INPUT['title'];
if ($subject === '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_SUBJECT_NOT_INPUTTED);
}

if ($is_draft === false && ! is_array($sUIDs)) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_ADDRESSEES_NOT_SELECTED,
        null,
        ['app_name' => $G_message_name]);
}

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// create message data
$message = [];
$message['subject'] = $subject;

// for rich editor
if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
    require_once('grn/controller.csp');
    $message['format_type'] = 1;
    $message['data'] = $G_INPUT['data'];
} else {
    $message['format_type'] = 0;
    $message['data'] = $G_INPUT['data'];
}

if (@ $G_INPUT['confirm'] == '') {
    $message['confirm'] = 0;
} else {
    $message['confirm'] = 1;
}


