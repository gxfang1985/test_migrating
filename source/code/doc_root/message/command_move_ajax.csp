<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $source_cid = @ $G_INPUT['cid'];
    $destination_cid = @ $G_INPUT['dcid'];
    $ids = @ $G_INPUT['ids'];

    if ($source_cid == '' || $destination_cid == '') {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
    }

    if (is_array($ids)) {
        global $G_container_base;
        $uum = $G_container_base->getInstance('uum');
        $user = $uum->getLoginUser();

        if ( ! $user) {
            require_once('grn/error_code.csp');
            cb_throw_error(E_GRN_USER_NOT_FOUND);
        }

        $relations = [];
        foreach ($ids as $id) {
            list($relations[], $dummy1, $dummy2, $dummy3) = explode(',', $id);
        }

        require_once('message/message_logic.csp');
        $message_logic = new GRN_Message_Logic();
        $ret = $message_logic->moveMessages($user, $source_cid,
            $destination_cid, $relations);
        if ( ! $ret) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_MOVED,
                ['app_name' => $G_message_name],
                ['app_name' => $G_message_name],
                ['app_name' => $G_message_name]);
        }
    }
}
