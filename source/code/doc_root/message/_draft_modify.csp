<?php

$category_id = @ $G_INPUT['cid'];
$relation_id = @ $G_INPUT['rid'];
$message_id = @ $G_INPUT['mid'];

if ($category_id == '' || $relation_id == '' || $message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$t->assign('category_id', $category_id);
$t->assign('relation_id', $relation_id);
$t->assign('message_id', $message_id);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$page_index = 'message/index';
$page_inbox = 'message/inbox';
$page_outbox = 'message/outbox';
$page_draftbox = 'message/draftbox';
$page_garbagebox = 'message/garbagebox';
$page_category_list = 'message/category_list';

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

$user_id = $user->getOID();

require_once('message/folder_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();
$folder_info = $folder_logic->getFolderInfo($user, $category_id);

if ( ! $folder_info) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

switch ($folder_info['folder_type']) {
    case GRN_MESSAGE_RECEIVINGFOLDER:
        $page_folder = $page_inbox;
        break;
    case GRN_MESSAGE_SENDINGFOLDER:
        $page_folder = $page_outbox;
        break;
    case GRN_MESSAGE_DRAFTFOLDER:
        $page_folder = $page_draftbox;
        break;
    case GRN_MESSAGE_GARBAGEFOLDER:
        $page_folder = $page_garbagebox;
        break;
    default:
        $page_folder = $page_category_list;
}

$t->assign(
    'site_position',
    [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index)
        ],
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_folder),
            'cid'  => $category_id
        ],
        [
            'page' => "message/draft_view",
            'name' => grn_get_page_display_name("message/draft_view"),
            'cid'  => $category_id,
            'rid'  => $relation_id,
            'mid'  => $message_id
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

/*
$category_id = @ $G_INPUT['cid'];
$limit = 20; //N件

// page title
$page_title = "下書きの編集";
$t->assign( 'page_title', $page_title );
// site position
$t->assign(
    'site_position',array(
        array(
            'page' => "message/index",
            'name' => "メッセージ"
        ),
        array(
            'page' => "message/draft_list",
            'name' => "フォルダ"
        ),
        array(
            'page' => "message/draft_view",
            'name' => "下書きの詳細"
        ),
        array(
            'page' => "",
            'name' => $page_title
        )
    )
);

// メッセージ
$t->assign(
    'message',array(
        'mid' => '001', //記事ID
        'cid' => '001', //カテゴリID
        'subject' => '社員旅行のお知らせ', //標題
        'data' => '社員旅行の季節が近づいてまいりました。', //本文
        'subscribe' => 0, //購読しているかどうか
        'creator_uid' => 3, //差出人ID
        'ctime' => '10/1(金)', //作成日時
        'mtime' => '10/6(水)', //更新日時
        'previous_id' => '', //前の記事ID
        'next_id' => '003', //次の記事ID
        'confirm' => 1,
        'attach_files' => array( //本文添付ファイルたち
            '000001' => array( //key
                'fid' => '000001', //ファイルID
            )
        )
    )
);
 */


