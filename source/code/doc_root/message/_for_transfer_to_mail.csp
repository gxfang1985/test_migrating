<?php

use grn\grn\access\service\AppAccess;

if ( ! isset($user) || $user) {
    global $G_INPUT;
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();
}
$user_id = $user->getOID();

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
require_once('mail/resources.csp');
$disable_mail_application = false;
$app = $locator->getInstance(GRN_MAIL_APP_ID);
$disable_mail_application = ! AppAccess::isAppAvailable(GRN_MAIL_APP_ID);

require_once('mail/utility.csp');
$utility = GRN_Mail_Utility::getInstance();
$system_config = $utility->getSystemConfig();
$personal_config = $utility->getPersonalConfig($user);

// 総メールサイズをチェック
$system_config->getSizeUserLimitSetting($size_settings, $user_id);
$mail_size = $personal_config->getMailSize(null);
$over_limit_size_mail = false;
if ((0 <= $size_settings['user_limit_' . $user_id])
    && ($mail_size >= $size_settings['user_limit_' . $user_id] * 1024 * 1024)
) {
    $over_limit_size_mail = true;
}

// メールの使用が許可されているか
$system_config->getGeneralSetting($general_settings);
$disable_mail = $general_settings['disable_mail'];

$account_id = $personal_config->getDefaultAccountId(false, false, false,
    true);
$account_data = $personal_config->getAccountData($account_id, true, false);

$no_account = $no_server = true;
if ( ! is_null($account_id)) {
    $personal_config->checkAccountForSend($account_id, $no_account, $no_server);
}

if ( ! $no_account && ! $no_server) {
    $no_setting = true;
} else {
    $no_setting = false;
}

if ($disable_mail || is_null($account_data) || $account_data['disabled']
    || $over_limit_size_mail
    || $disable_mail_application
    || ! $no_setting
) {
    $t->assign('link_transfer_message_to_mail', false);
} else {
    $t->assign('link_transfer_message_to_mail', true);
    $t->assign('mail_name', $app->getName());
}

