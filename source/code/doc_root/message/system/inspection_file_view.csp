<?php

// message id
if ( ! array_key_exists('mid', $G_INPUT) || $G_INPUT['mid'] == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}
$message_id = $G_INPUT['mid'];

// file id
if ( ! array_key_exists('rfid', $G_INPUT) || $G_INPUT['rfid'] == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}
$rfile_id = $G_INPUT['rfid'];

$frm = '';
if ( ! array_key_exists('frm', $G_INPUT) || $G_INPUT['frm'] == '') {
    $G_INPUT['frm'] = 'fw';
}

// smarty
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// site position
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$page_search = 'message/system/inspection_search';
$page_view = 'message/system/inspection_view';

$site_position_for_view = [];
$site_position_for_view[] = [
    'page' => $page_search,
    'name' => grn_get_page_display_name($page_search),
    'sf'   => '1'
];
$site_position_for_view[] = [
    'page' => $page_view,
    'name' => grn_get_page_display_name($page_view),
    'mid'  => $message_id
];
if (strcmp($G_INPUT['frm'], 'ac') === 0) {
    $page_accessory = 'message/system/inspection_accessory';
    $site_position_for_view[] = [
        'page' => $page_accessory,
        'name' => grn_get_page_display_name($page_accessory),
        'mid'  => $message_id
    ];
    $frm = 'ac';
}
$site_position_for_view[] = [
    'page' => '',
    'name' => $page_title
];
$t->assign('site_position', $site_position_for_view);

// login user
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

// user config
require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$user_config = $cm->getUserConfig($user);

require_once('grn/controller.csp');
$utility = new GRN_ControllerUtil();

$offset = $utility->getNaviStartPosition();
$sort = $utility->getSortParameter();

$sortinfo = [
    'td' => ['column' => 'record_time', 'order' => true],
    'tu' => ['column' => 'record_time', 'order' => false],
    'ud' => ['column' => 'recorder_name', 'order' => true],
    'uu' => ['column' => 'recorder_name', 'order' => false],
    'nd' => ['column' => 'filename', 'order' => true],
    'nu' => ['column' => 'filename', 'order' => false],
];

if ( ! $sort || ! array_key_exists($sort, $sortinfo)) {
    $sort = 'td';
}

$sort_column = $sortinfo[$sort]['column'];
$sort_order = $sortinfo[$sort]['order'];

$utility->setSortParameter($sort);
$t->assign('sort', $sort);

$limit = $user_config->getListMax();

require_once('message/file.csp');
$fm = new GRN_Message_FileManager();
$file = $fm->getFile($rfile_id);
if ( ! $file) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$file_for_view = $utility->getFileDetailView($file, $offset, $limit,
    $sort_column, $sort_order);

$linkparams_for_view = [
    'mid'  => $message_id,
    'rfid' => $rfile_id,
    'sort' => $sort,
    'frm'  => $frm
];
$file_for_view['navi']['navi']['params'] = $linkparams_for_view;

$file_for_view['auth'] = ['write' => true];

$t->assign('linkparams', $linkparams_for_view);
$t->assign('mid', $message_id);
$t->assign('rfid', $rfile_id);
$t->assign('file', $file_for_view);
$t->assign('name_width', $user_config->getNameWidth());
$t->assign('frm', $frm);

// UI設定ロジックを取得する
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
assert('is_object( $manager ) && is_a( $manager, \'GRN_UIConfigManager\' )');
$config = $manager->getSystemConfig();
assert('is_object( $config ) && is_a( $config, \'GRN_UIConfig\' )');

// ロック制御するかどうか
$t->assign('enable_lock', $config->getFileLockable());

$t->display(cb_get_pagename() . '.tpl');

