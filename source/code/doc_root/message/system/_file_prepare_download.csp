<?php
require_once('message/file.csp');
require_once('grn/application.csp');

$file_id = array_key_exists('rfid', $G_INPUT) ? $G_INPUT['rfid'] : '';

if ($file_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$file_manager = new GRN_Message_FileManager();
$file = $file_manager->getFile($file_id);
if ( ! $file) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$message_id = array_key_exists('mid', $G_INPUT) ? $G_INPUT['mid'] : '';
$relation_id = array_key_exists('rid', $G_INPUT) ? $G_INPUT['rid'] : '';

$body = null;

$log_ver = array_key_exists('ver', $G_INPUT) ? $G_INPUT['ver'] : '';
if ($log_ver != '') {
    $app_locator = GRN_ApplicationLocator::instance();
    $dbconn = $app_locator->getConnection('message');

    $rowset = $file->getLogSet();
    $rowset->addCondition("col_version ='" . $dbconn->escape($log_ver) . "'");

    $log = $rowset->iterate();
    $rowset->destroy();

    if ( ! $log) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    $body = $log->get('body');
} else {
    $body = $file->getCurrentBody();
}
$file_name = $body->get('name');
