<?php

use grn\fts\Application as FtsApplication;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    $message_id = @ $G_INPUT['mid'];
    $file_id = @ $G_INPUT['rfid'];

    foreach ([$message_id, $file_id] as $id) {
        if ($id == '' || ! ctype_digit($id)) {
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
                null,
                ['app_name' => $G_message_name]);
        }
    }

    $frm = 'vw';
    if (array_key_exists('frm', $G_INPUT)
        && strcmp($G_INPUT['frm'], 'ac') === 0
    ) {
        $frm = $G_INPUT['frm'];
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    require_once('message/file.csp');
    $fm = new GRN_Message_FileManager();
    $file = $fm->getFile($file_id);

    if ( ! $file) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    if (array_key_exists('cancel', $G_INPUT)) {
        $lock = $file->getLockObject();
        $lock->releaseLock();

        cb_redirect('message/system/inspection_file_view',
            [
                'mid'  => $message_id,
                'rfid' => $file_id,
                'frm'  => $frm,
            ]
        );
    }

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    $target_name = '';
    if (array_key_exists('fn', $G_INPUT)) {
        $target_name = $G_INPUT['fn'];
    }

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if ((is_array($files) && count($files) == 1)) {
        if ( ! array_key_exists('cancel', $G_INPUT)) {
            $uploaded_file = array_pop($files);
            $file->update($user, $uploaded_file, @ $G_INPUT['comment']);
            if (FtsApplication::isAvailable()) {
                require_once('message/message_logic.csp');
                $message_logic = new GRN_Message_Logic();
                $message = $message_logic->getMessageById($message_id);
                if ( ! is_null($message)
                     && $message->get('col_message_type')
                        !== GRN_MESSAGE_TYPE_DRAFT
                ) {
                    // 下書きは更新しない。
                    require_once('message/file.csp');
                    $fileManager = new GRN_Message_FileManager();
                    $fileManager->updateFileIndexForFts($file, $message_id);
                }
            }
        }

        $lock = $file->getLockObject();
        $lock->releaseLock();

        cb_redirect('message/system/inspection_file_view',
            [
                'mid'  => $message_id,
                'rfid' => $file_id,
                'frm'  => $frm,
            ]
        );
    } else {
        $t->assign('err_no_file', true);
        // if error, show the source form
        $t->setPageInfo('message/system/inspection_file_upload');
        $t->assign('form_name', $target_name);
        require('_file_upload.csp');
        $t->assign('comment', @ $G_INPUT['comment']);

        $t->display('message/system/inspection_file_upload.tpl');
    }

}
