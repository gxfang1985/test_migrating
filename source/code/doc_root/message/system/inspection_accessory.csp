<?php

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

$message_id = @ $G_INPUT['mid'];

if ($message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$t->assign('mid', $message_id);

// site position
$page_title = grn_get_current_page_display_name();
$page_search = 'message/system/inspection_search';
$page_view = 'message/system/inspection_view';
$t->assign('page_title', $page_title);
$t->assign('site_position',
    [
        [
            'page' => $page_search,
            'name' => grn_get_page_display_name($page_search),
            'sf'   => '1'
        ],
        [
            'page' => $page_view,
            'name' => grn_get_page_display_name($page_view),
            'mid'  => $message_id
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]);

// login user
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

// user config
require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$user_config = $cm->getUserConfig($user);

$t->assign('name_width', $user_config->getNameWidth());
$t->assign('truncate_width', $user_config->getTruncateWidth());

require_once('grn/controller.csp');
$utility = new GRN_ControllerUtil();

if (is_null($sort = $utility->getSortParameter())) {
    $sort = '1';
}

$utility->setSortParameter($sort);
$t->assign('sort', strcmp($sort, '1') === 0 ? '0' : '1');

require_once('message/inspection.csp');
$message = grn_message_inspection_get_message_info($message_id);

if ( ! $message) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$message_for_view = [];
$message_for_view['mid'] = $message_id;
$message_for_view['subject'] = $message['subject'];

require_once('message/file.csp');
$fm = new GRN_Message_FileManager();
$files = $fm->getAllFiles($message_id, (strcmp($sort, '1') === 0));

$files_for_view = [];
$users_id = []; //GRB-15046
while ( ! is_null(($data = $files->iterate()))) {
    $title = $data['f']->getTitle();
    if (is_null($title) || strlen($title) < 1) {
        $title = $data['b']->get('name');
    }
    $follow = $data['r']->get('follow');
    $creator = $data['f']->get('creator');
    $files_for_view[$data['f']->getOID()] = [
        'title'        => $title,
        'filename'     => $data['b']->get('name'),
        'abstract'     => $follow ? $follow->get('data') : $message['abstract'],
        //'follow_id'    => $follow ? $follow->getOID() : null,
        'follow_id'    => $follow ? $follow->get('id') : null,
        'ctime'        => $data['f']->get('ctime'),
        'creator_uid'  => $creator ? $creator->getOID() : 0,
        'creator_name' => $creator ? $creator->get('display_name')
            : $data['f']->get('creator_name'),
        'rfid'         => $data['r']->getOID(),
        'mime'         => $data['b']->getMIMEType()
    ];
    //start GRB-15046
    $uid = $files_for_view[$data['f']->getOID()]['creator_uid'];
    if ($uid > 0) {
        $users_id[] = $uid;
    }
    require_once("grn/controller.csp");
    $users_id = array_values(array_unique($users_id));
    $users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
        $user);
    $t->assign('users_info', $users_info);
    //end GRB-15046
}

$message_for_view['all_attach_files'] = $files_for_view;

$t->assign('message', $message_for_view);

// Smarty実行
$t->display(cb_get_pagename() . '.tpl');

