<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $message_id = @ $G_INPUT['mid'];
    $file_id = @ $G_INPUT['rfid'];
    $frm = @ $G_INPUT['frm'];

    if ($message_id == '' || $file_id == '') {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    require_once('message/inspection.csp');
    $message = grn_message_inspection_get_message_info($message_id);

    if ( ! $message) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }

    require_once('message/file.csp');
    $fm = new GRN_Message_FileManager();
    $ret = $fm->deleteFile($file_id, false);
    if ($ret === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    require_once('message/message_logic.csp');
    $message_logic = new GRN_Message_Logic();
    global $G_container_base;
    /** @var $uum GRN_Uum */
    $uum = $G_container_base->getInstance('uum');
    $ret = $message_logic->deleteMessageFile($uum->getLoginUser(), $message_id);

    if ($ret === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }

    if (strcmp($frm, 'ac') === 0) {
        $page = 'message/system/inspection_accessory';
        cb_redirect($page, ['mid' => $message_id]);
    } else {
        $page = 'message/system/inspection_view';
        cb_redirect($page, ['mid' => $message_id]);
    }
}

