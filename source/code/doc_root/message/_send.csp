<?php

$category_id = null;
if (array_key_exists('cid', $G_INPUT)) {
    $category_id = $G_INPUT['cid'];
    $t->assign('category_id', $category_id);
}

$t->assign('app_name', $G_message_name);

// page title
$page_title
    = grn_get_current_page_display_name(['app_name' => $G_message_name]);
$t->assign('page_title', $page_title);

// site position
$page_index = 'message/index';
$page_inbox = 'message/inbox';
$page_outbox = 'message/outbox';
$page_draftbox = 'message/draftbox';
$page_garbagebox = 'message/garbagebox';
$page_category_list = 'message/category_list';

if ( ! is_null($category_id) && strlen($category_id) > 0) {
    require_once('message/folder_logic.csp');
    $folder_logic = new GRN_Message_FolderLogic();
    $folder_info = $folder_logic->getFolderInfo($G_message_login,
        $category_id);

    if ( ! $folder_info) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
    }
}

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session = $sm->getSession('message/send');
if (array_key_exists('k', $G_INPUT)) {
    $session->set('k', 1);
} else {
    $session->unset_by('k');
}

require_once('message/system_logic.csp');
$system_logic = GRN_Message_SystemLogic::getInstance();
$t->assign('message',
    ['confirm' => $system_logic->getConfirmConfigAttribute()]);
$t->assign('use_editor', $system_logic->getUseREConfigAttribute());

$t->assign('rows', $G_message_ui_config->getAreaHeight());
$t->assign('cols', $G_message_ui_config->getAreaWidth());

/**
 * 管理者設定の部分は最初、閉じておく
 */
$t->assign('operator_open', 0);

$sf = 0;
if ( ! is_null($category_id) && strlen($category_id) > 0) {
    switch ($folder_info['folder_type']) {
        case GRN_MESSAGE_RECEIVINGFOLDER:
            $page_folder = $page_inbox;
            $sf = 1;
            break;
        case GRN_MESSAGE_SENDINGFOLDER:
            $page_folder = $page_outbox;
            break;
        case GRN_MESSAGE_DRAFTFOLDER:
            $page_folder = $page_draftbox;
            break;
        case GRN_MESSAGE_GARBAGEFOLDER:
            $page_folder = $page_garbagebox;
            break;
        default:
            $page_folder = $page_category_list;
    }
}

$t->assign('plugin', [
    'name'   => 'common',
    'params' => [
        'action'       => null,
        'session_name' => cb_get_pagename(),
        'app_id'       => 'message'
    ]
]);

$site_position = null;
if (is_null($category_id) || strlen($category_id) == 0) {
    $site_position = [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index),
            'sf'   => $sf
        ],
        [
            'page' => '',
            'name' => $page_title
        ],
    ];
} else {
    $site_position = [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index),
            'sf'   => $sf
        ],
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_folder),
            'cid'  => $category_id,
            'sf'   => 1
        ],
        [
            'page' => '',
            'name' => $page_title
        ],
    ];
}

$t->assign('site_position', $site_position);

