<?php

$category_id = @ $G_INPUT['cid'];
$relation_id = @ $G_INPUT['rid'];
$message_id = @ $G_INPUT['mid'];

if ($category_id == '' || $relation_id == '' || $message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$t->assign('cid', $category_id);
$t->assign('rid', $relation_id);
$t->assign('mid', $message_id);

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

require_once('message/folder_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();
$folder_info = $folder_logic->getFolderInfo($user, $category_id);
if ( ! $folder_info) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$folder_type = $folder_info['folder_type'];

$t->assign('app_name', $G_message_name);

// page title
$page_title
    = grn_get_current_page_display_name(['app_name' => $G_message_name]);
$t->assign('page_title', $page_title);

// site position
$page_index = 'message/index';
$page_inbox = 'message/inbox';
$page_outbox = 'message/outbox';
$page_draftbox = 'message/draftbox';
$page_garbagebox = 'message/garbagebox';
$page_category_list = 'message/category_list';

$sf = 0;
switch ($folder_info['folder_type']) {
    case GRN_MESSAGE_RECEIVINGFOLDER:
        $page_folder = $page_inbox;
        $sf = 1;
        break;
    case GRN_MESSAGE_SENDINGFOLDER:
        $page_folder = $page_outbox;
        break;
    case GRN_MESSAGE_DRAFTFOLDER:
        $page_folder = $page_draftbox;
        break;
    case GRN_MESSAGE_GARBAGEFOLDER:
        $page_folder = $page_garbagebox;
        break;
    default:
        $page_folder = $page_category_list;
}

$t->assign(
    'site_position',
    [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index),
            'sf'   => $sf
        ],
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_folder),
            'cid'  => $category_id,
            'sf'   => 1
        ],
        [
            'page' => 'message/view',
            'name' => grn_get_page_display_name('message/view',
                ['app_name' => $G_message_name]),
            'cid'  => $category_id,
            'rid'  => $relation_id,
            'mid'  => $message_id
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

require_once('message/system_logic.csp');
$system_logic = GRN_Message_SystemLogic::getInstance();
$use_editor = $system_logic->getUseREConfigAttribute();
$t->assign('use_editor', $use_editor);

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$message = $message_logic->getMessageBody($user, $relation_id,
    $message_id, strcmp($use_editor, '1') === 0 ? false : true);

$addressees = $message_logic->getAddressees($user, $message_id);
$is_operator = _grn_message_regard_operator($addressees,
    $message['creator_id']);

if ( ! $message) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

if ( ! $is_operator) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$message_for_view = [];
foreach ($message as $key => $value) {
    $message_for_view[$key] = $value;
}

// attached files
require_once('message/file.csp');
$fm = new GRN_Message_FileManager();
$files = $fm->getMessageFiles($message_id, false);

$files_for_view = [];
require_once('grn/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);
$files_for_view = grn_init_attached_file(cb_get_pagename() . $tmp_key, $files,
    true, 'message');

$t->assign('attached_files', $files_for_view);
$message_for_view['attached_files'] = $files_for_view;

// for rich editor
if ($message['format_type'] == 1) {
    $message_for_view['html'] = $message['data'];
}

$t->assign('rows', $G_message_ui_config->getAreaHeight());
$t->assign('cols', $G_message_ui_config->getAreaWidth());

$t->assign('message', $message_for_view);
