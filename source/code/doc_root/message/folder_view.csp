<?php

// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

$category_id = @ $G_INPUT['cid'];

if ($category_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$t->assign('cid', $category_id);

require_once('message/message_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();
$folder_info = $folder_logic->getFolderInfo($user, $category_id);
if ( ! $folder_info) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$folder_type = $folder_info['folder_type'];

if ($folder_type == GRN_MESSAGE_GARBAGEFOLDER) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

// page title
$page_title = grn_get_current_page_display_name();

if (isset($folder_info['folder_name'])) {
    $t->assign('page_title', $folder_info['folder_name']);
} else {
    $t->assign('page_title', $page_title);
}
// site position
$page_index = 'message/index';
$page_inbox = 'message/inbox';
$page_outbox = 'message/outbox';
$page_draftbox = 'message/draftbox';
$page_garbagebox = 'message/garbagebox';
$page_category_list = 'message/category_list';

$sf = 0;
switch ($folder_info['folder_type']) {
    case GRN_MESSAGE_RECEIVINGFOLDER:
        $page_folder = $page_inbox;
        $sf = 1;
        break;
    case GRN_MESSAGE_SENDINGFOLDER:
        $page_folder = $page_outbox;
        break;
    case GRN_MESSAGE_DRAFTFOLDER:
        $page_folder = $page_draftbox;
        break;
    case GRN_MESSAGE_GARBAGEFOLDER:
        $page_folder = $page_garbagebox;
        break;
    default:
        $page_folder = $page_category_list;
}
$t->assign(
    'site_position',
    [
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_index),
            'sf'   => $sf
        ],
        [
            'page' => $page_index,
            'name' => grn_get_page_display_name($page_folder),
            'cid'  => $category_id,
            'sf'   => 1
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

// フォルダ情報
$assign_category_map = [
    'cid'       => 'folder_id',
    'title'     => 'folder_name',
    'memo'      => 'memo',
    'type'      => 'folder_type',
    'subscribe' => 'subscription_flag'
];

$category_for_view = [];
foreach ($assign_category_map as $view_name => $data_name) {
    $category_for_view[$view_name] = $folder_info[$data_name];
}

$t->assign('category', $category_for_view);

// use garbage box or not
require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
$use_garbage = $personal_logic->getUseGarbageBoxAttribute($user);
//delete info
$delete_info = [
    'title'      => grn_get_page_display_name('message/folder_delete'),
    'page'       => 'message/folder_delete.tpl',
    'no_confirm' => false,
    'data'       => [
        'category_id'    => $category_id,
        'use_garbagebox' => $use_garbage,
        'folder_name'    => $folder_info['folder_name'],
    ],
    'handler'    => 'lnk_delete',
];
$t->assign('delete_info', $delete_info);
// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

