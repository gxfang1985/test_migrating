<?php

//-- get parameters from URL parameters
$filter_id = @ $G_INPUT['mfid'];

if ($filter_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILTER_NOT_FOUND);
}

$t->assign('filter_id', $filter_id);

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
$filter = $personal_logic->getFilter($user, $filter_id);
if ($filter === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILTER_NOT_FOUND);
}

$filter_for_view = [];
$filter_for_view['mfid'] = $filter_id;
$filter_for_view['title'] = $filter['name'];
$filter_for_view['cid'] = $filter['folder_id'];
$filter_for_view['kind'] = $filter['and_or'];

$filter_for_view['condition'] = [];

foreach ($filter['conditions'] as $condition) {
    $_condition = [];
    $_condition['object'] = $condition['class'];
    $_condition['value'] = $condition['string'];
    $_condition['type'] = $condition['condition'];

    $filter_for_view['condition'][] = $_condition;
}

$t->assign('filter', $filter_for_view);


//--------------------------------------------------------------

/*
// filter
$t->assign(
    'filter',array(
        'mfid' => 1, //filter_ID
        'title' => 'フィルター１', //filter_title
        'cid' => 3,
        'kind' => 2, //and,or
        'condition' =>  array( //condition setup
            1 => array(
                'object' => 1, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 1 //含む、含まない、同じ、異なる、始まる
            ),
            2 => array(
                'object' => 2, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 2 //含む、含まない、同じ、異なる、始まる
            ),
            3 => array(
                'object' => 3, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 3 //含む、含まない、同じ、異なる、始まる
            ),
        ),
    )
);
 */

// filter set Number
$t->assign('filter_set_num', count($filter['conditions']));

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//require_once( 'grn/controller.csp' );

// site position
$t->assign(
    'site_position',
    [
        [
            'page' => 'message/personal/filter',
            'name' => grn_get_page_display_name('message/personal/filter'),
        ],
        [
            'page' => 'message/personal/filter_view',
            'name' => grn_get_page_display_name('message/personal/filter_view'),
            'mfid' => $filter_id,
        ],
        [
            'page' => '',
            'name' => $page_title,
        ],
    ]
);


