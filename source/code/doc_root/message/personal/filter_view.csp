<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
//$application_id = @ $G_INPUT['app_id'];
//$t->assign('app_id', $application_id);
//$filter_id = @ $G_INPUT['id'];
//$t->assign('filter_id', $filter_id);

//------------------

$filter_id = @ $G_INPUT['mfid'];
if ($filter_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILTER_NOT_FOUND);
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

require_once('message/personal_logic.csp');
$personal_logic = GRN_Message_PersonalLogic::getInstance();
$filter = $personal_logic->getFilter($user, $filter_id);

if ( ! $filter) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILTER_NOT_FOUND);
}

$filter_for_view = [];
$filter_for_view['mfid'] = $filter_id;
$filter_for_view['title'] = $filter['name'];
$filter_for_view['cid'] = $filter['folder_id'];
$filter_for_view['type'] = $filter['and_or'];
$filter_for_view['condition'] = [];

// order
$filter_list = $personal_logic->getAllFilters($user);
$order = 1;
if (is_array($filter_list)) {
    foreach ($filter_list as $_filter) {
        if ($_filter['filter_id'] == $filter_id) {
            break;
        }

        $order++;
    }
}
$filter_for_view['order'] = $order;

foreach ($filter['conditions'] as $condition) {
    $_condition = [];
    $_condition['object'] = $condition['class'];
    $_condition['value'] = $condition['string'];
    $_condition['type'] = $condition['condition'];
    $filter_for_view['condition'][] = $_condition;
}

$t->assign('filter', $filter_for_view);

/*
// filter
$t->assign(
    'filter',array(
        'mfid' => 1, //filter_ID
        'title' => 'フィルター１', //filter_title
        'cid' => 3,
        'type' => 'all', //condition type
        'condition' =>  array( //condition setup
            1 => array(
                'object' => 1, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 1 //含む、含まない、同じ、異なる、始まる
            ),
            2 => array(
                'object' => 2, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 2 //含む、含まない、同じ、異なる、始まる
            ),
            3 => array(
                'object' => 3, //subject,sender,address
                'value' => 'なんちゃらかんちゃら',
                'type' => 3 //含む、含まない、同じ、異なる、始まる
            ),
        ),
    )
);
 */

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "message/personal/filter",
            'name' => grn_get_page_display_name("message/personal/filter")
        ],
        [
            'page' => "",
            'name' => $page_title
        ]
    ]
);
//delete info
$delete_info = [
    'title'      => grn_get_page_display_name('message/personal/filter_delete'),
    'page'       => 'message/personal/filter_delete.tpl',
    'no_confirm' => false,
    'data'       => ['selected' => $filter_for_view],
    'handler'    => 'lnk_delete',
];
$t->assign('delete_info', $delete_info);
// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


