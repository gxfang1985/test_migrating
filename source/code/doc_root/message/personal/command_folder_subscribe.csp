<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $subscribed_fids = [];
    foreach ($G_INPUT as $key => $value) {
        if (strncmp($key, 'fid', 3) == 0) {
            $subscribed_fids[] = substr($key, 3);
        }
    }

    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    require_once('message/folder_logic.csp');
    $folder_logic = new GRN_Message_FolderLogic();
    $folder_logic->setAllSubscription($user, $subscribed_fids);

    _message_rebuild_folder_tree();

    require_once('message/resources.csp');
    cb_redirect('personal/application_list', ['app_id' => GRN_MESSAGE_APPID]);
}

