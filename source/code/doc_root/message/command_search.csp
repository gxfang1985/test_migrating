<?php

if (array_key_exists('REQUEST_METHOD', $_SERVER)
    && strcasecmp($_SERVER['REQUEST_METHOD'], 'POST') === 0
) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $cmd = '';
    if (array_key_exists('cmd', $G_INPUT)) {
        $cmd = $G_INPUT['cmd'];
    }

    $cid = '';
    if (array_key_exists('cid', $G_INPUT)) {
        $cid = $G_INPUT['cid'];
    }

    switch ($cmd) {
        case 'move':
            $dcid = '';
            $ids = '';
            if (array_key_exists('dcid', $G_INPUT)) {
                $dcid = $G_INPUT['dcid'];
            }
            if (array_key_exists('ids', $G_INPUT)) {
                $ids = $G_INPUT['ids'];
            }

            if ($dcid == '') {
                require_once('message/error_code.csp');
                cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
            }

            if (is_array($ids)) {
                $relations = [];
                $folders = [];
                foreach ($ids as $id) {
                    list($relations[], $dummy1, $dummy2, $folders[], $dummy3)
                        = explode(',', $id);
                }

                // create folder groups
                $folder_groups = [];
                foreach ($folders as $index => $fid) {
                    if ( ! array_key_exists($fid, $folder_groups)) {
                        $folder_groups[$fid] = [];
                    }

                    $folder_groups[$fid][] = $relations[$index];
                }

                if (count($folder_groups) > 0) {
                    require_once('message/message_logic.csp');
                    $message_logic = new GRN_Message_Logic();

                    foreach ($folder_groups as $scid => $rids) {
                        $ret = $message_logic->moveMessages($G_message_login,
                            $scid, $dcid,
                            $rids);

                        if ( ! $ret) {
                            require_once('message/error_code.csp');
                            cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_MOVED,
                                ['app_name' => $G_message_name],
                                ['app_name' => $G_message_name],
                                ['app_name' => $G_message_name]);
                        }
                    }
                }
            }

            cb_redirect('message/index', ['cid' => $cid, 'sf' => 1]);
            break;
        case 'delete':
            $params = [];
            $params['cid'] = $cid;
            $params['frm'] = 'srch';
            $ids = @ $G_INPUT['ids'];

            /*
            if( $params['cid'] == '' || $params['ctype'] == '' )
            {
                require_once( 'message/error_code.csp' );
                cb_throw_error( E_GRN_MESSAGE_FOLDER_NOT_FOUND );
            }
             */

            if (is_array($ids)) {
                require_once('fw/session_manager.csp');
                $sm = CB_SessionManager::getInstance();
                $session = $sm->getSession('message/index');
                $session->set('message_ids', $ids);

                cb_redirect('message/delete_multi', $params);
            } else {
                cb_redirect('message/index', ['cid' => $cid, 'sf' => 1]);
            }
            break;
        default:
            require_once('message/error_code.csp');
            cb_throw_error(E_GRN_MESSAGE_WRONG_PARAMETER);
    }
}

