<?php

use grn\grn\MemberLogic;
use grn\grn\mention\MentionController;

require_once('message/error_code.csp');

global $G_state_set;
$G_state_set->set("html_should_be_closed", false);
$G_state_set->set("copyright_should_be_written", false);
$G_state_set->set("error_page_type", "json");

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_container_base;
    $uum = $G_container_base->getInstance('uum');
    $user = $uum->getLoginUser();

    if ( ! $user) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    require_once('message/message_logic.csp');
    $message_logic = new GRN_Message_Logic();

    $category_id = @$G_INPUT['cid'];
    $relation_id = @$G_INPUT['rid'];
    $message_id = @$G_INPUT['mid'];

    if ($category_id == '' || $relation_id == '' || $message_id == '') {
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }
    $follow = [];
    $follow['creator'] =& $user;
    $follow['format_type'] = 0;
    $follow['data'] = $G_INPUT['data'];

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);
    if (cb_trim($follow['data']) == '' && count($files) == 0) {
        cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_INPUTTED);
    }

    $mentioned_objects
        = MentionController::getMentionObjectsFromRequestArgs($G_INPUT);
    $mention_member_ids = $mentioned_objects->getObjectIdsGroupByType();
    $mention_user_ids = $mention_member_ids[MemberLogic::TYPE_USER];
    $evaluated_user_ids
        = $message_logic->filterUsersNotHavingPermission($message_id,
        $mention_user_ids);
    if ($evaluated_user_ids) {
        cb_throw_error(E_GRN_MESSAGE_HAS_NO_PERMISSION, null,
            ['users' => MemberLogic::getCommaSeparatedUserNames($evaluated_user_ids)]);
    }

    $follow['mention'] = $mentioned_objects;

    $ret = $message_logic->writeFollow($user, $message_id, $follow, $files);
    if ($ret === false) {
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }
}
echo json_encode(["succeed" => 1]);
