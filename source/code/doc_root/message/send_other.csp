<?php

use grn\grn\MemberLogic;

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$form_name = cb_get_pagename();
// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form($form_name, true);

require('_send_other.csp');

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();

$addressees = $message_logic->getAddressees($user, $message_id);
if ($addressees === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$uids = [];
foreach ($addressees as $addressee) {
    $uids[] = $addressee['id'];
}
require_once("grn/controller.csp");
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($uids,
    $uum->getLoginUser());

$initialize_users_for_view = [];
$addressee_users_for_filter_view = [];
$operation_users_for_filter_view = [];
foreach ($addressees as $addressee) {
    if ($addressee['id'] != '' && $addressee['dtime']->unix_ts == 0) {
        $initialize_users_for_view[] = $addressee['id'];
        if ($addressee['is_operator']) {
            $operation_users_for_filter_view[] = $addressee['id'];
        }
    }
}

$message_info = $message_logic->getMessageInfo($user, $relation_id,
    $message_id);
$creator_id = $message_info['creator_id'];

require_once("message/view_utils.csp");
$t->assign('operator_open',
    GRN_Message_ViewUtils::is_operator_open($operation_users_for_filter_view,
        $creator_id));

$initialize_users_for_view = MemberLogic::getInstance()
                                        ->getDisplayUsersByUserIds($initialize_users_for_view);
$t->assign('addressee_users', $initialize_users_for_view);

$addressee_users_for_filter_view = $initialize_users_for_view;
$t->assign('addressee_users_filter', $addressee_users_for_filter_view);

$operation_users_for_filter_view = MemberLogic::getInstance()
                                              ->getDisplayUsersByUserIds($operation_users_for_filter_view);
$t->assign('operation_users', $operation_users_for_filter_view);

//generate upload ticket
include('grn/_upload_prepend.csp');

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

