<?php

// ユーザー取得
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if ( ! $user) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_USER_NOT_FOUND);
}

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//------------------

$category_id = array_key_exists('cid', $G_INPUT) ? $G_INPUT['cid'] : '';

require_once('message/folder_logic.csp');
$folder_logic = new GRN_Message_FolderLogic();

if ($category_id == '') {
    // カテゴリの指定がない場合は受信箱

    $category_id = $folder_logic->getSpecificFolderID($user,
        GRN_MESSAGE_RECEIVINGFOLDER);
    if ( ! $category_id) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
    }
}

$page_title
    = grn_get_current_page_display_name(['app_name' => $G_message_name]);
$t->assign('app_name', $G_message_name);
$t->assign('page_title', $page_title);


$page_index = 'message/index';
$page_inbox = 'message/inbox';
$page_outbox = 'message/outbox';
$page_draftbox = 'message/draftbox';
$page_garbagebox = 'message/garbagebox';
$page_category_list = 'message/category_list';

$folder_info = $folder_logic->getFolderInfo($user, $category_id);

if ( ! $folder_info) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLDER_NOT_FOUND);
}

$sf = 0;
switch ($folder_info['folder_type']) {
    case GRN_MESSAGE_RECEIVINGFOLDER:
        $page_folder = $page_inbox;
        $sf = 1;
        break;
    case GRN_MESSAGE_SENDINGFOLDER:
        $page_folder = $page_outbox;
        break;
    case GRN_MESSAGE_DRAFTFOLDER:
        $page_folder = $page_draftbox;
        break;
    case GRN_MESSAGE_GARBAGEFOLDER:
        $page_folder = $page_garbagebox;
        break;
    default:
        $page_folder = $page_category_list;
}

$top_page = [
    'page' => $page_index,
    'name' => grn_get_page_display_name($page_index),
    'sf'   => $sf
];

$folder_page = [
    'page' => $page_index,
    'name' => grn_get_page_display_name($page_folder),
    'cid'  => $category_id,
    'sf'   => 1
];

$t->assign(
    'site_position',
    [
        $top_page,
        $folder_page,
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);


require_once('_unconfirmed_list.csp');

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


