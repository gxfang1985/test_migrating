<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $category_id = @ $G_INPUT['cid'];
    $relation_id = @ $G_INPUT['rid'];
    $message_id = @ $G_INPUT['mid'];
    $file_id = @ $G_INPUT['rfid'];

    if ($category_id == '' || $relation_id == '' || $message_id == ''
        || $file_id == ''
    ) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    require_once('message/message_logic.csp');
    $message_logic = new GRN_Message_Logic();
    $message = $message_logic->getMessageInfo($G_message_login,
        $relation_id, $message_id);
    if ($message === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }

    switch ($message['message_type']) {
        case '0': // general message
        case '1': // sent message
            $complete = false;
            $page = 'message/view';
            break;
        case '2': // draft message
            $complete = true;
            $page = 'message/draft_view';
            break;
    }

    if (array_key_exists('frm', $G_INPUT)
        && strcmp($G_INPUT['frm'], 'ac') === 0
    ) {
        $page = 'message/accessory';
    }

    require_once('message/file.csp');
    $fm = new GRN_Message_FileManager();
    $file = $fm->getFile($file_id);
    // ファイルの作成者あるいは許可がある人が変更/削除できるようにする
    require_once('message/message_logic.csp');
    $message_logic = new GRN_Message_Logic();
    $message_files = $message_logic->getMessageFiles($message_id);
    $addressee_list = $message_logic->getAddressees($G_message_login,
        $message_id);
    $creator_id = $message_logic->getMessageCreatorId($message_id);
    $is_operator = _grn_message_regard_operator($addressee_list,
        $creator_id);
    if ( ! array_key_exists($file_id, $message_files)) {
        $is_operator = false;
    }
    if ( ! $file || ! ($file->isCreator($G_message_login) || $is_operator)) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    $ret = $fm->deleteFile($file_id, $complete);
    if ($ret === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
            null,
            ['app_name' => $G_message_name]);
    }

    $ret = $message_logic->deleteMessageFile($G_message_login, $message_id);
    if ($ret === false) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name],
            ['app_name' => $G_message_name]);
    }

    cb_redirect($page, [
        'cid' => $category_id,
        'rid' => $relation_id,
        'mid' => $message_id,
    ]);
}

