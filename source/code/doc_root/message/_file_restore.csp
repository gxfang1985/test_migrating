<?php

$file_id = @ $G_INPUT['rfid'];
$restore_version = @ $G_INPUT['ver'];

if ($file_id == '' || $restore_version == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

$t->assign('linkparams', [
    'rid'  => $relation_id,
    'mid'  => $message_id,
    'rfid' => $file_id
]);

require_once('message/file.csp');
$fm = new GRN_Message_FileManager();
$file = $fm->getFile($file_id);
// ファイルの作成者あるいは許可がある人が変更/削除できるようにする
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$message_files = $message_logic->getMessageFiles($message_id);
$addressee_list = $message_logic->getAddressees($G_message_login, $message_id);
$creator_id = $message_logic->getMessageCreatorId($message_id);
$is_operator = _grn_message_regard_operator($addressee_list, $creator_id);
if ( ! array_key_exists($file_id, $message_files)) {
    $is_operator = false;
}
if ( ! $file || ! ($file->isCreator($G_message_login) || $is_operator)) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FILE_NOT_FOUND,
        null,
        ['app_name' => $G_message_name]);
}

require_once('grn/controller.csp');
$utility = new GRN_ControllerUtil();
$restore_for_view = $utility->getFileRestoreView($file, $restore_version);

$t->assign('restore', $restore_for_view);


