<?php

require_once("notification/application.csp");
$app_locator = GRN_ApplicationLocator::instance();

// ポータルアプリ取得
if ( ! $app_locator->isActive('portal')) {
    // ポータル使用不可状態
    cb_throw_error();
}
/** @var GRN_Portal_Application $app_portal */
$app_portal = $app_locator->getInstance('portal');

// ポータルトップページ取得
$portal_index = $app_portal->getConfig('index');
if (is_null($portal_index) || (strlen($portal_index) == 0)) {
    // 定義されていないときはトップページへ
    $portal_index = 'index';
}

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // 通知アプリ取得
    /** @var GRN_Notification_App $notification_app */
    $notification_app = $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
    if (is_null($notification_app)) {
        // 使用不可状態
        cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
    }

    $uum = $G_container_base->getInstance('uum');
    $login = $uum->getLoginUser();
    if ( ! is_object($login)) {
        cb_throw_error(E_COMMON_ACCOUNT_INVALIDATED);
    }

    // チェックした項目
    $notification = @ $G_INPUT['notification'];
    if (is_array($notification) && (count($notification) > 0)) {
        $is_to_me = isset($G_INPUT['is_to_me']) ? boolval($G_INPUT['is_to_me'])
            : false;
        // 通知データの確認処理
        $notification_app->confirmDatas($login, $notification, $is_to_me);
    }
}

// redirect portal page
cb_redirect($portal_index);

