<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//--- Smarty Section ---//

//Create Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//--- Applitation Section ---//

// 通知アプリ取得
require_once("notification/application.csp");
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Notification_App $notification_app */
$notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
if (is_null($notification_app)) {
    // 使用不可状態
    cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
}

// ポータルアプリ取得
if ( ! $app_locator->isActive('portal')) {
    // ポータル使用不可状態
    cb_throw_error();
}
/** @var GRN_Portal_Application $app_portal */
$app_portal =& $app_locator->getInstance('portal');

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    $uum =& $G_container_base->getInstance('uum');
    $login =& $uum->getLoginUser();
    if ( ! is_object($login)) {
        cb_throw_error(E_COMMON_ACCOUNT_INVALIDATED);
    }

    // 設定
    $settings = [];

    //文字サイズ
    $font_size = @ $G_INPUT['font_size'];
    $settings['font_size'] = $font_size;

    // 表示する項目
    $display_items = [];
    $settings['display_item'] = [];

    $space_name = @ $G_INPUT['space_name'];
    if ( ! is_null($space_name)) {
        $space_name = intval($space_name);
        $display_items[] = 'space_name';
    } else {
        $space_name = 0;
    }

    // 内容
    $abstract = @ $G_INPUT['abstract'];
    if ( ! is_null($abstract)) {
        $abstract = intval($abstract);
        $display_items[] = 'abstract';
    } else {
        $abstract = 0;
    }

    // 名前
    $sender_name = @ $G_INPUT['sender_name'];
    if ( ! is_null($sender_name)) {
        $sender_name = intval($sender_name);
        $display_items[] = 'sender_name';
    } else {
        $sender_name = 0;
    }

    // 日時
    $timestamp = @ $G_INPUT['timestamp'];
    if ( ! is_null($timestamp)) {
        $timestamp = intval($timestamp);
        $display_items[] = 'timestamp';
    } else {
        $timestamp = 0;
    }

    $settings['display_item'] = [
        'space_name'  => $space_name,                       // スペース名
        'abstract'    => $abstract,                         // 内容
        'sender_name' => $sender_name,                      // 名前
        'timestamp'   => $timestamp                         // 日時
    ];

    // 表示する件数
    $rows = @ $G_INPUT['rows'];
    $settings['rows'] = $rows;

    // 表示するアプリ
    $module_id = @ $G_INPUT['module_id'];
    $settings['module_id'] = $module_id;

    // ポータルアプリ取得
    $app_portal->setPortletSettings($G_INPUT['plid'], $settings);

    // 監査する
    require_once('notification/inspection.csp');
    $inspection = GRN_Notification_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        if ('set-personal' == $G_INPUT['display']) {
            $action = GRN_NOTIFICATION_INSPECTION_PERSONAL_PORTLET_CONFIG;
        } else {
            $action = GRN_NOTIFICATION_INSPECTION_SYSTEM_PORTLET_CONFIG;
        }
        $target = GRN_NOTIFICATION_INSPECTION_HISTORY_PORTLET_SET;

        $params = ['plid' => $G_INPUT['plid']];

        $informations = [];
        if (0 < count($display_items)) {
            $informations['display_items'] = implode('/', $display_items);
        } else {
            $informations['display_items'] = 'none';
        }

        $informations[$settings['module_id']] = $settings['rows'];

        $inspection->record($action, $target, $params, $informations);
    }

    //Switch Redirect Page
    if ($G_INPUT['display'] === 'set-system') {
        //redirect System page
        cb_redirect('portal/system/view', ['pid' => $G_INPUT['pid']]);
    } elseif ($G_INPUT['display'] === 'set-operation') {
        //redirect Operation page
        cb_redirect('portal/operation/view', ['pid' => $G_INPUT['pid']]);
    } else {
        //redirect Personal page
        cb_redirect('portal/personal/view', ['pid' => $G_INPUT['pid']]);
    }
}


