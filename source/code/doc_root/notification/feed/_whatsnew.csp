<?php

define('MAX_DATA_NUM', 20);

// 通知アプリ取得
require_once("notification/application.csp");
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Notification_App $notification_app */
$notification_app = $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);

if ( ! is_null($notification_app)) {
    // 通知更新処理対応アプリケーションの更新処理呼び出し
    $notification_app->updateApplications($login, true);
    // 外部アプリケーション管理ロジックを取得する
    $app_manager = $notification_app->getOutsideApplicationManager();

    $system_config = $notification_app->getSystemConfig();
    $personal_config = $notification_app->getPersonalConfig($login);
    $portlet_logic = $notification_app->getPortletLogic();
    $default_display_type = $portlet_logic->getDefaultDisplayType();

    // 取得件数
    $default_rows = MAX_DATA_NUM;

    // アプリのデフォルト設定を利用する
    {
        // 通知対応アプリ列挙
        $apps_list = [];
        $apps_list[] = $notification_app->getApplicationList(true);
        $apps_list[] = $app_manager->getAllList();

        // アプリごとのデータ
        $module_data_list = [];
        $module_data_list['indexes'] = [];
        $module_data_list['numbers'] = [];

        foreach (array_keys($apps_list) as $apps_id) {
            $apps =& $apps_list[$apps_id];
            foreach (array_keys($apps) as $app_id) {
                $app =& $apps[$app_id];
                // 通知対応で利用可能かどうかチェック
                if (is_object($app) && is_a($app, 'GRN_ApplicationBase')) {
                    // 最新情報取得
                    $module_id = $app->getModuleId();

                    $data_list =& $notification_app->getDataListFast('whatsnew',
                        $login, $module_id, 'time', true, 0, $default_rows);
                    $data_count = is_array($data_list) ? count($data_list) : 0;

                    $data_list_key = 'indexes';
                    $module_data_list[$data_list_key][$module_id] = [
                        'id'        => $module_id,
                        'name'      => $app->getName(),
                        'rows'      => $default_rows,
                        'data_list' => $data_list,
                        'count'     => $data_count
                    ];
                }
            }
        }
    }
}


