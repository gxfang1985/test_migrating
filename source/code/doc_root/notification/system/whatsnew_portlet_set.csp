<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

////////////////////////////////////////////////////////////////

require_once('notification/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$available_only = false;
/** @var GRN_Notification_App $notification_app */
$notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
if (is_null($notification_app)) {
    cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
}

$app_manager =& $notification_app->getOutsideApplicationManager();

$system_config =& $notification_app->getSystemConfig();

////////////////////////////////////////////////////////////////

// 表示しない項目の一覧を取得する
$not_display_items = [];
$system_config->getWhatsNewPortletNotDisplayItems($not_display_items);

require_once('notification/view_util.csp');
$utility = GRN_Notification_ViewUtil::getInstance();
$captions = $utility->getWhatsNewItemCaptions();
$display_items = [];

foreach ($captions as $key => $caption) {
    $checked = 0;
    if (false === array_search($key, $not_display_items)) {
        $checked = 1;
    }

    $display_items[$key] = [
        'caption' => $caption,
        'checked' => $checked
    ];
}

////////////////////////////////////////////////////////////////

// モジュールごとに表示の初期設定値を取得する
$apps_list = [];
$apps_list[] = $notification_app->getApplicationList($available_only);
$apps_list[] = $app_manager->getAllList();

$module_settings = [];

foreach (array_keys($apps_list) as $apps_id) {
    $apps =& $apps_list[$apps_id];
    foreach (array_keys($apps) as $app_id) {
        $app =& $apps[$app_id];
        $module_id = $app->getModuleId();
        if ('grn.' == substr($module_id, 0, 4)) {
            $app =& $app_locator->getInstance($app_id);
        }
        if ( ! ($app instanceof GRN_ApplicationBase)) {
            continue;
        }

        $setting = null;
        $system_config->getWhatsNewPortletDisplaySetting($module_id, $setting);
        if (is_array($setting)) {
            if ('x.' == substr($module_id, 0, 2)) {
                if (0 == strcasecmp('Cybozu Information', $app->getId())) {
                    $class = 'notify_cybozu20.gif';
                } else {
                    $class = $app->getConfig('icon20') . '.gif';
                }
            } else {
                $class = $app->getConfig('icon20') . '.png';
            }

            $setting += [
                'name'  => $app->getDefaultName(),
                'class' => $class,
            ];

            $module_id = str_replace('.', '_', $module_id);
            $module_settings[$module_id] = $setting;
        }
    }
}

$t->assign('app_id', 'notification');
$t->assign('display_items', $display_items);
$t->assign('application', $module_settings);
$t->assign('select1', [
    'name'     => 'keep_day_notice',
    'options'  => [0, 5, 10, 15, 20,],
    'padding'  => '&nbsp;',
    'selected' => 5,
]);

////////////////////////////////////////////////////////////////

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


