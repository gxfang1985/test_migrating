<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // GET/POSTされたパラメータを取得する
    $is_not_receive = false;
    if (array_key_exists('is_not_receive', $G_INPUT)) {
        $is_not_receive = $G_INPUT['is_not_receive'];
    }

    // 通知一覧を取得する
    require_once('notification/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Notification_App $notification_app */
    $notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
    if ( ! is_object($notification_app)
         || ! is_a($notification_app, 'GRN_Notification_App')
    ) {
        cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
    }

    // 通知一覧の設定を取得する
    $system_config =& $notification_app->getSystemConfig();

    // 未登録の外部通知の設定を保存する
    $setting = ['is_receive' => (1 != $is_not_receive)];
    if ( ! $system_config->setOutsideApplicationSetting($setting)) {
        cb_throw_error(E_GRN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
    }

    // 監査する
    require_once('notification/inspection.csp');
    $inspection = GRN_Notification_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $action = GRN_NOTIFICATION_INSPECTION_NOTIFY_SET_CONFIG;
        $target = GRN_NOTIFICATION_INSPECTION_NOTIFY_SET_TARGET;
        $informations = [];
        if ($is_not_receive) {
            $informations['receive'] = 'true';
        } else {
            $informations['receive'] = 'false';
        }
        $inspection->record($action, $target, null, $informations);
    }
}

cb_redirect('system/application_list', ['app_id' => 'notification']);


