<?php

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;
// for site position
$t->assign('app_id', 'notification');

// 通知アプリ取得
require_once("notification/application.csp");
$app_locator = GRN_ApplicationLocator::instance();
$available_only = false;
/** @var GRN_Notification_App $notification_app */
$notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
if (is_null($notification_app)) {
    // 使用不可状態
    cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
}

// 外部アプリケーション管理ロジックを取得する
$app_manager =& $notification_app->getOutsideApplicationManager();

$system_config =& $notification_app->getSystemConfig();

//------------------
// 通知対応アプリ一覧取得
$module_settings = [];

$apps_list = [];
$apps_list[] = $notification_app->getApplicationList($available_only);
$apps_list[] = $app_manager->getAllList();

foreach (array_keys($apps_list) as $apps_id) {
    $apps =& $apps_list[$apps_id];
    foreach (array_keys($apps) as $app_id) {
        $app =& $apps[$app_id];
        $module_id = $app->getModuleId();
        if ('grn.' == substr($module_id, 0, 4)) {
            $app =& $app_locator->getInstance($app_id);
            $icon = $app->getConfig('icon20') . '.png';
        }
        if ('x.' == substr($module_id, 0, 2)) {
            if (0 == strcasecmp('Cybozu Information', $app->getId())) {
                $icon = 'notify_cybozu20.gif';
            } else {
                $icon = $app->getConfig('icon20') . '.gif';
            }
        }
        if ( ! is_object($app) || ! is_a($app, 'GRN_ApplicationBase')) {
            continue;
        }

        // 設定読み込み
        $setting = null;
        $system_config->getWhatsNewPortletForceSetting($module_id, $setting);
        if (is_array($setting)) {
            $module_setting = [
                'id'              => $module_id,
                'html_escaped_id' => htmlspecialchars($module_id),
                'name'            => $app->getDefaultName(),
                'icon'            => $icon,
                'setting'         => $setting
            ];

            $module_settings[$module_id] = $module_setting;
        }
    }
}

$t->assign('module_settings', $module_settings);

//------------------

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Smarty実行
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");

