<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // 通知アプリを取得する
    require_once("notification/application.csp");
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Notification_App $notification_app */
    $notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
    if (is_null($notification_app)) {
        cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
    }

    // 外部アプリケーション管理ロジックを取得する
    $app_manager =& $notification_app->getOutsideApplicationManager();

    $system_config =& $notification_app->getSystemConfig();

    // 表示しない項目の一覧を保存する
    require_once('notification/view_util.csp');
    $utility = GRN_Notification_ViewUtil::getInstance();
    $captions = $utility->getWhatsNewItemCaptions();
    $not_display_items = [];
    foreach (array_keys($captions) as $key) {
        $id = str_replace('.', '_', 'display_item_' . $key);
        if (0 == @ $G_INPUT[$id]) {
            $not_display_items[] = $key;
        }
    }

    $informations = [];
    if (0 < count($not_display_items)) {
        $informations['not_display_items'] = implode('/', $not_display_items);
    } else {
        $informations['not_display_items'] = 'none';
    }

    $retval
        = $system_config->setWhatsNewPortletNotDisplayItems($not_display_items);
    if (true !== $retval) {
        cb_throw_error(E_GRN_CMMN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
    }

    // モジュールごとに表示の初期選択値を保存する
    $apps_list = [];
    $apps_list[] = $notification_app->getApplicationList(false);
    $apps_list[] = $app_manager->getAllList();

    foreach (array_keys($apps_list) as $apps_id) {
        $apps =& $apps_list[$apps_id];
        foreach (array_keys($apps) as $app_id) {
            $app =& $apps[$app_id];
            $module_id = $app->getModuleId();
            if ( ! ($app instanceof GRN_ApplicationBase)) {
                continue;
            }

            $id = str_replace('.', '_', 'display_count_' . $module_id);
            if ( ! array_key_exists($id, $G_INPUT)) {
                continue;
            }

            $setting = [];
            $setting['count'] = strval($G_INPUT[$id]);

            $informations[$module_id] = 'count:' . $setting['count'];

            $retval
                = $system_config->setWhatsNewPortletDisplaySetting($module_id,
                $setting);
            if (true !== $retval) {
                cb_throw_error(E_GRN_CMMN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
            }
        }
    }

    // 監査する
    require_once('notification/inspection.csp');
    $inspection = GRN_Notification_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $action = GRN_NOTIFICATION_INSPECTION_SYSTEM_CONFIG;
        $target = GRN_NOTIFICATION_INSPECTION_WHATSNEW_PORTLET_SET;

        $inspection->record($action, $target, null, $informations);
    }
}

cb_redirect('system/application_list', ['app_id' => 'notification']);


