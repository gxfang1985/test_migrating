<?php

require_once('grn/application.csp');

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'notification/system/notifyinfo_add';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // 通知一覧を取得する
        require_once('notification/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();
        /** @var GRN_Notification_App $notification_app */
        $notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
        if ( ! is_object($notification_app)
             || ! is_a($notification_app, 'GRN_Notification_App')
        ) {
            cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
        }

        // GET/POSTされたパラメータを取得する
        $id = null;
        if (array_key_exists('id', $G_INPUT)) {
            $id = $G_INPUT['id'];
        }
        $display_name = null;
        if (array_key_exists('name', $G_INPUT)) {
            $display_name = $G_INPUT['name'];
        }

        // 外部通知管理を取得する
        $app_manager =& $notification_app->getOutsideApplicationManager();

        // 外部通知コードの衝突をチェックする
        $app_locator = GRN_ApplicationLocator::instance();
        $dbconn =& $app_locator->getConnection('notification');
        $add_condition = cb_queryf($dbconn, "col_id = '@S'", $id);
        if (0 < $app_manager->count($add_condition)) {
            cb_throw_error(E_GRN_NTFC_COLLISION_OUTSIDE_ID);
        }

        // 外部通知を生成する
        $app =& $app_manager->create($id);
        $app->setName($display_name);

        $app->setUrlPatterns($G_INPUT['url']);

        // 監査する
        require_once('notification/inspection.csp');
        $inspection = GRN_Notification_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            $action = GRN_NOTIFICATION_INSPECTION_NOTIFYINFO_CREATE;
            $target = GRN_NOTIFICATION_INSPECTION_NOTIFYINFO_TARGET;
            $params = [
                'aid'  => $app->getApplicationId(),
                'code' => $id,
                'name' => $display_name
            ];

            $inspection->record($action, $target, $params);
        }

        SmartyValidate::unregister_form($target_name);

        cb_redirect('notification/system/notifyinfo_list');
    } else {
        $t->setPageInfo($target_name);
        include('_notifyinfo_add.csp');

        $t->assign('id', cb_at($G_INPUT, 'id'));
        $t->assign('name', cb_at($G_INPUT, 'name'));
        $t->assign('url', cb_at($G_INPUT, 'url'));

        $t->display($target_name . '.tpl');
    }
}


