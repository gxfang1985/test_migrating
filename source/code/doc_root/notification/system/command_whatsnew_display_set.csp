<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // 通知アプリ取得
    require_once("notification/application.csp");
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Notification_App $notification_app */
    $notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
    if (is_null($notification_app)) {
        // 使用不可状態
        cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
    }

    // 外部通知アプリ取得
    $app_manager =& $notification_app->getOutsideApplicationManager();

    $system_config =& $notification_app->getSystemConfig();

    // 通知対応アプリ列挙
    $apps_list = [];
    $apps_list[] = $notification_app->getApplicationList(false);
    $apps_list[] = $app_manager->getAllList();

    // アプリごとの設定
    $informations = [];
    foreach (array_keys($apps_list) as $apps_id) {
        $apps =& $apps_list[$apps_id];
        foreach (array_keys($apps) as $app_id) {
            $app =& $apps[$app_id];

            if (is_null($app)) {
                continue;
            }

            $module_id = $app->getModuleId();
            $module_str = str_replace('.', '_', $module_id);  // '.' -> '_'

            // 設定するフラグ
            $set = @ $G_INPUT['set_' . $module_str];

            // 表示する形式
            $display_type = @ $G_INPUT['display_type_' . $module_str];

            $informations[$module_id] = $display_type;
            if ($set) {
                $informations[$module_id] .= '/use';
            }

            // 設定をプロファイルにセーブ
            $result = $system_config->setWhatsNewPortletForceSetting($module_id,
                $set, $display_type);
            if ($result !== true) {
                // 設定失敗
                cb_throw_error(E_GRN_CMMN_NTFC_FAILED_TO_UPDATE_PROFILE_DATA);
            }
        }
    }

    require_once('notification/inspection.csp');
    $inspection = GRN_Notification_Inspection::getInstance();
    if ($inspection->isEnabled()) {
        $action = GRN_NOTIFICATION_INSPECTION_SYSTEM_CONFIG;
        $target = GRN_NOTIFICATION_INSPECTION_WHATSNEW_DISPLAY_SET;
        $inspection->record($action, $target, null, $informations);
    }
}

cb_redirect('system/application_list', ['app_id' => 'notification']);

