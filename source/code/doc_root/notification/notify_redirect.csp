<?php

// 通知本体を取得する
require_once('notification/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
/** @var GRN_Notification_App $notification_app */
$notification_app =& $app_locator->getInstance(GRN_NOTIFICATION_APP_ID);
if (is_null($notification_app)) {
    cb_throw_error(E_GRN_NTFC_NOT_AVAILABLE);
}

// 通知サービスを取得する
$notification_serviece =& $notification_app->getNotificationService();

// ログインユーザーを取得する
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();
if ( ! is_object($login)) {
    cb_throw_error(E_COMMON_ACCOUNT_INVALIDATED);
}

$notify_id = @ $G_INPUT['nid'];
if ( ! is_null($notify_id) && 0 < strlen($notify_id)) {
    // 通知を取得する
    $notify
        = $notification_serviece->getNotifyDataPropertiesByNotifyId($notify_id,
        $login->getOID());
    if (false === $notify->isStatusConfirmed()) {
        // 通知の状態を確認済みに変更する
        $notify_ids = [$notify_id];
        $notification_app->confirmDatas($login, $notify_ids);
    }

    if ($notify->getAutoConfirmFlag()) {
        if ('a' == @ $G_INPUT['ct']) {
            $data = $notify->getAbstractData();
        } else {
            $data = $notify->getSubjectData();
        }

        $url = @ $data['url'];
        if ( ! is_null($url) && 0 < strlen($url)) {
            if (strncasecmp($url, 'http', 4) !== 0) {
                cb_redirect($url);
            }

            global $G_state_set;
            $G_state_set->set('redirect_to', $url);
            cb_safe_exit();
        }
    }
}

$notify_history_id = @ $G_INPUT['nhid'];
if ( ! is_null($notify_history_id) && 0 < strlen($notify_history_id)) {
    $notify
        = $notification_serviece->getHistoryDataPropertiesById($notify_history_id,
        $login->getOID());

    if ('a' == @ $G_INPUT['ct']) {
        $data = $notify->getAbstractData();
    } else {
        $data = $notify->getSubjectData();
    }

    $url = @ $data['url'];
    if ( ! is_null($url) && 0 < strlen($url)) {
        if (strncasecmp($url, 'http', 4) !== 0) {
            cb_redirect($url);
        }

        global $G_state_set;
        $G_state_set->set('redirect_to', $url);
        cb_safe_exit();
    }
}

cb_redirect('notification/index');


