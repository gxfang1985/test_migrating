<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

// アイテムID
if ( ! array_key_exists('iid', $G_INPUT)) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$item_id = $G_INPUT['iid'];

// ファイルID
if ( ! array_key_exists('fid', $G_INPUT)) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ATTACHED_FILE_NOT_FOUND);
}
$file_id = $G_INPUT['fid'];


require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

// アイテム取得
if ( ! ($item =& $logic->getItem($login, $item_id))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

// アイテムのタイプを確認
if ($item->isFile()) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

// メモの取得
if ( ! ($content = $item->getContent())) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

// ファイルの取得
if ( ! ($file =& $content->getFile($file_id))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ATTACHED_FILE_NOT_FOUND);
}

$body = null;

if (@ $G_INPUT['ver']) {
    $body =& $file->getBody($G_INPUT['ver']);
} else {
    $body =& $file->getCurrentBody();
}

if ( ! $body) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_INVALID_FILE_VERSION);
}

$body->download(true);

cb_safe_exit();


