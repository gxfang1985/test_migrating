<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form(isset($target_name) ? $target_name
        : cb_get_pagename(), true);
}

//------------------

$folder_id = null;
if (array_key_exists('did', $G_INPUT)) {
    $folder_id = $G_INPUT['did'];
}

$t->assign('folder_id', $folder_id);

require_once('memo/controller.csp');
$utility = new GRN_Memo_ControllerUtil(isset($target_name) ? $target_name
    : cb_get_pagename());

require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

$position_args = null;

if ($folder_id) {
    if (is_null(($folder =& $logic->getFolder($login, $folder_id)))) {
        require_once('memo/error_code.csp');
        cb_throw_error(E_GRN_MEMO_FOLDER_NOT_FOUND);
    }

    $position_args = ['folder_name' => $folder->get('name')];

    $folder_for_view = grn_memo_folder_view($folder);
    $t->assign('folder', $folder_for_view);

    if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') != 0) {
        // フォームの初期値を設定
        $t->assign('pdid', $folder->getId('parent'));
        $t->assign('title', $folder_for_view['name']);
        $t->assign('memo', $folder_for_view['memo']);
    }
}

$root_folders = $logic->getRootFolders($login);
$menu = grn_memo_folder_select_menu($root_folders, $folder_id);

$t->assign('folder_menu', $menu);

$page_path = [
    'memo/index'       => ['did' => $folder_id],
    'memo/folder_view' => ['did' => $folder_id],
];

$utility->setSitePosition($t, $page_path, $position_args);

