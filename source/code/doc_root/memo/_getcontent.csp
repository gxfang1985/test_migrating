<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

$folder_id = null;
if (array_key_exists('did', $G_INPUT)) {
    $folder_id = $G_INPUT['did'];
}

if ( ! array_key_exists('iid', $G_INPUT) || strlen($G_INPUT['iid']) < 1
     || $G_INPUT['iid'] < 1
) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$item_id = $G_INPUT['iid'];

require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

if ( ! ($item =& $logic->getItem($login, $item_id))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

if ($item->isFile()) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

if ( ! ($content = $item->getContent())) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

require_once('memo/controller.csp');
$utility = new GRN_Memo_ControllerUtil();

$content_for_view = $utility->getContentView($content, true);
$files = $content->getFiles();
$files_for_view = [];
foreach (array_keys($files) as $id) {
    $files_for_view[$id] = $utility->getFileLinkView($files[$id]);
}
$content_for_view['files'] = $files_for_view;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;
$t->assign('content', $content_for_view);

$page_path = ['memo/index' => ['did' => $folder_id]];
$position = $utility->makeSitePosition('memo/view', $page_path);


