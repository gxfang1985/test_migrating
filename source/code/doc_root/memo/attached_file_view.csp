<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// フォルダID
$folder_id = null;
if (array_key_exists('did', $G_INPUT)) {
    $folder_id = $G_INPUT['did'];
}
$t->assign('folder_id', $folder_id);

// アイテムID
if ( ! array_key_exists('iid', $G_INPUT) || strlen($G_INPUT['iid']) < 1
     || $G_INPUT['iid'] < 1
) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$item_id = $G_INPUT['iid'];
$t->assign('item_id', $item_id);

// ファイルID
if ( ! array_key_exists('fid', $G_INPUT) || strlen($G_INPUT['fid']) < 1
     || $G_INPUT['fid'] < 1
) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ATTACHED_FILE_NOT_FOUND);
}
$file_id = $G_INPUT['fid'];
$t->assign('file_id', $file_id);

require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

// アイテム取得
if (is_null(($item =& $logic->getItem($login, $item_id)))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

// アイテムのタイプを確認
if ($item->isFile()) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

// データの取得
if ( ! ($content = $item->getContent())) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

// ファイルの取得
if ( ! ($file =& $content->getFile($file_id))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ATTACHED_FILE_NOT_FOUND);
}

require_once('memo/controller.csp');
$utility = new GRN_Memo_ControllerUtil();

require_once('grn/ui.csp');
$ucm = GRN_UIConfigManager::getInstance();
$uiconfig =& $ucm->getUserConfig($login);

// 履歴先頭位置
$offset = $utility->getListOffset();

// 履歴ソート
$order_column = $utility->getListOrderColumn(null, 'td');
$t->assign('sort', $order_column['param']);

// 履歴表示数
$limit = $uiconfig->getListMax();

$file_for_view = $utility->getFileDetailView($file,
    $offset, $limit, $order_column['column'], $order_column['order']);
$file_for_view['navi']['navi']['params'] = [
    'did' => $folder_id,
    'iid' => $item_id,
    'fid' => $file_id,
    'sf'  => 1
];

$t->assign('file', $file_for_view);


$t->assign('linkparams',
    ['did' => $folder_id, 'iid' => $item_id, 'fid' => $file_id]);


$position = [
    'memo/index' => ['did' => $folder_id],
    'memo/view'  => ['did' => $folder_id, 'iid' => $item_id],
];

$utility->setSitePosition($t, $position);


$t->display(cb_get_pagename() . ".tpl");

