<?php

global $G_INPUT;

global $G_container_app;
$uum = $G_container_app->getInstance('uum');
$login = $uum->getLoginUser();

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// フォルダID
$folder_id = null;
if (array_key_exists('did', $G_INPUT)
    && grn\grn\Validate::isNumber($G_INPUT['did'])
) {
    $folder_id = $G_INPUT['did'];
}
$t->assign('folder_id', $folder_id);

// アイテムID
if ( ! array_key_exists('iid', $G_INPUT)
     || ! grn\grn\Validate::isNumber($G_INPUT['iid'])
) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$item_id = $G_INPUT['iid'];

$t->assign('item_id', $item_id);

require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

// アイテム取得
if (is_null(($item = $logic->getItem($login, $item_id)))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}

if ( ! $item->isFile()) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

// ファイル取得
if ( ! ($file = $item->getContent())) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

require_once('memo/controller.csp');
$utility = new GRN_Memo_ControllerUtil();

require_once('grn/ui.csp');
$ucm = GRN_UIConfigManager::getInstance();
$uiconfig = $ucm->getUserConfig($login);

// 履歴先頭位置
$offset = $utility->getListOffset();

// 履歴ソート
$order_column = $utility->getListOrderColumn(null, 'td');
$t->assign('sort', $order_column['param']);

// 履歴表示数
$limit = $uiconfig->getListMax();

$file_for_view = $utility->getFileDetailView($file,
    $offset, $limit, $order_column['column'], $order_column['order']);
$file_for_view['navi']['navi']['params'] = [
    'did' => $folder_id,
    'iid' => $item_id,
    'sf'  => 1
];

$t->assign('file', $file_for_view);

if ($item->getId('folder')) {
    $folder = $item->get('folder');
    $folder_for_view = grn_memo_folder_view($folder);
    $folder_for_view['path'] = grn_memo_folder_path($folder);
    $t->assign('folder', $folder_for_view);
}

$t->assign('linkparams', ['did' => $folder_id, 'iid' => $item_id]);

// 移動メニュー
$folders = $logic->getRootFolders($login);
$t->assign('folder_menu', grn_memo_folder_select_menu($folders));
$t->assign('pdid', $item->getId('folder'));

// 前後ナビ
$list_utility = new GRN_Memo_ControllerUtil('memo/index');

$order_column = $list_utility->getListOrderColumn();

require_once('memo/list.csp');
$list = new GRN_Memo_ItemList($login);
$list->addOrderColumn($order_column['column'], $order_column['order']);
if ($folder_id) {
    $folder =& $logic->getFolder($login, $folder_id);
    $list->setFolder($folder);
}

$navi_for_view = [];

if ( ! is_null(($neighbor =& $list->getPrevious($item)))) {
    if ($neighbor->isFile()) {
        $navi_for_view['prev'] = [
            'page'        => 'memo/file_view',
            'page_params' => ['did' => $folder_id, 'iid' => $neighbor->getOID()]
        ];
    } else {
        $navi_for_view['prev'] = [
            'page'        => 'memo/view',
            'page_params' => ['did' => $folder_id, 'iid' => $neighbor->getOID()]
        ];
    }
}
if ( ! is_null(($neighbor =& $list->getNext($item)))) {
    if ($neighbor->isFile()) {
        $navi_for_view['next'] = [
            'page'        => 'memo/file_view',
            'page_params' => ['did' => $folder_id, 'iid' => $neighbor->getOID()]
        ];
    } else {
        $navi_for_view['next'] = [
            'page'        => 'memo/view',
            'page_params' => ['did' => $folder_id, 'iid' => $neighbor->getOID()]
        ];
    }
}
$t->assign('navi', $navi_for_view);

$delete_info = [
    'title'      => grn_get_page_display_name('memo/file_delete'),
    'page'       => 'memo/file_delete.tpl',
    'data'       => [
        'file'      => $file_for_view,
        'folder_id' => $item->getId('folder'),
        'item_id'   => $item->getOID()
    ],
    'no_confirm' => false,
    'handler'    => 'memo_file_delete',
];

$t->assign('delete_info', $delete_info);

$position = ['memo/index' => ['did' => $folder_id]];
$utility->setSitePosition($t, $position);


$t->display(cb_get_pagename() . ".tpl");

