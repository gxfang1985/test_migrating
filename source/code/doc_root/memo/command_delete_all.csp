<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $folder_id = null;
    if (array_key_exists('did', $G_INPUT)) {
        $folder_id = $G_INPUT['did'];
    }

    global $G_container_app;
    $uum =& $G_container_app->getInstance('uum');
    $login =& $uum->getLoginUser();

    require_once('memo/logic.csp');
    $logic = GRN_Memo_Logic::getInstance();

    require_once('memo/table.csp');
    $rowset = new CB_RowSet(cb_class2table('grn_memo_item'));
    $condition = $rowset->queryf("col_user = '@S'", $login->getOID());
    $rowset->addCondition($condition);

    if ($folder_id) {
        if ( ! ($folder =& $logic->getFolder($login, $folder_id))) {
            require_once('memo/error_code.csp');
            cb_throw_error(E_GRN_MEMO_FOLDER_NOT_FOUND);
        }

//        $rowset->addCondition( 'col_folder = '.$folder->getOID() );
        $rowset->addCondition($rowset->queryf("col_folder = '@S'",
            $folder->getOID()));
    }

    /**
     * 100件を削除するごとに実行時間をチェックして、1分経過で一旦終了する
     */

    $limit = 60;
    $start = time();
    $counter = 0;
    $remain = false;

    while ( ! is_null(($row = $rowset->iterate()))) {
        if (++$counter >= 100) {
            $now = time();
            if (($now - $start) >= $limit) {
                $remain = true;
                break;
            }
        }
        $row->delete();
        //Log: Delete memo
        require_once('memo/inspection.csp');
        $inspection = GRN_Memo_Inspection::getInstance();
        $inspection->writeLogMemo('delete', $row);
    }

    if ($remain) {
        cb_redirect('memo/delete_all', ['did' => $folder_id, 'cont' => 1]);
    }

    cb_redirect('memo/index', ['did' => $folder_id]);
}

