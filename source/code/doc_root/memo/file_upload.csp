<?php

global $G_INPUT;

global $G_container_app;
$uum =& $G_container_app->getInstance('uum');
$login =& $uum->getLoginUser();

require_once('grn/smarty.csp');
$t = new GRN_Smarty();

require_once('memo/logic.csp');
$logic = GRN_Memo_Logic::getInstance();

$folder_id = null;
if (array_key_exists('did', $G_INPUT)) {
    $folder_id = $G_INPUT['did'];
}
$t->assign('folder_id', $folder_id);

if ( ! array_key_exists('iid', $G_INPUT)) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$item_id = $G_INPUT['iid'];

if ( ! ($item =& $logic->getItem($login, $item_id))) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
}
$t->assign('item_id', $item_id);

if ( ! $item->isFile()) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

if ( ! ($file = $item->getContent())) {
    require_once('memo/error_code.csp');
    cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
}

//generate upload ticket
include('grn/_upload_prepend.csp');

require_once('memo/controller.csp');
$utility = new GRN_Memo_ControllerUtil();

$file_for_view = $utility->getFileView($file);

$t->assign('file', $file_for_view);

$t->assign('linkparams', ['did' => $folder_id, 'iid' => $item_id]);

$index_return = 0;
if (array_key_exists('index_return', $G_INPUT)) {
    $index_return = $G_INPUT['index_return'];
}

if ($index_return == "1") {
    $position = [
        'memo/index' => ['did' => $folder_id],
    ];
} else {
    $position = [
        'memo/index'     => ['did' => $folder_id],
        'memo/file_view' => ['did' => $folder_id, 'iid' => $item_id],
    ];
}

$utility->setSitePosition($t, $position);

//for the short cut from index view
if (isset($G_INPUT['index_return'])) {
    $t->assign('index_return', '1');
}

$t->display(cb_get_pagename() . '.tpl');

