<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$settings = @ $portlet['settings'];

// 保存フォルダID
$folder_id = @ $settings['did'];
// 編集中アイテムID

$item_id = @ $settings['iid'];

if ( ! isset($portlet['settings']['rows'])) {
    $portlet['settings']['rows'] = 10;
}

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

require_once('fw/profile.csp');
$up =& cb_get_user_profile($login, 'grn.memo.portlet');

$item_id = null;

$item_ids = null;
if ($up->getAttribute('item_ids', $item_ids)) {
    if (is_array($item_ids) && array_key_exists($portlet['plid'], $item_ids)) {
        $item_id = $item_ids[$portlet['plid']];
    }
}

if ($item_id) {
    require_once('memo/table.csp');
    require_once('memo/logic.csp');
    $logic = GRN_Memo_Logic::getInstance();

    $item =& $logic->getItem($login, $item_id);

    if ( ! $item || ! ($content = $item->getContent())) {
        // 編集していたメモが削除されている場合

        unset($item_ids[$portlet['plid']]);
        $up->updateAttribute('item_ids', $item_ids);
    } else {
        $t->assign('memo', [
            'iid'   => $item->getOID(),
            'title' => $content->get('title'),
            'data'  => $content->get('data'),
        ]);
    }
}

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('memo');
    $page_title = cb_plain_msg('grn.memo', 'portlet_view',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("memo/portlet/view.tpl");


