<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $folder_id = null;
    if (array_key_exists('did', $G_INPUT)) {
        $folder_id = $G_INPUT['did'];
    }

    if ( ! array_key_exists('eid', $G_INPUT)) {
        cb_redirect('memo/index', ['did' => $folder_id]);
    }
    $eid = $G_INPUT['eid'];

    if ( ! is_array($eid) || count($eid) < 1) {
        cb_redirect('memo/index', ['did' => $folder_id]);
    }

    if ( ! array_key_exists('cmd', $G_INPUT) || $G_INPUT['cmd'] != 'move') {
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession('grn.memo.index');

        $session->set('eid', $eid);

        cb_redirect('memo/delete_multi', ['did' => $folder_id]);
    }

    $parent_folder_id = null;
    if (array_key_exists('mdid', $G_INPUT) && strlen($G_INPUT['mdid']) > 0) {
        $parent_folder_id = $G_INPUT['mdid'];
    }

    global $G_container_app;
    $uum =& $G_container_app->getInstance('uum');
    $login =& $uum->getLoginUser();

    require_once('memo/logic.csp');
    $logic = GRN_Memo_Logic::getInstance();

    $parent_folder = null;

    if ( ! is_null($parent_folder_id)) {
        if ( ! ($parent_folder =& $logic->getFolder($login,
            $parent_folder_id))
        ) {
            require_once('memo/error_code.csp');
            cb_throw_error(E_GRN_MEMO_FOLDER_NOT_FOUND);
        }
    }

    foreach ($eid as $item_id) {
        if ( ! ($item =& $logic->getItem($login, $item_id))) {
            require_once('memo/error_code.csp');
            cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
        }

        $item->set('folder', $parent_folder);
        //Log: Update memo
        require_once('memo/inspection.csp');
        $inspection = GRN_Memo_Inspection::getInstance();
        if ( ! $item->isFile()) {
            $inspection->writeLogMemo('modify', $item);
        } else {
            $content = $item->getContent();
            $inspection->writeLogFile('modify', $item, $content);
        }
    }

    cb_redirect('memo/index', ['did' => $folder_id]);
}
