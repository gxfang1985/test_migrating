<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    global $G_container_app;
    $uum = $G_container_app->getInstance('uum');
    $login = $uum->getLoginUser();

    require_once('memo/logic.csp');
    $logic = GRN_Memo_Logic::getInstance();

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'memo/folder_add';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $title = array_key_exists('title', $G_INPUT) ? $G_INPUT['title'] : null;
        $memo = array_key_exists('memo', $G_INPUT) ? $G_INPUT['memo'] : null;

        $folder = $logic->createFolder($login, $title, $memo);

        if (array_key_exists('pdid', $G_INPUT)
            && strlen($G_INPUT['pdid']) > 0
        ) {
            if ( ! ($pf =& $logic->getFolder($login, $G_INPUT['pdid']))) {
                require_once('memo/error_code.csp');
                cb_throw_error(E_GRN_MEMO_PARENT_FOLDER_NOT_FOUND);
            }
            $folder_id = $folder->getOID();
            $pf->addFolder($folder_id);
        }

        //ログの書き出し　↓
        require_once('memo/inspection.csp');
        $inspection = GRN_Memo_Inspection::getInstance();
        $inspection->writeLogFolder('create', $folder);
        //ログの書き出し　↑

        require_once('memo/folder_tree.csp');
        GRN_Memo_FolderTree::_memo_rebuild_folder_tree($G_INPUT['pdid']);

        cb_redirect('memo/index', ['did' => @$G_INPUT['did']]);
    } else {
        $t->setPageInfo($target_name);

        $t->assign('title', cb_at($G_INPUT, 'title'));
        $t->assign('pdid', cb_at($G_INPUT, 'pdid'));
        $t->assign('memo', cb_at($G_INPUT, 'memo'));

        $folder_id = null;
        if (array_key_exists('did', $G_INPUT)) {
            $folder_id = $G_INPUT['did'];
        }
        $t->assign('folder_id', $folder_id);

        require_once('memo/controller.csp');
        $utility = new GRN_Memo_ControllerUtil();

        if ($folder_id) {
            if ( ! ($folder =& $logic->getFolder($login, $folder_id))) {
                require_once('memo/error_code.csp');
                cb_throw_error(E_GRN_MEMO_FOLDER_NOT_FOUND);
            }

            $folder_for_view = grn_memo_folder_view($folder);
            $t->assign('folder', $folder_for_view);
        }

        $folders = $logic->getRootFolders($login);
        $t->assign('folder_menu', grn_memo_folder_select_menu($folders));

        $page_path = ['memo/index' => ['did' => $folder_id]];
        $utility->setSitePosition($t, $page_path);

        $t->display($target_name . '.tpl');
    }
}
