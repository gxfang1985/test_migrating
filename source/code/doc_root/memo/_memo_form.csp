<?php

global $G_INPUT;

global $G_container_app;
$uum = $G_container_app->getInstance('uum');
$login = $uum->getLoginUser();


if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form(isset($target_name) ? $target_name
        : cb_get_pagename(), true);
}

require_once('memo/logic.csp');
require_once('memo/error_code.csp');

$logic = GRN_Memo_Logic::getInstance();

require_once('memo/controller.csp');
$tmp_key = grn_get_temporary_key();
$t->assign('tmp_key', $tmp_key);

if (array_key_exists('iid', $G_INPUT) && $G_INPUT['iid']) {
    $item_id = $G_INPUT['iid'];
    $t->assign('item_id', $item_id);

    if ( ! ($item =& $logic->getItem($login, $item_id))) {
        require_once('memo/error_code.csp');
        cb_throw_error(E_GRN_MEMO_ITEM_NOT_FOUND);
    }
    if ($item->isFile()) {
        require_once('memo/error_code.csp');
        cb_throw_error(E_GRN_MEMO_CONTENT_NOT_FOUND);
    }

    $content = $item->getContent();

    if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') != 0) {
        $t->assign('title', $content->get('title'));
        $t->assign('data', $content->get('data'));
        $t->assign('html', $content->get('html'));

        $files = $content->getFiles();

        if (isset($no_copy) && $no_copy) {
            $file_info = grn_init_attached_file(isset($target_name)
                ? $target_name . $tmp_key : cb_get_pagename() . $tmp_key,
                $files, true, 'memo');
        } else {
            $file_info = grn_init_attached_file(isset($target_name)
                ? $target_name . $tmp_key : cb_get_pagename() . $tmp_key,
                $files, false, 'memo');
        }

        // 位置の初期値を設定
        $t->assign('pdid', $item->getId('folder'));
    } else {
        $file_info = grn_get_attached_file_info(isset($target_name)
            ? $target_name . $tmp_key : cb_get_pagename() . $tmp_key);

        $t->assign('title', cb_at($G_INPUT, 'title'));
        $t->assign('pdid', cb_at($G_INPUT, 'pdid'));

        if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
            require_once('grn/controller.csp');
            $t->assign('data', grn_strip_tags($G_INPUT['data']));
            $t->assign('html', $G_INPUT['data']);
        } else {
            $t->assign('data', cb_at($G_INPUT, 'data'));
            $t->assign('html', null);
        }
    }
} else {
    if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') != 0) {
        $file_info = grn_init_attached_file(isset($target_name) ? $target_name
                                                                  . $tmp_key
            : cb_get_pagename() . $tmp_key, null, false, 'memo');
    } else {
        $file_info = grn_get_attached_file_info(isset($target_name)
            ? $target_name . $tmp_key : cb_get_pagename() . $tmp_key, 'memo');

        $t->assign('title', cb_at($G_INPUT, 'title'));
        $t->assign('pdid', cb_at($G_INPUT, 'pdid'));

        if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
            require_once('grn/controller.csp');
            $t->assign('data', grn_strip_tags($G_INPUT['data']));
            $t->assign('html', $G_INPUT['data']);
        } else {
            $t->assign('data', cb_at($G_INPUT, 'data'));
            $t->assign('html', null);
        }
    }
}

//generate upload ticket
include('grn/_upload_prepend.csp');

$t->assign('attach_files', $file_info);

$folder = null;
$folder_id = null;

if (array_key_exists('did', $G_INPUT) && strlen($G_INPUT['did']) > 0
    && $G_INPUT['did'] > 0
) {
    $folder_id = $G_INPUT['did'];

    if ( ! ($folder =& $logic->getFolder($login, $folder_id))) {
        require_once('memo/error_code.csp');
        cb_throw_error(E_GRN_MEMO_FOLDER_NOT_FOUND);
    }

    if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') != 0) {
        // 位置メニューの初期値を設定

        $val = $t->get_template_vars('pdid');
        if ( ! $val) {
            $t->assign('pdid', $folder_id);
        }
    }
}

if (is_object($folder)) {
    $folder_for_view = grn_memo_folder_view($folder);
    $folder_for_view['path'] = grn_memo_folder_path($folder);
    $t->assign('folder', $folder_for_view);
}

$t->assign('folder_id', $folder_id);

$folders = $logic->getRootFolders($login);

$t->assign('folder_menu', grn_memo_folder_select_menu($folders));

if ( ! isset($utility) || ! is_a($utility, 'GRN_Memo_ControllerUtil')) {
    $utility = new GRN_Memo_ControllerUtil(isset($target_name) ? $target_name
        : cb_get_pagename());
}

$config = $utility->getConfigValues($login, true);

$t->assign('config', $config);
$t->assign('total_size', $logic->getFileSize($login, null));


