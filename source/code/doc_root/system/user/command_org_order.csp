<?php

$logic = &_grn_get_privilege_logic();
$is_admin = $logic->isAdmin();

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    $org_id = @ $G_INPUT['oid'];
    $child_org_ids = @ $G_INPUT['child_ids'];

    if (is_array($child_org_ids) && 0 < count($child_org_ids)) {
        global $G_container_base;
        /** @var GRN_Uum $uum */
        $uum =& $G_container_base->getInstance('uum');

        if (0 == strlen($org_id)) {
            if ( ! $is_admin) {
                cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
            }

            $children = $uum->getRootGroups();
        } else {
            $children = $uum->getChildGroups($org_id);
        }

        if (count($child_org_ids) != count($children)) {
            cb_throw_error(E_GRN_GROUP_NOT_FOUND);
        }

        $order_list = [];
        foreach ($child_org_ids as $list_index => $child_org_id) {
            if ( ! array_key_exists($child_org_id, $children)) {
                cb_throw_error(E_GRN_GROUP_NOT_FOUND);
            }

            $properties = ['list_index' => $list_index];
            $order_list[$child_org_id] = $properties;
        }
        $uum->setGroupOrder($org_id, $order_list);
        foreach ($child_org_ids as $list_index => $child_org_id) {
            $uum->execInspection('group', 'order', [
                'pgid'       => $org_id,
                'gid'        => $child_org_id,
                'list_index' => $list_index
            ]);
        }
    }

    _grn_rebuild_tree();

    cb_redirect('system/user/org_list', ['oid' => $org_id]);
}


