<?php

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

$org_id = array_key_exists('oid', $G_INPUT) ? $G_INPUT['oid'] : null;
$poid = @$G_INPUT['poid'];

$logic = &_grn_get_privilege_logic();

global $G_container_base;
/** @var GRN_Uum $uum */
$uum =& $G_container_base->getInstance('uum');

$group = &$uum->getGroup($org_id);
if ( ! $group) {
    cb_throw_error(E_GRN_GROUP_NOT_FOUND);
}
$logged_in_user = $uum->getLoginUser();
if ( ! $logic->isTransferable($logged_in_user, $group)) {
    cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
}

require_once('grn/org_privilege.csp');
$privilege_logic = GRN_OrganizationPrivilegeLogic::getInstance();

$t->assign('node', ['id' => $org_id, 'name' => $group->get('name')]);

$item_type = @ $G_INPUT['itype'];
$item_tid = @ $G_INPUT['itid'];
if ( ! $item_type || ! $item_tid) {
    cb_throw_error(E_GRN_PREVILEGE_NOT_SELECT_TARGETS);
}

require_once('grn/uum_util.csp');
$uum_util = GRN_UumUtil::getInstance();
$dynamic_roles = $uum_util->listDynamicRoles();

$item = null;

switch ($item_type) {
    case 'user':
        if (($target = &$uum->getUser($item_tid))) {
            $item = $privilege_logic->getPrivilege($group, $target, $item_type);

        }
        break;

    case 'group':
        if (($target = &$uum->getGroup($item_tid))) {
            $item = $privilege_logic->getPrivilege($group, $target, $item_type);
        }
        break;

    case 'static_role':
        if (($target = &$uum->getStaticRole($item_tid))) {
            $item = $privilege_logic->getPrivilege($group, $target, $item_type);
        }
        break;

    case 'dynamic_role':
        if (array_key_exists($item_tid, $dynamic_roles)) {
            $item = $privilege_logic->getPrivilege($group, $item_tid,
                $item_type);
        }
        break;
}

if (is_null($item)) {
    cb_throw_error(E_GRN_PREVILEGE_TARGET_NOT_FOUND);
}

$t->assign('item', [
    'tid'          => $item_tid,
    'type'         => $item_type,
    'transferable' => $item->get('transferable')
]);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => 'system/user/org_list',
            'name' => grn_get_page_display_name('system/user/org_list'),
            'oid'  => $org_id
        ],
        [
            'page' => 'system/user/org_privilege_list',
            'name' => grn_get_page_display_name('system/user/org_privilege_list'),
            'oid'  => $org_id,
            'poid' => $poid
        ],
        [
            'page' => '',
            'name' => $page_title
        ]
    ]
);

$t->assign('poid', $poid);

$t->display(cb_get_pagename() . ".tpl");


