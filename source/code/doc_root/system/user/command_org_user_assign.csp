<?php

$logic = &_grn_get_privilege_logic();

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    /** @var GRN_Uum $uum */
    $uum =& $G_container_base->getInstance('uum');

    $org_id = @ $G_INPUT['oid'];
    if (0 == strlen($org_id)) {
        assert('FALSE');
    }

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();

    $session_name = 'grn.system.org_user_assign';
    $session =& $session_manager->getSession($session_name);

    $user_ids = $session->get('user_ids');
    if (is_array($user_ids) && 0 < count($user_ids)) {
        switch ($org_id) {
            case -2:
                $login =& $uum->getLoginUser();
                // ログインユーザーとAdministratorは除外する
                unset($user_ids[$login->getOID()]);
                unset($user_ids[GRN_UUM_ADMINISTRATION_USER]);
                foreach (array_keys($user_ids) as $user_id) {
                    $uum->deactivateUser($user_id);
                }
                break;
            case -1:
                foreach (array_keys($user_ids) as $user_id) {
                    $uum->setUserGroups($user_id, []);
                }
                break;
            default:
                $users = $uum->getGroupUsers($org_id);

                foreach (array_keys($user_ids) as $uid) {
                    $users[$uid] = 1;
                }

                $uum->setGroupUsers($org_id, array_keys($users));
                $uum->execInspection('group', 'assign', [
                    'gid'  => $org_id,
                    'uids' => implode(',', array_keys($users))
                ]);
                break;
        }
    }

    cb_redirect('system/user/org_list', ['oid' => $org_id]);
}
