<?php

//-- instantiate smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$logic = &_grn_get_privilege_logic();
$is_admin = $logic->isAdmin();

// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
// register the form you want to validate
SmartyValidate::register_form(cb_get_pagename(), true);

/** @var GRN_Uum $uum */
$uum =& $G_container_base->getInstance('uum');
require_once('grn/uum_util.csp');
$uum_util = GRN_UumUtil::getInstance();
$user = $uum->getLoginUser();

// organization id
$org_id = @ $G_INPUT['oid'];
if ( ! $org_id) {
    // (ルート)というのは存在しないので、ここにきちゃいかん。
    cb_throw_error(E_GRN_GROUP_NOT_FOUND);
}

require_once('grn/org_util.csp');

//--organization informaiton
$org_row =& grn_get_org_row($org_id);
$org =& grn_get_org_info($org_row, true, false);

//--modifing parent id
$parent_oid = @ $G_INPUT['poid'];

$parent_row =& grn_get_org_row($parent_oid);
if ( ! is_null($parent_row) && ! $logic->isPrivileged($user, $parent_row)) {
    cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
}

if ($is_admin) {
    $parent =& grn_get_org_info($parent_row);
    $parent['ancestors'] =& grn_get_org_ancestors($parent_row);
    $parent['parent'] =& grn_get_org_parent($parent_row);
    $parent['children'] =& grn_get_org_children($parent_oid, true);
    $parent['child_count'] = count($parent['children']);
} else {
    $root_groups =& $logic->getRootGroupsWithAuthority($user);
    $parent =& grn_get_org_info($parent_row);
    $ancestors =& grn_get_org_ancestors($parent_row);
    $hits = 0;
    foreach ($ancestors as $ancestor) {
        if (array_key_exists($ancestor['oid'], $root_groups)) {
            break;
        }
        $hits++;
    }
    $parent['ancestors'] = array_slice($ancestors, $hits);
    if (array_key_exists($parent_oid, $root_groups)) {
        $parent['parent'] = null;
    } else {
        $parent['parent'] =& grn_get_org_parent($parent_row);
    }
    if ( ! $parent_oid) {
        $children = [];
        foreach ($root_groups as $key => $group) {
            $child = [
                'oid'  => $group->getOID(),
                'name' => $group->get('name')
            ];
            $children[$key] = $child;
        }
        $parent['children'] =& $children;
        unset($children);
    } else {
        $parent['children'] =& grn_get_org_children($parent_oid, true);
    }
    $parent['child_count'] = count($parent['children']);
}

$t->assign('org_id', $org_id);
$t->assign('org', $org);
$t->assign('poid', $parent_oid);
$t->assign('parent', $parent);
$t->assign('is_admin', $is_admin);

$form_name = cb_get_pagename();
$t->assign('form_name', $form_name);
$t->assign('dir_name', 'system/user');

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('title_of_grn_title', $page_title);

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'org_list'          => ['oid' => $org_id],
    'org_view'          => ['oid' => $org_id],
    'org_parent_modify' => null,
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('system/user/', $page_infos);
$t->assign('site_position', $site_position);

//-- show page
$t->display(cb_get_pagename() . '.tpl');


