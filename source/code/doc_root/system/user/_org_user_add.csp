<?php

if ( ! isset($session_name)) {
    $session_name = 'grn.system.org_user_belong';
}

if ( ! isset($org_ids) || ! is_array($org_ids)) {
    // 未選択
    $org_ids = [];
} else {
    // 設定済みの組織
    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $current_org = [];
    foreach ($org_ids as $group_id) {
        $group = $uum->getGroupInfo($group_id);
        if ( ! $group) {
            continue;
        }
        $path = $uum_util->getGroupPathString($group_id,
            ' > ');
        $current_org[$group_id] = [
            'name'     => $group['col_name'],
            'fullpath' => $path
        ];
        $org_ids[$group_id] = $group_id;
    }
    if (count($current_org) > 0) {
        $t->assign('current_org', $current_org);
    }
}
require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session = $session_manager->getSession($session_name);
$session->set('org_ids', $org_ids);

if (isset($primary_group) && is_numeric($primary_group) && $primary_group > 0) {
    $t->assign('primary_group', $primary_group);
}

$t->assign('session', $session_name);

require_once("fw/i18n/locale.csp");
if ( ! isset($selected_locale)) {
    $selected_locale = CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED;
}

$locales = CB_LocaleManager::getLocales();
$locales_param = [];
$locales_param[] = [
    "value"    => CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED,
    "label"    => cb_msg("fw.common", CB_LocaleManager::getBlank()),
    "selected" => $selected_locale
                  == CB_UserLocaleSetting::$LOCALE_IS_NOT_RELATED
];
foreach ($locales as $locale) {
    $locales_param[] = [
        "value"    => $locale->getId(),
        "label"    => $locale->getLocalName(),
        "selected" => $selected_locale == $locale->getId()
    ];
}
$t->assign("locales_param", $locales_param);

if ( ! isset($selected_language)) {
    $selected_language = CB_LocaleManager::getDefaultLanguage();
}
$languages_param = [];
foreach (CB_LanguageManager::getAvailableLanguages() as $language_code) {
    $languages_param[] = [
        "value"    => $language_code,
        "label"    => CB_LanguageManager::getLanguageName($language_code),
        "selected" => $selected_language == $language_code,
    ];
}
$t->assign("languages_param", $languages_param);

require_once('fw/i18n/base.csp');
$selected_base = isset($selected_base) ? $selected_base : null;
$bases_param = CB_BaseManager::getBaseSelectParams($selected_base);
$t->assign('bases_param', $bases_param);

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'org_list'     => ['oid' => $org_id, 'sf' => 1],
    'org_user_add' => null,
];
require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil();
$site_position = $controller_util->makeSitePosition('system/user/',
    $page_infos);
$t->assign('site_position', $site_position);


