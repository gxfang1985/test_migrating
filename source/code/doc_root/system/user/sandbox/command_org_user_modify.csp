<?php

use grn\system\sandbox\GRN_ControllerUtilSandbox;
use grn\system\sandbox\GRN_Uum_Sandbox;
use grn\system\sandbox\GRN_UumUtil_Sandbox;
use grn\system\sandbox\UserOperationService;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once("fw/i18n/locale.csp");

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    // GET/POSTされたパラメータを取得する
    $user_id = '';
    $org_id = '';
    global $G_INPUT;
    if (array_key_exists('uid', $G_INPUT)) {
        $user_id = $G_INPUT['uid'];
        unset($G_INPUT['uid']);
    }
    if (0 == strlen($user_id)) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }

    $org_id = @ $G_INPUT['poid'];

    $org_ids = null;
    $org = null;
    if (array_key_exists('oid', $G_INPUT) && is_array($G_INPUT['oid'])
        && count($G_INPUT['oid']) > 0
    ) {
        foreach ($G_INPUT['oid'] as $key) {
            $org_ids[$key] = $key;
        }
        unset($G_INPUT['oid']);
    } else {
        // 組織の指定がない場合は、すべて未所属
        $org_ids = [];
    }

    // 詳細を表示するユーザーを取得する
    $uum = GRN_Uum_Sandbox::getInstance();
    $user = $uum->getUser($user_id);
    if ( ! is_object($user) || ! is_a($user, 'CB_User')) {
        cb_throw_error(E_GRN_USER_NOT_FOUND);
    }
    $user_id = $user->getOID();

    // 組み込み項目を取得する
    $controller_util = new GRN_ControllerUtilSandbox();
    $builtin_items = $controller_util->listBuiltinItems($user);

    // カスタマイズ項目を取得する
    $extended_items = $controller_util->listExtendedItems($user);

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'system/user/sandbox/org_user_modify';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $userDiffData = [];

        // 表示優先度
        $userDiffData['position'] = cb_at($G_INPUT, 'position');

        // 使用の停止
        if (array_key_exists('invalid', $G_INPUT)) {
            $invalid = $G_INPUT['invalid'] === '1';
            unset($G_INPUT['invalid']);
        } else {
            $invalid = false;
        }
        $userDiffData['valid'] = ! $invalid;

        // 組織へ追加
        $userService = new UserOperationService();
        if (is_array($org_ids) && count($org_ids) > 0) {
            $groups = $uum->getGroupInfoList($org_ids);
            if (is_array($groups) && count($groups) > 0) {
                $userService->setUserGroups($user_id, array_keys($groups));
            }
        } else {
            $userService->setUserGroups($user_id, []);
        }

        // 優先する組織
        $relationId = false;
        if (array_key_exists('primary_org', $G_INPUT)
            && is_numeric($G_INPUT['primary_org'])
            && $G_INPUT['primary_org'] > 0
        ) {
            // 優先する組織として有効な値がPOSTされるケースは、所属しているかどうかのバリデーションを行なう
            $relationId = $userService->getUserGroupRelationId($user_id,
                $G_INPUT['primary_org']);
            if ( ! $relationId) {
                require_once('grn/error_code.csp');
                cb_throw_error(E_GRN_INVALID_PRIMARY_GROUP);
            }
        }
        $userDiffData["primary"] = $relationId;

        // Set a base of the user
        $base_id = cb_at($G_INPUT, 'base');
        if ($base_id) {
            require_once('fw/i18n/base.csp');
            $base = CB_Base::select($base_id);
            if (is_null($base)) {
                require_once('fw/error_code.csp');
                cb_throw_error(E_COMMON_BASE_WAS_NOT_FOUND);
            }
        } else {
            $base_id = null;
        }
        $userDiffData["base"] = $base_id;

        $userService->updateUserDiff($user_id, $userDiffData);

        SmartyValidate::unregister_form($target_name);

        $uum->execInspection('sandbox-user', 'modify', [
            'uid'     => $user->getOID(),
            'name'    => $user->get('display_name'),
            'account' => $user->get('foreign_key')
        ]);

        cb_redirect('system/user/sandbox/org_user_view',
            ['oid' => $org_id, 'uid' => $user_id]);
    } else {
        foreach (array_keys($builtin_items) as $item_id) {
            if (array_key_exists($item_id, $G_INPUT)) {
                if ('file' != $builtin_items[$item_id]['type']) {
                    $builtin_items[$item_id]['value'] = $G_INPUT[$item_id];
                }
            }
        }
        foreach (array_keys($extended_items) as $item_id) {
            $extended_items_key = 'extended_' . $item_id;
            if (array_key_exists($extended_items_key, $G_INPUT)) {
                if ('file' != $extended_items[$item_id]['type']) {
                    $extended_items[$item_id]['value']
                        = $G_INPUT[$extended_items_key];
                }
            }
        }

        $t->setPageInfo($target_name);
        $t->assign('org_id', $org_id);
        $t->assign('user_id', $user_id);
        $user_info = [];
        if (array_key_exists('password', $G_INPUT)) {
            $user_info['password'] = $G_INPUT['password'];
        }
        if (array_key_exists('retype', $G_INPUT)) {
            $user_info['retype'] = $G_INPUT['retype'];
        }
        if (array_key_exists('position', $G_INPUT)) {
            $user_info['position'] = $G_INPUT['position'];
        }
        if (array_key_exists('invalid', $G_INPUT)) {
            $user_info['valid'] = ($G_INPUT['invalid'] === '1') ? 0 : 1;
        } else {
            $user_info['valid'] = 1;
        }

        // 設定している組織
        $groups = $uum->getGroupInfoList($org_ids);
        $uum_util = GRN_UumUtil_Sandbox::getInstance();
        if (is_array($groups) && count($groups) > 0) {
            if (array_key_exists('primary_org', $G_INPUT)) {
                $primary_group_id = $G_INPUT['primary_org'];
            } else {
                $primary_group_id = -1;
            }

            $group_options = [];
            $groups_info = [];
            foreach ($groups as $key => $group) {
                $groups_info[$key] = [];
                $groups_info[$key]['oid'] = $key;
                $groups_info[$key]['name'] = $group['col_name'];
                $groups_info[$key]['path'] = str_replace('>', ' > ',
                    $uum_util->getGroupPathString($key));

                $selected = ($key == $primary_group_id);
                $group_options[] = [
                    'value'    => $key,
                    'label'    => $groups_info[$key]['name'] . ' （' .
                                  $groups_info[$key]['path'] . '）',
                    'selected' => $selected,
                ];
            }
            $user_info['group_options'] = $group_options;
            $user_info['groups'] = $groups_info;
        }

        $session_name = 'grn.system.user_modify.org_user_belong';
        $t->assign('builtin_items', $builtin_items);
        $t->assign('extended_items', $extended_items);
        $t->assign('user', $user_info);
        $t->assign('is_super', ($user_id == GRN_UUM_ADMINISTRATION_USER));

        //Locale Information
        if (isset($G_INPUT["locale"])) {
            $selected_locale = @$G_INPUT["locale"];
        }

        $selected_base = isset($G_INPUT['base']) ? $G_INPUT['base'] : null;

        include('_org_user_modify.csp');

        $t->display($target_name . '.tpl');
    }
}


