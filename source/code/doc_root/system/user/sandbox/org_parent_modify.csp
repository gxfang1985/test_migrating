<?php

//-- instantiate smarty object
use grn\system\sandbox\SandboxConstants;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

// SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
// register the form you want to validate
SmartyValidate::register_form(cb_get_pagename(), true);

// organization id
global $G_INPUT;
$org_id = @ $G_INPUT['oid'];
if ( ! $org_id) {
    // (ルート)というのは存在しないので、ここにきちゃいかん。
    cb_throw_error(E_GRN_GROUP_NOT_FOUND);
}

require_once('grn/org_util.csp');

//--organization informaiton
$org_row =& grn_get_org_row($org_id, SandboxConstants::SANDBOX_MODE);
$org =& grn_get_org_info($org_row, true, false);

//--modifing parent id
$parent_oid = @ $G_INPUT['poid'];

$parent_row =& grn_get_org_row($parent_oid, SandboxConstants::SANDBOX_MODE);

$parent =& grn_get_org_info($parent_row);
$parent['ancestors'] =& grn_get_org_ancestors($parent_row);
$parent['parent'] =& grn_get_org_parent($parent_row, false,
    SandboxConstants::SANDBOX_MODE);
$parent['children'] =& grn_get_org_children($parent_oid, true,
    SandboxConstants::SANDBOX_MODE);
$parent['child_count'] = count($parent['children']);

$t->assign('org_id', $org_id);
$t->assign('org', $org);
$t->assign('poid', $parent_oid);
$t->assign('parent', $parent);
$t->assign('is_admin', true);

$form_name = cb_get_pagename();
$t->assign('form_name', $form_name);
$t->assign('dir_name', 'system/user/sandbox');
$t->assign('is_sandbox_page', true);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('title_of_grn_title',
    cb_msg("grn.system.user", "org_parent_modify"));

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'index'             => [],
    'org_list'          => ['oid' => $org_id],
    'org_view'          => ['oid' => $org_id],
    'org_parent_modify' => null,
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('system/user/sandbox/', $page_infos);
$t->assign('site_position', $site_position);

//-- show page
$t->display('system/user/org_parent_modify.tpl');


