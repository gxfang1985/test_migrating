<?php

use grn\system\sandbox\SandboxConstants;
use grn\system\sandbox\GRN_Uum_Sandbox;
use grn\system\sandbox\GRN_Uum_SearchSandbox;

/** @var GRN_Uum $uum */

include("_org_user.csp");


// 前へ&次へ
$navi_params = [];

if (array_key_exists('search_text', $G_INPUT)
    && strlen($G_INPUT['search_text']) > 0
) {
    // 検索
    require_once('grn/org_util_search.csp');

    $search_text = $G_INPUT['search_text'];
    $condition = grn_get_user_info_search_condition($org_id, $search_text,
        true);

    if ($org_id != -3) {
        $user_ids = grn_search_user_ids($org_id, $condition,
            SandboxConstants::SANDBOX_MODE);

        $index = array_search($user_id, $user_ids);
        $prev_index = $index - 1;
        if (0 <= $prev_index) {
            $prev_uid = $user_ids[$prev_index];
            $navi_params['previous'] = [];
            $navi_params['previous']['page']
                = cb_get_pagename();
            $navi_params['previous']['page_params'] = [];
            $navi_params['previous']['page_params']['oid'] = $org_id;
            $navi_params['previous']['page_params']['uid'] = $prev_uid;
            $navi_params['previous']['page_params']['search_text']
                = $search_text;
        }
        $next_index = $index + 1;
        if ((count($user_ids) - 1) >= $next_index) {
            $next_uid = $user_ids[$next_index];
            $navi_params['next'] = [];
            $navi_params['next']['page']
                = cb_get_pagename();
            $navi_params['next']['page_params'] = [];
            $navi_params['next']['page_params']['oid'] = $org_id;
            $navi_params['next']['page_params']['uid'] = $next_uid;
            $navi_params['next']['page_params']['search_text'] = $search_text;
        }
    } else {
        // updated users

        // get updated users
        require_once('fw/string_util.csp');
        if (strlen(cb_trim($condition)) > 0) {
            $uum_search = new GRN_Uum_SearchSandbox();
            $result = $uum_search->getUpdatedUserInfos(0, -1, $condition);
            $user_count = $result['total_count'];
            $users = $result['user_list'];
        } else {
            $user_count = 0;
            $users = [];
        }

        $keys = array_keys($users);
        $index = array_search($user_id, $keys);
        $prev_index = $index - 1;
        if (0 <= $prev_index) {
            $prev_uid = $keys[$prev_index];
            $navi_params['previous'] = [];
            $navi_params['previous']['page']
                = cb_get_pagename();
            $navi_params['previous']['page_params'] = [];
            $navi_params['previous']['page_params']['oid'] = $org_id;
            $navi_params['previous']['page_params']['uid'] = $prev_uid;
            $navi_params['previous']['page_params']['search_text']
                = $search_text;
        }
        $next_index = $index + 1;
        if (($user_count - 1) >= $next_index) {
            $next_uid = $keys[$next_index];
            $navi_params['next'] = [];
            $navi_params['next']['page']
                = cb_get_pagename();
            $navi_params['next']['page_params'] = [];
            $navi_params['next']['page_params']['oid'] = $org_id;
            $navi_params['next']['page_params']['uid'] = $next_uid;
            $navi_params['next']['page_params']['search_text'] = $search_text;
        }
    }
} else {
    if ($org_id != -3) {
        require_once('grn/org_util.csp');
        $user_ids = grn_get_user_ids($org_id, SandboxConstants::SANDBOX_MODE);

        $index = array_search($user_id, $user_ids);
        $prev_index = $index - 1;
        if (0 <= $prev_index) {
            $prev_uid = $user_ids[$prev_index];
            $navi_params['previous'] = [];
            $navi_params['previous']['page'] = cb_get_pagename();
            $navi_params['previous']['page_params'] = [];
            $navi_params['previous']['page_params']['oid'] = $org_id;
            $navi_params['previous']['page_params']['uid'] = $prev_uid;
        }
        $next_index = $index + 1;
        if ((count($user_ids) - 1) >= $next_index) {
            $next_uid = $user_ids[$next_index];
            $navi_params['next'] = [];
            $navi_params['next']['page'] = cb_get_pagename();
            $navi_params['next']['page_params'] = [];
            $navi_params['next']['page_params']['oid'] = $org_id;
            $navi_params['next']['page_params']['uid'] = $next_uid;
        }
    } else {
        // get updated users
        $uum_sandbox = GRN_Uum_Sandbox::getInstance();
        $result = $uum_sandbox->getUpdatedUsers(-1, 0);
        $user_count = $result['total_count'];
        $users = $result['user_list'];

        $keys = array_keys($users);
        $index = array_search($user_id, $keys);
        $prev_index = $index - 1;
        if (0 <= $prev_index) {
            $prev_uid = $keys[$prev_index];
            $navi_params['previous'] = [];
            $navi_params['previous']['page'] = cb_get_pagename();
            $navi_params['previous']['page_params'] = [];
            $navi_params['previous']['page_params']['oid'] = $org_id;
            $navi_params['previous']['page_params']['uid'] = $prev_uid;
        }
        $next_index = $index + 1;
        if (($user_count - 1) >= $next_index) {
            $next_uid = $keys[$next_index];
            $navi_params['next'] = [];
            $navi_params['next']['page'] = cb_get_pagename();
            $navi_params['next']['page_params'] = [];
            $navi_params['next']['page_params']['oid'] = $org_id;
            $navi_params['next']['page_params']['uid'] = $next_uid;
        }
    }
}

// Smartyに前後ナビのパラメータを割り当てる
$t->assign('navi_params', $navi_params);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$page_infos = [
    'index'         => [],
    'org_list'      => ['oid' => $org_id, 'sf' => 1],
    'org_user_view' => null,
];

if (array_key_exists('search_text', $G_INPUT)
    && strlen($G_INPUT['search_text']) > 0
) {
    $page_infos['org_list']['search_text'] = $G_INPUT['search_text'];
}

$site_position = $controller_util->makeSitePosition('system/user/sandbox/',
    $page_infos);
$t->assign('site_position', $site_position);

$t->assign('license_deny', $license_deny);

$t->assign('dir_name', 'system/user/sandbox');
$t->assign('is_sandbox_page', true);

//-- show page
$t->display("system/user/org_user_view.tpl");

