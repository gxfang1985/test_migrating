<?php

use \grn\system\sandbox\GRN_Uum_Sandbox;
use grn\system\sandbox\SandboxConstants;

// Smarty をインスタンス化
require_once('grn/smarty.csp');
require_once('grn/error_code.csp');
$t = new GRN_Smarty;

// gorup id
global $G_INPUT;
$org_id = cb_at($G_INPUT, 'oid');

require_once('grn/org_util.csp');

//--group informaiton
//$org_row =& grn_get_org_row( $org_id );
$uum = GRN_Uum_Sandbox::getInstance();
$org_row = $uum->getGroup($G_INPUT['oid']);
if ( ! $org_row) {
    cb_throw_error(E_GRN_GROUP_NOT_FOUND);
}
$org =& grn_get_org_info($org_row, false, true);

//--child group
$org['children'] =& grn_get_org_children($org_id, false,
    SandboxConstants::SANDBOX_MODE);

if ($org_id) {
    //--user count
    $org['user_count'] = $uum->getGroupUserCount($org_id);

    //--parent group
    $org['parent'] =& grn_get_org_parent($org_row, true,
        SandboxConstants::SANDBOX_MODE);

    // forward/backward navigation
    $parent = $org_row->getParent();

    if ($parent) {
        $siblings = $uum->getChildGroups($parent->getOID());
    } else {
        $siblings = $uum->getRootGroups();
    }

    $keys = array_keys($siblings);
    $index = array_search($org_id, $keys);
    $navi_params = [];
    $prev_index = $index - 1;
    if (0 <= $prev_index) {
        $sibling =& $siblings[$keys[$prev_index]];
        $navi_params['previous'] = [];
        $navi_params['previous']['page'] = cb_get_pagename();
        $navi_params['previous']['page_params'] = [];
        $navi_params['previous']['page_params']['oid'] = $sibling->getOID();
    }

    $next_index = $index + 1;
    if ((count($siblings) - 1) >= $next_index) {
        $sibling =& $siblings[$keys[$next_index]];
        $navi_params['next'] = [];
        $navi_params['next']['page'] = cb_get_pagename();
        $navi_params['next']['page_params'] = [];
        $navi_params['next']['page_params']['oid'] = $sibling->getOID();
    }

    // Smartyに前後ナビのパラメータを割り当てる
    $t->assign('navi_params', $navi_params);
}

$t->assign('org_id', $org_id);
$t->assign('org', $org);
$t->assign('is_root', ! $org_id);
$t->assign('privileged_root', false);

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'index'    => [],
    'org_list' => ['oid' => $org_id, 'sf' => 1],
    'org_view' => null,
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('system/user/sandbox/', $page_infos);
$t->assign('site_position', $site_position);

$t->assign('dir_name', 'system/user/sandbox');
$t->assign('is_sandbox_page', true);

$t->display('system/user/org_view.tpl');


