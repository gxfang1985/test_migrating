<?php

use grn\system\sandbox\GRN_Uum_Sandbox;
use grn\system\sandbox\GroupOperationService;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    global $G_INPUT;
    $org_id = cb_at($G_INPUT, 'oid');
    if (0 == strlen($org_id)) {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }

    $uum = GRN_Uum_Sandbox::getInstance();

    $parent_org_id = null;
    if ($org = $uum->getGroup($org_id)) {
        if ($parent_org = $org->get('parent')) {
            $parent_org_id = $parent_org->getOID();
        }
        $service = new GroupOperationService;
        $service->removeGroup($org_id);
        $uum->execInspection('sandbox-group', 'delete', [
            'gid'         => $org->getOID(),
            'name'        => $org->get('name'),
            'foreign_key' => $org->get('foreign_key')
        ]);
    } else {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }

    grn\system\sandbox\_grn_rebuild_tree();
    cb_redirect('system/user/sandbox/org_list', ['oid' => $parent_org_id]);
}

