<?php

use grn\system\sandbox\GroupOperationService;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    //get language values
    require_once('fw/i18n.csp');
    $inputLocalNameArray
        = getMultiLanguageText(GRN_UUM_ELEMENT_NAME_ORGANIZATION, $G_INPUT);

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'system/user/sandbox/org_add';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $foreignKey = @ $G_INPUT['code'];
        $memo = @ $G_INPUT['memo'];
        $parentOrgId = @$G_INPUT['oid'];


        //Add Group
        $service = new GroupOperationService();
        $service->addGroup($inputLocalNameArray, $foreignKey, $memo,
            $parentOrgId);


        SmartyValidate::unregister_form($target_name);

        grn\system\sandbox\_grn_rebuild_tree($parentOrgId);

        cb_redirect('system/user/sandbox/org_list', ['oid' => $parentOrgId]);
    } else {
        $t->setPageInfo($target_name);

        include('_org_add.csp');

        $t->assign('form_name', $target_name);
        $t->assign('dir_name', 'system/user/sandbox');
        $t->assign('is_sandbox_page', true);

        $assign_input_values = [
            'code' => $G_INPUT['code'] ?? null,
            'memo' => $G_INPUT['memo'] ?? null
        ];
        $t->assign($assign_input_values);

        $multiLanguageInfoArray = [];
        $multiLanguageInfoArray['element_name']
            = GRN_UUM_ELEMENT_NAME_ORGANIZATION;
        $multiLanguageInfoArray['values'] = $inputLocalNameArray;
        $t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);

        $t->display('system/user/org_add.tpl');
    }

}
