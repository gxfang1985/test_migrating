<?php
/** @var GRN_Uum $uum */

include("_org_user.csp");


// 前へ&次へ
$navi_params = [];

if (array_key_exists('search_text', $G_INPUT)
    && strlen($G_INPUT['search_text']) > 0
) {
    // 検索
    require_once('grn/org_util_search.csp');

    $search_text = $G_INPUT['search_text'];
    $condition = grn_get_user_info_search_condition($org_id, $search_text,
        true);

    /* system/user/_prepend.csp */
    $logic = &_grn_get_privilege_logic();
    $is_admin = $logic->isAdmin();

    $ids = $org_id;
    if ( ! $is_admin && ! $org_id) {
        $logged_in_user = $uum->getLoginUser();
        $ids
            = array_keys($logic->getDescendantsWithAuthority($logged_in_user));
    }

    $user_ids = grn_search_user_ids($org_id, $condition);

    $index = array_search($user_id, $user_ids);
    $prev_index = $index - 1;
    if (0 <= $prev_index) {
        $prev_uid = $user_ids[$prev_index];
        $navi_params['previous'] = [];
        $navi_params['previous']['page']
            = cb_get_pagename();
        $navi_params['previous']['page_params'] = [];
        $navi_params['previous']['page_params']['oid'] = $org_id;
        $navi_params['previous']['page_params']['uid'] = $prev_uid;
        $navi_params['previous']['page_params']['search_text'] = $search_text;
    }
    $next_index = $index + 1;
    if ((count($user_ids) - 1) >= $next_index) {
        $next_uid = $user_ids[$next_index];
        $navi_params['next'] = [];
        $navi_params['next']['page'] = cb_get_pagename();
        $navi_params['next']['page_params'] = [];
        $navi_params['next']['page_params']['oid'] = $org_id;
        $navi_params['next']['page_params']['uid'] = $next_uid;
        $navi_params['next']['page_params']['search_text'] = $search_text;
    }
} else {
    require_once('grn/org_util.csp');
    $user_ids = grn_get_user_ids($org_id);

    $index = array_search($user_id, $user_ids);
    $prev_index = $index - 1;
    if (0 <= $prev_index) {
        $prev_uid = $user_ids[$prev_index];
        $navi_params['previous'] = [];
        $navi_params['previous']['page'] = cb_get_pagename();
        $navi_params['previous']['page_params'] = [];
        $navi_params['previous']['page_params']['oid'] = $org_id;
        $navi_params['previous']['page_params']['uid'] = $prev_uid;
    }
    $next_index = $index + 1;
    if ((count($user_ids) - 1) >= $next_index) {
        $next_uid = $user_ids[$next_index];
        $navi_params['next'] = [];
        $navi_params['next']['page'] = cb_get_pagename();
        $navi_params['next']['page_params'] = [];
        $navi_params['next']['page_params']['oid'] = $org_id;
        $navi_params['next']['page_params']['uid'] = $next_uid;
    }
}

// Smartyに前後ナビのパラメータを割り当てる
$t->assign('navi_params', $navi_params);

// !! tentative
//$user_for_view['previous_id'] = -1;
//$user_for_view['next_id'] = -1;

//-- page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$page_infos = [
    'org_list'      => ['oid' => $org_id, 'sf' => 1],
    'org_user_view' => null,
];

if (array_key_exists('search_text', $G_INPUT)
    && strlen($G_INPUT['search_text']) > 0
) {
    $page_infos['org_list']['search_text'] = $G_INPUT['search_text'];
}

$site_position = $controller_util->makeSitePosition('system/user/',
    $page_infos);
$t->assign('site_position', $site_position);

$t->assign('license_deny', $license_deny);
$t->assign('dir_name', 'system/user');

//-- show page
$t->display(cb_get_pagename() . ".tpl");

