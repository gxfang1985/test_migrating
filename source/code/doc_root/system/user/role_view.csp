<?php

//-- instantiate smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL parameters
$role_id = @ $G_INPUT['role_id'];

//-- prepare uum
/** @var GRN_Uum $uum */
$uum = $G_container_base->getInstance('uum');

$the_role = $uum->getStaticRole($role_id);
if ( ! $the_role) {
    cb_throw_error(E_GRN_ROLE_NOT_FOUND);
}
$the_role_name = $the_role->get('foreign_key');
$the_role_creation_info = $uum->getStaticRoleCreationInfo($role_id);
$creator = $the_role_creation_info->get('creator');
$creator_id = null;
if ($creator) {
    $creator_id = $creator->getOID();
}
$modifier = $the_role_creation_info->get('modifier');
$modifier_id = null;
if ($modifier) {
    $modifier_id = $modifier->getOID();
}
$the_role_users = $uum->getRoleUsers($role_id);
if (is_array($the_role_users)) {
    $the_number_of_users = count($the_role_users);
} else {
    $the_number_of_users = 0;
}


$t->assign('role', [
        'rid'             => $role_id,
        'title'           => $the_role_name,
        'memo'            => $the_role->get('description'),
        'number_of_users' => $the_number_of_users,
        'ctime'           => $the_role_creation_info->get('ctime'),
        'creator_uid'     => $creator_id,
        'creator_name'    => $the_role_creation_info->get('creator_name'),
        'mtime'           => $the_role_creation_info->get('mtime'),
        'modifier_uid'    => $modifier_id,
        'modifier_name'   => $the_role_creation_info->get('modifier_name'),
        // under implementation
        'previous_id'     => $role_id - 1,
        'next_id'         => $role_id + 1
    ]
);

// 前後ナビのパラメータを生成する
$roles = $uum->listStaticRoles();
$keys = array_keys($roles);
$key_id = array_search($role_id, $keys);

$navi_params_for_view = [];

$previous_id = $key_id - 1;
if (0 <= $previous_id) {
    $role =& $roles[$keys[$previous_id]];
    $navi_params_for_view['previous'] = [];
    $navi_params_for_view['previous']['page']
        = cb_get_pagename();
    $navi_params_for_view['previous']['page_params'] = [];
    $navi_params_for_view['previous']['page_params']['role_id']
        = $role->getOID();
}

$next_id = $key_id + 1;
if ((count($roles) - 1) >= $next_id) {
    $role =& $roles[$keys[$next_id]];
    $navi_params_for_view['next'] = [];
    $navi_params_for_view['next']['page'] = cb_get_pagename();
    $navi_params_for_view['next']['page_params'] = [];
    $navi_params_for_view['next']['page_params']['role_id'] = $role->getOID();
}

// Smartyに前後ナビのパラメータを割り当てる
$t->assign('navi_params', $navi_params_for_view);

//--------------------------------------------------------------

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

require_once('grn/controller.csp');

// Smartyにサイトポジションを割り当てる
$page_infos = [
    'role_list' => ['role_id' => $role_id, 'sf' => 1],
    'role_view' => null
];
$util = new GRN_ControllerUtil();
$site_position = $util->makeSitePosition('system/user/', $page_infos);
$t->assign('site_position', $site_position);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


