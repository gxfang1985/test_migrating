<?php

$logic = &_grn_get_privilege_logic();

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    $org_id = array_key_exists('oid', $G_INPUT) ? $G_INPUT['oid'] : null;

    global $G_container_base;
    /** @var GRN_Uum $uum */
    $uum =& $G_container_base->getInstance('uum');

    $group = &$uum->getGroup($org_id);
    if ( ! $group) {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }

    $logged_in_user = $uum->getLoginUser();
    if ( ! $logic->isTransferable($logged_in_user, $group)) {
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }

    require_once('grn/org_privilege.csp');

    $logic->deletePrivileges($group);

    $logged_in_user = $uum->getLoginUser();
    if ( ! $logic->isTransferable($logged_in_user, $group)) {
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }

    // 監査ログ
    require_once('grn/logger.csp');
    $lm = CB_LoggerManager::getInstance();
    $l =& $lm->getLogger('grn.common');

    $params = ['gid' => $group->getOID(), 'name' => $group->get('name')];
    $l->noticeEx('delete_all', 'privilege', $params);

    cb_redirect('system/user/org_privilege_list', $G_INPUT);
}
