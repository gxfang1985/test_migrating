<?php

$logic = _grn_get_privilege_logic();

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    $org_id = @ $G_INPUT['oid'];
    if (0 == strlen($org_id)) {
        cb_throw_error(E_GRN_GROUP_NOT_FOUND);
    }

    global $G_container_base;
    /** @var GRN_Uum $uum */
    $uum = $G_container_base->getInstance('uum');

    $parent_org_id = null;
    if ($org = $uum->getGroup($org_id)) {
        if ($parent_org = $org->get('parent')) {
            $parent_org_id = $parent_org->getOID();
        }

        $uum->removeGroup($org_id);
        $uum->execInspection('group', 'delete', [
            'gid'         => $org->getOID(),
            'name'        => $org->get('name'),
            'foreign_key' => $org->get('foreign_key')
        ]);
    }
    $logged_in_user = $uum->getLoginUser();
    if ( ! $logic->isAdmin() && ! $logic->hasPrivilege($logged_in_user)) {
        cb_redirect('system/common_list');
    } else {
        _grn_rebuild_tree();

        cb_redirect('system/user/org_list', ['oid' => $parent_org_id]);
    }
}

