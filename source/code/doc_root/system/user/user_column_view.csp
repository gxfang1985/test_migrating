<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- get parameters from URL paramters
$column_id = @ $G_INPUT['clid'];

global $G_container_base;
/** @var GRN_Uum $uum */
$uum =& $G_container_base->getInstance('uum');

require_once('grn/sso.csp');
$sso_service = GRN_SSO_Service::getInstance();
$ssos = $sso_service->getSSOMethodList('uum');
$sso_name = cb_msg('grn.common', 'default_sso');

//ケータイのライセンスがは場合は表示しない
$cellular_licensed = _isApplicationLicensed('cellular');
$t->assign('cellular_licensed', $cellular_licensed);

$column_for_view = [];
if (is_numeric($column_id)) {
    $column =& $uum->getItem($column_id);
    if ( ! $column) {
        cb_throw_error(E_GRN_USER_COLUMN_NOT_FOUND);
    }

    if (is_array($ssos) && array_key_exists($column->get('sso'), $ssos)) {
        $sso_name = $ssos[$column->get('sso')]->get('display_name');
    }
    $column_for_view
        = [
        'clid'         => $column_id,
        'is_extension' => true,
        'display_name' => $column->get('display_name'),
        'id'           => $column->get('id'),
        'use'          => $column->get('use'),
        'necessary'    => $column->get('necessary'),
        'not_modify'   => $column->get('not_modify'),
        'show'         => $column->get('show'),
        'display'      => $column->get('display'),
        'search'       => $column->get('search'),
        'sso_name'     => $sso_name,
        'type'         => $uum->getRealItemTypeName($column->get('type'))
    ];
    if ($cellular_licensed) {
        $column_for_view['cellular'] = $column->get('cellular');
    }

    unset($column);
} else {
    //$properties =& $uum->getDefaultItemProperty( $column_id );
    $properties = _getDefaultItemProperty($column_id);

    if (is_array($ssos) && array_key_exists($properties['sso'], $ssos)) {
        $sso_name = $ssos[$properties['sso']]->get('display_name');
    }

    $properties['clid'] = $column_id;
    $properties['is_extension'] = false;
    $properties['display_name'] = $uum->getRealDefaultItemName($column_id);
    $properties['id'] = $column_id;
    $properties['sso_name'] = $sso_name;
    $column_for_view = $properties;
}
// process attendee
if ($column_id === 'attendee') {
    $column_for_view['show'] = 1;
    $column_for_view['display'] = 1;
}
$t->assign('column', $column_for_view);

//-- set page title and site position
$page_list = 'system/user/user_column_list';

// use $page_title for both page title and site position
$page_title = grn_get_current_page_display_name();

// set page title
$t->assign('page_title', $page_title);

// set site position
$t->assign(
    'site_position',
    [
        ['page' => $page_list, 'name' => grn_get_page_display_name($page_list)],
        ['page' => "", 'name' => $page_title],
    ]
);

//-- show page
$t->display(cb_get_pagename() . '.tpl');


