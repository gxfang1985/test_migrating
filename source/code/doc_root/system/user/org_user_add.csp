<?php

// Smarty をインスタンス化
require_once("grn/smarty.csp");
$t = new GRN_Smarty;


global $G_container_base;
/** @var GRN_Uum $uum */
$uum = $G_container_base->getInstance('uum');

$logic = _grn_get_privilege_logic();

$org_id = '-1';
if (array_key_exists('oid', $G_INPUT) && is_numeric($G_INPUT['oid'])
    && $G_INPUT['oid'] > 0
) {
    $org_id = $G_INPUT['oid'];
}

require_once('SmartyValidate.class.php');
if (SmartyValidate::is_registered_form(cb_get_pagename())) {
    SmartyValidate::unregister_form(cb_get_pagename());
}
SmartyValidate::connect($t);
SmartyValidate::register_form(cb_get_pagename());

// 組み込み項目を取得する
$item_values = $uum->getDefaultItemProperties();
$builtin_items = [];
foreach ($item_values as $id => $properties) {
    if ( ! $properties['use']) {
        continue;
    }
    $builtin_items[$id]['display_name'] = $uum->getRealDefaultItemName($id);
    $builtin_items[$id]['necessary'] = $properties['necessary'];
    $builtin_items[$id]['type'] = $properties['type'];
    $builtin_items[$id]['use'] = $properties['use'];
}

// カスタマイズ項目を取得する
$extended = $uum->listItems();
$extended_items = [];
$oids = array_keys($extended);
foreach ($oids as $oid) {
    $row =& $extended[$oid];
    $id = $row->get('id');
    $extended_items[$id]['display_name'] = $row->get('display_name');
    $extended_items[$id]['necessary'] = $row->get('necessary');
    $extended_items[$id]['type'] = $row->get('type');
    $extended_items[$id]['use'] = $row->get('use');
    $extended_items[$id]['extended'] = 1;
}

$t->assign('org_id', $org_id);
$user_info = [];
if (-2 == $org_id) {
    $user_info['valid'] = 0;
} else {
    $user_info['valid'] = 1;
}

$session_name = 'grn.system.user_add.org_user_belong';
$org_ids = [];
// 初期に表示する組織
if (($group = $uum->getGroupInfo($org_id))) {
    require_once('grn/uum_util.csp');
    $uum_util = GRN_UumUtil::getInstance();
    $org_ids[$org_id] = $org_id;
    $path = str_replace('>', ' > ',
        $uum_util->getGroupPathString($org_id));
    $t->assign('org_fullpath', $path);
}
$t->assign('session', $session_name);

$t->assign('user', $user_info);
$t->assign('builtin_items', $builtin_items);
$t->assign('extended_items', $extended_items);

include('_org_user_add.csp');

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


