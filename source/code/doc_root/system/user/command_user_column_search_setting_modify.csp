<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    global $G_container_base;
    /** @var GRN_Uum $uum */
    $uum =& $G_container_base->getInstance('uum');

    $extension_columns = @ $G_INPUT['extension_columns'];
    $extension_items = $uum->listItems();
    $keys = array_keys($extension_items);
    foreach ($keys as $key) {
        $input = [];
        if (is_array($extension_columns)
            && array_key_exists($key, $extension_columns)
        ) {
            $input =& $extension_columns[$key];
        }

        $prop = [];
        $item =& $extension_items[$key];
        $prop['search'] = $item->get('search');
        $prop_keys = array_keys($prop);
        foreach ($prop_keys as $prop_key) {
            if (array_key_exists($prop_key, $input)) {
                $prop[$prop_key] = 1;
            } else {
                $prop[$prop_key] = 0;
            }
        }

        $column =& $uum->getItem($key);
        if ( ! $column) {
            cb_throw_error(E_GRN_USER_COLUMN_NOT_FOUND);
        }
        $uum->setItemProperties($key, $prop);

        // logging
        $temp = ['cid' => $key];
        $temp['display_name'] = $column->get('display_name');
        $temp['type'] = $column->get('type');
        $temp['id'] = $column->get('id');
        $prop = array_merge($temp, $prop);
        $uum->execInspection('user_item', 'modify', $prop);
    }

    cb_redirect('system/common_list', ['id' => 'user']);
}
