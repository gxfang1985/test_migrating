<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    // register the target_form, or you get an error if you go back to the previous page by using
    // your browser 'back' button
    $target_name = 'system/user/role_add';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        // -------- 
        $parameter_conversion_map = [
            'title' => 'foreign_key',
            'memo'  => 'description'
        ];
        $properties = [];
        foreach ($parameter_conversion_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }
        /** @var GRN_Uum $uum */
        $uum = $G_container_base->getInstance('uum');
        $the_role = $uum->addStaticRole($properties);
        // --------
        $uum->execInspection('role', 'create', [
            'rid'         => $the_role->getOID(),
            'foreign_key' => $the_role->get('foreign_key'),
            'memo'        => $the_role->get('description')
        ]);

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        cb_redirect('system/user/role_list',
            ['role_id' => $the_role->getOID()]);
    } else {

        $t->setPageInfo($target_name);

        //-- if error, show the source form
        // include sharing code
        include('_role_add.csp');
        $t->assign('memo', $G_INPUT['memo'] ?? null);
        $t->display($target_name . '.tpl');
    }

}
