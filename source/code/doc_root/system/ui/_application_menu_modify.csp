<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- menu id
$id = $G_INPUT['id'];
$t->assign('id', $id);

require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
$menu = $manager->getDefaultApplicationMenu();
$current_item = $menu->getMenu($id);

if ( ! $current_item) {
    cb_throw_error(E_GRN_MENU_NOT_FOUND);
}

require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
$apps = $app_locator->getActiveApplicationIds();

$menu = [];
foreach ($apps as $app_id) {
    if ( ! $app_locator->isLicensed($app_id)
         || ! $app_locator->isActive($app_id)
    ) {
        continue;
    }

    $function_name = $app_locator->getDefaultName($app_id);
    $app_name = $app_locator->getName($app_id);

    $menu[$app_id] = [
        'app_id' => $app_id,
        'name'   => $function_name,
        'items'  => []
    ];
    $link_menu = $manager->getLinkMenu($app_id);

    foreach ($link_menu as $item) {
        $page = $app_id . '/' . $item['location'];
        $menu[$app_id]['items'][] = [
            'value' => $page,
            'label' =>
                grn_get_page_display_name($page,
                    [
                        'app_name'         => $app_name,
                        'application_name' => $app_name
                    ])
        ];
    }

    if (count($menu[$app_id]['items']) <= 0) {
        unset($menu[$app_id]);
    }
}


require_once('system/resources.csp');
require_once('system/SystemUiLogic.csp');
$sysUiLogic = new SystemUiLogic();
$localLanguageValues
    = $sysUiLogic->createMultiLanguageValuesArrayWithApplicationMenu($id);
$multiLanguageInfoArray = [];
$emptyMultiLanguageInfoArray = [];

if ( ! is_null($current_item['app_id'])) {
    $t->assign('url', '');
    $t->assign('link', $current_item['location']);
    $t->assign('icon_url', '');
    $t->assign('icon_file_info', null);

    $multiLanguageInfoArray['element_name']
        = GRN_SYSTEM_ELEMENT_NAME_APPLICATION_MENU_LINK;
    $multiLanguageInfoArray['values'] = $localLanguageValues;

    $emptyMultiLanguageInfoArray['element_name']
        = GRN_SYSTEM_ELEMENT_NAME_APPLICATION_MENU_URL;
    $emptyMultiLanguageInfoArray['values'] = null;

    $t->assign('multiLanguageInfoArrayWithLink', $multiLanguageInfoArray);
    $t->assign('multiLanguageInfoArrayWithUrl', $emptyMultiLanguageInfoArray);
} else {
    $icon_url = '';
    $icon_url = $current_item['icon_location'];

    $t->assign('url', $current_item['location']);
    $t->assign('link', '');
    $t->assign('icon_url', $icon_url);
    $t->assign('icon_file_info', $current_item['icon_file_info']);

    $multiLanguageInfoArray['element_name']
        = GRN_SYSTEM_ELEMENT_NAME_APPLICATION_MENU_URL;
    $multiLanguageInfoArray['values'] = $localLanguageValues;

    $emptyMultiLanguageInfoArray['element_name']
        = GRN_SYSTEM_ELEMENT_NAME_APPLICATION_MENU_LINK;
    $emptyMultiLanguageInfoArray['values'] = null;

    $t->assign('multiLanguageInfoArrayWithLink', $emptyMultiLanguageInfoArray);
    $t->assign('multiLanguageInfoArrayWithUrl', $multiLanguageInfoArray);
}

$t->assign('menu', $menu);

if ( ! is_null($current_item['app_id'])) {
    $t->assign('menu_type', 'app');
} else {
    $t->assign('menu_type', 'url');
}

$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$t->assign(
    'site_position',
    [
        [
            'page' => 'system/ui/application_menu_list',
            'name' => grn_get_page_display_name('system/ui/application_menu_list')
        ],
        [
            'page' => 'system/ui/application_menu_view',
            'name' => grn_get_page_display_name('system/ui/application_menu_view'),
            'id'   => $id
        ],
        ['page' => "", 'name' => $page_title],
    ]
);


