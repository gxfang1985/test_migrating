<?php

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    $eid = @ $G_INPUT['eid'];
    if ( ! is_array($eid)) {
        cb_redirect('system/privilege/application_admin_list', $G_INPUT);
    }

    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();

    $users = $system->getApplicationUsers();
    $groups = $system->getApplicationGroups();
    $roles = $system->getApplicationRoles();

    $user_ids = [];
    $group_ids = [];
    $role_ids = [];

    // OIDリスト→SIDリスト作成
    foreach ($eid as $id) {
        $temp = explode(':', $id);
        if (strcmp($temp[0], 'user') === 0) {
            if (array_key_exists($temp[1], $users)) {
                array_push($user_ids, $users[$temp[1]]['sid']);
            }
        } elseif (strcmp($temp[0], 'group') === 0) {
            if (array_key_exists($temp[1], $groups)) {
                array_push($group_ids, $groups[$temp[1]]['sid']);
            }
        } elseif (strcmp($temp[0], 'static_role') === 0
                  || strcmp($temp[0], 'dynamic_role') === 0
        ) {
            if (is_numeric($temp[1])) {
                if (array_key_exists($temp[1], $roles)) {
                    array_push($role_ids, $roles[$temp[1]]['sid']);
                }
            } else {
                $role_ids[] = $temp[1];
            }
        }
    }

    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();
    $system->removeApplicationUsers($user_ids);
    $system->removeApplicationGroups($group_ids);
    $system->removeApplicationRoles($role_ids);

    $params = $G_INPUT;
    unset($params['eid']);
    cb_redirect('system/privilege/application_admin_list', $params);
}

