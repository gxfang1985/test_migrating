<?php

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//SmartyValidate should be initialized when an input form is there.
require('SmartyValidate.class.php');
SmartyValidate::connect($t);
SmartyValidate::register_form('system/authentication/authenticate_method_add1',
    true);

//Get Authenticate Driver List
require_once('grn/authentication.csp');
$authentication_service = GRN_Authentication_Service::getInstance();
$authenticate_driver_list
    = $authentication_service->getAuthenticateDriverList();

//Create Parameter Translation Map for Authenticate Driver
$translation_map_authenticate_driver = [
    'title' => 'name',                 //Driver Name
    'type'  => 'type',                 //Driver Type
];

//Do Parameter Translation for Authenticate Driver
$loader = new GRN_Authentication_Application_Loader();
foreach (array_keys($authenticate_driver_list) as $authenticate_driver_index) {
    //Skip Default and Special Authentication Driver
    $drivet_type
        = $authenticate_driver_list[$authenticate_driver_index]->getType();
    $driver_type_elements = explode('.', $drivet_type);
    if ($loader->loadHook($driver_type_elements[4])
        || $driver_type_elements[4] === 'default'
    ) {
        continue;
    }

    $authenticate_driver_for_view = [];
    foreach ($translation_map_authenticate_driver as $view_name => $model_name) {
        switch ($model_name) {
            case 'name':
                $authenticate_driver_for_view[$view_name]
                    = $authenticate_driver_list[$authenticate_driver_index]->getName();
                break;
            case 'type':
                $authenticate_driver_for_view[$view_name]
                    = $authenticate_driver_list[$authenticate_driver_index]->getType();
                break;
            default:
                break;
        }
    }

    //Add Authenticate Driver List for View
    if ($authenticate_driver_for_view['type']
        == 'grn.common.authentication.authenticate.environment'
    ) {
        array_unshift($authenticate_driver_list_for_view,
            $authenticate_driver_for_view);
    } else {
        $authenticate_driver_list_for_view[] = $authenticate_driver_for_view;
    }
}

//Create Selected Authenticate Driver Type
if (array_key_exists('sf', $G_INPUT)) {
    //Get Driver Type from Session
    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession(GRN_AUTH_MODULE_ID);
    $selected_authenticate_driver_type
        =& $session->get('authenticate_driver_type');
} else {
    //Clear Session Driver Type
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession(GRN_AUTH_MODULE_ID);
    $session->set('authenticate_driver_type', null);

    //Get Current Driver Type
    $current_driver = current($authenticate_driver_list_for_view);
    $selected_authenticate_driver_type = $current_driver['type'];
}

//Assign Authenticate Driver Display Infomation
$t->assign('authenticate_driver', $authenticate_driver_list_for_view);
$t->assign('selected_authenticate_driver_type',
    $selected_authenticate_driver_type);

//-- set page title and site position

// set page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "system/authentication/authenticate_method_list",
            'name' => grn_get_page_display_name('system/authentication/authenticate_method_list')
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


