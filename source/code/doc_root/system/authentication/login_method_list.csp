<?php

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Set Base ID for Site Position
$t->assign('id', 'authentication');

//Clear Element ID List
$eid_list = [];
require_once('grn/authentication.csp');
$session_manager = CB_SessionManager::getInstance();
$session =& $session_manager->getSession(GRN_AUTH_MODULE_ID);
$session->set('eid_list', $eid_list);

//Get Login Method List
require_once("grn/authentication.csp");
$authentication_service = GRN_Authentication_Service::getInstance();
$login_method_list =& $authentication_service->getLoginMethodList();
if ( ! $login_method_list) {
    $login_method_list = [];
}

// Create Parameter Translation Map
$translation_map = [
    'lmid'         => '_id',
    'display_name' => 'display_name',
    'is_active'    => 'is_active',
    'is_default'   => 'is_default',
];

//Exclude Special Authentication
$view_id_list = [];
$loader = new GRN_Authentication_Application_Loader();
foreach (array_keys($login_method_list) as $login_method_id) {
    $drivet_type = $login_method_list[$login_method_id]->get('driver_type');
    $driver_type_elements = explode('.', $drivet_type);
    if ( ! $loader->loadHook($driver_type_elements[4])) {
        $view_id_list[] = $login_method_id;
    }
}

// Do Parameter Translation
$index = 0;
$login_method_list_for_view = [];
foreach ($view_id_list as $login_method_id) {
    $login_method_for_view = [];
    foreach ($translation_map as $view_name => $model_name) {
        switch ($view_name) {
            case 'lmid':
                $login_method_for_view[$view_name] = $login_method_id;
                break;
            case 'is_default':
                $driver_type
                    = $login_method_list[$login_method_id]->get('driver_type');
                if ($driver_type === GRN_AUTH_LOGIN_DEFAULT) {
                    $login_method_for_view[$view_name] = 1;
                } else {
                    $login_method_for_view[$view_name] = 0;
                }
                break;
            case 'display_name':
                $display_name
                    = $login_method_list[$login_method_id]->get(GRN_AUTH_PROPERTY_DISPLAY_NAME);
                if ( ! $display_name) {
                    $driver_type
                        = $login_method_list[$login_method_id]->get(GRN_AUTH_PROPERTY_DRIVER_TYPE);
                    $driver_type_elements = explode('.', $driver_type);
                    $display_name = cb_msg($driver_type,
                        $driver_type_elements[4]);
                }
                $login_method_for_view[$view_name] = $display_name;
                break;
            default:
                $login_method_for_view[$view_name]
                    = $login_method_list[$login_method_id]->get($model_name);
                break;
        }
    }
    $index++;
    $login_method_list_for_view[$index] = $login_method_for_view;
}

// Assign Get Parameter
$login_method_id = @ $G_INPUT['lmid'];
$t->assign('login_method_id', $login_method_id);

// Assign Portlet Display Infomation
// Assign Login Method List
$t->assign('login_method', $login_method_list_for_view);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


