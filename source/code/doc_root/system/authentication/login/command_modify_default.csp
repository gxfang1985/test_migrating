<?php

// Check HTTP-POST Method
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'system/authentication/login/modify_default';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        // Create Parameter Translation Map
        $translation_map = [
            'lmid'         => '_lmid',               //Login Method ID
            'rmid'         => '_rmid',               //Repository Method ID
            'display_name' => 'display_name',       //Login Method Display Name
            'use_multi'    => 'use_multi',
            'multi_rmid'   => 'multi_rmid',
        ];

        // Do Parameter Translation
        $properties = [];
        foreach ($translation_map as $view_name => $model_name) {
            $properties[$model_name] = @ $G_INPUT[$view_name];
        }

        $authentication_service = GRN_Authentication_Service::getInstance();

        ///Get Login Method
        $login_method
            = $authentication_service->getLoginMethod($properties['_lmid']);

        //Check Driver
        \grn\system\authentication\AvailableDriverChecker::getInstanceOfLoginMethod()
                                                         ->canModify(
                                                             $login_method->getDriverType(),
                                                             GRN_AUTH_LOGIN_DEFAULT
                                                         );

        //Update and Get Repository
        $child_repository_ids = [];
        foreach ($properties['multi_rmid'] as $child_repository_id => $selected) {
            if ($selected) {
                $child_repository_ids[] = $child_repository_id;
            }
        }
        $new_repository_method
            = $authentication_service->updateLoginMethodRepository(
            $login_method->getRepositoryMethod(), $properties['use_multi'],
            $properties['_rmid'], $child_repository_ids
        );

        //Create Infomation Login Driver Settings
        $driver_settings = [];

        //Modify Login Method
        $authentication_service->modifyLoginMethod(
            $properties['_lmid'], $properties['display_name'], $driver_settings,
            $new_repository_method
        );

        foreach (GRN_AUTH_LOGIN_DRIVERS_DEPENDING_ON_DEFAULT as $driver_type) {
            global $G_container_base;
            $dbconn = $G_container_base->getInstance('dbconn');
            $query
                = sprintf("SELECT _id FROM tab_grn_authentication_login_authenticate WHERE col_driver_type='%s';",
                $driver_type);
            $ret = $dbconn->query($query);
            if ($ret) {
                $row = $dbconn->fetch_assoc($ret);
                $util_api_properties = $properties;
                $util_api_properties['driver_type'] = $driver_type;
                // update
                if ($row) {
                    $util_api_login_method_id = $row['_id'];
                    $authentication_service->modifyLoginMethod(
                        $util_api_login_method_id,
                        $util_api_properties['display_name'], $driver_settings,
                        $new_repository_method
                    );
                } else // insert
                {
                    $authentication_service->addLoginMethod($util_api_properties['display_name'],
                        $util_api_properties['driver_type'],
                        $driver_settings, $new_repository_method);
                }
            }
        }


        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        //Switch Redirect Page
        cb_redirect('system/authentication/login_method_view',
            ['lmid' => $properties['_lmid']]);
    } else {
        //Assign Template Name
        $t->setPageInfo('../_login_method_modify');

        //include sharing codes with command_*
        include('../_login_method_modify.csp');

        //Rewrite Authenticate Method Infomation
        $login_method_for_view = &$t->get_template_vars('login_method');
        $login_method_for_view['amid'] = @ $G_INPUT['amid'];
        $login_method_for_view['display_name'] = @ $G_INPUT['display_name'];
        $login_method_for_view['rmid'] = @ $G_INPUT['rmid'];
        $login_method_for_view['use_multi'] = @ $G_INPUT['use_multi'];
        $login_method_for_view['multi_rmid'] = @ $G_INPUT['multi_rmid'];

        $login_method_for_view['_input_repository_settings'] = [
            'use_multi'  => cb_at($G_INPUT, 'use_multi'),
            'multi_rmid' => cb_at($G_INPUT, 'multi_rmid')
        ];


        //Display Previous Page
        $t->display('system/authentication/login_method_modify.tpl');
    }
}


