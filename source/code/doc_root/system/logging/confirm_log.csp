<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

require_once('fw/i18n.csp');

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$admin_page = 'system/logging/admin';

$year = date('Y');

global $G_INPUT;

$search_text = '';
if (array_key_exists('search_text', $G_INPUT)
    && ! empty($G_INPUT['search_text'])
) {

    $search_text = $G_INPUT['search_text'];
    if (strlen($search_text) != 4) {
        $year = null;
    } else {
        $search_text = intval($search_text);
        if ($search_text < 2000 || $search_text > 2037) {
            $year = null;
        } else {
            $year = $search_text;
        }
    }
}

$files = [];

require_once('grn/logger.csp');
$logic = GRN_LoggingLogic::getInstance();

if ($year) {
    global $G_container_base;
    $dbconn =& $G_container_base->getInstance('dbconn');
    //$start_time = mktime(0,0,0,1,1,$year);
    //$end_time = mktime(0,0,0,12,31,$year);
    //$query = "SELECT _id , col_ctime, col_title_sort_key FROM tab_grn_logging_file WHERE col_ctime >= ".$start_time." AND col_ctime <= ".$end_time;
    $query
        = "SELECT _id , col_ctime, col_title_sort_key FROM tab_grn_logging_file WHERE col_title_sort_key like 'log"
          . $year . "%' ORDER BY col_ctime DESC";

    $ret = $dbconn->query($query);

    while ($row = $dbconn->fetch_row($ret)) {
        $ts = new CB_TimeStamp();
        $ts->unix_ts = $row[1];
        $files[] = ['id' => $row[0], 'title' => $row[2], 'date' => $ts];
    }
    $t->assign('search_text', $year);
} else {
    $t->assign('validation_errors',
        [cb_msg('grn.system.logging', 'error_year')]);
    $t->assign('search_text', $search_text);
}

$delete_info_multi = [
    'title'        => grn_get_page_display_name('system/logging/delete_multi_files'),
    'page'         => 'system/logging/delete_multi_files.tpl',
    'no_confirm'   => false,
    'data'         => ['delete_numbers' => true],
    'handler'      => ['btn_delete_multi'],
    'multi_target' => 'eid[]',
    'form_target'  => 'system/logging/confirm_log',
];
$t->assign('delete_info_multi', $delete_info_multi);


$t->assign('files', $files);
$t->assign('site_position',
    [
        [
            'page' => $admin_page,
            'name' => grn_get_page_display_name($admin_page)
        ],
        ['page' => '', 'name' => $page_title]
    ]);

$t->display(cb_get_pagename() . ".tpl");
