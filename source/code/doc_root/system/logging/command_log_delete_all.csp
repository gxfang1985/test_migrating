<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('grn/logger.csp');
    $logic = GRN_LoggingLogic::getInstance();

    $query = CB_LoggerQuery::getInstance();

    $priority = $G_INPUT['priority'];
    $category = '';
    $category_condition = null;
    if (array_key_exists('category', $G_INPUT) && $G_INPUT['category']) {
        $category = $G_INPUT['category'];
        $logic->checkCategoryInput($category);
        $log_category = $logic->getLogCategory($category);
        $category_condition = $query->queryf("col_category = '@S'",
            $log_category);
    }

    // まず一番昔のTimestampを取得する
    if ( ! is_null($category_condition)) {
        $query->setCondition($category_condition);
    }

    $result = $query->select('MIN( col_timestamp ) AS min_timestamp');
    $result = $query->fetch_assoc($result);
    if (is_array($result)
        && array_key_exists('min_timestamp', $result)
        && ! is_null($result['min_timestamp'])
    ) {
        $min_timestamp = $result['min_timestamp'];
        $term = new CB_Date;
        $term->parse(@$G_INPUT['date']);
        $term_ts = cb_date_convert2timestamp($term->format());

        $ts = new CB_TimeStamp;
        $ts->unix_ts = $min_timestamp;
        $min_ts = new CB_TimeStampEx($ts);

        // Timestampの時間を切り捨てる
        $min_date = $min_ts->getDate();
        $min_ts->unix_ts = cb_date_convert2timestamp($min_date->format());

        // ロックがかかってINSERTができなくなるのを防ぐため、削除クエリを短く分断する。
        // 一番昔のTimestampから指定された日付のTimestampまでインクリメントして1日ずつ削除する。
        while ($term_ts >= $min_ts->unix_ts) {
            $date_condition = "col_timestamp < '" . $min_ts->unix_ts . "'";
            $condition = $date_condition;
            if ( ! is_null($category_condition)) {
                $condition = $category_condition . ' AND ' . $condition;
            }

            $query->setCondition($condition);
            $query->delete();

            $min_date = $min_ts->getDate();
            $min_date->moveDays(1);
            $min_ts->unix_ts = cb_date_convert2timestamp($min_date->format());
        }
    }

    cb_redirect('system/logging/admin', [
        'priority' => $priority,
        'category' => $category
    ]);
}


