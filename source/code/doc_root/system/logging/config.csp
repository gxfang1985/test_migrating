<?php

require_once('grn/logger.csp');
require_once('grn/smarty.csp');
$t = new GRN_Smarty();
$logic = GRN_LoggingLogic::getInstance();
$session = $logic->getSession();
$psp = $session->get('psp');

$priority = @$G_INPUT['priority'];
$category = @$G_INPUT['category'];
$logic->checkCategoryInput($category);
$priorities = [];
$log_category = $logic->getLogCategory($category);
$categories = $logic->getLogCategoryList($category);

global $G_container_base;
$config = $G_container_base->getInstance('logger_config');

$priorities = [
    GRN_LOGGER_THRESHOLD_ERROR   => [
        'code'    => CB_LOGGER_ERROR,
        'targets' => $config->getError($log_category)
    ],
    GRN_LOGGER_THRESHOLD_WARNING => [
        'code'    => CB_LOGGER_WARNING,
        'targets' => $config->getWarning($log_category)
    ],
    GRN_LOGGER_THRESHOLD_NOTICE  => [
        'code'    => CB_LOGGER_NOTICE,
        'targets' => $config->getNotice($log_category)
    ],
    GRN_LOGGER_THRESHOLD_INFO    => [
        'code'    => CB_LOGGER_INFO,
        'targets' => $config->getInfo($log_category)
    ],
];

foreach ($priorities as $key => $value) {
    $log =& $priorities[$key];
    $log['name'] = $logic->getThresholdName($value['code']);

    if (is_array($value['targets'])) {
        $db = in_array(CB_LOGGER_DB, $value['targets']);
        $syslog = in_array(CB_LOGGER_SYSLOG, $value['targets']);
    } else {
        $db = false;
        $syslog = false;
    }
    $on = true;
    if ($db && $syslog) {
        $log['both'] = true;
    } elseif ($db) {
        $log['dblogging'] = true;
    } elseif ($syslog) {
        $log['syslog'] = true;
    } else {
        $on = false;
        $log['both'] = true;
    }
    $log['on'] = $on;
}
$t->assign('priorities', $priorities);
$t->assign('categories', $categories);
$t->assign('priority', $priority);
$t->assign('category', $category);

$admin_page = 'system/logging/admin';
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position 
$t->assign(
    'site_position', [
        [
            'page'     => $admin_page,
            'name'     => grn_get_page_display_name($admin_page),
            'priority' => $priority,
            'category' => $category,
            'sp'       => $psp
        ],
        ['page' => "", 'name' => $page_title]
    ]
);


$t->display(cb_get_pagename() . '.tpl');

