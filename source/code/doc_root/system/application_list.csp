<?php

//-- instantiate smarty object
require_once('grn/smarty.csp');
$t = new GRN_Smarty();

global $G_license_mode;
$license_deny = true;

if ($G_license_mode === GRN_LICENSE_SUCCESS) {
    $license_deny = false;

    //-- application setup menu
    $selected_app = @ $G_INPUT['app_id'];

    require_once('grn/application_util.csp');
    $util = GRN_ApplicationUtil::getInstance();
    $menu = $util->getSystemConfigMenu();

    require_once('grn/application.csp');
    $locator = GRN_ApplicationLocator::instance();
    $applications = [];
    foreach (array_keys($menu) as $app_id) {
        $app = $locator->getInstance($app_id);
        if ( ! $app->isLicensed()) {
            continue;
        }
        if ($app) {
            $applications[$app_id] = $app->getDefaultName();
        }
    }
    $t->assign('applications', $applications);

    // page title
    // サイトポジション
    $page_title = '';
    if ($selected_app && array_key_exists($selected_app, $menu)) {
        $positions[] = [
            'page' => 'system/application_list',
            'name' => grn_get_current_page_display_name()
        ];

        $app = $locator->getInstance($selected_app);
        $page_title = null;
        if ($app) {
            $page_title = $app->getDefaultName();
        }
    } else {
        $page_title = grn_get_current_page_display_name();
    }
    $positions[] = ['page' => '', 'name' => $page_title];
    $t->assign('page_title', $page_title);
    $t->assign('site_position', $positions);

    require_once('fw/i18n.csp'); // for cb_msg
    if (array_key_exists($selected_app, $menu)) {
        $t->assign('selected_app', $selected_app);

        $app_menu = $menu[$selected_app];
        $config_categories = array_keys($app_menu);
        $t->assign('categories', $config_categories);

        $config_data = [];
        foreach ($app_menu as $category_name => $category) {
            $app_name = $locator->getDefaultName($selected_app);

            $category_items = [];
            foreach ($category as $item_config) {
                assert('array_key_exists("page", $item_config)');
                $item = [];
                $item['page'] = $item_config['page'];
                $item['name'] = grn_get_page_display_name($item['page']);
                if (array_key_exists('icon', $item_config)) {
                    $item['icon'] = $item_config['icon'];
                } else {
                    $item['icon'] = 'general32';
                }
                $category_items[] = $item;
            }

            $cat_item = [];

            $cat_item['name'] = cb_plain_msg('grn.' . $selected_app,
                $category_name,
                ['application_name' => $app_name]);
            $cat_item['items'] = $category_items;
            $config_data[] = $cat_item;
        }
        $t->assign('config_data', $config_data);
    }
} else {
    $positions[] = [
        'page' => '',
        'name' => grn_get_current_page_display_name()
    ];
    $page_title = grn_get_current_page_display_name();
    $t->assign('page_title', $page_title);
    $t->assign('site_position', $positions);
}

if (defined('ON_SAAS')) {
    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $saas_license_user = $uum->checkSaasLincense();
    $active_count = $uum->getActiveUserCount() - 1;
    if ($saas_license_user < $active_count) {
        $license_deny = true;
        $t->assign('applications', []);
    }
}

$t->assign('license_deny', $license_deny);

//-- show page
$t->display('system/application_list.tpl');
