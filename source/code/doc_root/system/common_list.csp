<?php

//-- instantiate smarty object
require_once('grn/smarty.csp');
$t = new GRN_Smarty();

$selected_id = null;
if (array_key_exists('id', $G_INPUT)) {
    $selected_id = $G_INPUT['id'];
}

global $G_container_base;

// uum
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

if (defined('ON_SAAS')) {
    $saas_license_over = false;
    $saas_license_user = $uum->checkSaasLincense();
    $active_count = $uum->getActiveUserCount() - 1;
    if ($saas_license_user < $active_count) {
        $saas_license_over = true;
    }
}

// privilege logic
require_once('grn/org_privilege.csp');
$privilege_logic = GRN_OrganizationPrivilegeLogic::getInstance();

// system logic
require_once('grn/system_logic.csp');

$system = GRN_System::getInstance();
$ids = $system->getLogicIds();

$logic_list = [];
$privileged_config = null;

foreach ($ids as $id) {
    if ( ! $system->adminSubSystem($id, $user)) {
        if ($id == 'user') {
            if ( ! $privilege_logic->hasPrivilege($user)) {
                continue;
            } else {
                $privileged_config = [
                    'general' => [
                        [
                            'page' => 'system/user/org_list',
                            'icon' => 'groupadmin32'
                        ],
                        [
                            'page' => 'system/user/org_import_index',
                            'icon' => 'import32'
                        ],
                        [
                            'page' => 'system/user/org_export_index',
                            'icon' => 'export32'
                        ],
                    ],
                ];
            }
        } else {
            continue;
        }
    }

    if (defined('ON_SAAS')) {
        if ('license' === $id) {
            continue;
        }

        if ($saas_license_over && 'user' !== $id) {
            continue;
        }
    }

    $logic = $system->getLogic($id);
    if ($logic->getConfigArray() === false) {
        continue;
    }

    $logic_list[$id] = [
        'id'       => $id,
        'name'     => $logic->getName(),
        'selected' => ($id === $selected_id)
    ];
}
$t->assign('logic_list', $logic_list);
$config_data = [];
if (array_key_exists($selected_id, $logic_list)
    && ($selected_logic
        = $system->getLogic($selected_id))
) {
    // page title
    $page_title = $selected_logic->getName();
    $t->assign('page_title', $page_title);
    // サイトポジション
    $t->assign('site_position', [
        [
            'page' => 'system/common_list',
            'name' => grn_get_page_display_name('system/common_list')
        ],
        ['page' => '', 'name' => $page_title]
    ]);

    $t->assign('selected', $selected_id);
    $config_array = $selected_logic->getConfigArray();
    if ($selected_id == 'user' && ! is_null($privileged_config)) {
        $config_array = $privileged_config;
    }
    if ($config_array) {
        require_once('fw/i18n.csp');
        foreach ($config_array as $cat_key => $items) {
            $category = [];
            $category['name'] = cb_msg('grn.common.system.' . $selected_id,
                $cat_key);
            $item_data = [];
            foreach ($items as $item) {
                $item['name'] = grn_get_page_display_name($item['page']);
                if ( ! array_key_exists('icon', $item)) {
                    $item['icon'] = 'general32';
                }
                $item_data[] = $item;
            }
            $category['items'] = $item_data;
            $config_data[] = $category;
        }
    }
} else {
    // page title
    $page_title = grn_get_current_page_display_name();
    $t->assign('page_title', $page_title);
    // サイトポジション
    $t->assign('site_position', [
        ['page' => '', 'name' => $page_title],
    ]);
}
$t->assign('config_data', $config_data);

//-- show page
$t->display(cb_get_pagename() . '.tpl');


