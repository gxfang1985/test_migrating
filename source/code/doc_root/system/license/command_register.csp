<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty();

    $license = $G_INPUT['key'];

    require_once('grn/license_validator.csp');
    $generator = new GRN_LicenseValidator;

    // ライセンスバリデーション
    if (false === $generator->validate($license)) {
        // クラック対策
        sleep(5);
        // 登録キーの検証に失敗しました。
        cb_throw_error(E_GRN_LICENSE_FAIL_VARIDATION);
    }

    $license_info = $generator->getLicenseInfo();

    require_once('grn/license.csp');
    $lm = GRN_LicenseManager::getInstance();
    $lm->addLicense($license_info);

    // お客様番号の登録
    require_once('grn/customer.csp');
    $customer = GRN_Customer::getInstance();
    $customer->setCustomerId($license_info['customer']);
    cb_redirect('system/license/admin');
}


