<?php

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get SSO Method ID
$sso_method_id = @ $G_INPUT['smid'];

//Get Display SSO Method
require_once('grn/sso.csp');
$sso_service = GRN_SSO_Service::getInstance();
$sso_method =& $sso_service->getSSOMethod($sso_method_id);

//Create Parameter Translation Map
$translation_map = [
    //SSO Method Infomation
    'smid'               => 'smid',                 //SSO Method ID
    'said'               => 'application',          //SSO Application ID
    'display_name'       => 'display_name',         //Display Name
    'driver_type'        => 'driver_type',          //Driver Type
    'driver_settings'    => 'driver_settings',      //Driver Name
    'available_personal' => 'available_personal',   //Available Personal
    'available_window'   => 'available_window',     //Available Window
    'ctime'              => 'ctime',                //Create Time
    'creator_uid'        => 'creator',              //Creator ID
    'creator_name'       => 'creator_name',         //Creator Name
    'mtime'              => 'mtime',                //Modify Time
    'modify_uid'         => 'modifier',             //Modifier ID
    'modify_name'        => 'modifier_name',        //Modifier Name
];

//Do Parameter Translation
$sso_method_for_view = [];
foreach ($translation_map as $view_name => $model_name) {
    switch ($model_name) {
        case 'smid':
            $sso_method_for_view[$view_name] = $sso_method->getOID();
            break;
        case 'application':
            $said = $sso_method->get($model_name);
            $sso_method_for_view[$view_name] = $said;
            if ($said === 'login' || $said === 'uum') {
                $sso_method_for_view[$model_name] = cb_msg('grn.common', $said);
            } else {
                //Get Application Locator for Application Name
                require_once('grn/application.csp');
                $app_locator = GRN_ApplicationLocator::instance();
                $sso_method_for_view[$model_name]
                    = $app_locator->getName($said);
            }
            break;
        case 'driver_settings':
            $driver_settings = $sso_method->get($model_name);
            if ($driver_settings) {
                $driver_settings = cb_unserialize($driver_settings,
                    ["allowed_classes" => false]);
            }
            $sso_method_for_view[$view_name] = $driver_settings;
            break;
        case 'creator':
        case 'modifier':
            $user =& $sso_method->get($model_name);
            $sso_method_for_view[$view_name] = is_null($user) ? null
                : $user->getOID();
            break;
        default:
            $sso_method_for_view[$view_name] = $sso_method->get($model_name);
            break;
    }
}

//Get Application Identifier List
require_once("grn/sso.csp");
$sso_service = GRN_SSO_Service::getInstance();
$app_identifier_list
    = $sso_service->getSSOIdentifierList($sso_method_for_view['said']);

//Assign Display Infomation
$t->assign('sso_method', $sso_method_for_view);
$t->assign('identifier', $app_identifier_list);

//-- set page title and site position

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign(
    'site_position', [
        [
            'page' => "system/sso/sso_method_list",
            'name' => grn_get_page_display_name('system/sso/sso_method_list'),
            'sf'   => 1
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


