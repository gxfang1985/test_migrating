<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $charset = isset($G_INPUT['charset']) ? $G_INPUT['charset'] : null;
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    /// テンポラリのファイルを作成
    $tempdir = cb_tmpdir();
    $temp_filename = tempnam($tempdir, 'base_');

    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    // 項目名の書き出し
    if (isset($G_INPUT['item_name']) && $G_INPUT['item_name']) {
        require_once('fw/i18n.csp');

        $header = [];
        $header[] = cb_msg('grn.system.calendar.export', 'base_name');
        $header[] = cb_msg('grn.system.calendar.export', 'base_code');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_sunday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_monday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_tuesday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_wednesday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_thursday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_friday');
        $header[] = cb_msg('grn.system.calendar.export', 'workday_saturday');
        //GRN2-3190
        $header[] = cb_msg('grn.system.calendar.export', 'calendar_workday');
        $header[] = cb_msg('grn.system.calendar.export', 'calendar_code');
        //GRN2-3190
        $header[] = cb_msg('grn.system.calendar.export', 'work_hours_start1');
        $header[] = cb_msg('grn.system.calendar.export', 'work_hours_end1');
        $header[] = cb_msg('grn.system.calendar.export', 'work_hours_start2');
        $header[] = cb_msg('grn.system.calendar.export', 'work_hours_end2');
        $header[] = cb_msg('grn.system.calendar.export', 'etc');

        $csv->writeLine($header);
    }

    require_once('fw/i18n/base.csp');
    $bases = CB_BaseManager::getBases();
    foreach ($bases as $base) {
        $line = [];
        $line[] = $base->getName();
        $line[] = $base->getCode();
        $line[] = $base->getWorkdaySunday();
        $line[] = $base->getWorkdayMonday();
        $line[] = $base->getWorkdayTuesday();
        $line[] = $base->getWorkdayWednesday();
        $line[] = $base->getWorkdayThursday();
        $line[] = $base->getWorkdayFriday();
        $line[] = $base->getWorkdaySaturday();

        require_once('grn/calendar.csp');
        //GRN2-3190
        $line[] = $base->getApplyCalendar();
        $line[] = GRN_CalendarManager::getInstance()
                                     ->getSystemCalendar($base->getCalendar())
                                     ->get('code');
        //GRN2-3190
        $work_hours_list = CB_BaseWorkHours::selectByBaseId($base->getId());
        foreach ($work_hours_list as $work_hours) {
            $line[] = $work_hours->getStart();
            $line[] = $work_hours->getEnd();
        }

        $csv->writeLine($line);
    }
    $csv->close();

    // 一時ファイルに書き出した内容をファイルとして出力
    cb_prepare_download('base.csv', 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    if (($size = filesize($temp_filename)) > 0) {
        echo fread($fp, $size);
    }
    fclose($fp);
    // 一時ファイルの削除
    unlink($temp_filename);
}
