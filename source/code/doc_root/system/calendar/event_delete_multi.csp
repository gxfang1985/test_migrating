<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

$scid = @$G_INPUT['scid'];
$all = @$G_INPUT['all'];
$bdate = @$G_INPUT['bdate'];
if (is_null($bdate)) {
    $now = getdate();
    $bdate = $now['year'];
}

$event_ids = [];
$event_count = 0;

if ($all) {
    require_once('grn/calendar.csp');
    $cm = GRN_CalendarManager::getInstance();
    $c = $cm->getSystemCalendar($scid);
    if ( ! $c) {
        cb_throw_error(E_GRN_CALENDAR_CALENDAR_NOT_FOUND);
    }

    $rowset = new CB_RowSet($c->getAttributeTable());
    $condition = $rowset->queryf("col_calendar='@S'", $scid);
    $rowset->addCondition($condition);
    $event_count = 0;
    while ($row = $rowset->iterate()) {
        $event_ids[] = $row->getOID();
        $event_count++;
    }

    $event_count = $rowset->count();
} else {
    if (array_key_exists('eid', $G_INPUT)) {
        $event_ids = @$G_INPUT['eid'];
        $event_count = count($event_ids);
    }
}

if ($event_count <= 0) {
    cb_throw_error(E_GRN_CALENDAR_DAY_NOT_FOUND);
}

$events = [
    'delete_numbers' => $event_count,
    'event'          => $event_ids
];

$t->assign('scid', $scid);
$t->assign('bdate', $bdate);
$t->assign('events', $events);

// page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

$page_list = 'system/calendar/systemcalendar_list';
$page_event = 'system/calendar/event_view';

// site position 
$t->assign(
    'site_position', [
        [
            'page' => $page_list,
            'name' => grn_get_page_display_name($page_list),
            'scid' => $scid
        ],
        ['page' => "", 'name' => $page_title]
    ]
);

// Smartyå®Ÿè¡Œ
$t->display(cb_get_pagename() . ".tpl");

