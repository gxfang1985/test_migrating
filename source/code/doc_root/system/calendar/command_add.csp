<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    $scid = @$G_INPUT['scid'];
    $title = isset($G_INPUT['title']) ? $G_INPUT['title'] : null;
    $code = isset($G_INPUT['code']) ? $G_INPUT['code'] : null;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    // force to register
    $target_name = 'system/calendar/add';
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {

        require_once('grn/calendar.csp');

        $cm = GRN_CalendarManager::getInstance();
        if (strlen($title) <= 0) {
            cb_throw_error(E_GRN_CALENDAR_NOT_CALENDER_NAME);
        }

        $cm->addSystemCalendar($title, $code);

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        cb_redirect('system/calendar/systemcalendar_list', ['scid' => $scid]);
    } else {
        //-- if error, show the source form

        // include sharing codes with command_*
        include('_add.csp');

        $t->assign('title', $title);
        $t->assign('code', $code);
        $t->display($target_name . '.tpl');
    }
}


