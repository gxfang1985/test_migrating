<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once("grn/smarty.csp");
    require_once("SmartyValidate.class.php");
    require_once("fw/i18n.csp");
    require_once("fw/i18n/base.csp");

    $i18n = CB_I18N::getInstance();
    $target_name = "system/calendar/base/base_modify";
    $t = new GRN_Smarty();
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);

    $base_names = getMultiLanguageText("base-name", $G_INPUT);
    $base_code = isset($G_INPUT['base-code']) ? $G_INPUT["base-code"] : null;
    $calendar_id = isset($G_INPUT['calendar']) ? $G_INPUT['calendar']
        : GRN_CALENDAR_SYSTEM_DEFAULT;

    $work_hours_list = CB_BaseManager::parseWorkHoursList($G_INPUT);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        if ( ! array_key_exists("bid", $G_INPUT)) {
            cb_throw_error(E_COMMON_BASE_WAS_NOT_FOUND);
        }

        CB_BaseManager::modifyBase($G_INPUT, $base_names);

        cb_redirect("system/calendar/base/base_detail",
            ["bid" => $G_INPUT["bid"]]);
    } else {
        require_once("_base_modify.csp");
        $base = [
            'id'                => isset($G_INPUT['bid']) ? $G_INPUT['bid']
                : null,
            'names'             => $base_names,
            'code'              => $base_code,
            'workday_sunday'    => (isset($G_INPUT['sunday'])
                                    && $G_INPUT['sunday']) ? 1 : 0,
            'workday_monday'    => (isset($G_INPUT['monday'])
                                    && $G_INPUT['monday']) ? 1 : 0,
            'workday_tuesday'   => (isset($G_INPUT['tuesday'])
                                    && $G_INPUT['tuesday']) ? 1 : 0,
            'workday_wednesday' => (isset($G_INPUT['wednesday'])
                                    && $G_INPUT['wednesday']) ? 1 : 0,
            'workday_thursday'  => (isset($G_INPUT['thursday'])
                                    && $G_INPUT['thursday']) ? 1 : 0,
            'workday_friday'    => (isset($G_INPUT['friday'])
                                    && $G_INPUT['friday']) ? 1 : 0,
            'workday_saturday'  => (isset($G_INPUT['saturday'])
                                    && $G_INPUT['saturday']) ? 1 : 0,
            'apply_calendar'    => (isset($G_INPUT['apply_calendar'])
                                    && $G_INPUT['apply_calendar']) ? 1 : 0,
            'work_hours_list'   => $work_hours_list,
            'calendar'          => ['id' => $calendar_id],
        ];
        $t->assign('base', $base);

        $t->setPageInfo($target_name);
        $t->display($target_name . '.tpl');
    }
}
