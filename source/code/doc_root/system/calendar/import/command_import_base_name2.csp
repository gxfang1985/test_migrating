<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $file_id = isset($G_INPUT['file_id']) ? $G_INPUT['file_id'] : null;
    $charset = isset($G_INPUT['charset']) ? $G_INPUT['charset'] : null;
    $skip = isset($G_INPUT['skip']) ? $G_INPUT['skip'] : 0;

    if ( ! $file_id) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    require_once('fw/session_manager.csp');

    $session_manager = CB_SessionManager::getInstance();
    $session
        = $session_manager->getSession('system/calendar/import/import_base_name1');
    $files = $session->getFiles('base_name_import_files');

    if ( ! is_array($files) || 0 == count($files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }
    if ( ! array_key_exists($file_id, $files)) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }
    if ( ! $files[$file_id]->exists()) {
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    require_once('fw/csv.csp');
    $csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

    // 先頭行をスキップ
    for ($i = 0; $i < $skip; ++$i) {
        $csv->readLine();
    }

    require_once('fw/i18n/base.csp');
    while (($line = $csv->readLine()) !== false) {
        CB_BaseManager::importBaseLocalName($line);
    }
    $csv->close();

    foreach (array_keys($files) as $id) {
        $session->unsetFile('base_name_import_files', $id);
    }

    cb_redirect('system/common_list', ['id' => 'calendar']);
}
