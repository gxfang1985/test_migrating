<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$charset = isset($G_INPUT['charset']) ? $G_INPUT['charset'] : null;
$skip = isset($G_INPUT['skip']) ? $G_INPUT['skip'] : 0;
$file_id = isset($G_INPUT['file_id']) ? $G_INPUT['file_id'] : null;

if ( ! $file_id) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$t->assign('charset', $charset);
$t->assign('skip', $skip);
$t->assign('file_id', $file_id);

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session = $sm->getSession('system/calendar/import/import_base_name1');

$files = $session->getFiles('base_name_import_files');

if ( ! is_array($files) || 0 == count($files)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}
if ( ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}
if ( ! $files[$file_id]->exists()) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

// 表示するサンプルの行数
$read_lines = 0;

// サンプル行の読み込み
$lines = [];
while ($read_lines < 5) {
    if (($line = $csv->readLine()) !== false) {
        if ($skip > 0) {
            --$skip;
            continue;
        }
        $lines[] = $line;
    } else {
        break;
    }
    $read_lines++;
}
$t->assign('csv_datas', $lines);

$page_title
    = grn_get_page_display_name('system/calendar/import/import_base_name1');
$t->assign('page_title', $page_title);

$t->assign('site_position', [
    [
        'page' => 'system/calendar/import/import_index',
        'name' => grn_get_page_display_name('system/calendar/import/import_index'),
    ],
    [
        'page' => '',
        'name' => $page_title,
    ],
]);

$t->display(cb_get_pagename() . ".tpl");
