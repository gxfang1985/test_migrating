<?php

use grn\grn\access\utility\AppAvailabilityUtil;

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$page_name = cb_get_pagename();

$charset = null;
if (array_key_exists('charset', $G_INPUT)) {
    $charset = $G_INPUT['charset'];
}
if (0 == strlen($charset)) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}
$t->assign('charset', $charset);
$skip = null;
if (array_key_exists('skip', $G_INPUT)) {
    $skip = $G_INPUT['skip'];
}
$t->assign('skip', $skip);
$file_id = null;
if (array_key_exists('fid', $G_INPUT)) {
    $file_id = $G_INPUT['fid'];
}
if (0 == strlen($file_id)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}
$t->assign('file_id', $file_id);

require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();
$session
    =& $session_manager->getSession('system/application/availability_user_import1');
$files = $session->getFiles('import_files');
if ( ! array_key_exists($file_id, $files)) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

require_once('fw/csv.csp');
$csv_reader = new CB_CSVReader($charset, $files[$file_id]->getPath());

$line_count = 0;
$lines = [];
while ($line = $csv_reader->readLine()) {
    if ($skip) {
        $skip = false;
        continue;
    }

    $lines[] = $line;
    if (5 < $line_count++) {
        break;
    }
}
$t->assign('csv_datas', $lines);

// Available apps
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$activated_app_ids = AppAvailabilityUtil::getActiveAppIds();
$available_apps = [];
foreach ($activated_app_ids as $app_id) {
    $app = $locator->getInstance($app_id, true);
    $available_apps[] = $app->getName();
}
$t->assign('available_apps', $available_apps);

// Site Position
$t->assign('site_position', [
        [
            'page' => '',
            'name' => grn_get_page_display_name('system/application/availability_user_import2')
        ]
    ]
);

$t->display("{$page_name}.tpl");
