<?php

use grn\grn\access\bean\Availability;
use grn\grn\access\utility\AppAvailabilityUtil;
use grn\grn\access\logic\AvailabilitySettingLogic;
use grn\grn\Validate;

global $G_INPUT;

require_once('grn/smarty.csp');
$t = new GRN_Smarty;
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$page_name = cb_get_pagename();
if ( ! array_key_exists('id', $G_INPUT)
     || ! array_key_exists('type', $G_INPUT)
) {
    cb_redirect('system/application/availability_user_list');
}

$type_map = [
    'cb_user'      => Availability::USER,
    'cb_group'     => Availability::GROUP,
    'cb_role'      => Availability::STATIC_ROLE,
    'dynamic_role' => Availability::DYNAMIC_ROLE
];

$id = $G_INPUT['id'];
$type = $G_INPUT['type'];
if (empty($type) || ! in_array(strtolower($type), array_keys($type_map))) {
    cb_throw_error(E_GRN_CAN_NOT_CHANGE_SETTING);
}
if ($type != 'dynamic_role') {
    if ( ! Validate::isNumber($id) || $id < 1) {
        cb_throw_error(E_GRN_CAN_NOT_CHANGE_SETTING);
    }
}

$app_setting_logic = new \grn\grn\access\logic\AvailabilitySettingLogic();
$app_ids_user = $app_setting_logic->getAvailabilitySettingByTargetId($id,
    $type_map[$type]);
if (count($app_ids_user) === 0) {
    cb_throw_error(E_GRN_CAN_NOT_CHANGE_SETTING);
}

// get app is allow
$app_is_active = $app_setting_logic->getActiveAppIds();
$applications_for_view = [];
foreach ($app_is_active as $app_id) {
    $app_usage_settings = cb_at($app_ids_user, $app_id, [
        'internal' => AppAvailabilityUtil::ACCESS_DENIED,
        'external' => AppAvailabilityUtil::ACCESS_DENIED
    ]);
    $applications_for_view[$app_id] = [
        'app_id'    => $app_id,
        'allow'     => $app_usage_settings['internal']
                       == AppAvailabilityUtil::ACCESS_ALLOWED,
        'ext_allow' => $app_usage_settings['external']
                       == AppAvailabilityUtil::ACCESS_ALLOWED,
        'active'    => true,
    ];
}
$t->assign('app_list', $applications_for_view);
$t->assign('id', $id);
$t->assign('type', $type);
//Page Information
$page_infos = [
    'availability_user_list'   => ['sf' => true],
    'availability_user_modify' => null
];
require_once('grn/controller.csp');
$controller_util = new GRN_ControllerUtil($page_name);
$site_position = $controller_util->makeSitePosition('system/application/',
    $page_infos);
$t->assign('site_position', $site_position);

$t->assign('can_use_external_access',
    AvailabilitySettingLogic::getExternalAccessSetting());

$t->display("{$page_name}.tpl");


