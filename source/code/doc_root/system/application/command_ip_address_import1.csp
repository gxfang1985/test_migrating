<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $page_name = 'system/application/ip_address_import1';
    SmartyValidate::register_form($page_name);

    if (SmartyValidate::is_valid($G_INPUT, $page_name)) {
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session = $session_manager->getSession($page_name);
        $files = $session->getFiles('import_files');
        if (is_array($files)) {
            foreach (array_keys($files) as $file_id) {
                $session->unsetFile('import_files', $file_id);
            }
        }

        $file = $_FILES['file'];
        if ($file['error']) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }
        $file_id = $session->addFile('import_files', $file);

        SmartyValidate::unregister_form($page_name);

        cb_redirect('system/application/ip_address_import2',
            [
                'charset' => cb_at($G_INPUT, 'charset', null),
                'skip'    => cb_at($G_INPUT, 'skip', null),
                'file_id' => $file_id
            ]);
    } else {
        $params = ['charset', 'skip'];
        foreach ($params as $param) {
            $t->assign($param, cb_at($G_INPUT, $param, null));
        }
        $t->setPageInfo($page_name);
        $page_title = grn_get_page_display_name($page_name);
        $t->assign('page_title', $page_title);

        // Site Position
        $t->assign('site_position', [
                [
                    "page" => 'system/application/availability_user_list',
                    "name" => grn_get_page_display_name("system/application/availability_user_list")
                ],
                [
                    "page" => 'system/application/external_access_detail',
                    "name" => grn_get_page_display_name("system/application/external_access_detail")
                ],
                [
                    'page' => '',
                    'name' => $page_title
                ]
            ]
        );

        $t->display("{$page_name}.tpl");
    }
}
