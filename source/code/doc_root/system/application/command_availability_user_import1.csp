<?php

use grn\grn\access\utility\AppAvailabilityUtil;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $page_name = 'system/application/availability_user_import1';
    SmartyValidate::register_form($page_name);

    if (SmartyValidate::is_valid($G_INPUT, $page_name)) {
        require_once('fw/session_manager.csp');
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession($page_name);
        $files = $session->getFiles('import_files');
        if (is_array($files)) {
            foreach (array_keys($files) as $file_id) {
                $session->unsetFile('import_files', $file_id);
            }
        }

        $file = $_FILES['file'];
        if ($file['error']) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }
        $file_id = $session->addFile('import_files', $file);

        SmartyValidate::unregister_form($page_name);

        cb_redirect('system/application/availability_user_import2', [
            'charset' => $G_INPUT['charset'],
            'skip'    => $G_INPUT['skip'],
            'fid'     => $file_id
        ]);
    } else {
        // Assign input values
        $assign_input_values = [
            'charset' => cb_at($G_INPUT, 'charset'),
            'skip'    => cb_at($G_INPUT, 'skip')
        ];
        $t->assign($assign_input_values);

        $t->setPageInfo($page_name);
        $page_title = grn_get_page_display_name($page_name);
        $t->assign('page_title', $page_title);

        // Available apps
        require_once('grn/application.csp');
        $locator = GRN_ApplicationLocator::instance();
        $activated_app_ids = AppAvailabilityUtil::getActiveAppIds();
        $available_apps = [];
        foreach ($activated_app_ids as $app_id) {
            $app = $locator->getInstance($app_id, true);
            $available_apps[] = $app->getName();
        }
        $t->assign('available_apps', $available_apps);

        // Site Position
        $t->assign('site_position', [
                [
                    'page' => '',
                    'name' => grn_get_page_display_name('system/application/availability_user_import1')
                ]
            ]
        );

        $t->display("{$page_name}.tpl");
    }
}
