<?php

require_once('grn/smarty.csp');
$t = new GRN_Smarty;

//--------------------------------------------------------------

// UI設定ロジックを取得する
require_once('grn/ui.csp');
$manager = GRN_UIConfigManager::getInstance();
assert('is_object( $manager ) && is_a( $manager, \'GRN_UIConfigManager\' )');
$config =& $manager->getSystemConfig();
assert('is_object( $config ) && is_a( $config, \'GRN_UIConfig\' )');

// ファイル管理設定ロジックを取得する
require_once('grn/file.csp');
$manager = GRN_FileManagerConfig::getInstance();
assert('is_object( $manager ) && is_a( $manager, \'GRN_FileManagerConfig\' )');

require_once('fw/i18n.csp');

$max_size = ini_get('upload_max_filesize');
$byte = 'B';
$display_max_size = $max_size . $byte;

// ファイルのサイズ制限
$resources = [
    '512'    => '512KB',
    '1024'   => '1MB',
    '3072'   => '3MB',
    '5120'   => '5MB',
    '10240'  => '10MB',
    '51200'  => '50MB',
    '102400' => '100MB',
    '-1'     => cb_msg('grn.system', 'separator'),
    '0'      => $display_max_size
];

$max_filesize = $manager->getMaxFileSize();

$options = [];
foreach ($resources as $value => $label) {
    $selected = false;
    if ((intval($value) * 1024) == $max_filesize) {
        $selected = true;
    }
    $options[] = [
        'label'    => $label,
        'value'    => $value,
        'selected' => $selected
    ];
}

$max_filesize = [
    'name'    => 'max_filesize',
    'options' => $options
];

// バージョン管理の上限値
$max_version = $manager->getMaxVersion();

$options = [];
$options[] = [
    'label'    => cb_msg('grn.system', 'no_version'),
    'value'    => 0,
    'selected' => (0 == $max_version)
];

$options[] = [
    'label' => cb_msg('grn.system', 'separator'),
    'value' => null
];

for ($i = 1; $i <= 10; $i++) {
    $selected = false;
    if ($i == $max_version) {
        $selected = true;
    }
    $options[] = [
        'label'    => $i,
        'value'    => $i,
        'selected' => $selected
    ];
}

$options[] = [
    'label' => cb_msg('grn.system', 'separator'),
    'value' => null
];

$options[] = [
    'label'    => cb_msg('grn.system', 'infinity'),
    'value'    => GRN_FILE_CONFIG_VERSION_INFINITE,
    'selected' => (GRN_FILE_CONFIG_VERSION_INFINITE == $max_version)
];

$max_version = [
    'name'    => 'max_version',
    'options' => $options
];

// ロックをかける期間
$resources = [
    '30'   => cb_msg('grn.system', '30_minutes'),
    '60'   => cb_msg('grn.system', '60_minutes'),
    '180'  => cb_msg('grn.system', '180_minutes'),
    '300'  => cb_msg('grn.system', '300_minutes'),
    '1440' => cb_msg('grn.system', '1440_minutes'),
    '-1'   => cb_msg('grn.system', 'separator'),
    '0'    => cb_msg('grn.system', 'infinity')
];

$lock_timeout = $manager->getLockTimeout();

$options = [];
foreach ($resources as $value => $label) {
    $selected = false;
    if ($value == $lock_timeout) {
        $selected = true;
    }
    $options[] = [
        'label'    => $label,
        'value'    => $value,
        'selected' => $selected
    ];
}

$lock_timeout = [
    'name'    => 'lock_timeout',
    'options' => $options
];

// ロック機能
$file_lockable = [
    'name'    => 'file_lockable',
    'checked' => $config->getFileLockable()
];

// SmartyにUIの共通設定を割り当てる
$t->assign('config', [
    'max_filesize'  => $max_filesize,
    'max_version'   => $max_version,
    'lock_timeout'  => $lock_timeout,
    'file_lockable' => $file_lockable
]);

//--------------------------------------------------------------

// Smartyにページタイトルを割り当てる
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

// Smartyを実行する
$t->display(cb_get_pagename() . '.tpl');


