<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    // UI設定ロジックを取得する
    require_once('grn/ui.csp');
    $manager = GRN_UIConfigManager::getInstance();
    assert('is_object( $manager ) && is_a( $manager, \'GRN_UIConfigManager\' )');
    $config =& $manager->getSystemConfig();
    assert('is_object( $config ) && is_a( $config, \'GRN_UIConfig\' )');

    // システムデフォルト設定ロジックを取得する
    require_once('grn/file.csp');
    $manager = GRN_FileManagerConfig::getInstance();
    assert('is_object( $manager ) && is_a( $manager, \'GRN_FileManagerConfig\' )');

    // 入力フォームデータを取得する
    $form_names = [
        'max_filesize',
        'lock_timeout'
    ];

    $form_values = [];
    foreach ($form_names as $form_name) {
        if ( ! array_key_exists($form_name, $G_INPUT)) {
            cb_throw_error(E_GRN_SYSTEM_INVALID_FORM_DATA);
        }

        $form_value = $G_INPUT[$form_name];

        if (is_null($form_value) || 0 == strlen($form_value)) {
            cb_throw_error(E_GRN_SYSTEM_INVALID_FORM_DATA);
        }

        $form_values[$form_name] = intval($form_value);
    }
    $max_version = @ $G_INPUT['max_version'];
    $file_lockable = @ $G_INPUT['file_lockable'];

    // ファイルのサイズ制限
    if (0 <= $form_values['max_filesize']) {
        $manager->setMaxFileSize(intval($form_values['max_filesize']) * 1024);
    }

    // 保存する履歴の件数
    if (is_numeric($max_version) && -1 <= $max_version) {
        $manager->setMaxVersion($max_version);
    }

    // ロックをかける期間
    if (0 <= $form_values['lock_timeout']) {
        $manager->setLockTimeout($form_values['lock_timeout']);
    }
    // ロック機能
    $config->setFileLockable(1 == $file_lockable);
}

cb_redirect('system/common_list', ['id' => 'filemanager']);


