<?php

require_once('grn/error_code.csp');

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//-- assign smarty parameters

// page title
$page_title = grn_get_page_display_name(cb_get_pagename());
$t->assign('page_title', $page_title);

require_once('fw/i18n.csp');
$items = [
    'title' => [
        'display_name' => cb_msg('grn.common.mime', 'col_extension'),
    ],
    'url'   => [
        'display_name' => cb_msg('grn.common.mime', 'col_mime'),
    ],
];
$t->assign('items', $items);

if ( ! @ $G_INPUT['file']) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
$file_id = $G_INPUT['file'];
$t->assign('charset', $charset);
$t->assign('skip', $skip);
$t->assign('file_id', $file_id);

if ( ! $charset) {
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$target_name = '';
if (array_key_exists('fn', $G_INPUT)) {
    $target_name = $G_INPUT['fn'];
}
$t->assign('form_name', $target_name);

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session =& $sm->getSession($target_name);

$files = $session->getFiles('import_files');

if ( ! $files || ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

// 表示するサンプルの行数
$read_lines = 5;

// folder csv files column number
$csv_columns_num = 2;

// サンプル行の読み込み
$csv_datas = [];

$count = 0;
while (($line = $csv->readLine()) !== false) {
    if ($skip > 0) {
        $skip--;
        continue;
    }
    $csv_datas[] = $line;
    $count++;

    if ($count >= $read_lines) {
        break;
    }
}

$t->assign('csv_datas', $csv_datas);

$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);
$t->assign('site_position', [['page' => '', 'name' => $page_title]]);

$t->assign('form', ['hiddens' => ['fn' => $target_name]]);

//-- show page
$t->display(cb_get_pagename() . ".tpl");

