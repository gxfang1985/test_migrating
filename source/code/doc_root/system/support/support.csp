<?php

require_once("grn/smarty.csp");
$t = new GRN_Smarty();

require_once('SmartyValidate.class.php');
if (SmartyValidate::is_registered_form(cb_get_pagename())) {
    SmartyValidate::unregister_form(cb_get_pagename());
}
SmartyValidate::connect($t);
SmartyValidate::register_form(cb_get_pagename());

$names = [
    'name',
    'yomi',
    'admin_name',
    'admin_yomi',
    'group',
    'email',
    'phone'
];

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session =& $sm->getSession(cb_get_pagename());

if (array_key_exists('sf', $G_INPUT) && $G_INPUT['sf'] === '1') {
    foreach ($names as $name) {
        $raw = $session->get('raw_' . $name);
        $t->assign($name, $raw);
    }
} else {
    $info = [];

    require_once('grn/customer.csp');
    $customer = GRN_Customer::getInstance();
    $info['name'] = $customer->getProperty('company_name');
    $info['yomi'] = $customer->getProperty('company_name2');

    global $G_container_base;
    $uum =& $G_container_base->getInstance('uum');
    $user =& $uum->getLoginUser();
    $group = false;
    if ($user) {
        if ($user->getOID() !== GRN_UUM_ADMINISTRATION_USER) {
            $info['admin_name'] = $user->get('display_name');
            $info['admin_yomi'] = $user->get('sort_key');
        }
        $info['email'] = $user->get('email_address');
        $info['phone'] = $user->get('telephone_number');
        $group = $uum->getUserPrimaryGroup($user->getOID());
    }
    if ($group !== false) {
        $info['group'] = $group->get('name');
    }

    require_once('fw/string_util.csp');
    foreach ($names as $name) {
        if ( ! array_key_exists($name, $info)) {
            $info[$name] = '';
        } elseif (is_string($info[$name])) {
            $info[$name] = cb_trim($info[$name]);
        } elseif (is_int($info[$name])) {
            $info[$name] = (string)($info[$name]);
        } else {
            $info[$name] = '';
        }
    }


    $t->assign('name', $info['name']);
    $t->assign('yomi', $info['yomi']);
    $t->assign('admin_name', $info['admin_name']);
    $t->assign('admin_yomi', $info['admin_yomi']);
    $t->assign('group', $info['group']);
    $t->assign('email', $info['email']);
    $t->assign('phone', $info['phone']);
}

// Smartyにページタイトルを割り当てる
$page_title = grn_get_page_display_name('common/support');
$t->assign('page_title', $page_title);

// Smartyにサイトポジションを割り当てる
$t->assign('site_position',
    [
        [
            'name' => grn_get_page_display_name('system/index'),
            'page' => 'system/index'
        ],
        ['name' => $page_title, 'page' => null],
    ]
);

$t->display(cb_get_pagename() . ".tpl");


