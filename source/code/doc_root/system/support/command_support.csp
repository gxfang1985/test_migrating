<?php

use grn\fts\Application as FtsApplication;

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty();

    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);

    $target_name = 'system/support/support';
    SmartyValidate::register_form($target_name);

    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        $info = [];

        $input_names = [
            'subject',
            'name',
            'yomi',
            'admin_name',
            'admin_yomi',
            'group',
            'email',
            'phone'
        ];
        foreach ($input_names as $input_name) {
            if (array_key_exists($input_name, $G_INPUT)) {
                $info[$input_name] = $G_INPUT[$input_name];
            }
        }

        require_once('grn/customer.csp');
        $customer = GRN_Customer::getInstance();
        $info['id'] = $customer->getProperty('customer_id');

        require_once('grn/license.csp');
        $lm = GRN_LicenseManager::getInstance();
        $license_info = $lm->getLicense(GRN_LICENSE_BASESYSTEM);
        $expire_date = null;
        if ($lm->isDemoLicense($license_info['type'])) {
            $expire_date = $license_info['limit'];
        } else {
            $expire_date = $license_info['service_limit'];
        }
        if ($expire_date) {
            $info['expire'] = $expire_date->format();
        }

        $info['os'] = cb_getserveros();
        $info['webserver'] = '';
        if (array_key_exists('SERVER_SOFTWARE', $_SERVER)) {
            $info['webserver'] = $_SERVER['SERVER_SOFTWARE'];
        }
        $info['docdir'] = '';
        if (array_key_exists('DOCUMENT_ROOT', $_SERVER)) {
            $info['docdir'] = $_SERVER['DOCUMENT_ROOT'];
        } elseif (array_key_exists('PATH_TRANSLATED', $_SERVER)
                  && array_key_exists('PATH_INFO', $_SERVER)
        ) {
            $info['docdir'] = substr($_SERVER['PATH_TRANSLATED'], 0,
                -strlen($_SERVER['PATH_INFO']));
        }
        $basedir = cb_basedir();
        if (strncasecmp(php_uname('s'), 'WIN', 3) === 0) {
            $basedir = str_replace('\\', '/', $basedir);
        }
        $info['cgidir'] = $basedir;
        global $G_container_base;
        $uum =& $G_container_base->getInstance('uum');
        $info['usercount'] = $uum->getUserCount() - 1;

        require_once('grn/application.csp');
        $app_locator = GRN_ApplicationLocator::instance();
        $ids = $app_locator->getActiveApplicationIds();
        $info['productinfo'] = [];
        global $G_config_grn;
        $version = $G_config_grn->get('System', 'version');
        foreach ($ids as $id) {
            $name = $app_locator->getName($id);
            $status = $app_locator->getStatus($id);
            $info['productinfo'][$id] = [
                'id'      => $id,
                'name'    => $name,
                'version' => $version
            ];
        }

        if (FtsApplication::isViewable()) {
            $info['productinfo']['fts'] = [
                'id'      => 'fts',
                'name'    => cb_msg('grn.fts', 'fts-name'),
                'version' => $version
            ];
        }

        $names = [
            'subject',
            'id',
            'name',
            'yomi',
            'admin_name',
            'admin_yomi',
            'group',
            'email',
            'phone',
            'expire',
            'os',
            'webserver',
            'docdir',
            'cgidir',
            'usercount',
            'productinfo'
        ];

        $encode = [];
        require_once('fw/string_util.csp');
        foreach ($names as $name) {
            if (is_array($info[$name])) {
                //appinfo
                $encode[$name] = '';
                $delim = '';
                $appkeys = array_keys($info[$name]);
                foreach ($appkeys as $appkey) {
                    $datakeys = array_keys($info[$name][$appkey]);
                    foreach ($datakeys as $datakey) {
                        $info[$name][$appkey][$datakey]
                            = cb_trim($info[$name][$appkey][$datakey]);
                        $encode[$name] .= $delim
                                          . $info[$name][$appkey][$datakey];
                        $delim = "\n";
                    }
                }
                $encode[$name] = base64_encode($encode[$name]);
                continue;
            }

            if ( ! array_key_exists($name, $info)) {
                $info[$name] = '';
            } elseif (is_string($info[$name])) {
                $info[$name] = cb_trim($info[$name]);
            } elseif (is_int($info[$name])) {
                $info[$name] = (string)($info[$name]);
            } else {
                $info[$name] = '';
            }

            $encode[$name] = base64_encode($info[$name]);
        }

        require_once('fw/session_manager.csp');
        $sm = CB_SessionManager::getInstance();
        $session =& $sm->getSession($target_name);

        foreach ($names as $name) {
            $session->set('raw_' . $name, $info[$name]);
            $session->set('enc_' . $name, $encode[$name]);
        }

        SmartyValidate::unregister_form($target_name);
        cb_redirect('system/support/support_send');
    } else {
        $page_title = grn_get_page_display_name('common/support');
        $t->assign('page_title', $page_title);
        $t->assign('site_position',
            [
                [
                    'name' => grn_get_page_display_name('system/index'),
                    'page' => 'system/index'
                ],
                ['name' => $page_title, 'page' => null],
            ]
        );

        $t->setPageInfo($target_name);

        $assign_input_values = [
            'subject'    => $G_INPUT['subject'] ?? null,
            'name'       => $G_INPUT['name'] ?? null,
            'yomi'       => $G_INPUT['yomi'] ?? null,
            'admin_name' => $G_INPUT['admin_name'] ?? null,
            'admin_yomi' => $G_INPUT['admin_yomi'] ?? null,
            'group'      => $G_INPUT['group'] ?? null,
            'email'      => $G_INPUT['email'] ?? null,
            'phone'      => $G_INPUT['phone'] ?? null
        ];
        $t->assign($assign_input_values);
        $t->display($target_name . '.tpl');
    }
}


