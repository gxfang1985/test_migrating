<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    require_once('grn/smarty.csp');
    $t = new GRN_Smarty;

    require_once('grn/http_proxy.csp');
    $hpcm = GRN_HttpProxyConfigManager::getInstance();

    if (@$G_INPUT['available']) {
        // Validation check
        require_once('SmartyValidate.class.php');
        SmartyValidate::connect($t);

        // force to register
        $target_name = 'system/external/webproxy';
        SmartyValidate::register_form($target_name);

        if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
            require_once('fw/string_util.csp');
            $hpcm->setProperty('available', true);

            if (strlen(cb_trim(@$G_INPUT['server'])) <= 0) {
                cb_throw_error(E_GRN_EXTSERVER_INVALID_PROXYSERVER_NAME);
            }
            $hpcm->setProperty('server', @$G_INPUT['server']);

            if (0 > (int)@$G_INPUT['port']
                || 0xFFFF < (int)@$G_INPUT['port']
            ) {
                cb_throw_error(E_GRN_EXTSERVER_INVALID_PROXYSERVER_PORT);
            }

            $hpcm->setProperty('port', (int)@$G_INPUT['port']);
            $hpcm->setProperty('exception_address',
                @$G_INPUT['exception_address']);

            // 接続確認
            $hpcm->testConnect();

            SmartyValidate::unregister_form($target_name);

            cb_redirect('system/common_list', ['id' => 'external']);
        } else {
            $t->setPageInfo($target_name);

            $init = false;
            include('_webproxy.csp');

            $t->display($target_name . '.tpl');
        }
    } else {
        $hpcm->setProperty('available', false);
        cb_redirect('system/common_list', ['id' => 'external']);
    }
}


