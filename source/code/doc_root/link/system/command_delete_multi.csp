<?php

if (0 === strcasecmp(cb_at($_SERVER, 'REQUEST_METHOD', ''), 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Create Parameter Translation Map
    $translation_map = [
        'ids' => '_id',
        'cid' => 'cid',
    ];

    //Do Parameter Translation
    $properties = [];
    foreach ($translation_map as $view_name => $model_name) {
        $properties[$model_name] = cb_at($G_INPUT, $view_name, null);
    }

    //Delete Link
    require_once('link/link_logic.csp');
    $link_logic = GRN_Link_System_Link_Logic::getInstance();

    //Get Link List
    $link_list = $link_logic->getList($properties['cid']);

    $link_ids = cb_at($properties, '_id', []);

    //Delete Link
    foreach ($link_ids as $link_id) {
        //Check Link Exist
        if (array_key_exists($link_id, $link_list)) {
            //Check Inspection Message Enabled
            require_once('link/inspection.csp');
            $inspection = GRN_Link_Inspection::getInstance();
            if ($inspection->isEnabled()) {
                //Get Link Object
                require_once('link/link_logic.csp');
                $link_logic = GRN_Link_System_Link_Logic::getInstance();
                $link = $link_logic->get($link_id);
                //Get Link Name
                $link_name = $link->get(GRN_LINK_PROPERTY_NAME);
            }

            //Delete Link
            $link_logic->delete($link_id, $properties['cid']);

            //Check Inspection Message Enabled
            if ($inspection->isEnabled()) {
                //Get Category Object
                require_once('link/category_logic.csp');
                $category_logic = GRN_Link_System_Category_Logic::getInstance();
                $category = $category_logic->get($properties['cid']);

                //Write Inspection Message
                $message_args['lid']
                    = $link_id;                                 //Link ID
                $message_args['cid']
                    = $category->getOID();                      //Category ID
                $message_args['link_name']
                    = $link_name;                               //Link Name
                $message_args['category_name']
                    = $category->get(GRN_LINK_PROPERTY_NAME);   //Category Name

                //Record Inspection
                $inspection->writeInspectionLog('delete', 'system_link',
                    $message_args);
            }
        }
    }

    //Redirect Next Page
    cb_redirect('link/system/list', ['cid' => $properties['cid']]);
}


