<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Get Parameters
    $charset = @ $G_INPUT['charset'];     //Charactor Set
    $item_name = @ $G_INPUT['item_name'];   //Item Name
    $file_name = @ $G_INPUT['file_name'];   //File Name

    //Get Default Charactor Set
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    //Create Temporary File
    $tempdir = cb_tmpdir();
    $temp_filename = tempnam($tempdir, 'link_');

    //Create CSV Writer
    require_once('fw/csv.csp');
    $csv = new CB_CSVWriter($charset, $temp_filename);

    //Write Item Name
    if ($item_name) {
        require_once('fw/i18n.csp');
        $header = [];
        $header[] = cb_msg('grn.link.system', 'access_csv_code');
        $header[] = cb_msg('grn.link.system', 'access_csv_item');
        $header[] = cb_msg('grn.link.system', 'access_csv_value');
        $header[] = cb_msg('grn.link.system', 'access_csv_target');
        $csv->writeLine($header);
    }

    //Get Category List
    require_once('link/category_logic.csp');
    $category_logic = GRN_Link_System_Category_Logic::getInstance();
    $category_list = $category_logic->getList();

    //Export All Category Security Model and Access Right
    require_once('link/access_logic.csp');
    $category_access_logic = GRN_Link_Category_Access_Logic::getInstance();
    foreach (array_keys($category_list) as $category_id) {
        //Export Security Model
        $csv_line = $category_access_logic->exportSecurityModel($category_id);
        $csv->writeLine($csv_line);

        //Export Access Right
        $csv_line_list = $category_access_logic->exportAccess($category_id);
        foreach ($csv_line_list as $csv_line) {
            $csv->writeLine($csv_line);
        }
    }
    $csv->close();

    //Download CSV File
    //'text/comma-separated-values'
    cb_prepare_download($file_name, 'application/csv', false);
    $fp = fopen($temp_filename, 'rb');
    if (($size = filesize($temp_filename)) > 0) {
        echo fread($fp, $size);
    }
    fclose($fp);

    //Delete Temporary File
    unlink($temp_filename);
}
