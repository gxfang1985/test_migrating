<?php

//Get User
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$user =& $uum->getLoginUser();

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get navi parameter
require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$user_config =& $cm->getUserConfig($user);
$subject_width = $user_config->getSubjectWidth();
$t->assign('subject_width', $subject_width);

//Set Application Name
global $G_link_app_name;
$t->assign('app_name', $G_link_app_name);

//Get Parameters
$category_id = isset($G_INPUT['cid']) ? $G_INPUT['cid'] : null;    //Category ID

// --- folder tree
$tree_info = [
    'link_url' => 'link/system/list',
    'oid_key'  => 'cid'
];
$tree_selected_oid = ($category_id != GRN_LINK_CATEGORY_ROOT_ID) ? $category_id
    : null;
include('_category_tree.csp');
$category_id = $tree_selected_oid;
// --- end: folder tree

//Get Link and Category Controller Utility
require_once('link/controller_util.csp');
$link_util = GRN_Link_Link_Controller_Utility::getInstance();
$category_util = GRN_Link_Category_Controller_Utility::getInstance();

//Set Link And Category Type
$link_util->setType('system');
$category_util->setType('system');

//Check Category ID
require_once('link/resources.csp');
$category_id = $category_id ? $category_id : GRN_LINK_CATEGORY_ROOT_ID;
$t->assign('category_id', $category_id);

//Create Parameter Translation for Link
$translation_map_link = [
    'lid'    => '_id',          //Link ID
    'object' => 'type',         //Link Type
    'title'  => 'name',         //Link Name
    'url'    => 'url',          //Link URL
    'memo'   => 'memo',         //Link Memo
    'cid'    => 'cid',          //Category ID
    'sid'    => 'sid',          //SSO Method ID
];

//Create Parameter Translation for Category
$translation_map_category = [
    'cid'         => '_id',          //Category ID
    'title'       => 'name',         //Category Name
    'foreign_key' => 'foreign_key',  //Category Name
    'memo'        => 'memo',         //Category Memo
];

//Get Link List for View
$link_list_for_view = $link_util->getListView($translation_map_link,
    $category_id);

//Get Current Category for View
$category_for_view = $category_util->getView($category_id,
    $translation_map_category);

//Get Brother Category List for View
//$brother_category_list_for_view = $category_util->getBrotherListView($category_id, $translation_map_category);

//Get Child Category List for View
//$child_category_list_for_view = $category_util->getChildListView($category_id, $translation_map_category);

//Get Tree Category List for View
//$tree_category_list_for_view = $category_util->getTreeListView($category_id, $translation_map_category, FALSE, FALSE);

//Add SSO Information to Link
foreach (array_keys($link_list_for_view) as $link_id) {
    $link_list_for_view[$link_id]['sso_param']['system_link'] = $link_id;
    $link_list_for_view[$link_id]['sso_param']['system_category']
        = $link_list_for_view[$link_id]['cid'];
}

//Get Popup Setting
$config_list = $link_util->getGeneralConfig();

//Create Selected Category Information
if ($category_id == GRN_LINK_CATEGORY_ROOT_ID) {
    //$category_information_for_view                      = $category_for_view;
    //$category_information_for_view['categories']          = $child_category_list_for_view;
    //$category_information_for_view['path']              = $tree_category_list_for_view;
    //$category_information_for_view['child_categories']  = $child_category_list_for_view;
} else {
    //$category_information_for_view                      = $category_for_view;
    //$category_information_for_view['categories']        = $brother_category_list_for_view;
    //$category_information_for_view['path']              = $tree_category_list_for_view;
    //$category_information_for_view['child_categories']  = $child_category_list_for_view;
}

$t->assign('is_root', $category_id == GRN_LINK_CATEGORY_ROOT_ID);
//Assign Link List
$t->assign('share_link_list', $link_list_for_view);
//Assign Category
$t->assign('category', $category_for_view);
//Assign Set Popup
$t->assign('set_popup',
    array_key_exists('popup_set', $config_list) ? $config_list['popup_set']
        : 0);

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

// site position
$t->assign('site_position', [
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


