<?php

global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Category Controller Utility
require_once('link/controller_util.csp');
$category_util = GRN_Link_Category_Controller_Utility::getInstance();

//Check Category ID
require_once('link/resources.csp');
$category_id = @ $G_INPUT['cid'];    //Category ID
$category_id = $category_id ? $category_id : GRN_LINK_CATEGORY_ROOT_ID;
$t->assign('category_id', $category_id);

// Personal or Shared
$type = (@ $G_INPUT['type'] == 'share') ? 'share' : 'personal';
$category_util->setType(($type == 'share') ? 'manage' : 'personal');
$t->assign('type', $type);

//Check Management Right
$management = $category_util->checkManage($category_id, null, false,
    CB_DATABASE_NO_LOCK);

//Check Move Category Right
$avail_move = 0;
if ($category_id != GRN_LINK_CATEGORY_ROOT_ID && $type != 'personal') {
    require_once('link/category_logic.csp');
    $category_logic = GRN_Link_System_Category_Logic::getInstance();
    $category =& $category_logic->get($category_id);
    $parent_category =& $category->get('parent');
    if ($parent_category) {
        if ($category_util->checkManage($parent_category->getOID(), null, false,
            CB_DATABASE_NO_LOCK)
        ) {
            $child_category_list
                = $category_logic->getChildList($parent_category->getOID());
            if (count($child_category_list) !== 0) {
                $avail_move = 1;
            }
        } else {
            $parent_parent_category =& $parent_category->get('parent');
            if ($parent_parent_category) {
                if ($category_util->checkManage($parent_parent_category->getOID(),
                    null, false, CB_DATABASE_NO_LOCK)
                ) {
                    $avail_move = 1;
                }
            }
        }
    }
    unset($category);
    unset($parent_category);
    unset($parent_parent_category);
}

//Create Parameter Translation for Category
$translation_map_category = [
    'cid'          => '_id',              //Category ID
    'title'        => 'name',             //Category Name
    'foreign_key'  => 'foreign_key',      //Category Name
    'memo'         => 'memo',             //Category Memo
    'creator_uid'  => 'creator_uid',      //Category Creator UID
    'creator_name' => 'creator_name',     //Category Creator Name
    'modify_uid'   => 'modifier_uid',     //Category Modifier UID
    'modify_name'  => 'modifier_name',    //Category Modifier Name
    'ctime'        => 'ctime',            //Category Create Time
    'mtime'        => 'mtime',            //Category Modify Time
    'num_children' => 'num_children',     //Children Category Count
    'num_link'     => 'num_link',         //Children Link Count
];

$category = $category_util->getView($category_id,
    $translation_map_category, null, true, CB_DATABASE_NO_LOCK);
$category_id = $category['cid'];
$category['parent_category'] = $category_util->getParentView($category_id,
    $translation_map_category, null, true, CB_DATABASE_NO_LOCK);
$category['child_categories']
    = $category_util->getListView($translation_map_category,
    $category_id, CB_DATABASE_NO_LOCK);

$t->assign('category', $category);
$t->assign('is_root', $category_id == GRN_LINK_CATEGORY_ROOT_ID);
$t->assign('management', $management ? 1 : 0);
$t->assign('avail_move', $avail_move);

//-- set page title and site position

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$t->assign('site_position', [
        [
            'page' => 'link/index',
            'name' => grn_get_page_display_name('link/index'),
            'cid'  => $category_id,
            'type' => $type
        ],
        ['page' => '', 'name' => $page_title]
    ]
);
$delete_info = [
    'title'      => grn_get_page_display_name('link/category_delete'),
    'page'       => 'link/category_delete.tpl',
    'no_confirm' => false,
    'data'       => [
        'category' => $category
    ],
    'handler'    => 'lnk_delete',
];
$t->assign('delete_info', $delete_info);
//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


