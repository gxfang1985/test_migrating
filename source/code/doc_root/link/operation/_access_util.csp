<?php

//--current organization id
$poid = @ $G_INPUT['poid'];
if (isset($t) && ! is_null($t)) {
    $t->assign('poid', $poid);
}

//--category
$node_id = @ $G_INPUT['nid'];
$node_id = $node_id ? $node_id : GRN_LINK_CATEGORY_ROOT_ID;

//Get Category Controller Utility
require_once('link/controller_util.csp');
$category_util = GRN_Link_Category_Controller_Utility::getInstance();
$category_util->setType('manage');

//Check Management Right
$category_util->checkManage($node_id, null, true, CB_DATABASE_NO_LOCK);

//Check Category ID
require_once('link/resources.csp');
$node_id = $node_id ? $node_id : GRN_LINK_CATEGORY_ROOT_ID;

//Create Parameter Translation for Category
$translation_map_category = [
    'nid'         => '_id',          //Category ID
    'name'        => 'name',         //Cattegory Name
    'foreign_key' => 'foreign_key',  //Cattegory Foregin Key
    'memo'        => 'memo',         //Category Memo
    'child_count' => 'num_children', //Children Category Count
];

//Get Category for View
$category_for_view = $category_util->getView($node_id,
    $translation_map_category, null, true, CB_DATABASE_NO_LOCK);

//Get Child Category List for View
$child_category_list_for_view = $category_util->getChildListView($node_id,
    $translation_map_category, CB_DATABASE_NO_LOCK);

//Get Tree Category List for View
$tree_category_list_for_view = $category_util->getTreeListView($node_id,
    $translation_map_category, false, false, CB_DATABASE_NO_LOCK);

//Create Category Information
$category_information_for_view = $category_for_view;
$category_information_for_view['children'] = $child_category_list_for_view;
$category_information_for_view['ancestors'] = $tree_category_list_for_view;

//Assign Category
$node =& $category_information_for_view;

//Assign Smarty Variable
if (isset($t) && ! is_null($t)) {
    $t->assign('node_id', $node_id);
    $t->assign('node', $node);
}

