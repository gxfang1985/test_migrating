<?php

if (0 == strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST')) {
    global $G_INPUT;

    //Instantiate Smarty Object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //Validation Check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    $target_name = 'link/operation/import1';
    SmartyValidate::register_form($target_name);

    //Validate After POST
    if (SmartyValidate::is_valid($G_INPUT, $target_name)) {
        //Get Parameters
        $category_id = @ $G_INPUT['cid'];        //Category ID
        $charset = @ $G_INPUT['charset'];    //Charactor Set
        $skip = @ $G_INPUT['skip'];       //Skip First Line Flag
        $category_id = $category_id ? $category_id : GRN_LINK_CATEGORY_ROOT_ID;

        //Get Category Controller Utility
        require_once('link/controller_util.csp');
        $category_util = GRN_Link_Category_Controller_Utility::getInstance();
        $category_util->setType('manage');

        //Check Access Right
        $category_util->checkAccess($category_id, null, true);

        //Check Management Right
        $category_util->checkManage($category_id, null, true);

        //Get Session
        require_once('fw/session_manager.csp');
        $target_name = 'link/operation/import1';
        $session_manager = CB_SessionManager::getInstance();
        $session =& $session_manager->getSession($target_name);

        //Get Temporary File From Session
        $file_infos = $session->getFiles('import_files');
        if (is_array($file_infos)) {
            foreach (array_keys($file_infos) as $id) {
                $session->unsetFile('import_files', $id);
            }
        }

        //Check Temporary File
        $file = $_FILES['file'];
        if ($file['error']) {
            cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
        }

        //Add Temporary File to Session
        $file_id = $session->addFile('import_files', $file);

        //Validation Session Finished
        SmartyValidate::unregister_form($target_name);

        //Redirect Next Page
        cb_redirect('link/operation/import2', [
            'charset' => $G_INPUT['charset'],
            'skip'    => $G_INPUT['skip'],
            'file'    => $file_id,
            'cid'     => $category_id
        ]);
    } else {
        //Include Sharing Codes With Command_*
        include('_import1.csp');

        //Assign Post Parameters
        $t->assign('charset', cb_at($G_INPUT, 'charset'));
        $t->assign('skip', cb_at($G_INPUT, 'skip'));

        //Assign Template Name
        $t->setPageInfo($target_name);

        //Display Previous Page
        $t->display($target_name . '.tpl');
    }
}


