<?php

global $G_INPUT;

//Instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get Parameters
$category_id = @ $G_INPUT['cid'];                                 //Category ID
$charset
    = @ $G_INPUT['charset'];                             //Charactor Set
$skip = @ $G_INPUT['skip'] ? intval($G_INPUT['skip'])
    : 0; //Skip First Line Flag
$file_id
    = @ $G_INPUT['file'];                                //Temporary File ID
$category_id = $category_id ? $category_id : GRN_LINK_CATEGORY_ROOT_ID;

//Get Category Controller Utility
require_once('link/controller_util.csp');
$category_util = GRN_Link_Category_Controller_Utility::getInstance();
$category_util->setType('manage');

//Check Access Right
$category_util->checkAccess($category_id, null, true);

//Check Management Right
$category_util->checkManage($category_id, null, true);

//Get Default Charactor Set
if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

//Get Temporaruy File From Session
require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session =& $sm->getSession('link/operation/import1');
$files = $session->getFiles('import_files');
if ( ! array_key_exists($file_id, $files)) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

//Create CSV Reader
require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

//Get Sample Line Data
$lines = [];
$read_lines = 5;
for ($i = 0; $i < $read_lines; $i++) {
    if (($line = $csv->readLine()) !== false) {
        //Skip First Line
        if ($skip == 1 && $i == 0) {
            continue;
        }

        //Padding Last Line
        if (count($line) == 3 && ! array_key_exists(3, $line)) {
            $line[3] = "";
        }

        $lines[] = $line;
    } else {
        break;
    }
}

//Assign Category ID
$t->assign('category_id', $category_id);
//Assign Charactor Set
$t->assign('charset', $charset);
//Assign Skip First Line Flag
$t->assign('skip', $skip);
//Assign Temporary File ID
$t->assign('file', $file_id);
//Assign Sample CSV Line Data
$t->assign('lines', $lines);

//page title
$page_title = grn_get_current_page_display_name();
$t->assign('page_title', $page_title);

//site position
$t->assign('site_position', [
        [
            'page' => 'link/index',
            'name' => grn_get_page_display_name('link/index'),
            'cid'  => $category_id,
            'type' => 'share'
        ],
        ['page' => '', 'name' => $page_title]
    ]
);

//Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("{$doc_name}.tpl");


