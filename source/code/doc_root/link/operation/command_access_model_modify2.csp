<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    include('_access_util.csp');

    //Get Parameters
    $node_id = @ $G_INPUT['nid'];             //Category ID
    $security_model = @ $G_INPUT['security_model'];  //Security Model
    $node_id = $node_id ? $node_id : GRN_LINK_CATEGORY_ROOT_ID;

    //Get Category Controller Utility
    require_once('link/controller_util.csp');
    $category_util = GRN_Link_Category_Controller_Utility::getInstance();
    $category_util->setType('manage');

    //Check Management Right
    $category_util->checkManage($node_id, null, true);

    //Set Security Model
    require_once('link/access_logic.csp');
    $category_access_logic = GRN_Link_Category_Access_Logic::getInstance();
    $category_access_logic->setSecurityModel($node_id, $security_model);

    //Refresh Category Cache
    require_once('link/category_information_manager_base.csp');
    $system_category_information_manager_base
        = GRN_Link_System_Category_Information_Manager_Base::getInstance();
    $system_category_information_manager_base->refreshCache(null, true);

    //Keep Login User Access Right
    if ( ! $category_util->checkAccess($node_id, null, false)) {
        global $G_link_login_user;
        $authorities = ['browse' => 1];
        $category_access_logic->addAccess($node_id,
            $G_link_login_user->getOID(), GRN_LINK_ACCESS_TARGET_TYPE_USER,
            $authorities);
    }

    $params = $G_INPUT;
    unset($params['security_model']);

    //Redirect Next Page
    cb_redirect('link/operation/access_list', $params);
}

