<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    //Get Parameters
    $category_id = @ $G_INPUT['cid'];         //Category ID
    $charset = @ $G_INPUT['charset'];     //Charactor Set
    $skip = @ $G_INPUT['skip'];        //Skip First Line Flag
    $file_id = @ $G_INPUT['file'];        //Temporary File ID
    $category_id = $category_id ? $category_id : GRN_LINK_CATEGORY_ROOT_ID;

    //Get Category Controller Utility
    require_once('link/controller_util.csp');
    $category_util = GRN_Link_Category_Controller_Utility::getInstance();
    $category_util->setType('manage');

    //Check Access Right
    $category_util->checkAccess($category_id, null, true);

    //Check Management Right
    $category_util->checkManage($category_id, null, true);

    //Get Default Charactor Set
    if ( ! $charset) {
        global $G_config_common;
        $charset = $G_config_common->get('I18N', 'default_external_encoding');
    }

    //Get Temporaruy File From Session
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $session =& $sm->getSession('link/operation/import1');
    $files = $session->getFiles('import_files');
    if ( ! array_key_exists($file_id, $files)) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
    }

    //Create CSV Reader
    require_once('fw/csv.csp');
    $csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

    //Import Link
    $first = true;
    require_once('link/link_logic.csp');
    $long_logic = GRN_Link_System_Link_Logic::getInstance();
    while (false !== ($line = $csv->readLine())) {
        //Check Skip First Line Flag
        if ($skip && $first) {
            $first = false;
            continue;
        }

        //Import Link
        $link = $long_logic->import($category_id, $line);

        //Check Inspection Message Enabled
        require_once('link/inspection.csp');
        $inspection = GRN_Link_Inspection::getInstance();
        if ($inspection->isEnabled()) {
            //Get Category Object
            require_once('link/category_logic.csp');
            $category_logic = GRN_Link_System_Category_Logic::getInstance();
            $category =& $category_logic->get($category_id);

            //Write Inspection Message
            $message_args['lid']
                = $link->getOID();                          //Link ID
            $message_args['cid']
                = $category->getOID();                      //Category ID
            $message_args['link_name']
                = $link->get(GRN_LINK_PROPERTY_NAME);       //Link Name
            $message_args['category_name']
                = $category->get(GRN_LINK_PROPERTY_NAME);   //Category Name

            //Record Inspection
            $inspection->writeInspectionLog('import', 'system_link',
                $message_args);
        }
    }

    //Redirect Next Page
    cb_redirect('link/index', ['cid' => $category_id, 'type' => 'share']);
}
