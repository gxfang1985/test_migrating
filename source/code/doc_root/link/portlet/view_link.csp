<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get User
global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$user = $uum->getLoginUser();

// instantiate an Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

//Get navi parameter
require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
$user_config = $cm->getUserConfig($user);
$subject_width = $user_config->getSubjectWidth();
$t->assign('subject_width', $subject_width);


//Initialize Portlet Settings
if ( ! array_key_exists('settings', $portlet)) {
    //Check Portal Type
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    /** @var GRN_Portal_Application $app_portal */
    $app_portal = $app_locator->getInstance('portal');

    //Initialize Portlet Settings
    $portlet['settings'] = [];
    if ($app_portal->isSystemPortal($portlet['pid'])) {
        $portlet['settings']['type'] = 'share';
    } else {
        $portlet['settings']['type'] = 'personal';
    }
    $portlet['settings']['cid'] = GRN_LINK_CATEGORY_ROOT_ID;
    $portlet['settings']['font_size'] = 'normal';
    $portlet['settings']['col_size'] = '1';
}

//Create Parameter Translation Map
$translation_map_link = [
    'lid'   => '_id',      //Link ID
    'title' => 'name',     //Link Name
    'url'   => 'url',      //Link Name
    'sid'   => 'sid',      //SSO Method ID
    'type'  => 'type',     //Link Type
];

//Create Parameter Translation Map
$translation_map_category = [
    'cid'   => '_id',  //Category ID
    'title' => 'name', //Category Name
];

//Get Link and Category Controller Utility
require_once('link/controller_util.csp');
$link_util = GRN_Link_Link_Controller_Utility::getInstance();
$category_util = GRN_Link_Category_Controller_Utility::getInstance();
$link_util->setType($portlet['settings']['type']);
$category_util->setType($portlet['settings']['type']);

//Get Category List
require_once('link/category_information_logic_base.csp');
if ($portlet['settings']['type'] == 'personal') {
    $category_logic
        = GRN_Link_Personal_Category_Information_Logic_Base::getInstance();
} else {
    $category_logic
        = GRN_Link_System_Category_Information_Logic_Base::getInstance();
}
$category_list = $category_logic->getList(null, CB_DATABASE_NO_LOCK, false);

//Check Category Exists
if (array_key_exists($portlet['settings']['cid'], $category_list)) {
    //Check Access Right
    if ($category_util->checkAccess($portlet['settings']['cid'], null, false,
        CB_DATABASE_NO_LOCK)
    ) {
        //Get Category for View
        $category_for_view
            = $category_util->getView($portlet['settings']['cid'],
            $translation_map_category, null, false, CB_DATABASE_NO_LOCK);

        //Get Link List for View
        $link_list_for_view = $link_util->getListView($translation_map_link,
            $portlet['settings']['cid'], CB_DATABASE_NO_LOCK);

        //Create Link Information for View
        $link_information_for_view = [];
//      if ($portlet['settings']['type'] != 'personal' && $portlet['settings']['sid'] != 0)
        if ($portlet['settings']['type'] != 'personal') {
            foreach (array_keys($link_list_for_view) as $link_id) {
                $link_list_for_view[$link_id]['sso_param'] = [
                    'system_link'     => $link_id,
                    'system_category' => $portlet['settings']['cid']
                ];
            }
            $link_information_for_view = $link_list_for_view;
        } else {
            $link_information_for_view = $link_list_for_view;
        }
    } else {
        //Can't Access
        $link_information_for_view = [];
        $category_for_view = [];
    }
} else {
    //Not Avaliable
    $link_information_for_view = [];
    $category_for_view = [];
}

//Get Popup Setting
$config_list = $link_util->getGeneralConfig();

//Get Management Right
if ($portlet['settings']['type'] != 'personal' && is_array($category_for_view)
    && count($category_for_view)
) {
    //Check Management Right
    $category_util->setType('manage');
    $management = $category_util->checkManage($portlet['settings']['cid'], null,
        false, CB_DATABASE_NO_LOCK);
} else {
    $management = 0;
}

//Get Column Setting
$col_size = $portlet['settings']['col_size'];
$portlet['settings']['col_width'] = floor(100 / $col_size);
$portlet['settings']['col_span'] = 2 * $col_size;

//Assign Portlet Settings
$t->assign('settings', $portlet['settings']);
//Assign Link
$t->assign('link', $link_information_for_view);
//Assign Category
$t->assign('category', $category_for_view);
//Assign Set Popup
$t->assign('set_popup', $config_list['popup_set']);
//Assign Management
$t->assign('management', $management);

//Set Page Title
if ($portlet['title'] === '') {
    global $G_portal_app_name;
    $page_title = cb_plain_msg('grn.link', 'portlet_view_link',
        ['app_name' => $G_link_app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);
$t->assign('display_name_mode', $portlet['display_name_mode']);

// Ignore Licence Warnning
$t->skipWarning();

// Display Smarty Template
$doc_name = cb_get_pagename();
$t->display("link/portlet/view_link.tpl");


