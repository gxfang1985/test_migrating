<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

if ( ! array_key_exists('hid', $G_INPUT) || strlen($G_INPUT['hid']) < 1
     || $G_INPUT['hid'] < 1
) {
    require_once('cabinet/table.csp');
    $folder_id = GRN_CABINET_ROOT_FOLDER_ID;
} else {
    $folder_id = $G_INPUT['hid'];
}

$t->assign('folder_id', $folder_id);

require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

// GRN35-209
if (@$G_INPUT['hid']) {
    $utility->prepareMakeSitePosition($t, @$G_INPUT['hid']);
} else {
    $page_path = [
        'cabinet/index' => ['hid' => @$G_INPUT['hid']]
    ];
    $utility->setSitePosition($t, $page_path);
}
// GRN35-209

// _folder_select.csp を直に取り込み

if ( ! isset($set_folder_id)) {
    $set_folder_id = $folder_id;

    if (array_key_exists('s_hid', $G_INPUT) && strlen($G_INPUT['s_hid']) > 0) {
        $set_folder_id = $G_INPUT['s_hid'];
    }
}

$t->assign('folder_id', $folder_id);
$t->assign('set_folder_id', $set_folder_id);


// セッションに保存した購読フォルダを取得

require_once('fw/session_manager.csp');
$session_manager = CB_SessionManager::getInstance();

if (isset($target_name)) {
    $session =& $session_manager->getSession($target_name);
} else {
    $session =& $session_manager->getSession(cb_get_pagename());
}

if ( ! isset($session_id)) {
    $session_id = 'folder_select';
}

if ( ! array_key_exists('ss', $G_INPUT) || ! $G_INPUT['ss']) {
    // 初期化

    require_once('cabinet/notification.csp');
    $nm = GRN_Cabinet_NotificationManager::getInstance();
    $notified_folders = $nm->getNotifiedFolders($G_cabinet_login);
    $candidate_folders = $nm->getSubscribedFolders($G_cabinet_login);


    $for_session = [];
    foreach (array_keys($notified_folders) as $key) {
        $item =& $notified_folders[$key];

        $for_session[$key] = [
            'hid'  => $item->getOID(),
            'name' => $item->get('name'),
        ];
    }
    $notified_folders = $for_session;

    $for_session = [];
    foreach (array_keys($candidate_folders) as $key) {
        $item =& $candidate_folders[$key];

        require_once('cabinet/functions.csp');

        $notified = null;

        if (array_key_exists($key, $notified_folders)) {
            $notified = true;
        }

        $for_session[$key] = [
            'hid'      => $item->getOID(),
            'name'     => $item->get('name'),
            'path'     => grn_cabinet_get_folder_path_string($item),
            'notified' => $notified,
        ];
    }
    $candidate_folders = $for_session;
} else {
    $notified_folders = $session->get($session_id . '_notified');
    $candidate_folders = $session->get($session_id . '_candidate');

    if (is_null($notified_folders)) {
        $notified_folders = [];
    }
    if (is_null($candidate_folders)) {
        $candidate_folders = [];
    }
}

// 検索
if (array_key_exists('text', $G_INPUT)) {
    // フォルダ検索

    $result_for_view = [];

    if (array_key_exists('text', $G_INPUT) && strlen($G_INPUT['text']) > 0) {
        $t->assign('text', $G_INPUT['text']);

        require_once('cabinet/folder.csp');
        $cm = GRN_Cabinet_FolderManager::getInstance();

        // 検索実行
        $folders = $cm->search($G_cabinet_login, $G_INPUT['text']);

        require_once('cabinet/functions.csp');

        // 検索結果
        foreach (array_keys($folders) as $hid) {
            $item =& $folders[$hid];

            $notified = null;
            if (array_key_exists($hid, $notified_folders)) {
                $notified = true;
            }

            $subscribed = null;
            if (array_key_exists($hid, $candidate_folders)) {
                $subscribed = true;
            }

            $result_for_view[$hid] = [
                'name'       => $item->get('name'),
                'hid'        => $hid,
                'path'       => grn_cabinet_get_folder_path_string($item),
                'notified'   => $notified,
                'subscribed' => $subscribed,
            ];
        }
    }

    $t->assign('search', [
            'result' => $result_for_view,
            'count'  => count($result_for_view),
            'text'   => $G_INPUT['text'],
        ]
    );

    if (count($result_for_view) < 1) {
        $t->assign('set_folder_id', null);
    }
} else {
    // 通常のフォルダツリーからの選択画面を表示する場合

    if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login,
        $set_folder_id))
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }

    require_once('cabinet/hierarchy.csp');
    $hierarchy = GRN_Cabinet_Hierarchy::getInstance();

    $hierarchy->setNotificationFolders(true);
    $hierarchy->setSubscriptionFolders(true);
    $hierarchy->setEnablePathString(true);

    $folder_for_view = $hierarchy->build($G_cabinet_login, $folder);

    // フォルダツリー
    $t->assign('folder', $folder_for_view);
}

$session->set($session_id . '_notified', $notified_folders);
$session->set($session_id . '_candidate', $candidate_folders);

$t->assign('candidate_folders', $candidate_folders);

if (array_key_exists($set_folder_id, $candidate_folders)) {
    $t->assign('disable_select', true);
}

$t->display(cb_get_pagename() . ".tpl");

