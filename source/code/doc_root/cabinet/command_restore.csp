<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! ($file_id = @ $G_INPUT['fid'])) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }
    if ( ! ($restore_version = @ $G_INPUT['ver'])) {
        cb_throw_error(E_GRN_CABINET_FILE_LOG_NOT_FOUND);
    }

    $folder_id = @ $G_INPUT['hid'];

    if ( ! ($file = $G_cabinet->getFile($G_cabinet_login, $file_id,
        GRN_CABINET_ACCESS_W))
    ) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }
    if ($file->isInTrash())       // Huy added
    {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    $file->restore($G_cabinet_login, $restore_version, @ $G_INPUT['comment']);

    // inspection
    require_once('cabinet/inspection.csp');
    $inspection = GRN_Cabinet_Inspection::getInstance();

    $filebody = $file->getCurrentBody();
    $title = $file->getTitle();
    if (strlen($title) === 0) {
        $title = $filebody->get('name');
    }

    if (strlen($folder_id) === 0) {
        $folder = $G_cabinet->getFileFolder($file);
        if ( ! is_null($folder)) {
            $folder_id = $folder->getOID();
        } else {
            $folder_id = '0';
        }
    }

    if (FtsApplication::isAvailable()) {
        $searchService = new IndexService();
        $searchService->updateFileIndex($file);
    }

    // Write log: resotre file
    require_once('cabinet/inspection.csp');
    $inspection = GRN_Cabinet_Inspection::getInstance();
    $inspection->writeLogFile('restore', $file, $folder_id);

    cb_redirect('cabinet/view', ['hid' => $folder_id, 'fid' => $file_id]);
}
