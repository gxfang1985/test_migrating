<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! ($file_id = @ $G_INPUT['fid'])) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    $folder_id = @ $G_INPUT['hid'];

    if (array_key_exists('upload', $G_INPUT)) {
        // ファイルをロック
        require_once('grn/ui.csp');
        $uim = GRN_UIConfigManager::getInstance();
        $uisysconf =& $uim->getSystemConfig();

        if ( ! $uisysconf->getFileLockable()) {
            require(cb_basedir() . '/code/doc_root/cabinet/upload.csp');
            cb_safe_exit();
        }
        if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id,
            GRN_CABINET_ACCESS_W))
        ) {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        if ($file->isInTrash()) {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        $lock =& $file->getLockObject();
        $lock->acquireLock();
        include_once('upload.csp');
        cb_safe_exit();

    }

    // unlock

    if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    if ($file->isInTrash())       // Huy added
    {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }


    $lock =& $file->getLockObject();
    $lock->releaseLock();

    cb_redirect('cabinet/view', ['hid' => $folder_id, 'fid' => $file_id]);

}
