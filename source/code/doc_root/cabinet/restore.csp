<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


if ( ! ($file_id = @ $G_INPUT['fid'])) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
if ( ! ($restore_version = @ $G_INPUT['ver'])) {
    cb_throw_error(E_GRN_CABINET_FILE_LOG_NOT_FOUND);
}

$folder_id = @ $G_INPUT['hid'];

$t->assign('folder_id', $folder_id);
$t->assign('file_id', $file_id);
$t->assign('restore_version', $restore_version);

$t->assign('linkparams', ['hid' => $folder_id]);

require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

// GRN35-209
if (@$G_INPUT['hid']) {
    if ( ! ($folder = $G_cabinet->getFolder($G_cabinet_login,
        $G_INPUT['hid']))
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $utility->prepareMakeSitePosition($t, @$G_INPUT['hid'], @$G_INPUT['fid']);
} else {
    $page_path = [
        'cabinet/index' => ['hid' => @$G_INPUT['hid']],
        'cabinet/view'  => [
            'hid' => @$G_INPUT['hid'],
            'fid' => @$G_INPUT['fid']
        ],
    ];

    $utility->setSitePosition($t, $page_path);
}
// GRN35-209

if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

if ($file->isInTrash())       // Huy added
{
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$restore_for_view = $utility->getFileRestoreView($file, $restore_version);

$t->assign('restore', $restore_for_view);

$t->display(cb_get_pagename() . ".tpl");

