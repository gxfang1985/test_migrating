<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // ファイルIDは必須
    if ( ! ($file_id = @ $G_INPUT['fid'])) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    $folder_id = @ $G_INPUT['hid'];

    if ( ! ($file = $G_cabinet->getFile($G_cabinet_login, $file_id,
        GRN_CABINET_ACCESS_W))
    ) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    if ($file->isInTrash())       // Huy added
    {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    $file->setTitle($G_INPUT['title']);
    $file->setDescription($G_INPUT['memo']);

    if (is_numeric(@$G_INPUT['version'])) {
        if ($G_INPUT['version'] != $file->getMaxVersion()) {
            $file->setMaxVersion($G_INPUT['version']);
        }
    }

    if (FtsApplication::isAvailable()) {
        $searchService = new IndexService();
        $searchService->updateFileIndex($file);
    }

    // Write log: modify file information
    require_once('cabinet/inspection.csp');
    $inspection = GRN_Cabinet_Inspection::getInstance();
    $inspection->writeLogFile('modify', $file, $folder_id);

    cb_redirect('cabinet/view', ['hid' => $folder_id, 'fid' => $file_id]);
}

