<?php

global $G_INPUT;

if ( ! ($file_id = @ $G_INPUT['fid'])) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$folder_id = @ $G_INPUT['hid'];
$version = @ $G_INPUT['ver'];


if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

if ($file->isInTrash()) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$body = null;

if ($version) {
    $body =& $file->getBody($version);
} else {
    $body =& $file->getCurrentBody();
}

if ( ! $body) {
    cb_throw_error(E_GRN_CABINET_FILE_LOG_NOT_FOUND);
}


if (strlen($folder_id) === 0) {
    $folder =& $G_cabinet->getFileFolder($file);
    $folder_id = $folder->getOID();
}
//Write log: download file
require_once('cabinet/inspection.csp');
$inspection = GRN_Cabinet_Inspection::getInstance();
$inspection->writeLogFile('download', $file, $folder_id);

//$body->download( array_key_exists( 'inline', $G_INPUT ) );
$body->download(true);

cb_safe_exit();


