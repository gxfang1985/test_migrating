<?php

require_once('cabinet/folder_util.csp');
global $G_cabinet;
global $G_cabinet_login;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

if ( ! isset($folder_id)) {
    if ( ! array_key_exists('hid', $G_INPUT)) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $folder_id = $G_INPUT['hid'];
}

if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login, $folder_id))) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

// folder infor.

$folder_for_view['id'] = $folder->getOId();
$folder_for_view['name'] = $folder->get('name');
$folder_for_view['size'] = $folder->getFolderSize($G_cabinet_login);
if (($folder_for_view['size'] > 0) && ($folder_for_view['size'] < 1024)) {
    $folder_for_view['size'] = 1024;
}

$t->assign('folder', $folder_for_view);

// sub folder infor.

$offset = $utility->getListOffset();
if (is_null($limit = $G_cabinet_ui_config->getListMax())) {
    $limit = 20;
}

$fs_list = new GRN_Cabinet_FolderSizeList($G_cabinet_login, $folder);
$fs_list->setOffSet($offset);
$fs_list->setLimit($limit);

$order_column = $utility->getListOrderColumn(null,
    'fsd');  // default sort by size (descending)

$t->assign('sort', $order_column['param']);

if ($order_column['param'] == 'fsu') {
    $fs_list->sortBySize(true, false);
}

$sub_folders = [];
$sub_folders = $fs_list->getFolderListView();
foreach ($sub_folders as $id => $item) {
    if (($item['size'] > 0) && ($item['size'] < 1024)) {
        $sub_folders[$id]['size'] = 1024;
    }
}

$t->assign('sub_folders', $sub_folders);

// navi.

$navi_for_view = [];
$navi_for_view = $utility->makeNaviInformation($offset,
    $limit, $fs_list->count());
$navi_for_view['navi']['params'] = [
    'hid'  => $folder ? $folder->getOID() : 0,
    'sort' => $order_column['param']
];

$t->assign('navi', $navi_for_view);


