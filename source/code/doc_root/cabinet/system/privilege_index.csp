<?php

global $G_INPUT;

//-- instantiate Smarty object
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$node_id = null;

if (array_key_exists('nid', $G_INPUT)
    && $G_INPUT['nid'] != GRN_CABINET_ROOT_FOLDER_ID
) {
    $node_id = $G_INPUT['nid'];   // folder id
}

// --- folder tree
$tree_info = [
    'link_url' => 'cabinet/system/privilege_index',
    'oid_key'  => 'nid'
];
$tree_selected_oid = $node_id;
include('../_folder_tree.csp');
$node_id = $tree_selected_oid ? $tree_selected_oid : GRN_CABINET_ROOT_FOLDER_ID;
// --- end: folder tree

//--folder tree
$node_row =& $G_cabinet->getFolder($G_cabinet_login, $node_id);
if ( ! $node_row) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

require_once('cabinet/hierarchy.csp');
$hierarchy = GRN_Cabinet_Hierarchy::getInstance();
$node = $hierarchy->build($G_cabinet_login, $node_row);

//--privilege information
if ($node_id) {
    require_once('grn/access_resources.csp');

    $privilege = [];

    //-- prepare cabinet privilege manager
    require_once('cabinet/privilege.csp');
    $am = GRN_Cabinet_PrivilegeManager::getInstance();

    $targets = $am->getTargets($node_row, null);

    $privilege_list = [];
    foreach ($targets as $class_type => $privileges) {
        switch ($class_type) {
            case 'cb_user':
                $type = GRN_ACCESS_TARGET_TYPE_USER;
                break;
            case 'cb_group':
                $type = GRN_ACCESS_TARGET_TYPE_GROUP;
                break;
            case 'cb_role':
                $type = GRN_ACCESS_TARGET_TYPE_STATIC_ROLE;
                break;
            default:
                $type = GRN_ACCESS_TARGET_TYPE_DYNAMIC_ROLE;
                break;
        }

        foreach ($privileges as $key => $authorities) {
            $privilege_list[] = [
                'type' => $type,
                'tid'  => $key,
                'data' => $authorities
            ];
        }
    }

    $privilege['list'] = $privilege_list;
    $privilege['count'] = count($privilege['list']);
}

$t->assign('node_id', $node_id);
$t->assign('node', $node);
$t->assign('privilege', @ $privilege);
$t->assign('is_root', ! $node_id);


require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

$utility->setSitePosition($t, null);

$t->display(cb_get_pagename() . ".tpl");

