<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

$page_path = [
    'cabinet/system/import_index' => [],
];

$utility->setSitePosition($t, $page_path);

if ( ! @ $G_INPUT['file_id']) {
    cb_throw_error(E_GRN_CSV_FILE_NOT_FOUND);
}

$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
$file_id = $G_INPUT['file_id'];

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

$t->assign('charset', $charset);
$t->assign('skip', $skip);
$t->assign('file_id', $file_id);

require_once('fw/session_manager.csp');
$sm = CB_SessionManager::getInstance();
$session =& $sm->getSession('cabinet/system/folder_import1');

$files = $session->getFiles('import_files');

if ( ! $files || ! array_key_exists($file_id, $files)) {
    cb_throw_error(E_GRN_CABINET_TEMPORALY_FILE_NOT_FOUND);
}


require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $files[$file_id]->getPath());

// 表示するサンプルの行数
$read_lines = 5;

// サンプル行の読み込み
$lines = [];

$count = 0;
while (($line = $csv->readLine()) !== false) {

    if ($skip > 0) {
        $skip--;
        continue;
    }

    $lines[] = $line;

    $count++;

    if ($count >= $read_lines) {
        break;
    }
}

$t->assign('csv_datas', $lines);

$t->display(cb_get_pagename() . ".tpl");

