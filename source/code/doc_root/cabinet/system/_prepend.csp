<?php

require_once('grn/application.csp');

$locator = GRN_ApplicationLocator::instance();
global $G_cabinet;
$G_cabinet = null;
if ( ! ($G_cabinet = $locator->getInstance('cabinet'))) {
    cb_throw_error(E_GRN_CABINET_DEACTIVATED);
}
unset($locator);

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
global $G_cabinet_login;
$G_cabinet_login = $uum->getLoginUser();
unset($uum);

require_once('cabinet/cabinet_util.csp');
global $G_cabinet_util;
$G_cabinet_util = GRN_Cabinet_Util::getInstance();

require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
global $G_cabinet_ui_config;
$G_cabinet_ui_config = $cm->getUserConfig($G_cabinet_login);
unset($cm);

//GTM-528
global $G_INPUT;
$white_list = [
    'cabinet/system/folder_list',
    'cabinet/system/folder_restore',
    'cabinet/system/command_folder_restore',
    'cabinet/system/folder_delete_permanent',
    'cabinet/system/command_folder_delete_permanent',
    'cabinet/system/search',
];
$page_path = strtolower(cb_get_pagename());
if ( ! in_array($page_path, $white_list)) {
    if (array_key_exists('hid', $G_INPUT) && $G_INPUT['hid'] != '') {
        if (($folder = $G_cabinet->getFolder($G_cabinet_login, $G_INPUT['hid']))
            && $folder->checkDeletedFlag()
        ) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
    }
    if (array_key_exists('s_hid', $G_INPUT) && $G_INPUT['s_hid'] != '') {
        if (($folder =& $G_cabinet->getFolder($G_cabinet_login,
                $G_INPUT['s_hid']))
            && $folder->checkDeletedFlag()
        ) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
    }
    if (array_key_exists('nid', $G_INPUT) && $G_INPUT['nid'] != '') {
        if (($folder =& $G_cabinet->getFolder($G_cabinet_login,
                $G_INPUT['nid']))
            && $folder->checkDeletedFlag()
        ) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
    }
    unset($folder);
}

///////////////////////////////////////

function _cabinet_rebuild_folder_tree($expand_oid = null)
{
    require_once('cabinet/folder_tree.csp');
    $list_page = 'cabinet/system/folder_list';
    grn_cabinet_rebuild_folder_tree($list_page, $expand_oid);

    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session = $session_manager->getSession('grn.common.org_tree_util');
    $session_values = $session->getValues();
    foreach ($session_values as $key => $value) {
        $keys = explode('/', $key);
        if ($keys[0] == 'cabinet') {
            $session->unset_by($key);
        }
    }
}


