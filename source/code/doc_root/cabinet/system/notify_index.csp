<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$folder_id = null;

if (array_key_exists('nid', $G_INPUT) && strlen($G_INPUT['nid']) > 0
    && $G_INPUT['nid'] > 0
    && $G_INPUT['nid'] != GRN_CABINET_ROOT_FOLDER_ID
) {
    $folder_id = $G_INPUT['nid'];
}

// --- folder tree
$tree_info = [
    'link_url' => 'cabinet/system/notify_index',
    'oid_key'  => 'nid'
];
$tree_selected_oid = $folder_id;
include('../_folder_tree.csp');
$folder_id = $tree_selected_oid ? $tree_selected_oid
    : GRN_CABINET_ROOT_FOLDER_ID;
// --- end: folder tree

if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login, $folder_id))) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

$t->assign('node_id', $folder->getOID());
$t->assign('node_name', $folder->get('name'));


require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

$utility->setSitePosition($t, null);

require_once('cabinet/hierarchy.csp');
$hierarchy = GRN_Cabinet_Hierarchy::getInstance();
$node_for_view = $hierarchy->build($G_cabinet_login, $folder);

$notify_for_view = [];
$notify_for_view['force'] = $folder->get('force_notify');
$notify_for_view['nid'] = $folder->getOID();


require_once('grn/access_resources.csp');

$notify_list = [];

$targets = $folder->getNotificationTargets('user');
foreach (array_keys($targets) as $id) {
    $notify_list[] = ['type' => GRN_ACCESS_TARGET_TYPE_USER, 'tid' => $id];
}

$targets = $folder->getNotificationTargets('group');
foreach (array_keys($targets) as $id) {
    $notify_list[] = ['type' => GRN_ACCESS_TARGET_TYPE_GROUP, 'tid' => $id];
}

$targets = $folder->getNotificationTargets('role');
foreach (array_keys($targets) as $id) {
    $notify_list[] = [
        'type' => GRN_ACCESS_TARGET_TYPE_STATIC_ROLE,
        'tid'  => $id
    ];
}

$targets = $folder->getNotificationTargets('dynamic_role');
foreach (array_keys($targets) as $id) {
    $notify_list[] = [
        'type' => GRN_ACCESS_TARGET_TYPE_DYNAMIC_ROLE,
        'tid'  => $id
    ];
}

$notify_for_view['list'] = $notify_list;
$notify_for_view['count'] = count($notify_list);

$t->assign('node', $node_for_view);
$t->assign('notify', $notify_for_view);
$t->assign('enable_force', 1);

$t->display(cb_get_pagename() . ".tpl");

