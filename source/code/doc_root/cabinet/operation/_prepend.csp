<?php

require_once('grn/application.csp');

$locator = GRN_ApplicationLocator::instance();
global $G_cabinet;
$G_cabinet = null;
if ( ! ($G_cabinet =& $locator->getInstance('cabinet'))) {
    cb_throw_error(E_GRN_CABINET_DEACTIVATED);
}
unset($locator);

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
global $G_cabinet_login;
$G_cabinet_login =& $uum->getLoginUser();
unset($uum);

require_once('cabinet/cabinet_util.csp');
global $G_cabinet_util;
$G_cabinet_util = GRN_Cabinet_Util::getInstance();

require_once('grn/ui.csp');
$cm = GRN_UIConfigManager::getInstance();
global $G_cabinet_ui_config;
$G_cabinet_ui_config =& $cm->getUserConfig($G_cabinet_login);
unset($cm);

global $G_INPUT;
$hid = cb_at($G_INPUT, 'hid');
$nid = cb_at($G_INPUT, 'nid');

if ( ! $hid && ! $nid) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

if ($hid) {
    if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login, $hid))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    if ( ! $folder->privileged($G_cabinet_login, ['operation'])) {
        cb_throw_error(E_GRN_CABINET_OPERATION_NOT_GRANTED);
    }
}

if ($nid) {
    if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login, $nid))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    if ( ! $folder->privileged($G_cabinet_login, ['operation'])) {
        cb_throw_error(E_GRN_CABINET_OPERATION_NOT_GRANTED);
    }
}

if (array_key_exists('s_hid', $G_INPUT) && $G_INPUT['s_hid'] != '') {
    if (($folder =& $G_cabinet->getFolder($G_cabinet_login, $G_INPUT['s_hid']))
        && $folder->checkDeletedFlag()
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
}

unset($folder, $hid, $nid);

///////////////////////////////////////

function _cabinet_rebuild_folder_tree($expand_oid = null)
{
    require_once('cabinet/folder_tree.csp');
    $list_page = 'cabinet/index';
    grn_cabinet_rebuild_folder_tree($list_page, $expand_oid);
}


