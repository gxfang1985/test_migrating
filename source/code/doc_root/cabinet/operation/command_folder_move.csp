<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    if ( ! @ $G_INPUT['hid']
         || ! ($folder
            =& $G_cabinet->getFolder($G_cabinet_login, $G_INPUT['hid']))
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    if ( ! @ $G_INPUT['s_hid']
         || ! ($parent
            =& $G_cabinet->getFolder($G_cabinet_login, $G_INPUT['s_hid']))
    ) {
        cb_throw_error(E_GRN_CABINET_INVAID_PARENT_FOLDER);
    }
    if ( ! $folder->isMovable($G_cabinet_login)) {
        cb_throw_error(E_GRN_CABINET_INVAID_PARENT_FOLDER);
    }
    $oldParentId = 0;
    $oldParent = $folder->get('parent');
    if ( ! is_null($oldParent)) {
        $oldParentId = $oldParent->getOID();
    }
    $folder->setParent($G_cabinet_login, $parent);

    _cabinet_rebuild_folder_tree($G_INPUT['s_hid']);

    // Write log: Move folder
    require_once('cabinet/inspection.csp');
    $inspection = GRN_Cabinet_Inspection::getInstance();
    $inspection->writeLogFolder('move', $folder, $oldParentId);

    cb_redirect('cabinet/operation/folder_view', ['hid' => $folder->getOID()]);
}
