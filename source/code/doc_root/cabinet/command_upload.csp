<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    $target_name = 'cabinet/upload';

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    if (@ $G_INPUT['cancel'] || (is_array($files) && count($files) == 1)) {
        if ( ! ($file_id = @ $G_INPUT['fid'])) {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        if ( ! ($file = $G_cabinet->getFile($G_cabinet_login, $file_id,
            GRN_CABINET_ACCESS_W))
        ) {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        if ($file->isInTrash())       // Huy added
        {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        $folder_id = @ $G_INPUT['hid'];

        if ( ! @ $G_INPUT['cancel']) {
            // キャンセルでなければ更新
            $uploaded_file = array_pop($files);
            $file->update($G_cabinet_login, $uploaded_file,
                $G_INPUT['comment']);
            if (FtsApplication::isAvailable()) {
                $searchService = new IndexService();
                $searchService->updateFileIndex($file);
            }

            //Write log: update file
            require_once('cabinet/inspection.csp');
            $inspection = GRN_Cabinet_Inspection::getInstance();
            $inspection->writeLogFile('update', $file, $folder_id);
        }

        $lock = $file->getLockObject();
        $lock->releaseLock();

        if (array_key_exists('index_return', $G_INPUT)) {
            cb_redirect('cabinet/index', ['hid' => $folder_id]);
        } else {
            cb_redirect('cabinet/view',
                ['hid' => $folder_id, 'fid' => $file_id]);
        }

    } else {
        $t->assign('err_no_file', true);
        $t->setPageInfo($target_name);

        include('_upload.csp');

        //generate upload ticket
        include('grn/_upload_prepend.csp');

        $upload_ticket = cb_at($G_INPUT, 'upload_ticket');
        $comment = cb_at($G_INPUT, 'comment');
        $index_return = cb_at($G_INPUT, 'index_return');
        $t->assign('upload_ticket', $upload_ticket);
        $t->assign('comment', $comment);
        $t->assign('index_return', $index_return);

        $t->display("{$target_name}.tpl");
    }
}

