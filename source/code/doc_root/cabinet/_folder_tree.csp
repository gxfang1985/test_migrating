<?php

require_once('grn/org_tree.csp');
require_once('cabinet/folder_tree.csp');

if ( ! isset($tree_name)) {
    $tree_name = cb_get_pagename();
}

if ( ! isset($is_system)) {
    $page_parts = explode('/', cb_get_pagename());
    $is_system = (@$page_parts[1] === 'system');
}
if ( ! isset($force_hide_notification)) {
    $force_hide_notification = null;
}
if ( ! isset($view_checkbox)) {
    $view_checkbox = null;
}

$util = GRN_OrgTreeUtil::getInstance();
$tree =& $util->getTree($tree_name, 'GRN_Cabinet_FolderTree', [
    'system'                  => $is_system,
    'force_hide_notification' => $force_hide_notification,
    'checkbox'                => $view_checkbox
]);

$tree_for_view = [];
if (is_null($tree_selected_oid) && ! array_key_exists('sf', $G_INPUT)) {
    $tree_selected_oid = $tree->getSelectedNode();
}
if (array_key_exists('top', $G_INPUT) || is_null($tree->getRoot())) {
    if ( ! array_key_exists('sf', $G_INPUT) || is_null($tree->getRoot())) {
        $tree->initialize();
    }

    if (array_key_exists('top', $G_INPUT)) {
        $tree_selected_oid = null;
    }
}

$tree->setSelectedNode($tree_selected_oid);
$util->setTree($tree_name, $tree);

// ルートフォルダを取得
if ( ! @$root_folder) {
    if ( ! ($root_folder = $G_cabinet->getFolder($G_cabinet_login,
        GRN_CABINET_ROOT_FOLDER_ID))
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
}

$tree_for_view = [
    'page_name'    => $tree_name,
    'root'         => $tree->getRoot(),
    'async_url'    => $is_system ? 'cabinet/system/folder_json'
        : 'cabinet/folder_json',
    'link_url'     => null,
    'selected_oid' => $tree_selected_oid,
    'root_caption' => $root_folder->get('name'),
];

if (isset($tree_info) && is_array($tree_info)) {
    $tree_for_view = $tree_info + $tree_for_view;
}

$t->assign('folder_tree', $tree_for_view);

