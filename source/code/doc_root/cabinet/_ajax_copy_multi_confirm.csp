<?php
if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    $hid = null;
    if ( ! array_key_exists('hid', $G_INPUT) || strlen($G_INPUT['hid']) < 1) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $hid = $G_INPUT['hid'];

    $target_ids = null;
    if ( ! array_key_exists('ids', $G_INPUT)) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $target_ids = $G_INPUT['ids'];

    require_once('cabinet/folder.csp');
    $factory = GRN_Cabinet_FolderFactory::getInstance();
    if ( ! ($folder = $factory->get($hid))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $folder_name = $folder->get('name');
    $source_info = ['key' => 'hid', 'id' => $hid, 'name' => $folder_name];
    $t->assign('source_info', $source_info);

    $page_parts = explode('/', cb_get_pagename());
    $is_system = (@$page_parts[1] === 'system');

    $target_list = [];
    foreach ($target_ids as $id) {
        if ( ! ($folder = $factory->get($id))) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
        if ( ! $is_system) {
            $folder->privileged($G_cabinet_login, ['operation'], true);
        }

        $folder_name = $folder->get('name');
        $target_list[] = ['id' => $id, 'name' => $folder_name];
    }
    $targets = [];
    $targets['list'] = $target_list;
    $targets['count'] = count($targets['list']);
    $t->assign('targets', $targets);

    $t->display(cb_get_pagename() . ".tpl");
}
