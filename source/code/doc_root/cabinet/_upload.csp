<?php

global $G_INPUT;

// ファイルIDは必須
if ( ! ($file_id = @ $G_INPUT['fid'])) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
$folder_id = @ $G_INPUT['hid'];

$t->assign('folder_id', $folder_id);
$t->assign('file_id', $file_id);

require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

if ($folder_id) {
    if ( ! ($folder = $G_cabinet->getFolder($G_cabinet_login, $folder_id))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
}

// GRN35-209
if (array_key_exists('index_return', $G_INPUT)) {
    if ($G_INPUT['hid']) {
        $utility->prepareMakeSitePosition($t, $G_INPUT['hid']);
    } else {
        $page_path = [
            'cabinet/index' => ['hid' => @$G_INPUT['hid']]
        ];
        $utility->setSitePosition($t, $page_path);
    }
} else {
    if ($G_INPUT['hid']) {
        $utility->prepareMakeSitePosition($t, $G_INPUT['hid'], $G_INPUT['fid']);
    } else {
        $page_path = [
            'cabinet/index' => ['hid' => @$G_INPUT['hid']],
            'cabinet/view'  => [
                'hid' => @$G_INPUT['hid'],
                'fid' => @$G_INPUT['fid']
            ],
        ];

        $utility->setSitePosition($t, $page_path);
    }
}
// GRN35-209

// ファイルを取得
//GRN35-512
if ( ! ($file = $G_cabinet->getFile($G_cabinet_login, $file_id,
    GRN_CABINET_ACCESS_W))
) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
//GRN35-512
if ($file->isInTrash())       // Huy added
{
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$t->assign('locked', 'false');
require_once('grn/ui.csp');
$uim = GRN_UIConfigManager::getInstance();
$uisysconf = $uim->getSystemConfig();

if ($uisysconf->getFileLockable()) {
    // Lock the file
    $lock = $file->getLockObject();
    $lock->acquireLock();
    $t->assign('locked', 'true');
}

// オブジェクトから表示データ取得
$file_for_view = $utility->getFileView($file);

// ファイル表示データ
$t->assign('file', $file_for_view);
if (isset($G_INPUT['index_return'])) {
    $t->assign('index_return', 'index_return');
}
// アプリ固有リンクパラメータ（インクルードするファイル画面用）
$t->assign('linkparams', ['hid' => $folder_id]);


