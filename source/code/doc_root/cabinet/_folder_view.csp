<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

if ( ! isset($utility) || ! is_a($utility, 'GRN_Cabinet_ControllerUtil')) {
    require_once("cabinet/controller.csp");
    $utility = new GRN_Cabinet_ControllerUtil();
}

if ( ! array_key_exists('hid', $G_INPUT)) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}
$folder_id = $G_INPUT['hid'];

if ( ! ($folder = $G_cabinet->getFolder($G_cabinet_login, $folder_id))) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}
$t->assign('folder_id', $folder_id);


// 選択されたフォルダの情報を取得

$folder_for_view = [];
$folder_for_view['hid'] = $folder->getOID();
$folder_for_view['name'] = $folder->get('name');
$folder_for_view['memo'] = $folder->get('description');
$folder_for_view['foreign_key'] = $folder->get('foreign_key');
$folder_for_view['file_count'] = $folder->getNumFiles();

$utility->getCreatorView($folder, $folder_for_view);
$utility->getModifierView($folder, $folder_for_view);


// 親フォルダ情報

if (($parent =& $folder->get('parent'))) {
    $parent_for_view = [];
    $parent_for_view['hid'] = $parent->getOID();
    $parent_for_view['name'] = $parent->get('name');
    $parent_for_view['child_count'] = $parent->getNumFolders($G_cabinet_login);

    if (isset($need_prilivileges) && $need_prilivileges) {
        $parent_for_view['privileges']
            = $parent->getPrivileges($G_cabinet_login);
    }

    $folder_for_view['parent'] = $parent_for_view;
} else {
    $folder_for_view['creator_uid'] = 1;
    if (array_key_exists("modifier_uid", $folder_for_view)
        && $folder_for_view['modifier_uid'] == 0
    ) {
        $folder_for_view['modifier_uid'] = 1;
    }
}

// サブフォルダ情報の取得

$children = $folder->getFolders($G_cabinet_login);

if (count($children) > 0) {
    $children_for_view = [];
    foreach (array_keys($children) as $hid) {
        $child =& $children[$hid];
        $child_for_view = [];
        $child_for_view['name'] = $child->get('name');
        $child_for_view['hid'] = $child->getOID();
        $child_for_view['child_count']
            = $child->getNumFolders($G_cabinet_login);

        $children_for_view[$hid] = $child_for_view;
    }
    $folder_for_view['children'] = $children_for_view;
}

$folder_for_view['child_count'] = count($children);

$folder_for_view['movable'] = $folder->isMovable($G_cabinet_login);

$t->assign('folder', $folder_for_view);

