<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    require_once('grn/upload.csp');
    $files = GRN_UploadFile::getUploadedFiles(@$G_INPUT['upload_ticket'],
        @$G_INPUT['upload_fileids'], true);

    $folder_id = @ $G_INPUT['hid'];
    $set_folder_id = $G_INPUT['s_hid'];

    if ( ! ($folder = $G_cabinet->getFolder($G_cabinet_login,
        $set_folder_id))
    ) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }

    if (count($files) > 0) {
        foreach ($files as $fileid => $tmpfile) {
            $comment = @$G_INPUT['memo_' . $fileid];
            $max_version = @$G_INPUT['max_version_' . $fileid];
            $title = @$G_INPUT['title_' . $fileid];
            $file = $G_cabinet->createFile($G_cabinet_login, $folder,
                $tmpfile, null);

            if ( ! is_null($comment)) {
                $file->setDescription($comment);
            }
            if ( ! is_null($max_version)) {
                $file->setMaxVersion($max_version);
            }
            if ( ! is_null($title)) {
                $file->setTitle($title);
            }

            // Write log: create file
            require_once('cabinet/inspection.csp');
            $inspection = GRN_Cabinet_Inspection::getInstance();
            $inspection->writeLogFile("create", $file, $folder);

            $file->onCreate($G_cabinet_login);
            $G_cabinet->readFile($G_cabinet_login, $file);

            if (FtsApplication::isAvailable()) {
                $searchService = new IndexService();
                $searchService->createFileIndex($file);
            }
        }

        cb_redirect('cabinet/index', ['hid' => $folder_id]);
    } else {

        $target_name = 'cabinet/add';
        $t->setPageInfo($target_name);

        include('_add.csp');

        $t->assign('err_no_file', true);

        $upload_ticket = cb_at($G_INPUT, 'upload_ticket');
        $t->assign('upload_ticket', $upload_ticket);

        $title = cb_at($G_INPUT, 'title');
        $t->assign('title', $title);
        $max_version = cb_at($G_INPUT, 'max_version');
        $t->assign('max_version', $max_version);
        $memo = cb_at($G_INPUT, 'memo');
        $t->assign('memo', $memo);

        $t->display("{$target_name}.tpl");
    }

}

