<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}

if ( ! array_key_exists('fid', $G_INPUT) || strlen($G_INPUT['fid']) < 1
     || $G_INPUT['fid'] < 1
) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
$file_id = $G_INPUT['fid'];
$t->assign('file_id', $file_id);

if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
if ($file->isInTrash())       // Huy added
{
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
if ( ! ($folder =& $G_cabinet->getFileFolder($file))) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

$folder_id = $folder->getOID();

$body =& $file->getCurrentBody();
$title = $file->getTitle();

if (is_null($title) || strlen($title) < 1) {
    $title = $body->get('name');
}

$file_for_view = [
    'fid'      => $file->getOID(),
    'title'    => $title,
    'filename' => $body->get('name'),
];

$t->assign('file', $file_for_view);


// 現在の位置を取得

require_once('cabinet/functions.csp');

$current_for_view = [
    'hid'  => $folder->getOID(),
    'path' => grn_cabinet_get_folder_path_string($folder),
    'name' => $folder->get('name')
];

$t->assign('current', $current_for_view);

if (isset($dir_prefix)) {
    require_once($dir_prefix . '_folder_select.csp');
} else {
    require_once('_folder_select.csp');
}

// parameters for folder_select.tpl
$t->assign('params', ['fid' => $file_id]);

if ( ! isset($utility)) {
    require_once('cabinet/controller.csp');
    $utility = new GRN_Cabinet_ControllerUtil();
}

$t->assign('config', $utility->getConfigValues($G_cabinet_login));


