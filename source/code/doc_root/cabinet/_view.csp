<?php

global $G_INPUT;

if ( ! isset($t) || ! is_a($t, 'GRN_Smarty')) {
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;
}
if ( ! isset($utility) || ! is_a($utility, 'GRN_Cabinet_ControllerUtil')) {
    require_once('cabinet/controller.csp');
    $utility = new GRN_Cabinet_ControllerUtil();
}


// ファイルIDは必須
if ( ! ($file_id = @ $G_INPUT['fid'])) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}
$t->assign('file_id', $file_id);

if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

if ($file->isInTrash())     // Huy added
{
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

if ( ! ($folder =& $G_cabinet->getFileFolder($file))) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}
$folder_id = $folder->getOID();
$t->assign('folder_id', $folder_id);

$folder_for_view = [
    'hid'        => $folder->getOID(),
    'name'       => $folder->get('name'),
    'privileges' => $folder->getPrivileges($G_cabinet_login),
];

$t->assign('folder', $folder_for_view);

// GRN35-209
// ファイルリンク用のパラメータをセット 
$linkparams = [];

if ($folder_id) {
    $linkparams['hid'] = $folder_id;
}
$t->assign('linkparams', $linkparams);
// GRN35-209

// 履歴一覧先頭位置
$offset = $utility->getListOffset();

// 履歴一覧ソート
$order_column = $utility->getListOrderColumn(null, 'td');

$t->assign('sort', $order_column['param']);


// get common ui configuration
if (is_null($limit = $G_cabinet_ui_config->getListMax())) {
    $limit = 20;
}

// オブジェクトから表示データを取得
$file_for_view = $utility->getFileDetailView($file,
    $offset,
    $limit,
    $order_column['column'],
    $order_column['order']);

require_once('cabinet/functions.csp');

$file_for_view['position'] = grn_cabinet_get_folder_path_array($folder);
$file_for_view['auth'] = $folder->getAuthorities($G_cabinet_login);
$file_for_view['deletable'] = $folder->isDeletableFile($G_cabinet_login, $file);
$file_for_view['movable'] = $folder->isMovableFile($G_cabinet_login, $file);

$file_for_view['navi']['navi']['params'] = [
    'hid'  => $folder_id,
    'fid'  => $file_id,
    'sort' => $order_column['param']
];

$pages = explode('/', cb_get_pagename());

if ( ! isset($index_page)) {
    $pages[count($pages) - 1] = 'index';
    $index_page = implode('/', $pages);
}

// 前後のナビゲーション
$index_utility = new GRN_Cabinet_ControllerUtil($index_page);
$navi_for_view = $index_utility->getNeighborsView($G_cabinet_login, $file,
    $folder);

if (@ $pages[1] != 'system') {
    // 既読処理
    $G_cabinet->readFile($G_cabinet_login, $file);
}

$users_id = [];
$users_id[] = @$file_for_view['creator_uid'];
$users_id[] = @$file_for_view['modifier_uid'];

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

require_once("grn/controller.csp");
$users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
    $G_cabinet_login);
$t->assign('users_info', $users_info);

$t->assign('file', $file_for_view);
$t->assign('navi', $navi_for_view);
$t->assign('config', $utility->getConfigValues($G_cabinet_login));

require_once('grn/ui.csp');
$ucm = GRN_UIConfigManager::getInstance();
$usc =& $ucm->getSystemConfig();

$t->assign('lockable', $usc->getFileLockable());



