<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}


//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

$settings = $portlet['settings'];

$folder_id = $settings['hid'];

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cabinet = $locator->getInstance('cabinet');

global $G_container_base;
$uum = $G_container_base->getInstance('uum');
$login = $uum->getLoginUser();

if (($folder = $cabinet->getFolder($login, $folder_id))) {
    if ( ! $folder->checkDeletedFlag()) {
        $rows = @ $portlet['settings']['rows'];
        if ( ! $rows) {
            $rows = 5;
        }

        require_once('cabinet/controller.csp');
        $utility = new GRN_Cabinet_ControllerUtil();

        //get cabinet display order
        $order = $folder->getCabinetDisplayOrder();
        $arg = $utility->getListOrderArg($order);
        $order_column = $utility->getListOrderColumn($arg);

        require_once('cabinet/file_util.csp');
        $collection = new GRN_Cabinet_FileList($login, $folder);
        $collection->setLimit($rows);
        $collection->setLock(CB_DATABASE_NO_LOCK);
        $collection->addOrderColumn($order_column['column'],
            $order_column['order']);

        $users_id = [];
        $files_for_view = [];
        $star_unique_ids = [];
        while ( ! is_null(($file = $collection->iterate()))) {
            $for_view = $utility->getFileListView($login, $file);
            $for_view['read'] = $cabinet->isReadFile($login, $file);

            $files_for_view[$file->getOID()] = $for_view;
            $users_id[] = $for_view['modifier_uid'];
            $users_id[] = $for_view['locked_owner_uid'];
            $star_unique_ids[] = $file->getOID();
        }

        $users_info = GRN_ControllerUtil::getUserInfoToShowUserName($users_id,
            $login, "cabinet");

        $t->assign('folder',
            ['name' => $folder->get('name'), 'hid' => $folder_id]);
        $t->assign('files', $files_for_view);
        $t->assign('config', $utility->getConfigValues($login));
        $t->assign('users_info', $users_info);
        require_once('star/logic.csp');
        $star_logic = GRN_Star_StarLogic::getInstance();
        $use_star = $star_logic->isActive();
        $t->assign('use_star', $use_star);
        $t->assign('star_infos',
            $star_logic->getStatusByIDs($login, 'grn.cabinet',
                $star_unique_ids));
    }
}

//Assign include_php Parameter
$t->assign('portlet', $portlet);

//Set Page Title
if ($portlet['title'] === '') {
    require_once('grn/application.csp');
    $app_locator = GRN_ApplicationLocator::instance();
    $app_name = $app_locator->getName('cabinet');
    $page_title = cb_plain_msg('grn.cabinet', 'portlet_view',
        ['app_name' => $app_name]);
} else {
    $page_title = $portlet['title'];
}
$t->assign('page_title', $page_title);
$t->assign('display_name_mode', $portlet['display_name_mode']);

//Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("cabinet/portlet/view.tpl");


