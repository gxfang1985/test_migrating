<?php

require_once('portal/error_code.csp');
if ( ! isset($portlet)) {
    cb_throw_error(E_GRN_PRTL_PORTLET_INVALID_ACCESS);
}

//Get Smarty Instance
require_once("grn/smarty.csp");
$t = new GRN_Smarty;

global $G_INPUT;

//Create Font Options Array
$font_options = [
    ['value' => 'small', 'label' => cb_msg('grn.cabinet', 'font_size_small')],
    ['value' => 'normal', 'label' => cb_msg('grn.cabinet', 'font_size_normal')],
    ['value' => 'large', 'label' => cb_msg('grn.cabinet', 'font_size_large')],
];
$font_size = @$portlet['settings']['font_size'];
switch ($font_size) {
    case 'small':
        $font_options[0]['selected'] = true;
        break;
    case 'normal':
        $font_options[1]['selected'] = true;
        break;
    case 'large':
        $font_options[2]['selected'] = true;
        break;
    default:
        $font_options[1]['selected'] = true;
        break;
}
$t->assign('font_options', $font_options);

//Crerate Select Number Array
$select_numbers = [];
for ($i = 1; $i < 21; ++$i) {
    $select_numbers[] = $i;
}

$t->assign('select_numbers', $select_numbers);

// セッションから値を取り出す
// ss はフォルダ選択時のポストから戻った場合のフラグ
if (@ $G_INPUT['ss']) {
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $session =& $sm->getSession('cabinet/portlet/settings');

    $session_portlet = $session->get('portlet');
    if ($session_portlet) {
        $portlet =& $session_portlet;
    }
}

if ( ! array_key_exists('settings', $portlet)) {
    $portlet['settings'] = [
        'hid'          => null,
        'rows'         => 5,
        'show_columns' => [
            'title'    => 1,
            'filename' => 1,
            'modifier' => 1,
            'mtime'    => 1,
            'size'     => 1
        ]
    ];
} else {
    if ( ! array_key_exists('rows', $portlet['settings'])) {
        $portlet['settings']['rows'] = 5;
    }
    if ( ! array_key_exists('show_columns', $portlet['settings'])) {
        $portlet['settings']['show_columns'] = [
            'title'    => 1,
            'filename' => 1,
            'modifier' => 1,
            'mtime'    => 1,
            'size'     => 1
        ];
    }
}

// 表示フォルダを取得

require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
$cabinet =& $locator->getInstance('cabinet');

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login =& $uum->getLoginUser();

$folder_id = @ $portlet['settings']['hid'];

if (array_key_exists('s_hid', $G_INPUT) && strlen($G_INPUT['s_hid']) > 0) {
    $folder_id = $G_INPUT['s_hid'];
}

if ( ! $folder_id) {
    require_once('cabinet/table.csp');
    $folder_id = GRN_CABINET_ROOT_FOLDER_ID;
}

require_once('cabinet/folder.csp');
$foldermgr = GRN_Cabinet_FolderManager::getInstance();
$is_deleted_folder = $foldermgr->isFolderDeletedPermanent($folder_id);
if ($is_deleted_folder) {
    $folder_id = GRN_CABINET_ROOT_FOLDER_ID;
}

$folder = null;
if ($folder_id) {
    if ( ! ($folder =& $cabinet->getFolder($login, $folder_id))) {
        $portlet['settings']['hid'] = null;
    } elseif ($folder->checkDeletedFlag()) {
        $folder_id = GRN_CABINET_ROOT_FOLDER_ID;
        $portlet['settings']['hid'] = $folder_id;
    }
}

$t->assign('set_folder_id', $folder_id);


if (array_key_exists('text', $G_INPUT)) {
    // フォルダ検索

    $result_for_view = [];

    if (array_key_exists('text', $G_INPUT) && strlen($G_INPUT['text']) > 0) {
        $t->assign('text', $G_INPUT['text']);

        require_once('cabinet/folder.csp');
        $cm = GRN_Cabinet_FolderManager::getInstance();

        $folders = $cm->search($login, $G_INPUT['text']);

        require_once('cabinet/functions.csp');

        foreach (array_keys($folders) as $hid) {
            $item =& $folders[$hid];
            if ($item->checkDeletedFlag()) {
                continue;
            }
            $result_for_view[$hid] = [
                'name' => $item->get('name'),
                'hid'  => $hid,
                'path' => grn_cabinet_get_folder_path_string($item),
            ];
        }

    }

    $t->assign('search', [
            'result' => $result_for_view,
            'count'  => count($result_for_view),
            'text'   => $G_INPUT['text'],
        ]
    );
} else {
    // 通常のフォルダツリーからの選択画面を表示する場合

    require_once('cabinet/folder.csp');
    $fm = GRN_Cabinet_FolderManager::getInstance();

    if ( ! ($folder =& $fm->getFolder($login, $folder_id))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }

    require_once('cabinet/hierarchy.csp');
    $hierarchy = GRN_Cabinet_Hierarchy::getInstance();

    $folder_for_view = $hierarchy->build($login, $folder);

    // フォルダツリー
    $t->assign('folder', $folder_for_view);
}

$params = [
    'pid'     => $portlet['pid'],
    'plid'    => $portlet['plid'],
    'ppid'    => $portlet['ppid'],
    'display' => $portlet['display'],
];

// ツリー表示リンクのパラメータ
$t->assign('params', $params);

if (@ $portlet['settings']['hid']) {
    if (($folder =& $cabinet->getFolder($login, $portlet['settings']['hid']))) {
        $t->assign('current', ['name' => $folder->get('name')]);
    }
}


// フォルダ選択時のポストからリダイレクトされる場合以外はセッションに保存
if ( ! @ $G_INPUT['ss']) {
    require_once('fw/session_manager.csp');
    $sm = CB_SessionManager::getInstance();
    $session =& $sm->getSession('cabinet/portlet/settings');
    $session->set('portlet', $portlet);
}


//Assign include_php Parameter
$t->assign('portlet', $portlet);
$t->assign('display', $display);

// Ignore Licence Warnning
$t->skipWarning();

//Display Smarty Template
$t->display("cabinet/portlet/settings.tpl");

