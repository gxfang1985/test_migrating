<?php

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    global $G_INPUT;

    $folder_id = @ $G_INPUT['hid'];

    if ( ! ($file_id = @ $G_INPUT['fid'])) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }

    require_once('cabinet/access.csp');
    $acc = GRN_Cabinet_AccessManager::getInstance();

    $force = false;

    // 管理権限があれば強制解除
    if ($acc->isSuperAdmin($G_cabinet_login)) {
        $force = true;
    } else {
        if ( ! ($folder =& $G_cabinet->getFileFolder($file))) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
        if ($acc->isAdmin($G_cabinet_login, $folder)) {
            $force = true;
        }
    }

    $lock =& $file->getLockObject();
    $lock->releaseLock($force);

    if ( ! $folder_id) {
        if ( ! isset($folder)) {
            if ( ! ($folder =& $G_cabinet->getFileFolder($file_id))) {
                cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
            }
        }
        $G_INPUT['hid'] = $folder->getOID();
    }
}


