<?php

global $G_INPUT;

require_once("grn/smarty.csp");
$t = new GRN_Smarty;


$folder_id = @ $G_INPUT['hid'];

if ( ! ($file_id = @ $G_INPUT['fid'])) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$t->assign('folder_id', $folder_id);
$t->assign('file_id', $file_id);

require_once('cabinet/controller.csp');
$utility = new GRN_Cabinet_ControllerUtil();

// GRN35-209
if (@$G_INPUT['hid']) {
    if ( ! ($folder = $G_cabinet->getFolder($G_cabinet_login, $folder_id))) {
        cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
    }
    $utility->prepareMakeSitePosition($t, @$G_INPUT['hid'], @$G_INPUT['fid']);
} else {
    $page_path = [
        'cabinet/index' => ['hid' => @$G_INPUT['hid']],
        'cabinet/view'  => [
            'hid' => @$G_INPUT['hid'],
            'fid' => @$G_INPUT['fid']
        ],
    ];

    $utility->setSitePosition($t, $page_path);
}
// GRN35-209

if ( ! ($file =& $G_cabinet->getFile($G_cabinet_login, $file_id))) {
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

if ($file->isInTrash())       // Huy added
{
    cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
}

$file_for_view = $utility->getFileView($file);

$folder =& $G_cabinet->getFileFolder($file);

require_once('cabinet/functions.csp');
$file_for_view['position'] = grn_cabinet_get_folder_path_array($folder);

// ファイル表示データ
$t->assign('file', $file_for_view);

// バージョン管理世代数のUI生成用データ
$t->assign('version', $utility->getFileMaxVersionMenu($file->getMaxVersion()));

$t->display(cb_get_pagename() . ".tpl");

