<?php
require_once('cabinet/resources.csp');

if (strcasecmp(@ $_SERVER['REQUEST_METHOD'], 'POST') == 0) {
    assert('isset($target_name)');

    global $G_INPUT;
    $input_properties = [
        'access_dropdown_selected'       => '',
        'hid'                            => '',
        'enable_copy_access'             => '',
        'enable_copy_notification'       => '',
        'foreign_key'                    => '',
        'memo'                           => '',
        'notification_dropdown_selected' => '',
    ];
    $input_properties = array_intersect_key($G_INPUT, $input_properties);
    require_once('fw/i18n.csp');
    $lang_list = CB_LanguageManager::getAvailableLanguages();
    $lang_list[] = CB_I18N_DEFUALT_LANGUAGE_CODE;
    $lang_list[] = 'edit';
    $lang_list[] = 'edit-lang';
    foreach ($lang_list as $lang) {
        $key = GRN_CABINET_ELEMENT_NAME_FOLDER . '-' . $lang;
        if (isset($G_INPUT[$key])) {
            $input_properties[$key] = $G_INPUT[$key];
        }
    }

    // instantiate an Smarty object
    require_once("grn/smarty.csp");
    $t = new GRN_Smarty;

    //get language values
    $inputLocalNameArray = getMultiLanguageText(GRN_CABINET_ELEMENT_NAME_FOLDER,
        $input_properties);

    // Validation check
    require_once('SmartyValidate.class.php');
    SmartyValidate::connect($t);
    SmartyValidate::register_form($target_name);

    // validate after a POST
    if (SmartyValidate::is_valid($input_properties, $target_name)) {
        if ( ! @ $input_properties['hid']) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }

        $foreignKey = cb_at($input_properties, 'foreign_key');
        $memo = cb_at($input_properties, 'memo');
        $folderId = cb_at($input_properties, 'hid');
        $enableAccessCopy = cb_at($input_properties,
            'enable_copy_access');
        $enableNotificationCopy = cb_at($input_properties,
            'enable_copy_notification');
        $accessCopySrc = cb_at($input_properties,
            'access_dropdown_selected');
        $notificationCopySrc = cb_at($input_properties,
            'notification_dropdown_selected');

        //Modify Folder
        global $G_cabinet_login;
        require_once('cabinet/folder.csp');
        $folderMgr = GRN_Cabinet_FolderManager::getInstance();
        $folderMgr->modifyFolder($G_cabinet_login, $folderId,
            $inputLocalNameArray, $foreignKey, $memo);

        if ( ! is_null($enableAccessCopy)) {
            require_once('cabinet/access.csp');
            $targetFolder = $folderMgr->getFolder($G_cabinet_login, $folderId);
            $accessMgr = GRN_Cabinet_AccessManager::getInstance();
            $accessMgr->copyAccess($accessCopySrc, [$targetFolder->getOID()]);
        }

        if ( ! is_null($enableNotificationCopy)) {
            require_once('cabinet/notification.csp');
            $targetFolder = $folderMgr->getFolder($G_cabinet_login,
                $folderId);
            $notificationMgr = GRN_Cabinet_NotificationManager::getInstance();
            $notificationMgr->copyNotification($notificationCopySrc,
                [$targetFolder->getOID()]);
        }

        // the validation session is finished
        SmartyValidate::unregister_form($target_name);

        $success = true;

        _cabinet_rebuild_folder_tree($folderId);
    } else {
        $t->setPageInfo($target_name);
        $t->assign($input_properties);

        if ( ! array_key_exists('hid', $input_properties)) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
        $folder_id = $input_properties['hid'];

        if ( ! ($folder =& $G_cabinet->getFolder($G_cabinet_login,
            $folder_id))
        ) {
            cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
        }
        $t->assign('folder_id', $folder_id);

        if (($parent = $folder->get('parent'))) {
            $t->assign('parent_name', $parent->get('name'));

            $privileges = $parent->getPrivileges($G_cabinet_login);
            $page_parts = explode('/', cb_get_pagename());
            $is_system = (cb_at($page_parts, 1) === 'system');

            if ($privileges['operation'] || $is_system) {
                require_once('cabinet/folder_tree.csp');
                $params = [
                    'system'                  => $is_system,
                    'force_hide_notification' => true
                ];
                $tree = new GRN_Cabinet_FolderTree($params);
                $tree_for_access = $tree->getTreeForView($parent,
                    $is_system, 'tree_for_access',
                    'grn.page.folder_form.access_dropdown.selectCategory');
                $tree_for_notification = $tree->getTreeForView($parent,
                    $is_system, 'tree_for_notification',
                    'grn.page.folder_form.notification_dropdown.selectCategory');

                $t->assign('tree_for_access', $tree_for_access);
                $t->assign('tree_for_notification', $tree_for_notification);
                $t->assign('tree_params', $params);
            }
        }

        $multiLanguageInfoArray = [];
        $multiLanguageInfoArray['element_name']
            = GRN_CABINET_ELEMENT_NAME_FOLDER;
        $multiLanguageInfoArray['values'] = $inputLocalNameArray;
        $t->assign('multiLanguageInfoArray', $multiLanguageInfoArray);
    }
}

