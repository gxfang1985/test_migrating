<?php
require_once dirname(dirname(__DIR__)) . '/_api.csp';
require_once 'cbpapi/util.csp';

// Load all facilities
require_once 'schedule/facility_system_logic.csp';
$facility_logic = GRN_Facility_SystemLogic::getInstance();
$facilities = $facility_logic->getGroupFacilitiesInfo();

// Filter by permissions
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login = &$uum->getLoginUser();
$dynamic_roles = $uum->listGrantedRoles();
require_once('schedule/access_logic.csp');
$acc_logic = GRN_Schedule_Access_Logic::getInstance();
$facilities_tmp = $acc_logic->evaluateAccessesById($login, $facilities,
    ['read'], $dynamic_roles, 'facility');

// Arrange
$rows = [];
foreach ($facilities_tmp as $key => $facility) {
    $row = new stdClass();
    $row->id = intval($key);
    $row->name = $facility['col_name'];
    $row->body = $facility['col_memo'];
    $rows[] = $row;
}

$result = new stdClass();
$result->success = true;
$result->rows = $rows;
echo json_encode($result);
