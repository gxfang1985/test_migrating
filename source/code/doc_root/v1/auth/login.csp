<?php
$noAuthenticationAPI = true;
require_once dirname(__DIR__) . '/_api.csp';


$in = JSON::getInput();

if (isset($in->method)) {
    if ($in->method === 'environment') {
        $authenticationMethod = 'environment';
    } elseif ($in->method === 'default') {
        $authenticationMethod = 'default';
    } else {
        throw new APIException('Parameter:method is invalid.', 202);
    }
} else {
    $authenticationMethod = 'default';
}

if ($authenticationMethod === 'default') {
    if ( ! isset($in->username)) {
        throw new APIException('Username is not specified.', 201);
    }
    if ( ! isset($in->password)) {
        throw new APIException('Password is not specified.', 201);
    }
}

global $G_INPUT;
$G_INPUT["_system"] = 1;
$uum = cb_lwc_uum();
if ( ! $uum->login()) {
    throw new APIException('Fail to login.', 1001);
}

$user = $uum->getLoginUser();

$loginUser = new stdClass();
$loginUser->id = $user->getOID();
$loginUser->name = $user->get('display_name');

$context = new stdClass();
$context->loginUser = $loginUser;
$context->requestToken = cb_csrf_get_token();
$context->sessionToken = session_name() . "=" . session_id();

$result = new stdClass();
$result->success = true;
$result->context = $context;
echo json_encode($result);
