<?php
//--------------------
//  ユーザー認証
//--------------------
global $G_INPUT;
global $G_container_base;
$uum =& $G_container_base->getInstance('uum');

// ログインしてない or 認証要求あり
if ( ! ($G_login = $uum->getLoginUser())
     || (array_key_exists('_account', $G_INPUT)
         && array_key_exists('_password', $G_INPUT))
) {
    // ログイン済みであれば一旦ログアウト
    if ( ! $G_login == false) {
        $uum->logout();
    }

    if ( ! $uum->login())                                    // ログイン(失敗)
    {
        require_once('fw/error_code.csp');
        cb_throw_error(E_COMMON_AUTHENTICATION_FAILED);
    } else                                                    // ログイン(成功)
    {
        //LDAPの場合は基本システムの管理権限以上を持っていない場合はエラー
        //つまり，運用管理者でもエラーになります
        require_once('grn/system_logic.csp');
        $system = GRN_System::getInstance();
        $logged_in_user = $uum->getLoginUser();
        if ( ! $system->adminSubSystem('user', $logged_in_user)) {
            require_once('fw/error_code.csp');
            cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
        }
        require_once('fw/csrf.csp');
        cb_csrf_get_token();
        cb_switch_page('/system/user/command_user_organization_import1.csp');
    }
} else {
    require_once('fw/session_manager.csp');
    $session_manager = CB_SessionManager::getInstance();
    $session =& $session_manager->getSession('grn.csrf');
    $csrf_ticket = '';
    $csrf_ticket = $session->get('csrf_ticket');
    require_once('fw/csrf.csp');
    cb_csrf_validate_token($csrf_ticket);

    //LDAPの場合は基本システムの管理権限以上を持っていない場合はエラー
    //つまり，運用管理者でもエラーになります
    require_once('grn/system_logic.csp');
    $system = GRN_System::getInstance();
    $logged_in_user = $uum->getLoginUser();
    if ( ! $system->adminSubSystem('user', $logged_in_user)) {
        require_once('fw/error_code.csp');
        cb_throw_error(E_GRN_NO_SYSTEM_PRIVILEGE);
    }

    cb_switch_page('/system/user/command_user_organization_import1.csp');
}
