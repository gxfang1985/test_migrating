<?php
/*
* Created on 2007-03-28
*
* メールアカウントCSV読込
* 
* ■受信データ仕様 
* 名前       | 必須 |   値    | 個数 | 備考
* ----------------------------|------------------------------------------------------------------------
* file       |  ○  | ファイル|  1   | メールアカウントに読み込むファイル
* charset    |  ×  | 文字列  |  1   | 文字コード(1の場合 SJIS-win、 0 の場合 UTF-8)
* skip       |  ×  | 文字列  |  1   | 先頭行の項目名
* system     |  ○  | 固定値  |  1   | "2"  ※"2"の場合、ガルーン2のシステム設定を指定する
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用
* manage     |  ○  | 固定値  |  1   | "mail"
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用
* ■機能
* ・文字コードと先頭行のスキップを指定して、メールアカウントのCSVファイルをガルーン２に読込むことができる
*/
global $G_INPUT;
global $_FILE;

// coopLogin.cspのファイル存在
if ( ! is_file('coopLogin.csp')) {
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    include_once('error_code.csp');

    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

// ログイン認証
require('coopLogin.csp');
unset($uum);

//---------------------------------------------
//  アプリケーションの使用/停止状態をチェック
//---------------------------------------------
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
if ( ! ($G_application =& $locator->getInstance($G_INPUT['manage']))) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
}
unset($locator);


// 受信データチェック////////////////////
$error_msg = null;

if ( ! array_key_exists('file', $_FILES)) {
    $error_msg = 'file';
}

if ($error_msg) {
    include_once("error_code.csp");
    api_response_data(null, E_API_MAIL_PARAM_WRONG . "[" . $error_msg . "]");
    cb_safe_exit();
}
unset($error_msg);

// ファイルの存在チェック////////////////
if ($_FILES['file']['error'] != UPLOAD_ERR_OK) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_FILE_UPLOAD);
}

//-------------------------------------------------
//  CSVファイルの読込(メールアカウント)
//-------------------------------------------------
$charset = @$G_INPUT['charset'];
$skip = @$G_INPUT['skip'] ? intval($G_INPUT['skip']) : 0;
$filepath = $_FILES['file']['tmp_name'];

if ( ! $charset) {
    global $G_config_common;
    $charset = $G_config_common->get('I18N', 'default_external_encoding');
}

require_once('fw/csv.csp');
$csv = new CB_CSVReader($charset, $filepath);

// 先頭行をスキップ
for ($i = 0; $i < $skip; ++$i) {
    $csv->readLine();
}

require_once("mail/system_config.csp");
$system_config = GRN_Mail_SystemConfig::getInstance();

// インポート
$system_config->importAccountDataFromCSV($csv);
$csv->close();

