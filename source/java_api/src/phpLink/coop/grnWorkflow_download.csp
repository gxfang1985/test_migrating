<?php
/*
* Created on 2007-04-04
*
* ワークフロー(添付ファイルのDL)
* 
* ■受信データ仕様 
* 名前       | 必須 |   値    | 個数 | 備考
* ----------------------------|------------------------------------------------------------------------
* ifid       |  ○  | 数値    |  1   | ワークフローの添付ファイルID
* title_flag |  ×  | 数値    |  1   | ファイル管理のファイルのタイトル取得フラグ(タイトル取得 1:する,1以外:しない)
* system     |  ○  | 固定値  |  1   | "2"  ※"2"の場合、ガルーン2のシステム設定を指定する
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用
* manage     |  ○  | 固定値  |  1   | "workflow"
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用
* ■機能
* ・ガルーン２ ワークフローの任意の添付ファイルのダウンロードを行うことができる
*/

global $G_INPUT;

// coopLogin.cspのファイル存在
if ( ! is_file('coopLogin.csp')) {
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    include_once('error_code.csp');

    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

// ログイン認証
require('coopLogin.csp');
unset($uum);

// 2007/04/26 WFアプリ停止時にAPI経由で添付ファイルのDLが出来てしまう (不具合管理251)
//---------------------------------------------
//  アプリケーションの使用/停止状態をチェック
//---------------------------------------------
require_once('grn/application.csp');
$locator = GRN_ApplicationLocator::instance();
// 2008/01/15 不具合管理 296 WFにて，アプリケーションの使用許可がない状態で取得を実行するとエラーになる
if ( ! ($G_application =& $locator->getInstance('workflow'))) {
    require_once('grn/error_code.csp');
    cb_throw_error(E_GRN_APPLICATION_NOT_ACTIVE);
}
unset($locator, $G_application);
/////////////////////////////////////////////////////////////////////////////////////


// 受信データチェック////////////////////
if ( ! array_key_exists('ifid', $G_INPUT) || ! is_numeric($G_INPUT['ifid'])) {
    include_once("error_code.csp");
    api_response_data(null, E_API_CABINET_PARAM_WRONG . "[ifid]");
    cb_safe_exit();
}

$title_flag = @ $G_INPUT['title_flag'];

require_once('workflow/itemdatafile_logic.csp');

if ($title_flag == 1) {
    $title = null;
    $item_data_file_id = @ $G_INPUT['ifid'];

    //$item_data_fileの取得
    $item_data_file_logic = GRN_Workflow_ItemDataFile_Logic::getInstance();
    $item_data_file =& $item_data_file_logic->get($item_data_file_id);

    require_once('workflow/itemdata_manager_base.csp');
    $item_data_logic = GRN_Workflow_ItemData_Manager_Base::getInstance();

    $item_data =& $item_data_logic->get($item_data_file['col_item_data']);

    //$file_objectの取得
//    require_once('grn/file.csp');
//    $file_manager = GRN_FileManager::getInstance();
    require_once('workflow/file.csp');
    $file_manager = new GRN_Workflow_FileManager_Core();
    $file_table =& $file_manager->getFileTable();
    $file_object =& $file_table->getRow($item_data_file['col_file']);

    if ( ! $file_object) {
        require_once('workflow/error_code.csp');
        cb_throw_error(E_GRN_WRKF_ITEMDATAFILE_NOT_FOUND);
    }

    //Download Current Version File
    $body_object =& $file_object->getCurrentBody();

    $pid = @$item_data['col_petition'];
    $title = $body_object->get('name');

    // 添付ファイルのファイル名を返す
    print($pid . ',' . $title);
    cb_safe_exit();
} else {
    $item_data_file_id = @ $G_INPUT['ifid'];

    //$item_data_fileの取得
    $item_data_file_logic = GRN_Workflow_ItemDataFile_Logic::getInstance();
    $item_data_file =& $item_data_file_logic->get($item_data_file_id);

    require_once('workflow/itemdata_manager_base.csp');
    $item_data_logic = GRN_Workflow_ItemData_Manager_Base::getInstance();

    $item_data =& $item_data_logic->get($item_data_file['col_item_data']);

    $G_INPUT['pid'] = @$item_data['col_petition'];
}

// file_download.cspに丸投げ
require(cb_basedir() . '/code/doc_root/workflow/system/file_download.csp');
