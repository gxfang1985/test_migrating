<?php
/*
* Created on 2006/10
*
* 掲示板フォロー登録機能
* 
* ■受信データ仕様 
*
*   項目名      |説明
*   ------------+--------------------------------------------------
*   aid         |掲示板IDを指定します。
*   data        |本文
*   editor      |本文の書式  (0:テキスト,2=書式編集)  現状は 0(テキスト)しかこないけど
*   send        |登録コマンド (valueは空) 
*   file[0-n]   |添付ファイルアップロード
*   registrant  |coopLoginにて使用  差出人を指定します。(→このユーザーでLoginAs)
*               |パラメータがなければログインユーザーで登録
*   page        |coopLoginにて使用"_coopBulletin_follow_add.csp" 
*   app         |coopLoginにて使用"bulletin"
*
* ■機能
*  掲示板フォローの登録を行う 
*  本文の書式はテキスト指定のみとする(書式編集の機能はない)
*  基本的には、↓のソースから下書き機能・画面の表示部分を抜くかんじで
*  bulletin/command_view.csp
*/


global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);

if ( ! array_key_exists('aid', $G_INPUT)) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

$article_id = $G_INPUT['aid'];

/** @var GRN_Bulletin $G_application */
// 参考元ソース(command_view)との差分分の対応
//if( !($article =& $G_application->getArticle( $G_login, $article_id) ) )
if ( ! ($article =& $G_application->getArticle($G_login, $article_id,
    GRN_BULLETIN_ACCESS_R, true, CB_DATABASE_EXCLUSIVE_LOCK))
) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

//2008/01/30 不具合修正 312 変更、削除、フォロー登録のエラー判定が不正
$category = $article->get('category');
$category_id = $category->getOID();
// カテゴリに対するアクセス権(閲覧)があるか
if ( ! ($G_application->getCategory($G_login, $category_id,
    GRN_BULLETIN_ACCESS_R, false))
) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_READ);
}
//--


//フォロー書込み許可がなければエラー(この記述及びエラーNoでよいか要確認)///
if ( ! $article->get('can_follow')) {
    //   2007/03/26 掲示板フォロー追加にて，フォロー書込み許可がない場合のエラーメッセージ修正 不具合管理(198)
    include_once('error_code.csp');
    api_response_data(null, E_API_BULLETIN_FOLLOW_PERMIT);
    cb_safe_exit();

}
///////////////////////////////////////////////////////////////////////////

if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
    require_once('grn/controller.csp');
    $properties['data'] = grn_strip_tags($G_INPUT['data']);
    $properties['html'] = $G_INPUT['data'];
} else {
    $properties['data'] = $G_INPUT['data'];
    $properties['html'] = null;
}

if (is_null($properties['data']) || strlen(cb_trim($properties['data'])) < 1) {
    $found_file = false;
    foreach (array_keys($_FILES) as $name) {
        if ($_FILES[$name]['error'] == UPLOAD_ERR_OK) {
            $found_file = true;
            break;
        }
    }
    if ( ! $found_file) {
        cb_throw_error(E_GRN_BULLETIN_EMPTY_FOLLOW);
    }
}

$follow =& $article->writeFollow($G_login, $properties, $_FILES);

assert('$follow !== FALSE');

//フォローIDを返す
$event_id = $follow->getOID();
printf("<Header Data><CR><LF>");
printf("0,%s", $event_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");
