<?php
/*
* Created on 2007-03-26
*
* ファイル削除機能
* 
* ■受信データ仕様 
* 名前       | 必須 |   値    | 個数 | 備考
* ----------------------------|------------------------------------------------------------------------
* fid        |  ○  | 数値    |  1   | ファイルID
* registrant |  ×  | 文字列  |  1   | 更新者 のログインアカウント
*            |      |         |      | →coopLogin.cspにて、LoginAsを行う
* app        |  ○  | 固定値  |  1   | "cabinet"
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用*
* ■機能
* ・ファイル管理上のファイルを削除する 
* ・[受信データ]を受取り、指定されたファイルIDのファイルを削除する
* ・以下のシステム設定値については、以下判定を行うものとする
* ★注意★ 更新者自身がロックしている場合も、エラー(GRN_CMMN_0202) とする
*  grn.exe/cabinet/_command_delete
*  /include/cabinet/application.csp (deleteFile関数)
*/

global $G_INPUT;

// coopLogin.cspのファイル存在
if ( ! is_file('coopLogin.csp')) {
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    include_once("error_code.csp");

    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');
unset($uum);


// 受信データチェック
if ( ! array_key_exists('fid', $G_INPUT) || ! is_numeric($G_INPUT['fid'])) {
    include_once("error_code.csp");
    api_response_data(null, E_API_CABINET_PARAM_WRONG . "[fid]");
    cb_safe_exit();
}


// ファイル取得
/** @var GRN_Cabinet $G_application */
if (($file =& $G_application->getFile($G_login, $G_INPUT['fid'],
    GRN_CABINET_ACCESS_R))
) {
    //start 2008/01/15 G2.5対応 
    //不具合№286対応 ファイル情報取得で、ファイルID 1 指定時のエラー不正
    if ( ! $folder =& $G_application->getFileFolder($file)) {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }
    //ゴミ箱ファイルを省く
    if ($file->isInTrash())       // Huy added
    {
        cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
    }
    //end 2008/01/15 G2.5対応

    $lock =& $file->getLockObject();
    // 自身がロックしている場合のみ ここでエラー出す
    if ($lock->isLocked() == 2) {
        require_once('grn/error_code.csp');
        cb_throw_error(E_GRN_FILE_LOCKED);
    }
}


// あとは削除関数におまかせ
$G_application->deleteFile($G_login, $G_INPUT['fid'], null);

//ファイルIDを戻す
api_response_data($file->getOID());

