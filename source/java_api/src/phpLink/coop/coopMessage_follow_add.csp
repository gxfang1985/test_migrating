<?php
/*
* Created on 2006/10
*
* 社内メールフォロー登録機能
* 
* ■受信データ仕様 
*
*   項目名      |説明
*   ------------+--------------------------------------------------
*   mid         |掲示板IDを指定します。
*   data        |本文
*   editor      |本文の書式  (0:テキスト,1=書式編集)  現状は 0(テキスト)しかこないけど
*   cmd         |登録コマンド (valueはfollow 固定値 必要ないけど)
*   file[0-n]   |添付ファイルアップロード
*   registrant  |coopLoginにて使用  登録者を指定します。(→このユーザーでLoginAs)
*               |パラメータがなければログインユーザーで登録
*   page        |coopLoginにて使用"_coopMessage_follow_add.csp" 
*   app         |coopLoginにて使用"message"
* ■機能
*  社内メールフォローの登録を行う 
*  本文の書式はテキスト指定のみとする(書式編集の機能はない)
*  基本的には、↓のソースから下書き機能・閲覧確認機能・画面の表示部分etcを抜くかんじで
*  (フォローの登録のみできればよい)
*  message/command_view.csp (ver 2.0.3)
*/

global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

//  アプリ名を取りだす
$G_message = null;
require_once('grn/application.csp');
$app_locator = GRN_ApplicationLocator::instance();
if ( ! ($G_message =& $app_locator->getInstance('message'))) {
    require_once('message/error_code.csp');
    $name = $app_locator->getName('message');
    $name = htmlspecialchars($name);
    cb_throw_error(E_GRN_MESSAGE_DEACTIVATED,
        ['app_name' => $name],
        ['app_name' => $name]);
}
$G_message_name = $G_message->getName();
unset($app_locator);

global $G_container_base;
$uum =& $G_container_base->getInstance('uum');
$login_user =& $uum->getLoginUser();
unset($uum);

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();

$message_id = @ $G_INPUT['mid'];

if ($message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$follow = [];
$follow['creator'] =& $G_login;

// for rich editor
$data = array_key_exists('data', $G_INPUT) ? $G_INPUT['data'] : '';
if (array_key_exists('editor', $G_INPUT) && $G_INPUT['editor']) {
    $follow['format_type'] = 1;
    $follow['data'] = $data;
} else {
    $follow['format_type'] = 0;
    $follow['data'] = $data;
}

if (cb_trim($follow['data']) == '') {
    $found_files = false;
    foreach (array_keys($_FILES) as $name) {
        if ($_FILES[$name]['error'] == UPLOAD_ERR_OK) {
            $found_files = true;
            break;
        }
    }
    if ( ! $found_files) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_INPUTTED);
    }
}

//  フォローを書き込む
$follow_row = $message_logic->writeFollow($login_user, $message_id, $follow,
    $_FILES);
if ($follow_row === false) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND,
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name],
        ['app_name' => $G_message_name]);
}

$follow_id = $follow_row->getOID();
///////////////////////////////////////
//戻り値 メッセージフォローID
///////////////////////////////////////
printf("<Header Data><CR><LF>");
printf("0,%s", $follow_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");


