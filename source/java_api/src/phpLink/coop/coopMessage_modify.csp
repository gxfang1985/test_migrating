<?php
global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
// メッセージID
$message_id = @ $G_INPUT['mid'];                            // メッセージID
if ($message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND);
}

// タイトル
$title = cb_trim(@$G_INPUT['title']);                        // タイトル
if ($title == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_SUBJECT_NOT_INPUTTED);
}
$description = preg_replace('/\x0D\x0A|\x0D|\x0A/', '', @$title);
if (mb_strlen($description) > 100) {
    $description = mb_substr($description, 0, 100);
}
$title = $description;

// 本文
$format = 0;
$data = $G_INPUT['data'];                                    // 本文

require_once('grn/controller.csp');

// 添付ファイル
$files = [];
foreach ($_FILES as $key => $file) {
    if ($file['error'] != UPLOAD_ERR_OK) {
        continue;
    }

    $files[$key] = $file;
}

$target_name = 'message/modify';
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$ret = $message_logic->modifyMessage($G_login,
    $message_id,
    mb_substr($title, 0, 100),
    $data,
    $format,
    $files);
if ( ! $ret) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND);
}

$m_id = $message_id;
printf("<Header Data><CR><LF>");
printf("0,%s", $m_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");

