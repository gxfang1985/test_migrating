<?php
global $G_INPUT;

/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);

$message_id = @ $G_INPUT['mid'];                            // メッセージID

if ($message_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND);
}

//start 2008/01/11 G2.5対応
// check privilege
//global $G_container_base;
//$db =& $G_container_base->getInstance( 'dbconn' );
$app_locator = GRN_ApplicationLocator::instance();
$db =& $app_locator->getConnection('message');
unset($app_locator);
//end 2008/01/11 G2.5対応

// 指定した社内メールが存在するかチェック
$conditions = [
    'col_creator = \'' . $G_login->getOID() . '\'',
    '_id = \'' . $db->escape($message_id) . '\''
];
$query = 'SELECT COUNT(*) AS cnt FROM tab_grn_message_messages a WHERE ';
$query .= implode(' AND ', $conditions);
$result = $db->query($query);
if ($result !== false) {
    $row = $db->fetch_assoc($result);
    if ($row['cnt'] == 0) {
        require_once('message/error_code.csp');
        cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_FOUND);
    }
}

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();

$ret = $message_logic->deleteMessageData($G_login, [$message_id]);
if ( ! $ret) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_MESSAGE_NOT_DELETED);
}
printf("<Header Data><CR><LF>");
printf("0,%s", $message_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");
