<?php
global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);
$follow_id = @ $G_INPUT['fid'];                            // フォローID

if ($follow_id == '') {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_FOUND);
}

//start 2008/01/10 G2.5対応
// 不具合№289対応
// ※メッセージIDの取得（フォローIDよりメッセージIDを取得するGR2のフレームワークのメソッドに存在しない為)
//   SQLで直実装します
$app_locator = GRN_ApplicationLocator::instance();
$db =& $app_locator->getConnection('message');
$conditions = ['_id = \'' . $db->escape($G_INPUT['fid']) . '\''];
$query = 'SELECT col_message FROM tab_grn_message_follows WHERE ';
$query .= implode(' AND ', $conditions);
$result = $db->query($query);
if ($result === false) {
    $db->throwError(['query' => 'failed query on SELECT: ' . $query]);
}
$row = $db->fetch_assoc($result);
$message_id = '';
if ($result !== false) {
    $message_id = $row['col_message'];
}
$db->free_result($result);

//実行者の情報のdtimeが日付の場合はエラー(GR2の画面と同様のチェック)
require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
if ($message_id != '') {
    $addressee_list = $message_logic->getAddressees($G_login, $message_id);
    foreach ($addressee_list as $addressee) {
        if ($addressee['id'] == $G_login->getOID()
            && $addressee['dtime']->unix_ts != 0
        ) {
            require_once('error_code.csp');
            api_response_data(null, E_API_MESSAGE_USER_ADDRESS_DELETE);
            cb_safe_exit();
        }
    }
}
unset($app_locator);
//end 2008/01/10 G2.5対応

require_once('message/message_logic.csp');
$message_logic = new GRN_Message_Logic();
$ret = $message_logic->deleteFollow($G_login, $follow_id);
if ( ! $ret) {
    require_once('message/error_code.csp');
    cb_throw_error(E_GRN_MESSAGE_FOLLOW_NOT_FOUND);
}
printf("<Header Data><CR><LF>");
printf("0,%s", $follow_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");
