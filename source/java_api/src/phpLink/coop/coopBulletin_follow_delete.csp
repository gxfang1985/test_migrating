<?php

/*
* Created on 2006/10
*
* 掲示板削除機能
* 
* ■受信データ仕様 
*
*   項目名      |説明
*   ------------+--------------------------------------------------
*   aid         |掲示板IDを指定します
*   registrant  |coopLoginにて使用  更新者を指定します。(→このユーザーでLoginAs)
*               |パラメータがなければログインユーザーで更新
*   page        |coopLoginにて使用"_coopBulletin_follow_delete.csp" 
*   app         |coopLoginにて使用"bulletin"
*
* ■機能
*  掲示板の削除を行う 
*  参考ソース
*  bulletin/command_follow_delete.csp
*/


global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);
//unset( $G_application );

require_once('bulletin/follow.csp');

if ( ! ($follow_id = @ $G_INPUT['follow_id'])) {
    cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
}

//JAVA側からは、follow_idしか来ない仕様にしてある。以下の削除方法でOK?
// 44行目についてテーブルにfollow_idがあるかのチェック 要確認
//   _tab_follow が private access用っぽいけど大丈夫か？
//   チェックしないと $fm->getFollow で Fatal error: Call to a member function on a non-object  
//   が出てしまいサイボウズのエラーが還らない

$fm = GRN_Bulletin_FollowManager::getInstance();

// $follow_idがテーブルにあるかチェック なければエラー
if ( ! ($fm->_tab_follow->getRow($follow_id))) {
    cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
}
// $follow_idより followオブジェクトの取得
if ( ! ($follow =& $fm->getFollow($G_login, $follow_id))) {
    cb_throw_error(E_GRN_BULLETIN_FOLLOW_NOT_FOUND);
}

//掲示IDを返す/////////////////////
$f_id = $follow->getOID();
///////////////////////////////////

// 掲示取得
if ( ! ($article =& $follow->get('article'))) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_FOLLOW);
}

// start 2008/01/28 不具合管理(311) フォロー削除のエラー判定が不正
/* 
//// 2007.05.02 アクセス権メッセージが不正な箇所が存在する 不具合管理(238)
//// アクセス権をチェック
//$auth = $article->getAuthorities( $G_login );
//
//if( ! @ $auth['read'] )
//{
//    require_once('bulletin/error_code.csp');
//    cb_throw_error( E_GRN_BULLETIN_ACCESS_DENY_READ );
//}
//if( ! @ $auth['follow'] )
//{
//    require_once('bulletin/error_code.csp');
//    cb_throw_error( E_GRN_BULLETIN_ACCESS_DENY_FOLLOW );
//}
*/

$category = $article->get('category');
$category_id = $category->getOID();
/** @var GRN_Bulletin $G_application */
// カテゴリに対するアクセス権(閲覧)があるか
if ( ! ($G_application->getCategory($G_login, $category_id,
    GRN_BULLETIN_ACCESS_R, false))
) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_READ);
}
// 削除可能かどうか
if ( ! ($follow->isDeletable($G_login, false))) {
    require_once('bulletin/error_code.csp');
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_FOLLOW);
}
// end 2008/01/28 不具合管理(311) フォロー削除のエラー判定が不正

$follow->delete($G_login);

//--------------------------------------------------------------------------------------------
printf("<Header Data><CR><LF>");
printf("0,%s", $f_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");
