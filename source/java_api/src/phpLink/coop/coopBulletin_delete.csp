<?php

/*
* Created on 2006/10
*
* 掲示板削除機能
* 
* ■受信データ仕様 
*
*   項目名      |説明
*   ------------+--------------------------------------------------
*    aid        |削除する掲示板記事IDを指定します。
*    registrant |coopLoginにて使用 更新者を指定します。(→このユーザーでLoginAs)
*               |パラメータがなければログインユーザーで更新
*    page       |coopLoginにて使用"_coopBulletin_delete.csp" 
*    app        |coopLoginにて使用"bulletin"
* 
* ■機能
*  掲示板の削除を行う 
*  参考ソース
*  bulletin/command_delete.csp
*/

global $G_INPUT;
/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');

/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);

if ( ! ($article_id = @ $G_INPUT['aid'])) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}
/** @var GRN_Bulletin $G_application */
if ( ! ($article =& $G_application->getArticle($G_login, $article_id))) {
    cb_throw_error(E_GRN_BULLETIN_ARTICLE_NOT_FOUND);
}

//2008/01/30 不具合修正 312 変更、削除、フォロー登録のエラー判定が不正
$category = $article->get('category');
$category_id = $category->getOID();
// カテゴリに対するアクセス権(閲覧)があるか
if ( ! ($G_application->getCategory($G_login, $category_id,
    GRN_BULLETIN_ACCESS_R, false))
) {
    $creator = $article->get('creator');
    $creator_id = $creator->getOID();

    // 未掲示且つ登録者であれば、エラーじゃない
    if ($article->isPublished() || $creator_id != $G_login->getOID()) {
        require_once('bulletin/error_code.csp');
        cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_READ);
    }
}
//--


// 削除可能かどうか
if ( ! $article->isDeletable($G_login)) {
    cb_throw_error(E_GRN_BULLETIN_ACCESS_DENY_DELETE);
}

//掲示IDを返す/////////////////////
$a_id = $article->getOID();
///////////////////////////////////
$article->delete($G_login);

//--------------------------------------------------------------------------
printf("<Header Data><CR><LF>");
printf("0,%s", $a_id);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");
