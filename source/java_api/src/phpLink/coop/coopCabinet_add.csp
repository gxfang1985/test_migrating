<?php

use grn\fts\Application as FtsApplication;
use grn\fts\cabinet\IndexService;

global $G_INPUT;

/////////////////////////////////////////////////////////////////////////////////////////
//20061120修正
//coopファイルが存在しないとFatal Erorrになるためファイル存在チェック
//$nextpage = basename($G_INPUT['page']);
$nextpage = "coopLogin.csp";
if (is_file(cb_basedir() . '/code/doc_root/' . dirname(cb_get_pagename()) . '/'
            . $nextpage)
) {
    //20061120修正
    //require( $nextpage );
} else {
    //コピーライトとHTML閉じタグ出力しない
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    //   2007/03/27 coopLogin.cspがない場合のエラーメッセージ修正 不具合管理(199)
    include_once('error_code.csp');
    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}

//ログイン認証
require('coopLogin.csp');
/////////////////////////////////////////////////////////////////////////////////////////
unset($uum);

//   2007/03/27 ファイル登録時，バージョンに文字列を指定すると無制限扱いになる 不具合管理(184)
// 受信データチェック
if ( ! is_numeric($G_INPUT['max_version'])) {
    include_once("error_code.csp");
    api_response_data(null, E_API_CABINET_PARAM_WRONG . "[max_version]");
    cb_safe_exit();
}

// フォルダコードからフォルダIDを取得
require_once('cabinet/folder.csp');
/** @var GRN_Cabinet_FolderManager $G_cabinet */
$G_cabinet = GRN_Cabinet_FolderManager::getInstance();
$set_folder_id =& $G_cabinet->_getFolderIdByForeignKey($G_INPUT['folder']);

// 2007.04.23 アクセス権メッセージが不正な箇所が存在する 不具合管理(238)
if ( ! ($folder =& $G_cabinet->getFolder($G_login, $set_folder_id,
    GRN_CABINET_ACCESS_R, true))
) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}
if ( ! ($folder =& $G_cabinet->getFolder($G_login, $set_folder_id,
    GRN_CABINET_ACCESS_W, true))
) {
    cb_throw_error(E_GRN_CABINET_FOLDER_NOT_FOUND);
}

unset($G_cabinet);

$locator = GRN_ApplicationLocator::instance();
$G_cabinet = null;
/** @var GRN_Cabinet $G_cabinet */
if ( ! ($G_cabinet =& $locator->getInstance('cabinet'))) {
    cb_throw_error(E_GRN_CABINET_DEACTIVATED);
}
unset($locator);

$comment = null;
if (array_key_exists('comment', $G_INPUT)) {
    $comment = cb_trim($G_INPUT['comment']);
}

$file =& $G_cabinet->createFile($G_login, $folder, $_FILES['file'], $comment);

assert('$file');

$description = preg_replace('/\x0D\x0A|\x0D|\x0A/', '', @$G_INPUT['title']);
if (mb_strlen($description) > 100) {
    $description = mb_substr($description, 0, 100);
}
$G_INPUT['title'] = $description;

if (array_key_exists('title', $G_INPUT))                    // タイトル
{
    $file->setTitle(cb_trim($G_INPUT['title']));
}
if (array_key_exists('memo', $G_INPUT))                    // ファイルの説明
{
    $file->setDescription($G_INPUT['memo']);
}
if (array_key_exists('max_version', $G_INPUT))            // バージョン管理
{
    //   2007/03/22 バージョンの制限値を超えることが可能なロジックがある 不具合管理(185)
    //   2007/04/04 ファイルの追加及び情報変更で無制限扱いのパラメータは-1であるべき(209)
    $config = GRN_FileManagerConfig::getInstance();
    $system_max_version = $config->getMaxVersion();

    if ($G_INPUT['max_version'] > 10 || $G_INPUT['max_version'] == -1) {
        $ver = $system_max_version;
    } elseif ($G_INPUT['max_version'] < -1) {
        $ver = 0;
    } else {
        $ver = $G_INPUT['max_version'];
    }

    $file->setMaxVersion($ver);
}

if (FtsApplication::isAvailable()) {
    $searchService = new IndexService();
    $searchService->createFileIndex($file);
}

// Write log: create file 
require_once('cabinet/inspection.csp');
$inspection = GRN_Cabinet_Inspection::getInstance();
$inspection->writeLogFile("create", $file,
    $folder);                 // add 2008/01/15 G2.5対応

$file->onCreate($G_login);
$G_cabinet->readFile($G_login, $file);

// 2008/02/04 不具合No(313)
$fid = $file->getOID();                                    // ファイルID

printf("<Header Data><CR><LF>");
printf("0,%s", $fid);
printf("<Footer Data><CR><LF>");
printf("NOERROR<CR><LF>");

