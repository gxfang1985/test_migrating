<?php
/*
* Created on 2007-03-23
*
* ファイルダウンロード機能
* 
* ■受信データ仕様 
* 名前       | 必須 |   値    | 個数 | 備考
* ----------------------------|------------------------------------------------------------------------
* fid        |  ○  | 数値    |  1   | ファイルID
* ver        |  ×  | 数値    |  1   | バージョンNo 
* title_flag |  ×  | 数値    |  1   | ファイル管理のファイルのタイトル取得フラグ(タイトル取得 1:する,1以外:しない)
* registrant |  ×  | 文字列  |  1   | 更新者 のログインアカウント
*            |      |         |      | →coopLogin.cspにて、LoginAsを行う
* app        |  ○  | 固定値  |  1   | "cabinet"
*            |      |         |      | →coopLogin.cspにて、各アプリケーションオブジェクトの生成時使用*
* ■機能
* ・ファイル管理上のファイルをダウンロードする
* ・[受信データ]を受取り、指定されたファイルIDのファイルをダウンロードする
* ・以下のシステム設定値については、以下判定を行うものとする
*   フォルダに対するアクセス権      →フォルダに対する読込権限がない場合はエラー (GRN_CBNT_17008)
*  grn.exe/cabinet/download
*/

global $G_INPUT;
// coopLogin.cspのファイル存在
if ( ! is_file('coopLogin.csp')) {
    global $G_state_set;
    $G_state_set->set('copyright_should_be_written', false);
    $G_state_set->set('html_should_be_closed', false);

    include_once("error_code.csp");

    header("X-Cybozu-Error:" . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Header Data><CR><LF>");
    print("1," . E_API_COMMON_COOPLOGIN_NOT_FOUND);
    print("<Footer Data><CR><LF>");
    print("ERROR<CR><LF>");
    cb_safe_exit();
}


//ログイン認証
require('coopLogin.csp');
unset($uum);

// 受信データチェック
if ( ! array_key_exists('fid', $G_INPUT) || ! is_numeric($G_INPUT['fid'])) {
    include_once("error_code.csp");
    api_response_data(null, E_API_CABINET_PARAM_WRONG . "[fid]");
    cb_safe_exit();
}
/** @var GRN_Cabinet $G_application */
// 任意パラムの空セット
if ( ! array_key_exists('ver', $G_INPUT)) {
    $G_INPUT['ver'] = "";
}

$title_flag = @ $G_INPUT['title_flag'];

if ($title_flag == 1) {
    $title = null;

    // ファイル取得
    if (($file =& $G_application->getFile($G_login, $G_INPUT['fid'],
        GRN_CABINET_ACCESS_R))
    ) {
        //start 2008/01/15 G2.5対応 
        //不具合№286対応 ファイル情報取得で、ファイルID 1 指定時のエラー不正
        if ( ! $folder =& $G_application->getFileFolder($file)) {
            cb_throw_error(E_GRN_CABINET_FILE_NOT_FOUND);
        }
        //end 2008/01/15 G2.5対応

        $body = null;

        if ($G_INPUT['ver']) {

            $body =& $file->getBody($G_INPUT['ver']);
        } else {
            $body =& $file->getCurrentBody();
        }

        if ($body != null) {
            $title = $body->get('name');
        }
    }

    // 添付ファイルのファイル名を返す
    print($title);
    cb_safe_exit();
}

// download.cspに丸投げ
$G_cabinet_login = &$G_login;
$G_cabinet = &$G_application;

require(cb_basedir() . '/code/doc_root/cabinet/download.csp');

