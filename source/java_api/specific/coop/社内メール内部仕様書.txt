社内メール プログラム仕様書

0.目次
-------------------------------------------------------------------
    0.目次
    1.サンプルプログラム
        1-(ア) 社内メール登録
        1-(イ) 社内メール更新
        1-(ウ) 社内メール削除
        1-(エ) 社内メールフォロー登録
        1-(オ) 社内メールフォロー削除
    2.ガルーン連携（JAVA）用プログラム
        2-(ア) 社内メール登録
        2-(イ) 社内メール更新
        2-(ウ) 社内メール削除
        2-(エ) 社内メールフォロー登録
        2-(オ) 社内メールフォロー削除
    3.ガルーン連携（PHP）用プログラム
        3-(ア) 社内メール登録
        3-(イ) 社内メール更新
        3-(ウ) 社内メール削除
        3-(エ) 社内メールフォロー登録
        3-(オ) 社内メールフォロー削除
    4.その他
-------------------------------------------------------------------

1.サンプルプログラム
    (ア) 社内メール登録
        [ファイル名]
            CmdMessageAdd.java
        [クラス名]
            CmdMessageAdd
        [概要]
            コマンドラインよりガルーン２へ社内メールの登録を行う
        [機能]
            コマンドラインよりガルーン２へ社内メール登録を行うことができる
            指定できるオプションのガイダンスを表示することができる
            実行結果を表示することができる
            例外発生時は、エラー内容を表示することができる
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main         メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -r    社内メールを登録するユーザのログイン名
                        ⑥ -t    社内メールのタイトル
                        ⑦ -d    社内メールの本文
                        ⑧ -f    社内メールの添付ファイル (複数指定可能)
                        ⑨ -a    社内メール宛先のログイン名(複数指定可能)
                        ⑩ -c    (閲覧状況を確認する)
                        ※②～⑨は、次の要素に値を指定することとする(例.-u sato)
                        ※①～⑩は、順不同とする
                    戻り値        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② argsの要素に規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へ社内メール情報を送信 
                                                      (メソッド CoopLink.putMessageAdd 呼び出し)
                        ⑤ ガルーン２をログアウト     (メソッド CoopLink.logout 呼び出し)
                        ⑥ ④の戻り値(==登録された社内メールID)を標準エラー出力に出力
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                        ※宛先が指定されていない場合は、ガイダンスを表示し、処理を抜ける
                        ※URL,ログイン名、パスワード、タイトルがそれぞれ指定されていない場合は、
                          標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑩)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdMessageAdd -o http://localhost/cgi-bin/cbgrn/grn.cgi 
                                 -u "Administrator" -p "admin"  -r "user1"
                                 -t "ミーティングのお知らせ"
                                 -d "詳細は、添付ファイル参照のこと"  
                                 -f "/var/tmp/test.txt" -c
                                 -a "user1" -a "user2" -a "user3" -a "user4"
            ※実際には１行。
            →[結果] localhostのガルーン2に対して、
                     以下の社内メールが送信される。
                     ・差出人            ：A(ログインアカウント=user1)
                     ・宛先              ：A(ログインアカウント=user1),
                                           B(ログインアカウント=user2),
                                           C(ログインアカウント=user3),
                                           D(ログインアカウント=user4)
                     ・タイトル          ：ミーティングのお知らせ
                     ・本文              ：詳細は、添付ファイル参照のこと
                     ・添付ファイル      ：test.txt
                     ・確認しましたボタン：あり

                     登録された社内メールIDが表示される → 45

    (イ) 社内メール更新
        [ファイル名]
            CmdMessageModify.java
        [概要]
            コマンドラインよりガルーン２に社内メールを更新することができる。
        [機能]
            コマンドラインよりガルーン２に社内メールを更新することができる。
            指定できるオプションのガイダンスを表示することができる。
            実行結果を表示することができる。
            例外発生時は、エラー内容を表示することができる。
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -id   更新する社内メールIDを指定
                        ⑥ -r    差出人のユーザーのログイン名を指定
                        ⑦ -t    標題を指定
                        ⑧ -d    本文を指定
                        ⑨ -f    添付ファイルのパスを指定
                        ※②～⑨は、次の要素に値を指定する(例.-u sato)
                        ※①～⑨は、順不同とする
                    戻り値
                        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② args の要素より規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン   (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へパラメータを送信 (メソッド CoopLink.putMessageModify 呼び出し)
                        ⑤ ガルーン２をログアウト       (メソッド CoopLink.logout 呼び出し)
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                        ※URL、ログイン名、パスワード、社内メールID、標題がそれぞれ指定されていない場合は、標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑨)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdMessageModify -o http://localhost/cgi-bin/cbgrn/grn.cgi 
                                   -u "Administrator" -p "admin"
                                   -id 10 -t "作業報告"
                                   -f "/usr/作業報告書1.txt" -f "/usr/作業報告書2.txt"
            ※実際には１行。

    (ウ) 社内メール削除
        [ファイル名]
            CmdMessageDelete.java
        [概要]
            コマンドラインよりガルーン２に社内メールを削除することができる。
        [機能]
            コマンドラインよりガルーン２に社内メールを削除することができる。
            指定できるオプションのガイダンスを表示することができる。
            実行結果を表示することができる。
            例外発生時は、エラー内容を表示することができる。
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -id   更新する社内メールIDを指定
                        ⑥ -r    差出人のユーザーのログイン名を指定
                        ※②～⑥は、次の要素に値を指定する(例.-u sato)
                        ※①～⑥は、順不同とする
                    戻り値
                        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② args の要素より規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン   (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へパラメータを送信 (メソッド CoopLink.putMessageDelete 呼び出し)
                        ⑤ ガルーン２をログアウト       (メソッド CoopLink.logout 呼び出し)
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                          ・NumberFormatExceotion
                        ※URL、ログイン名、パスワード、社内メールIDがそれぞれ指定されていない場合は、標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑥)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdMessageDelete -o http://localhost/cgi-bin/cbgrn/grn.cgi 
                                   -u "Administrator" -p "admin" -id 10
            ※実際には１行。

    (エ) 社内メールフォロー登録
        [ファイル名]
            CmdMessageFollowAdd.java
        [クラス名]
            CmdMessageFollowAdd
        [概要]
            コマンドラインよりガルーン２へ社内メールのフォロー登録を行う
        [機能]
            コマンドラインよりガルーン２へ任意の社内メールに対してフォロー登録を行うことができる
            指定できるオプションのガイダンスを表示することができる
            実行結果(登録した社内メールフォローID)を表示することができる
            例外発生時は、エラー内容を表示することができる
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main         メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -r    社内メールフォローを登録するユーザのログイン名
                        ⑥ -id   社内メールフォローを登録する社内メールID
                        ⑦ -d    社内メールフォローの本文
                        ⑧ -f    社内メールフォローの添付ファイル (複数指定可能)
                        ※②～⑧は、次の要素に値を指定することとする(例.-u sato)
                        ※①～⑧は、順不同とする
                    戻り値        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② args の要素より規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へ社内メール情報を送信 
                                                (メソッド CoopLink.putMessageFollowAdd 呼び出し)
                        ⑤ ガルーン２をログアウト            (メソッド CoopLink.logout 呼び出し)
                        ⑥ 登録した社内メールの社内メールIDを標準エラー出力に出力
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                        ※URL,ログイン名、パスワード、社内メールIDがそれぞれ指定されていない場合は、
                          標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑧)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdMessageFollowAdd -o http://localhost/cgi-bin/cbgrn/grn.cgi 
                                      -u "Administrator" -p "admin"  -r "user2"
                                      -id 45 -d "参加メンバーについては添付ファイルを参照"
                                      -f "/home/test/member1.txt" -f "/home/test/member2.txt" 
            ※実際には１行。
            →[結果] localhostのガルーンに対して、
                     社内メールID=45の社内メールについて以下の情報のフォローが登録される
                     ・差出人  ：user2
                     ・本文    ：参加メンバーについては添付ファイルを参照
                     ・添付ファイル：member1.txt,member2.txt
                     登録された社内メールフォローIDが表示される → 78


    (オ) 社内メールフォロー削除
        [ファイル名]
            CmdMessageFollowDelete.java
        [概要]
            コマンドラインよりガルーン２に社内メールフォローを削除することができる。
        [機能]
            コマンドラインよりガルーン２に社内メールフォローを削除することができる。
            指定できるオプションのガイダンスを表示することができる。
            実行結果を表示することができる。
            例外発生時は、エラー内容を表示することができる。
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -id   削除する社内メールのフォローIDを指定
                        ⑥ -r    差出人のユーザーのログイン名を指定
                        ※②～⑥は、次の要素に値を指定する(例.-u sato)
                        ※①～⑥は、順不同とする
                    戻り値
                        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② args の要素より規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン   (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へパラメータを送信 (メソッド CoopLink.putMessageFollowDelete 呼び出し)
                        ⑤ ガルーン２をログアウト       (メソッド CoopLink.logout 呼び出し)
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                        ※URL、ログイン名、パスワード、社内メールIDがそれぞれ指定されていない場合は、標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑧)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdMessageFollowDelete -o http://localhost/cgi-bin/cbgrn/grn.cgi        
                                         -u "Administrator" -p "admin" -id 10
            ※実際には１行。

2.ガルーン連携（JAVA）
    (ア) 社内メール登録
        [ファイル名]
            /jp/co/cybozu/CoopLink.java (garoon2.jar)
        [クラス]
            jp.co.cybozu.CoopLink 
        [メソッド]
            putMessageAdd
        [概要]
            インスタンス作成時に指定されたURLのガルーン２に対し
            社内メール情報(登録)のHTTPリクエスト送信し、ガルーン２からのレスポンスを取得する
        [機能]
            ガルーン２に社内メール情報(登録)のパラメータをHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に登録された場合は、社内メールIDを返す、エラーの場合は、例外をthrowする
        [仕様]
            引数
               String title              … 社内メールの標題
               String data               … 本文.null指定可能(=本文未入力)
               boolean confirm           … 閲覧状況フラグ
                                            (true:確認ボタンをつける,false:確認ボタンをつけない)
               Collection accounts       … 宛先となるログイン名の集合.
                                            要素は、String型またはtoString()でログイン名を取得でき
                                            るObject
                                            要素内にnullがある場合は、NullPointerException発生
               Collection attachedFiles  … 添付ファイルとなるファイルパスの集合.
                                            null指定可能(=添付ファイルを登録しない)
                                            要素は、String型またはtoString()でファイルパスを取得でき
                                            るObject
                                            要素内にnullがある場合は、NullPointerException発生
               String registrant         … 登録者のログイン名.null指定可能(=登録者はログインユーザ) 
            戻り値
               String 登録されたガルーン２の社内メールID 
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            処理
              [リクエスト送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopMessage_add"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "title"             引数 title(nullの場合は ""(空文字))
                    "data"              引数 data(nullの場合は ""(空文字))
                    "receivers[]"       引数 accounts !=nullの場合の各要素.toString()
                                        (条件にマッチしない場合はパラメータ自体なし)
                                        ※同パラメータ名で複数の値を渡す
                                         accounts[] = "user1"
                                         accounts[] = "user2"
                    "file(0-n)"         引数 attachedFilesのFileストリーム
                                        (MIMETYPEは、全て application/octet-stream)
                                        (nullの場合は、パラメータ自体なし)
                    "confirm"           "1" (引数 confirm == falseの場合はパラメータ自体なし)
                    "registrant"        引数 registrant(nullの場合は ""(空文字))
                    "app"               "message" (アプリケーション名)
              [レスポンス受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー判定
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed in the registration of the message. 
                                + (ガルーン２エラーNO)"

                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed in the registration of the message. 
                                + ([要素２])"
                    
                 正常判定
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    →要素１が0の場合正常とする
                      要素２を戻り値にセット (= 登録された社内メールID)
              [備考]
                 本文の書式は、テキストとする(HTMLを有効にするパラメータは渡さない)

        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String MessageID = null;
            String url = "http://localhost/cgi-bin/cbgrn/grn.exe"; // GaroonのURL
            String user = "sato";                                  // ログインユーザーアカウント
            String password = "sato";                              // ログインパスワード
            String registrant = "matsuda";                         // 登録者
            String title = "タイトル";                             // タイトル
            String data = "本文";                                  // 本文
            boolean confirm = false;                               // フォロー許可あり
            Collection userAccounts = new ArrayList();             // 添付ファイル
            userAccounts.add("suzuki");

            Collection attachedFiles = new ArrayList();            // 添付ファイル
            attachedFiles.add("/home/test/test.txt");
 
            // Garoonへの接続&認証(ガルーンのURL,ログイン名,パスワード)
            CoopLink MessageLink = new CoopLink(url, user, password);

            
            // Garoonに社内メール情報を送信
            MessageID=MessageLink.putMessageAdd(title,            // タイトル
                                                   data,           // 本文
                                                   confirm,        // 閲覧状況確認
                                                   userAccounts,   // 宛先
                                                   attachedFiles,  // 添付ファイル
                                                   registrant);    // 登録者
            // ガルーンとの接続終了
            MessageLink.logout();
            //社内メールIDを表示
            System.out.println(MessageID);
            ---------------------------------------------------------------------------------------

    (イ) 社内メール更新
        [クラス]
            jp.co.cybozu.CoopLink (garoon2.jar)
        [メソッド]
            putMessageModify
        [概要]
            指定したパラメータをガルーン２にHTTPリクエストを送信し、ガルーン２からのレスポンスを取得する
        [機能]
            ガルーン２に社内メール(更新)をHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に更新された場合は、社内メールIDを返す
            エラーの場合は、例外をthrowする
        [仕様]
            引数
              long mid                   … 更新を行う社内メールIDを指定
              String title               … 標題を指定
              String data                … 本文を指定
              Collection attachedFiles   … 社内メールに添付するファイルのパスを指定
              String registrant          … 更新者を指定
            戻り値
               String 更新されたガルーン２の社内メールID
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            特記事項
              [送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopMessage_modify"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "app"               固定値 "message"    … アプリケーション系の処理(アプリケーションID:"message")
                    "mid"               引数   mid          … 更新を行う社内メールIDを指定
                    "title"             引数   title        … 標題を指定
                    "data"              引数   data         … 本文を指定
                    "registrant"        引数   registrant   … 更新者を指定
                    "file[0-n]"         引数   filepathのFileストリーム
                                        (MIMETYPEは、全て application/octet-stream)

              [受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed in the modification of the message.
                                + (ガルーン２エラーNO)"

                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed in the modification of the message. 
                                + ([要素２])"
                    
                 正常
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                      →要素１に戻り値をセット(更新された社内メールID)

              [備考]
                 本文の書式は、テキストとする(HTMLを有効にするパラメータは渡さない)

        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String url = http://localhost/cgi-bin/cbgrn/grn.cgi;   　 // ガルーン２のURL
            String user = "sato";                                     // ログインユーザーアカウント
            String password = "sato";                                 // ログインパスワード
	    String title = null;                                      // 標題
            String data = null;                                       // 本文
            Collection attachedFile = new ArrayList();                // 添付ファイル
            attachedFile.add("/usr/作業報告書.txt");                  // 添付ファイル
            String mid = "10";                                        // 社内メールID
            String messageId = null;                                  // 社内メールID

            // ガルーン２への接続&認証(ガルーン２のURL,ログイン名,パスワード)
            CoopLink messageLink = new CoopLink(url, user, password);

            // ガルーン２にパラメータを送信
            messageId = messageLink.putMessageModify(Long.parseLong(mid),// 社内メールID
                                                     title,              // 標題
                                                     data,               // 本文
                                                     attachedFile,       // 添付ファイル
                                                     registrant);        // 差出人

            // ガルーン２との接続終了
            messageLink.logout();

            // 社内メールIDを表示
            System.out.println(messageId);
            ---------------------------------------------------------------------------------------

    (ウ) 社内メール削除
        [クラス]
            jp.co.cybozu.CoopLink (garoon2.jar)
        [メソッド]
            putMessageDelete
        [概要]
            指定したパラメータをガルーン２にHTTPリクエストを送信し、ガルーン２からのレスポンスを取得する
        [機能]
            ガルーン２に社内メール(削除)をHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に削除された場合は、社内メールIDを返す
            エラーの場合は、例外をthrowする
        [仕様]
            引数
              long mid                   … 削除を行う社内メールIDを指定
              String registrant          … 削除者を指定
            戻り値
               String 削除されたガルーン２の社内メールID
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            特記事項
              [送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopMessage_delete"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "app"               固定値 "message"    … アプリケーション系の処理(アプリケーションID:"message")
                    "mid"               引数   mid          … 削除を行う社内メールIDを指定
                    "registrant"        引数   registrant   … 削除者を指定

              [受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed in the deletion of the message.
                                + (ガルーン２エラーNO)"

                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed in the deletion of the message. 
                                + ([要素２])"
                    
                 正常
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                      →要素１に戻り値をセット(削除された社内メールID)

              [備考]
                 本文の書式は、テキストとする(HTMLを有効にするパラメータは渡さない)

        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String url = http://localhost/cgi-bin/cbgrn/grn.cgi;   　 // ガルーン２のURL
            String user = "sato";                                     // ログインユーザーアカウント
            String password = "sato";                                 // ログインパスワード
            String mid = "10";                                        // 社内メールID
            String messageId = null;                                  // 社内メールID

            // ガルーン２への接続&認証(ガルーン２のURL,ログイン名,パスワード)
            CoopLink messageLink = new CoopLink(url, user, password);

            // ガルーン２にパラメータを送信
            messageId = messageLink.putMessageDelete(Long.parseLong(mid),// 社内メールID
                                                     registrant);        // 差出人

            // ガルーン２との接続終了
            messageLink.logout();

            // 社内メールIDを表示
            System.out.println(messageId);
            ---------------------------------------------------------------------------------------

    (エ) 社内メールフォロー登録
        [ファイル名]
            /jp/co/cybozu/CoopLink.java (garoon2.jar)
        [クラス]
            jp.co.cybozu.CoopLink
        [メソッド]
            putMessageFollowAdd
        [概要]
            インスタンス作成時に指定されたURLのガルーン２に対し
            社内メールフォロー情報(登録)のHTTPリクエスト送信し、ガルーン２からのレスポンスを取得す
            る
        [機能]
            ガルーン２に社内メールフォロー情報(登録)のパラメータをHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に登録された場合は、社内メールフォローIDを返す、エラーの場合は、例外をthrowする
        [仕様]
            引数
               long messageId            … フォロー登録対象の社内メールID
               String data               … フォロー本文.null指定可能(=本文未入力)
               Collection attachedFiles  … フォロー添付ファイルとなるファイルパスの集合.
                                            null指定可能(=添付ファイルを登録しない)
                                            要素は、String型またはtoString()でファイルパスを取得でき
                                            るObject
                                            要素内にnullがある場合は、NullPointerException発生
               String registrant         … フォロー登録者のログイン名.null指定可能
                                            (=フォロー登録者はログインユーザ) 
            戻り値
               String 登録されたガルーン２の社内メールフォローID 
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            処理
              [リクエスト送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopMessage_follow_add"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "mid"               引数 messageId
                    "data"              引数 data(nullの場合は ""(空文字))
                    "file[0-n]"         引数 attachedFilesのFileストリーム
                                        (MIMETYPEは、全て application/octet-stream)
                                        (nullの場合は、パラメータ自体なし)
                    "registrant"        引数 registrant(nullの場合は ""(空文字))
                    "app"               "message" (アプリケーション名)
                    "editor"            固定値 "0" (書式編集用)
                    "cmd"               固定値 "follow" (多分必要ないけど。。)
              [レスポンス受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed in the registration of the message Follow. 
                                + (ガルーン２エラーNO)"
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed in the deletion of the message Follow. 
                                + ([要素２])"
                    
                 正常
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    →要素１が0の場合正常とする
                      要素２を戻り値にセット (= 登録された社内メールフォローID)


        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String MessageId = null;
            String url = "http://localhost/cgi-bin/cbgrn/grn.exe";  // GaroonのURL
            String user = "sato";                                   // ログインユーザーアカウント
            String password = "sato";                               // ログインパスワード
            long mid = 18;                                          // 社内メールID
            String registrant = "matsuda";                          // 登録者
            String data = "社内メールフォロー本文";                 // 本文
            Collection attachedFiles = new ArrayList();             // 添付ファイル
            attachedFiles.add("/home/test/test.txt");

            // Garoonへの接続&認証(ガルーンのURL,ログイン名,パスワード)
            CoopLink MessageLink = new CoopLink(url, user, password);

            // Garoonに社内メール情報を送信
            MessageId=MessageLink.putMessageFollowAdd(mid,          // 社内メールID
                                                      data,         // 本文
                                                      attachedFiles,// 添付ファイル
                                                      registrant);  // 登録者
            // ガルーンとの接続終了
            MessageLink.logout();
            //社内メールIDを表示
            System.out.println(MessageId);
            ---------------------------------------------------------------------------------------

    (オ) 社内メールフォロー削除
        [クラス]
            jp.co.cybozu.CoopLink (garoon2.jar)
        [メソッド]
            putMessageFollowDelete
        [概要]
            指定したパラメータをガルーン２にHTTPリクエストを送信し、ガルーン２からのレスポンスを取得する
        [機能]
            ガルーン２に社内メールフォロー(削除)をHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に削除された場合は、社内メールのフォローIDを返す
            エラーの場合は、例外をthrowする
        [仕様]
            引数
              long fid                   … 削除を行う社内メールのフォローIDを指定
              String registrant          … 削除者を指定
            戻り値
               String 削除されたガルーン２の社内メールのフォローID
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            特記事項
              [送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopMessage_follow_add"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "app"               固定値 "message"    … アプリケーション系の処理(アプリケーションID:"message")
                    "fid"               引数   fid          … フォローを追加する社内メールIDを指定
                    "registrant"        引数   registrant   … 削除者を指定

              [受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed in the deletion of the message follow.
                                + (ガルーン２エラーNO)"

                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed in the deletion of the message follow.
                                + ([要素２])"
                    
                 正常
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                      →要素１に戻り値をセット(削除された社内メールのフォローID)

              [備考]
                 本文の書式は、テキストとする(HTMLを有効にするパラメータは渡さない)

        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String url = http://localhost/cgi-bin/cbgrn/grn.cgi;   　 // ガルーン２のURL
            String user = "sato";                                     // ログインユーザーアカウント
            String password = "sato";                                 // ログインパスワード
            String fid = "10";                                        // 社内メールのフォローID
            String followId = null;                                   // 社内メールのフォローID

            // ガルーン２への接続&認証(ガルーン２のURL,ログイン名,パスワード)
            CoopLink messageLink = new CoopLink(url, user, password);

            // ガルーン２にパラメータを送信
            followId = messageLink.putMessageFollowDelete(Long.parseLong(fid),// 社内メールのフォローID
                                                          registrant);        // 差出人

            // ガルーン２との接続終了
            messageLink.logout();

            // 社内メールのフォローIDを表示
            System.out.println(followId);
            ---------------------------------------------------------------------------------------

3.ガルーン連携（PHP）
    (ア) 社内メール登録
        [ファイル名]
            coopMessage_add.csp
        [概要]
            ガルーン２へ社内メールの登録を行う
        [機能]
            ガルーン２で社内メールを送信する
            正常終了した場合は,登録された社内メールIDを独自形式のHTMLでレスポンスする
        [仕様]
            受信データ仕様
                項目名         |説明
                ---------------+--------------------------------------------------------------------
                title          |(必須)標題を指定します。 
                data           |本文
                receivers[]    |(必須)参加者の指定(配列) 
                file[0-n]      |添付ファイル
                confirm        |閲覧状況の確認ボタンをつける (valueは 1 ) 
                               |(確認ボタンをつけないの場合は、パラメータ自体不要)
                registrant     |coopLoginにて使用 登録者指定(→このユーザーでLoginAs)
                               |パラメータがない又は""(空文字)の場合ログインユーザーで登録
                app            |(必須)coopLoginにて使用"Message" 
            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック,アプリケーションチェック)
              →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理----------------------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]値のアプリケーションの停止チェック
                  パラメータ["registrant"]値のチェック(ある場合は、registrantで再Login)
              --------------------------------------------------------------------------------------
              パラメータ["receivers[]"]よりユーザーIDを取得
              →取得できなければ、エラー(GRN_CMMN_00105)
              →パラメータ自体がなければ、エラー(GRN_MSSG_15008)

              パラメータ["title"]について、改行コード(\r\n,\n,\r)削除,101文字以降削除
              パラメータ["title"]について、未存在、空白なら、エラー(GRN_MSSG_15007)

              配列に社内メールのプロパティセット(タイトル、本文、添付ファイルetc)

              message/message_logic.cspよりメッセージロジッククラス→sendMessageで、
              社内メール情報を送信
              →戻り値のメッセージオブジェクトより社内メールIDを取得→HTML吐き出し

            備考

    (イ) 社内メール更新
        [ファイル名]
            coopMessage_modify.csp
        [概要]
            ガルーン２へ社内メールの更新を行う
        [機能]
            ガルーン２における社内メールの更新(message/command_modify.csp)と同等の機能
            正常終了した場合は、更新された社内メールIDを独自形式のHTMLで表示する
        [仕様]
            受信データ仕様
                項目名        |説明
                --------------+--------------------------------------------------
                app           |coopLoginにて使用(固定値:"message")
                              |アプリケーション管理系の処理の場合のアプリケーションID
                mid           |更新を行う社内メールIDを指定
                title         |標題を指定
                data          |本文を指定
                file[0-n]     |社内メールに添付するファイルのパスを指定
                registrant    |coopLoginにて使用 更新者指定(→このユーザーでLoginAs)
                              |パラメータがなければログインユーザーで登録

            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック、アプリケーションチェック)
                →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理-------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]の管理権限チェック
              -----------------------------------------------------------------------
              パラメータ["mid"]が存在するかチェックを行います。
                →パラメータが存在しない場合(GRN_MSSG_15003)
              パラメータ["title"]が存在するかチェックを行います。
                →パラメータが存在しない場合(GRN_MSSG_15007)
              パラメータ["title"]について、改行コード(\r\n,\n,\r)削除,101文字以降削除
              パラメータ["file"]より、添付ファイルの追加を行います。
              パラメータをガルーン２に更新を行います。
                →正常に更新された場合には、社内メールIDを返します。
                →社内メールの更新に失敗した場合(GRN_MSSG_15003)

    (ウ) 社内メール削除
        [ファイル名]
            coopMessage_delete.csp
        [概要]
            ガルーン２へ社内メールの削除を行う
        [機能]
            ガルーン２における社内メールの削除(message/command_delete.csp)と同等の機能
            正常終了した場合は、削除された社内メールIDを独自形式のHTMLで表示する
        [仕様]
            受信データ仕様
                項目名        |説明
                --------------+--------------------------------------------------
                app           |coopLoginにて使用(固定値:"message")
                              |アプリケーション管理系の処理の場合のアプリケーションID
                fid           |削除を行う社内メールIDを指定
                registrant    |coopLoginにて使用 削除者指定(→このユーザーでLoginAs)
                              |パラメータがなければログインユーザーで登録

            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック、アプリケーションチェック)
                →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理-------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]の管理権限チェック
              -----------------------------------------------------------------------
              パラメータ["mid"]が存在するかチェックを行います。
                →パラメータが存在しない場合(GRN_MSSG_15003)
              パラメータをガルーン２に削除を行います。
                →正常に削除された場合には、社内メールIDを返します。
                →社内メールの削除に失敗した場合(GRN_MSSG_15019)

    (エ) 社内メールフォロー登録
        [ファイル名]
            coopMessage_follow_add.csp
        [概要]
            ガルーン２へ社内メールフォロー登録を行う
        [機能]
            ガルーン２における社内メールフォロー登録を行う
            社内メールの指定は、社内メールIDを使用
            正常終了した場合は,登録された社内メールフォローIDを独自形式のHTMLで表示する
        [仕様]
            受信データ仕様
                項目名      |説明
                ------------+--------------------------------------------------
                mid         |(必須)フォロー登録対象の社内メールID
                data        |(要)本文
                editor      |本文の書式 (0:テキスト,1=書式編集)  
                            |現状は 0(テキスト)しかこないけど
                cmd         |登録コマンド (valueは"follow") ※未使用
                file[0-n]   |(要)添付ファイル
                registrant  |coopLoginにて使用 登録者指定(→このユーザーでLoginAs)
                            |パラメータがない又は""(空文字)の場合ログインユーザーで登録
                app         |(必須)coopLoginにて使用 (valueは"Message")
            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック,アプリケーションチェック)
              →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理-------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]のアプリケーションの停止チェック
                  パラメータ["registrant"]のチェック(ある場合は、registrantで再Login)
              -----------------------------------------------------------------------
              パラメータ["mid"]のパラメータチェック
              パラメータが存在しない場合 →エラー(GRN_MSSG_15003)

              パラメータ["data"]及び["file0-n"]が存在しないまたは空の場合は
              →エラー(GRN_MSSG_15005)

              メッセージロジッククラス→_insertFollow,_addFollowFiles,_updateVoiceにて
              フォロー登録 ※１

              書き込まれた社内メール＆フォローについて
              既読処理を行う ※２

              登録されたフォローのIDを取得 →HTML吐き出し

            備考
              ※１について
              →本来であれば、メッセージロジック→writeFollow でフォロー登録できるが
                writeFollowの戻り値がbooleanのため フォローIDが取得できない。
                このため、writeFollowの中身をまるまるソース上に記述して処理させている

              ※２について
              →画面上でフォロー登録する場合と同じになるようにした。
                このため、APIでフォロー登録すると
                登録者が画面をひらくと、実際には画面で確認していないのに
                社内メール・フォローが既読状態になっている

    (オ) 社内メールフォロー削除
        [ファイル名]
            coopMessage_follow_delete.csp
        [概要]
            ガルーン２へ社内メールフォローの削除を行う
        [機能]
            ガルーン２における社内メールフォローの削除(message/command_follow_delete.csp)と同等の機能
            正常終了した場合は、削除された社内メールのフォローIDを独自形式のHTMLで表示する
        [仕様]
            受信データ仕様
                項目名        |説明
                --------------+--------------------------------------------------
                app           |coopLoginにて使用(固定値:"message")
                              |アプリケーション管理系の処理の場合のアプリケーションID
                fid           |削除を行う社内メールのフォローIDを指定
                registrant    |coopLoginにて使用 削除者指定(→このユーザーでLoginAs)
                              |パラメータがなければログインユーザーで登録

            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック、アプリケーションチェック)
                →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理-------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]の管理権限チェック
              -----------------------------------------------------------------------
              パラメータ["fid"]が存在するかチェックを行います。
                →パラメータが存在しない場合(GRN_MSSG_15004)
              パラメータをガルーン２に更新を行います。
                →正常に削除された場合には、社内メールのフォローIDを返します。
                →社内メールフォローの削除に失敗した場合(GRN_MSSG_15004)

4.その他
[環境]
・ガルーンサーバー側
  →以下のフォルダにガルーン連携(PHP)用プログラム cspファイル配置
  [ガルーン２インストールディレクトリ]/code/doc_root/coop/coopMessage_add.csp    (登録用)
                                                          coopMessage_modify.csp (更新用)
                                                          coopMessage_delete.csp (削除用)
                                                          coopMessage_follow_add.csp    (フォロー登録用)
                                                          coopMessage_follow_delete.csp (フォロー削除用)
                                                          coopLogin.csp  (全アプリ共通処理)

  ※ガルーン2をバージョンアップした時点でcoopディレクトリは削除されます。
    バージョンアップ作業を実施した場合には、再度、coopディレクトリを配置する必要がある

・連携用マシン(ガルーンサーバと兼ねても可)
  java1.4以降をインストール
  [jreインストールディレクトリ]/lib/ext/にガルーン連携（JAVA）用プログラムgaroon2.jarをコピーもしくは、
  実行時にクラスパスを通す
  サンプルプログラムについては、適当なディレクトリにあれば良し

[注意事項]
・サンプルプログラムについて
  →あくまでもガルーン連携（JAVA）用プログラムgaroon2.jarの使い方の一例としてのプログラム

・ガルーン連携（JAVA）用プログラムgaroon2.jar →登録、更新、フォロー登録について
          OutOfMemory 出る可能性あり（20M以上(環境により異なる)大きなファイルを添付登録できない)
→http://agent.corp.cybozu.co.jp/scripts/cbdb/db.exe?page=DBRecord&did=13984&qid=164&vid=54&rid=155&Head=&hid=&sid=5&rev=&ssid=&#comment

以上

作成日  2007/01/15
作成者  tsukurimichi
version 1.0