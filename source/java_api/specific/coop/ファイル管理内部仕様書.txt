ファイル管理 プログラム仕様書

0.目次
-------------------------------------------------------------------
    0.目次
    1.サンプルプログラム
        1-(ア) ファイル管理登録
    2.ガルーン連携（JAVA）用プログラム
        2-(ア) ファイル管理登録
    3.ガルーン連携（PHP）用プログラム
        3-(ア) ファイル管理登録
    4.その他
-------------------------------------------------------------------

1.サンプルプログラム
    (ア) ファイル管理登録
        [ファイル名]
            CmdCabinetAdd.java
        [概要]
            コマンドラインよりガルーン２にファイル管理を登録することができる。
        [機能]
            コマンドラインよりガルーン２にファイル管理を登録することができる。
            指定できるオプションのガイダンスを表示することができる。
            実行結果を表示することができる。
            例外発生時は、エラー内容を表示することができる。
        [仕様]
            メソッド
                ・usage        ガイダンスの表示
                    パラメータ    なし
                    戻り値        なし
                    処理          ガイダンスを標準エラー出力に出力する
                ・main メイン処理
                    パラメータ   String args[]  コマンドライン実行する場合の引数
                        ① -h    （ガイダンスの表示用）
                        ② -o    ガルーン２のURL
                        ③ -u    ガルーン２のログイン名
                        ④ -p    ③のパスワード
                        ⑤ -r    登録者を指定
                        ⑥ -fc   ファイル管理のフォルダコードを指定
                        ⑦ -f    追加するファイルを指定
                        ⑧ -t    タイトルを指定
                        ⑨ -v    バージョン管理を指定
                        ⑩ -m    ファイルの説明を指定
                        ※②～⑩は、次の要素に値を指定する(例.-u sato)
                        ※①～⑩は、順不同とする
                    戻り値
                        なし
                    処理
                        ① argsの要素数が０の場合は、ガイダンスを表示し処理を抜ける
                        ② args の要素より規定の文字列があった場合は、次の要素を変数に格納する※
                        ③ ガルーン２へ接続、ログイン   (クラス   CoopLink コンストラクタ呼び出し)
                        ④ ガルーン２へパラメータを送信 (メソッド CoopLink.putCabinetAdd 呼び出し)
                        ⑤ ガルーン２をログアウト       (メソッド CoopLink.logout 呼び出し)
                    特記事項
                        例外が発生した場合は、エラー内容が標準エラー出力に出力される
                        catchしているエラー
                          ・RemoretException
                          ・IOException
                          ・IllegalArgumentException
                          ・NullPointerException
                        ※URL、ログイン名、パスワード、フォルダコード、ファイルがそれぞれ指定されて
                          いない場合は、標準入力での再入力を求める
                        ※指定されたパラメータ(①～⑩)以外の引数がargsに渡された場合は、ガイダンス
                          を表示し、処理を抜ける
        [使い方]
            #java CmdCabinetAdd -o http://localhost/cgi-bin/cbgrn/grn.cgi 
                                -u "Administrator" -p "admin"
                                -fc "honsya" -f "/usr/試験仕様書.doc" -v 10
                                -m "ファイル管理での試験仕様書"
            ※実際には１行。

2.ガルーン連携（JAVA）
    (ア) ファイル管理登録
        [クラス]
            jp.co.cybozu.CoopLink (garoon2.jar)
        [メソッド]
            putCabinetAdd
        [概要]
            指定したパラメータをガルーン２にHTTPリクエストを送信し、ガルーン２からのレスポンスを取得する
        [機能]
            ガルーン２にファイル管理(登録)をHTTPでPOSTすることができる
            ガルーン２からのレスポンスを取得し、結果をリターンすることができる
            正常に登録された場合は、ファイル管理IDを返す
            エラーの場合は、例外をthrowする
        [仕様]
            引数
              String title               … タイトルを指定
              String folder              … ファイル管理のフォルダコードを指定
              long version               … バージョン管理を指定
                                            バージョン管理は下記のいずれかを指定
                                              0以下 :しない
                                              1～10 :1～10世代
                                              11以上:無制限
              String memo                … ファイルの説明を指定
              String file                … ファイル管理に登録するファイルを指定
            戻り値
               String 登録されたガルーン２のファイル管理ID
            例外
               IOException               … 接続が確立できない等通信上のエラーが発生した場合 
               RemoteException           … ガルーン２連携用プログラム上でエラーが発生した場合
               
            特記事項
              [送信処理]
               送信先   … CoopLinkコンストラクタで指定されたガルーン２のURL + "/coop/coopCabinet_add"
               送信方法 … POST(multipart/form-data)
               送信パラメータ
                    【パラメータ名】   【値】
                    "app"               固定値 "cabinet"    … アプリケーション系の処理(アプリケーションID:"cabinet")
                    "title"             引数   title        … タイトルを指定
                    "folder"            引数   folder       … ファイル管理のフォルダコードを指定
                    "max_version"       引数   version      … バージョン管理を指定
                    "memo"              引数   memo         … ファイルの説明を指定
                    "registrant"        引数   registrant   … 登録者を指定
                    "file"              引数   filepathのFileストリーム
                                        (MIMETYPEは、全て application/octet-stream)

              [受信処理]
                CoopLink.processResult(java.net.HttpURLConnection hc, String context)参照
                取得したHTMLを解析
                 エラー
                    HTTPヘッダより"X-Cybozu-Error"フィールド取得 → フィールド有の場合は
                    RemortException発生
                    エラー文言 "failed to register a cabinet.
                                + (ガルーン２エラーNO)"

                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                    要素１が1の場合は、RemortException発生
                    エラー文言 "failed to register a cabinet. 
                                + ([要素２])"
                    
                 正常
                    HTML内より"<Header Data><CR><LF>" と "<Footer Data>"に囲まれた文字列取得
                      (文字列の形式…[要素１],[要素２])
                      →要素１に戻り値をセット(登録されたファイル管理ID)

              [備考]
                 本文の書式は、テキストとする(HTMLを有効にするパラメータは渡さない)

        [呼び出し方]
            ---------------------------------------------------------------------------------------
            String url = http://localhost/cgi-bin/cbgrn/grn.cgi;   　 // ガルーン２のURL
            String user = "sato";                                     // ログインユーザーアカウント
            String password = "sato";                                 // ログインパスワード
            String filepath = "/usr/ounits.csv";                      // ファイルパス
	    String title = null;                                      // タイトル
            String folder = null;                                     // フォルダコード
            String version = "0";                                     // バージョン管理
            String memo = null;                                       // ファイルの説明
            String registrant = null;                                 // 登録者
            File file = null;                                         // ファイル
            String fileId = null;                                     // ファイル管理ID

            // ガルーン２への接続&認証(ガルーン２のURL,ログイン名,パスワード)
            CoopLink cabinetLink = new CoopLink(url, user, password);

            // ガルーン２にパラメータを送信
            fileId = cabinetLink.putCabinetAdd(title,                  // タイトル
                                               folder,                 // フォルダコード
                                               Long.parseLong(version),// バージョン管理
                                               memo,                   // ファイルの説明
                                               registrant,             // 登録者
                                               file);                  // ファイル

            // ガルーン２との接続終了
            cabinetLink.logout();

            // ファイル管理IDを表示
            System.out.println(fileId);
            ---------------------------------------------------------------------------------------

3.ガルーン連携（PHP）
    (ア) ファイル管理登録
        [ファイル名]
            coopCabinet_add.csp
        [概要]
            ガルーン２へファイル管理の登録を行う
        [機能]
            ガルーン２におけるファイル管理の登録(cabinet/command_add.csp)と同等の機能
            フォルダの指定については、フォルダコードを指定する
            正常終了した場合は,登録されたファイル管理IDを独自形式のHTMLで表示する
        [仕様]
            受信データ仕様
                項目名      |説明
                ------------+--------------------------------------------------
                app         |coopLoginにて使用(固定値:"cabinet")
                            |アプリケーション管理系の処理の場合のアプリケーションID
                title       |タイトルを指定
                            |指定しなければファイル名がタイトルとなります。
                folder      |ファイル管理のフォルダコードを指定
                max_version |バージョン管理を指定
                            |  0以下 :しない
                            |  1～10 :1～10世代
                            |  11以上:無制限
                memo        |ファイルの説明を指定
                registrant  |coopLoginにて使用 登録者指定(→このユーザーでLoginAs)
                            |パラメータがなければログインユーザーで登録

            処理
              同フォルダ内のcoopLogin.csp をincludeする(ログインチェック、アプリケーションチェック)
                →ファイルがなければ "PageNotFound"エラー
              ---coopLogin.csp内処理-------------------------------------------------
                  セッションIDよりログインチェック
                  パラメータ["app"]の管理権限チェック
              -----------------------------------------------------------------------
              フォルダコードからフォルダIDを取得する
              パラメータ["title"]について、改行コード(\r\n,\n,\r)削除,101文字以降削除
              パラメータ["max_version"]について下記の値を設定する
                0以下 :しない   (値:"0")
                1～10 :1～10世代(値:"1"～"10")
                11以上:無制限   (値:"-1")
              パラメータをガルーン２に登録を行います。
                →正常に登録された場合には、ファイル管理IDを返します。

4.その他
    [環境]
        ・ガルーンサーバー側
            →以下のフォルダにガルーン連携(PHP)用プログラム cspファイル配置
              [ガルーン２インストールディレクトリ]/code/doc_root/coop/coopCabinet_add.csp (ファイル管理登録)
                                                                      coopLogin.csp       (全アプリ共通処理)
        ・連携用マシン(ガルーンサーバと兼ねても可)
            jre1.4以降をインストール
            [jreインストールディレクトリ]/lib/ext/にガルーン連携（JAVA）用プログラムgaroon2.jarをコピーもしくは、
            実行時にクラスパスを通す
            サンプルプログラムについては、適当なディレクトリにあれば良し

    [注意事項]
        ・サンプルプログラムについて
            →あくまでもガルーン連携（JAVA）用プログラムgaroon2.jarの使い方の一例としてのプログラム

        ・「システム管理(基本システム)」→「ファイル」→「一般設定」のバージョン管理の上限値が設定されている値
          より大きい値を設定した場合は、バージョン管理の上限値で設定されます。

        ・「システム管理(基本システム)」→「ファイル」→「一般設定」のファイルのサイズ制限が設定されている場合
　　　　　に、その値を超えるファイルサイズのファイルを登録することはできません。
