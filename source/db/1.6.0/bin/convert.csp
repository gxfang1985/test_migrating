<?php

cb_require_role('CommandLine');

// Disable output buffering for command-line.
while (ob_get_level() > 0) {
    ob_end_clean();
}

// Enable automatic flushing upon every 'echo'.
ob_implicit_flush();

// Entry point.
$convert = new GRN_Convert1_6_0();
$convert->main();


class GRN_Convert1_6_0
{
    public function main()
    {
        $this->_convertSpaceRichText();
    }

    //GRN2-4201
    private function _convertSpaceRichText()
    {
        require_once('grn/application.csp');
        require_once('grn/controller.csp');

        $applicationLocator = GRN_ApplicationLocator::instance();
        $dbconn = $applicationLocator->getConnection("space");

        $result
            = $dbconn->query("SELECT col_space, col_memo FROM tab_grn_space_space_memo WHERE col_is_rich_text = '1';");
        while ($row = $dbconn->fetch_assoc($result)) {
            $memoHtml
                = grn_wash_script_without_style_attribute($row['col_memo']);
            $memo = grn_strip_tags($memoHtml);

            $query = "UPDATE tab_grn_space_space_memo SET ";
            $query .= "  col_memo_html = '" . $dbconn->escape($memoHtml) . "'";
            $query .= ", col_memo = '" . $dbconn->escape($memo) . "'";
            $query .= " WHERE col_space = '"
                      . $dbconn->escape($row['col_space']) . "';";
            $dbconn->query($query);
        }
        $dbconn->free_result($result);


        $result
            = $dbconn->query("SELECT _id, col_content FROM tab_grn_space_comment WHERE col_is_rich_text = '1';");
        while ($row = $dbconn->fetch_assoc($result)) {
            $contentHtml
                = grn_wash_script_without_style_attribute($row['col_content']);
            $content = grn_strip_tags($contentHtml);

            $query = "UPDATE tab_grn_space_comment SET ";
            $query .= "  col_content_html = '" . $dbconn->escape($contentHtml)
                      . "'";
            $query .= ", col_content = '" . $dbconn->escape($content) . "'";
            $query .= " WHERE _id = '" . $dbconn->escape($row['_id']) . "';";
            $dbconn->query($query);
        }
        $dbconn->free_result($result);


        $result
            = $dbconn->query("SELECT _id, col_content FROM tab_grn_space_thread WHERE col_is_rich_text = '1';");
        while ($row = $dbconn->fetch_assoc($result)) {
            $contentHtml
                = grn_wash_script_without_style_attribute($row['col_content']);
            $content = grn_strip_tags($contentHtml);

            $query = "UPDATE tab_grn_space_thread SET ";
            $query .= "  col_content_html = '" . $dbconn->escape($contentHtml)
                      . "'";
            $query .= ", col_content = '" . $dbconn->escape($content) . "'";
            $query .= " WHERE _id = '" . $dbconn->escape($row['_id']) . "';";
            $dbconn->query($query);
        }
        $dbconn->free_result($result);


        //tab_grn_space_todo is not using col_is_rich_text.
        //Therefore, a conversion is unnecessary.
    }
}
